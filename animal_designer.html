<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ¨ç‰©è®¾è®¡å™¨ - ç”µå­ç›†æ ½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .animal-card {
            transition: all 0.3s ease;
        }
        
        .animal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* ç³»åˆ«é¢œè‰² */
        .element-water { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .element-fire { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .element-grass { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .element-wind { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .element-electric { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .element-earth { background: linear-gradient(135deg, #a16207, #854d0e); }
        
        /* ç¨€æœ‰åº¦é¢œè‰² */
        .rarity-common { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .rarity-shiny { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .rarity-prismatic { background: linear-gradient(135deg, #ec4899, #8b5cf6, #3b82f6); }
        .rarity-stellar { background: linear-gradient(135deg, #fef3c7, #fde68a, #fbbf24); color: #92400e; }
        
        .color-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        #model-preview-canvas {
            width: 100%;
            height: 300px;
            border-radius: 0.5rem;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        
        .model-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        
        .model-control-btn {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #60a5fa;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .model-control-btn:hover {
            background: rgba(59, 130, 246, 0.3);
            border-color: #60a5fa;
        }
        
        .model-control-btn.active {
            background: rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ¦ åŠ¨ç‰©è®¾è®¡å™¨ ğŸ¦</h1>
            <p class="text-green-200">è®¾è®¡å’Œç®¡ç†åŠ¨ç‰©æ¨¡æ¿æ± </p>
            <div class="mt-4 bg-green-900/50 border border-green-700 rounded-lg p-4 max-w-3xl mx-auto text-left">
                <p class="text-sm text-green-200 font-bold mb-2">ğŸ’¡ åŠ¨ç‰©ç”Ÿæˆæœºåˆ¶ï¼š</p>
                <div class="text-xs text-green-100">
                    <div class="mb-2">â€¢ æ¸¸æˆä¼šä»åŠ¨ç‰©æ¨¡æ¿æ± ä¸­éšæœºé€‰æ‹©æ¨¡æ¿ç”Ÿæˆé‡ç”ŸåŠ¨ç‰©</div>
                    <div class="mb-2">â€¢ æ¯ä¸ªæ¨¡æ¿å®šä¹‰äº†åŠ¨ç‰©çš„åŸºç¡€å±æ€§ã€ç³»åˆ«ã€ç¨€æœ‰åº¦ç­‰</div>
                    <div>â€¢ ç”Ÿæˆçš„åŠ¨ç‰©ä¼šåœ¨æ¨¡æ¿åŸºç¡€ä¸Šæ·»åŠ éšæœºå˜åŒ–</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šåŠ¨ç‰©è®¾è®¡è¡¨å• -->
            <div class="lg:col-span-2 bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ¨ åˆ›å»ºåŠ¨ç‰©æ¨¡æ¿</h2>
                
                <form id="animal-form" class="space-y-4">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">åŠ¨ç‰©åç§° *</label>
                            <input type="text" id="animal-name" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">åŠ¨ç‰©ID (ç‰©ç§+ç¨€æœ‰åº¦) *</label>
                            <input type="text" id="animal-id" required pattern="^[1-4]\d{4}$"
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white font-mono text-center text-lg focus:outline-none focus:border-green-500"
                                placeholder="ä¾‹: 10001">
                            <p class="text-xs text-gray-400 mt-1">
                                æ ¼å¼ï¼š<span class="font-mono">1xxxx</span>=æ™®é€š <span class="font-mono">2xxxx</span>=é—ªå…‰
                                <span class="font-mono">3xxxx</span>=å¹»å½© <span class="font-mono">4xxxx</span>=æ˜ŸèŠ’<br>
                                ä¾‹ï¼š10001(æ™®é€š)ã€20001(é—ªå…‰)ã€30001(å¹»å½©)ã€40001(æ˜ŸèŠ’)ä¸ºåŒä¸€ç‰©ç§
                            </p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-300 mb-2">é¢œè‰² (åå…­è¿›åˆ¶)</label>
                            <div class="flex gap-2">
                                <input type="color" id="animal-color" required
                                    class="w-16 h-10 bg-gray-800 border border-gray-600 rounded-lg cursor-pointer">
                                <input type="text" id="animal-color-hex" required pattern="^#[0-9A-Fa-f]{6}$"
                                    class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-green-500"
                                    placeholder="#FF5733">
                            </div>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-300 mb-2">å¤´åƒå›¾ç‰‡ (å¯é€‰)</label>
                            <div class="flex gap-2">
                                <label for="animal-avatar-input" class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-gray-400 hover:border-purple-500 cursor-pointer transition-colors flex items-center justify-center">
                                    <span id="avatar-filename">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                                </label>
                                <input type="file" id="animal-avatar-input" accept="image/*" class="hidden">
                                <button type="button" id="clear-avatar-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 rounded-lg hidden">
                                    æ¸…é™¤
                                </button>
                            </div>
                            <div id="avatar-preview" class="mt-2 hidden">
                                <img id="avatar-preview-img" class="w-20 h-20 rounded-full border-2 border-gray-600 object-cover" alt="å¤´åƒé¢„è§ˆ">
                            </div>
                            <p class="text-xs text-gray-400 mt-1">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œå»ºè®®å°ºå¯¸ 200x200</p>
                        </div>
                    </div>

                    <!-- ç³»åˆ«å’Œç¨€æœ‰åº¦ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ç³»åˆ«</label>
                            <select id="animal-element" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-green-500">
                                <option value="">é€‰æ‹©ç³»åˆ«</option>
                                <option value="æ°´ç³»">ğŸ’§ æ°´ç³»</option>
                                <option value="ç«ç³»">ğŸ”¥ ç«ç³»</option>
                                <option value="è‰ç³»">ğŸŒ¿ è‰ç³»</option>
                                <option value="é£ç³»">ğŸ’¨ é£ç³»</option>
                                <option value="ç”µç³»">âš¡ ç”µç³»</option>
                                <option value="åœŸç³»">ğŸª¨ åœŸç³»</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ç¨€æœ‰åº¦</label>
                            <select id="animal-rarity" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-green-500">
                                <option value="">é€‰æ‹©ç¨€æœ‰åº¦</option>
                                <option value="common">âšª æ™®é€š</option>
                                <option value="shiny">âœ¨ é—ªå…‰</option>
                                <option value="prismatic">ğŸŒˆ å¹»å½©</option>
                                <option value="stellar">â­ æ˜ŸèŠ’</option>
                            </select>
                        </div>
                    </div>

                    <!-- åŸºç¡€å±æ€§ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ“Š åŸºç¡€å±æ€§</label>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs text-gray-400">åˆå§‹ç­‰çº§</label>
                                <input type="number" id="animal-level" min="1" max="100" value="1" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">åŸºç¡€ç»éªŒå€¼</label>
                                <input type="number" id="animal-base-exp" min="10" max="1000" value="100" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                                <p class="text-xs text-gray-500 mt-1">Lv1â†’Lv2æ‰€éœ€ç»éªŒ</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">ç»éªŒå¢é•¿ç³»æ•°</label>
                                <input type="number" id="animal-exp-growth" min="1.0" max="2.0" step="0.1" value="1.2" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                                <p class="text-xs text-gray-500 mt-1">æ¯çº§ç»éªŒå€ç‡</p>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">ç”Ÿå‘½å€¼</label>
                                <input type="number" id="animal-health" min="50" max="1000" value="100" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">ä½“åŠ›</label>
                                <input type="number" id="animal-stamina" min="50" max="500" value="100" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">å¥½æ„Ÿåº¦</label>
                                <input type="number" id="animal-favorability" min="0" max="100" value="50" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">ğŸ’¡ å‡çº§ç»éªŒå…¬å¼ï¼šLv Nâ†’N+1 = åŸºç¡€ç»éªŒ Ã— (å¢é•¿ç³»æ•° ^ (N-1))</p>
                    </div>

                    <!-- æˆ˜æ–—èƒ½åŠ› -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">âš”ï¸ æˆ˜æ–—èƒ½åŠ›</label>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs text-gray-400">æ”»å‡»</label>
                                <input type="number" id="animal-attack" min="5" max="100" value="10" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">é˜²å¾¡</label>
                                <input type="number" id="animal-defense" min="5" max="100" value="5" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">æ•æ·</label>
                                <input type="number" id="animal-agility" min="5" max="100" value="8" required
                                    class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-green-500">
                            </div>
                        </div>
                    </div>

                    <!-- ä¸‰ç§æˆé•¿é…ç½® -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ“ˆ æˆé•¿é…ç½® (æ¯çº§å¢é•¿)</label>
                        <p class="text-xs text-gray-400 mb-3">ğŸ’¡ é…ç½®ä¸‰ç§æˆé•¿ç±»å‹ï¼Œåœ¨åœ°å›¾ä¸­ç”Ÿæˆæ—¶é€‰æ‹©ä½¿ç”¨å“ªç§</p>
                        
                        <!-- å¹³åº¸æˆé•¿ -->
                        <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-600 mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-gray-300">â­ å¹³åº¸æˆé•¿ (1.0x)</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs text-gray-400">ç”Ÿå‘½å€¼</label>
                                    <input type="number" id="growth-mediocre-health" min="1" max="100" value="10" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">ä½“åŠ›</label>
                                    <input type="number" id="growth-mediocre-stamina" min="1" max="50" value="8" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">å¥½æ„Ÿåº¦</label>
                                    <input type="number" id="growth-mediocre-favorability" min="1" max="10" value="3" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">æ”»å‡»</label>
                                    <input type="number" id="growth-mediocre-attack" min="1" max="10" value="2" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">é˜²å¾¡</label>
                                    <input type="number" id="growth-mediocre-defense" min="1" max="10" value="1" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-green-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">æ•æ·</label>
                                    <input type="number" id="growth-mediocre-agility" min="1" max="10" value="1" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-green-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- è¶…å¸¸æˆé•¿ -->
                        <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-600 mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-blue-300">â­â­ è¶…å¸¸æˆé•¿ (1.5x)</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs text-gray-400">ç”Ÿå‘½å€¼</label>
                                    <input type="number" id="growth-extraordinary-health" min="1" max="100" value="15" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">ä½“åŠ›</label>
                                    <input type="number" id="growth-extraordinary-stamina" min="1" max="50" value="12" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">å¥½æ„Ÿåº¦</label>
                                    <input type="number" id="growth-extraordinary-favorability" min="1" max="10" value="5" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">æ”»å‡»</label>
                                    <input type="number" id="growth-extraordinary-attack" min="1" max="10" value="3" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">é˜²å¾¡</label>
                                    <input type="number" id="growth-extraordinary-defense" min="1" max="10" value="2" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">æ•æ·</label>
                                    <input type="number" id="growth-extraordinary-agility" min="1" max="10" value="2" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç’€ç’¨æˆé•¿ -->
                        <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-600">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-purple-300">â­â­â­ ç’€ç’¨æˆé•¿ (2.0x)</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs text-gray-400">ç”Ÿå‘½å€¼</label>
                                    <input type="number" id="growth-brilliant-health" min="1" max="100" value="20" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">ä½“åŠ›</label>
                                    <input type="number" id="growth-brilliant-stamina" min="1" max="50" value="16" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">å¥½æ„Ÿåº¦</label>
                                    <input type="number" id="growth-brilliant-favorability" min="1" max="10" value="7" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">æ”»å‡»</label>
                                    <input type="number" id="growth-brilliant-attack" min="1" max="10" value="4" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">é˜²å¾¡</label>
                                    <input type="number" id="growth-brilliant-defense" min="1" max="10" value="3" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">æ•æ·</label>
                                    <input type="number" id="growth-brilliant-agility" min="1" max="10" value="3" required
                                        class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-purple-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æŠ€èƒ½æ± é€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ¯ æŠ€èƒ½æ± é€‰æ‹©</label>
                        <p class="text-xs text-gray-400 mb-3">ğŸ’¡ é€‰æ‹©ä¸€ä¸ªæŠ€èƒ½æ± ï¼ŒåŠ¨ç‰©å°†ä»ä¸­éšæœºè·å¾—æŠ€èƒ½ï¼ˆæ•°é‡ç”±æŠ€èƒ½æ§½ä½æ•°å†³å®šï¼‰</p>
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                            <div class="flex gap-2 mb-3">
                                <select id="skillpool-select"
                                    class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500">
                                    <option value="">-- é€‰æ‹©æŠ€èƒ½æ±  --</option>
                                </select>
                                <a href="skillpool_designer.html" target="_blank"
                                    class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors whitespace-nowrap">
                                    âš™ï¸ ç®¡ç†æŠ€èƒ½æ± 
                                </a>
                            </div>
                            <div id="selected-skillpool-info" class="hidden bg-purple-900/30 border border-purple-600 rounded-lg p-3">
                                <!-- é€‰ä¸­çš„æŠ€èƒ½æ± ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                            </div>
                        </div>
                    </div>

                    <!-- æè¿° -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">åŠ¨ç‰©æè¿°</label>
                        <textarea id="animal-desc" rows="2"
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-green-500"
                            placeholder="æè¿°è¿™ä¸ªåŠ¨ç‰©çš„ç‰¹ç‚¹..."></textarea>
                    </div>

                    <!-- æŒ‰é’® -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="submit-btn"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            <span id="submit-text">âœ¨ åˆ›å»ºåŠ¨ç‰©æ¨¡æ¿</span>
                        </button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            âŒ å–æ¶ˆç¼–è¾‘
                        </button>
                        <button type="button" id="clear-btn"
                            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            ğŸ”„ æ¸…ç©º
                        </button>
                    </div>
                </form>
            </div>

            <!-- å³ä¾§ï¼šåŠ¨ç‰©é¢„è§ˆå’Œåˆ—è¡¨ -->
            <div class="space-y-6">
                <!-- 3Dæ¨¡å‹é¢„è§ˆ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">ğŸ¨ 3Dæ¨¡å‹é¢„è§ˆ</h3>
                        <label for="model-file-input" class="bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold py-2 px-3 rounded-lg transition-colors cursor-pointer">
                            ğŸ“ å¯¼å…¥GLB
                        </label>
                        <input type="file" id="model-file-input" accept=".glb,.gltf" class="hidden">
                    </div>
                    <div id="model-preview-container" class="relative">
                        <canvas id="model-preview-canvas"></canvas>
                        <div class="model-controls">
                            <button class="model-control-btn active" data-shape="sphere" title="çƒä½“">ğŸ”µ çƒä½“</button>
                            <button class="model-control-btn" data-shape="cube" title="ç«‹æ–¹ä½“">ğŸŸ¦ ç«‹æ–¹ä½“</button>
                            <button class="model-control-btn" data-shape="cone" title="é”¥ä½“">ğŸ”º é”¥ä½“</button>
                            <button class="model-control-btn" data-shape="torus" title="ç¯ä½“">ğŸ© ç¯ä½“</button>
                            <button class="model-control-btn" data-shape="octahedron" title="å…«é¢ä½“">ğŸ’ å…«é¢ä½“</button>
                            <button class="model-control-btn" data-shape="custom" title="è‡ªå®šä¹‰æ¨¡å‹" id="custom-model-btn" style="display:none;">ğŸ“¦ è‡ªå®šä¹‰</button>
                        </div>
                        <div class="text-xs text-gray-400 text-center mt-2">
                            æ‹–åŠ¨æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | æ”¯æŒå¯¼å…¥GLB/GLTFæ¨¡å‹
                        </div>
                        <div id="model-info" class="text-xs text-green-400 text-center mt-1" style="display:none;"></div>
                    </div>
                </div>
                
                <!-- åŠ¨ç‰©å±æ€§é¢„è§ˆ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ“‹ å±æ€§é¢„è§ˆ</h3>
                    <div id="animal-preview" class="animal-card bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">â“</div>
                            <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                        </div>
                    </div>
                </div>

                <!-- åŠ¨ç‰©æ¨¡æ¿æ±  -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">ğŸ¦ åŠ¨ç‰©æ¨¡æ¿æ±  (<span id="animal-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <label for="import-file"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer">
                                ğŸ“¤ å¯¼å…¥
                            </label>
                            <input type="file" id="import-file" accept=".json" class="hidden">
                            <button id="export-btn"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ“¥ å¯¼å‡ºJSON
                            </button>
                            <button id="export-csv-btn"
                                class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ“Š å¯¼å‡ºCSV
                            </button>
                            <button id="apply-to-game-btn"
                                class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ® åº”ç”¨
                            </button>
                        </div>
                    </div>
                    <div id="animals-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 text-sm py-8">
                            æš‚æ— åŠ¨ç‰©æ¨¡æ¿
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ€èƒ½é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="skill-select-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-xl p-6 max-w-2xl w-full mx-4 border border-gray-700 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">ä»æŠ€èƒ½æ± é€‰æ‹©æŠ€èƒ½</h3>
                <button id="close-skill-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>
            <div id="skill-pool-list" class="space-y-2">
                <!-- æŠ€èƒ½åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <script>
        // åŠ¨ç‰©æ¨¡æ¿æ± å­˜å‚¨
        let animals = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
        // æŠ€èƒ½æ± 
        let skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
        // å½“å‰é…ç½®çš„æŠ€èƒ½
        let configuredSkills = [];
        // å½“å‰ç¼–è¾‘çš„åŠ¨ç‰©ç´¢å¼•
        let editingIndex = -1;
        // å½“å‰é€‰æ‹©çš„å¤´åƒæ•°æ®
        let currentAvatarData = null;
        // å¤´åƒæ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼ˆç”¨äºåŒºåˆ†"æœªä¿®æ”¹"å’Œ"ä¸»åŠ¨æ¸…é™¤"ï¼‰
        let avatarModified = false;
        
        // 3Dæ¨¡å‹ç›¸å…³
        let scene, camera, renderer, animalMesh, currentShape = 'sphere';
        let isMouseDown = false;
        let mouseX = 0, mouseY = 0;
        let customModelData = null; // å­˜å‚¨è‡ªå®šä¹‰æ¨¡å‹çš„Base64æ•°æ®
        let gltfLoader = null; // GLTFåŠ è½½å™¨

        // DOMå…ƒç´ 
        const form = document.getElementById('animal-form');
        const preview = document.getElementById('animal-preview');
        const animalsList = document.getElementById('animals-list');
        const clearBtn = document.getElementById('clear-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const exportBtn = document.getElementById('export-btn');
        const colorInput = document.getElementById('animal-color');
        const colorHexInput = document.getElementById('animal-color-hex');

        // åˆå§‹åŒ–
        function init() {
            renderAnimalsList();
            setupFormListeners();
            updateAnimalCount();
            syncColorInputs();
            setupSkillModal();
            setupAvatarUpload();
            init3DPreview(); // åˆå§‹åŒ–3Dé¢„è§ˆ
        }
        
        // è®¾ç½®å¤´åƒä¸Šä¼ 
        function setupAvatarUpload() {
            const avatarInput = document.getElementById('animal-avatar-input');
            const avatarFilename = document.getElementById('avatar-filename');
            const avatarPreview = document.getElementById('avatar-preview');
            const avatarPreviewImg = document.getElementById('avatar-preview-img');
            const clearAvatarBtn = document.getElementById('clear-avatar-btn');
            
            avatarInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶2MBï¼‰
                if (file.size > 2 * 1024 * 1024) {
                    alert('âŒ å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼è¯·é€‰æ‹©å°äº2MBçš„å›¾ç‰‡ã€‚');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64Data = event.target.result;
                    currentAvatarData = base64Data;
                    avatarModified = true;  // æ ‡è®°å¤´åƒå·²ä¿®æ”¹
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    avatarPreviewImg.src = base64Data;
                    avatarPreview.classList.remove('hidden');
                    avatarFilename.textContent = file.name;
                    clearAvatarBtn.classList.remove('hidden');
                    updatePreview();  // æ›´æ–°é¢„è§ˆ
                };
                reader.readAsDataURL(file);
            });
            
            clearAvatarBtn.addEventListener('click', () => {
                currentAvatarData = null;
                avatarModified = true;  // æ ‡è®°å¤´åƒå·²ä¿®æ”¹ï¼ˆæ¸…é™¤ï¼‰
                avatarInput.value = '';
                avatarPreview.classList.add('hidden');
                avatarFilename.textContent = 'ç‚¹å‡»é€‰æ‹©å›¾ç‰‡';
                clearAvatarBtn.classList.add('hidden');
                updatePreview();  // æ›´æ–°é¢„è§ˆ
            });
        }
        
        // åˆå§‹åŒ–3Dé¢„è§ˆ
        function init3DPreview() {
            const canvas = document.getElementById('model-preview-canvas');
            const container = document.getElementById('model-preview-container');
            
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0f172a);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / 300, 0.1, 1000);
            camera.position.z = 3;
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, 300);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // æ·»åŠ å…‰æº
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-5, -5, -5);
            scene.add(directionalLight2);
            
            // åˆå§‹åŒ–GLTFLoaderï¼ˆä½¿ç”¨è½®è¯¢ç¡®ä¿åŠ è½½å®Œæˆï¼‰
            const initGLTFLoader = () => {
                if (typeof THREE !== 'undefined' && THREE.GLTFLoader) {
                    gltfLoader = new THREE.GLTFLoader();
                    console.log('âœ… GLTFLoaderå·²åˆå§‹åŒ–');
                } else {
                    console.log('â³ ç­‰å¾…GLTFLoaderåŠ è½½...');
                    setTimeout(initGLTFLoader, 100);
                }
            };
            initGLTFLoader();
            
            // åˆ›å»ºåˆå§‹åŠ¨ç‰©æ¨¡å‹
            createAnimalModel('#3b82f6', 'sphere');
            
            // è®¾ç½®å½¢çŠ¶åˆ‡æ¢æŒ‰é’®
            document.querySelectorAll('.model-control-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.model-control-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentShape = this.dataset.shape;
                    const color = document.getElementById('animal-color-hex').value || '#3b82f6';
                    if (currentShape === 'custom' && customModelData) {
                        loadCustomModel(customModelData);
                    } else {
                        createAnimalModel(color, currentShape);
                    }
                });
            });
            
            // è®¾ç½®GLBæ–‡ä»¶å¯¼å…¥
            const modelFileInput = document.getElementById('model-file-input');
            modelFileInput.addEventListener('change', handleModelFileUpload);
            
            // é¼ æ ‡äº¤äº’
            canvas.addEventListener('mousedown', (e) => {
                isMouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isMouseDown || !animalMesh) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                animalMesh.rotation.y += deltaX * 0.01;
                animalMesh.rotation.x += deltaY * 0.01;
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            canvas.addEventListener('mouseleave', () => {
                isMouseDown = false;
            });
            
            // æ»šè½®ç¼©æ”¾
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                camera.position.z += e.deltaY * 0.01;
                camera.position.z = Math.max(1.5, Math.min(5, camera.position.z));
            });
            
            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', () => {
                const width = canvas.clientWidth;
                camera.aspect = width / 300;
                camera.updateProjectionMatrix();
                renderer.setSize(width, 300);
            });
            
            // åŠ¨ç”»å¾ªç¯
            animate3D();
        }
        
        // å¤„ç†GLBæ–‡ä»¶ä¸Šä¼ 
        function handleModelFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“ å¼€å§‹åŠ è½½æ–‡ä»¶:', file.name);
            
            // æ£€æŸ¥GLTFLoaderæ˜¯å¦å·²åˆå§‹åŒ–
            const tryLoadModel = () => {
                if (!gltfLoader) {
                    console.log('â³ GLTFLoaderæœªå°±ç»ªï¼Œç­‰å¾…åˆå§‹åŒ–...');
                    setTimeout(tryLoadModel, 100);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const arrayBuffer = e.target.result;
                        console.log('ğŸ“¦ æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¤§å°:', arrayBuffer.byteLength, 'bytes');
                        
                        // è½¬æ¢ä¸ºBase64ä»¥ä¾¿å­˜å‚¨
                        const base64 = arrayBufferToBase64(arrayBuffer);
                        customModelData = base64;
                        console.log('âœ… Base64è½¬æ¢å®Œæˆ');
                        
                        // åŠ è½½æ¨¡å‹
                        loadCustomModel(base64, file.name);
                        
                        // æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹æŒ‰é’®
                        const customBtn = document.getElementById('custom-model-btn');
                        customBtn.style.display = 'inline-block';
                        
                        // è‡ªåŠ¨åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å‹
                        document.querySelectorAll('.model-control-btn').forEach(b => b.classList.remove('active'));
                        customBtn.classList.add('active');
                        currentShape = 'custom';
                        
                    } catch (error) {
                        console.error('âŒ æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
                        alert('âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('âŒ æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                    alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼');
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            tryLoadModel();
            
            // æ¸…ç©ºinputä»¥å…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        }
        
        // åŠ è½½è‡ªå®šä¹‰GLBæ¨¡å‹
        function loadCustomModel(base64Data, fileName = 'è‡ªå®šä¹‰æ¨¡å‹') {
            if (!gltfLoader) {
                console.error('âŒ GLTFLoaderæœªåˆå§‹åŒ–');
                alert('âŒ GLTFLoaderæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            console.log('ğŸ”„ å¼€å§‹è§£æGLBæ¨¡å‹...');
            
            // ç§»é™¤æ—§æ¨¡å‹
            if (animalMesh) {
                scene.remove(animalMesh);
                if (animalMesh.geometry) animalMesh.geometry.dispose();
                if (animalMesh.material) {
                    if (Array.isArray(animalMesh.material)) {
                        animalMesh.material.forEach(m => m.dispose());
                    } else {
                        animalMesh.material.dispose();
                    }
                }
                animalMesh = null;
            }
            
            try {
                // å°†Base64è½¬å›ArrayBuffer
                const arrayBuffer = base64ToArrayBuffer(base64Data);
                console.log('ğŸ“¦ ArrayBufferå¤§å°:', arrayBuffer.byteLength, 'bytes');
                
                // ä½¿ç”¨GLTFLoaderåŠ è½½
                gltfLoader.parse(arrayBuffer, '',
                    function(gltf) {
                        console.log('âœ… GLTFè§£ææˆåŠŸ');
                        const model = gltf.scene;
                        
                        // è®¡ç®—æ¨¡å‹è¾¹ç•Œå¹¶è°ƒæ•´å¤§å°
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        
                        console.log('ğŸ“ æ¨¡å‹å°ºå¯¸:', size.x.toFixed(2), size.y.toFixed(2), size.z.toFixed(2));
                        
                        if (maxDim > 0) {
                            const scale = 2 / maxDim; // ç¼©æ”¾åˆ°åˆé€‚å¤§å°
                            model.scale.setScalar(scale);
                            console.log('ğŸ” ç¼©æ”¾æ¯”ä¾‹:', scale.toFixed(3));
                        }
                        
                        // å±…ä¸­æ¨¡å‹
                        const center = box.getCenter(new THREE.Vector3());
                        model.position.sub(center.multiplyScalar(model.scale.x));
                        
                        // åº”ç”¨é¢œè‰²ï¼ˆå¦‚æœå¯èƒ½ï¼‰
                        const color = document.getElementById('animal-color-hex').value || '#3b82f6';
                        applyColorToModel(model, color);
                        
                        // æ·»åŠ åˆ°åœºæ™¯
                        animalMesh = model;
                        scene.add(animalMesh);
                        
                        // è°ƒæ•´ç›¸æœºä½ç½®ä»¥ç¡®ä¿æ¨¡å‹å¯è§
                        camera.position.z = 3;
                        camera.lookAt(0, 0, 0);
                        
                        console.log('âœ… GLBæ¨¡å‹åŠ è½½æˆåŠŸ');
                        
                        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                        const modelInfo = document.getElementById('model-info');
                        modelInfo.textContent = `âœ… å·²åŠ è½½: ${fileName}`;
                        modelInfo.style.display = 'block';
                        modelInfo.className = 'text-xs text-green-400 text-center mt-1';
                        
                    },
                    function(error) {
                        console.error('âŒ åŠ è½½GLBæ¨¡å‹å¤±è´¥:', error);
                        alert('âŒ åŠ è½½æ¨¡å‹å¤±è´¥: ' + error.message + '\n\nè¯·ç¡®ä¿æ–‡ä»¶æ˜¯æœ‰æ•ˆçš„GLB/GLTFæ ¼å¼ï¼');
                        
                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        const modelInfo = document.getElementById('model-info');
                        modelInfo.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
                        modelInfo.style.display = 'block';
                        modelInfo.className = 'text-xs text-red-400 text-center mt-1';
                        
                        // å›é€€åˆ°é»˜è®¤å½¢çŠ¶
                        currentShape = 'sphere';
                        const color = document.getElementById('animal-color-hex').value || '#3b82f6';
                        createAnimalModel(color, 'sphere');
                    }
                );
            } catch (error) {
                console.error('âŒ æ¨¡å‹åŠ è½½å¼‚å¸¸:', error);
                alert('âŒ æ¨¡å‹åŠ è½½å¼‚å¸¸: ' + error.message);
                
                // å›é€€åˆ°é»˜è®¤å½¢çŠ¶
                currentShape = 'sphere';
                const color = document.getElementById('animal-color-hex').value || '#3b82f6';
                createAnimalModel(color, 'sphere');
            }
        }
        
        // åº”ç”¨é¢œè‰²åˆ°æ¨¡å‹
        function applyColorToModel(model, colorHex) {
            const color = new THREE.Color(colorHex);
            model.traverse((child) => {
                if (child.isMesh && child.material) {
                    if (Array.isArray(child.material)) {
                        child.material.forEach(mat => {
                            if (mat.color) mat.color.set(color);
                        });
                    } else {
                        if (child.material.color) {
                            child.material.color.set(color);
                        }
                    }
                }
            });
        }
        
        // ArrayBufferè½¬Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        // Base64è½¬ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        // åˆ›å»ºåŠ¨ç‰©3Dæ¨¡å‹
        function createAnimalModel(colorHex, shape = 'sphere') {
            // å¦‚æœæ˜¯è‡ªå®šä¹‰æ¨¡å‹ï¼Œä½¿ç”¨åŠ è½½çš„æ¨¡å‹
            if (shape === 'custom' && customModelData) {
                loadCustomModel(customModelData);
                return;
            }
            
            // ç§»é™¤æ—§æ¨¡å‹
            if (animalMesh) {
                scene.remove(animalMesh);
                if (animalMesh.geometry) animalMesh.geometry.dispose();
                if (animalMesh.material) {
                    if (Array.isArray(animalMesh.material)) {
                        animalMesh.material.forEach(m => m.dispose());
                    } else {
                        animalMesh.material.dispose();
                    }
                }
            }
            
            // åˆ›å»ºå‡ ä½•ä½“
            let geometry;
            switch(shape) {
                case 'cube':
                    geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.8, 1.8, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(0.8, 0.3, 16, 100);
                    break;
                case 'octahedron':
                    geometry = new THREE.OctahedronGeometry(1.2, 0);
                    break;
                case 'sphere':
                default:
                    geometry = new THREE.SphereGeometry(1, 32, 32);
                    break;
            }
            
            // åˆ›å»ºæè´¨
            const color = new THREE.Color(colorHex);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 100,
                specular: 0x444444,
                emissive: color.clone().multiplyScalar(0.1)
            });
            
            // åˆ›å»ºç½‘æ ¼
            animalMesh = new THREE.Mesh(geometry, material);
            scene.add(animalMesh);
        }
        
        // 3DåŠ¨ç”»å¾ªç¯
        function animate3D() {
            requestAnimationFrame(animate3D);
            
            // è‡ªåŠ¨æ—‹è½¬ï¼ˆå½“ä¸æ‹–åŠ¨æ—¶ï¼‰
            if (!isMouseDown && animalMesh) {
                animalMesh.rotation.y += 0.005;
            }
            
            renderer.render(scene, camera);
        }
        
        // æ›´æ–°3Dæ¨¡å‹é¢œè‰²
        function update3DModelColor(colorHex) {
            if (!animalMesh) return;
            
            if (currentShape === 'custom') {
                // è‡ªå®šä¹‰æ¨¡å‹ï¼šéå†æ‰€æœ‰æè´¨
                applyColorToModel(animalMesh, colorHex);
            } else {
                // åŸºç¡€å‡ ä½•ä½“ï¼šç›´æ¥è®¾ç½®æè´¨é¢œè‰²
                if (animalMesh.material) {
                    const color = new THREE.Color(colorHex);
                    animalMesh.material.color.set(color);
                    animalMesh.material.emissive.set(color.clone().multiplyScalar(0.1));
                }
            }
        }

        // ä¸å†éœ€è¦updateSkillSlotsDisplayå‡½æ•°

        // è®¾ç½®æŠ€èƒ½æ± é€‰æ‹©å™¨
        function setupSkillModal() {
            const skillpoolSelect = document.getElementById('skillpool-select');
            
            // åˆå§‹åŠ è½½æŠ€èƒ½æ± åˆ—è¡¨
            loadSkillPoolOptions();
            
            // ç›‘å¬æŠ€èƒ½æ± é€‰æ‹©å˜åŒ–
            skillpoolSelect.addEventListener('change', function() {
                const poolKey = this.value;
                if (poolKey) {
                    showSkillPoolInfo(poolKey);
                } else {
                    document.getElementById('selected-skillpool-info').classList.add('hidden');
                }
                updatePreview();
            });
            
            // ç›‘å¬é¡µé¢è·å¾—ç„¦ç‚¹æ—¶åˆ·æ–°æŠ€èƒ½æ± åˆ—è¡¨ï¼ˆä»æŠ€èƒ½æ± ç®¡ç†é¡µè¿”å›æ—¶ï¼‰
            window.addEventListener('focus', function() {
                const currentValue = skillpoolSelect.value;
                loadSkillPoolOptions(currentValue);
            });
        }

        // åŠ è½½æŠ€èƒ½æ± é€‰é¡¹
        function loadSkillPoolOptions(selectedKey = '') {
            const skillPools = JSON.parse(localStorage.getItem('SKILL_POOLS') || '[]');
            const skillpoolSelect = document.getElementById('skillpool-select');
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……é€‰é¡¹
            skillpoolSelect.innerHTML = '<option value="">-- é€‰æ‹©æŠ€èƒ½æ±  --</option>';
            
            skillPools.forEach(pool => {
                const option = document.createElement('option');
                option.value = pool.key;
                option.textContent = `${pool.icon} ${pool.name} (${pool.skills.length}ä¸ªæŠ€èƒ½)`;
                skillpoolSelect.appendChild(option);
            });
            
            // è®¾ç½®é€‰ä¸­å€¼
            if (selectedKey) {
                skillpoolSelect.value = selectedKey;
                if (skillpoolSelect.value === selectedKey) {
                    showSkillPoolInfo(selectedKey);
                }
            } else {
                // ç¡®ä¿éšè—æŠ€èƒ½æ± ä¿¡æ¯
                document.getElementById('selected-skillpool-info').classList.add('hidden');
            }
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„æŠ€èƒ½æ± ä¿¡æ¯
        function showSkillPoolInfo(poolKey) {
            const skillPools = JSON.parse(localStorage.getItem('SKILL_POOLS') || '[]');
            const pool = skillPools.find(p => p.key === poolKey);
            
            if (!pool) {
                document.getElementById('selected-skillpool-info').classList.add('hidden');
                return;
            }

            const totalWeight = pool.skills.reduce((sum, s) => sum + (s.weight || 0), 0);
            const rarityStats = {};
            pool.skills.forEach(s => {
                rarityStats[s.rarity] = (rarityStats[s.rarity] || 0) + 1;
            });

            const rarityLabels = {
                'common': 'âšªæ™®é€š',
                'rare': 'âœ¨ç¨€æœ‰',
                'epic': 'ğŸŒˆå²è¯—',
                'legendary': 'â­ä¼ è¯´'
            };

            const infoDiv = document.getElementById('selected-skillpool-info');
            infoDiv.innerHTML = `
                <div class="flex items-start gap-2">
                    <div class="text-2xl">${pool.icon}</div>
                    <div class="flex-1">
                        <div class="text-sm font-bold text-purple-300 mb-1">${pool.name}</div>
                        ${pool.description ? `<div class="text-xs text-gray-400 mb-2">${pool.description}</div>` : ''}
                        <div class="flex gap-2 text-xs mb-2">
                            <span class="text-purple-200">ğŸ“Š ${pool.skills.length}ä¸ªæŠ€èƒ½</span>
                            <span class="${totalWeight === 100 ? 'text-green-400' : 'text-yellow-400'}">âš–ï¸ ${totalWeight.toFixed(1)}%</span>
                        </div>
                        <div class="flex gap-1 text-xs flex-wrap">
                            ${Object.entries(rarityStats).map(([r, c]) =>
                                `<span class="bg-purple-600/20 text-purple-200 px-2 py-0.5 rounded">${rarityLabels[r]}Ã—${c}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
            infoDiv.classList.remove('hidden');
        }

        // ä¸å†éœ€è¦è¿™äº›å‡½æ•°ï¼Œå·²è¢«æŠ€èƒ½æ± é€‰æ‹©å™¨æ›¿ä»£

        // è·å–æŠ€èƒ½ç±»å‹åç§°
        function getTypeName(type) {
            const names = {
                'attack': 'æ”»å‡»',
                'defense': 'é˜²å¾¡',
                'agility': 'æ•æ·',
                'buff': 'å¢ç›Š',
                'debuff': 'å‡ç›Š',
                'heal': 'æ²»ç–—',
                'passive': 'è¢«åŠ¨'
            };
            return names[type] || type;
        }

        // é€‰æ‹©æŠ€èƒ½ï¼ˆæ·»åŠ åˆ°æŠ€èƒ½æ± ï¼‰
        function selectSkill(skillKey) {
            const skill = skillPool.find(s => s.key === skillKey);
            if (!skill) return;

            // æ·»åŠ åˆ°æŠ€èƒ½æ± ï¼Œå¸¦ç¨€æœ‰åº¦å’Œæƒé‡é…ç½®
            // æ ¹æ®æŠ€èƒ½ç±»åˆ«è®¾ç½®é»˜è®¤ç¨€æœ‰åº¦å’Œæƒé‡
            let defaultRarity = 'common';
            let defaultWeight = 50;
            
            // æ ¹æ®æŠ€èƒ½ç±»åˆ«åˆ¤æ–­é»˜è®¤ç¨€æœ‰åº¦
            if (skill.category && skill.category.includes('mutation')) {
                if (skill.category.includes('eternal') || skill.category.includes('source') || skill.category.includes('lord')) {
                    defaultRarity = 'stellar'; // ä¼ è¯´çº§å˜å¼‚
                    defaultWeight = 5;
                } else if (skill.category.includes('chaos') || skill.category.includes('holy') ||
                           skill.category.includes('psychic') || skill.category.includes('thunder')) {
                    defaultRarity = 'prismatic'; // ç²¾è‹±çº§å˜å¼‚
                    defaultWeight = 15;
                } else {
                    defaultRarity = 'shiny'; // åŸºç¡€çº§å˜å¼‚
                    defaultWeight = 30;
                }
            }

            configuredSkills.push({
                skillKey: skill.key,
                rarity: defaultRarity,
                weight: defaultWeight,
                unlockLevel: 1
            });

            renderConfiguredSkills();
            document.getElementById('skill-select-modal').classList.add('hidden');
        }

        // æ¸²æŸ“å·²é…ç½®çš„æŠ€èƒ½æ± 
        function renderConfiguredSkills() {
            const list = document.getElementById('skills-config-list');
            document.getElementById('skill-count-display').textContent = configuredSkills.length;

            if (configuredSkills.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-4">
                        ç‚¹å‡»"æ·»åŠ æŠ€èƒ½åˆ°æ± "é€‰æ‹©æŠ€èƒ½å¹¶é…ç½®æƒé‡
                    </div>
                `;
                return;
            }

            const typeIcons = {
                'attack': 'âš”ï¸',
                'defense': 'ğŸ›¡ï¸',
                'agility': 'âš¡',
                'buff': 'ğŸ’ª',
                'debuff': 'ğŸ”»',
                'heal': 'ğŸ’š',
                'passive': 'ğŸŒŸ'
            };

            // è®¡ç®—æƒé‡æ€»å’Œå’Œç¨€æœ‰åº¦åˆ†å¸ƒ
            const totalWeight = configuredSkills.reduce((sum, s) => sum + (s.weight || 0), 0);
            const rarityStats = {};
            configuredSkills.forEach(s => {
                rarityStats[s.rarity] = (rarityStats[s.rarity] || 0) + 1;
            });

            list.innerHTML = `
                <!-- æŠ€èƒ½æ± ç»Ÿè®¡ -->
                <div class="bg-blue-900/30 border border-blue-600 rounded-lg p-3 mb-3">
                    <div class="flex justify-between items-center text-xs">
                        <div class="text-blue-300">
                            <span class="font-bold">æŠ€èƒ½æ± ç»Ÿè®¡ï¼š</span>
                            <span>å…±${configuredSkills.length}ä¸ªæŠ€èƒ½</span>
                        </div>
                        <div class="flex gap-2">
                            ${Object.entries(rarityStats).map(([rarity, count]) => {
                                const rarityLabels = {
                                    'common': 'âšª',
                                    'shiny': 'âœ¨',
                                    'prismatic': 'ğŸŒˆ',
                                    'stellar': 'â­'
                                };
                                return `<span class="text-blue-200">${rarityLabels[rarity]}${count}</span>`;
                            }).join(' ')}
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        æƒé‡æ€»å’Œ: <span class="${totalWeight === 100 ? 'text-green-400' : 'text-yellow-400'}">${totalWeight.toFixed(1)}%</span>
                        ${totalWeight !== 100 ? ' âš ï¸ å»ºè®®è®¾ä¸º100%' : ' âœ“'}
                    </div>
                </div>

                <!-- æŠ€èƒ½åˆ—è¡¨ -->
                ${configuredSkills.map((config, index) => {
                    const skill = skillPool.find(s => s.key === config.skillKey);
                    if (!skill) return '';

                    const typeIcon = typeIcons[skill.type] || '';
                    const typeName = getTypeName(skill.type);
                    
                    // ç”ŸæˆæŠ€èƒ½æè¿°
                    const skillDesc = skill.description || skill.desc || 'æ— æè¿°';

                    // è·å–æŠ€èƒ½å‚æ•°
                    const params = skill.params || {};
                    const paramTags = [];
                    
                    // CDå’ŒæŒç»­æ—¶é—´
                    if (params.cooldown > 0) {
                        paramTags.push(`<span class="bg-red-600/30 text-red-300 px-1.5 py-0.5 rounded">CD${params.cooldown}</span>`);
                    }
                    if (params.duration > 0) {
                        paramTags.push(`<span class="bg-yellow-600/30 text-yellow-300 px-1.5 py-0.5 rounded">æŒç»­${params.duration}</span>`);
                    }
                    
                    // ç¨€æœ‰åº¦é¢œè‰²
                    const rarityClasses = {
                        'common': 'gray',
                        'shiny': 'yellow',
                        'prismatic': 'pink',
                        'stellar': 'orange'
                    };
                    const rarityClass = rarityClasses[config.rarity] || 'gray';
                    
                    const rarityLabels = {
                        'common': 'âšª æ™®é€š',
                        'shiny': 'âœ¨ é—ªå…‰',
                        'prismatic': 'ğŸŒˆ å¹»å½©',
                        'stellar': 'â­ æ˜ŸèŠ’'
                    };

                    return `
                        <div class="bg-gray-700/50 rounded-lg p-2 border border-${rarityClass}-600/50">
                            <div class="flex items-start gap-2">
                                <div class="text-xl flex-shrink-0">${skill.icon}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-1 mb-1 flex-wrap">
                                        <span class="text-sm font-bold text-white truncate">${skill.name}</span>
                                        <span class="category-badge ${skill.category} text-xs">${getCategoryName(skill.category)}</span>
                                        <span class="bg-blue-600/30 text-blue-300 px-1.5 py-0.5 rounded text-xs">${typeIcon} ${typeName}</span>
                                    </div>
                                    <p class="text-xs text-gray-400 mb-2 line-clamp-1">${skillDesc}</p>
                                    ${paramTags.length > 0 ? `<div class="flex flex-wrap gap-1 text-xs mb-2">
                                        ${paramTags.join('')}
                                    </div>` : ''}
                                    
                                    <!-- ç¨€æœ‰åº¦å’Œæƒé‡é…ç½® -->
                                    <div class="grid grid-cols-3 gap-2 mt-2">
                                        <div>
                                            <label class="text-xs text-gray-500">ç¨€æœ‰åº¦</label>
                                            <select onchange="updateSkillRarity(${index}, this.value)"
                                                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-${rarityClass}-500">
                                                <option value="common" ${config.rarity === 'common' ? 'selected' : ''}>âšª æ™®é€š</option>
                                                <option value="shiny" ${config.rarity === 'shiny' ? 'selected' : ''}>âœ¨ é—ªå…‰</option>
                                                <option value="prismatic" ${config.rarity === 'prismatic' ? 'selected' : ''}>ğŸŒˆ å¹»å½©</option>
                                                <option value="stellar" ${config.rarity === 'stellar' ? 'selected' : ''}>â­ æ˜ŸèŠ’</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">æƒé‡%</label>
                                            <input type="number" min="0" max="100" step="0.1" value="${config.weight || 0}"
                                                onchange="updateSkillWeight(${index}, this.value)"
                                                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-${rarityClass}-500">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500">è§£é”Lv</label>
                                            <input type="number" min="1" max="100" value="${config.unlockLevel || 1}"
                                                onchange="updateSkillLevel(${index}, this.value)"
                                                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-${rarityClass}-500">
                                        </div>
                                    </div>
                                </div>
                                <button onclick="removeSkill(${index})"
                                    class="text-red-400 hover:text-red-300 text-xl flex-shrink-0">
                                    Ã—
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }

        // è·å–æ•ˆæœåç§°
        function getEffectName(effect) {
            const names = {
                'direct_attack': 'ç›´æ¥æ”»å‡»',
                'multi_attack': 'å¤šæ®µæ”»å‡»',
                'dot_damage': 'æŒç»­ä¼¤å®³',
                'percent_damage': 'ç™¾åˆ†æ¯”ä¼¤å®³',
                'direct_defense': 'ç›´æ¥é˜²å¾¡',
                'continuous_defense': 'æŒç»­é˜²å¾¡',
                'defense_counter': 'é˜²å¾¡åå‡»',
                'direct_speed': 'ç›´æ¥å¢é€Ÿ',
                'continuous_speed': 'æŒç»­å¢é€Ÿ',
                'buff_attack_damage': 'æ”»å‡»å¢ä¼¤',
                'buff_attack_defense': 'æ”»å‡»å¢é˜²',
                'buff_attack_speed': 'æ”»å‡»å¢é€Ÿ',
                'buff_attack_status': 'æ”»å‡»å¢ç›Š',
                'buff_defense_damage': 'é˜²å¾¡å¢ä¼¤',
                'buff_defense_speed': 'é˜²å¾¡å¢é€Ÿ',
                'buff_defense_defense': 'é˜²å¾¡å¢é˜²',
                'buff_defense_status': 'é˜²å¾¡å¢ç›Š',
                'buff_speed': 'å¢é€Ÿ',
                'buff_status_enemy': 'æ–½åŠ å¼‚å¸¸',
                'buff_purify': 'å‡€åŒ–',
                'buff_heal_amp': 'å¢åŠ æ²»ç–—',
                'buff_element_damage': 'å±æ€§å¢ä¼¤',
                'debuff_attack_damage': 'æ”»å‡»å‡ä¼¤',
                'debuff_attack_defense': 'æ”»å‡»å‡é˜²',
                'debuff_attack_speed': 'æ”»å‡»å‡é€Ÿ',
                'debuff_attack_status': 'æ”»å‡»å‡ç›Š',
                'debuff_defense_damage': 'é˜²å¾¡å‡ä¼¤',
                'debuff_defense_defense': 'é˜²å¾¡å‡é˜²',
                'debuff_defense_speed': 'é˜²å¾¡å‡é€Ÿ',
                'debuff_defense_status': 'é˜²å¾¡å‡ç›Š',
                'debuff_speed': 'å‡é€Ÿ',
                'debuff_status_self': 'è‡ªèº«å¼‚å¸¸',
                'debuff_no_heal': 'ç¦ç–—',
                'debuff_heal_reduce': 'å‡ç–—',
                'debuff_element_damage': 'å±æ€§å‡ä¼¤',
                'heal_direct': 'ç›´æ¥æ¢å¤',
                'heal_continuous': 'æŒç»­æ¢å¤',
                'heal_percent': 'ç™¾åˆ†æ¯”æ¢å¤',
                'heal_rebirth': 'é‡ç”Ÿ',
                'heal_lifesteal': 'ç”Ÿå‘½æ±²å–',
                // æ—§ç‰ˆå…¼å®¹
                'damage': 'ä¼¤å®³',
                'critical': 'æš´å‡»',
                'lifesteal': 'å¸è¡€',
                'buff_attack': 'æ”»å‡»+',
                'buff_defense': 'é˜²å¾¡+',
                'buff_agility': 'æ•æ·+',
                'guaranteed_dodge': 'é—ªé¿',
                'counter': 'åå‡»',
                'passive_attack': 'è¢«åŠ¨æ”»å‡»',
                'passive_defense': 'è¢«åŠ¨é˜²å¾¡',
                'passive_agility': 'è¢«åŠ¨æ•æ·',
                'regen': 'å›å¤',
                'bonus_damage': 'é™„åŠ ä¼¤å®³',
                'armor_pierce': 'ç©¿é€',
                'true_damage': 'çœŸä¼¤',
                'damage_amp': 'ä¼¤å®³å¢å¹…',
                'damage_reduction': 'å‡ä¼¤',
                'burn': 'ç¼çƒ§',
                'freeze': 'å†°å†»',
                'poison': 'ä¸­æ¯’',
                'stun': 'çœ©æ™•',
                'rebirth': 'é‡ç”Ÿ'
            };
            return names[effect] || effect;
        }
        
        // è·å–æŠ€èƒ½æ•ˆæœæè¿°
        function getEffectDescription(skill) {
            const effect = skill.effect;
            const params = skill.params || {};
            
            const descriptions = {
                'direct_attack': `é€ æˆ ${params.attackBonus || 1}Ã— æ”»å‡»åŠ›çš„ä¼¤å®³`,
                'multi_attack': `è¿›è¡Œ ${params.count || 1} æ®µæ”»å‡»ï¼Œæ¯æ®µä¼¤å®³ä¸åŒ`,
                'dot_damage': `æ¯å›åˆé€ æˆ ${params.attackBonus || 1}Ã— æ”»å‡»åŠ›çš„æŒç»­ä¼¤å®³`,
                'percent_damage': `é€ æˆç›®æ ‡ ${(params.damagePercent || 0.1) * 100}% ç”Ÿå‘½çš„ä¼¤å®³`,
                'direct_defense': `æŠµæŒ¡ ${params.defenseBonus || 1}Ã— é˜²å¾¡åŠ›çš„ä¼¤å®³`,
                'continuous_defense': `æŒç»­æŠµæŒ¡ ${params.defenseBonus || 1}Ã— é˜²å¾¡åŠ›çš„ä¼¤å®³`,
                'defense_counter': `é˜²å¾¡å¹¶åå‡» ${params.counterBonus || 0.5}Ã— ä¼¤å®³`,
                'direct_speed': `å¢åŠ  ${(params.speedBonus || 0.2) * 100}% é€Ÿåº¦`,
                'continuous_speed': `æŒç»­å¢åŠ  ${(params.speedBonus || 0.2) * 100}% é€Ÿåº¦`,
                'buff_attack_damage': `å¢åŠ  ${(params.buffBonus || 0.2) * 100}% æ”»å‡»ä¼¤å®³`,
                'buff_attack_defense': `å¢åŠ  ${(params.buffBonus || 0.2) * 100}% é˜²å¾¡åŠ›`,
                'buff_attack_speed': `å¢åŠ  ${(params.buffBonus || 0.2) * 100}% é€Ÿåº¦`,
                'debuff_attack_damage': `é™ä½æ•Œæ–¹ ${(params.buffBonus || 0.2) * 100}% æ”»å‡»ä¼¤å®³`,
                'debuff_attack_defense': `é™ä½æ•Œæ–¹ ${(params.buffBonus || 0.2) * 100}% é˜²å¾¡åŠ›`,
                'heal_direct': `æ¢å¤ ${params.healBonus || 0.5}Ã— ç”Ÿå‘½`,
                'heal_continuous': `æ¯å›åˆæ¢å¤ ${params.healBonus || 0.5}Ã— ç”Ÿå‘½`,
                'heal_percent': `æ¢å¤ ${(params.healPercent || 0.3) * 100}% ç”Ÿå‘½`,
                'heal_lifesteal': `æ±²å– ${(params.lifestealBonus || 0.2) * 100}% ä¼¤å®³è½¬åŒ–ä¸ºç”Ÿå‘½`
            };
            
            return descriptions[effect] || getEffectName(effect);
        }
        
        // è·å–å¼‚å¸¸çŠ¶æ€åç§°
        function getStatusName(status) {
            const names = {
                'stun': 'çœ©æ™•',
                'poison': 'ä¸­æ¯’',
                'bleed': 'æµè¡€',
                'frostbite': 'å†»ä¼¤',
                'burn': 'çƒ§ä¼¤',
                'paralyze': 'éº»ç—¹'
            };
            return names[status] || status;
        }

        // æ›´æ–°æŠ€èƒ½ç¨€æœ‰åº¦
        function updateSkillRarity(index, rarity) {
            configuredSkills[index].rarity = rarity;
            renderConfiguredSkills();
        }

        // æ›´æ–°æŠ€èƒ½æƒé‡
        function updateSkillWeight(index, weight) {
            configuredSkills[index].weight = parseFloat(weight) || 0;
            renderConfiguredSkills();
        }

        // æ›´æ–°æŠ€èƒ½è§£é”ç­‰çº§
        function updateSkillLevel(index, level) {
            configuredSkills[index].unlockLevel = parseInt(level) || 1;
        }

        // ç§»é™¤æŠ€èƒ½
        function removeSkill(index) {
            configuredSkills.splice(index, 1);
            renderConfiguredSkills();
        }

        // è·å–ç±»åˆ«åç§°
        function getCategoryName(category) {
            const names = {
                'element-water': 'æ°´ç³»',
                'element-fire': 'ç«ç³»',
                'element-grass': 'è‰ç³»',
                'element-wind': 'é£ç³»',
                'element-electric': 'ç”µç³»',
                'element-earth': 'åœŸç³»',
                'mutation-dark': 'é»‘åŒ–',
                'mutation-light': 'ç™½åŒ–',
                'mutation-crystal': 'æ™¶åŒ–',
                'mutation-shadow': 'å½±åŒ–',
                'mutation-thunder': 'æç”µ',
                'mutation-holy': 'åœ£è¾‰',
                'mutation-psychic': 'å¼‚èƒ½',
                'mutation-void': 'è™šæ— ',
                'mutation-annihilate': 'æ¹®ç­',
                'mutation-chaos': 'æš—èš€',
                'mutation-rebirth': 'è½®å›',
                'rarity-shiny': 'é—ªå…‰',
                'rarity-prismatic': 'å¹»å½©',
                'rarity-stellar': 'æ˜ŸèŠ’'
            };
            return names[category] || 'æœªçŸ¥';
        }

        // åŒæ­¥é¢œè‰²è¾“å…¥
        function syncColorInputs() {
            colorInput.addEventListener('input', (e) => {
                colorHexInput.value = e.target.value.toUpperCase();
                update3DModelColor(e.target.value);
                updatePreview();
            });

            colorHexInput.addEventListener('input', (e) => {
                const hex = e.target.value;
                if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                    colorInput.value = hex;
                    update3DModelColor(hex);
                    updatePreview();
                }
            });
        }

        // æ›´æ–°åŠ¨ç‰©æ•°é‡æ˜¾ç¤º
        function updateAnimalCount() {
            document.getElementById('animal-count').textContent = animals.length;
        }

        // è®¾ç½®è¡¨å•ç›‘å¬å™¨
        function setupFormListeners() {
            // å®æ—¶é¢„è§ˆ
            form.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            // æäº¤è¡¨å•
            form.onsubmit = (e) => {
                e.preventDefault();
                if (editingIndex >= 0) {
                    updateAnimal();
                } else {
                    createAnimal();
                }
            };

            // æ¸…ç©ºæŒ‰é’®
            clearBtn.onclick = () => {
                form.reset();
                currentAvatarData = null;
                avatarModified = false;
                document.getElementById('animal-avatar-input').value = '';
                document.getElementById('avatar-preview').classList.add('hidden');
                document.getElementById('avatar-filename').textContent = 'ç‚¹å‡»é€‰æ‹©å›¾ç‰‡';
                document.getElementById('clear-avatar-btn').classList.add('hidden');
                loadSkillPoolOptions(''); // é‡æ–°åŠ è½½æŠ€èƒ½æ± é€‰é¡¹å¹¶æ¸…ç©ºé€‰æ‹©
                cancelEdit();
                updatePreview();
            };

            // å–æ¶ˆç¼–è¾‘æŒ‰é’®
            cancelEditBtn.onclick = () => {
                form.reset();
                currentAvatarData = null;
                avatarModified = false;
                document.getElementById('animal-avatar-input').value = '';
                document.getElementById('avatar-preview').classList.add('hidden');
                document.getElementById('avatar-filename').textContent = 'ç‚¹å‡»é€‰æ‹©å›¾ç‰‡';
                document.getElementById('clear-avatar-btn').classList.add('hidden');
                loadSkillPoolOptions(''); // é‡æ–°åŠ è½½æŠ€èƒ½æ± é€‰é¡¹å¹¶æ¸…ç©ºé€‰æ‹©
                cancelEdit();
                updatePreview();
            };

            // å¯¼å‡ºæŒ‰é’®
            exportBtn.onclick = exportAnimals;
            document.getElementById('export-csv-btn').onclick = exportAnimalsToCSV;

            // å¯¼å…¥æŒ‰é’®
            document.getElementById('import-file').onchange = importAnimals;

            // åº”ç”¨åˆ°æ¸¸æˆæŒ‰é’®
            document.getElementById('apply-to-game-btn').onclick = applyToGame;
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const data = getFormData();
            if (!data.name) {
                preview.innerHTML = `
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-2">â“</div>
                        <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                    </div>
                `;
                return;
            }

            const elementClass = data.element ? `element-${data.element}` : 'bg-gray-700';
            const rarityClass = data.rarity ? `rarity-${data.rarity}` : 'bg-gray-700';
            
            // å¤´åƒæˆ–é¢œè‰²é¢„è§ˆ
            let avatarHtml;
            if (currentAvatarData) {
                avatarHtml = `<img src="${currentAvatarData}" class="color-preview object-cover" alt="å¤´åƒé¢„è§ˆ">`;
            } else {
                avatarHtml = `<div class="color-preview" style="background-color: ${data.color}"></div>`;
            }

            preview.innerHTML = `
                <div class="flex items-start gap-3">
                    ${avatarHtml}
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="text-lg font-bold text-white">${data.name}</h4>
                            <span class="badge ${elementClass}">${getElementName(data.element)}</span>
                            <span class="badge ${rarityClass}">${getRarityName(data.rarity)}</span>
                        </div>
                        <p class="text-xs text-gray-300 mb-2">${data.desc || 'æš‚æ— æè¿°'}</p>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="bg-orange-600/20 text-orange-300 px-2 py-1 rounded">ğŸ“Š Lv.${data.level}</div>
                            <div class="bg-cyan-600/20 text-cyan-300 px-2 py-1 rounded">ğŸ“ˆ ${data.baseExp}Ã—${data.expGrowth}</div>
                            <div class="bg-pink-600/20 text-pink-300 px-2 py-1 rounded">ğŸ’— ${data.health}</div>
                            <div class="bg-green-600/20 text-green-300 px-2 py-1 rounded">ğŸ’ª ${data.stamina}</div>
                            <div class="bg-red-600/20 text-red-300 px-2 py-1 rounded">âš”ï¸ ${data.attack}</div>
                            <div class="bg-blue-600/20 text-blue-300 px-2 py-1 rounded">ğŸ›¡ï¸ ${data.defense}</div>
                            <div class="bg-yellow-600/20 text-yellow-300 px-2 py-1 rounded">âš¡ ${data.agility}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            return {
                animalId: document.getElementById('animal-id').value.toUpperCase(),
                name: document.getElementById('animal-name').value,
                color: document.getElementById('animal-color-hex').value,
                element: document.getElementById('animal-element').value,
                rarity: document.getElementById('animal-rarity').value,
                level: parseInt(document.getElementById('animal-level').value) || 1,
                baseExp: parseInt(document.getElementById('animal-base-exp').value) || 100,
                expGrowth: parseFloat(document.getElementById('animal-exp-growth').value) || 1.2,
                health: parseInt(document.getElementById('animal-health').value) || 100,
                stamina: parseInt(document.getElementById('animal-stamina').value) || 100,
                attack: parseInt(document.getElementById('animal-attack').value) || 10,
                defense: parseInt(document.getElementById('animal-defense').value) || 5,
                agility: parseInt(document.getElementById('animal-agility').value) || 8,
                favorability: parseInt(document.getElementById('animal-favorability').value) || 50,
                growthTypes: {
                    mediocre: {
                        health: parseInt(document.getElementById('growth-mediocre-health').value) || 10,
                        stamina: parseInt(document.getElementById('growth-mediocre-stamina').value) || 8,
                        attack: parseInt(document.getElementById('growth-mediocre-attack').value) || 2,
                        defense: parseInt(document.getElementById('growth-mediocre-defense').value) || 1,
                        agility: parseInt(document.getElementById('growth-mediocre-agility').value) || 1,
                        favorability: parseInt(document.getElementById('growth-mediocre-favorability').value) || 3
                    },
                    extraordinary: {
                        health: parseInt(document.getElementById('growth-extraordinary-health').value) || 15,
                        stamina: parseInt(document.getElementById('growth-extraordinary-stamina').value) || 12,
                        attack: parseInt(document.getElementById('growth-extraordinary-attack').value) || 3,
                        defense: parseInt(document.getElementById('growth-extraordinary-defense').value) || 2,
                        agility: parseInt(document.getElementById('growth-extraordinary-agility').value) || 2,
                        favorability: parseInt(document.getElementById('growth-extraordinary-favorability').value) || 5
                    },
                    brilliant: {
                        health: parseInt(document.getElementById('growth-brilliant-health').value) || 20,
                        stamina: parseInt(document.getElementById('growth-brilliant-stamina').value) || 16,
                        attack: parseInt(document.getElementById('growth-brilliant-attack').value) || 4,
                        defense: parseInt(document.getElementById('growth-brilliant-defense').value) || 3,
                        agility: parseInt(document.getElementById('growth-brilliant-agility').value) || 3,
                        favorability: parseInt(document.getElementById('growth-brilliant-favorability').value) || 7
                    }
                },
                skillPoolKey: document.getElementById('skillpool-select').value || null,
                desc: document.getElementById('animal-desc').value
            };
        }

        // åˆ›å»ºåŠ¨ç‰©æ¨¡æ¿
        function createAnimal() {
            const data = getFormData();
            const animalKey = `ANIMAL_${Date.now()}`;
            
            // æ£€æŸ¥æ¨¡å‹æ•°æ®å¤§å°
            let modelData = null;
            if (currentShape === 'custom' && customModelData) {
                const sizeInMB = (customModelData.length * 0.75) / (1024 * 1024); // Base64å¤§çº¦æ˜¯åŸå§‹å¤§å°çš„1.33å€
                if (sizeInMB > 2) {
                    if (!confirm(`âš ï¸ è­¦å‘Šï¼šè‡ªå®šä¹‰æ¨¡å‹è¾ƒå¤§ï¼ˆçº¦${sizeInMB.toFixed(2)}MBï¼‰\n\nä¿å­˜å¤§æ¨¡å‹å¯èƒ½å¯¼è‡´localStorageé…é¢è¶…é™ã€‚\nå»ºè®®ä½¿ç”¨è¾ƒå°çš„æ¨¡å‹æ–‡ä»¶ï¼ˆ<2MBï¼‰ã€‚\n\næ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿï¼ˆä¸ä¿å­˜æ¨¡å‹æ•°æ®ï¼‰`)) {
                        // ç”¨æˆ·é€‰æ‹©ä¸ä¿å­˜æ¨¡å‹æ•°æ®
                        console.log('âš ï¸ ç”¨æˆ·å–æ¶ˆä¿å­˜å¤§æ¨¡å‹æ•°æ®');
                    } else {
                        modelData = customModelData;
                    }
                } else {
                    modelData = customModelData;
                }
            }
            
            const animal = {
                key: animalKey,
                ...data,
                modelData: modelData,
                modelShape: currentShape,
                avatarData: currentAvatarData,
                createdAt: new Date().toISOString()
            };

            try {
                animals.push(animal);
                saveAnimalPool();
                
                renderAnimalsList();
                updateAnimalCount();
                form.reset();
                loadSkillPoolOptions(''); // é‡æ–°åŠ è½½å¹¶æ¸…ç©ºæŠ€èƒ½æ± é€‰æ‹©
                updatePreview();
                
                const skillPoolMsg = animal.skillPoolKey ? '\nâœ… å·²å…³è”æŠ€èƒ½æ± ' : '\nâš ï¸ æœªé€‰æ‹©æŠ€èƒ½æ± ';
                const modelMsg = animal.modelData ? '\nâœ… åŒ…å«è‡ªå®šä¹‰3Dæ¨¡å‹' : (currentShape === 'custom' ? '\nâš ï¸ æ¨¡å‹æœªä¿å­˜ï¼ˆè¿‡å¤§ï¼‰' : '');
                alert(`âœ… åŠ¨ç‰©æ¨¡æ¿ "${data.name}" å·²æ·»åŠ åˆ°æ¨¡æ¿æ± ï¼${skillPoolMsg}${modelMsg}`);
            } catch (error) {
                // å›æ»š
                animals.pop();
                if (error.name === 'QuotaExceededError') {
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³ï¼\n\nå»ºè®®ï¼š\n1. ä½¿ç”¨æ›´å°çš„GLBæ¨¡å‹æ–‡ä»¶ï¼ˆ<2MBï¼‰\n2. åˆ é™¤ä¸€äº›æ—§çš„åŠ¨ç‰©æ¨¡æ¿\n3. å¯¼å‡ºå¹¶æ¸…ç©ºå½“å‰æ¨¡æ¿æ± ');
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
                }
                console.error('ä¿å­˜å¤±è´¥:', error);
            }
        }

        // æ›´æ–°åŠ¨ç‰©æ¨¡æ¿
        function updateAnimal() {
            const data = getFormData();
            
            // æ£€æŸ¥æ¨¡å‹æ•°æ®å¤§å°
            let modelData = null;
            if (currentShape === 'custom' && customModelData) {
                const sizeInMB = (customModelData.length * 0.75) / (1024 * 1024);
                if (sizeInMB > 2) {
                    if (!confirm(`âš ï¸ è­¦å‘Šï¼šè‡ªå®šä¹‰æ¨¡å‹è¾ƒå¤§ï¼ˆçº¦${sizeInMB.toFixed(2)}MBï¼‰\n\nä¿å­˜å¤§æ¨¡å‹å¯èƒ½å¯¼è‡´localStorageé…é¢è¶…é™ã€‚\nå»ºè®®ä½¿ç”¨è¾ƒå°çš„æ¨¡å‹æ–‡ä»¶ï¼ˆ<2MBï¼‰ã€‚\n\næ˜¯å¦ç»§ç»­ä¿å­˜ï¼Ÿï¼ˆä¸ä¿å­˜æ¨¡å‹æ•°æ®ï¼‰`)) {
                        console.log('âš ï¸ ç”¨æˆ·å–æ¶ˆä¿å­˜å¤§æ¨¡å‹æ•°æ®');
                    } else {
                        modelData = customModelData;
                    }
                } else {
                    modelData = customModelData;
                }
            }
            
            // ä¿å­˜åŸå§‹æ•°æ®ä»¥ä¾¿å›æ»š
            const originalAnimal = {...animals[editingIndex]};
            
            // ä¿ç•™åŸæœ‰çš„keyå’Œåˆ›å»ºæ—¶é—´
            const animal = {
                key: animals[editingIndex].key,
                ...data,
                modelData: modelData,
                modelShape: currentShape,
                avatarData: avatarModified ? currentAvatarData : animals[editingIndex].avatarData,
                createdAt: animals[editingIndex].createdAt,
                updatedAt: new Date().toISOString()
            };

            try {
                animals[editingIndex] = animal;
                saveAnimalPool();
                
                renderAnimalsList();
                updateAnimalCount();
                form.reset();
                loadSkillPoolOptions(''); // é‡æ–°åŠ è½½å¹¶æ¸…ç©ºæŠ€èƒ½æ± é€‰æ‹©
                cancelEdit();
                updatePreview();
                
                const modelMsg = animal.modelData ? '\nâœ… åŒ…å«è‡ªå®šä¹‰3Dæ¨¡å‹' : (currentShape === 'custom' ? '\nâš ï¸ æ¨¡å‹æœªä¿å­˜ï¼ˆè¿‡å¤§ï¼‰' : '');
                alert(`âœ… åŠ¨ç‰©æ¨¡æ¿ "${data.name}" å·²æ›´æ–°ï¼${modelMsg}`);
            } catch (error) {
                // å›æ»š
                animals[editingIndex] = originalAnimal;
                if (error.name === 'QuotaExceededError') {
                    alert('âŒ æ›´æ–°å¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³ï¼\n\nå»ºè®®ï¼š\n1. ä½¿ç”¨æ›´å°çš„GLBæ¨¡å‹æ–‡ä»¶ï¼ˆ<2MBï¼‰\n2. åˆ é™¤ä¸€äº›æ—§çš„åŠ¨ç‰©æ¨¡æ¿\n3. å¯¼å‡ºå¹¶æ¸…ç©ºå½“å‰æ¨¡æ¿æ± ');
                } else {
                    alert('âŒ æ›´æ–°å¤±è´¥ï¼š' + error.message);
                }
                console.error('æ›´æ–°å¤±è´¥:', error);
            }
        }

        // ç¼–è¾‘åŠ¨ç‰©æ¨¡æ¿
        function editAnimal(index) {
            editingIndex = index;
            avatarModified = false;  // é‡ç½®å¤´åƒä¿®æ”¹æ ‡å¿—
            const animal = animals[index];
            
            // å¡«å……è¡¨å•
            document.getElementById('animal-id').value = animal.animalId || '';
            document.getElementById('animal-name').value = animal.name;
            document.getElementById('animal-color').value = animal.color;
            document.getElementById('animal-color-hex').value = animal.color;
            document.getElementById('animal-element').value = animal.element;
            document.getElementById('animal-rarity').value = animal.rarity;
            document.getElementById('animal-level').value = animal.level;
            document.getElementById('animal-base-exp').value = animal.baseExp;
            document.getElementById('animal-exp-growth').value = animal.expGrowth;
            document.getElementById('animal-health').value = animal.health;
            document.getElementById('animal-stamina').value = animal.stamina;
            document.getElementById('animal-attack').value = animal.attack;
            document.getElementById('animal-defense').value = animal.defense;
            document.getElementById('animal-agility').value = animal.agility;
            document.getElementById('animal-favorability').value = animal.favorability;
            
            // å¡«å……ä¸‰ç§æˆé•¿é…ç½®ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰
            if (animal.growthTypes) {
                // æ–°æ ¼å¼ï¼šä¸‰ç§æˆé•¿
                document.getElementById('growth-mediocre-health').value = animal.growthTypes.mediocre.health;
                document.getElementById('growth-mediocre-stamina').value = animal.growthTypes.mediocre.stamina;
                document.getElementById('growth-mediocre-attack').value = animal.growthTypes.mediocre.attack;
                document.getElementById('growth-mediocre-defense').value = animal.growthTypes.mediocre.defense;
                document.getElementById('growth-mediocre-agility').value = animal.growthTypes.mediocre.agility;
                document.getElementById('growth-mediocre-favorability').value = animal.growthTypes.mediocre.favorability;
                
                document.getElementById('growth-extraordinary-health').value = animal.growthTypes.extraordinary.health;
                document.getElementById('growth-extraordinary-stamina').value = animal.growthTypes.extraordinary.stamina;
                document.getElementById('growth-extraordinary-attack').value = animal.growthTypes.extraordinary.attack;
                document.getElementById('growth-extraordinary-defense').value = animal.growthTypes.extraordinary.defense;
                document.getElementById('growth-extraordinary-agility').value = animal.growthTypes.extraordinary.agility;
                document.getElementById('growth-extraordinary-favorability').value = animal.growthTypes.extraordinary.favorability;
                
                document.getElementById('growth-brilliant-health').value = animal.growthTypes.brilliant.health;
                document.getElementById('growth-brilliant-stamina').value = animal.growthTypes.brilliant.stamina;
                document.getElementById('growth-brilliant-attack').value = animal.growthTypes.brilliant.attack;
                document.getElementById('growth-brilliant-defense').value = animal.growthTypes.brilliant.defense;
                document.getElementById('growth-brilliant-agility').value = animal.growthTypes.brilliant.agility;
                document.getElementById('growth-brilliant-favorability').value = animal.growthTypes.brilliant.favorability;
            } else if (animal.growth) {
                // æ—§æ ¼å¼ï¼šå•ä¸€æˆé•¿ï¼Œè½¬æ¢ä¸ºä¸‰ç§æˆé•¿
                const baseGrowth = animal.growth;
                const potential = animal.potential || 'è¶…å¸¸';
                const multipliers = { 'å¹³åº¸': 1.0, 'è¶…å¸¸': 1.5, 'ç’€ç’¨': 2.0 };
                const mult = multipliers[potential] || 1.5;
                
                // å¹³åº¸ = åŸºç¡€æˆé•¿ / å€ç‡
                document.getElementById('growth-mediocre-health').value = Math.round(baseGrowth.health / mult);
                document.getElementById('growth-mediocre-stamina').value = Math.round(baseGrowth.stamina / mult);
                document.getElementById('growth-mediocre-attack').value = Math.round(baseGrowth.attack / mult);
                document.getElementById('growth-mediocre-defense').value = Math.round(baseGrowth.defense / mult);
                document.getElementById('growth-mediocre-agility').value = Math.round(baseGrowth.agility / mult);
                document.getElementById('growth-mediocre-favorability').value = Math.round(baseGrowth.favorability / mult);
                
                // è¶…å¸¸ = åŸºç¡€æˆé•¿ / å€ç‡ * 1.5
                document.getElementById('growth-extraordinary-health').value = Math.round(baseGrowth.health / mult * 1.5);
                document.getElementById('growth-extraordinary-stamina').value = Math.round(baseGrowth.stamina / mult * 1.5);
                document.getElementById('growth-extraordinary-attack').value = Math.round(baseGrowth.attack / mult * 1.5);
                document.getElementById('growth-extraordinary-defense').value = Math.round(baseGrowth.defense / mult * 1.5);
                document.getElementById('growth-extraordinary-agility').value = Math.round(baseGrowth.agility / mult * 1.5);
                document.getElementById('growth-extraordinary-favorability').value = Math.round(baseGrowth.favorability / mult * 1.5);
                
                // ç’€ç’¨ = åŸºç¡€æˆé•¿ / å€ç‡ * 2.0
                document.getElementById('growth-brilliant-health').value = Math.round(baseGrowth.health / mult * 2.0);
                document.getElementById('growth-brilliant-stamina').value = Math.round(baseGrowth.stamina / mult * 2.0);
                document.getElementById('growth-brilliant-attack').value = Math.round(baseGrowth.attack / mult * 2.0);
                document.getElementById('growth-brilliant-defense').value = Math.round(baseGrowth.defense / mult * 2.0);
                document.getElementById('growth-brilliant-agility').value = Math.round(baseGrowth.agility / mult * 2.0);
                document.getElementById('growth-brilliant-favorability').value = Math.round(baseGrowth.favorability / mult * 2.0);
            }
            
            document.getElementById('animal-desc').value = animal.desc || '';
            
            // é‡æ–°åŠ è½½æŠ€èƒ½æ± é€‰é¡¹å¹¶æ¢å¤æŠ€èƒ½æ± é€‰æ‹©
            loadSkillPoolOptions(animal.skillPoolKey || '');
            
            // æ¢å¤å¤´åƒ
            if (animal.avatarData) {
                currentAvatarData = animal.avatarData;
                document.getElementById('avatar-preview-img').src = animal.avatarData;
                document.getElementById('avatar-preview').classList.remove('hidden');
                document.getElementById('avatar-filename').textContent = 'å·²åŠ è½½ä¿å­˜çš„å¤´åƒ';
                document.getElementById('clear-avatar-btn').classList.remove('hidden');
            } else {
                currentAvatarData = null;
                document.getElementById('avatar-preview').classList.add('hidden');
                document.getElementById('avatar-filename').textContent = 'ç‚¹å‡»é€‰æ‹©å›¾ç‰‡';
                document.getElementById('clear-avatar-btn').classList.add('hidden');
            }
            
            // æ¢å¤3Dæ¨¡å‹
            if (animal.modelData) {
                customModelData = animal.modelData;
                currentShape = animal.modelShape || 'custom';
                
                // ç­‰å¾…GLTFLoaderåˆå§‹åŒ–åå†åŠ è½½
                const tryLoad = () => {
                    if (gltfLoader) {
                        loadCustomModel(customModelData);
                        
                        // æ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹æŒ‰é’®
                        const customBtn = document.getElementById('custom-model-btn');
                        customBtn.style.display = 'inline-block';
                        
                        // æ¿€æ´»å¯¹åº”æŒ‰é’®
                        document.querySelectorAll('.model-control-btn').forEach(b => b.classList.remove('active'));
                        const activeBtn = document.querySelector(`[data-shape="${currentShape}"]`);
                        if (activeBtn) activeBtn.classList.add('active');
                        
                        document.getElementById('model-info').textContent = 'âœ… å·²åŠ è½½ä¿å­˜çš„è‡ªå®šä¹‰æ¨¡å‹';
                        document.getElementById('model-info').style.display = 'block';
                    } else {
                        setTimeout(tryLoad, 100);
                    }
                };
                tryLoad();
            } else {
                currentShape = animal.modelShape || 'sphere';
                createAnimalModel(animal.color, currentShape);
                document.querySelectorAll('.model-control-btn').forEach(b => b.classList.remove('active'));
                const activeBtn = document.querySelector(`[data-shape="${currentShape}"]`);
                if (activeBtn) activeBtn.classList.add('active');
            }
            
            // æ›´æ–°UI
            submitText.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            cancelEditBtn.classList.remove('hidden');
            
            updatePreview();
            
            // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingIndex = -1;
            submitText.textContent = 'âœ¨ åˆ›å»ºåŠ¨ç‰©æ¨¡æ¿';
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            cancelEditBtn.classList.add('hidden');
        }

        // ä¿å­˜åŠ¨ç‰©æ¨¡æ¿æ± 
        function saveAnimalPool() {
            try {
                const jsonStr = JSON.stringify(animals);
                const sizeInMB = (jsonStr.length / (1024 * 1024)).toFixed(2);
                console.log(`ğŸ’¾ ä¿å­˜åŠ¨ç‰©æ¨¡æ¿æ± ï¼Œå¤§å°: ${sizeInMB}MB`);
                
                localStorage.setItem('ANIMAL_POOL', jsonStr);
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    console.error('âŒ localStorageé…é¢è¶…é™');
                    throw error; // é‡æ–°æŠ›å‡ºä»¥ä¾¿ä¸Šå±‚å¤„ç†
                } else {
                    console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                    throw error;
                }
            }
        }

        // æ¸²æŸ“åŠ¨ç‰©åˆ—è¡¨
        function renderAnimalsList() {
            if (animals.length === 0) {
                animalsList.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-8">
                        æš‚æ— åŠ¨ç‰©æ¨¡æ¿
                    </div>
                `;
                return;
            }

            animalsList.innerHTML = animals.map((animal, index) => {
                const elementClass = `element-${animal.element}`;
                const rarityClass = `rarity-${animal.rarity}`;
                
                // å¤´åƒæˆ–é¢œè‰²çƒ
                let avatarHtml;
                if (animal.avatarData) {
                    avatarHtml = `<img src="${animal.avatarData}" class="w-12 h-12 rounded-full border-2 border-white object-cover" alt="${animal.name}">`;
                } else {
                    avatarHtml = `<div class="w-12 h-12 rounded-full border-2 border-white" style="background-color: ${animal.color}"></div>`;
                }
                
                return `
                    <div class="animal-card bg-gray-800 rounded-lg p-3 border border-gray-600">
                        <div class="flex items-start gap-2">
                            ${avatarHtml}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <h5 class="text-sm font-bold text-white">${animal.name}</h5>
                                    <span class="badge ${elementClass} text-xs">${getElementName(animal.element)}</span>
                                    <span class="badge ${rarityClass} text-xs">${getRarityName(animal.rarity)}</span>
                                </div>
                                <div class="flex gap-2 text-xs flex-wrap">
                                    <span class="text-orange-400">ğŸ“ŠLv.${animal.level}</span>
                                    <span class="text-pink-400">ğŸ’—${animal.health}</span>
                                    <span class="text-red-400">âš”ï¸${animal.attack}</span>
                                    <span class="text-blue-400">ğŸ›¡ï¸${animal.defense}</span>
                                    <span class="text-yellow-400">âš¡${animal.agility}</span>
                                </div>
                            </div>
                            <div class="flex gap-1 flex-shrink-0">
                                <button onclick="editAnimal(${index})"
                                    class="text-blue-400 hover:text-blue-300 text-lg px-2"
                                    title="ç¼–è¾‘">
                                    âœï¸
                                </button>
                                <button onclick="deleteAnimal(${index})"
                                    class="text-red-400 hover:text-red-300 text-xl"
                                    title="åˆ é™¤">
                                    Ã—
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤åŠ¨ç‰©æ¨¡æ¿
        function deleteAnimal(index) {
            if (confirm('ç¡®å®šè¦ä»æ¨¡æ¿æ± ä¸­åˆ é™¤è¿™ä¸ªåŠ¨ç‰©å—ï¼Ÿ')) {
                animals.splice(index, 1);
                saveAnimalPool();
                renderAnimalsList();
                updateAnimalCount();
            }
        }

        // å¯¼å‡ºåŠ¨ç‰©æ¨¡æ¿æ± ï¼ˆJSONæ ¼å¼ï¼‰
        function exportAnimals() {
            if (animals.length === 0) {
                alert('æ¨¡æ¿æ± ä¸ºç©ºï¼');
                return;
            }

            const dataStr = JSON.stringify(animals, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `animal_pool_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å‡ºåŠ¨ç‰©æ¨¡æ¿æ± ï¼ˆCSVæ ¼å¼ - ç­–åˆ’å‹å¥½ç‰ˆï¼‰
        function exportAnimalsToCSV() {
            if (animals.length === 0) {
                alert('æ¨¡æ¿æ± ä¸ºç©ºï¼');
                return;
            }

            // è½¬ä¹‰CSVå­—æ®µ
            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            // åŸºç¡€è¡¨å¤´
            const baseHeaders = [
                'åŠ¨ç‰©ID', 'åŠ¨ç‰©åç§°', 'æè¿°', 'é¢œè‰²', 'ç³»åˆ«', 'ç¨€æœ‰åº¦',
                'åˆå§‹ç­‰çº§', 'åŸºç¡€ç»éªŒå€¼', 'ç»éªŒå¢é•¿ç³»æ•°',
                'ç”Ÿå‘½å€¼', 'ä½“åŠ›', 'æ”»å‡»', 'é˜²å¾¡', 'æ•æ·', 'å¥½æ„Ÿåº¦'
            ];

            // æˆé•¿é…ç½®è¡¨å¤´
            const growthHeaders = [
                'å¹³åº¸_ç”Ÿå‘½', 'å¹³åº¸_ä½“åŠ›', 'å¹³åº¸_æ”»å‡»', 'å¹³åº¸_é˜²å¾¡', 'å¹³åº¸_æ•æ·', 'å¹³åº¸_å¥½æ„Ÿ',
                'è¶…å¸¸_ç”Ÿå‘½', 'è¶…å¸¸_ä½“åŠ›', 'è¶…å¸¸_æ”»å‡»', 'è¶…å¸¸_é˜²å¾¡', 'è¶…å¸¸_æ•æ·', 'è¶…å¸¸_å¥½æ„Ÿ',
                'ç’€ç’¨_ç”Ÿå‘½', 'ç’€ç’¨_ä½“åŠ›', 'ç’€ç’¨_æ”»å‡»', 'ç’€ç’¨_é˜²å¾¡', 'ç’€ç’¨_æ•æ·', 'ç’€ç’¨_å¥½æ„Ÿ'
            ];

            // æŠ€èƒ½æ± è¡¨å¤´ï¼ˆæ”¹ä¸ºå•åˆ—ï¼‰
            const skillHeaders = ['å…³è”æŠ€èƒ½æ± '];

            const headers = [...baseHeaders, ...growthHeaders, ...skillHeaders,
                'æ˜¯å¦æœ‰3Dæ¨¡å‹', 'æ˜¯å¦æœ‰å¤´åƒ', 'åˆ›å»ºæ—¶é—´', 'æ›´æ–°æ—¶é—´', 'å¤‡æ³¨'];

            // æ„å»ºCSVå†…å®¹
            let csvContent = headers.join(',') + '\n';

            animals.forEach(animal => {
                // åŸºç¡€ä¿¡æ¯
                const baseRow = [
                    escapeCSV(animal.animalId || ''),
                    escapeCSV(animal.name),
                    escapeCSV(animal.desc || ''),
                    escapeCSV(animal.color),
                    escapeCSV(getElementName(animal.element)),
                    escapeCSV(getRarityName(animal.rarity)),
                    escapeCSV(animal.level),
                    escapeCSV(animal.baseExp),
                    escapeCSV(animal.expGrowth),
                    escapeCSV(animal.health),
                    escapeCSV(animal.stamina),
                    escapeCSV(animal.attack),
                    escapeCSV(animal.defense),
                    escapeCSV(animal.agility),
                    escapeCSV(animal.favorability)
                ];

                // æˆé•¿é…ç½®
                const growthRow = [];
                if (animal.growthTypes) {
                    // æ–°æ ¼å¼
                    ['mediocre', 'extraordinary', 'brilliant'].forEach(type => {
                        const growth = animal.growthTypes[type] || {};
                        growthRow.push(
                            escapeCSV(growth.health || 0),
                            escapeCSV(growth.stamina || 0),
                            escapeCSV(growth.attack || 0),
                            escapeCSV(growth.defense || 0),
                            escapeCSV(growth.agility || 0),
                            escapeCSV(growth.favorability || 0)
                        );
                    });
                } else if (animal.growth) {
                    // æ—§æ ¼å¼å…¼å®¹
                    const baseGrowth = animal.growth;
                    const mult = { 'å¹³åº¸': 1.0, 'è¶…å¸¸': 1.5, 'ç’€ç’¨': 2.0 }[animal.potential || 'è¶…å¸¸'] || 1.5;
                    
                    [1.0, 1.5, 2.0].forEach(factor => {
                        const actualFactor = factor / mult;
                        growthRow.push(
                            escapeCSV(Math.round(baseGrowth.health * actualFactor)),
                            escapeCSV(Math.round(baseGrowth.stamina * actualFactor)),
                            escapeCSV(Math.round(baseGrowth.attack * actualFactor)),
                            escapeCSV(Math.round(baseGrowth.defense * actualFactor)),
                            escapeCSV(Math.round(baseGrowth.agility * actualFactor)),
                            escapeCSV(Math.round(baseGrowth.favorability * actualFactor))
                        );
                    });
                } else {
                    // æ— æˆé•¿æ•°æ®
                    for (let i = 0; i < 18; i++) growthRow.push('');
                }

                // æŠ€èƒ½æ± ä¿¡æ¯ï¼ˆæ”¹ä¸ºæ˜¾ç¤ºæŠ€èƒ½æ± åç§°ï¼‰
                const skillPoolKey = animal.skillPoolKey;
                let skillPoolName = '';
                if (skillPoolKey) {
                    const skillPools = JSON.parse(localStorage.getItem('SKILL_POOLS') || '[]');
                    const pool = skillPools.find(p => p.key === skillPoolKey);
                    skillPoolName = pool ? pool.name : skillPoolKey;
                }

                const row = [...baseRow, ...growthRow, escapeCSV(skillPoolName),
                    escapeCSV(animal.modelData ? 'æ˜¯' : 'å¦'),
                    escapeCSV(animal.avatarData ? 'æ˜¯' : 'å¦'),
                    escapeCSV(animal.createdAt ? new Date(animal.createdAt).toLocaleString('zh-CN') : ''),
                    escapeCSV(animal.updatedAt ? new Date(animal.updatedAt).toLocaleString('zh-CN') : ''),
                    ''
                ];

                csvContent += row.join(',') + '\n';
            });

            // æ·»åŠ BOM
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åŠ¨ç‰©é…ç½®è¡¨_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`âœ… å·²å¯¼å‡º ${animals.length} ä¸ªåŠ¨ç‰©æ¨¡æ¿åˆ°ç­–åˆ’é…ç½®è¡¨ï¼ˆCSVæ ¼å¼ï¼‰ï¼\n\nè¡¨æ ¼ç‰¹ç‚¹ï¼š\nâ€¢ æ‰å¹³åŒ–ç»“æ„ï¼Œä¾¿äºExcelç¼–è¾‘\nâ€¢ ä¸­æ–‡åˆ—åï¼Œæ˜“äºç†è§£\nâ€¢ åŒ…å«ä¸‰ç§æˆé•¿ç±»å‹é…ç½®\nâ€¢ æœ€å¤šæ”¯æŒ10ä¸ªæŠ€èƒ½é…ç½®`);
        }

        // å¯¼å…¥åŠ¨ç‰©æ¨¡æ¿
        function importAnimals(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedAnimals = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedAnimals)) {
                        alert('âŒ æ— æ•ˆçš„JSONæ ¼å¼ï¼');
                        return;
                    }

                    // åˆå¹¶åŠ¨ç‰©ï¼ˆé¿å…é‡å¤ï¼‰
                    const existingKeys = new Set(animals.map(a => a.key));
                    const newAnimals = importedAnimals.filter(a => !existingKeys.has(a.key));
                    
                    animals = [...animals, ...newAnimals];
                    saveAnimalPool();
                    
                    renderAnimalsList();
                    updateAnimalCount();
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${newAnimals.length} ä¸ªæ–°åŠ¨ç‰©æ¨¡æ¿ï¼`);
                } catch (error) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        }

        // åº”ç”¨åˆ°æ¸¸æˆ
        function applyToGame() {
            if (animals.length === 0) {
                alert('âŒ åŠ¨ç‰©æ¨¡æ¿æ± ä¸ºç©ºï¼');
                return;
            }

            // ç»Ÿè®¡å„ç³»åˆ«å’Œç¨€æœ‰åº¦æ•°é‡
            const stats = {
                elements: {},
                rarities: {}
            };
            
            animals.forEach(animal => {
                stats.elements[animal.element] = (stats.elements[animal.element] || 0) + 1;
                stats.rarities[animal.rarity] = (stats.rarities[animal.rarity] || 0) + 1;
            });
            
            const elementStats = Object.entries(stats.elements)
                .map(([k, v]) => `${getElementName(k)}: ${v}`)
                .join('\nâ€¢ ');
            
            const rarityStats = Object.entries(stats.rarities)
                .map(([k, v]) => `${getRarityName(k)}: ${v}`)
                .join('\nâ€¢ ');
            
            alert(`âœ… åŠ¨ç‰©æ¨¡æ¿æ± å·²å°±ç»ªï¼\n\n` +
                  `ğŸ“Š æ¨¡æ¿æ± ç»Ÿè®¡ï¼š\n` +
                  `æ€»è®¡ï¼š${animals.length} ä¸ªæ¨¡æ¿\n\n` +
                  `ç³»åˆ«åˆ†å¸ƒï¼š\nâ€¢ ${elementStats}\n\n` +
                  `ç¨€æœ‰åº¦åˆ†å¸ƒï¼š\nâ€¢ ${rarityStats}\n\n` +
                  `æ¸¸æˆä¼šæ ¹æ®æƒé‡ä»æ¨¡æ¿æ± ä¸­éšæœºç”Ÿæˆé‡ç”ŸåŠ¨ç‰©ï¼`);
        }

        // è¾…åŠ©å‡½æ•°
        function getElementName(element) {
            const names = {
                'water': 'æ°´ç³»',
                'fire': 'ç«ç³»',
                'grass': 'è‰ç³»',
                'wind': 'é£ç³»',
                'electric': 'ç”µç³»',
                'earth': 'åœŸç³»'
            };
            return names[element] || 'æœªçŸ¥';
        }

        function getRarityName(rarity) {
            const names = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰',
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´',
                // å…¼å®¹æ—§æ•°æ®
                'shiny': 'é—ªå…‰',
                'prismatic': 'å¹»å½©',
                'stellar': 'æ˜ŸèŠ’',
                'uncommon': 'ç½•è§',
                'mythic': 'ç¥è¯'
            };
            return names[rarity] || 'æœªçŸ¥';
        }

        function getPotentialName(potential) {
            const names = {
                'low': 'ä½',
                'medium': 'ä¸­',
                'high': 'é«˜',
                'exceptional': 'å“è¶Š'
            };
            return names[potential] || 'ä¸­';
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>