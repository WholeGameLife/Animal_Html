<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸƒç½—è¥¿å¡å¤§é™†è”èµ›ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 50%, #1e1b4b 100%);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            background: rgba(15, 23, 42, 0.95);
        }

        .header {
            background: linear-gradient(135deg, #7c3aed 0%, #db2777 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            justify-content: center;
            background: rgba(30, 41, 59, 0.8);
            border-bottom: 3px solid #7c3aed;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab {
            padding: 18px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            border: none;
            background: transparent;
            color: #94a3b8;
            min-width: 150px;
        }

        .tab:hover {
            background: rgba(124, 58, 237, 0.2);
            color: #e0e7ff;
        }

        .tab.active {
            background: rgba(124, 58, 237, 0.3);
            color: white;
            border-bottom: 3px solid #fbbf24;
        }

        .content {
            padding: 30px;
            min-height: calc(100vh - 200px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-box {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 2px solid rgba(124, 58, 237, 0.4);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            color: #e0e7ff;
        }

        .info-box h3 {
            color: #a78bfa;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .info-box.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            border-color: rgba(16, 185, 129, 0.6);
        }

        .info-box.success h3 {
            color: #86efac;
        }

        .info-box.warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            border-color: rgba(251, 191, 36, 0.6);
        }

        .info-box.warning h3 {
            color: #fcd34d;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .region-card {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 3px solid rgba(124, 58, 237, 0.3);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s;
        }

        .region-card:hover {
            transform: translateY(-8px);
            border-color: #7c3aed;
            box-shadow: 0 15px 35px rgba(124, 58, 237, 0.5);
        }

        .region-card.selected {
            border-color: #fbbf24;
            box-shadow: 0 15px 35px rgba(251, 191, 36, 0.6);
            transform: translateY(-8px);
        }

        .region-card h3 {
            font-size: 1.5em;
            margin: 10px 0;
            color: #e0e7ff;
        }

        .region-card p {
            color: #cbd5e1;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #e0e7ff;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(30, 41, 59, 0.6);
            color: white;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.4);
        }

        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed 0%, #db2777 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(124, 58, 237, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(124, 58, 237, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .tournament-bracket {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            overflow-x: auto;
            gap: 60px;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid rgba(124, 58, 237, 0.3);
            position: relative;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-width: 180px;
            position: relative;
            min-height: 600px;
        }
        
        /* ä¸ºæ¯ä¸ªè½®æ¬¡è®¾ç½®æ ¼å­é—´è·ï¼Œä½¿åç»­è½®æ¬¡çš„æ ¼å­å¯¹é½åˆ°å‰ä¸€è½®ä¸¤ä¸ªæ ¼å­çš„ä¸­é—´ */
        .bracket-round-r1 .bracket-match {
            margin: 10px 0;
        }
        
        .bracket-round-r1 .bracket-match:first-of-type {
            margin-top: 20px;
        }
        
        .bracket-round-r2 .bracket-match {
            margin: 80px 0;
        }
        
        .bracket-round-r2 .bracket-match:first-of-type {
            margin-top: 110px;
        }
        
        .bracket-round-r3 .bracket-match {
            margin: 240px 0;
        }
        
        .bracket-round-r3 .bracket-match:first-of-type {
            margin-top: 285px;
        }
        
        .bracket-round-r4 .bracket-match {
            margin: 560px 0;
        }
        
        .bracket-round-r4 .bracket-match:first-of-type {
            margin-top: 605px;
        }

        .bracket-round-title {
            text-align: center;
            font-weight: bold;
            color: white;
            margin-bottom: 15px;
            font-size: 0.9em;
            padding: 8px 12px;
            background: linear-gradient(135deg, #7c3aed 0%, #db2777 100%);
            border-radius: 8px;
            box-shadow: 0 3px 12px rgba(124, 58, 237, 0.5);
        }

        .bracket-match {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.7) 0%, rgba(30, 41, 59, 0.9) 100%);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin: 8px 0;
            min-width: 180px;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .bracket-match:hover {
            border-color: #7c3aed;
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.5);
            transform: scale(1.02);
        }

        .bracket-match.player-match {
            border-color: #fbbf24;
            box-shadow: 0 5px 18px rgba(251, 191, 36, 0.5);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.15) 100%);
        }

        .bracket-match.completed {
            border-color: #10b981;
        }
        
        .bracket-match.final {
            min-width: 220px;
            border-width: 3px;
            padding: 14px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
        }
        
        /* æ°´å¹³è¿æ¥çº¿ï¼šä»æ ¼å­å³ä¾§ä¼¸å‡º */
        .bracket-match::after {
            content: '';
            position: absolute;
            right: -30px;
            top: 50%;
            width: 30px;
            height: 2px;
            background: rgba(124, 58, 237, 0.5);
        }
        
        /* å‚ç›´è¿æ¥çº¿ï¼šè¿æ¥ä¸¤ä¸ªç›¸é‚»æ ¼å­ */
        .bracket-match.pair-top::before {
            content: '';
            position: absolute;
            right: -30px;
            top: 50%;
            width: 2px;
            transform-origin: top;
        }
        
        .bracket-match.pair-bottom::before {
            content: '';
            position: absolute;
            right: -30px;
            bottom: 50%;
            width: 2px;
            transform-origin: bottom;
        }
        
        /* è®¡ç®—å‚ç›´çº¿é«˜åº¦ - è¿æ¥åˆ°ä¸‹ä¸€è½®æ ¼å­çš„ä¸­å¿ƒ */
        .bracket-round-r1 .bracket-match.pair-top::before,
        .bracket-round-r1 .bracket-match.pair-bottom::before {
            height: calc(50% + 80px);
            background: rgba(124, 58, 237, 0.5);
        }
        
        .bracket-round-r2 .bracket-match.pair-top::before,
        .bracket-round-r2 .bracket-match.pair-bottom::before {
            height: calc(50% + 160px);
            background: rgba(124, 58, 237, 0.5);
        }
        
        .bracket-round-r3 .bracket-match.pair-top::before,
        .bracket-round-r3 .bracket-match.pair-bottom::before {
            height: calc(50% + 320px);
            background: rgba(124, 58, 237, 0.5);
        }
        
        /* åŠå†³èµ›ç‰¹æ®Šè¿æ¥ï¼šè¿æ¥åˆ°å†³èµ› */
        .bracket-round-r4 .bracket-match.pair-top::before {
            height: calc(50% + 280px);
            background: rgba(251, 191, 36, 0.6);
        }
        
        .bracket-round-r4 .bracket-match.pair-bottom::before {
            height: calc(50% + 280px);
            background: rgba(251, 191, 36, 0.6);
        }
        
        /* ä¸æ˜¾ç¤ºè¿æ¥çº¿çš„æƒ…å†µ */
        .bracket-match.no-line::after,
        .bracket-match.no-line::before {
            display: none;
        }
        
        /* å³åŠåŒºçš„è¿æ¥çº¿é•œåƒ */
        .bracket-round.right-bracket .bracket-match::after {
            right: auto;
            left: -30px;
        }
        
        .bracket-round.right-bracket .bracket-match::before {
            right: auto;
            left: -30px;
        }

        .bracket-team {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            margin: 4px 0;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 6px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .bracket-team.winner {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%);
            border: 1px solid #10b981;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }

        .bracket-team.loser {
            opacity: 0.4;
        }

        .bracket-team-name {
            color: #e0e7ff;
            font-weight: 600;
            font-size: 0.85em;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bracket-team-name.player {
            color: #fbbf24;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        .bracket-team-score {
            color: #a78bfa;
            font-weight: bold;
            font-size: 1.2em;
            min-width: 25px;
            text-align: center;
        }

        .bracket-stage-info {
            text-align: center;
            font-size: 0.7em;
            color: #94a3b8;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
        }

        .standings-table th,
        .standings-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .standings-table th {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.8) 0%, rgba(71, 85, 105, 0.9) 100%);
            color: #e0e7ff;
            font-weight: bold;
            font-size: 1.1em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .standings-table tr {
            background: rgba(51, 65, 85, 0.6);
            color: #e0e7ff;
            transition: all 0.3s;
        }

        .standings-table tr:hover {
            background: rgba(124, 58, 237, 0.2);
        }

        .standings-table .player-team {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%);
            font-weight: bold;
        }

        .standings-table .promotion {
            border-left: 5px solid #10b981;
        }

        .standings-table .playoff {
            border-left: 5px solid #f59e0b;
        }

        .standings-table .relegation {
            border-left: 5px solid #ef4444;
        }

        .fixture-card {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .fixture-card:hover {
            border-color: #7c3aed;
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }

        .fixture-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .team-box {
            flex: 1;
            text-align: center;
            padding: 20px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            color: #e0e7ff;
            font-size: 1.2em;
            font-weight: bold;
        }

        .team-box.player-team {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%);
            border: 2px solid #fbbf24;
        }

        .match-vs {
            font-size: 1.5em;
            font-weight: bold;
            color: #a78bfa;
        }

        .match-score {
            font-size: 2em;
            font-weight: bold;
            color: #7c3aed;
        }

        .animal-card {
            padding: 18px;
            border: 2px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            color: #e0e7ff;
        }

        .animal-card:hover {
            transform: translateY(-5px);
            border-color: #7c3aed;
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
        }

        .animal-card.selected {
            border-color: #fbbf24;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.5);
        }

        .animal-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            border-left: 5px solid #667eea;
            transition: all 0.3s;
            color: #e0e7ff;
        }

        .history-item:hover {
            transform: translateX(10px);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
        }

        .history-item.promoted {
            border-left-color: #10b981;
        }

        .history-item.relegated {
            border-left-color: #ef4444;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .tournament-bracket {
                flex-direction: column;
                gap: 40px;
                padding: 20px;
            }

            .bracket-round {
                width: 100%;
                min-width: auto;
            }
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #7c3aed, #db2777);
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš”ï¸ åŸƒç½—è¥¿å¡å¤§é™†è”èµ›ç³»ç»Ÿ âš”ï¸</h1>
            <p>äº”å¤§åœ°åŒºè”èµ› â€¢ ä»é’å¹´è”èµ›å¼€å§‹å¾ç¨‹ â€¢ æŒ‘æˆ˜å¤§é™†å† å†›</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('main')">ä¸»ç•Œé¢</button>
            <button class="tab" onclick="switchTab('career')">ç”Ÿæ¶¯å†å²</button>
        </div>

        <div class="content">
            <!-- ä¸»ç•Œé¢ -->
            <div id="main-tab" class="tab-content active">
                <div id="not-joined-view">
                    <div class="info-box" style="max-width: 900px; margin: 0 auto 40px;">
                        <h3>ğŸ® å¼€å§‹ä½ çš„è”èµ›å¾ç¨‹</h3>
                        <p style="font-size: 1.1em; margin-bottom: 15px;">
                            æ‰€æœ‰ç©å®¶éƒ½ä»<strong style="color: #a78bfa;">é’å¹´è”èµ›</strong>å¼€å§‹ã€‚
                        </p>
                        <p style="color: #cbd5e1; margin-bottom: 10px;">
                            <strong>å°ç»„èµ›ï¼š</strong>64é˜Ÿåˆ†16ç»„ï¼ˆæ¯ç»„4é˜Ÿï¼‰ï¼Œä¸ç»„å†…å…¶ä»–é˜Ÿå„æ‰“2åœºï¼Œå‰2åæ™‹çº§
                        </p>
                        <p style="color: #cbd5e1;">
                            <strong>æ·˜æ±°èµ›ï¼š</strong>32é˜Ÿâ†’16â†’8â†’4ï¼Œæ¯è½®å¯¹å†³2åœºï¼ˆå¹³å±€åŠ èµ›ï¼‰ï¼Œå‰4åæ™‹çº§ç”²çº§è”èµ›
                        </p>
                        <p style="color: #94a3b8; margin-top: 15px;">
                            ğŸ’¡ é’å¹´è”èµ›æ— éœ€ç™»è®°åŠ¨ç‰©ï¼Œæ¯åœºæ¯”èµ›å¯è‡ªç”±é€‰æ‹©5åªåŠ¨ç‰©å‚æˆ˜ã€‚
                        </p>
                    </div>

                    <div style="max-width: 900px; margin: 0 auto;">
                        <div class="form-group">
                            <label>é€‰æ‹©ä½ çš„åœ°åŒºï¼š</label>
                            <div class="region-grid">
                                <div class="region-card" onclick="selectRegion('ä¼Šç¼‡')">
                                    <div style="font-size: 2.5em;">ğŸŒ…</div>
                                    <h3>ä¼Šç¼‡</h3>
                                    <p>ä¸œéƒ¨åœ°åŒº</p>
                                </div>
                                <div class="region-card" onclick="selectRegion('æ‹œå°¼')">
                                    <div style="font-size: 2.5em;">ğŸŒ„</div>
                                    <h3>æ‹œå°¼</h3>
                                    <p>è¥¿éƒ¨åœ°åŒº</p>
                                </div>
                                <div class="region-card" onclick="selectRegion('ç½—å¨œ')">
                                    <div style="font-size: 2.5em;">ğŸï¸</div>
                                    <h3>ç½—å¨œ</h3>
                                    <p>å—éƒ¨åœ°åŒº</p>
                                </div>
                                <div class="region-card" onclick="selectRegion('ç½—å…°')">
                                    <div style="font-size: 2.5em;">ğŸ”ï¸</div>
                                    <h3>ç½—å…°</h3>
                                    <p>åŒ—éƒ¨åœ°åŒº</p>
                                </div>
                                <div class="region-card" onclick="selectRegion('å·´å¡')">
                                    <div style="font-size: 2.5em;">ğŸ›ï¸</div>
                                    <h3>å·´å¡</h3>
                                    <p>ä¸­éƒ¨åœ°åŒº</p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>ä½ çš„é˜Ÿä¼åç§°ï¼š</label>
                            <input type="text" id="team-name" placeholder="ä¸ºä½ çš„é˜Ÿä¼å–ä¸€ä¸ªå“äº®çš„åå­—...">
                        </div>

                        <div style="text-align: center; margin-top: 40px;">
                            <button class="btn btn-primary" onclick="joinLeague()">
                                ğŸš€ å¼€å§‹è”èµ›å¾ç¨‹
                            </button>
                        </div>
                    </div>
                </div>

                <div id="joined-main-view" style="display: none;">
                    <!-- ä¸»ç•Œé¢å¸ƒå±€ï¼šå·¦å³åˆ†æ  -->
                    <div style="display: grid; grid-template-columns: 380px 750px; gap: 20px; max-width: 1200px; margin: 0 auto;">
                        
                        <!-- å·¦ä¾§ï¼šè®­ç»ƒå¸ˆæ¡£æ¡ˆ -->
                        <div class="info-box" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(124, 58, 237, 0.1) 100%); border: 2px solid rgba(139, 92, 246, 0.5); height: fit-content;">
                            <h3 style="color: #c4b5fd; margin-bottom: 20px; font-size: 1.5em; text-align: center;">ğŸ« è®­ç»ƒå¸ˆæ¡£æ¡ˆ</h3>
                            
                            <!-- å‚èµ›ä¿¡æ¯ -->
                            <div style="background: rgba(30, 41, 59, 0.7); border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(139, 92, 246, 0.2);">
                                <h4 style="color: #c4b5fd; font-size: 1.1em; margin-bottom: 12px; text-align: center; font-weight: bold;">ğŸ“‹ å‚èµ›ä¿¡æ¯</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">é˜Ÿä¼åç§°</span>
                                        <span id="info-team-name" style="color: #e0e7ff; font-weight: bold;">---</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">æ‰€åœ¨åœ°åŒº</span>
                                        <span id="info-region" style="color: #e0e7ff; font-weight: bold;">---</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">å½“å‰è”èµ›</span>
                                        <span id="info-league" style="color: #c4b5fd; font-weight: bold;">---</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">å½“å‰èµ›å­£</span>
                                        <span id="info-season" style="color: #e0e7ff; font-weight: bold;">---</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">æœ€é«˜æˆå°±</span>
                                        <span id="info-achievement" style="color: #fbbf24; font-weight: bold;">---</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">å‚èµ›æ¬¡æ•°</span>
                                        <span id="info-seasons-played" style="color: #e0e7ff; font-weight: bold;">---</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- æˆ˜æ–—ä¿¡æ¯ -->
                            <div style="background: rgba(16, 185, 129, 0.15); border: 2px solid rgba(16, 185, 129, 0.4); border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px rgba(16, 185, 129, 0.2);">
                                <h4 style="color: #86efac; font-size: 1.1em; margin-bottom: 12px; text-align: center; font-weight: bold;">âš”ï¸ æˆ˜æ–—ä¿¡æ¯</h4>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">æ€»æ¯”èµ›åœºæ¬¡</span>
                                        <span id="info-total-matches" style="color: #e0e7ff; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">èƒœåœº</span>
                                        <span id="info-wins" style="color: #6ee7b7; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">è´Ÿåœº</span>
                                        <span id="info-losses" style="color: #fca5a5; font-weight: bold;">0</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">å‡»è´¥å¯¹æ‰‹</span>
                                        <span id="info-defeated" style="color: #6ee7b7; font-weight: bold;">0æ¬¡</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">è¢«å‡»è´¥</span>
                                        <span id="info-defeated-by" style="color: #fca5a5; font-weight: bold;">0æ¬¡</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #94a3b8; font-size: 0.95em;">èƒœç‡</span>
                                        <span id="info-win-rate" style="color: #c4b5fd; font-weight: bold;">0%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šä¸Šä¸‹åˆ†æ  -->
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            
                            <!-- ä¸Šéƒ¨ï¼šæ¯”èµ›ä¿¡æ¯ -->
                            <div class="info-box" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%); border: 2px solid rgba(16, 185, 129, 0.4);">
                                <h3 style="color: #86efac; margin-bottom: 15px; font-size: 1.4em;">ğŸ“… æ¯”èµ›ä¿¡æ¯</h3>
                                <div id="match-info" style="color: #e0e7ff;">
                                    <!-- æ¯”èµ›ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;" id="season-control-btn">
                                    <button class="btn btn-primary" onclick="skipToKnockout()" id="skip-to-knockout-btn" style="display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                        âš¡ è·³è¿‡å°ç»„èµ›
                                    </button>
                                    <button class="btn btn-primary" onclick="startNextSeason()" id="next-season-btn" style="display: none;">
                                        ğŸ å¼€å§‹ä¸‹èµ›å­£
                                    </button>
                                    <button class="btn btn-secondary" onclick="resetSeason()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                                        ğŸ”„ é‡ç½®èµ›å­£
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ä¸‹éƒ¨ï¼šå·¦å³åˆ†æ  -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                
                                <!-- å·¦ä¸‹ï¼šè¯¦ç»†èµ›ç¨‹æŒ‰é’® -->
                                <div class="info-box" onclick="switchTab('schedule')" style="cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 160px; transition: all 0.3s; border: 2px solid rgba(124, 58, 237, 0.4); padding: 20px;" onmouseover="this.style.borderColor='#7c3aed'; this.style.boxShadow='0 6px 20px rgba(124, 58, 237, 0.4)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='rgba(124, 58, 237, 0.4)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ“Š</div>
                                        <h3 style="color: #a78bfa; font-size: 1.3em; margin-bottom: 8px;">è¯¦ç»†èµ›ç¨‹</h3>
                                        <p style="color: #cbd5e1; font-size: 0.95em;">æŸ¥çœ‹å®Œæ•´æ’å</p>
                                    </div>
                                </div>
                                
                                <!-- å³ä¸‹ï¼šæˆ˜æ–—å‡†å¤‡æŒ‰é’® -->
                                <div class="info-box" onclick="openBattlePreparation()" style="cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 160px; transition: all 0.3s; border: 2px solid rgba(16, 185, 129, 0.4); padding: 20px;" onmouseover="this.style.borderColor='#10b981'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)'; this.style.transform='translateY(-3px)'" onmouseout="this.style.borderColor='rgba(16, 185, 129, 0.4)'; this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5em; margin-bottom: 10px;">âš”ï¸</div>
                                        <h3 style="color: #86efac; font-size: 1.3em; margin-bottom: 8px;">æˆ˜æ–—å‡†å¤‡</h3>
                                        <p style="color: #cbd5e1; font-size: 0.95em;" id="battle-prep-hint">é€‰æ‹©å‚æˆ˜åŠ¨ç‰©</p>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="registration-view" style="display: none; max-width: 1200px; margin: 0 auto;">
                    <div class="info-box success">
                        <h3>ğŸ‰ æ­å–œæ™‹çº§ï¼</h3>
                        <p id="promotion-info" style="font-size: 1.2em;"></p>
                    </div>
                    
                    <div class="info-box warning">
                        <h3>âš ï¸ åŠ¨ç‰©åå•ç™»è®°</h3>
                        <p>ä½ ç°åœ¨éœ€è¦ç™»è®°25åªåŠ¨ç‰©ä½œä¸ºæœ¬èµ›å­£çš„å‚èµ›åå•ã€‚</p>
                    </div>
                    
                    <div class="form-group">
                        <label>é€‰æ‹©25åªåŠ¨ç‰©ï¼š</label>
                        <div style="text-align: center; margin: 20px 0;">
                            <span style="font-size: 1.3em; color: #a78bfa;">å·²é€‰æ‹©ï¼š</span>
                            <span id="reg-selected-count" style="font-size: 2em; font-weight: bold; color: #fbbf24;">0</span>
                            <span style="font-size: 1.3em; color: #a78bfa;"> / 25</span>
                        </div>
                        <div class="animal-list" id="registration-animal-list"></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <button class="btn btn-primary" onclick="completeRegistration()">
                            âœ… å®Œæˆç™»è®°ï¼Œå¼€å§‹æ–°èµ›å­£
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æˆ˜æ–—å‡†å¤‡ç•Œé¢ -->
            <div id="battle-preparation-tab" class="tab-content">
                <div style="max-width: 1400px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #a78bfa; font-size: 2em;">âš”ï¸ æˆ˜æ–—å‡†å¤‡</h2>
                        <button class="btn btn-secondary" onclick="switchTab('main')">â† è¿”å›ä¸»ç•Œé¢</button>
                    </div>
                    
                    <!-- å¯¹æ‰‹ä¿¡æ¯ -->
                    <div id="battle-opponent-info" class="info-box" style="margin-bottom: 20px;">
                        <!-- å¯¹æ‰‹ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <!-- VSå¸ƒå±€ï¼šå·¦è¾¹ç©å®¶ï¼Œå³è¾¹å¯¹æ‰‹ -->
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
                        <!-- å·¦ä¾§ï¼šç©å®¶åŠ¨ç‰© -->
                        <div class="info-box">
                            <h3 style="color: #fbbf24; margin-bottom: 20px; font-size: 1.3em; text-align: center;">ğŸ‘¤ æˆ‘æ–¹é˜µå®¹</h3>
                            <div id="team-slots" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px;">
                                <!-- åŠ¨ç‰©æ ¼å­å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                        
                        <!-- ä¸­é—´ï¼šVS -->
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                            <div style="font-size: 3em; font-weight: bold; color: #ef4444; text-shadow: 0 0 20px rgba(239, 68, 68, 0.8); writing-mode: vertical-rl; text-orientation: upright;">VS</div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šå¯¹æ‰‹åŠ¨ç‰© -->
                        <div class="info-box" style="border-color: rgba(239, 68, 68, 0.4);">
                            <h3 style="color: #ef4444; margin-bottom: 20px; font-size: 1.3em; text-align: center;">ğŸ‘¥ å¯¹æ‰‹å¸¸ç”¨åŠ¨ç‰©</h3>
                            <div id="opponent-slots" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px;">
                                <!-- å¯¹æ‰‹åŠ¨ç‰©å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="playNextRound()" style="font-size: 1.3em; padding: 18px 50px;">
                            â–¶ï¸ è¿›è¡Œä¸‹ä¸€åœºæ¯”èµ›
                        </button>
                        <button class="btn btn-primary" onclick="debugAutoWin()" style="font-size: 1.1em; padding: 15px 35px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            ğŸ® ç›´æ¥èƒœåˆ©(è°ƒè¯•)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- åŠ¨ç‰©è¯¦æƒ…æ¨¡æ€æ¡† -->
            <div id="animal-detail-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;" onclick="closeAnimalDetailModal()">
                <div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 1) 100%); border: 2px solid rgba(139, 92, 246, 0.6); border-radius: 15px; padding: 25px; max-width: 700px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.8);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #c4b5fd; font-size: 1.3em; margin: 0;">åŠ¨ç‰©è¯¦æƒ…</h3>
                        <button onclick="closeAnimalDetailModal()" style="background: transparent; border: none; color: #94a3b8; font-size: 1.8em; cursor: pointer; padding: 0; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center;">&times;</button>
                    </div>
                    <div id="animal-detail-content-modal">
                        <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
 
            <!-- ç”Ÿæ¶¯å†å² -->
            <div id="career-tab" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #a78bfa; font-size: 2em; text-align: center;">ğŸ“œ èŒä¸šç”Ÿæ¶¯å†å²</h2>
                <div id="career-history-content" style="max-width: 900px; margin: 0 auto;">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“œ</div>
                        <p>è¯·å…ˆåŠ å…¥è”èµ›</p>
                    </div>
                </div>
            </div>

            <!-- èµ›ç¨‹ -->
            <div id="schedule-tab" class="tab-content">
                <h2 style="margin-bottom: 30px; color: #a78bfa; font-size: 2em; text-align: center;">ğŸ“Š èµ›ç¨‹æ’è¡Œæ¦œ</h2>
                <div id="schedule-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>è¯·å…ˆåŠ å…¥è”èµ›</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="image_library.js"></script>
    <script src="league_system.js"></script>
    <script>
        let leagueSystem;
        let selectedRegion = null;
        let selectedAnimals = [];
        let playerAnimals = [];

        window.onload = async function() {
            leagueSystem = new LeagueSystem();
            loadPlayerAnimals();
            await loadSavedData();
            
            // è°ƒè¯•ï¼šæ£€æŸ¥è”èµ›é˜Ÿä¼æ•°é‡
            if (leagueSystem.playerTeam && leagueSystem.playerTeam.region && leagueSystem.playerTeam.league) {
                const league = leagueSystem.getLeagueInfo(leagueSystem.playerTeam.region, leagueSystem.playerTeam.league);
                console.log('é¡µé¢åŠ è½½å®Œæˆ - è”èµ›é˜Ÿä¼æ•°é‡:', league.teams ? league.teams.length : 0);
                if (league.groupStage && league.groupStage.groups) {
                    console.log('å°ç»„æ•°é‡:', league.groupStage.groups.length);
                    league.groupStage.groups.forEach((group, index) => {
                        console.log(`ç¬¬${index + 1}ç»„é˜Ÿä¼æ•°:`, group.length);
                    });
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä»æˆ˜æ–—è¿”å›
            checkBattleReturn();
            
            updateUI();
        };
        
        // æ£€æŸ¥æ˜¯å¦ä»æˆ˜æ–—ç³»ç»Ÿè¿”å›
        async function checkBattleReturn() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ¯”èµ›ç»“æœï¼ˆ5v5å…¨éƒ¨ç»“æŸï¼‰
            const matchResult = localStorage.getItem('leagueMatchResult');
            if (matchResult) {
                await processLeagueMatchResult(JSON.parse(matchResult));
                localStorage.removeItem('leagueMatchResult');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„é˜Ÿåˆ—ï¼ˆå•åœºæˆ˜æ–—ç»“æŸï¼‰
            const queueData = JSON.parse(localStorage.getItem('leagueBattleQueue'));
            if (queueData) {
                // å¦‚æœé˜Ÿåˆ—è¿˜æœ‰æ•°æ®ï¼Œè¯´æ˜æ˜¯ä»å•åœºæˆ˜æ–—è¿”å›ï¼Œä½†è¿™åº”è¯¥ç”±battle_systemå¤„ç†
                // è¿™é‡Œåªéœ€è¦ç­‰å¾…ï¼Œbattle_systemä¼šå¤„ç†ç»§ç»­é€»è¾‘
                return;
            }
        }

        function loadPlayerAnimals() {
            // ç¨€æœ‰åº¦è‹±æ–‡è½¬ä¸­æ–‡æ˜ å°„
            const rarityMap = {
                'common': 'æ™®é€š',
                'shiny': 'é—ªå…‰',
                'prismatic': 'å¹»å½©',
                'stellar': 'æ˜ŸèŠ’'
            };
            
            // ä»æ¸¸æˆçŠ¶æ€ä¸­è¯»å–çœŸå®çš„åŠ¨ç‰©æ•°æ®
            const gameStateJSON = localStorage.getItem('gameState');
            if (gameStateJSON) {
                try {
                    const gameState = JSON.parse(gameStateJSON);
                    if (gameState.animals && Array.isArray(gameState.animals)) {
                        // è½¬æ¢ä¸ºè”èµ›ç³»ç»Ÿéœ€è¦çš„æ ¼å¼
                        playerAnimals = gameState.animals.map(animal => ({
                            id: animal.id,
                            name: animal.name,
                            hp: animal.maxStamina || 100,
                            attack: animal.abilities?.combat?.attack || 10,
                            defense: animal.abilities?.combat?.defense || 5,
                            agility: animal.abilities?.combat?.agility || 8,
                            level: animal.level || 1,
                            element: animal.element,
                            gender: animal.gender,
                            rarity: rarityMap[animal.rarity] || animal.rarity || 'æ™®é€š',
                            color: animal.color,
                            templateKey: animal.templateKey,
                            animalId: animal.animalId,
                            // ä¿ç•™åŸå§‹åŠ¨ç‰©å¼•ç”¨
                            originalAnimal: animal
                        }));
                        console.log(`å·²åŠ è½½ ${playerAnimals.length} åªçœŸå®åŠ¨ç‰©`);
                        return;
                    }
                } catch (e) {
                    console.error('åŠ è½½åŠ¨ç‰©æ•°æ®å¤±è´¥:', e);
                }
            }
            
            // å¦‚æœæ²¡æœ‰çœŸå®æ•°æ®ï¼Œæç¤ºç”¨æˆ·
            playerAnimals = [];
            console.warn('æœªæ‰¾åˆ°æ¸¸æˆæ•°æ®ï¼Œè¯·å…ˆåœ¨ä¸»åœºæ™¯ä¸­æ•è·ä¸€äº›åŠ¨ç‰©ï¼');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®ï¼ˆscheduleæ ‡ç­¾å·²ç§»é™¤ï¼Œé€šè¿‡ä¸»ç•Œé¢æŒ‰é’®è®¿é—®ï¼‰
            if (tabName === 'main') {
                document.querySelector('.tab[onclick*="main"]').classList.add('active');
            } else if (tabName === 'career') {
                document.querySelector('.tab[onclick*="career"]').classList.add('active');
            }
            // scheduleæ²¡æœ‰æ ‡ç­¾æŒ‰é’®ï¼Œä¸éœ€è¦æ¿€æ´»
            
            updateTabContent(tabName);
        }

        function selectRegion(region) {
            selectedRegion = region;
            document.querySelectorAll('.region-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.region-card').classList.add('selected');
        }

        async function joinLeague() {
            if (!selectedRegion) {
                alert('è¯·é€‰æ‹©åœ°åŒºï¼');
                return;
            }

            const teamName = document.getElementById('team-name').value.trim();
            if (!teamName) {
                alert('è¯·è¾“å…¥é˜Ÿä¼åç§°ï¼');
                return;
            }

            try {
                leagueSystem.joinLeague(selectedRegion, teamName);
                alert('ğŸ‰ æˆåŠŸåŠ å…¥è”èµ›ï¼ä»é’å¹´è”èµ›å¼€å§‹ä½ çš„å¾ç¨‹ï¼');
                await saveData();
                updateUI();
            } catch (error) {
                alert('åŠ å…¥å¤±è´¥ï¼š' + error.message);
            }
        }

        function displayRegistrationAnimalList() {
            const animalList = document.getElementById('registration-animal-list');
            animalList.innerHTML = '';
            selectedAnimals = [];

            playerAnimals.forEach(animal => {
                const card = document.createElement('div');
                card.className = 'animal-card';
                card.innerHTML = `
                    <h4 style="margin-bottom: 10px;">${animal.name}</h4>
                    <p>ç­‰çº§: ${animal.level}</p>
                    <p>HP: ${Math.round(animal.hp)}</p>
                    <p>æ”»å‡»: ${Math.round(animal.attack)}</p>
                    <p>é˜²å¾¡: ${Math.round(animal.defense)}</p>
                `;
                card.onclick = () => toggleAnimalSelection(animal, card);
                animalList.appendChild(card);
            });
        }

        function toggleAnimalSelection(animal, card) {
            const index = selectedAnimals.findIndex(a => a.id === animal.id);
            
            if (index > -1) {
                selectedAnimals.splice(index, 1);
                card.classList.remove('selected');
            } else {
                if (selectedAnimals.length < 25) {
                    selectedAnimals.push(animal);
                    card.classList.add('selected');
                } else {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©25åªåŠ¨ç‰©ï¼');
                    return;
                }
            }
            
            document.getElementById('reg-selected-count').textContent = selectedAnimals.length;
        }

        async function completeRegistration() {
            if (selectedAnimals.length !== 25) {
                alert('è¯·é€‰æ‹©25åªåŠ¨ç‰©ï¼');
                return;
            }

            try {
                leagueSystem.registerAnimals(selectedAnimals);
                alert('âœ… ç™»è®°æˆåŠŸï¼æ–°èµ›å­£å¼€å§‹ï¼');
                selectedAnimals = [];
                document.getElementById('registration-view').style.display = 'none';
                document.getElementById('joined-main-view').style.display = 'block';
                await saveData();
                updateUI();
            } catch (error) {
                alert('ç™»è®°å¤±è´¥ï¼š' + error.message);
            }
        }

        async function playNextRound() {
            const playerTeam = leagueSystem.getPlayerTeam();
            if (!playerTeam.region) {
                alert('è¯·å…ˆåŠ å…¥è”èµ›ï¼');
                return;
            }
            
            // é’å¹´è”èµ›ï¼šåŒæ­¥æˆ˜æ–—å‡†å¤‡ä¸­é€‰æ‹©çš„åŠ¨ç‰©
            if (playerTeam.league === 'é’å¹´è”èµ›') {
                if (!window.selectedBattleAnimals || window.selectedBattleAnimals.filter(a => a).length < 5) {
                    alert('âš ï¸ è¯·å…ˆåœ¨æˆ˜æ–—å‡†å¤‡ç•Œé¢é€‰æ‹©5åªå‚æˆ˜åŠ¨ç‰©ï¼');
                    switchTab('battle-preparation');
                    return;
                }
                // å°†é€‰ä¸­çš„åŠ¨ç‰©ä¸´æ—¶å­˜å‚¨åˆ° registeredAnimals
                playerTeam.registeredAnimals = window.selectedBattleAnimals.filter(a => a);
            }

            try {
                // è·å–ä¸‹ä¸€åœºæ¯”èµ›ä¿¡æ¯
                const nextMatchInfo = getNextMatchInfo();
                if (!nextMatchInfo) {
                    alert('âš ï¸ æ²¡æœ‰å¯è¿›è¡Œçš„æ¯”èµ›ï¼');
                    return;
                }
                
                // ä¿å­˜å½“å‰è”èµ›çŠ¶æ€
                await saveData();
                
                // å‡†å¤‡æˆ˜æ–—æ•°æ®å¹¶è·³è½¬åˆ°æˆ˜æ–—ç³»ç»Ÿ
                startLeagueBattle(nextMatchInfo);
                
            } catch (error) {
                alert('æ¯”èµ›è¿›è¡Œå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è·å–ä¸‹ä¸€åœºæ¯”èµ›ä¿¡æ¯
        function getNextMatchInfo() {
            const playerTeam = leagueSystem.getPlayerTeam();
            const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
            
            if (league.name === 'é’å¹´è”èµ›') {
                if (!league.groupStage || !league.groupStage.completed) {
                    // å°ç»„èµ›ï¼šæ‰¾åˆ°ç©å®¶çš„ä¸‹ä¸€åœºæ¯”èµ›
                    const playerMatches = league.fixtures.filter(f =>
                        f.stage === 'å°ç»„èµ›' && !f.result && (f.home.isPlayer || f.away.isPlayer)
                    ).sort((a, b) => a.round - b.round);
                    
                    if (playerMatches.length > 0) {
                        const match = playerMatches[0];
                        return {
                            stage: 'å°ç»„èµ›',
                            round: match.round,
                            opponent: match.home.isPlayer ? match.away : match.home,
                            isPlayerHome: match.home.isPlayer,
                            matchData: match
                        };
                    }
                } else {
                    // æ·˜æ±°èµ›ï¼šæ‰¾åˆ°ç©å®¶çš„å½“å‰æ·˜æ±°èµ›
                    const currentMatch = league.knockoutFixtures.find(f =>
                        !f.winner && (f.team1?.isPlayer || f.team2?.isPlayer)
                    );
                    
                    if (currentMatch) {
                        return {
                            stage: currentMatch.stage,
                            round: currentMatch.round,
                            opponent: currentMatch.team1?.isPlayer ? currentMatch.team2 : currentMatch.team1,
                            isPlayerTeam1: currentMatch.team1?.isPlayer,
                            matchData: currentMatch,
                            isKnockout: true
                        };
                    }
                }
            } else {
                // å…¶ä»–è”èµ›ï¼šæ‰¾åˆ°ç©å®¶çš„ä¸‹ä¸€åœºæ¯”èµ›
                const upcomingMatches = league.fixtures.filter(f =>
                    !f.result && (f.home.isPlayer || f.away.isPlayer)
                ).sort((a, b) => a.round - b.round);
                
                if (upcomingMatches.length > 0) {
                    const match = upcomingMatches[0];
                    return {
                        stage: 'å¸¸è§„èµ›',
                        round: match.round,
                        opponent: match.home.isPlayer ? match.away : match.home,
                        isPlayerHome: match.home.isPlayer,
                        matchData: match
                    };
                }
            }
            
            return null;
        }
        
        // å¯åŠ¨è”èµ›æˆ˜æ–—
        function startLeagueBattle(matchInfo) {
            const playerTeam = leagueSystem.getPlayerTeam();
            
            // ä¿å­˜è”èµ›æˆ˜æ–—ä¿¡æ¯åˆ° localStorage
            localStorage.setItem('leagueBattleInfo', JSON.stringify({
                region: playerTeam.region,
                league: playerTeam.league,
                matchInfo: matchInfo
            }));
            
            // ä¿å­˜è¿”å›URL
            localStorage.setItem('battleReturnUrl', 'league.html');
            
            // å‡†å¤‡5v5æˆ˜æ–—é˜Ÿåˆ—
            const playerAnimals = playerTeam.registeredAnimals.slice(0, 5);
            const opponentAnimals = matchInfo.opponent.registeredAnimals?.slice(0, 5) || [];
            
            if (playerAnimals.length < 5) {
                alert('âš ï¸ å‚æˆ˜åŠ¨ç‰©ä¸è¶³5åªï¼');
                return;
            }
            
            if (opponentAnimals.length < 5) {
                alert('âš ï¸ å¯¹æ‰‹æ•°æ®å¼‚å¸¸ï¼');
                return;
            }
            
            // ä¿å­˜æˆ˜æ–—é˜Ÿåˆ—
            localStorage.setItem('leagueBattleQueue', JSON.stringify({
                playerAnimals: playerAnimals,
                opponentAnimals: opponentAnimals,
                currentBattle: 0,
                playerWins: 0,
                opponentWins: 0
            }));
            
            // å¼€å§‹ç¬¬ä¸€åœºæˆ˜æ–—
            startNextBattleInQueue();
        }
        
        // å¼€å§‹é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€åœºæˆ˜æ–—
        function startNextBattleInQueue() {
            const queueData = JSON.parse(localStorage.getItem('leagueBattleQueue'));
            if (!queueData) {
                alert('æˆ˜æ–—é˜Ÿåˆ—æ•°æ®ä¸¢å¤±ï¼');
                return;
            }
            
            const currentIndex = queueData.currentBattle;
            
            // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰æˆ˜æ–—
            if (currentIndex >= 5 || queueData.playerWins >= 3 || queueData.opponentWins >= 3) {
                finishLeagueMatch(queueData);
                return;
            }
            
            // å‡†å¤‡å½“å‰æˆ˜æ–—çš„æ•°æ®
            const playerAnimal = queueData.playerAnimals[currentIndex];
            const opponentAnimal = queueData.opponentAnimals[currentIndex];
            
            // è½¬æ¢ä¸ºæˆ˜æ–—ç³»ç»Ÿéœ€è¦çš„æ ¼å¼
            const battlePlayerAnimal = {
                ...playerAnimal.originalAnimal || playerAnimal,
                stamina: playerAnimal.hp || playerAnimal.originalAnimal?.maxStamina || 300,
                abilities: {
                    combat: {
                        attack: playerAnimal.attack || 50,
                        defense: playerAnimal.defense || 50,
                        agility: playerAnimal.agility || 50
                    }
                }
            };
            
            const battleOpponent = {
                ...opponentAnimal,
                stamina: opponentAnimal.hp || 300,
                abilities: {
                    combat: {
                        attack: opponentAnimal.attack || 50,
                        defense: opponentAnimal.defense || 50,
                        agility: opponentAnimal.agility || 50
                    }
                },
                isWild: false // è”èµ›å¯¹æ‰‹ä¸æ˜¯é‡ç”ŸåŠ¨ç‰©
            };
            
            // ä¿å­˜åˆ° localStorage ä¾›æˆ˜æ–—ç³»ç»Ÿä½¿ç”¨
            localStorage.setItem('battlePlayerAnimal', JSON.stringify(battlePlayerAnimal));
            localStorage.setItem('battleOpponent', JSON.stringify(battleOpponent));
            localStorage.setItem('battleReturnUrl', 'league.html');
            
            // è·³è½¬åˆ°æˆ˜æ–—åœºæ™¯
            window.location.href = 'battle.html';
        }
        
        // å®Œæˆè”èµ›æ¯”èµ›ï¼ˆ5v5ç»“æŸåï¼‰
        function finishLeagueMatch(queueData) {
            const playerWins = queueData.playerWins;
            const opponentWins = queueData.opponentWins;
            
            // æ¸…é™¤é˜Ÿåˆ—æ•°æ®
            localStorage.removeItem('leagueBattleQueue');
            
            // ç¡®å®šèƒœè´Ÿ
            const playerWon = playerWins > opponentWins;
            
            // ä¿å­˜æ¯”èµ›ç»“æœ
            localStorage.setItem('leagueMatchResult', JSON.stringify({
                playerWins: playerWins,
                opponentWins: opponentWins,
                result: playerWon ? 'win' : 'loss'
            }));
            
            // æ˜¾ç¤ºç»“æœå¹¶å¤„ç†è”èµ›é€»è¾‘
            alert(`âš”ï¸ 5v5æ¯”èµ›ç»“æŸï¼\n\næˆ‘æ–¹: ${playerWins} èƒœ\nå¯¹æ–¹: ${opponentWins} èƒœ\n\nç»“æœ: ${playerWon ? 'ğŸ‰ èƒœåˆ©ï¼' : 'ğŸ’€ å¤±è´¥...'}`);
            
            // å¤„ç†è”èµ›ç»“æœ
            processLeagueMatchResult(playerWon);
        }
        
        // å¤„ç†è”èµ›æ¯”èµ›ç»“æœ
        async function processLeagueMatchResult(matchResultData) {
            const playerTeam = leagueSystem.getPlayerTeam();
            const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
            const matchResult = matchResultData || JSON.parse(localStorage.getItem('leagueMatchResult'));
            
            if (!matchResult) {
                console.error('æ²¡æœ‰æ¯”èµ›ç»“æœæ•°æ®ï¼');
                return;
            }
            
            console.log('å¤„ç†è”èµ›æ¯”èµ›ç»“æœ:', matchResult);
            
            try {
                // å¦‚æœæ˜¯æ·˜æ±°èµ›ï¼Œéœ€è¦æ‰‹åŠ¨è®°å½•æˆ˜æ–—ç»“æœï¼Œä¸è°ƒç”¨playRound
                if (league.name === 'é’å¹´è”èµ›' && league.groupStage && league.groupStage.completed) {
                    console.log('å¤„ç†é’å¹´è”èµ›æ·˜æ±°èµ›ç»“æœ');
                    
                    // æ‰¾åˆ°ç©å®¶çš„å½“å‰æ·˜æ±°èµ›å¯¹å†³ï¼ˆæœªå†³å‡ºèƒœè´Ÿçš„ï¼‰
                    // ä¸ä½¿ç”¨currentRoundï¼Œç›´æ¥æŸ¥æ‰¾æœªå®Œæˆçš„ç©å®¶å¯¹å†³
                    const playerFixture = league.knockoutFixtures.find(f =>
                        !f.winner && (f.team1?.isPlayer || f.team2?.isPlayer)
                    );
                    
                    if (!playerFixture) {
                        console.error('æœªæ‰¾åˆ°ç©å®¶çš„æ·˜æ±°èµ›å¯¹å†³');
                        alert('âŒ æœªæ‰¾åˆ°å½“å‰å¯¹å†³ä¿¡æ¯');
                        localStorage.removeItem('leagueMatchResult');
                        return;
                    }
                    
                    console.log('æ‰¾åˆ°ç©å®¶å¯¹å†³:', {
                        stage: playerFixture.stage,
                        round: playerFixture.round,
                        team1: playerFixture.team1?.teamName,
                        team2: playerFixture.team2?.teamName,
                        matchesPlayed: playerFixture.matches?.length || 0
                    });
                    
                    // å°†çœŸå®æˆ˜æ–—ç»“æœæ·»åŠ åˆ°matchesæ•°ç»„
                    const playerIsTeam1 = playerFixture.team1?.isPlayer;
                    if (!playerFixture.matches) {
                        playerFixture.matches = [];
                    }
                    
                    playerFixture.matches.push({
                        winner: matchResult.result === 'win' ?
                            (playerIsTeam1 ? playerFixture.team1 : playerFixture.team2) :
                            (playerIsTeam1 ? playerFixture.team2 : playerFixture.team1),
                        home: playerFixture.team1,
                        away: playerFixture.team2,
                        homeWins: playerIsTeam1 ? matchResult.playerWins : matchResult.opponentWins,
                        awayWins: playerIsTeam1 ? matchResult.opponentWins : matchResult.playerWins,
                        homePoints: matchResult.result === 'win' ?
                            (playerIsTeam1 ? 3 : 0) : (playerIsTeam1 ? 0 : 3),
                        awayPoints: matchResult.result === 'win' ?
                            (playerIsTeam1 ? 0 : 3) : (playerIsTeam1 ? 3 : 0)
                    });
                    
                    console.log('æ·»åŠ æˆ˜æ–—ç»“æœåï¼Œmatchesæ•°é‡:', playerFixture.matches.length);
                    
                    // æ£€æŸ¥ç©å®¶æ˜¯å¦å†³å‡ºèƒœè´Ÿ
                    const team1Wins = playerFixture.matches.filter(m => m.winner === playerFixture.team1).length;
                    const team2Wins = playerFixture.matches.filter(m => m.winner === playerFixture.team2).length;
                    
                    console.log('å½“å‰æˆ˜ç»©:', { team1Wins, team2Wins });
                    
                    const roundFixtures = league.knockoutFixtures.filter(f => f.round === playerFixture.round);
                    
                    if (team1Wins >= 2 || team2Wins >= 2) {
                        // ç©å®¶å·²å†³å‡ºèƒœè´Ÿ
                        playerFixture.winner = team1Wins > team2Wins ? playerFixture.team1 : playerFixture.team2;
                        console.log('ç©å®¶å·²å†³å‡ºèƒœè´Ÿï¼Œèƒœè€…:', playerFixture.winner.teamName);
                        
                        // ç«‹å³å®Œæˆæœ¬è½®æ‰€æœ‰å…¶ä»–AIå¯¹å±€
                        console.log(`æœ¬è½®å…±${roundFixtures.length}åœºæ¯”èµ›ï¼Œç«‹å³å®Œæˆæ‰€æœ‰AIå¯¹å±€...`);
                        
                        roundFixtures.forEach(f => {
                            if (f !== playerFixture && !f.winner) {
                                if (!f.matches) f.matches = [];
                                
                                // è®¡ç®—å½“å‰æˆ˜ç»©
                                let ai_team1Wins = f.matches.filter(m => m.winner === f.team1).length;
                                let ai_team2Wins = f.matches.filter(m => m.winner === f.team2).length;
                                
                                // ç»§ç»­æ·»åŠ æ¯”èµ›ç›´åˆ°å†³å‡ºèƒœè´Ÿï¼ˆæœ€å¤š3åœºï¼‰
                                while (f.matches.length < 3 && ai_team1Wins < 2 && ai_team2Wins < 2) {
                                    const aiMatch = leagueSystem.simulateMatch(f.team1, f.team2);
                                    f.matches.push(aiMatch);
                                    
                                    // é‡æ–°è®¡ç®—æˆ˜ç»©
                                    ai_team1Wins = f.matches.filter(m => m.winner === f.team1).length;
                                    ai_team2Wins = f.matches.filter(m => m.winner === f.team2).length;
                                }
                                
                                // è®¾ç½®èƒœè€…
                                f.winner = ai_team1Wins > ai_team2Wins ? f.team1 : f.team2;
                            }
                        });
                        
                        // æ›´æ–°ä¸‹ä¸€è½®å¯¹é˜µ
                        leagueSystem.updateNextKnockoutRound(league, playerFixture.round);
                        
                        // æ›´æ–°å½“å‰è½®æ¬¡
                        league.currentRound = playerFixture.round;
                        
                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                        if (playerFixture.stage === 'å†³èµ›') {
                            league.completed = true;
                            leagueSystem.processYouthLeagueEnd(league);
                        }
                    } else {
                        // ç©å®¶æœªå†³å‡ºèƒœè´Ÿï¼ŒåŒæ­¥æ¨¡æ‹Ÿå…¶ä»–AIå¯¹å±€çš„1åœºæ¯”èµ›
                        console.log(`æœ¬è½®å…±${roundFixtures.length}åœºæ¯”èµ›ï¼ŒåŒæ­¥æ¨¡æ‹Ÿå…¶ä»–AIå¯¹å±€çš„1åœº...`);
                        
                        roundFixtures.forEach(f => {
                            if (f !== playerFixture && !f.winner) {
                                // ä¸ºæ¯ä¸ªAIå¯¹å±€æ·»åŠ 1åœºæ¯”èµ›
                                if (!f.matches) f.matches = [];
                                
                                // è®¡ç®—å·²æœ‰æˆ˜ç»©
                                let ai_team1Wins = f.matches.filter(m => m.winner === f.team1).length;
                                let ai_team2Wins = f.matches.filter(m => m.winner === f.team2).length;
                                
                                // åªæœ‰åœ¨æœªå†³å‡ºèƒœè´Ÿä¸”æœªè¾¾åˆ°æœ€å¤§åœºæ¬¡æ—¶æ‰æ·»åŠ 
                                if (f.matches.length < 3 && ai_team1Wins < 2 && ai_team2Wins < 2) {
                                    const aiMatch = leagueSystem.simulateMatch(f.team1, f.team2);
                                    f.matches.push(aiMatch);
                                    
                                    // é‡æ–°è®¡ç®—æˆ˜ç»©
                                    ai_team1Wins = f.matches.filter(m => m.winner === f.team1).length;
                                    ai_team2Wins = f.matches.filter(m => m.winner === f.team2).length;
                                    
                                    // æ£€æŸ¥æ˜¯å¦å†³å‡ºèƒœè´Ÿ
                                    if (ai_team1Wins >= 2 || ai_team2Wins >= 2) {
                                        f.winner = ai_team1Wins > ai_team2Wins ? f.team1 : f.team2;
                                        console.log(`  AIå¯¹å±€å†³å‡ºèƒœè´Ÿ: ${f.team1.teamName} ${ai_team1Wins}:${ai_team2Wins} ${f.team2.teamName}`);
                                    }
                                }
                            }
                        });
                    }
                    
                    await saveData();
                    updateAllTabs();
                    
                    // æ¸…é™¤æ¯”èµ›ç»“æœ
                    localStorage.removeItem('leagueMatchResult');
                    
                    if (league.completed) {
                        alert('ğŸ èµ›å­£å·²ç»“æŸï¼');
                        document.getElementById('next-season-btn').style.display = 'inline-block';
                    }
                    
                    return;
                }
                
                // éæ·˜æ±°èµ›æˆ–å…¶ä»–æƒ…å†µï¼Œè°ƒç”¨playRound
                const result = leagueSystem.playRound(playerTeam.region, playerTeam.league);
                
                if (result.error) {
                    alert(result.error);
                    return;
                }

                await saveData();
                updateAllTabs();
                
                // æ¸…é™¤æ¯”èµ›ç»“æœ
                localStorage.removeItem('leagueMatchResult');
                
                if (result.completed) {
                    alert('ğŸ èµ›å­£å·²ç»“æŸï¼');
                    document.getElementById('next-season-btn').style.display = 'inline-block';
                }
            } catch (error) {
                alert('å¤„ç†æ¯”èµ›ç»“æœå¤±è´¥ï¼š' + error.message);
            }
        }

        async function simulateFullSeason() {
            if (!confirm('ç¡®å®šè¦æ¨¡æ‹Ÿå®Œæ•´èµ›å­£å—ï¼Ÿ')) return;

            const playerTeam = leagueSystem.getPlayerTeam();
            const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
            
            while (!league.completed) {
                leagueSystem.playRound(playerTeam.region, playerTeam.league);
            }

            await saveData();
            updateUI();
            document.getElementById('next-season-btn').style.display = 'inline-block';
            alert('âš¡ èµ›å­£æ¨¡æ‹Ÿå®Œæˆï¼');
        }

        async function startNextSeason() {
            try {
                const result = leagueSystem.startNewSeason();
                
                if (result.needsRegistration) {
                    document.getElementById('joined-main-view').style.display = 'none';
                    document.getElementById('registration-view').style.display = 'block';
                    document.getElementById('promotion-info').textContent = 
                        `ä½ å·²ä»${result.previousLeague.league}æ™‹çº§åˆ°${leagueSystem.playerTeam.league}ï¼`;
                    displayRegistrationAnimalList();
                } else {
                    alert(`ğŸ æ–°èµ›å­£å¼€å§‹ï¼å½“å‰è”èµ›ï¼š${leagueSystem.playerTeam.league}`);
                    document.getElementById('next-season-btn').style.display = 'none';
                    await saveData();
                    updateUI();
                }
            } catch (error) {
                alert('å¼€å§‹æ–°èµ›å­£å¤±è´¥ï¼š' + error.message);
            }
        }

        function updateAllTabs() {
            updateTabContent('main');
            updateTabContent('career');
            updateTabContent('schedule');
        }

        function updateTabContent(tabName) {
            const playerTeam = leagueSystem.getPlayerTeam();
            if (!playerTeam.region) return;

            const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);

            switch(tabName) {
                case 'main':
                    displayMainView(league);
                    break;
                case 'career':
                    displayCareerHistory();
                    break;
                case 'schedule':
                    displaySchedule(league);
                    break;
                case 'battle-preparation':
                    updateBattlePreparation();
                    break;
            }
        }

        function displayMainView(league) {
            // æ›´æ–°ä¸ªäººä¿¡æ¯å¡ç‰‡
            updatePlayerInfo();
            
            // æ›´æ–°æ¯”èµ›ä¿¡æ¯
            updateMatchInfo(league);
            
            // æ›´æ–°æˆ˜æ–—å‡†å¤‡æç¤º
            updateBattlePreparationHint();
        }
        
        function updateBattlePreparationHint() {
            const playerTeam = leagueSystem.getPlayerTeam();
            const hint = document.getElementById('battle-prep-hint');
            if (!hint) return;
            
            const isYouthLeague = playerTeam.league === 'é’å¹´è”èµ›';
            const selectedCount = isYouthLeague ? (window.selectedBattleAnimals?.filter(a => a).length || 0) : playerTeam.registeredAnimals.length;
            const totalNeeded = isYouthLeague ? 5 : 25;
            
            hint.textContent = `å·²é€‰æ‹© ${selectedCount}/${totalNeeded} åªåŠ¨ç‰©`;
        }
        
        function openBattlePreparation() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨åŠ¨ç‰©
            if (playerAnimals.length === 0) {
                alert('âš ï¸ æ‚¨è¿˜æ²¡æœ‰ä»»ä½•åŠ¨ç‰©ï¼\n\nè¯·å…ˆåœ¨ä¸»åœºæ™¯ä¸­ï¼š\n1. æ•è·é‡ç”ŸåŠ¨ç‰©\n2. æˆ–åœ¨åŠ¨ç‰©ç®¡ç†ä¸­å¿ƒç¹æ®–åŠ¨ç‰©\n\nç„¶åè¿”å›è”èµ›ç³»ç»Ÿå‚æˆ˜ã€‚');
                return;
            }
            
            // åˆå§‹åŒ–é€‰ä¸­çš„æˆ˜æ–—åŠ¨ç‰©æ•°ç»„
            if (!window.selectedBattleAnimals) {
                window.selectedBattleAnimals = [];
            }
            
            switchTab('battle-preparation');
            updateBattlePreparation();
        }
        
        function updateBattlePreparation() {
            updateTeamSlots();
            updateOpponentInfo();
            updateOpponentSlots();
        }
        
        function updateOpponentInfo() {
            const playerTeam = leagueSystem.getPlayerTeam();
            const opponentInfoContainer = document.getElementById('battle-opponent-info');
            
            if (!playerTeam || !playerTeam.region) {
                opponentInfoContainer.innerHTML = '';
                return;
            }
            
            const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
            
            // è·å–ä¸‹ä¸€åœºå¯¹æ‰‹
            let opponentTeam = null;
            if (league.name === 'é’å¹´è”èµ›') {
                if (!league.groupStage || !league.groupStage.completed) {
                    // å°ç»„èµ›
                    const playerGroupMatches = league.fixtures.filter(f =>
                        f.stage === 'å°ç»„èµ›' && !f.result && (f.home.isPlayer || f.away.isPlayer)
                    ).sort((a, b) => a.round - b.round);
                    
                    if (playerGroupMatches.length > 0) {
                        const nextMatch = playerGroupMatches[0];
                        opponentTeam = nextMatch.home.isPlayer ? nextMatch.away : nextMatch.home;
                    }
                } else {
                    // æ·˜æ±°èµ›
                    const currentKnockoutMatch = league.knockoutFixtures.find(f =>
                        !f.winner && (f.team1?.isPlayer || f.team2?.isPlayer)
                    );
                    if (currentKnockoutMatch) {
                        opponentTeam = currentKnockoutMatch.team1?.isPlayer ? currentKnockoutMatch.team2 : currentKnockoutMatch.team1;
                    }
                }
            } else {
                // å…¶ä»–è”èµ›
                const upcomingMatches = league.fixtures.filter(f =>
                    !f.result && (f.home.isPlayer || f.away.isPlayer)
                ).sort((a, b) => a.round - b.round);
                
                if (upcomingMatches.length > 0) {
                    const nextMatch = upcomingMatches[0];
                    opponentTeam = nextMatch.home.isPlayer ? nextMatch.away : nextMatch.home;
                }
            }
            
            if (opponentTeam) {
                const opponentStats = getOpponentStats(league, opponentTeam);
                opponentInfoContainer.innerHTML = `
                    <div style="text-align: center;">
                        <h3 style="color: #ef4444; font-size: 1.4em; margin-bottom: 10px;">ä¸‹ä¸€åœºå¯¹æ‰‹ï¼š${opponentTeam.teamName}</h3>
                        <div style="display: inline-flex; gap: 10px;">
                            <span style="background: rgba(124, 58, 237, 0.3); padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">èƒœç‡ ${opponentStats.winRate}%</span>
                            <span style="background: rgba(16, 185, 129, 0.3); padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">èƒœ ${opponentStats.wins}</span>
                            <span style="background: rgba(239, 68, 68, 0.3); padding: 6px 12px; border-radius: 6px; font-size: 0.9em;">è´Ÿ ${opponentStats.losses}</span>
                        </div>
                    </div>
                `;
                
                // ä¿å­˜å¯¹æ‰‹ä¿¡æ¯ä¾› updateOpponentSlots ä½¿ç”¨
                window.currentOpponent = opponentTeam;
            } else {
                opponentInfoContainer.innerHTML = `
                    <div style="text-align: center; color: #94a3b8;">
                        <p>æš‚æ— å¯¹æ‰‹ä¿¡æ¯</p>
                    </div>
                `;
                window.currentOpponent = null;
            }
        }
        
        function updateOpponentSlots() {
            const opponentSlotsContainer = document.getElementById('opponent-slots');
            
            if (!window.currentOpponent) {
                opponentSlotsContainer.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">æš‚æ— å¯¹æ‰‹ä¿¡æ¯</div>';
                return;
            }
            
            const opponentAnimals = getOpponentAnimals(window.currentOpponent);
            
            if (opponentAnimals.length === 0) {
                opponentSlotsContainer.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 40px;">å¯¹æ‰‹åŠ¨ç‰©æ•°æ®åŠ è½½ä¸­...</div>';
                return;
            }
            
            // å…ƒç´ å›¾æ ‡æ˜ å°„
            const ELEMENT_ICONS = {
                'æ°´': 'ğŸ’§', 'ç«': 'ğŸ”¥', 'è‰': 'ğŸŒ¿', 'é›·': 'âš¡',
                'åœŸ': 'ğŸª¨', 'é£': 'ğŸ’¨', 'å…‰': 'âœ¨', 'æš—': 'ğŸŒ‘', 'é»˜è®¤': 'âšª'
            };
            
            // ç¨€æœ‰åº¦é¢œè‰²
            const rarityColors = {
                'æ™®é€š': '#9ca3af', 'é—ªå…‰': '#60a5fa', 'å¹»å½©': '#a78bfa', 'æ˜ŸèŠ’': '#fbbf24'
            };
            
            let html = '';
            opponentAnimals.slice(0, 5).forEach((animal, i) => {
                const elementIcon = ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤'];
                const rarityColor = rarityColors[animal.rarity] || '#ef4444';
                const colorHex = animal.color ? '#' + animal.color.toString(16).padStart(6, '0') : '#ff4444';
                
                // è·å–å¤´åƒ
                let avatarHtml;
                const avatarUrl = window.imageLibrary ? window.imageLibrary.getAnimalAvatar(animal) : null;
                
                if (avatarUrl) {
                    avatarHtml = `
                        <img src="${avatarUrl}"
                             style="width: 90px; height: 90px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto 10px; display: block; object-fit: cover; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);"
                             alt="${animal.name}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="background-color: ${colorHex}; width: 90px; height: 90px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto 10px; display: none; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);"></div>
                    `;
                } else {
                    avatarHtml = `<div style="background-color: ${colorHex}; width: 90px; height: 90px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto 10px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);"></div>`;
                }
                
                html += `
                    <div onclick="showAnimalDetailModal(${JSON.stringify(animal).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%); border: 2px solid ${rarityColor}; border-radius: 12px; padding: 12px; opacity: 0.9; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.transform='translateY(-3px)'; this.style.opacity='1'" onmouseout="this.style.transform='translateY(0)'; this.style.opacity='0.9'">
                        ${avatarHtml}
                        <div style="text-align: center;">
                            <div style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                <span style="background: #ef4444; color: white; padding: 3px 10px; border-radius: 6px; font-size: 0.85em; font-weight: bold;">Lv${animal.level || 1}</span>
                                <span style="color: #ef4444; font-size: 1em; font-weight: bold;">${animal.name}</span>
                            </div>
                            <div style="color: #cbd5e1; font-size: 0.75em; display: grid; grid-template-columns: repeat(2, 1fr); gap: 3px 6px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>â¤ï¸</span><span>${Math.round(animal.hp || 0)}</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>âš”ï¸</span><span>${Math.round(animal.attack || 0)}</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>ğŸ›¡ï¸</span><span>${Math.round(animal.defense || 0)}</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>âš¡</span><span>${Math.round(animal.agility || 0)}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // å¦‚æœå¯¹æ‰‹åŠ¨ç‰©å°‘äº5ä¸ªï¼Œå¡«å……ç©ºä½
            for (let i = opponentAnimals.length; i < 5; i++) {
                html += `
                    <div style="background: rgba(51, 65, 85, 0.3); border: 2px dashed rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px; min-height: 180px; display: flex; align-items: center; justify-content: center; opacity: 0.5;">
                        <div style="text-align: center; color: #64748b;">
                            <div style="font-size: 2em; margin-bottom: 8px;">â“</div>
                            <p style="font-size: 0.85em;">æœªçŸ¥</p>
                        </div>
                    </div>
                `;
            }
            
            opponentSlotsContainer.innerHTML = html;
        }
        
        function updateMatchInfo(league) {
            const matchInfo = document.getElementById('match-info');
            if (!league || !league.name) {
                matchInfo.innerHTML = '<p style="color: #94a3b8;">æš‚æ— æ¯”èµ›ä¿¡æ¯</p>';
                document.getElementById('skip-to-knockout-btn').style.display = 'none';
                return;
            }
            
            // æ§åˆ¶"è·³è¿‡å°ç»„èµ›"æŒ‰é’®çš„æ˜¾ç¤º
            const skipBtn = document.getElementById('skip-to-knockout-btn');
            if (league.name === 'é’å¹´è”èµ›' && league.groupStage && !league.groupStage.completed) {
                skipBtn.style.display = 'inline-block';
            } else {
                skipBtn.style.display = 'none';
            }
            
            let html = '';
            
            if (league.name === 'é’å¹´è”èµ›') {
                const currentRound = league.currentRound || 0;
                
                if (!league.groupStage || !league.groupStage.completed) {
                    // å°ç»„èµ›é˜¶æ®µ
                    html = `<p style="font-size: 1.1em; margin-bottom: 10px;">ğŸ“Š å½“å‰é˜¶æ®µï¼š<span style="color: #c4b5fd; font-weight: bold;">å°ç»„èµ› ç¬¬${currentRound}è½®</span></p>`;
                    
                    // æŸ¥æ‰¾ç©å®¶çš„å°ç»„èµ›æ¯”èµ›
                    const playerGroupMatches = league.fixtures.filter(f =>
                        f.stage === 'å°ç»„èµ›' && !f.result && (f.home.isPlayer || f.away.isPlayer)
                    ).sort((a, b) => a.round - b.round);
                    
                    if (playerGroupMatches.length > 0) {
                        const nextMatch = playerGroupMatches[0];
                        const opponentTeam = nextMatch.home.isPlayer ? nextMatch.away : nextMatch.home;
                        const opponentStats = getOpponentStats(league, opponentTeam);
                        
                        html += `
                        <div style="margin-top: 15px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%); padding: 18px; border-radius: 12px; border: 2px solid rgba(124, 58, 237, 0.3);">
                            <!-- å¯¹æ‰‹åç§° -->
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 5px;">ğŸ¯ ç¬¬${nextMatch.round}è½® ä¸‹ä¸€åœºå¯¹æ‰‹</div>
                                <div style="font-size: 1.4em; color: #fbbf24; font-weight: bold;">${opponentTeam.teamName}</div>
                            </div>
                            
                            <!-- å¯¹æ‰‹ç»Ÿè®¡ï¼ˆç½‘æ ¼å¸ƒå±€ï¼‰ -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                                <div style="background: rgba(124, 58, 237, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(124, 58, 237, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #c4b5fd;">${opponentStats.winRate}%</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">èƒœç‡</div>
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #6ee7b7;">${opponentStats.wins}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">èƒœåœº</div>
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #fca5a5;">${opponentStats.losses}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">è´Ÿåœº</div>
                                </div>
                                <div style="background: rgba(100, 116, 139, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(100, 116, 139, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #cbd5e1;">${opponentStats.played}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">è½®æ¬¡</div>
                                </div>
                            </div>
                            
                            <!-- å¯¹æ‰‹å¸¸ç”¨åŠ¨ç‰© -->
                            <div style="border-top: 1px solid rgba(148, 163, 184, 0.2); padding-top: 12px;">
                                <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 8px; text-align: center;">å¯¹æ‰‹å¸¸ç”¨åŠ¨ç‰©</div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">`;
                        
                        const opponentAnimals = getOpponentAnimals(opponentTeam);
                        opponentAnimals.slice(0, 5).forEach(animal => {
                            html += `
                                <div style="background: rgba(51, 65, 85, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 10px; text-align: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(71, 85, 105, 0.8)'; this.style.borderColor='rgba(124, 58, 237, 0.5)';" onmouseout="this.style.background='rgba(51, 65, 85, 0.6)'; this.style.borderColor='rgba(148, 163, 184, 0.3)';">
                                    <div style="color: #e0e7ff; font-size: 0.9em; font-weight: bold; margin-bottom: 4px;">${animal.name}</div>
                                    <div style="color: #fbbf24; font-size: 0.8em; font-weight: bold;">Lv${animal.level || 1}</div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        </div>`;
                    } else {
                        html += `<p style="color: #86efac; margin-top: 10px;">âœ… å°ç»„èµ›å·²å®Œæˆ</p>`;
                    }
                } else {
                    // æ·˜æ±°èµ›é˜¶æ®µ
                    const currentKnockoutMatch = league.knockoutFixtures.find(f =>
                        !f.winner && (f.team1?.isPlayer || f.team2?.isPlayer)
                    );
                    
                    if (currentKnockoutMatch) {
                        html = `<div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 5px;">ğŸ† å½“å‰é˜¶æ®µ</div>
                            <div style="font-size: 1.3em; color: #fbbf24; font-weight: bold;">${currentKnockoutMatch.stage}</div>
                        </div>`;
                        
                        const opponentTeam = currentKnockoutMatch.team1?.isPlayer ? currentKnockoutMatch.team2 : currentKnockoutMatch.team1;
                        const opponentStats = getOpponentStats(league, opponentTeam);
                        
                        html += `
                        <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%); padding: 18px; border-radius: 12px; border: 2px solid rgba(124, 58, 237, 0.3);">
                            <!-- å¯¹æ‰‹åç§° -->
                            <div style="text-align: center; margin-bottom: 15px;">
                                <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 5px;">ğŸ¯ å¯¹æ‰‹</div>
                                <div style="font-size: 1.4em; color: #e0e7ff; font-weight: bold;">${opponentTeam?.teamName || 'TBD'}</div>
                                <div style="font-size: 0.8em; color: #94a3b8; margin-top: 5px;">ï¼ˆæ¯è½®å¯¹å†³2åœºï¼Œå¹³å±€åŠ èµ›ï¼‰</div>
                            </div>
                            
                            <!-- å¯¹æ‰‹ç»Ÿè®¡ï¼ˆç½‘æ ¼å¸ƒå±€ï¼‰ -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                                <div style="background: rgba(124, 58, 237, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(124, 58, 237, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #c4b5fd;">${opponentStats.winRate}%</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">èƒœç‡</div>
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #6ee7b7;">${opponentStats.wins}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">èƒœåœº</div>
                                </div>
                                <div style="background: rgba(239, 68, 68, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #fca5a5;">${opponentStats.losses}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">è´Ÿåœº</div>
                                </div>
                                <div style="background: rgba(100, 116, 139, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(100, 116, 139, 0.4);">
                                    <div style="font-size: 1.4em; font-weight: bold; color: #cbd5e1;">${opponentStats.played}</div>
                                    <div style="font-size: 0.75em; color: #94a3b8;">è½®æ¬¡</div>
                                </div>
                            </div>`;
                        
                        // æ˜¾ç¤ºå¯¹æ‰‹çš„å¸¸ç”¨åŠ¨ç‰©
                        if (opponentTeam) {
                            html += `
                            <div style="border-top: 1px solid rgba(148, 163, 184, 0.2); padding-top: 12px;">
                                <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 8px; text-align: center;">å¯¹æ‰‹å¸¸ç”¨åŠ¨ç‰©</div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">`;
                            
                            const opponentAnimals = getOpponentAnimals(opponentTeam);
                            opponentAnimals.slice(0, 5).forEach(animal => {
                                html += `
                                    <div style="background: rgba(51, 65, 85, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 10px; text-align: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(71, 85, 105, 0.8)'; this.style.borderColor='rgba(124, 58, 237, 0.5)';" onmouseout="this.style.background='rgba(51, 65, 85, 0.6)'; this.style.borderColor='rgba(148, 163, 184, 0.3)';">
                                        <div style="color: #e0e7ff; font-size: 0.9em; font-weight: bold; margin-bottom: 4px;">${animal.name}</div>
                                        <div style="color: #fbbf24; font-size: 0.8em; font-weight: bold;">Lv${animal.level || 1}</div>
                                    </div>
                                `;
                            });
                            
                            html += `
                                </div>
                            </div>`;
                        }
                        
                        html += `</div>`;
                    } else {
                        html = `<div style="text-align: center; padding: 20px;">
                            <div style="font-size: 2em; margin-bottom: 10px;">ğŸ†</div>
                            <p style="color: #86efac; font-size: 1.2em;">âœ… èµ›äº‹å·²å®Œæˆ</p>
                        </div>`;
                    }
                }
            } else {
                // å…¶ä»–è”èµ›
                const currentRound = league.currentRound || 0;
                const totalRounds = league.fixtures ? Math.max(...league.fixtures.map(f => f.round)) : 0;
                html = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 5px;">ğŸŸï¸ å½“å‰è½®æ¬¡</div>
                    <div style="font-size: 1.3em; color: #c4b5fd; font-weight: bold;">ç¬¬${currentRound}è½® / å…±${totalRounds}è½®</div>
                </div>`;
                
                // æ˜¾ç¤ºæ¥ä¸‹æ¥çš„æ¯”èµ›
                const upcomingMatches = league.fixtures.filter(f =>
                    !f.result && (f.home.isPlayer || f.away.isPlayer)
                ).sort((a, b) => a.round - b.round);
                
                if (upcomingMatches.length > 0) {
                    const nextMatch = upcomingMatches[0];
                    const opponentTeam = nextMatch.home.isPlayer ? nextMatch.away : nextMatch.home;
                    const roundInfo = nextMatch.round > currentRound ? `ç¬¬${nextMatch.round}è½®` : '';
                    const opponentStats = getOpponentStats(league, opponentTeam);
                    
                    html += `
                    <div style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%); padding: 18px; border-radius: 12px; border: 2px solid rgba(124, 58, 237, 0.3);">
                        <!-- å¯¹æ‰‹åç§° -->
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 0.9em; color: #94a3b8; margin-bottom: 5px;">ğŸ¯ ${roundInfo} ä¸‹ä¸€åœºå¯¹æ‰‹</div>
                            <div style="font-size: 1.4em; color: #fbbf24; font-weight: bold;">${opponentTeam.teamName}</div>
                        </div>
                        
                        <!-- å¯¹æ‰‹ç»Ÿè®¡ï¼ˆç½‘æ ¼å¸ƒå±€ï¼‰ -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                            <div style="background: rgba(124, 58, 237, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(124, 58, 237, 0.4);">
                                <div style="font-size: 1.4em; font-weight: bold; color: #c4b5fd;">${opponentStats.winRate}%</div>
                                <div style="font-size: 0.75em; color: #94a3b8;">èƒœç‡</div>
                            </div>
                            <div style="background: rgba(16, 185, 129, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(16, 185, 129, 0.4);">
                                <div style="font-size: 1.4em; font-weight: bold; color: #6ee7b7;">${opponentStats.wins}</div>
                                <div style="font-size: 0.75em; color: #94a3b8;">èƒœåœº</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(239, 68, 68, 0.4);">
                                <div style="font-size: 1.4em; font-weight: bold; color: #fca5a5;">${opponentStats.losses}</div>
                                <div style="font-size: 0.75em; color: #94a3b8;">è´Ÿåœº</div>
                            </div>
                            <div style="background: rgba(100, 116, 139, 0.25); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid rgba(100, 116, 139, 0.4);">
                                <div style="font-size: 1.4em; font-weight: bold; color: #cbd5e1;">${opponentStats.played}</div>
                                <div style="font-size: 0.75em; color: #94a3b8;">è½®æ¬¡</div>
                            </div>
                        </div>
                        
                        <!-- å¯¹æ‰‹å¸¸ç”¨åŠ¨ç‰© -->
                        <div style="border-top: 1px solid rgba(148, 163, 184, 0.2); padding-top: 12px;">
                            <div style="color: #94a3b8; font-size: 0.85em; margin-bottom: 8px; text-align: center;">å¯¹æ‰‹å¸¸ç”¨åŠ¨ç‰©</div>
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">`;
                    
                    const opponentAnimals = getOpponentAnimals(opponentTeam);
                    opponentAnimals.slice(0, 5).forEach(animal => {
                        html += `
                            <div style="background: rgba(51, 65, 85, 0.6); border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 10px; text-align: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(71, 85, 105, 0.8)'; this.style.borderColor='rgba(124, 58, 237, 0.5)';" onmouseout="this.style.background='rgba(51, 65, 85, 0.6)'; this.style.borderColor='rgba(148, 163, 184, 0.3)';">
                                <div style="color: #e0e7ff; font-size: 0.9em; font-weight: bold; margin-bottom: 4px;">${animal.name}</div>
                                <div style="color: #fbbf24; font-size: 0.8em; font-weight: bold;">Lv${animal.level || 1}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    </div>`;
                }
            }
            
            matchInfo.innerHTML = html;
        }
        
        function getOpponentAnimals(opponentTeam) {
            // å¦‚æœå¯¹æ‰‹æœ‰ç™»è®°çš„åŠ¨ç‰©ï¼Œè¿”å›å‰5ä¸ª
            if (opponentTeam && opponentTeam.registeredAnimals && opponentTeam.registeredAnimals.length > 0) {
                return opponentTeam.registeredAnimals.slice(0, 5);
            }
            
            // å¦‚æœæ²¡æœ‰åŠ¨ç‰©æ•°æ®ï¼Œè¿”å›ç©ºæ•°ç»„ï¼ˆä¸æ˜¾ç¤ºï¼‰
            // é¡µé¢é‡æ–°åŠ è½½æ—¶ï¼ŒloadDataä¼šè‡ªåŠ¨ä¸ºAIé˜Ÿä¼ç”ŸæˆåŠ¨ç‰©
            return [];
        }
        
        function getOpponentStats(league, opponentTeam) {
            // ä»è”èµ›æ•°æ®ä¸­è·å–å¯¹æ‰‹çš„æˆ˜ç»©
            let played = 0, wins = 0, losses = 0;
            
            if (league.name === 'é’å¹´è”èµ›' && league.groupStage && !league.groupStage.completed) {
                // å°ç»„èµ›é˜¶æ®µï¼šç»Ÿè®¡å¯¹æ‰‹åœ¨å°ç»„å†…çš„æˆ˜ç»©
                const groupFixtures = league.fixtures.filter(f =>
                    f.result && (f.home.teamName === opponentTeam.teamName || f.away.teamName === opponentTeam.teamName)
                );
                
                groupFixtures.forEach(fixture => {
                    played++;
                    const isHome = fixture.home.teamName === opponentTeam.teamName;
                    if (isHome) {
                        if (fixture.result.homePoints === 2) wins++;
                        else if (fixture.result.homePoints === 0) losses++;
                    } else {
                        if (fixture.result.awayPoints === 2) wins++;
                        else if (fixture.result.awayPoints === 0) losses++;
                    }
                });
            } else if (league.standings) {
                // ä»ç§¯åˆ†æ¦œè·å–ç»Ÿè®¡
                const teamStanding = league.standings.find(s => s.team.teamName === opponentTeam.teamName);
                if (teamStanding) {
                    played = teamStanding.played;
                    wins = teamStanding.won;
                    losses = teamStanding.lost;
                }
            }
            
            const winRate = played > 0 ? ((wins / played) * 100).toFixed(0) : 0;
            
            return { played, wins, losses, winRate };
        }
        
        
        function updatePlayerInfo() {
            const playerTeam = leagueSystem.getPlayerTeam();
            if (!playerTeam || !playerTeam.region) return;
            
            // å‚èµ›ä¿¡æ¯
            document.getElementById('info-team-name').textContent = playerTeam.teamName || '---';
            document.getElementById('info-region').textContent = playerTeam.region || '---';
            document.getElementById('info-league').textContent = playerTeam.league || '---';
            document.getElementById('info-season').textContent = `ç¬¬${leagueSystem.currentSeason}èµ›å­£`;
            
            // è®¡ç®—æœ€é«˜æˆå°±
            let highestAchievement = 'é’å¹´è”èµ›';
            if (playerTeam.careerHistory && playerTeam.careerHistory.length > 0) {
                const leagues = ['è¶…çº§è”èµ›', 'å† å†›è”èµ›', 'ç”²çº§è”èµ›', 'é’å¹´è”èµ›'];
                for (const league of leagues) {
                    if (playerTeam.careerHistory.some(h => h.league === league)) {
                        highestAchievement = league;
                        break;
                    }
                }
            }
            document.getElementById('info-achievement').textContent = highestAchievement;
            document.getElementById('info-seasons-played').textContent = `${playerTeam.careerHistory ? playerTeam.careerHistory.length : 0}æ¬¡`;
            
            // æˆ˜æ–—ä¿¡æ¯
            const stats = playerTeam.battleStats || { totalMatches: 0, wins: 0, losses: 0, opponentsDefeated: 0, timesDefeated: 0 };
            document.getElementById('info-total-matches').textContent = stats.totalMatches;
            document.getElementById('info-wins').textContent = stats.wins;
            document.getElementById('info-losses').textContent = stats.losses;
            document.getElementById('info-defeated').textContent = `${stats.opponentsDefeated}æ¬¡`;
            document.getElementById('info-defeated-by').textContent = `${stats.timesDefeated}æ¬¡`;
            
            const winRate = stats.totalMatches > 0 ? ((stats.wins / stats.totalMatches) * 100).toFixed(1) : 0;
            document.getElementById('info-win-rate').textContent = `${winRate}%`;
        }
        
        function updateTeamSlots() {
            const playerTeam = leagueSystem.getPlayerTeam();
            const slotsContainer = document.getElementById('team-slots');
            
            if (!playerTeam || !playerTeam.league) {
                slotsContainer.innerHTML = '';
                return;
            }
            
            // å…ƒç´ å›¾æ ‡æ˜ å°„
            const ELEMENT_ICONS = {
                'æ°´': 'ğŸ’§',
                'ç«': 'ğŸ”¥',
                'è‰': 'ğŸŒ¿',
                'é›·': 'âš¡',
                'åœŸ': 'ğŸª¨',
                'é£': 'ğŸ’¨',
                'å…‰': 'âœ¨',
                'æš—': 'ğŸŒ‘',
                'é»˜è®¤': 'âšª'
            };
            
            // ç¨€æœ‰åº¦é¢œè‰²
            const rarityColors = {
                'æ™®é€š': '#9ca3af',
                'é—ªå…‰': '#60a5fa',
                'å¹»å½©': '#a78bfa',
                'æ˜ŸèŠ’': '#fbbf24'
            };
            
            const isYouthLeague = playerTeam.league === 'é’å¹´è”èµ›';
            const slotCount = isYouthLeague ? 5 : 25;
            
            let html = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨åŠ¨ç‰©
            if (playerAnimals.length === 0) {
                html = `
                    <div style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%); border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 12px; padding: 40px; text-align: center;">
                        <div style="font-size: 3em; margin-bottom: 15px;">âš ï¸</div>
                        <h3 style="color: #fca5a5; font-size: 1.3em; margin-bottom: 10px;">æ²¡æœ‰å¯ç”¨çš„åŠ¨ç‰©</h3>
                        <p style="color: #cbd5e1; margin-bottom: 20px;">è¯·å…ˆåœ¨ä¸»åœºæ™¯ä¸­æ•è·æˆ–ç¹æ®–ä¸€äº›åŠ¨ç‰©</p>
                        <button class="btn btn-primary" onclick="window.location.href='game3d.html'">å‰å¾€ä¸»åœºæ™¯</button>
                    </div>
                `;
                slotsContainer.innerHTML = html;
                return;
            }
            
            for (let i = 0; i < slotCount; i++) {
                const animal = isYouthLeague ? window.selectedBattleAnimals?.[i] : playerTeam.registeredAnimals?.[i];
                
                if (animal) {
                    const elementIcon = ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤'];
                    const rarityColor = rarityColors[animal.rarity] || rarityColors['æ™®é€š'];
                    const colorHex = animal.color ? '#' + animal.color.toString(16).padStart(6, '0') : '#888888';
                    
                    // è·å–å¤´åƒURLï¼ˆä¼˜å…ˆæœ¬åœ°æ–‡ä»¶ â†’ localStorage â†’ é¢œè‰²çƒï¼‰
                    let avatarHtml;
                    const avatarUrl = window.imageLibrary ? window.imageLibrary.getAnimalAvatar(animal) : null;
                    
                    if (avatarUrl) {
                        avatarHtml = `
                            <img src="${avatarUrl}"
                                 style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto 12px; display: block; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"
                                 alt="${animal.name}"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="background-color: ${colorHex}; width: 100px; height: 100px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto 12px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>
                        `;
                    } else {
                        avatarHtml = `<div style="background-color: ${colorHex}; width: 100px; height: 100px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>`;
                    }
                    
                    html += `
                        <div onclick="event.target.tagName !== 'BUTTON' && showAnimalDetailModal(${JSON.stringify(animal).replace(/"/g, '&quot;')})" class="animal-card" style="position: relative; border-color: ${rarityColor}; padding: 12px; cursor: pointer;">
                            ${avatarHtml}
                            <div style="text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                    <span style="background: #fbbf24; color: #1f2937; padding: 3px 10px; border-radius: 6px; font-size: 0.85em; font-weight: bold;">Lv${animal.level || 1}</span>
                                    <span style="color: #fbbf24; font-size: 1em; font-weight: bold;">${animal.name}</span>
                                </div>
                                <div style="color: #cbd5e1; font-size: 0.75em; display: grid; grid-template-columns: repeat(2, 1fr); gap: 3px 6px;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>â¤ï¸</span><span>${Math.round(animal.hp || 0)}</span></div>
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>âš”ï¸</span><span>${Math.round(animal.attack || 0)}</span></div>
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>ğŸ›¡ï¸</span><span>${Math.round(animal.defense || 0)}</span></div>
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>âš¡</span><span>${Math.round(animal.agility || 0)}</span></div>
                                </div>
                            </div>
                            ${isYouthLeague ? `<button onclick="removeAnimalFromSlot(${i}); event.stopPropagation();" style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.4); font-weight: bold;">Ã—</button>` : ''}
                        </div>
                    `;
                } else {
                    html += `
                        <div onclick="${isYouthLeague ? `openAnimalSelector(${i})` : ''}" style="background: rgba(51, 65, 85, 0.3); border: 2px dashed rgba(148, 163, 184, 0.5); border-radius: 12px; padding: 20px; min-height: 200px; display: flex; align-items: center; justify-content: center; ${isYouthLeague ? 'cursor: pointer;' : ''} transition: all 0.3s;">
                            <div style="text-align: center; color: #64748b;">
                                <div style="font-size: 2.5em; margin-bottom: 10px;">â•</div>
                                <p style="font-size: 0.95em;">${isYouthLeague ? 'ç‚¹å‡»é€‰æ‹©åŠ¨ç‰©' : 'ç©ºä½'}</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            slotsContainer.innerHTML = html;
        }
        
        // åˆå§‹åŒ–é€‰ä¸­çš„æˆ˜æ–—åŠ¨ç‰©æ•°ç»„
        window.selectedBattleAnimals = window.selectedBattleAnimals || [];
        
        function openAnimalSelector(slotIndex) {
            // æ£€æŸ¥æ˜¯å¦æœ‰åŠ¨ç‰©
            if (playerAnimals.length === 0) {
                alert('âš ï¸ æ‚¨è¿˜æ²¡æœ‰ä»»ä½•åŠ¨ç‰©ï¼\nè¯·å…ˆåœ¨ä¸»åœºæ™¯ä¸­æ•è·æˆ–ç¹æ®–åŠ¨ç‰©ã€‚');
                return;
            }
            
            // æ‰“å¼€åŠ¨ç‰©é€‰æ‹©ç•Œé¢
            const availableAnimals = playerAnimals.filter(a =>
                !window.selectedBattleAnimals.some(selected => selected && selected.id === a.id)
            );
            
            if (availableAnimals.length === 0) {
                alert('æ²¡æœ‰å¯ç”¨çš„åŠ¨ç‰©äº†ï¼æ‰€æœ‰åŠ¨ç‰©éƒ½å·²è¢«é€‰æ‹©ã€‚');
                return;
            }
            
            // å…ƒç´ å›¾æ ‡æ˜ å°„
            const ELEMENT_ICONS = {
                'æ°´': 'ğŸ’§',
                'ç«': 'ğŸ”¥',
                'è‰': 'ğŸŒ¿',
                'é›·': 'âš¡',
                'åœŸ': 'ğŸª¨',
                'é£': 'ğŸ’¨',
                'å…‰': 'âœ¨',
                'æš—': 'ğŸŒ‘',
                'é»˜è®¤': 'âšª'
            };
            
            // ç®€å•çš„é€‰æ‹©ç•Œé¢
            let html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="closeAnimalSelector()">';
            html += '<div onclick="event.stopPropagation()" style="background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%); border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 20px; padding: 30px; max-width: 1100px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.6);">';
            html += '<h3 style="color: #c4b5fd; margin-bottom: 25px; font-size: 1.6em; text-align: center;">é€‰æ‹©å‚æˆ˜åŠ¨ç‰©</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">';
            
            availableAnimals.forEach(animal => {
                // ç¨€æœ‰åº¦é¢œè‰²
                const rarityColors = {
                    'æ™®é€š': '#9ca3af',
                    'é—ªå…‰': '#60a5fa',
                    'å¹»å½©': '#a78bfa',
                    'æ˜ŸèŠ’': '#fbbf24'
                };
                const rarityColor = rarityColors[animal.rarity] || '#9ca3af';
                const elementIcon = ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤'];
                const colorHex = animal.color ? '#' + animal.color.toString(16).padStart(6, '0') : '#888888';
                
                // è·å–å¤´åƒURL
                let avatarHtml;
                const avatarUrl = window.imageLibrary ? window.imageLibrary.getAnimalAvatar(animal) : null;
                
                if (avatarUrl) {
                    avatarHtml = `
                        <img src="${avatarUrl}"
                             style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid ${rarityColor}; margin: 0 auto 15px; display: block; object-fit: cover; box-shadow: 0 6px 20px rgba(0,0,0,0.5);"
                             alt="${animal.name}"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="background-color: ${colorHex}; width: 120px; height: 120px; border-radius: 50%; border: 4px solid ${rarityColor}; margin: 0 auto 15px; display: none; box-shadow: 0 6px 20px rgba(0,0,0,0.5);"></div>
                    `;
                } else {
                    avatarHtml = `<div style="background-color: ${colorHex}; width: 120px; height: 120px; border-radius: 50%; border: 4px solid ${rarityColor}; margin: 0 auto 15px; box-shadow: 0 6px 20px rgba(0,0,0,0.5);"></div>`;
                }
                
                html += `
                    <div onclick="selectAnimalForSlot(${slotIndex}, '${animal.id}')" class="animal-card" style="cursor: pointer; border-color: ${rarityColor}; padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.4);">
                        ${avatarHtml}
                        <div style="text-align: center;">
                            <div style="display: flex; gap: 6px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                                <span style="background: #fbbf24; color: #1f2937; padding: 3px 10px; border-radius: 6px; font-size: 0.85em; font-weight: bold;">Lv${animal.level}</span>
                                <span style="color: #fbbf24; font-size: 1em; font-weight: bold;">${animal.name}</span>
                            </div>
                            <div style="color: #cbd5e1; font-size: 0.75em; display: grid; grid-template-columns: repeat(2, 1fr); gap: 3px 6px;">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>â¤ï¸</span><span>${Math.round(animal.hp)}</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>âš”ï¸</span><span>${Math.round(animal.attack)}</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>ğŸ›¡ï¸</span><span>${Math.round(animal.defense)}</span></div>
                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;"><span>âš¡</span><span>${Math.round(animal.agility)}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div style="text-align: center; margin-top: 20px;"><button class="btn btn-secondary" onclick="closeAnimalSelector()">å…³é—­</button></div>';
            html += '</div></div>';
            
            const selector = document.createElement('div');
            selector.id = 'animal-selector';
            selector.innerHTML = html;
            document.body.appendChild(selector);
        }
        
        function selectAnimalForSlot(slotIndex, animalId) {
            const animal = playerAnimals.find(a => a.id === animalId);
            if (animal) {
                window.selectedBattleAnimals[slotIndex] = animal;
                updateTeamSlots();
                closeAnimalSelector();
            }
        }
        
        function removeAnimalFromSlot(slotIndex) {
            window.selectedBattleAnimals[slotIndex] = null;
            updateTeamSlots();
        }
        
        function closeAnimalSelector() {
            const selector = document.getElementById('animal-selector');
            if (selector) {
                selector.remove();
            }
        }
        
        function showAnimalDetailModal(animal) {
            const modal = document.getElementById('animal-detail-modal');
            const content = document.getElementById('animal-detail-content-modal');
            
            if (!animal) return;
            
            // å…ƒç´ å›¾æ ‡æ˜ å°„
            const ELEMENT_ICONS = {
                'æ°´': 'ğŸ’§', 'ç«': 'ğŸ”¥', 'è‰': 'ğŸŒ¿', 'é›·': 'âš¡',
                'åœŸ': 'ğŸª¨', 'é£': 'ğŸ’¨', 'å…‰': 'âœ¨', 'æš—': 'ğŸŒ‘', 'é»˜è®¤': 'âšª'
            };
            
            const elementIcon = ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤'];
            const colorHex = animal.color ? '#' + animal.color.toString(16).padStart(6, '0') : '#888888';
            const rarityColors = {
                'æ™®é€š': '#9ca3af', 'é—ªå…‰': '#60a5fa', 'å¹»å½©': '#a78bfa', 'æ˜ŸèŠ’': '#fbbf24'
            };
            const rarityColor = rarityColors[animal.rarity] || '#9ca3af';
            
            // è·å–å¤´åƒ
            let avatarHtml;
            const avatarUrl = window.imageLibrary ? window.imageLibrary.getAnimalAvatar(animal) : null;
            
            if (avatarUrl) {
                avatarHtml = `
                    <img src="${avatarUrl}"
                         style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto; display: block; object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.5);"
                         alt="${animal.name}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="background-color: ${colorHex}; width: 120px; height: 120px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5);"></div>
                `;
            } else {
                avatarHtml = `<div style="background-color: ${colorHex}; width: 120px; height: 120px; border-radius: 50%; border: 3px solid ${rarityColor}; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5);"></div>`;
            }
            
            let html = `
                ${avatarHtml}
                <div style="text-align: center; margin: 15px 0;">
                    <div style="display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap; margin-bottom: 8px;">
                        <span style="background: #fbbf24; color: #1f2937; padding: 4px 12px; border-radius: 6px; font-size: 1em; font-weight: bold;">Lv ${animal.level}</span>
                        <span style="color: #fbbf24; font-size: 1.3em; font-weight: bold;">${animal.name}</span>
                        ${animal.rarity && animal.rarity !== 'æ™®é€š' ? `<span style="background: ${rarityColor}; color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.9em; font-weight: bold;">${animal.rarity}</span>` : ''}
                        ${animal.gender ? `<span style="color: ${animal.gender === 'é›„' ? '#60a5fa' : '#f9a8d4'}; font-size: 1.3em;">${animal.gender === 'é›„' ? 'â™‚' : 'â™€'}</span>` : ''}
                    </div>
                </div>
                
                <!-- æˆ˜æ–—å±æ€§å’ŒæŠ€èƒ½å¹¶åˆ— -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <!-- å·¦ä¾§ï¼šæˆ˜æ–—å±æ€§ -->
                    <div style="background: rgba(30, 41, 59, 0.6); border-radius: 10px; padding: 12px;">
                        <h5 style="color: #ef4444; font-size: 0.9em; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 6px;">âš”ï¸ æˆ˜æ–—å±æ€§</h5>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="background: rgba(220, 38, 38, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="font-size: 0.8em; color: #94a3b8;">â¤ï¸ HP</div>
                                <div style="font-size: 1.1em; font-weight: bold; color: #fca5a5;">${Math.round(animal.hp)}</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="font-size: 0.8em; color: #94a3b8;">âš”ï¸ æ”»å‡»</div>
                                <div style="font-size: 1.1em; font-weight: bold; color: #fca5a5;">${Math.round(animal.attack)}</div>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="font-size: 0.8em; color: #94a3b8;">ğŸ›¡ï¸ é˜²å¾¡</div>
                                <div style="font-size: 1.1em; font-weight: bold; color: #93c5fd;">${Math.round(animal.defense)}</div>
                            </div>
                            <div style="background: rgba(251, 191, 36, 0.15); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 6px; padding: 8px; display: flex; align-items: center; justify-content: space-between;">
                                <div style="font-size: 0.8em; color: #94a3b8;">âš¡ æ•æ·</div>
                                <div style="font-size: 1.1em; font-weight: bold; color: #fcd34d;">${Math.round(animal.agility)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šè£…å¤‡æŠ€èƒ½ -->
                    <div style="background: rgba(30, 41, 59, 0.6); border-radius: 10px; padding: 12px;">
                        <h5 style="color: #a78bfa; font-size: 0.9em; margin-bottom: 10px; text-align: center; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 6px;">ğŸ¯ è£…å¤‡æŠ€èƒ½</h5>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
            `;
            
            // è·å–å®Œæ•´åŠ¨ç‰©æ•°æ®å¹¶æ˜¾ç¤ºè£…å¤‡çš„æŠ€èƒ½
            const fullAnimal = animal.originalAnimal || animal;
            const skillLibrary = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            const equippedSkills = fullAnimal.combatSkills?.equipped || [];
            
            for (let i = 0; i < 4; i++) {
                const skillKey = equippedSkills[i];
                if (skillKey) {
                    const skill = skillLibrary.find(s => s.key === skillKey);
                    if (skill) {
                        html += `
                            <div style="background: rgba(124, 58, 237, 0.2); border: 1px solid rgba(124, 58, 237, 0.4); border-radius: 6px; padding: 8px; text-align: center;">
                                <div style="font-size: 1.5em; margin-bottom: 3px;">${skill.icon || 'ğŸ”¹'}</div>
                                <div style="font-size: 0.8em; font-weight: bold; color: #c4b5fd; margin-bottom: 2px; line-height: 1.2;">${skill.name}</div>
                                <div style="font-size: 0.65em; color: #94a3b8;">CD:${skill.params?.cooldown || 0}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="background: rgba(51, 65, 85, 0.4); border: 1px solid rgba(100, 116, 139, 0.3); border-radius: 6px; padding: 8px; text-align: center; min-height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <div style="font-size: 1.2em; color: #64748b; margin-bottom: 2px;">â“</div>
                                <div style="font-size: 0.7em; color: #64748b;">æœªçŸ¥</div>
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div style="background: rgba(51, 65, 85, 0.3); border: 1px dashed rgba(100, 116, 139, 0.3); border-radius: 6px; padding: 8px; text-align: center; min-height: 70px; display: flex; align-items: center; justify-content: center;">
                            <div style="font-size: 0.7em; color: #64748b;">ç©ºæ§½ä½</div>
                        </div>
                    `;
                }
            }
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            modal.style.display = 'flex';
        }
        
        function closeAnimalDetailModal() {
            const modal = document.getElementById('animal-detail-modal');
            modal.style.display = 'none';
        }
        
        // ä¿å­˜åˆ°windowä»¥ä¾¿åœ¨onclickä¸­è°ƒç”¨
        window.showAnimalDetailModal = showAnimalDetailModal;
        window.closeAnimalDetailModal = closeAnimalDetailModal;

        function displayTournamentBracket(container, league) {
            console.log('displayTournamentBracket è°ƒç”¨', {
                hasLeague: !!league,
                leagueName: league?.name,
                hasGroupStage: !!league?.groupStage,
                groupStageKeys: league?.groupStage ? Object.keys(league.groupStage) : [],
                teamsCount: league?.teams?.length
            });
            
            if (!league || !league.groupStage) {
                container.innerHTML = '<div class="empty-state"><p>æ­£åœ¨åŠ è½½è”èµ›æ•°æ®...ï¼ˆleague.groupStageæœªåˆå§‹åŒ–ï¼‰</p></div>';
                return;
            }
            
            if (!league.groupStage.completed) {
                displayGroupStage(container, league);
            } else {
                displayKnockoutBracket(container, league);
            }
        }
        
        function displayGroupStage(container, league) {
            let playerGroupIndex = -1;
            if (league.groupStage && league.groupStage.groups) {
                league.groupStage.groups.forEach((group, index) => {
                    if (group.some(t => t.isPlayer)) {
                        playerGroupIndex = index;
                    }
                });
            }
            
            // åˆå§‹åŒ–æ˜¾ç¤ºç©å®¶æ‰€åœ¨ç»„
            if (window.currentDisplayGroup === undefined && playerGroupIndex >= 0) {
                window.currentDisplayGroup = playerGroupIndex;
            }
            
            const currentGroup = window.currentDisplayGroup >= 0 ? window.currentDisplayGroup : 0;
            
            let html = `
                <div style="max-width: 1400px; margin: 0 auto 30px;">
                    <h4 style="color: #a78bfa; margin-bottom: 20px; text-align: center;">é€‰æ‹©å°ç»„æŸ¥çœ‹ï¼š</h4>
                    
                    <!-- ç¬¬ä¸€è¡Œï¼š1-8ç»„ -->
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 12px;">
            `;
            
            // ç”Ÿæˆç¬¬ä¸€è¡Œï¼ˆ1-8ç»„ï¼‰
            for (let i = 0; i < 8; i++) {
                const isPlayerGroup = i === playerGroupIndex;
                const isCurrentGroup = i === currentGroup;
                let btnStyle = 'padding: 12px 20px; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: bold; border: none; min-width: 100px;';
                
                if (isCurrentGroup) {
                    btnStyle += ' background: linear-gradient(135deg, #7c3aed, #db2777); color: white; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.5);';
                } else if (isPlayerGroup) {
                    btnStyle += ' background: rgba(251, 191, 36, 0.3); border: 2px solid #fbbf24; color: #fbbf24;';
                } else {
                    btnStyle += ' background: rgba(51, 65, 85, 0.6); color: #cbd5e1;';
                }
                
                html += `
                    <button onclick="switchToGroup(${i})" style="${btnStyle}">
                        ${isPlayerGroup ? 'â­ ' : ''}ç¬¬${i + 1}ç»„
                    </button>
                `;
            }
            
            html += `
                    </div>
                    
                    <!-- ç¬¬äºŒè¡Œï¼š9-16ç»„ -->
                    <div style="display: flex; gap: 10px; justify-content: center;">
            `;
            
            // ç”Ÿæˆç¬¬äºŒè¡Œï¼ˆ9-16ç»„ï¼‰
            for (let i = 8; i < 16; i++) {
                const isPlayerGroup = i === playerGroupIndex;
                const isCurrentGroup = i === currentGroup;
                let btnStyle = 'padding: 12px 20px; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: bold; border: none; min-width: 100px;';
                
                if (isCurrentGroup) {
                    btnStyle += ' background: linear-gradient(135deg, #7c3aed, #db2777); color: white; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.5);';
                } else if (isPlayerGroup) {
                    btnStyle += ' background: rgba(251, 191, 36, 0.3); border: 2px solid #fbbf24; color: #fbbf24;';
                } else {
                    btnStyle += ' background: rgba(51, 65, 85, 0.6); color: #cbd5e1;';
                }
                
                html += `
                    <button onclick="switchToGroup(${i})" style="${btnStyle}">
                        ${isPlayerGroup ? 'â­ ' : ''}ç¬¬${i + 1}ç»„
                    </button>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            if (currentGroup >= 0 && currentGroup < 16) {
                const groupStanding = calculateGroupStanding(league, currentGroup);
                const isPlayerGroup = currentGroup === playerGroupIndex;
                
                html += `
                    <div style="max-width: 1000px; margin: 0 auto;">
                        <h3 style="color: ${isPlayerGroup ? '#fbbf24' : '#a78bfa'}; margin-bottom: 25px; font-size: 1.6em; text-align: center;">
                            ${isPlayerGroup ? 'â­ ä½ çš„å°ç»„ï¼š' : ''}ç¬¬${currentGroup + 1}ç»„
                        </h3>
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">æ’å</th>
                                    <th>é˜Ÿä¼</th>
                                    <th style="width: 100px;">è½®æ¬¡</th>
                                    <th style="width: 100px;">èƒœ</th>
                                    <th style="width: 100px;">è´Ÿ</th>
                                    <th style="width: 100px;">ç§¯åˆ†</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                groupStanding.forEach((team, index) => {
                    const isQualified = index < 2;
                    const isPlayer = team.team.isPlayer;
                    
                    let rowStyle = '';
                    let borderLeft = '';
                    
                    if (isPlayer) {
                        rowStyle = 'background: linear-gradient(90deg, rgba(139, 92, 246, 0.15) 0%, rgba(124, 58, 237, 0.1) 100%);';
                        borderLeft = 'border-left: 4px solid #8b5cf6;';
                    } else if (isQualified) {
                        borderLeft = 'border-left: 4px solid #34d399;';
                    }
                    
                    html += `
                        <tr style="${rowStyle} ${borderLeft}">
                            <td style="font-weight: bold; font-size: 1.3em; color: #c4b5fd;">${index + 1}</td>
                            <td style="text-align: left; font-weight: ${isPlayer ? 'bold' : '600'}; color: ${isPlayer ? '#c4b5fd' : '#e0e7ff'};">
                                ${isPlayer ? 'â­ ' : ''}${team.team.teamName}
                            </td>
                            <td style="color: #cbd5e1;">${team.played}</td>
                            <td style="color: #6ee7b7; font-weight: 600;">${team.won}</td>
                            <td style="color: #fca5a5; font-weight: 600;">${team.lost}</td>
                            <td style="font-weight: bold; font-size: 1.3em; color: #c4b5fd;">${team.points}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                        <div class="info-box" style="margin-top: 25px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); border-color: rgba(139, 92, 246, 0.3);">
                            <p style="color: #e0e7ff;">ğŸŸ© ç»¿è‰²æ ‡è®°ï¼šæ™‹çº§æ·˜æ±°èµ›ï¼ˆå‰2åï¼‰ | â­ ç´«è‰²é«˜äº®ï¼šä½ çš„é˜Ÿä¼</p>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function calculateGroupStanding(league, groupIndex) {
            if (!league.groupStage || !league.groupStage.groups || !league.groupStage.groups[groupIndex]) {
                console.error('å°ç»„æ•°æ®ä¸å­˜åœ¨:', { groupIndex, hasGroupStage: !!league.groupStage });
                return [];
            }
            
            const groupTeams = league.groupStage.groups[groupIndex];
            console.log(`è®¡ç®—ç¬¬${groupIndex + 1}ç»„ç§¯åˆ†æ¦œ - é˜Ÿä¼æ•°: ${groupTeams.length}`);
            
            const standings = {};
            
            groupTeams.forEach(team => {
                standings[team.teamName] = {
                    team: team,
                    played: 0,      // å·²æ‰“è½®æ¬¡
                    won: 0,         // èµ¢çš„è½®æ¬¡
                    drawn: 0,       // å¹³å±€è½®æ¬¡
                    lost: 0,        // è¾“çš„è½®æ¬¡
                    points: 0,      // ç§¯åˆ†ï¼ˆæŒ‰è½®æ¬¡èƒœè´Ÿè®¡ç®—ï¼‰
                    goalsFor: 0,    // èµ¢å¾—çš„å°å±€æ•°
                    goalsAgainst: 0,
                    goalDifference: 0
                };
            });
            
            // æŒ‰è½®æ¬¡åˆ†ç»„
            const groupFixtures = league.fixtures.filter(f => f.groupIndex === groupIndex && f.result);
            const roundResults = {};
            groupFixtures.forEach(fixture => {
                const round = fixture.round;
                if (!roundResults[round]) {
                    roundResults[round] = [];
                }
                roundResults[round].push(fixture);
            });
            
            console.log(`ç¬¬${groupIndex + 1}ç»„ - è½®æ¬¡åˆ†ç»„:`, Object.keys(roundResults).map(r => `ç¬¬${r}è½®: ${roundResults[r].length}åœº`));
            
            // æŒ‰è½®æ¬¡ç»Ÿè®¡
            Object.keys(roundResults).forEach(round => {
                const roundMatches = roundResults[round];
                const roundStats = {};
                
                // åˆå§‹åŒ–è¯¥è½®ç»Ÿè®¡
                groupTeams.forEach(team => {
                    roundStats[team.teamName] = {
                        matchWins: 0,      // è¯¥è½®èµ¢çš„åœºæ¬¡
                        matchLosses: 0,    // è¯¥è½®è¾“çš„åœºæ¬¡
                        goalsFor: 0,
                        goalsAgainst: 0
                    };
                });
                
                // ç»Ÿè®¡è¯¥è½®æ¯åœºæ¯”èµ›
                roundMatches.forEach(fixture => {
                    const homeTeam = fixture.home.teamName;
                    const awayTeam = fixture.away.teamName;
                    const result = fixture.result;
                    
                    roundStats[homeTeam].goalsFor += result.homeWins;
                    roundStats[homeTeam].goalsAgainst += result.awayWins;
                    roundStats[awayTeam].goalsFor += result.awayWins;
                    roundStats[awayTeam].goalsAgainst += result.homeWins;
                    
                    // åˆ¤æ–­è¯¥åœºæ¯”èµ›èƒœè´Ÿ
                    if (result.homePoints === 3) {
                        roundStats[homeTeam].matchWins++;
                        roundStats[awayTeam].matchLosses++;
                    } else if (result.awayPoints === 3) {
                        roundStats[awayTeam].matchWins++;
                        roundStats[homeTeam].matchLosses++;
                    }
                });
                
                // åˆ¤æ–­è¯¥è½®èƒœè´Ÿå¹¶æ›´æ–°ç§¯åˆ†
                Object.keys(roundStats).forEach(teamName => {
                    const stat = roundStats[teamName];
                    
                    if (stat.matchWins + stat.matchLosses > 0) {
                        standings[teamName].played++;  // è½®æ¬¡+1
                        standings[teamName].goalsFor += stat.goalsFor;
                        standings[teamName].goalsAgainst += stat.goalsAgainst;
                        
                        // è¯¥è½®èƒœè´Ÿåˆ¤å®šï¼šèµ¢çš„åœºæ¬¡å¤š=è¯¥è½®è·èƒœ
                        if (stat.matchWins > stat.matchLosses) {
                            standings[teamName].won++;      // èµ¢çš„è½®æ¬¡+1
                            standings[teamName].points += 3;
                            console.log(`  ç¬¬${round}è½® ${teamName}: èµ¢${stat.matchWins}åœº è¾“${stat.matchLosses}åœº â†’ è¯¥è½®è·èƒœ +3åˆ†`);
                        } else if (stat.matchLosses > stat.matchWins) {
                            standings[teamName].lost++;     // è¾“çš„è½®æ¬¡+1
                            standings[teamName].points += 0;
                            console.log(`  ç¬¬${round}è½® ${teamName}: èµ¢${stat.matchWins}åœº è¾“${stat.matchLosses}åœº â†’ è¯¥è½®å¤±è´¥ +0åˆ†`);
                        } else {
                            standings[teamName].drawn++;    // å¹³å±€è½®æ¬¡+1
                            standings[teamName].points += 1;
                            console.log(`  ç¬¬${round}è½® ${teamName}: èµ¢${stat.matchWins}åœº è¾“${stat.matchLosses}åœº â†’ è¯¥è½®å¹³å±€ +1åˆ†`);
                        }
                    }
                });
            });
            
            return Object.values(standings).map(team => {
                team.goalDifference = team.goalsFor - team.goalsAgainst;
                return team;
            }).sort((a, b) => {
                if (b.points !== a.points) return b.points - a.points;
                if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
                return b.goalsFor - a.goalsFor;
            });
        }
        
        function displayKnockoutBracket(container, league) {
            const stages = ['32è¿›16', '16è¿›8', '8è¿›4', 'åŠå†³èµ›'];
            const roundsByStage = {};
            
            stages.forEach(stage => {
                roundsByStage[stage] = (league.knockoutFixtures || []).filter(f => f.stage === stage);
            });
            
            const finalMatch = (league.knockoutFixtures || []).find(f => f.stage === 'å†³èµ›');
            const activeStages = stages.filter(stage => roundsByStage[stage].length > 0);
            
            // å°†æ¯ä¸ªé˜¶æ®µçš„æ¯”èµ›åˆ†ä¸ºä¸Šä¸‹åŠåŒº
            const getBracketHalves = (matches) => {
                const half = Math.ceil(matches.length / 2);
                return {
                    upper: matches.slice(0, half),
                    lower: matches.slice(half)
                };
            };
            
            let html = `
                <div class="info-box success" style="max-width: 100%; margin: 0 auto 30px;">
                    <h3>ğŸ† æ·˜æ±°èµ›é˜¶æ®µ</h3>
                    <p style="font-size: 1.1em;">32æ”¯é˜Ÿä¼è¿›å…¥æ·˜æ±°èµ›ï¼ˆ16ç»„å„å‰2åï¼‰ | æ¯è½®å¯¹å†³2åœºï¼ˆå¹³å±€åˆ™3åœºï¼‰ | å‰4åæ™‹çº§ç”²çº§è”èµ›</p>
                </div>
                <div class="tournament-bracket">
            `;
            
            // å·¦åŠåŒºï¼ˆä¸ŠåŠåŒºï¼šä»32è¿›16åˆ°åŠå†³èµ›ï¼‰
            activeStages.forEach((stage, stageIdx) => {
                const matches = roundsByStage[stage];
                const halves = getBracketHalves(matches);
                const roundClass = `bracket-round-r${stageIdx + 1}`;
                
                html += `<div class="bracket-round ${roundClass}">`;
                html += `<div class="bracket-round-title">${stage}<br><span style="font-size:0.75em;opacity:0.7;">ä¸ŠåŠåŒº</span></div>`;
                
                // æ˜¾ç¤ºä¸ŠåŠåŒºï¼Œæ¯ä¸¤ä¸ªæ ¼å­é…å¯¹
                halves.upper.forEach((match, matchIdx) => {
                    const isPairTop = matchIdx % 2 === 0;
                    const pairClass = isPairTop ? 'pair-top' : 'pair-bottom';
                    html += renderMatch(match, false, pairClass);
                });
                
                html += `</div>`;
            });
            
            // ä¸­é—´ï¼šå†³èµ›
            if (finalMatch) {
                html += `<div class="bracket-round" style="justify-content: center;">`;
                html += `<div class="bracket-round-title" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); font-size: 1.1em; padding: 12px;">ğŸ† å†³èµ› ğŸ†</div>`;
                html += renderMatch(finalMatch, true, 'no-line');
                html += `</div>`;
            }
            
            // å³åŠåŒºï¼ˆä¸‹åŠåŒºï¼šä»åŠå†³èµ›åˆ°32è¿›16ï¼Œé¡ºåºç›¸åï¼‰
            const reversedStages = [...activeStages].reverse();
            reversedStages.forEach((stage, stageIdx) => {
                const matches = roundsByStage[stage];
                const halves = getBracketHalves(matches);
                const roundClass = `bracket-round-r${activeStages.length - stageIdx}`;
                
                html += `<div class="bracket-round right-bracket ${roundClass}">`;
                html += `<div class="bracket-round-title">${stage}<br><span style="font-size:0.75em;opacity:0.7;">ä¸‹åŠåŒº</span></div>`;
                
                // æ˜¾ç¤ºä¸‹åŠåŒºï¼Œæ¯ä¸¤ä¸ªæ ¼å­é…å¯¹
                halves.lower.forEach((match, matchIdx) => {
                    const isPairTop = matchIdx % 2 === 0;
                    const pairClass = isPairTop ? 'pair-top' : 'pair-bottom';
                    html += renderMatch(match, false, pairClass);
                });
                
                html += `</div>`;
            });
            
            html += `</div>`;
            container.innerHTML = html;
        }
        
        function renderMatch(match, isFinal = false, connectClass = '') {
            const isPlayerMatch = match.team1?.isPlayer || match.team2?.isPlayer;
            const hasResult = match.winner !== null;
            const hasMatches = match.matches && match.matches.length > 0;
            const team1Wins = match.matches?.filter(m => m.winner === match.team1).length || 0;
            const team2Wins = match.matches?.filter(m => m.winner === match.team2).length || 0;
            
            const matchClass = isFinal ? 'final' : '';
            
            // æ˜¾ç¤ºæ¯”åˆ†ï¼šå¦‚æœæœ‰æ¯”èµ›è®°å½•ï¼ˆä¸ç®¡æ˜¯å¦å†³å‡ºèƒœè´Ÿï¼‰å°±æ˜¾ç¤ºæ¯”åˆ†
            const showScore = hasMatches || hasResult;
            
            return `
                <div class="bracket-match ${matchClass} ${connectClass} ${isPlayerMatch ? 'player-match' : ''} ${hasResult ? 'completed' : ''}">
                    <div class="bracket-team ${hasResult && match.winner?.teamName === match.team1?.teamName ? 'winner' : (hasResult ? 'loser' : '')}">
                        <span class="bracket-team-name ${match.team1?.isPlayer ? 'player' : ''}" title="${match.team1?.teamName || 'TBD'}">
                            ${match.team1?.isPlayer ? 'â­ ' : ''}${match.team1?.teamName || 'TBD'}
                        </span>
                        ${showScore ? `<span class="bracket-team-score">${team1Wins}</span>` : ''}
                    </div>
                    <div class="bracket-team ${hasResult && match.winner?.teamName === match.team2?.teamName ? 'winner' : (hasResult ? 'loser' : '')}">
                        <span class="bracket-team-name ${match.team2?.isPlayer ? 'player' : ''}" title="${match.team2?.teamName || 'TBD'}">
                            ${match.team2?.isPlayer ? 'â­ ' : ''}${match.team2?.teamName || 'TBD'}
                        </span>
                        ${showScore ? `<span class="bracket-team-score">${team2Wins}</span>` : ''}
                    </div>
                    ${hasResult ? '<div class="bracket-stage-info">âœ… å·²å®Œæˆ</div>' : (hasMatches ? '<div class="bracket-stage-info">â³ è¿›è¡Œä¸­</div>' : '<div class="bracket-stage-info">â³ å¾…è¿›è¡Œ</div>')}
                </div>
            `;
        }

        function displayStandingsInMain(container, league) {
            if (!league.standings || league.standings.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— ç§¯åˆ†æ•°æ®</p></div>';
                return;
            }

            let html = `<div style="max-width: 1200px; margin: 0 auto;">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">`;

            league.standings.forEach((team, index) => {
                const isPlayer = team.team.isPlayer;
                let cardStyle = 'background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%); border: 2px solid rgba(148, 163, 184, 0.3); border-radius: 12px; padding: 18px; transition: all 0.3s;';
                
                if (isPlayer) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%); border: 2px solid #fbbf24; border-radius: 12px; padding: 18px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);';
                } else if (team.promoted) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); border: 2px solid #10b981; border-radius: 12px; padding: 18px;';
                } else if (team.playoff) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 18px;';
                } else if (team.relegated) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 18px;';
                }

                html += `
                    <div style="${cardStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.8em; font-weight: bold; color: #a78bfa; min-width: 45px;">#${index + 1}</span>
                                <span style="font-size: 1.15em; font-weight: bold; color: ${isPlayer ? '#fbbf24' : '#e0e7ff'};">
                                    ${isPlayer ? 'â­ ' : ''}${team.team.teamName}
                                </span>
                            </div>
                            <span style="font-size: 1.5em; font-weight: bold; color: #a78bfa;">${team.points}åˆ†</span>
                        </div>
                        <div style="display: flex; gap: 18px; color: #cbd5e1; font-size: 0.95em;">
                            <span>è½®æ¬¡: ${team.played}</span>
                            <span style="color: #86efac;">èƒœ: ${team.won}</span>
                            <span style="color: #fca5a5;">è´Ÿ: ${team.lost}</span>
                        </div>
                    </div>`;
            });

            html += `</div>
                <div class="info-box" style="margin-top: 25px;">
                    <p>ğŸŸ¢ ç›´æ¥å‡çº§ | ğŸŸ¡ é™„åŠ èµ› | ğŸ”´ é™çº§ | â­ ä½ çš„é˜Ÿä¼</p>
                </div></div>`;

            container.innerHTML = html;
        }

        function displaySchedule(league) {
            const content = document.getElementById('schedule-content');
            
            if (!league || !league.name) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>è¯·å…ˆåŠ å…¥è”èµ›</p></div>';
                return;
            }

            if (league.name === 'é’å¹´è”èµ›') {
                // é’å¹´è”èµ›æ˜¾ç¤ºå°ç»„èµ›/æ·˜æ±°èµ›
                displayTournamentBracket(content, league);
                return;
            }

            // æ˜¾ç¤ºç§¯åˆ†æ¦œ
            let html = `<div class="info-box" style="max-width: 1200px; margin: 0 auto 30px;">
                <h3>${league.region} - ${league.name}</h3>
                <p style="font-size: 1.1em;">èµ›å­£ ${league.season} | ç¬¬ ${league.currentRound} è½®</p>
            </div><div style="max-width: 1200px; margin: 0 auto;">
                <table class="standings-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">æ’å</th>
                            <th>é˜Ÿä¼</th>
                            <th style="width: 100px;">è½®æ¬¡</th>
                            <th style="width: 100px;">èƒœ</th>
                            <th style="width: 100px;">è´Ÿ</th>
                            <th style="width: 100px;">ç§¯åˆ†</th>
                        </tr>
                    </thead>
                    <tbody>`;

            if (league.standings && league.standings.length > 0) {
                league.standings.forEach((team, index) => {
                    const isPlayer = team.team.isPlayer;
                    let rowStyle = '';
                    let borderLeft = '';
                    
                    if (isPlayer) {
                        rowStyle = 'background: linear-gradient(90deg, rgba(139, 92, 246, 0.15) 0%, rgba(124, 58, 237, 0.1) 100%);';
                        borderLeft = 'border-left: 4px solid #8b5cf6;';
                    } else if (team.promoted) {
                        borderLeft = 'border-left: 4px solid #34d399;';
                    } else if (team.playoff) {
                        borderLeft = 'border-left: 4px solid #fbbf24;';
                    } else if (team.relegated) {
                        borderLeft = 'border-left: 4px solid #f87171;';
                    }

                    html += `
                        <tr style="${rowStyle} ${borderLeft}">
                            <td style="font-weight: bold; font-size: 1.3em; color: #c4b5fd;">${index + 1}</td>
                            <td style="text-align: left; font-weight: ${isPlayer ? 'bold' : '600'}; color: ${isPlayer ? '#c4b5fd' : '#e0e7ff'};">
                                ${isPlayer ? 'â­ ' : ''}${team.team.teamName}
                            </td>
                            <td style="color: #cbd5e1;">${team.played}</td>
                            <td style="color: #6ee7b7; font-weight: 600;">${team.won}</td>
                            <td style="color: #fca5a5; font-weight: 600;">${team.lost}</td>
                            <td style="font-weight: bold; font-size: 1.3em; color: #c4b5fd;">${team.points}</td>
                        </tr>`;
                });
            }

            html += `</tbody></table>
                <div class="info-box" style="margin-top: 25px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%); border-color: rgba(139, 92, 246, 0.3);">
                    <p style="color: #e0e7ff;">ğŸŸ© ç›´æ¥å‡çº§ | ğŸŸ¨ é™„åŠ èµ› | ğŸŸ¥ é™çº§ | â­ ä½ çš„é˜Ÿä¼</p>
                </div></div>`;

            content.innerHTML = html;
        }

        function displayCareerHistory() {
            const playerTeam = leagueSystem.getPlayerTeam();
            const content = document.getElementById('career-history-content');
            
            if (!playerTeam.careerHistory || playerTeam.careerHistory.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“œ</div><p>æš‚æ— å†å²è®°å½•</p></div>';
                return;
            }

            let html = '';
            playerTeam.careerHistory.slice().reverse().forEach((record) => {
                const itemClass = record.promoted ? 'promoted' : (record.relegated ? 'relegated' : '');
                const statusText = record.promoted ? 'ğŸ‰ æ™‹çº§' : (record.relegated ? 'â¬‡ï¸ é™çº§' : 'â¡ï¸ ä¿çº§');
                
                html += `
                    <div class="history-item ${itemClass}">
                        <h4 style="font-size: 1.2em; margin-bottom: 10px;">èµ›å­£ ${record.season} - ${record.league}</h4>
                        <p>åœ°åŒºï¼š${record.region} | æ’åï¼š<strong>${record.rank}</strong> | ç§¯åˆ†ï¼š<strong>${record.points || 'N/A'}</strong></p>
                        <p style="margin-top: 10px;"><strong>${statusText}</strong></p>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }

        function displayStandings(league) {
            const content = document.getElementById('standings-content');
            
            if (!league.standings || league.standings.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>æš‚æ— ç§¯åˆ†æ•°æ®</p></div>';
                return;
            }

            let html = `<div class="info-box" style="max-width: 1200px; margin: 0 auto 30px;">
                <h3>${league.region} - ${league.name}</h3>
                <p style="font-size: 1.1em;">èµ›å­£ ${league.season} | ç¬¬ ${league.currentRound} è½®</p>
            </div><div style="max-width: 1200px; margin: 0 auto;">
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px;">`;

            league.standings.forEach((team, index) => {
                const isPlayer = team.team.isPlayer;
                let cardStyle = 'background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%); border: 2px solid rgba(148, 163, 184, 0.3); border-radius: 12px; padding: 18px; transition: all 0.3s;';
                
                if (isPlayer) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.3) 100%); border: 2px solid #fbbf24; border-radius: 12px; padding: 18px; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);';
                } else if (team.promoted) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); border: 2px solid #10b981; border-radius: 12px; padding: 18px;';
                } else if (team.playoff) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%); border: 2px solid #f59e0b; border-radius: 12px; padding: 18px;';
                } else if (team.relegated) {
                    cardStyle = 'background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%); border: 2px solid #ef4444; border-radius: 12px; padding: 18px;';
                }

                html += `
                    <div style="${cardStyle}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 1.8em; font-weight: bold; color: #a78bfa; min-width: 45px;">#${index + 1}</span>
                                <span style="font-size: 1.15em; font-weight: bold; color: ${isPlayer ? '#fbbf24' : '#e0e7ff'};">
                                    ${isPlayer ? 'â­ ' : ''}${team.team.teamName}
                                </span>
                            </div>
                            <span style="font-size: 1.5em; font-weight: bold; color: #a78bfa;">${team.points}åˆ†</span>
                        </div>
                        <div style="display: flex; gap: 18px; color: #cbd5e1; font-size: 0.95em;">
                            <span>è½®æ¬¡: ${team.played}</span>
                            <span style="color: #86efac;">èƒœ: ${team.won}</span>
                            <span style="color: #fca5a5;">è´Ÿ: ${team.lost}</span>
                        </div>
                    </div>`;
            });

            html += `</div>
                <div class="info-box" style="margin-top: 25px;">
                    <p>ğŸŸ¢ ç›´æ¥å‡çº§ | ğŸŸ¡ é™„åŠ èµ› | ğŸ”´ é™çº§ | â­ ä½ çš„é˜Ÿä¼</p>
                </div></div>`;

            content.innerHTML = html;
        }

        function displayFixtures(league) {
            const content = document.getElementById('fixtures-content');

            if (league.name === 'é’å¹´è”èµ›') {
                content.innerHTML = `<div class="info-box" style="max-width: 600px; margin: 50px auto;">
                    <h3>ğŸ’¡ æç¤º</h3>
                    <p>é’å¹´è”èµ›èµ›ç¨‹è¯·åœ¨ä¸»ç•Œé¢æŸ¥çœ‹ã€‚</p>
                </div>`;
                return;
            }

            const currentRound = league.currentRound;
            let html = `<div class="info-box" style="max-width: 1000px; margin: 0 auto 30px;">
                <h3>å½“å‰è½®æ¬¡</h3>
                <p style="font-size: 1.3em;">ç¬¬ ${currentRound} è½®</p>
            </div><div style="max-width: 1000px; margin: 0 auto;">`;

            const startRound = Math.max(1, currentRound - 2);
            const endRound = Math.min(currentRound + 1, league.fixtures.length);

            for (let round = startRound; round <= endRound; round++) {
                const roundFixtures = league.fixtures.filter(f => f.round === round);
                if (roundFixtures.length === 0) continue;

                html += `<h3 style="color: #a78bfa; margin: 30px 0 20px 0; font-size: 1.5em;">
                    ${round === currentRound ? 'â–¶ï¸ ' : ''}ç¬¬ ${round} è½®
                </h3>`;

                roundFixtures.forEach(fixture => {
                    const result = fixture.result;
                    html += `<div class="fixture-card"><div class="fixture-teams">
                        <div class="team-box ${fixture.home.isPlayer ? 'player-team' : ''}">
                            ${fixture.home.isPlayer ? 'â­ ' : ''}${fixture.home.teamName}
                            ${result ? `<div class="match-score">${result.homeWins}</div>` : ''}
                        </div>
                        <div class="match-vs">${result ? ':' : 'VS'}</div>
                        <div class="team-box ${fixture.away.isPlayer ? 'player-team' : ''}">
                            ${fixture.away.isPlayer ? 'â­ ' : ''}${fixture.away.teamName}
                            ${result ? `<div class="match-score">${result.awayWins}</div>` : ''}
                        </div>
                    </div></div>`;
                });
            }

            html += '</div>';
            content.innerHTML = html;
        }

        function displayTeamManagement(league) {
            const content = document.getElementById('manage-content');
            const playerTeam = leagueSystem.getPlayerTeam();

            if (playerTeam.league === 'é’å¹´è”èµ›') {
                content.innerHTML = `<div class="info-box" style="max-width: 600px; margin: 50px auto;">
                    <h3>ğŸ’¡ æç¤º</h3>
                    <p>é’å¹´è”èµ›æ— éœ€ç®¡ç†åŠ¨ç‰©åå•ï¼Œæ¯åœºæ¯”èµ›å¯è‡ªç”±é€‰æ‹©ã€‚</p>
                </div>`;
                return;
            }

            let html = `<div class="info-box success" style="max-width: 1200px; margin: 0 auto 30px;">
                <h3>å½“å‰é˜µå®¹</h3>
                <p>å·²ç™»è®°ï¼š${playerTeam.registeredAnimals.length} / 25 | å¯è½®æ¢ï¼š${playerTeam.availableSwaps}</p>
            </div><div class="animal-list" style="max-width: 1200px; margin: 0 auto;">`;

            playerTeam.registeredAnimals.forEach(animal => {
                html += `<div class="animal-card">
                    <h4 style="margin-bottom: 10px;">${animal.name}</h4>
                    <p>ç­‰çº§: ${animal.level} | HP: ${Math.round(animal.hp)}</p>
                    <p>æ”»å‡»: ${Math.round(animal.attack)} | é˜²å¾¡: ${Math.round(animal.defense)}</p>
                </div>`;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        // åˆ‡æ¢å°ç»„æ˜¾ç¤º
        function switchToGroup(groupIndex) {
            window.currentDisplayGroup = groupIndex;
            updateTabContent('schedule');
        }

        function updateUI() {
            const playerTeam = leagueSystem.getPlayerTeam();
            
            if (playerTeam.region) {
                document.getElementById('not-joined-view').style.display = 'none';
                document.getElementById('joined-main-view').style.display = 'block';
                document.getElementById('registration-view').style.display = 'none';
                // èµ›ç¨‹é¡µé¢é€šè¿‡ä¸»ç•Œé¢æŒ‰é’®è®¿é—®ï¼Œä¸éœ€è¦æ ‡ç­¾æŒ‰é’®
                
                // é‡ç½®å°ç»„æ˜¾ç¤ºä¸ºç©å®¶æ‰€åœ¨ç»„
                window.currentDisplayGroup = undefined;
                
                updateAllTabs();
                
                const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
                document.getElementById('next-season-btn').style.display = league.completed ? 'inline-block' : 'none';
            }
        }

        async function saveData() {
            try {
                await leagueSystem.saveData();
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                alert('âš ï¸ ä¿å­˜æ•°æ®å¤±è´¥ï¼š' + error.message);
            }
        }

        async function loadSavedData() {
            try {
                await leagueSystem.loadData();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        async function resetSeason() {
            if (!confirm('âš ï¸ ç¡®å®šè¦é‡ç½®èµ›å­£å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤æ‰€æœ‰è”èµ›æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ å½“å‰èµ›å­£è¿›åº¦\nâ€¢ é˜Ÿä¼ä¿¡æ¯\nâ€¢ æ¯”èµ›è®°å½•\nâ€¢ ç”Ÿæ¶¯å†å²\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                return;
            }
            
            try {
                // æ¸…é™¤ IndexedDB ä¸­çš„è”èµ›æ•°æ®
                await leagueSystem.clearAllData();
                
                alert('âœ… èµ›å­£å·²é‡ç½®ï¼é¡µé¢å°†åˆ·æ–°ã€‚');
                
                // åˆ·æ–°é¡µé¢
                location.reload();
            } catch (error) {
                console.error('é‡ç½®å¤±è´¥:', error);
                alert('âŒ é‡ç½®å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è·³è¿‡å°ç»„èµ›ï¼Œç›´æ¥è¿›å…¥æ·˜æ±°èµ›
        async function skipToKnockout() {
            if (!confirm('âš ï¸ ç¡®å®šè¦è·³è¿‡å°ç»„èµ›å—ï¼Ÿ\n\nå°†è‡ªåŠ¨æ¨¡æ‹Ÿæ‰€æœ‰å°ç»„èµ›ï¼Œå¹¶æ ¹æ®ç§¯åˆ†æ’åè¿›å…¥æ·˜æ±°èµ›ã€‚')) {
                return;
            }
            
            const playerTeam = leagueSystem.getPlayerTeam();
            if (!playerTeam || !playerTeam.region) {
                alert('è¯·å…ˆåŠ å…¥è”èµ›ï¼');
                return;
            }
            
            const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
            
            if (league.name !== 'é’å¹´è”èµ›') {
                alert('åªæœ‰é’å¹´è”èµ›å¯ä»¥è·³è¿‡å°ç»„èµ›ï¼');
                return;
            }
            
            if (league.groupStage && league.groupStage.completed) {
                alert('å°ç»„èµ›å·²å®Œæˆï¼');
                return;
            }
            
            try {
                console.log('å¼€å§‹æ¨¡æ‹Ÿå°ç»„èµ›...');
                
                // æ¨¡æ‹Ÿæ‰€æœ‰å°ç»„èµ›æ¯”èµ›
                const allGroupMatches = league.fixtures.filter(f => f.stage === 'å°ç»„èµ›' && !f.result);
                
                allGroupMatches.forEach(fixture => {
                    const result = leagueSystem.simulateMatch(fixture.home, fixture.away);
                    fixture.result = result;
                    
                    // è®°å½•ç»“æœ
                    if (!league.results) {
                        league.results = [];
                    }
                    league.results.push({
                        round: fixture.round,
                        fixture: fixture,
                        result: result
                    });
                });
                
                console.log(`å·²æ¨¡æ‹Ÿ ${allGroupMatches.length} åœºå°ç»„èµ›`);
                
                // å®Œæˆå°ç»„èµ›ï¼Œç”Ÿæˆæ·˜æ±°èµ›
                leagueSystem.finalizeGroupStage(league);
                league.groupStage.completed = true;
                
                // æ›´æ–°å½“å‰è½®æ¬¡åˆ°æ·˜æ±°èµ›ç¬¬ä¸€è½®
                if (league.knockoutFixtures && league.knockoutFixtures.length > 0) {
                    league.currentRound = league.knockoutFixtures[0].round - 1;
                }
                
                await saveData();
                updateAllTabs();
                
                alert('âœ… å°ç»„èµ›å·²å®Œæˆï¼\n\nä½ æ‰€åœ¨å°ç»„çš„æ’åå·²ç¡®å®šï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ·˜æ±°èµ›äº†ï¼');
                
            } catch (error) {
                console.error('è·³è¿‡å°ç»„èµ›å¤±è´¥:', error);
                alert('âŒ æ“ä½œå¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è°ƒè¯•ï¼šç›´æ¥èƒœåˆ©
        async function debugAutoWin() {
            if (!confirm('ğŸ® è°ƒè¯•æ¨¡å¼ï¼šç›´æ¥è·èƒœ\n\nè¿™å°†è·³è¿‡æˆ˜æ–—ï¼Œç›´æ¥åˆ¤å®šç©å®¶è·èƒœã€‚')) {
                return;
            }
            
            const playerTeam = leagueSystem.getPlayerTeam();
            if (!playerTeam.region) {
                alert('è¯·å…ˆåŠ å…¥è”èµ›ï¼');
                return;
            }
            
            // é’å¹´è”èµ›ï¼šæ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†åŠ¨ç‰©
            if (playerTeam.league === 'é’å¹´è”èµ›') {
                if (!window.selectedBattleAnimals || window.selectedBattleAnimals.filter(a => a).length < 5) {
                    alert('âš ï¸ è¯·å…ˆé€‰æ‹©5åªå‚æˆ˜åŠ¨ç‰©ï¼');
                    return;
                }
                playerTeam.registeredAnimals = window.selectedBattleAnimals.filter(a => a);
            }
            
            try {
                const league = leagueSystem.getLeagueInfo(playerTeam.region, playerTeam.league);
                
                // è·å–ä¸‹ä¸€åœºæ¯”èµ›
                const nextMatchInfo = getNextMatchInfo();
                if (!nextMatchInfo) {
                    alert('âš ï¸ æ²¡æœ‰å¯è¿›è¡Œçš„æ¯”èµ›ï¼');
                    return;
                }
                
                // æ¨¡æ‹Ÿç©å®¶è·èƒœçš„æ¯”èµ›ç»“æœ
                let mockResult;
                if (league.name === 'é’å¹´è”èµ›' && nextMatchInfo.isKnockout) {
                    // æ·˜æ±°èµ›ï¼šæ¯æ¬¡åªæ·»åŠ 1åœºç©å®¶èƒœåˆ©
                    const fixture = nextMatchInfo.matchData;
                    if (!fixture.matches) {
                        fixture.matches = [];
                    }
                    
                    const playerTeam = fixture.team1?.isPlayer ? fixture.team1 : fixture.team2;
                    const opponentTeam = fixture.team1?.isPlayer ? fixture.team2 : fixture.team1;
                    const playerIsTeam1 = fixture.team1?.isPlayer;
                    
                    // è®¡ç®—å½“å‰æˆ˜ç»©
                    let team1Wins = fixture.matches.filter(m => m.winner === fixture.team1).length;
                    let team2Wins = fixture.matches.filter(m => m.winner === fixture.team2).length;
                    
                    console.log('è°ƒè¯•æ¨¡å¼ - å½“å‰æˆ˜ç»©:', { team1Wins, team2Wins });
                    
                    // åªæ·»åŠ 1åœºç©å®¶èƒœåˆ©
                    fixture.matches.push({
                        winner: playerTeam,
                        home: fixture.team1,
                        away: fixture.team2,
                        homeWins: playerIsTeam1 ? 5 : 0,
                        awayWins: playerIsTeam1 ? 0 : 5,
                        homePoints: playerIsTeam1 ? 3 : 0,
                        awayPoints: playerIsTeam1 ? 0 : 3
                    });
                    
                    // é‡æ–°è®¡ç®—ç©å®¶æˆ˜ç»©
                    team1Wins = fixture.matches.filter(m => m.winner === fixture.team1).length;
                    team2Wins = fixture.matches.filter(m => m.winner === fixture.team2).length;
                    
                    console.log('è°ƒè¯•æ¨¡å¼ - æ·»åŠ 1åœºå:', { team1Wins, team2Wins, matchesCount: fixture.matches.length });
                    
                    const roundFixtures = league.knockoutFixtures.filter(f => f.round === fixture.round);
                    
                    if (team1Wins >= 2 || team2Wins >= 2) {
                        // ç©å®¶å·²å†³å‡ºèƒœè´Ÿï¼Œç«‹å³å®Œæˆæœ¬è½®æ‰€æœ‰å…¶ä»–AIå¯¹å±€
                        fixture.winner = team1Wins > team2Wins ? fixture.team1 : fixture.team2;
                        console.log('è°ƒè¯•æ¨¡å¼ - ç©å®¶å·²å†³å‡ºèƒœè´Ÿï¼Œèƒœè€…:', fixture.winner.teamName);
                        console.log('è°ƒè¯•æ¨¡å¼ - ç«‹å³å®Œæˆæœ¬è½®æ‰€æœ‰AIå¯¹å±€...');
                        
                        roundFixtures.forEach(f => {
                            if (f !== fixture && !f.winner) {
                                leagueSystem.simulateKnockoutFixture(f);
                            }
                        });
                        
                        // æ›´æ–°ä¸‹ä¸€è½®å¯¹é˜µ
                        leagueSystem.updateNextKnockoutRound(league, fixture.round);
                        
                        // æ›´æ–°å½“å‰è½®æ¬¡
                        league.currentRound = fixture.round;
                        
                        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                        if (fixture.stage === 'å†³èµ›') {
                            league.completed = true;
                            leagueSystem.processYouthLeagueEnd(league);
                        }
                    } else {
                        // ç©å®¶æœªå†³å‡ºèƒœè´Ÿï¼ŒåŒæ­¥æ¨¡æ‹Ÿå…¶ä»–AIå¯¹å±€çš„1åœºæ¯”èµ›
                        console.log(`è°ƒè¯•æ¨¡å¼ - æœ¬è½®å…±${roundFixtures.length}åœºæ¯”èµ›ï¼ŒåŒæ­¥æ¨¡æ‹Ÿå…¶ä»–AIå¯¹å±€çš„1åœº...`);
                        
                        roundFixtures.forEach(f => {
                            if (f !== fixture && !f.winner) {
                                // ä¸ºæ¯ä¸ªAIå¯¹å±€æ·»åŠ 1åœºæ¯”èµ›
                                if (!f.matches) f.matches = [];
                                
                                // è®¡ç®—å·²æœ‰æˆ˜ç»©
                                let ai_team1Wins = f.matches.filter(m => m.winner === f.team1).length;
                                let ai_team2Wins = f.matches.filter(m => m.winner === f.team2).length;
                                
                                // åªæœ‰åœ¨æœªå†³å‡ºèƒœè´Ÿä¸”æœªè¾¾åˆ°æœ€å¤§åœºæ¬¡æ—¶æ‰æ·»åŠ 
                                if (f.matches.length < 3 && ai_team1Wins < 2 && ai_team2Wins < 2) {
                                    const aiMatch = leagueSystem.simulateMatch(f.team1, f.team2);
                                    f.matches.push(aiMatch);
                                    
                                    // é‡æ–°è®¡ç®—æˆ˜ç»©
                                    ai_team1Wins = f.matches.filter(m => m.winner === f.team1).length;
                                    ai_team2Wins = f.matches.filter(m => m.winner === f.team2).length;
                                    
                                    // æ£€æŸ¥æ˜¯å¦å†³å‡ºèƒœè´Ÿ
                                    if (ai_team1Wins >= 2 || ai_team2Wins >= 2) {
                                        f.winner = ai_team1Wins > ai_team2Wins ? f.team1 : f.team2;
                                        console.log(`  è°ƒè¯• - AIå¯¹å±€å†³å‡ºèƒœè´Ÿ: ${f.team1.teamName} ${ai_team1Wins}:${ai_team2Wins} ${f.team2.teamName}`);
                                    }
                                }
                            }
                        });
                    }
                    
                    mockResult = {
                        round: fixture.round,
                        stage: fixture.stage,
                        completed: league.completed
                    };
                } else {
                    // å°ç»„èµ›æˆ–å¸¸è§„è”èµ›ï¼šç›´æ¥è°ƒç”¨playRound
                    mockResult = leagueSystem.playRound(playerTeam.region, playerTeam.league);
                }
                
                if (mockResult.error) {
                    alert(mockResult.error);
                    return;
                }
                
                await saveData();
                updateAllTabs();
                
                alert('âœ… å·²è‡ªåŠ¨è·èƒœï¼');
                
                if (mockResult.completed) {
                    document.getElementById('next-season-btn').style.display = 'inline-block';
                }
                
            } catch (error) {
                console.error('è°ƒè¯•å¤±è´¥:', error);
                alert('âŒ è°ƒè¯•å¤±è´¥ï¼š' + error.message);
            }
        }
    </script>
</body>
</html>