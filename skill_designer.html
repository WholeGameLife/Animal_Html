
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½è®¾è®¡å™¨ V2.0 - ç”µå­ç›†æ ½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .skill-card {
            transition: all 0.3s ease;
        }
        
        .skill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* ç³»åˆ«é¢œè‰² */
        .element-water { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .element-fire { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .element-grass { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .element-wind { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .element-electric { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .element-earth { background: linear-gradient(135deg, #a16207, #854d0e); }
        
        /* å˜å¼‚é¢œè‰² */
        .mutation-dark { background: linear-gradient(135deg, #1f2937, #111827); }
        .mutation-light { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); color: #111827; }
        .mutation-crystal { background: linear-gradient(135deg, #a78bfa, #8b5cf6); }
        .mutation-shadow { background: linear-gradient(135deg, #4b5563, #374151); }
        .mutation-thunder { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .mutation-holy { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
        .mutation-psychic { background: linear-gradient(135deg, #ec4899, #db2777); }
        .mutation-chaos { background: linear-gradient(135deg, #581c87, #6b21a8); }
        .mutation-eternal-dark { background: linear-gradient(135deg, #0f172a, #020617); }
        .mutation-eternal-light { background: linear-gradient(135deg, #fef9c3, #fef08a); color: #713f12; }
        .mutation-source-crystal { background: linear-gradient(135deg, #5b21b6, #6d28d9); }
        .mutation-thunder-lord { background: linear-gradient(135deg, #f59e0b, #d97706); }
        
        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .emoji-btn {
            padding: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        .emoji-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.2);
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">âš”ï¸ æŠ€èƒ½è®¾è®¡å™¨ V2.0 âš”ï¸</h1>
            <p class="text-blue-200 mb-3">å…¨æ–°æŠ€èƒ½ç³»ç»Ÿ - çµæ´»é…ç½®æ•ˆæœæ¥æºå’Œå‚æ•°</p>
            <div class="flex justify-center gap-3">
                <a href="skill_viewer.html"
                   class="inline-flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    <span>ğŸ¯</span>
                    <span>æŸ¥çœ‹æŠ€èƒ½æ± </span>
                </a>
                <button onclick="window.history.back()"
                        class="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    <span>â†</span>
                    <span>è¿”å›</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šæŠ€èƒ½è®¾è®¡è¡¨å• -->
            <div class="lg:col-span-2 bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ¨ åˆ›å»ºæ–°æŠ€èƒ½</h2>
                
                <form id="skill-form" class="space-y-4">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½åç§° *</label>
                            <input type="text" id="skill-name" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½å›¾æ ‡ *</label>
                            <div class="flex gap-2">
                                <input type="text" id="skill-icon" required maxlength="2"
                                    class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-2xl focus:outline-none focus:border-blue-500">
                                <button type="button" id="emoji-picker-btn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-lg">
                                    é€‰æ‹©
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- æŠ€èƒ½æè¿° -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½æè¿°</label>
                        <textarea id="skill-description" rows="2" placeholder="æè¿°è¿™ä¸ªæŠ€èƒ½çš„èƒŒæ™¯æ•…äº‹æˆ–ç‰¹ç‚¹..."
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500 resize-none"></textarea>
                    </div>

                    <!-- æŠ€èƒ½ç±»åˆ« -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½ç±»åˆ« *</label>
                            <select id="skill-category" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="">é€‰æ‹©ç±»åˆ«</option>
                                <optgroup label="ç³»åˆ«æŠ€èƒ½">
                                    <option value="element-water">ğŸ’§ æ°´ç³»</option>
                                    <option value="element-fire">ğŸ”¥ ç«ç³»</option>
                                    <option value="element-grass">ğŸŒ¿ è‰ç³»</option>
                                    <option value="element-wind">ğŸ’¨ é£ç³»</option>
                                    <option value="element-electric">âš¡ ç”µç³»</option>
                                    <option value="element-earth">ğŸª¨ åœŸç³»</option>
                                </optgroup>
                                <optgroup label="å˜å¼‚æŠ€èƒ½ - åŸºç¡€çº§">
                                    <option value="mutation-dark">ğŸ–¤ é»‘åŒ–</option>
                                    <option value="mutation-light">ğŸ¤ ç™½åŒ–</option>
                                    <option value="mutation-crystal">ğŸ’ æ™¶åŒ–</option>
                                    <option value="mutation-shadow">ğŸ‘¤ å½±åŒ–</option>
                                </optgroup>
                                <optgroup label="å˜å¼‚æŠ€èƒ½ - ç²¾è‹±çº§">
                                    <option value="mutation-chaos">ğŸŒ‘ æš—èš€</option>
                                    <option value="mutation-holy">âœ¨ åœ£è¾‰</option>
                                    <option value="mutation-psychic">ğŸ”® å¼‚èƒ½</option>
                                    <option value="mutation-thunder">âš¡ æç”µ</option>
                                </optgroup>
                                <optgroup label="å˜å¼‚æŠ€èƒ½ - ä¼ è¯´çº§">
                                    <option value="mutation-eternal-dark">ğŸŒ™ æ°¸å¤œ</option>
                                    <option value="mutation-eternal-light">â˜€ï¸ æ°¸è€€</option>
                                    <option value="mutation-source-crystal">ğŸ’  æºæ™¶</option>
                                    <option value="mutation-thunder-lord">âš¡ é›·ç…Œ</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½ç±»å‹ *</label>
                            <select id="skill-type" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="">é€‰æ‹©ç±»å‹</option>
                                <option value="attack">âš”ï¸ æ”»å‡»å‹</option>
                                <option value="defense">ğŸ›¡ï¸ é˜²å¾¡å‹</option>
                                <option value="agility">âš¡ æ•æ·å‹</option>
                                <option value="buff">ğŸ’ª å¢ç›Šå‹</option>
                                <option value="debuff">ğŸ”» å‡ç›Šå‹</option>
                                <option value="heal">ğŸ’š æ²»ç–—å‹</option>
                            </select>
                        </div>
                    </div>


                    <!-- æŠ€èƒ½æ•ˆæœé€‰æ‹© -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½æ•ˆæœ * (å¯å¤šé€‰)</label>
                        <div id="skill-effects" class="bg-gray-800 border border-gray-600 rounded-lg p-3 max-h-96 overflow-y-auto space-y-3">
                            <!-- æ”»å‡»ç±» -->
                            <div>
                                <div class="text-xs font-bold text-blue-400 mb-2">âš”ï¸ æ”»å‡»ç±»</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="direct_attack" class="skill-effect-checkbox">
                                        <span>ç›´æ¥æ”»å‡»</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="multi_attack" class="skill-effect-checkbox">
                                        <span>å¤šæ®µæ”»å‡»</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="dot_damage" class="skill-effect-checkbox">
                                        <span>é™„åŠ ä¼¤å®³(æŒç»­)</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="percent_damage" class="skill-effect-checkbox">
                                        <span>ç™¾åˆ†æ¯”ä¼¤å®³</span>
                                    </label>
                                </div>
                            </div>
                            <!-- é˜²å¾¡ç±» -->
                            <div>
                                <div class="text-xs font-bold text-green-400 mb-2">ğŸ›¡ï¸ é˜²å¾¡ç±»</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="direct_defense" class="skill-effect-checkbox">
                                        <span>ç›´æ¥é˜²å¾¡</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="continuous_defense" class="skill-effect-checkbox">
                                        <span>æŒç»­é˜²å¾¡</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="defense_counter" class="skill-effect-checkbox">
                                        <span>é˜²å¾¡åå‡»</span>
                                    </label>
                                </div>
                            </div>
                            <!-- æ•æ·ç±» -->
                            <div>
                                <div class="text-xs font-bold text-yellow-400 mb-2">âš¡ æ•æ·ç±»</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="direct_speed" class="skill-effect-checkbox">
                                        <span>ç›´æ¥å¢é€Ÿ</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="continuous_speed" class="skill-effect-checkbox">
                                        <span>æŒç»­å¢é€Ÿ</span>
                                    </label>
                                </div>
                            </div>
                            <!-- å¢ç›Šç±» -->
                            <div>
                                <div class="text-xs font-bold text-purple-400 mb-2">ğŸ’ª å¢ç›Šç±»</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_attack" class="skill-effect-checkbox">
                                        <span>å¢æ”»</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_defense" class="skill-effect-checkbox">
                                        <span>å¢é˜²</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_speed" class="skill-effect-checkbox">
                                        <span>å¢é€Ÿ</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_status_enemy" class="skill-effect-checkbox">
                                        <span>ä¸ºæ•Œæ–¹é™„åŠ å¼‚å¸¸</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_purify" class="skill-effect-checkbox">
                                        <span>å‡€åŒ–</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_heal_amp" class="skill-effect-checkbox">
                                        <span>å¢åŠ æ²»ç–—é‡</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="buff_element_damage" class="skill-effect-checkbox">
                                        <span>å±æ€§å¢ä¼¤</span>
                                    </label>
                                </div>
                            </div>
                            <!-- å‡ç›Šç±» -->
                            <div>
                                <div class="text-xs font-bold text-red-400 mb-2">ğŸ”» å‡ç›Šç±»</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_attack" class="skill-effect-checkbox">
                                        <span>å‡æ”»</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_defense" class="skill-effect-checkbox">
                                        <span>å‡é˜²</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_speed" class="skill-effect-checkbox">
                                        <span>å‡é€Ÿ</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_status_self" class="skill-effect-checkbox">
                                        <span>ä¸ºè‡ªèº«é™„åŠ å¼‚å¸¸</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_no_heal" class="skill-effect-checkbox">
                                        <span>ç¦ç–—</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_heal_reduce" class="skill-effect-checkbox">
                                        <span>å‡ç–—</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="debuff_element_damage" class="skill-effect-checkbox">
                                        <span>å±æ€§å‡ä¼¤</span>
                                    </label>
                                </div>
                            </div>
                            <!-- æ²»ç–—ç±» -->
                            <div>
                                <div class="text-xs font-bold text-pink-400 mb-2">ğŸ’š æ²»ç–—ç±»</div>
                                <div class="grid grid-cols-2 gap-2">
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="heal_direct" class="skill-effect-checkbox">
                                        <span>ç›´æ¥æ¢å¤</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="heal_continuous" class="skill-effect-checkbox">
                                        <span>æŒç»­æ¢å¤</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="heal_percent" class="skill-effect-checkbox">
                                        <span>ç™¾åˆ†æ¯”æ¢å¤</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="heal_rebirth" class="skill-effect-checkbox">
                                        <span>é‡ç”Ÿ</span>
                                    </label>
                                    <label class="flex items-center gap-2 text-white text-sm cursor-pointer hover:bg-gray-700 p-1.5 rounded">
                                        <input type="checkbox" name="skill-effect" value="heal_lifesteal" class="skill-effect-checkbox">
                                        <span>ç”Ÿå‘½æ±²å–</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŠ¨æ€å‚æ•°åŒºåŸŸ -->
                    <div id="params-container" class="space-y-4 bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                        <h3 class="text-sm font-bold text-gray-300 mb-3">ğŸ“Š æŠ€èƒ½å‚æ•°é…ç½®</h3>
                        
                        <!-- é€šç”¨å‚æ•° -->
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">å†·å´å›åˆ</label>
                                <input type="number" id="param-cooldown" min="0" value="0"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">æŒç»­å›åˆ</label>
                                <input type="number" id="param-duration" min="0" value="0"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-1">æ¯å›åˆæ¬¡æ•°</label>
                                <input type="number" id="param-count" min="1" value="1"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            </div>
                        </div>

                        <div id="dynamic-params" class="space-y-3">
                            <!-- åŠ¨æ€ç”Ÿæˆçš„å‚æ•°å°†æ’å…¥è¿™é‡Œ -->
                        </div>
                    </div>

                    <!-- æŒ‰é’® -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="submit-btn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            <span id="submit-text">âœ¨ åˆ›å»ºæŠ€èƒ½</span>
                        </button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            âŒ å–æ¶ˆç¼–è¾‘
                        </button>
                        <button type="button" id="clear-btn"
                            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            ğŸ”„ æ¸…ç©º
                        </button>
                    </div>
                </form>
            </div>

            <!-- å³ä¾§ï¼šæŠ€èƒ½é¢„è§ˆå’Œåˆ—è¡¨ -->
            <div class="space-y-6">
                <!-- æŠ€èƒ½é¢„è§ˆ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ‘ï¸ æŠ€èƒ½é¢„è§ˆ</h3>
                    <div id="skill-preview" class="skill-card bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">â“</div>
                            <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                        </div>
                    </div>
                    <button type="button" id="test-skill-btn" class="hidden w-full mt-3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        ğŸ® æµ‹è¯•æŠ€èƒ½æ•ˆæœ
                    </button>
                </div>

                <!-- å·²åˆ›å»ºæŠ€èƒ½åˆ—è¡¨ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">ğŸ“‹ æŠ€èƒ½åˆ—è¡¨ (<span id="skill-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <label for="import-file"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer">
                                ğŸ“¤ å¯¼å…¥
                            </label>
                            <input type="file" id="import-file" accept=".json" class="hidden">
                            <button id="export-btn"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ“¥ å¯¼å‡º
                            </button>
                        </div>
                    </div>
                    <div id="skills-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 text-sm py-8">
                            æš‚æ— æŠ€èƒ½
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emojié€‰æ‹©å™¨æ¨¡æ€æ¡† -->
        <div id="emoji-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-gray-900 rounded-xl p-6 max-w-md w-full mx-4 border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">é€‰æ‹©å›¾æ ‡</h3>
                    <button id="close-emoji-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
                </div>
                <div id="emoji-grid" class="emoji-picker bg-gray-800 rounded-lg p-4">
                    <!-- Emojiåˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- æŠ€èƒ½æµ‹è¯•æ¨¡æ€æ¡† -->
        <div id="test-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
            <div class="bg-gray-900 rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-gray-700">
                <div class="sticky top-0 bg-gray-900 border-b border-gray-700 p-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">ğŸ® æŠ€èƒ½æµ‹è¯•åœºæ™¯</h3>
                    <button id="close-test-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
                </div>
                
                <div class="p-6 space-y-4">
                    <!-- å±æ€§é…ç½® -->
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-4">
                        <h4 class="text-sm font-bold text-gray-300 mb-3">âš™ï¸ è‡ªå®šä¹‰å±æ€§</h4>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div class="space-y-2">
                                <div class="font-bold text-blue-300 mb-2">æˆ‘æ–¹å•ä½</div>
                                <input type="number" id="config-self-hp" placeholder="ç”Ÿå‘½å€¼" value="1000" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                                <input type="number" id="config-self-attack" placeholder="æ”»å‡»åŠ›" value="100" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                                <input type="number" id="config-self-defense" placeholder="é˜²å¾¡åŠ›" value="50" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                                <input type="number" id="config-self-agility" placeholder="æ•æ·" value="80" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                            </div>
                            <div class="space-y-2">
                                <div class="font-bold text-red-300 mb-2">æ•Œæ–¹å•ä½</div>
                                <input type="number" id="config-enemy-hp" placeholder="ç”Ÿå‘½å€¼" value="800" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                                <input type="number" id="config-enemy-attack" placeholder="æ”»å‡»åŠ›" value="90" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                                <input type="number" id="config-enemy-defense" placeholder="é˜²å¾¡åŠ›" value="40" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                                <input type="number" id="config-enemy-agility" placeholder="æ•æ·" value="70" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white">
                            </div>
                        </div>
                    </div>

                    <!-- æˆ˜æ–—åœºæ™¯ -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- æˆ‘æ–¹ -->
                        <div class="bg-blue-900/30 border border-blue-600 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-bold text-blue-300">ğŸ‘¤ æˆ‘æ–¹å•ä½</h4>
                                <select id="self-element" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="water">ğŸ’§ æ°´</option>
                                    <option value="fire">ğŸ”¥ ç«</option>
                                    <option value="grass">ğŸŒ¿ è‰</option>
                                    <option value="wind">ğŸ’¨ é£</option>
                                    <option value="electric">âš¡ ç”µ</option>
                                    <option value="earth">ğŸª¨ åœŸ</option>
                                </select>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">ç”Ÿå‘½å€¼:</span>
                                    <span class="text-white font-bold">
                                        <span id="self-hp">1000</span> / <span id="self-max-hp">1000</span>
                                    </span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="self-hp-bar" class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">æ”»å‡»åŠ›:</span>
                                    <span class="text-white"><span id="self-attack">100</span></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">é˜²å¾¡åŠ›:</span>
                                    <span class="text-white"><span id="self-defense">50</span></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">æ•æ·:</span>
                                    <span class="text-white"><span id="self-agility">80</span></span>
                                </div>
                                <div class="mt-3 pt-3 border-t border-blue-600">
                                    <div class="text-xs text-gray-400 mb-1">ğŸ”® å¼‚å¸¸çŠ¶æ€:</div>
                                    <div id="self-status" class="flex flex-wrap gap-1 min-h-[24px]">
                                        <span class="text-xs text-gray-500">æ— </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ•Œæ–¹ -->
                        <div class="bg-red-900/30 border border-red-600 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-lg font-bold text-red-300">ğŸ‘¹ æ•Œæ–¹å•ä½</h4>
                                <select id="enemy-element" class="bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs">
                                    <option value="water">ğŸ’§ æ°´</option>
                                    <option value="fire">ğŸ”¥ ç«</option>
                                    <option value="grass">ğŸŒ¿ è‰</option>
                                    <option value="wind">ğŸ’¨ é£</option>
                                    <option value="electric">âš¡ ç”µ</option>
                                    <option value="earth">ğŸª¨ åœŸ</option>
                                </select>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">ç”Ÿå‘½å€¼:</span>
                                    <span class="text-white font-bold">
                                        <span id="enemy-hp">800</span> / <span id="enemy-max-hp">800</span>
                                    </span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div id="enemy-hp-bar" class="bg-red-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">æ”»å‡»åŠ›:</span>
                                    <span class="text-white"><span id="enemy-attack">90</span></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">é˜²å¾¡åŠ›:</span>
                                    <span class="text-white"><span id="enemy-defense">40</span></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">æ•æ·:</span>
                                    <span class="text-white"><span id="enemy-agility">70</span></span>
                                </div>
                                <div class="mt-3 pt-3 border-t border-red-600">
                                    <div class="text-xs text-gray-400 mb-1">ğŸ”® å¼‚å¸¸çŠ¶æ€:</div>
                                    <div id="enemy-status" class="flex flex-wrap gap-1 min-h-[24px]">
                                        <span class="text-xs text-gray-500">æ— </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æŠ€èƒ½é€‰æ‹© -->
                    <div class="bg-purple-900/30 border border-purple-600 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-purple-300 mb-3">âš”ï¸ é€‰æ‹©æµ‹è¯•æŠ€èƒ½</h4>
                        <div id="test-skills-selector" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- æŠ€èƒ½é€‰æ‹©åˆ—è¡¨ -->
                        </div>
                    </div>

                    <!-- å›åˆä¿¡æ¯ -->
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-300">
                                <span class="font-bold text-yellow-300">å½“å‰å›åˆï¼š</span>
                                <span id="current-turn" class="text-white font-bold">1</span>
                            </div>
                            <div class="text-xs text-gray-400">
                                æŒç»­æ•ˆæœï¼š<span id="active-effects-count" class="text-white">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="grid grid-cols-3 gap-3">
                        <button id="use-skill-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-500" disabled>
                            âš”ï¸ ä½¿ç”¨æŠ€èƒ½
                        </button>
                        <button id="enemy-attack-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            ğŸ‘¹ æ•Œäººæ”»å‡»
                        </button>
                        <button id="next-turn-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            â­ï¸ ä¸‹ä¸€å›åˆ
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="use-all-skills-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-500" disabled>
                            âš¡ ä½¿ç”¨å…¨éƒ¨
                        </button>
                        <button id="reset-battle-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            ğŸ”„ é‡ç½®
                        </button>
                    </div>

                    <!-- æˆ˜æ–—æ—¥å¿— -->
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-4">
                        <h4 class="text-sm font-bold text-gray-300 mb-2">ğŸ“œ æˆ˜æ–—æ—¥å¿—</h4>
                        <div id="battle-log" class="space-y-1 max-h-60 overflow-y-auto text-xs text-gray-400">
                            <div class="text-center text-gray-500">ç­‰å¾…ä½¿ç”¨æŠ€èƒ½...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å¸¸ç”¨Emojiåˆ—è¡¨
        const EMOJIS = [
            'âš”ï¸', 'ğŸ—¡ï¸', 'ğŸ”ª', 'ğŸ¹', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸ’¥',
            'ğŸ›¡ï¸', 'ğŸ°', 'ğŸ§±', 'â›“ï¸', 'ğŸ”’', 'ğŸ”', 'ğŸ—ï¸', 'ğŸ”‘',
            'âš¡', 'ğŸ”¥', 'ğŸ’§', 'ğŸŒŠ', 'ğŸŒ¿', 'ğŸƒ', 'ğŸ’¨', 'ğŸŒªï¸',
            'â„ï¸', 'â˜ƒï¸', 'ğŸ§Š', 'ğŸ’', 'ğŸ’ ', 'ğŸ”®', 'ğŸŒŸ', 'âœ¨',
            'ğŸ’«', 'â­', 'ğŸŒ™', 'â˜€ï¸', 'ğŸŒˆ', 'â˜ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸',
            'ğŸ’ª', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤œ', 'ğŸ¤›', 'ğŸ‘‹', 'ğŸ–ï¸', 'âœ‹',
            'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›',
            'ğŸ©¸', 'ğŸ’‰', 'ğŸ’Š', 'ğŸ§ª', 'ğŸ§¬', 'ğŸ”¬', 'ğŸ§²', 'âš—ï¸',
            'ğŸ¯', 'ğŸ²', 'ğŸ°', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸª', 'ğŸ­', 'ğŸ¨',
            'ğŸŒ€', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—',
            'ğŸ‘¤', 'ğŸ‘¥', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–',
            'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ˜¡', 'ğŸ’¢', 'ğŸ’¯', 'ğŸ”±', 'âšœï¸', 'â™»ï¸'
        ];

        // æ•ˆæœå‚æ•°é…ç½®ï¼ˆæ¯ä¸ªæ•ˆæœéƒ½æœ‰ç‹¬ç«‹çš„æ•ˆæœæ¥æºï¼‰
        const EFFECT_PARAMS_CONFIG = {
            'direct_attack': { name: 'ç›´æ¥æ”»å‡»', params: ['effect-source', 'bonus'] },
            'multi_attack': { name: 'å¤šæ®µæ”»å‡»', params: ['effect-source', 'multi-bonus'] },
            'dot_damage': { name: 'é™„åŠ ä¼¤å®³', params: ['effect-source', 'bonus'] },
            'percent_damage': { name: 'ç™¾åˆ†æ¯”ä¼¤å®³', params: ['effect-source', 'percent'] },
            'direct_defense': { name: 'ç›´æ¥é˜²å¾¡', params: ['effect-source', 'bonus'] },
            'continuous_defense': { name: 'æŒç»­é˜²å¾¡', params: ['effect-source', 'bonus'] },
            'defense_counter': { name: 'é˜²å¾¡åå‡»', params: ['effect-source', 'defense-bonus', 'counter-effect-source', 'counter-bonus'] },
            'direct_speed': { name: 'ç›´æ¥å¢é€Ÿ', params: ['effect-source', 'bonus'] },
            'continuous_speed': { name: 'æŒç»­å¢é€Ÿ', params: ['effect-source', 'bonus'] },
            'buff_attack': { name: 'å¢æ”»', params: ['effect-source', 'target', 'bonus'] },
            'buff_defense': { name: 'å¢é˜²', params: ['effect-source', 'target', 'bonus'] },
            'buff_speed': { name: 'å¢é€Ÿ', params: ['effect-source', 'target', 'bonus'] },
            'buff_status_enemy': { name: 'ä¸ºæ•Œæ–¹é™„åŠ å¼‚å¸¸', params: ['status-type', 'status-chance'] },
            'buff_purify': { name: 'å‡€åŒ–', params: ['target', 'purify-type'] },
            'buff_heal_amp': { name: 'å¢åŠ æ²»ç–—é‡', params: ['effect-source', 'target', 'bonus'] },
            'buff_element_damage': { name: 'å±æ€§å¢ä¼¤', params: ['target', 'element-type', 'damage-bonus'] },
            'debuff_attack': { name: 'å‡æ”»', params: ['effect-source', 'target', 'bonus'] },
            'debuff_defense': { name: 'å‡é˜²', params: ['effect-source', 'target', 'bonus'] },
            'debuff_speed': { name: 'å‡é€Ÿ', params: ['effect-source', 'target', 'bonus'] },
            'debuff_status_self': { name: 'ä¸ºè‡ªèº«é™„åŠ å¼‚å¸¸', params: ['status-type', 'status-chance'] },
            'debuff_no_heal': { name: 'ç¦ç–—', params: ['target'] },
            'debuff_heal_reduce': { name: 'å‡ç–—', params: ['effect-source', 'target', 'bonus'] },
            'debuff_element_damage': { name: 'å±æ€§å‡ä¼¤', params: ['target', 'element-type', 'damage-reduce'] },
            'heal_direct': { name: 'ç›´æ¥æ¢å¤', params: ['effect-source', 'target', 'bonus'] },
            'heal_continuous': { name: 'æŒç»­æ¢å¤', params: ['effect-source', 'target', 'bonus'] },
            'heal_percent': { name: 'ç™¾åˆ†æ¯”æ¢å¤', params: ['effect-source', 'target', 'percent'] },
            'heal_rebirth': { name: 'é‡ç”Ÿ', params: ['effect-source', 'target', 'percent', 'rebirth-condition'] },
            'heal_lifesteal': { name: 'ç”Ÿå‘½æ±²å–', params: ['effect-source', 'bonus'] }
        };

        // æŠ€èƒ½æ± å­˜å‚¨
        let skills = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
        let editingIndex = -1;

        // DOMå…ƒç´ 
        const form = document.getElementById('skill-form');
        const preview = document.getElementById('skill-preview');
        const skillsList = document.getElementById('skills-list');
        const skillCount = document.getElementById('skill-count');
        const emojiModal = document.getElementById('emoji-modal');
        const emojiGrid = document.getElementById('emoji-grid');
        const dynamicParams = document.getElementById('dynamic-params');

        // åˆå§‹åŒ–
        function init() {
            renderSkillsList();
            setupEmojiPicker();
            setupFormListeners();
            updateSkillCount();
        }

        // æ›´æ–°æŠ€èƒ½æ•°é‡
        function updateSkillCount() {
            skillCount.textContent = skills.length;
        }

        // è®¾ç½®Emojié€‰æ‹©å™¨
        function setupEmojiPicker() {
            emojiGrid.innerHTML = '';
            EMOJIS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.textContent = emoji;
                btn.type = 'button';
                btn.onclick = () => {
                    document.getElementById('skill-icon').value = emoji;
                    emojiModal.classList.add('hidden');
                    updatePreview();
                };
                emojiGrid.appendChild(btn);
            });

            document.getElementById('emoji-picker-btn').onclick = () => emojiModal.classList.remove('hidden');
            document.getElementById('close-emoji-modal').onclick = () => emojiModal.classList.add('hidden');
            emojiModal.onclick = (e) => {
                if (e.target === emojiModal) emojiModal.classList.add('hidden');
            };
        }

        // è®¾ç½®è¡¨å•ç›‘å¬å™¨
        function setupFormListeners() {
            form.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            document.querySelectorAll('.skill-effect-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    showRelevantParams();
                    updatePreview();
                });
            });

            form.onsubmit = (e) => {
                e.preventDefault();
                if (editingIndex >= 0) {
                    updateSkill();
                } else {
                    createSkill();
                }
            };

            document.getElementById('clear-btn').onclick = () => {
                form.reset();
                cancelEdit();
                dynamicParams.innerHTML = '';
                updatePreview();
            };

            document.getElementById('cancel-edit-btn').onclick = () => {
                form.reset();
                cancelEdit();
                dynamicParams.innerHTML = '';
                updatePreview();
            };

            document.getElementById('export-btn').onclick = exportSkills;
            document.getElementById('import-file').onchange = importSkills;
        }

        // åŠ¨æ€æ˜¾ç¤ºç›¸å…³å‚æ•°ï¼ˆæ¯ä¸ªæ•ˆæœç‹¬ç«‹é…ç½®ï¼‰
        function showRelevantParams() {
            const selectedEffects = Array.from(document.querySelectorAll('.skill-effect-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            dynamicParams.innerHTML = '';
            
            if (selectedEffects.length === 0) return;

            const effectsHTML = selectedEffects.map(effectKey => {
                const config = EFFECT_PARAMS_CONFIG[effectKey];
                if (!config || !config.params || config.params.length === 0) return '';
                
                const paramsHTML = config.params.map(param =>
                    generateParamHTML(param, effectKey)
                ).join('');
                
                return `
                    <div class="border border-gray-600 rounded-lg p-3 bg-gray-700/30">
                        <div class="text-sm font-bold text-blue-300 mb-2">ğŸ“‹ ${config.name}</div>
                        <div class="grid grid-cols-1 gap-3">${paramsHTML}</div>
                    </div>
                `;
            }).filter(html => html).join('');

            if (effectsHTML) {
                dynamicParams.innerHTML = effectsHTML;
                
                // ä¸ºæ¯ä¸ªæ•ˆæœæ¥æºé€‰æ‹©å™¨æ·»åŠ changeç›‘å¬å™¨ï¼Œæ›´æ–°å…¬å¼è¯´æ˜
                selectedEffects.forEach(effectKey => {
                    const sourceSelect = document.getElementById(`param-${effectKey}-effect-source`);
                    if (sourceSelect) {
                        sourceSelect.addEventListener('change', () => {
                            updateParamDescriptions(effectKey);
                            updatePreview();
                        });
                    }
                    
                    // ä¸ºç‰¹æ®Šçš„ç¬¬äºŒæ•ˆæœæ¥æºä¹Ÿæ·»åŠ ç›‘å¬å™¨ï¼ˆå¦‚é˜²å¾¡åå‡»çš„åå‡»æ•ˆæœæ¥æºï¼‰
                    const counterSourceSelect = document.getElementById(`param-${effectKey}-counter-effect-source`);
                    if (counterSourceSelect) {
                        counterSourceSelect.addEventListener('change', () => {
                            updateCounterParamDescriptions(effectKey);
                            updatePreview();
                        });
                    }
                });
            }
        }

        // æ›´æ–°å‚æ•°è¯´æ˜æ–‡æœ¬
        function updateParamDescriptions(effectKey) {
            const sourceSelect = document.getElementById(`param-${effectKey}-effect-source`);
            if (!sourceSelect) return;
            
            const sourceName = getEffectSourceName(sourceSelect.value);
            const config = EFFECT_PARAMS_CONFIG[effectKey];
            
            // æ›´æ–°è¯¥æ•ˆæœä¸‹æ‰€æœ‰å‚æ•°çš„è¯´æ˜æ–‡æœ¬
            config.params.forEach(param => {
                const descId = `desc-${effectKey}-${param}`;
                const descEl = document.getElementById(descId);
                if (descEl && sourceName) {
                    switch(param) {
                        case 'bonus':
                            descEl.textContent = `æ•ˆæœ = ${sourceName} Ã— åŠ æˆå€¼`;
                            break;
                        case 'multi-bonus':
                            descEl.textContent = `æ¯æ®µä¼¤å®³ = ${sourceName} Ã— å¯¹åº”åŠ æˆ`;
                            break;
                        case 'percent':
                            descEl.textContent = `æ•ˆæœ = ${sourceName} Ã— ç™¾åˆ†æ¯”`;
                            break;
                        case 'defense-bonus':
                            descEl.textContent = `é˜²å¾¡å€¼ = å½“å‰é˜²å¾¡ + ${sourceName} Ã— é˜²å¾¡åŠ æˆ`;
                            break;
                    }
                }
            });
        }

        // æ›´æ–°åå‡»å‚æ•°è¯´æ˜æ–‡æœ¬
        function updateCounterParamDescriptions(effectKey) {
            const counterSourceSelect = document.getElementById(`param-${effectKey}-counter-effect-source`);
            if (!counterSourceSelect) return;
            
            const counterSourceName = getEffectSourceName(counterSourceSelect.value);
            const descEl = document.getElementById(`desc-${effectKey}-counter-bonus`);
            
            if (descEl && counterSourceName) {
                descEl.textContent = `åå‡»ä¼¤å®³ = ${counterSourceName} Ã— åå‡»åŠ æˆ`;
            }
        }

        // ç”Ÿæˆå‚æ•°HTMLï¼ˆæ¯ä¸ªæ•ˆæœç‹¬ç«‹é…ç½®æ•ˆæœæ¥æºï¼‰
        function generateParamHTML(paramType, effectName) {
            const paramId = `param-${effectName}-${paramType}`;
            
            switch(paramType) {
                case 'effect-source':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">âš¡ æ•ˆæœæ¥æº</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <optgroup label="è‡ªèº«å±æ€§">
                                <option value="self-current-attack">è‡ªèº«å½“å‰æ”»å‡»åŠ›</option>
                                <option value="self-base-attack">è‡ªèº«åŸºç¡€æ”»å‡»åŠ›</option>
                                <option value="self-current-defense">è‡ªèº«å½“å‰é˜²å¾¡åŠ›</option>
                                <option value="self-base-defense">è‡ªèº«åŸºç¡€é˜²å¾¡åŠ›</option>
                                <option value="self-current-agility">è‡ªèº«å½“å‰æ•æ·</option>
                                <option value="self-base-agility">è‡ªèº«åŸºç¡€æ•æ·</option>
                                <option value="self-max-hp">è‡ªèº«æœ€å¤§ç”Ÿå‘½</option>
                                <option value="self-lost-hp">è‡ªèº«å·²æŸå¤±ç”Ÿå‘½</option>
                                <option value="self-current-hp">è‡ªèº«å‰©ä½™ç”Ÿå‘½</option>
                                <option value="self-turn-damage">è‡ªèº«å›åˆé€ æˆçš„ä¼¤å®³</option>
                            </optgroup>
                            <optgroup label="æ•Œæ–¹å±æ€§">
                                <option value="enemy-current-attack">æ•Œæ–¹å½“å‰æ”»å‡»åŠ›</option>
                                <option value="enemy-base-attack">æ•Œæ–¹åŸºç¡€æ”»å‡»åŠ›</option>
                                <option value="enemy-current-defense">æ•Œæ–¹å½“å‰é˜²å¾¡åŠ›</option>
                                <option value="enemy-base-defense">æ•Œæ–¹åŸºç¡€é˜²å¾¡åŠ›</option>
                                <option value="enemy-current-agility">æ•Œæ–¹å½“å‰æ•æ·</option>
                                <option value="enemy-base-agility">æ•Œæ–¹åŸºç¡€æ•æ·</option>
                                <option value="enemy-max-hp">æ•Œæ–¹æœ€å¤§ç”Ÿå‘½</option>
                                <option value="enemy-lost-hp">æ•Œæ–¹å·²æŸå¤±ç”Ÿå‘½</option>
                                <option value="enemy-current-hp">æ•Œæ–¹å‰©ä½™ç”Ÿå‘½</option>
                                <option value="enemy-turn-damage">æ•Œæ–¹å›åˆé€ æˆçš„ä¼¤å®³</option>
                            </optgroup>
                        </select></div>`;
                
                case 'bonus':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">åŠ æˆå€¼</label>
                        <input type="number" id="${paramId}" step="0.01" min="0" value="1.0"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p id="desc-${effectName}-bonus" class="text-xs text-gray-500 mt-1">æ•ˆæœ = æ•ˆæœæ¥æº Ã— åŠ æˆå€¼</p></div>`;
                
                case 'multi-bonus':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">å¤šæ®µåŠ æˆ(é€—å·åˆ†éš”)</label>
                        <input type="text" id="${paramId}" placeholder="ä¾‹: 0.5,0.7,1.0"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p id="desc-${effectName}-multi-bonus" class="text-xs text-gray-500 mt-1">æ¯æ®µä¼¤å®³ = æ•ˆæœæ¥æº Ã— å¯¹åº”åŠ æˆ</p></div>`;
                
                case 'percent':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">ç™¾åˆ†æ¯” (0-1)</label>
                        <input type="number" id="${paramId}" step="0.01" min="0" max="1" value="0.1"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p id="desc-${effectName}-percent" class="text-xs text-gray-500 mt-1">æ•ˆæœ = æ•ˆæœæ¥æº Ã— ç™¾åˆ†æ¯”</p></div>`;
                
                case 'defense-bonus':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">é˜²å¾¡åŠ æˆ</label>
                        <input type="number" id="${paramId}" step="0.01" min="0" value="1.0"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p id="desc-${effectName}-defense-bonus" class="text-xs text-gray-500 mt-1">é˜²å¾¡å€¼ = å½“å‰é˜²å¾¡ + æ•ˆæœæ¥æº Ã— é˜²å¾¡åŠ æˆ</p></div>`;
                
                case 'counter-effect-source':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">âš¡ åå‡»æ•ˆæœæ¥æº</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <optgroup label="è‡ªèº«å±æ€§">
                                <option value="self-current-attack">è‡ªèº«å½“å‰æ”»å‡»åŠ›</option>
                                <option value="self-base-attack">è‡ªèº«åŸºç¡€æ”»å‡»åŠ›</option>
                                <option value="self-current-defense">è‡ªèº«å½“å‰é˜²å¾¡åŠ›</option>
                                <option value="self-base-defense">è‡ªèº«åŸºç¡€é˜²å¾¡åŠ›</option>
                                <option value="self-current-agility">è‡ªèº«å½“å‰æ•æ·</option>
                                <option value="self-base-agility">è‡ªèº«åŸºç¡€æ•æ·</option>
                                <option value="self-max-hp">è‡ªèº«æœ€å¤§ç”Ÿå‘½</option>
                                <option value="self-lost-hp">è‡ªèº«å·²æŸå¤±ç”Ÿå‘½</option>
                                <option value="self-current-hp">è‡ªèº«å‰©ä½™ç”Ÿå‘½</option>
                                <option value="self-turn-damage">è‡ªèº«å›åˆé€ æˆçš„ä¼¤å®³</option>
                            </optgroup>
                            <optgroup label="æ•Œæ–¹å±æ€§">
                                <option value="enemy-current-attack">æ•Œæ–¹å½“å‰æ”»å‡»åŠ›</option>
                                <option value="enemy-base-attack">æ•Œæ–¹åŸºç¡€æ”»å‡»åŠ›</option>
                                <option value="enemy-current-defense">æ•Œæ–¹å½“å‰é˜²å¾¡åŠ›</option>
                                <option value="enemy-base-defense">æ•Œæ–¹åŸºç¡€é˜²å¾¡åŠ›</option>
                                <option value="enemy-current-agility">æ•Œæ–¹å½“å‰æ•æ·</option>
                                <option value="enemy-base-agility">æ•Œæ–¹åŸºç¡€æ•æ·</option>
                                <option value="enemy-max-hp">æ•Œæ–¹æœ€å¤§ç”Ÿå‘½</option>
                                <option value="enemy-lost-hp">æ•Œæ–¹å·²æŸå¤±ç”Ÿå‘½</option>
                                <option value="enemy-current-hp">æ•Œæ–¹å‰©ä½™ç”Ÿå‘½</option>
                                <option value="enemy-turn-damage">æ•Œæ–¹å›åˆé€ æˆçš„ä¼¤å®³</option>
                            </optgroup>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">ç”¨äºè®¡ç®—åå‡»ä¼¤å®³</p></div>`;
                
                case 'counter-bonus':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">åå‡»ä¼¤å®³åŠ æˆ</label>
                        <input type="number" id="${paramId}" step="0.01" min="0" value="0.5"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p id="desc-${effectName}-counter-bonus" class="text-xs text-gray-500 mt-1">åå‡»ä¼¤å®³ = åå‡»æ•ˆæœæ¥æº Ã— åå‡»åŠ æˆ</p></div>`;
                
                case 'damage-bonus':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">ä¼¤å®³åŠ æˆ (0-1)</label>
                        <input type="number" id="${paramId}" step="0.01" min="0" max="1" value="0.2"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p class="text-xs text-gray-500 mt-1">æœ€ç»ˆä¼¤å®³ = åŸå§‹ä¼¤å®³ Ã— (1 + åŠ æˆ)</p></div>`;
                
                case 'damage-reduce':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">ä¼¤å®³å‡å… (0-1)</label>
                        <input type="number" id="${paramId}" step="0.01" min="0" max="1" value="0.2"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        <p class="text-xs text-gray-500 mt-1">æœ€ç»ˆä¼¤å®³ = åŸå§‹ä¼¤å®³ Ã— (1 - å‡å…)</p></div>`;
                
                case 'target':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">ç›®æ ‡</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="self">è‡ªèº«</option>
                            <option value="ally-all">æˆ‘æ–¹å…¨ä½“</option>
                            <option value="enemy-single">æ•Œæ–¹å•ä½“</option>
                            <option value="enemy-all">æ•Œæ–¹å…¨ä½“</option>
                        </select></div>`;
                
                case 'status-type':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">å¼‚å¸¸çŠ¶æ€ç±»å‹</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="stun">çœ©æ™•</option>
                            <option value="poison">ä¸­æ¯’</option>
                            <option value="bleed">æµè¡€</option>
                            <option value="frostbite">å†»ä¼¤</option>
                            <option value="burn">çƒ§ä¼¤</option>
                            <option value="paralyze">éº»ç—¹</option>
                        </select></div>`;
                
                case 'status-chance':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">æ–½åŠ æ¦‚ç‡ (%)</label>
                        <input type="number" id="${paramId}" min="0" max="100" value="50"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm"></div>`;
                
                case 'purify-type':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">å¯é©±æ•£çš„å¼‚å¸¸çŠ¶æ€</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="stun">çœ©æ™•</option>
                            <option value="poison">ä¸­æ¯’</option>
                            <option value="bleed">æµè¡€</option>
                            <option value="frostbite">å†»ä¼¤</option>
                            <option value="burn">çƒ§ä¼¤</option>
                            <option value="paralyze">éº»ç—¹</option>
                        </select></div>`;
                
                case 'element-type':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">å±æ€§ç±»å‹</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="water">æ°´</option>
                            <option value="fire">ç«</option>
                            <option value="grass">è‰</option>
                            <option value="wind">é£</option>
                            <option value="electric">ç”µ</option>
                            <option value="earth">åœŸ</option>
                        </select></div>`;
                
                case 'rebirth-condition':
                    return `<div><label class="block text-xs font-medium text-gray-400 mb-1">é‡ç”Ÿæ¡ä»¶</label>
                        <select id="${paramId}" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                            <option value="death">æ­»äº¡åè§¦å‘</option>
                            <option value="low-hp">ä½ç”Ÿå‘½è§¦å‘</option>
                        </select></div>`;
                
                default:
                    return '';
            }
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const name = document.getElementById('skill-name').value;
            const icon = document.getElementById('skill-icon').value;
            const category = document.getElementById('skill-category').value;
            const type = document.getElementById('skill-type').value;
            const description = document.getElementById('skill-description').value;
            const testBtn = document.getElementById('test-skill-btn');

            if (!name) {
                preview.innerHTML = `<div class="text-center text-gray-500">
                    <div class="text-4xl mb-2">â“</div>
                    <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div></div>`;
                testBtn.classList.add('hidden');
                return;
            }

            let selectedEffects = Array.from(document.querySelectorAll('.skill-effect-checkbox:checked'))
                .map(cb => cb.value);

            const effectLabels = selectedEffects.map(effect =>
                `<span class="bg-green-600/30 text-green-300 px-2 py-1 rounded text-xs">${EFFECT_PARAMS_CONFIG[effect]?.name || effect}</span>`
            ).join(' ');

            const cooldown = document.getElementById('param-cooldown').value;
            const duration = document.getElementById('param-duration').value;
            const count = document.getElementById('param-count').value;

            let paramDesc = [];
            if (cooldown > 0) paramDesc.push(`CD:${cooldown}å›åˆ`);
            if (duration > 0) paramDesc.push(`æŒç»­:${duration}å›åˆ`);
            if (count > 1) paramDesc.push(`${count}æ¬¡`);

            preview.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="text-4xl">${icon || 'â“'}</div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                            <h4 class="text-lg font-bold text-white">${name}</h4>
                            <span class="category-badge ${category}">${getCategoryName(category)}</span>
                        </div>
                        ${description ? `<p class="text-xs text-gray-400 italic mb-2">${description}</p>` : ''}
                        ${effectLabels ? `<div class="flex flex-wrap gap-1 mb-2">${effectLabels}</div>` : ''}
                        ${paramDesc.length > 0 ? `<div class="flex flex-wrap gap-2 text-xs">
                            ${paramDesc.map(p => `<span class="bg-purple-600/30 text-purple-300 px-2 py-1 rounded">${p}</span>`).join('')}
                        </div>` : ''}
                    </div>
                </div>`;
            
            // æ˜¾ç¤º/éšè—æµ‹è¯•æŒ‰é’®ï¼ˆåªè¦æœ‰æ•ˆæœå°±æ˜¾ç¤ºï¼‰
            if (selectedEffects.length > 0) {
                testBtn.classList.remove('hidden');
            } else {
                testBtn.classList.add('hidden');
            }
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            const selectedEffects = Array.from(document.querySelectorAll('.skill-effect-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            const params = {
                cooldown: parseInt(document.getElementById('param-cooldown').value) || 0,
                duration: parseInt(document.getElementById('param-duration').value) || 0,
                count: parseInt(document.getElementById('param-count').value) || 1
            };

            selectedEffects.forEach(effectKey => {
                const config = EFFECT_PARAMS_CONFIG[effectKey];
                if (config && config.params) {
                    config.params.forEach(param => {
                        const el = document.getElementById(`param-${effectKey}-${param}`);
                        if (el) {
                            if (param === 'multi-bonus') {
                                params[`${effectKey}_${param}`] = el.value.split(',').map(v => parseFloat(v.trim()) || 1.0);
                            } else if (el.type === 'number') {
                                params[`${effectKey}_${param}`] = parseFloat(el.value) || 0;
                            } else {
                                params[`${effectKey}_${param}`] = el.value;
                            }
                        }
                    });
                }
            });

            return {
                name: document.getElementById('skill-name').value,
                icon: document.getElementById('skill-icon').value,
                description: document.getElementById('skill-description').value,
                category: document.getElementById('skill-category').value,
                type: document.getElementById('skill-type').value,
                effects: selectedEffects,
                params: params
            };
        }

        // åˆ›å»ºæŠ€èƒ½
        function createSkill() {
            const data = getFormData();
            const skillKey = `CUSTOM_${Date.now()}`;
            
            const skill = {
                key: skillKey,
                ...data,
                createdAt: new Date().toISOString()
            };

            skills.push(skill);
            saveSkillPool();
            
            renderSkillsList();
            updateSkillCount();
            form.reset();
            dynamicParams.innerHTML = '';
            updatePreview();
            
            alert(`âœ… æŠ€èƒ½ "${data.name}" å·²åˆ›å»ºï¼`);
        }

        // æ›´æ–°æŠ€èƒ½
        function updateSkill() {
            const data = getFormData();
            
            const skill = {
                key: skills[editingIndex].key,
                ...data,
                createdAt: skills[editingIndex].createdAt,
                updatedAt: new Date().toISOString()
            };

            skills[editingIndex] = skill;
            saveSkillPool();
            
            renderSkillsList();
            form.reset();
            cancelEdit();
            dynamicParams.innerHTML = '';
            updatePreview();
            
            alert(`âœ… æŠ€èƒ½ "${data.name}" å·²æ›´æ–°ï¼`);
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingIndex = -1;
            document.getElementById('submit-text').textContent = 'âœ¨ åˆ›å»ºæŠ€èƒ½';
            document.getElementById('submit-btn').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('submit-btn').classList.add('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }
        
        // ä¿å­˜æŠ€èƒ½æ± 
        function saveSkillPool() {
            localStorage.setItem('SKILL_POOL', JSON.stringify(skills));
        }

        // æ¸²æŸ“æŠ€èƒ½åˆ—è¡¨
        function renderSkillsList() {
            if (skills.length === 0) {
                skillsList.innerHTML = `<div class="text-center text-gray-500 text-sm py-8">æš‚æ— æŠ€èƒ½</div>`;
                return;
            }

            skillsList.innerHTML = skills.map((skill, index) => {
                const effects = skill.effects || [];
                const effectLabels = effects.map(effect =>
                    `<span class="bg-green-600/30 text-green-300 px-1.5 py-0.5 rounded text-xs">${EFFECT_PARAMS_CONFIG[effect]?.name || effect}</span>`
                ).join(' ');
                
                return `
                    <div class="skill-card bg-gray-800 rounded-lg p-3 border border-gray-600">
                        <div class="flex items-start gap-2">
                            <div class="text-2xl">${skill.icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <h5 class="text-sm font-bold text-white truncate">${skill.name}</h5>
                                    <span class="category-badge ${skill.category} text-xs">${getCategoryName(skill.category)}</span>
                                </div>
                                ${skill.description ? `<p class="text-xs text-gray-500 italic mb-1">${skill.description}</p>` : ''}
                                ${effectLabels ? `<div>${effectLabels}</div>` : ''}
                            </div>
                            <div class="flex gap-1 flex-shrink-0">
                                <button onclick="editSkill(${index})"
                                    class="text-blue-400 hover:text-blue-300 text-lg px-2" title="ç¼–è¾‘">âœï¸</button>
                                <button onclick="deleteSkill(${index})"
                                    class="text-red-400 hover:text-red-300 text-xl" title="åˆ é™¤">Ã—</button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }

        // åˆ é™¤æŠ€èƒ½
        function deleteSkill(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ€èƒ½å—ï¼Ÿ')) {
                skills.splice(index, 1);
                saveSkillPool();
                renderSkillsList();
                updateSkillCount();
            }
        }

        // å¯¼å‡ºæŠ€èƒ½æ± 
        function exportSkills() {
            if (skills.length === 0) {
                alert('æŠ€èƒ½æ± ä¸ºç©ºï¼');
                return;
            }

            const dataStr = JSON.stringify(skills, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `skill_pool_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æŠ€èƒ½
        function importSkills(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedSkills = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedSkills)) {
                        alert('âŒ æ— æ•ˆçš„JSONæ ¼å¼ï¼');
                        return;
                    }

                    const existingKeys = new Set(skills.map(s => s.key));
                    const newSkills = importedSkills.filter(s => !existingKeys.has(s.key));
                    
                    skills = [...skills, ...newSkills];
                    saveSkillPool();
                    
                    renderSkillsList();
                    updateSkillCount();
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${newSkills.length} ä¸ªæ–°æŠ€èƒ½ï¼`);
                } catch (error) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        }

        // è¾…åŠ©å‡½æ•°
        function getCategoryName(category) {
            const names = {
                'element-water': 'æ°´ç³»', 'element-fire': 'ç«ç³»', 'element-grass': 'è‰ç³»',
                'element-wind': 'é£ç³»', 'element-electric': 'ç”µç³»', 'element-earth': 'åœŸç³»',
                'mutation-dark': 'ğŸ–¤ é»‘åŒ–', 'mutation-light': 'ğŸ¤ ç™½åŒ–', 'mutation-crystal': 'ğŸ’ æ™¶åŒ–',
                'mutation-shadow': 'ğŸ‘¤ å½±åŒ–', 'mutation-chaos': 'ğŸŒ‘ æš—èš€', 'mutation-holy': 'âœ¨ åœ£è¾‰',
                'mutation-psychic': 'ğŸ”® å¼‚èƒ½', 'mutation-thunder': 'âš¡ æç”µ',
                'mutation-eternal-dark': 'ğŸŒ™ æ°¸å¤œ', 'mutation-eternal-light': 'â˜€ï¸ æ°¸è€€',
                'mutation-source-crystal': 'ğŸ’  æºæ™¶', 'mutation-thunder-lord': 'âš¡ é›·ç…Œ'
            };
            return names[category] || 'æœªçŸ¥';
        }

        function getEffectSourceName(source) {
            const names = {
                'self-current-attack': 'è‡ªèº«å½“å‰æ”»å‡»', 'self-base-attack': 'è‡ªèº«åŸºç¡€æ”»å‡»',
                'self-current-defense': 'è‡ªèº«å½“å‰é˜²å¾¡', 'self-base-defense': 'è‡ªèº«åŸºç¡€é˜²å¾¡',
                'self-current-agility': 'è‡ªèº«å½“å‰æ•æ·', 'self-base-agility': 'è‡ªèº«åŸºç¡€æ•æ·',
                'self-max-hp': 'è‡ªèº«æœ€å¤§ç”Ÿå‘½', 'self-lost-hp': 'è‡ªèº«å·²æŸå¤±ç”Ÿå‘½',
                'self-current-hp': 'è‡ªèº«å‰©ä½™ç”Ÿå‘½', 'self-turn-damage': 'è‡ªèº«å›åˆä¼¤å®³',
                'enemy-current-attack': 'æ•Œæ–¹å½“å‰æ”»å‡»', 'enemy-base-attack': 'æ•Œæ–¹åŸºç¡€æ”»å‡»',
                'enemy-current-defense': 'æ•Œæ–¹å½“å‰é˜²å¾¡', 'enemy-base-defense': 'æ•Œæ–¹åŸºç¡€é˜²å¾¡',
                'enemy-current-agility': 'æ•Œæ–¹å½“å‰æ•æ·', 'enemy-base-agility': 'æ•Œæ–¹åŸºç¡€æ•æ·',
                'enemy-max-hp': 'æ•Œæ–¹æœ€å¤§ç”Ÿå‘½', 'enemy-lost-hp': 'æ•Œæ–¹å·²æŸå¤±ç”Ÿå‘½',
                'enemy-current-hp': 'æ•Œæ–¹å‰©ä½™ç”Ÿå‘½', 'enemy-turn-damage': 'æ•Œæ–¹å›åˆä¼¤å®³'
            };
            return names[source] || source || 'æœªé€‰æ‹©';
        }

        // æˆ˜æ–—æµ‹è¯•ç›¸å…³
        let testSkill = null;
        let currentTurn = 1;
        let activeEffects = []; // æŒç»­æ•ˆæœåˆ—è¡¨ï¼š{ effectKey, sourceValue, params, remainingTurns }
        let battleState = {
            self: {
                hp: 1000, maxHp: 1000, attack: 100, defense: 50, agility: 80,
                baseAttack: 100, baseDefense: 50, baseAgility: 80, turnDamage: 0,
                status: [], element: 'water'
            },
            enemy: {
                hp: 800, maxHp: 800, attack: 90, defense: 40, agility: 70,
                baseAttack: 90, baseDefense: 40, baseAgility: 70, turnDamage: 0,
                status: [], element: 'fire'
            }
        };

        // å¼‚å¸¸çŠ¶æ€åç§°æ˜ å°„
        const statusNames = {
            'stun': 'ğŸ˜µ çœ©æ™•',
            'poison': 'ğŸ¤¢ ä¸­æ¯’',
            'bleed': 'ğŸ©¸ æµè¡€',
            'frostbite': 'â„ï¸ å†»ä¼¤',
            'burn': 'ğŸ”¥ ç¼çƒ§',
            'paralyze': 'âš¡ éº»ç—¹',
            'no-heal': 'ğŸš« ç¦ç–—',
            'heal-reduce': 'ğŸ“‰ å‡ç–—'
        };

        let selectedTestSkills = [];

        function setupTestButton() {
            document.getElementById('test-skill-btn').onclick = () => {
                openTestModal();
            };
            document.getElementById('close-test-modal').onclick = closeTestModal;
            document.getElementById('test-modal').onclick = (e) => {
                if (e.target.id === 'test-modal') closeTestModal();
            };
            document.getElementById('use-skill-btn').onclick = useSelectedSkill;
            document.getElementById('use-all-skills-btn').onclick = useAllSkills;
            document.getElementById('enemy-attack-btn').onclick = enemyAttack;
            document.getElementById('next-turn-btn').onclick = nextTurn;
            document.getElementById('reset-battle-btn').onclick = resetBattle;
            
            // ä¸ºè‡ªå®šä¹‰å±æ€§è¾“å…¥æ¡†æ·»åŠ å®æ—¶æ›´æ–°ç›‘å¬å™¨
            setupConfigInputListeners();
        }
        
        function setupConfigInputListeners() {
            // æˆ‘æ–¹å±æ€§è¾“å…¥æ¡†
            const selfInputs = [
                { id: 'config-self-hp', key: 'hp', type: 'self', updateMax: true },
                { id: 'config-self-attack', key: 'attack', type: 'self' },
                { id: 'config-self-defense', key: 'defense', type: 'self' },
                { id: 'config-self-agility', key: 'agility', type: 'self' }
            ];
            
            // æ•Œæ–¹å±æ€§è¾“å…¥æ¡†
            const enemyInputs = [
                { id: 'config-enemy-hp', key: 'hp', type: 'enemy', updateMax: true },
                { id: 'config-enemy-attack', key: 'attack', type: 'enemy' },
                { id: 'config-enemy-defense', key: 'defense', type: 'enemy' },
                { id: 'config-enemy-agility', key: 'agility', type: 'enemy' }
            ];
            
            const allInputs = [...selfInputs, ...enemyInputs];
            
            allInputs.forEach(({ id, key, type, updateMax }) => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        const value = parseInt(input.value) || 0;
                        if (battleState[type]) {
                            battleState[type][key] = value;
                            if (updateMax) {
                                battleState[type].maxHp = value;
                            }
                            // åŒæ—¶æ›´æ–°åŸºç¡€å±æ€§ï¼ˆå¯¹äºæ”»å‡»ã€é˜²å¾¡ã€æ•æ·ï¼‰
                            if (key === 'attack') battleState[type].baseAttack = value;
                            if (key === 'defense') battleState[type].baseDefense = value;
                            if (key === 'agility') battleState[type].baseAgility = value;
                            
                            updateBattleUI();
                            addLog(`âš™ï¸ å±æ€§å·²æ›´æ–°: ${type === 'self' ? 'æˆ‘æ–¹' : 'æ•Œæ–¹'}${getAttributeName(key)} = ${value}`, 'cyan');
                        }
                    });
                }
            });
        }
        
        function getAttributeName(key) {
            const names = {
                'hp': 'ç”Ÿå‘½å€¼',
                'attack': 'æ”»å‡»åŠ›',
                'defense': 'é˜²å¾¡åŠ›',
                'agility': 'æ•æ·'
            };
            return names[key] || key;
        }

        function enemyAttack() {
            addLog(`â”â”â”â”â” æ•Œäººå›åˆ â”â”â”â”â”`, 'red');
            
            // è®¡ç®—æ•Œäººçš„æ”»å‡»ä¼¤å®³
            const rawDamage = battleState.enemy.attack;
            const actualDamage = Math.max(1, rawDamage - battleState.self.defense);
            
            battleState.self.hp -= actualDamage;
            battleState.enemy.turnDamage += actualDamage;
            
            addLog(`æ•Œäººæ”»å‡»: ${rawDamage} - ${battleState.self.defense}(æˆ‘æ–¹é˜²å¾¡) = ${actualDamage} ç‚¹ä¼¤å®³`, 'red');
            
            updateBattleUI();
            
            if (battleState.self.hp <= 0) {
                addLog('ğŸ’€ æˆ‘æ–¹è¢«å‡»è´¥ï¼', 'red');
            }
        }

        function openTestModal() {
            document.getElementById('test-modal').classList.remove('hidden');
            resetBattle();
            updateTestSkillsList();
        }

        function closeTestModal() {
            document.getElementById('test-modal').classList.add('hidden');
        }

        function updateTestSkillsList() {
            // è·å–å½“å‰ç¼–è¾‘çš„æŠ€èƒ½
            const currentSkill = getFormData();
            
            // åˆå¹¶å·²ä¿å­˜çš„æŠ€èƒ½å’Œå½“å‰ç¼–è¾‘çš„æŠ€èƒ½
            const allSkills = [...skills];
            if (currentSkill.name && currentSkill.effects.length > 0) {
                allSkills.push({...currentSkill, key: 'CURRENT', name: `[å½“å‰] ${currentSkill.name}`});
            }
            
            if (allSkills.length === 0) {
                document.getElementById('test-skills-selector').innerHTML =
                    '<div class="text-center text-gray-500 text-sm py-4">æš‚æ— å¯æµ‹è¯•çš„æŠ€èƒ½</div>';
                return;
            }
            
            const skillsHTML = allSkills.map((skill, index) => {
                const effectLabels = (skill.effects || []).map(e =>
                    EFFECT_PARAMS_CONFIG[e]?.name || e
                ).join('ã€');
                
                return `
                    <label class="flex items-start gap-3 p-3 bg-gray-800 hover:bg-gray-700 rounded-lg cursor-pointer border border-gray-600">
                        <input type="checkbox" value="${index}" class="test-skill-checkbox mt-1" onchange="updateUseSkillButton()">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xl">${skill.icon}</span>
                                <span class="font-bold text-white text-sm">${skill.name}</span>
                                <span class="category-badge ${skill.category} text-xs">${getCategoryName(skill.category)}</span>
                            </div>
                            <div class="text-xs text-gray-400">${effectLabels}</div>
                        </div>
                    </label>
                `;
            }).join('');
            
            document.getElementById('test-skills-selector').innerHTML = skillsHTML;
            selectedTestSkills = allSkills;
        }

        function updateUseSkillButton() {
            const selected = document.querySelectorAll('.test-skill-checkbox:checked');
            const useBtn = document.getElementById('use-skill-btn');
            const useAllBtn = document.getElementById('use-all-skills-btn');
            
            if (selected.length === 0) {
                useBtn.disabled = true;
                useAllBtn.disabled = true;
            } else if (selected.length === 1) {
                useBtn.disabled = false;
                useAllBtn.disabled = true;
            } else {
                useBtn.disabled = false;
                useAllBtn.disabled = false;
            }
        }

        function useSelectedSkill() {
            const selected = Array.from(document.querySelectorAll('.test-skill-checkbox:checked'));
            if (selected.length === 0) return;
            
            const skillIndex = parseInt(selected[0].value);
            testSkill = selectedTestSkills[skillIndex];
            useSkill();
        }

        function useAllSkills() {
            const selected = Array.from(document.querySelectorAll('.test-skill-checkbox:checked'));
            if (selected.length === 0) return;
            
            addLog(`â”â”â”â”â” è¿ç»­ä½¿ç”¨ ${selected.length} ä¸ªæŠ€èƒ½ â”â”â”â”â”`, 'blue');
            
            selected.forEach((checkbox, i) => {
                const skillIndex = parseInt(checkbox.value);
                testSkill = selectedTestSkills[skillIndex];
                addLog(`\nã€æŠ€èƒ½ ${i+1}/${selected.length}ã€‘`, 'blue');
                useSkillInternal();
            });
            
            updateBattleUI();
            if (battleState.enemy.hp <= 0) {
                addLog('ğŸ’€ æ•Œäººè¢«å‡»è´¥ï¼', 'red');
            }
        }

        function resetBattle() {
            currentTurn = 1;
            activeEffects = [];
            
            const selfElement = document.getElementById('self-element')?.value || 'water';
            const enemyElement = document.getElementById('enemy-element')?.value || 'fire';
            
            // è¯»å–è‡ªå®šä¹‰å±æ€§
            const selfHp = parseInt(document.getElementById('config-self-hp')?.value) || 1000;
            const selfAttack = parseInt(document.getElementById('config-self-attack')?.value) || 100;
            const selfDefense = parseInt(document.getElementById('config-self-defense')?.value) || 50;
            const selfAgility = parseInt(document.getElementById('config-self-agility')?.value) || 80;
            
            const enemyHp = parseInt(document.getElementById('config-enemy-hp')?.value) || 800;
            const enemyAttack = parseInt(document.getElementById('config-enemy-attack')?.value) || 90;
            const enemyDefense = parseInt(document.getElementById('config-enemy-defense')?.value) || 40;
            const enemyAgility = parseInt(document.getElementById('config-enemy-agility')?.value) || 70;
            
            battleState = {
                self: {
                    hp: selfHp, maxHp: selfHp, attack: selfAttack, defense: selfDefense, agility: selfAgility,
                    baseAttack: selfAttack, baseDefense: selfDefense, baseAgility: selfAgility, turnDamage: 0,
                    status: [], element: selfElement,
                    elementDamageBonus: {}
                },
                enemy: {
                    hp: enemyHp, maxHp: enemyHp, attack: enemyAttack, defense: enemyDefense, agility: enemyAgility,
                    baseAttack: enemyAttack, baseDefense: enemyDefense, baseAgility: enemyAgility, turnDamage: 0,
                    status: [], element: enemyElement,
                    elementDamageReduce: {}
                }
            };
            updateBattleUI();
            updateTurnDisplay();
            document.getElementById('battle-log').innerHTML = '<div class="text-center text-gray-500">æˆ˜æ–—å·²é‡ç½®ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•æŠ€èƒ½</div>';
        }

        function nextTurn() {
            currentTurn++;
            battleState.self.turnDamage = 0;
            battleState.enemy.turnDamage = 0;
            
            addLog(`â”â”â”â”â” ç¬¬${currentTurn}å›åˆå¼€å§‹ â”â”â”â”â”`, 'blue');
            
            // æ¸…é™¤ä¸´æ—¶å¢ç›Šæ•ˆæœï¼ˆduration=0çš„æ•ˆæœï¼‰
            clearTemporaryBuffs();
            
            // å¤„ç†æŒç»­æ•ˆæœ
            if (activeEffects.length > 0) {
                addLog(`è§¦å‘ ${activeEffects.length} ä¸ªæŒç»­æ•ˆæœ`, 'yellow');
                
                activeEffects.forEach(effect => {
                    addLog(`[${EFFECT_PARAMS_CONFIG[effect.effectKey]?.name}] å‰©ä½™${effect.remainingTurns}å›åˆ`, 'yellow');
                    
                    if (effect.isTempBuff) {
                        // ä¸´æ—¶å¢ç›Šæ•ˆæœï¼ˆå±æ€§å¢ä¼¤/å‡ä¼¤ï¼‰åªåœ¨å›åˆç»“æŸæ—¶æ¸…é™¤ï¼Œä¸éœ€è¦æ¯å›åˆè§¦å‘
                        addLog(`â†’ ä¸´æ—¶å¢ç›Šæ•ˆæœä¿æŒä¸­`, 'cyan');
                    } else {
                        testSkill = effect.skill; // ä¸´æ—¶è®¾ç½®æŠ€èƒ½ä»¥ä¾¿applyEffectä½¿ç”¨
                        
                        // å¯¹äºåŸºç¡€å±æ€§ï¼Œä½¿ç”¨é”å®šçš„åˆå§‹å€¼ï¼›å¯¹äºå½“å‰å±æ€§ï¼Œé‡æ–°è®¡ç®—
                        let effectValue;
                        if (effect.effectSource && effect.effectSource.includes('base')) {
                            effectValue = effect.lockedSourceValue;
                            addLog(`â†’ ä½¿ç”¨é”å®šçš„åŸºç¡€å€¼: ${Math.round(effectValue)}`, 'cyan');
                        } else {
                            effectValue = getEffectSourceValue(effect.effectSource);
                            addLog(`â†’ é‡æ–°è®¡ç®—å½“å‰å€¼: ${Math.round(effectValue)}`, 'yellow');
                        }
                        
                        applyEffect(effect.effectKey, effectValue, effect.count);
                    }
                });
                
                // å‡å°‘å›åˆæ•°å¹¶ç§»é™¤å·²ç»“æŸçš„æ•ˆæœ
                const beforeCount = activeEffects.length;
                activeEffects = activeEffects.map(effect => ({
                    ...effect,
                    remainingTurns: effect.remainingTurns - 1
                })).filter(effect => {
                    if (effect.remainingTurns > 0) {
                        return true;
                    } else {
                        // æ¸…é™¤è¿‡æœŸçš„ä¸´æ—¶å¢ç›Šæ•ˆæœ
                        if (effect.isTempBuff) {
                            testSkill = effect.skill;
                            const params = testSkill.params;
                            if (effect.effectKey === 'buff_element_damage') {
                                const elementType = params[`${effect.effectKey}_element-type`] || 'fire';
                                if (battleState.self.elementDamageBonus) {
                                    delete battleState.self.elementDamageBonus[elementType];
                                }
                                addLog(`Ã— å±æ€§å¢ä¼¤æ•ˆæœå·²ç»“æŸ(${getElementName(elementType)}ç³»)`, 'gray');
                            } else if (effect.effectKey === 'debuff_element_damage') {
                                const elementType = params[`${effect.effectKey}_element-type`] || 'fire';
                                if (battleState.enemy.elementDamageReduce) {
                                    delete battleState.enemy.elementDamageReduce[elementType];
                                }
                                addLog(`Ã— å±æ€§å‡ä¼¤æ•ˆæœå·²ç»“æŸ(${getElementName(elementType)}ç³»)`, 'gray');
                            }
                        }
                        return false;
                    }
                });
                
                if (beforeCount !== activeEffects.length) {
                    addLog(`${beforeCount - activeEffects.length} ä¸ªæ•ˆæœå·²ç»“æŸ`, 'gray');
                }
                addLog(`æŒç»­æ•ˆæœå¤„ç†å®Œæˆï¼Œå‰©ä½™ ${activeEffects.length} ä¸ª`, 'gray');
            } else {
                addLog('æ— æŒç»­æ•ˆæœ', 'gray');
            }
            
            updateBattleUI();
            updateTurnDisplay();
            
            if (battleState.enemy.hp <= 0) {
                addLog('ğŸ’€ æ•Œäººè¢«å‡»è´¥ï¼', 'red');
            }
            addLog(`â”â”â”â”â” ç¬¬${currentTurn}å›åˆç»“æŸ â”â”â”â”â”`, 'blue');
        }

        function updateTurnDisplay() {
            document.getElementById('current-turn').textContent = currentTurn;
            document.getElementById('active-effects-count').textContent = activeEffects.length;
        }

        function updateBattleUI() {
            // æ›´æ–°æˆ‘æ–¹
            document.getElementById('self-hp').textContent = Math.max(0, Math.round(battleState.self.hp));
            document.getElementById('self-max-hp').textContent = battleState.self.maxHp;
            document.getElementById('self-attack').textContent = Math.round(battleState.self.attack);
            document.getElementById('self-defense').textContent = Math.round(battleState.self.defense);
            document.getElementById('self-agility').textContent = Math.round(battleState.self.agility);
            const selfHpPercent = (battleState.self.hp / battleState.self.maxHp) * 100;
            document.getElementById('self-hp-bar').style.width = Math.max(0, selfHpPercent) + '%';

            // æ›´æ–°æˆ‘æ–¹å¼‚å¸¸çŠ¶æ€
            const selfStatusEl = document.getElementById('self-status');
            if (battleState.self.status.length === 0) {
                selfStatusEl.innerHTML = '<span class="text-xs text-gray-500">æ— </span>';
            } else {
                selfStatusEl.innerHTML = battleState.self.status.map(s =>
                    `<span class="bg-red-500/30 text-red-300 px-2 py-0.5 rounded text-xs">${statusNames[s] || s}</span>`
                ).join('');
            }

            // æ›´æ–°æ•Œæ–¹
            document.getElementById('enemy-hp').textContent = Math.max(0, Math.round(battleState.enemy.hp));
            document.getElementById('enemy-max-hp').textContent = battleState.enemy.maxHp;
            document.getElementById('enemy-attack').textContent = Math.round(battleState.enemy.attack);
            document.getElementById('enemy-defense').textContent = Math.round(battleState.enemy.defense);
            document.getElementById('enemy-agility').textContent = Math.round(battleState.enemy.agility);
            const enemyHpPercent = (battleState.enemy.hp / battleState.enemy.maxHp) * 100;
            document.getElementById('enemy-hp-bar').style.width = Math.max(0, enemyHpPercent) + '%';

            // æ›´æ–°æ•Œæ–¹å¼‚å¸¸çŠ¶æ€
            const enemyStatusEl = document.getElementById('enemy-status');
            if (battleState.enemy.status.length === 0) {
                enemyStatusEl.innerHTML = '<span class="text-xs text-gray-500">æ— </span>';
            } else {
                enemyStatusEl.innerHTML = battleState.enemy.status.map(s =>
                    `<span class="bg-red-500/30 text-red-300 px-2 py-0.5 rounded text-xs">${statusNames[s] || s}</span>`
                ).join('');
            }

            // æ›´æ–°å›åˆä¿¡æ¯
            updateTurnDisplay();
        }

        function addLog(message, color = 'white') {
            const log = document.getElementById('battle-log');
            if (log.querySelector('.text-gray-500')) {
                log.innerHTML = '';
            }
            const entry = document.createElement('div');
            entry.className = `text-${color}-400`;
            entry.textContent = `â–¸ ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function getEffectSourceValue(sourceKey) {
            const mapping = {
                'self-current-attack': battleState.self.attack,
                'self-base-attack': battleState.self.baseAttack,
                'self-current-defense': battleState.self.defense,
                'self-base-defense': battleState.self.baseDefense,
                'self-current-agility': battleState.self.agility,
                'self-base-agility': battleState.self.baseAgility,
                'self-max-hp': battleState.self.maxHp,
                'self-lost-hp': battleState.self.maxHp - battleState.self.hp,
                'self-current-hp': battleState.self.hp,
                'self-turn-damage': battleState.self.turnDamage,
                'enemy-current-attack': battleState.enemy.attack,
                'enemy-base-attack': battleState.enemy.baseAttack,
                'enemy-current-defense': battleState.enemy.defense,
                'enemy-base-defense': battleState.enemy.baseDefense,
                'enemy-current-agility': battleState.enemy.agility,
                'enemy-base-agility': battleState.enemy.baseAgility,
                'enemy-max-hp': battleState.enemy.maxHp,
                'enemy-lost-hp': battleState.enemy.maxHp - battleState.enemy.hp,
                'enemy-current-hp': battleState.enemy.hp,
                'enemy-turn-damage': battleState.enemy.turnDamage
            };
            return mapping[sourceKey] || 0;
        }

        function useSkill() {
            useSkillInternal();
            updateBattleUI();
            if (battleState.enemy.hp <= 0) {
                addLog('ğŸ’€ æ•Œäººè¢«å‡»è´¥ï¼', 'red');
            }
            addLog(`â”â”â”â”â” å›åˆç»“æŸ â”â”â”â”â”`, 'blue');
        }

        function useSkillInternal() {
            const count = testSkill.params.count || 1;
            addLog(`ä½¿ç”¨æŠ€èƒ½ã€${testSkill.name}ã€‘`, 'blue');
            if (count > 1) {
                addLog(`æ¯å›åˆæ¬¡æ•°: ${count}`, 'yellow');
            }

            // æŒ‰å›åˆæ‰§è¡Œé¡ºåºæ’åºæ•ˆæœ
            const effectPriority = {
                // ç¬¬ä¸€é˜¶æ®µï¼šå‡€åŒ–ï¼ˆå›åˆå¼€å§‹æœ€å…ˆç”Ÿæ•ˆï¼‰
                'buff_purify': 1,
                
                // ç¬¬äºŒé˜¶æ®µï¼šè¾…åŠ©çŠ¶æ€æ•ˆæœï¼ˆå¼‚å¸¸çŠ¶æ€ã€ç¦ç–—ã€å‡ç–—ç­‰ï¼Œåœ¨æ²»ç–—å‰ç”Ÿæ•ˆï¼‰
                'buff_status_enemy': 2, 'debuff_status_self': 2,
                'debuff_no_heal': 2, 'debuff_heal_reduce': 2,
                'buff_heal_amp': 2, 'buff_element_damage': 2, 'debuff_element_damage': 2,
                
                // ç¬¬ä¸‰é˜¶æ®µï¼šæ²»ç–—ç±»ï¼ˆå›åˆå¼€å§‹æ—¶å¦‚æœä¸æ»¡è¡€åˆ™ç”Ÿæ•ˆï¼‰
                'heal_direct': 3, 'heal_continuous': 3, 'heal_percent': 3, 'heal_rebirth': 3,
                
                // ç¬¬å››é˜¶æ®µï¼šå±æ€§å¢ç›Š/å‡ç›Š
                'buff_attack': 4, 'buff_defense': 4, 'buff_speed': 4,
                'debuff_attack': 4, 'debuff_defense': 4, 'debuff_speed': 4,
                'direct_speed': 4, 'continuous_speed': 4,
                
                // ç¬¬äº”é˜¶æ®µï¼šé˜²å¾¡ç±»
                'direct_defense': 5, 'continuous_defense': 5, 'defense_counter': 5,
                
                // ç¬¬å…­é˜¶æ®µï¼šä¼¤å®³ç±»
                'direct_attack': 6, 'multi_attack': 6, 'dot_damage': 6, 'percent_damage': 6,
                
                // ç¬¬ä¸ƒé˜¶æ®µï¼šç”Ÿå‘½æ±²å–ï¼ˆåŸºäºé€ æˆçš„ä¼¤å®³ï¼‰
                'heal_lifesteal': 7
            };

            // å¯¹æ•ˆæœæŒ‰ä¼˜å…ˆçº§æ’åº
            const sortedEffects = [...testSkill.effects].sort((a, b) => {
                return (effectPriority[a] || 99) - (effectPriority[b] || 99);
            });

            addLog(`â” æ‰§è¡Œé¡ºåº: ${sortedEffects.map(e => EFFECT_PARAMS_CONFIG[e]?.name || e).join(' â†’ ')}`, 'gray');

            const duration = testSkill.params.duration || 0;

            sortedEffects.forEach(effectKey => {
                // æŸäº›æ•ˆæœä¸éœ€è¦æ•ˆæœæ¥æº
                const noSourceEffects = ['buff_status_enemy', 'debuff_status_self', 'buff_purify', 'debuff_no_heal'];
                const tempBuffEffects = ['buff_element_damage', 'debuff_element_damage']; // ä¸´æ—¶å¢ç›Šæ•ˆæœ
                
                let sourceValue = 0;
                if (!noSourceEffects.includes(effectKey) && !tempBuffEffects.includes(effectKey)) {
                    const effectSource = testSkill.params[`${effectKey}_effect-source`];
                    sourceValue = getEffectSourceValue(effectSource);
                    addLog(`[${EFFECT_PARAMS_CONFIG[effectKey]?.name}] æ•ˆæœæ¥æº: ${getEffectSourceName(effectSource)} = ${Math.round(sourceValue)}`, 'yellow');
                } else {
                    addLog(`[${EFFECT_PARAMS_CONFIG[effectKey]?.name}]`, 'yellow');
                }
                
                // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ•ˆæœ
                applyEffect(effectKey, sourceValue, count);
                
                // å¦‚æœæœ‰æŒç»­å›åˆï¼Œæ·»åŠ åˆ°æŒç»­æ•ˆæœåˆ—è¡¨
                if (duration > 0) {
                    if (!noSourceEffects.includes(effectKey) && !tempBuffEffects.includes(effectKey)) {
                        // æœ‰æ•ˆæœæ¥æºçš„æŒç»­æ•ˆæœ
                        const effectSource = testSkill.params[`${effectKey}_effect-source`];
                        activeEffects.push({
                            effectKey: effectKey,
                            effectSource: effectSource,
                            lockedSourceValue: sourceValue,
                            count: count,
                            skill: testSkill,
                            remainingTurns: duration
                        });
                        addLog(`â†’ ${EFFECT_PARAMS_CONFIG[effectKey]?.name} å°†æŒç»­ ${duration} å›åˆï¼ˆé”å®šæ¥æºå€¼ï¼š${Math.round(sourceValue)}ï¼‰`, 'cyan');
                    } else if (tempBuffEffects.includes(effectKey)) {
                        // ä¸´æ—¶å¢ç›Šæ•ˆæœï¼ˆå±æ€§å¢ä¼¤/å‡ä¼¤ï¼‰
                        activeEffects.push({
                            effectKey: effectKey,
                            effectSource: null,
                            lockedSourceValue: 0,
                            count: 0,
                            skill: testSkill,
                            remainingTurns: duration,
                            isTempBuff: true // æ ‡è®°ä¸ºä¸´æ—¶å¢ç›Š
                        });
                        addLog(`â†’ ${EFFECT_PARAMS_CONFIG[effectKey]?.name} å°†æŒç»­ ${duration} å›åˆ`, 'cyan');
                    }
                }
            });
            
            updateTurnDisplay();
        }

        function applyEffect(effectKey, sourceValue, count) {
            const config = EFFECT_PARAMS_CONFIG[effectKey];
            if (!config) return;
            const params = testSkill.params;

            // åˆ¤æ–­æ˜¯å¦åŸºäºæ”»å‡»åŠ›
            const effectSource = testSkill.params[`${effectKey}_effect-source`];
            const isAttackBased = effectSource && (
                effectSource.includes('attack') ||
                effectSource === 'self-current-attack' ||
                effectSource === 'self-base-attack' ||
                effectSource === 'enemy-current-attack' ||
                effectSource === 'enemy-base-attack'
            );

            switch(effectKey) {
                case 'direct_attack': {
                    // ç›´æ¥æ”»å‡»ï¼šå¦‚æœåŸºäºæ”»å‡»åŠ›åˆ™è®¡ç®—é˜²å¾¡ï¼Œå¦åˆ™ç›´æ¥ä¼¤å®³
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const rawDamage = Math.round(sourceValue * bonus);
                    let actualDamage;
                    
                    if (isAttackBased) {
                        actualDamage = Math.max(1, rawDamage - battleState.enemy.defense);
                        addLog(`ç›´æ¥æ”»å‡»: ${rawDamage} - ${battleState.enemy.defense}(é˜²å¾¡) = ${actualDamage} ç‚¹ä¼¤å®³`, 'red');
                    } else {
                        actualDamage = rawDamage;
                        addLog(`ç›´æ¥æ”»å‡»: ${actualDamage} ç‚¹ä¼¤å®³ (${Math.round(sourceValue)} Ã— ${bonus})`, 'red');
                    }
                    
                    // åº”ç”¨å±æ€§å¢ä¼¤/å‡ä¼¤
                    actualDamage = applyElementDamageModifiers(actualDamage);
                    
                    battleState.enemy.hp -= actualDamage;
                    battleState.self.turnDamage += actualDamage;
                    break;
                }
                case 'multi_attack': {
                    // å¤šæ®µæ”»å‡»ï¼šå¦‚æœåŸºäºæ”»å‡»åŠ›åˆ™æ¯æ®µè®¡ç®—é˜²å¾¡
                    const bonuses = params[`${effectKey}_multi-bonus`] || [1];
                    let totalDamage = 0;
                    
                    bonuses.forEach((bonus, i) => {
                        const rawDamage = Math.round(sourceValue * bonus);
                        let actualDamage;
                        
                        if (isAttackBased) {
                            actualDamage = Math.max(1, rawDamage - battleState.enemy.defense);
                            addLog(`å¤šæ®µæ”»å‡»-ç¬¬${i+1}æ®µ: ${rawDamage} - ${battleState.enemy.defense} = ${actualDamage} ç‚¹ä¼¤å®³`, 'red');
                        } else {
                            actualDamage = rawDamage;
                            addLog(`å¤šæ®µæ”»å‡»-ç¬¬${i+1}æ®µ: ${actualDamage} ç‚¹ä¼¤å®³`, 'red');
                        }
                        
                        totalDamage += actualDamage;
                    });
                    
                    // åº”ç”¨å±æ€§å¢ä¼¤/å‡ä¼¤
                    totalDamage = applyElementDamageModifiers(totalDamage);
                    
                    battleState.enemy.hp -= totalDamage;
                    battleState.self.turnDamage += totalDamage;
                    addLog(`å¤šæ®µæ”»å‡»æ€»è®¡: ${totalDamage} ç‚¹ä¼¤å®³`, 'red');
                    break;
                }
                case 'dot_damage': {
                    // é™„åŠ ä¼¤å®³ï¼šå¦‚æœåŸºäºæ”»å‡»åŠ›åˆ™è®¡ç®—é˜²å¾¡
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const rawDamage = Math.round(sourceValue * count * bonus);
                    let actualDamage;
                    
                    if (isAttackBased) {
                        actualDamage = Math.max(1, rawDamage - battleState.enemy.defense);
                        addLog(`é™„åŠ ä¼¤å®³: ${rawDamage} - ${battleState.enemy.defense} = ${actualDamage} ç‚¹ä¼¤å®³`, 'red');
                    } else {
                        actualDamage = rawDamage;
                        addLog(`é™„åŠ ä¼¤å®³: ${actualDamage} ç‚¹ä¼¤å®³`, 'red');
                    }
                    
                    // åº”ç”¨å±æ€§å¢ä¼¤/å‡ä¼¤
                    actualDamage = applyElementDamageModifiers(actualDamage);
                    
                    battleState.enemy.hp -= actualDamage;
                    battleState.self.turnDamage += actualDamage;
                    break;
                }
                case 'percent_damage': {
                    // ç™¾åˆ†æ¯”ä¼¤å®³ï¼šå§‹ç»ˆä¸ºçœŸå®ä¼¤å®³
                    const percent = params[`${effectKey}_percent`] || 0.1;
                    let damage = Math.round(sourceValue * count * percent);
                    
                    // åº”ç”¨å±æ€§å¢ä¼¤/å‡ä¼¤
                    damage = applyElementDamageModifiers(damage);
                    
                    battleState.enemy.hp -= damage;
                    battleState.self.turnDamage += damage;
                    addLog(`ç™¾åˆ†æ¯”ä¼¤å®³: ${damage} ç‚¹çœŸå®ä¼¤å®³`, 'red');
                    break;
                }
                case 'buff_attack': {
                    // å¢æ”»ï¼šæ”»å‡»åŠ›=æ•ˆæœæ¥æº*å¢æ”»åŠ æˆ
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const increase = Math.round(sourceValue * bonus);
                    if (target === 'self' || target === 'ally-all') {
                        battleState.self.attack += increase;
                        addLog(`å¢æ”»: æˆ‘æ–¹æ”»å‡»åŠ› +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    }
                    break;
                }
                case 'buff_defense': {
                    // å¢é˜²ï¼šé˜²å¾¡åŠ›=æ•ˆæœæ¥æº*å¢é˜²åŠ æˆ
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const increase = Math.round(sourceValue * bonus);
                    if (target === 'self' || target === 'ally-all') {
                        battleState.self.defense += increase;
                        addLog(`å¢é˜²: æˆ‘æ–¹é˜²å¾¡åŠ› +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    }
                    break;
                }
                case 'buff_speed': {
                    // å¢é€Ÿï¼šæ•æ·åŠ›=æ•ˆæœæ¥æº*å¢é€ŸåŠ æˆ
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const increase = Math.round(sourceValue * bonus);
                    if (target === 'self' || target === 'ally-all') {
                        battleState.self.agility += increase;
                        addLog(`å¢é€Ÿ: æˆ‘æ–¹æ•æ· +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    }
                    break;
                }
                case 'direct_defense': {
                    // ç›´æ¥é˜²å¾¡ï¼šé˜²å¾¡å€¼=å½“å‰é˜²å¾¡å€¼+æ•ˆæœæ¥æº*é˜²å¾¡åŠ æˆ
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const increase = Math.round(sourceValue * bonus);
                    battleState.self.defense += increase;
                    addLog(`ç›´æ¥é˜²å¾¡: æˆ‘æ–¹é˜²å¾¡åŠ› +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    break;
                }
                case 'continuous_defense': {
                    // æŒç»­é˜²å¾¡ï¼šé˜²å¾¡å€¼=å½“å‰é˜²å¾¡å€¼+æ•ˆæœæ¥æº*é˜²å¾¡åŠ æˆ
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const increase = Math.round(sourceValue * bonus);
                    battleState.self.defense += increase;
                    addLog(`æŒç»­é˜²å¾¡: æˆ‘æ–¹é˜²å¾¡åŠ› +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    break;
                }
                case 'defense_counter': {
                    // é˜²å¾¡åå‡»ï¼šä½¿ç”¨é˜²å¾¡æ•ˆæœæ¥æºå¢åŠ é˜²å¾¡ï¼Œä½¿ç”¨åå‡»æ•ˆæœæ¥æºè®¡ç®—åå‡»ä¼¤å®³
                    const defBonus = params[`${effectKey}_defense-bonus`] || 1;
                    const counterBonus = params[`${effectKey}_counter-bonus`] || 0.5;
                    
                    // é˜²å¾¡éƒ¨åˆ†ï¼šä½¿ç”¨é˜²å¾¡æ•ˆæœæ¥æº
                    const defIncrease = Math.round(sourceValue * defBonus);
                    battleState.self.defense += defIncrease;
                    addLog(`é˜²å¾¡åå‡»-é˜²å¾¡: é˜²å¾¡åŠ› +${defIncrease} (${Math.round(sourceValue)} Ã— ${defBonus})`, 'green');
                    
                    // åå‡»éƒ¨åˆ†ï¼šä½¿ç”¨åå‡»æ•ˆæœæ¥æº
                    const counterSource = params[`${effectKey}_counter-effect-source`];
                    const counterSourceValue = getEffectSourceValue(counterSource);
                    const counterDamage = Math.round(counterSourceValue * counterBonus);
                    
                    battleState.enemy.hp -= counterDamage;
                    battleState.self.turnDamage += counterDamage;
                    addLog(`é˜²å¾¡åå‡»-åå‡»: é€ æˆ ${counterDamage} ç‚¹ä¼¤å®³ (${Math.round(counterSourceValue)} Ã— ${counterBonus})`, 'red');
                    break;
                }
                case 'direct_speed': {
                    // ç›´æ¥å¢é€Ÿï¼šæ•æ·=å½“å‰æ•æ·å€¼+æ•ˆæœæ¥æº*å¢é€ŸåŠ æˆ
                    const bonus = params[`${effectKey}_bonus`] || 0.2;
                    const increase = Math.round(sourceValue * bonus);
                    battleState.self.agility += increase;
                    addLog(`ç›´æ¥å¢é€Ÿ: æˆ‘æ–¹æ•æ· +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    break;
                }
                case 'continuous_speed': {
                    // æŒç»­å¢é€Ÿï¼šæ•æ·=å½“å‰æ•æ·å€¼+æ•ˆæœæ¥æº*å¢é€ŸåŠ æˆ
                    const bonus = params[`${effectKey}_bonus`] || 0.2;
                    const increase = Math.round(sourceValue * bonus);
                    battleState.self.agility += increase;
                    addLog(`æŒç»­å¢é€Ÿ: æˆ‘æ–¹æ•æ· +${increase} (${Math.round(sourceValue)} Ã— ${bonus})`, 'green');
                    break;
                }
                case 'debuff_attack': {
                    // å‡æ”»ï¼šæ”»å‡»åŠ›=æ•ˆæœæ¥æº*å‡æ”»åŠ æˆ
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const decrease = Math.round(sourceValue * bonus);
                    if (target === 'enemy-single' || target === 'enemy-all') {
                        battleState.enemy.attack = Math.max(0, battleState.enemy.attack - decrease);
                        addLog(`å‡æ”»: æ•Œæ–¹æ”»å‡»åŠ› -${decrease} (${Math.round(sourceValue)} Ã— ${bonus})`, 'purple');
                    }
                    break;
                }
                case 'debuff_defense': {
                    // å‡é˜²ï¼šé˜²å¾¡åŠ›=æ•ˆæœæ¥æº*å‡é˜²åŠ æˆ
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const decrease = Math.round(sourceValue * bonus);
                    if (target === 'enemy-single' || target === 'enemy-all') {
                        battleState.enemy.defense = Math.max(0, battleState.enemy.defense - decrease);
                        addLog(`å‡é˜²: æ•Œæ–¹é˜²å¾¡åŠ› -${decrease} (${Math.round(sourceValue)} Ã— ${bonus})`, 'purple');
                    }
                    break;
                }
                case 'debuff_speed': {
                    // å‡é€Ÿï¼šæ•æ·åŠ›=æ•ˆæœæ¥æº*å‡é€ŸåŠ æˆ
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const decrease = Math.round(sourceValue * bonus);
                    if (target === 'enemy-single' || target === 'enemy-all') {
                        battleState.enemy.agility = Math.max(0, battleState.enemy.agility - decrease);
                        addLog(`å‡é€Ÿ: æ•Œæ–¹æ•æ· -${decrease} (${Math.round(sourceValue)} Ã— ${bonus})`, 'purple');
                    }
                    break;
                }
                case 'heal_direct': {
                    // ç›´æ¥æ¢å¤ï¼šæ¢å¤é‡=æ•ˆæœæ¥æº*æ²»ç–—åŠ æˆ*æ¯å›åˆæ¢å¤æ¬¡æ•°
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const heal = Math.round(sourceValue * bonus * count);
                    if (target === 'self' || target === 'ally-all') {
                        battleState.self.hp = Math.min(battleState.self.maxHp, battleState.self.hp + heal);
                        addLog(`ç›´æ¥æ¢å¤: +${heal} ç”Ÿå‘½ (${Math.round(sourceValue)} Ã— ${bonus} Ã— ${count})`, 'green');
                    }
                    break;
                }
                case 'heal_continuous': {
                    // æŒç»­æ¢å¤ï¼šæ¢å¤é‡=æ•ˆæœæ¥æº*æ²»ç–—åŠ æˆ*æ¯å›åˆæ¢å¤æ¬¡æ•°
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 1;
                    const heal = Math.round(sourceValue * bonus * count);
                    if (target === 'self' || target === 'ally-all') {
                        battleState.self.hp = Math.min(battleState.self.maxHp, battleState.self.hp + heal);
                        addLog(`æŒç»­æ¢å¤: +${heal} ç”Ÿå‘½ (${Math.round(sourceValue)} Ã— ${bonus} Ã— ${count})`, 'green');
                    }
                    break;
                }
                case 'heal_percent': {
                    // ç™¾åˆ†æ¯”æ¢å¤ï¼šæ•ˆæœæ¥æº*æ¢å¤ç™¾åˆ†æ¯”*æ¯å›åˆæ¢å¤æ¬¡æ•°
                    const target = params[`${effectKey}_target`];
                    const percent = params[`${effectKey}_percent`] || 0.1;
                    const heal = Math.round(sourceValue * percent * count);
                    if (target === 'self' || target === 'ally-all') {
                        battleState.self.hp = Math.min(battleState.self.maxHp, battleState.self.hp + heal);
                        addLog(`ç™¾åˆ†æ¯”æ¢å¤: +${heal} ç”Ÿå‘½ (${Math.round(sourceValue)} Ã— ${percent} Ã— ${count})`, 'green');
                    }
                    break;
                }
                case 'heal_lifesteal': {
                    // ç”Ÿå‘½æ±²å–ï¼šæ•ˆæœæ¥æº*æ±²å–åŠ æˆ*æ¯å›åˆæ±²å–æ¬¡æ•°
                    const bonus = params[`${effectKey}_bonus`] || 0.2;
                    const heal = Math.round(sourceValue * bonus * count);
                    battleState.self.hp = Math.min(battleState.self.maxHp, battleState.self.hp + heal);
                    addLog(`ç”Ÿå‘½æ±²å–: +${heal} ç”Ÿå‘½ (${Math.round(sourceValue)} Ã— ${bonus} Ã— ${count})`, 'green');
                    break;
                }
                case 'buff_purify': {
                    // å‡€åŒ–ï¼šæ¸…é™¤å¼‚å¸¸çŠ¶æ€
                    const target = params[`${effectKey}_target`];
                    const purifyType = params[`${effectKey}_purify-type`] || 'all';
                    
                    if (target === 'self' || target === 'ally-all') {
                        const beforeCount = battleState.self.status.length;
                        if (purifyType === 'all') {
                            battleState.self.status = [];
                            addLog(`å‡€åŒ–: æ¸…é™¤æˆ‘æ–¹æ‰€æœ‰å¼‚å¸¸çŠ¶æ€ (${beforeCount}ä¸ª)`, 'green');
                        } else {
                            battleState.self.status = battleState.self.status.filter(s => s !== purifyType);
                            addLog(`å‡€åŒ–: æ¸…é™¤æˆ‘æ–¹ ${statusNames[purifyType] || purifyType}`, 'green');
                        }
                    }
                    break;
                }
                case 'buff_status_enemy': {
                    // ä¸ºæ•Œæ–¹é™„åŠ å¼‚å¸¸çŠ¶æ€
                    const statusType = params[`${effectKey}_status-type`] || 'poison';
                    const statusChance = params[`${effectKey}_status-chance`] || 50;
                    const random = Math.random() * 100;
                    
                    if (random <= statusChance) {
                        if (!battleState.enemy.status.includes(statusType)) {
                            battleState.enemy.status.push(statusType);
                            addLog(`æ–½åŠ å¼‚å¸¸: æ•Œæ–¹è·å¾— ${statusNames[statusType] || statusType} (${statusChance}%æ¦‚ç‡æˆåŠŸ)`, 'purple');
                        } else {
                            addLog(`æ–½åŠ å¼‚å¸¸: æ•Œæ–¹å·²æœ‰ ${statusNames[statusType] || statusType}`, 'gray');
                        }
                    } else {
                        addLog(`æ–½åŠ å¼‚å¸¸: æœªè§¦å‘ (${Math.round(random)}% > ${statusChance}%)`, 'gray');
                    }
                    break;
                }
                case 'debuff_status_self': {
                    // ä¸ºè‡ªèº«é™„åŠ å¼‚å¸¸çŠ¶æ€
                    const statusType = params[`${effectKey}_status-type`] || 'poison';
                    const statusChance = params[`${effectKey}_status-chance`] || 50;
                    const random = Math.random() * 100;
                    
                    if (random <= statusChance) {
                        if (!battleState.self.status.includes(statusType)) {
                            battleState.self.status.push(statusType);
                            addLog(`è‡ªèº«å¼‚å¸¸: è·å¾— ${statusNames[statusType] || statusType} (${statusChance}%æ¦‚ç‡æˆåŠŸ)`, 'purple');
                        } else {
                            addLog(`è‡ªèº«å¼‚å¸¸: å·²æœ‰ ${statusNames[statusType] || statusType}`, 'gray');
                        }
                    } else {
                        addLog(`è‡ªèº«å¼‚å¸¸: æœªè§¦å‘ (${Math.round(random)}% > ${statusChance}%)`, 'gray');
                    }
                    break;
                }
                case 'debuff_no_heal': {
                    // ç¦ç–—
                    const target = params[`${effectKey}_target`];
                    if (target === 'enemy-single' || target === 'enemy-all') {
                        if (!battleState.enemy.status.includes('no-heal')) {
                            battleState.enemy.status.push('no-heal');
                            addLog(`ç¦ç–—: æ•Œæ–¹æ— æ³•æ¢å¤ç”Ÿå‘½`, 'purple');
                        }
                    }
                    break;
                }
                case 'debuff_heal_reduce': {
                    // å‡ç–—
                    const target = params[`${effectKey}_target`];
                    const bonus = params[`${effectKey}_bonus`] || 0.5;
                    if (target === 'enemy-single' || target === 'enemy-all') {
                        if (!battleState.enemy.status.includes('heal-reduce')) {
                            battleState.enemy.status.push('heal-reduce');
                            addLog(`å‡ç–—: æ•Œæ–¹æ²»ç–—æ•ˆæœé™ä½ ${Math.round(bonus * 100)}%`, 'purple');
                        }
                    }
                    break;
                }
                case 'buff_element_damage': {
                    // å±æ€§å¢ä¼¤ï¼šè¯¥å±æ€§ç›®æ ‡çš„æœ€ç»ˆä¼¤å®³=æœ€ç»ˆä¼¤å®³*(1+å¢ä¼¤åŠ æˆ)
                    const target = params[`${effectKey}_target`];
                    const elementType = params[`${effectKey}_element-type`] || 'fire';
                    const damageBonus = params[`${effectKey}_damage-bonus`] || 0.2;
                    
                    if (target === 'self' || target === 'ally-all') {
                        if (!battleState.self.elementDamageBonus) battleState.self.elementDamageBonus = {};
                        battleState.self.elementDamageBonus[elementType] =
                            (battleState.self.elementDamageBonus[elementType] || 0) + damageBonus;
                        addLog(`å±æ€§å¢ä¼¤: æˆ‘æ–¹å¯¹${getElementName(elementType)}ç³»ä¼¤å®³ +${Math.round(damageBonus * 100)}% (å½“å‰æ•Œæ–¹ç³»åˆ«:${getElementName(battleState.enemy.element)})`, 'green');
                    }
                    break;
                }
                case 'debuff_element_damage': {
                    // å±æ€§å‡ä¼¤ï¼šå—åˆ°è¯¥å±æ€§æœ€ç»ˆä¼¤å®³=æœ€ç»ˆä¼¤å®³*(1-å‡ä¼¤åŠ æˆ)
                    const target = params[`${effectKey}_target`];
                    const elementType = params[`${effectKey}_element-type`] || 'fire';
                    const damageReduce = params[`${effectKey}_damage-reduce`] || 0.2;
                    
                    if (target === 'enemy-single' || target === 'enemy-all') {
                        if (!battleState.enemy.elementDamageReduce) battleState.enemy.elementDamageReduce = {};
                        battleState.enemy.elementDamageReduce[elementType] =
                            (battleState.enemy.elementDamageReduce[elementType] || 0) + damageReduce;
                        addLog(`å±æ€§å‡ä¼¤: æ•Œæ–¹å—åˆ°${getElementName(elementType)}ç³»ä¼¤å®³ -${Math.round(damageReduce * 100)}% (å½“å‰æˆ‘æ–¹ç³»åˆ«:${getElementName(battleState.self.element)})`, 'purple');
                    }
                    break;
                }
                default:
                    addLog(`[${config.name}] å·²è§¦å‘ï¼ˆç®€åŒ–æ¨¡æ‹Ÿï¼‰`, 'gray');
            }
        }

        function getElementName(element) {
            const names = {
                'water': 'æ°´', 'fire': 'ç«', 'grass': 'è‰',
                'wind': 'é£', 'electric': 'ç”µ', 'earth': 'åœŸ'
            };
            return names[element] || element;
        }

        // åº”ç”¨å±æ€§å¢ä¼¤/å‡ä¼¤
        function applyElementDamageModifiers(baseDamage) {
            let finalDamage = baseDamage;
            const selfElement = battleState.self.element;
            const enemyElement = battleState.enemy.element;
            
            console.log('è°ƒè¯•-å±æ€§å¢ä¼¤:', {
                baseDamage, selfElement, enemyElement,
                selfBonus: battleState.self.elementDamageBonus,
                enemyReduce: battleState.enemy.elementDamageReduce
            });
            
            // åº”ç”¨æˆ‘æ–¹çš„å±æ€§å¢ä¼¤ï¼ˆé’ˆå¯¹æ•Œæ–¹ç³»åˆ«ï¼‰
            if (battleState.self.elementDamageBonus && battleState.self.elementDamageBonus[enemyElement]) {
                const bonus = battleState.self.elementDamageBonus[enemyElement];
                const oldDamage = finalDamage;
                finalDamage = Math.round(finalDamage * (1 + bonus));
                addLog(`  â†’ å±æ€§å¢ä¼¤(å¯¹${getElementName(enemyElement)}ç³»): ${oldDamage} Ã— (1+${bonus}) = ${finalDamage}`, 'cyan');
            }
            
            // åº”ç”¨æ•Œæ–¹çš„å±æ€§å‡ä¼¤ï¼ˆé’ˆå¯¹æˆ‘æ–¹ç³»åˆ«ï¼‰
            if (battleState.enemy.elementDamageReduce && battleState.enemy.elementDamageReduce[selfElement]) {
                const reduce = battleState.enemy.elementDamageReduce[selfElement];
                const oldDamage = finalDamage;
                finalDamage = Math.round(finalDamage * (1 - reduce));
                addLog(`  â†’ å±æ€§å‡ä¼¤(å—${getElementName(selfElement)}ç³»): ${oldDamage} Ã— (1-${reduce}) = ${finalDamage}`, 'cyan');
            }
            
            return Math.max(1, finalDamage);
        }

        // æ¸…é™¤ä¸´æ—¶å¢ç›Šæ•ˆæœ
        function clearTemporaryBuffs() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”å±æ€§çš„æŒç»­æ•ˆæœ
            const activeElementBuffs = activeEffects.filter(e => e.isTempBuff).map(e => {
                const params = e.skill.params;
                return params[`${e.effectKey}_element-type`];
            });
            
            // æ¸…é™¤æ²¡æœ‰æŒç»­æ•ˆæœçš„å±æ€§å¢ä¼¤
            if (battleState.self.elementDamageBonus) {
                Object.keys(battleState.self.elementDamageBonus).forEach(elem => {
                    if (!activeElementBuffs.includes(elem)) {
                        delete battleState.self.elementDamageBonus[elem];
                        addLog(`æ¸…é™¤ä¸´æ—¶å±æ€§å¢ä¼¤(${getElementName(elem)}ç³»)`, 'gray');
                    }
                });
            }
            
            // æ¸…é™¤æ²¡æœ‰æŒç»­æ•ˆæœçš„å±æ€§å‡ä¼¤
            if (battleState.enemy.elementDamageReduce) {
                Object.keys(battleState.enemy.elementDamageReduce).forEach(elem => {
                    if (!activeElementBuffs.includes(elem)) {
                        delete battleState.enemy.elementDamageReduce[elem];
                        addLog(`æ¸…é™¤ä¸´æ—¶å±æ€§å‡ä¼¤(${getElementName(elem)}ç³»)`, 'gray');
                    }
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
        setupTestButton();
    </script>
</body>
</html>