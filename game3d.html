<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­ç›†æ ½ï¼šåŠ¨ç‰©æ –æ¯åœ° - 3D æ ¸å¿ƒå¾ªç¯æ¼”ç¤º</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- å¼•å…¥èƒŒåŒ…ç³»ç»Ÿ -->
    <script src="inventory_system.js"></script>
    <style>
        /* ç¡®ä¿ç”»å¸ƒå…¨å±ä¸”ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #0a1120; }
        canvas { display: block; }

        /* æ¸¸æˆ UI æ ·å¼ */
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€åˆ° 3D åœºæ™¯ */
        }
        .control-panel {
            pointer-events: auto; /* ä½¿æ§åˆ¶é¢æ¿å¯äº¤äº’ */
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid #374151;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px #047857; /* æŒ‰é’®é˜´å½± - ç»¿è‰² */
            min-width: 120px;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #047857;
        }
        .action-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #065f46;
        }
        .combat-log-entry {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .clear-button {
             box-shadow: 0 4px #475569; /* æ¸…ç©ºæŒ‰é’®é˜´å½± - ç°è‰² */
             background-color: #4b5563;
        }
        .clear-button:hover {
            box-shadow: 0 6px #475569;
             background-color: #6b7280;
        }
        .clear-button:active {
            box-shadow: 0 2px #374151;
             background-color: #374151;
        }
        .build-mode-active {
            border: 3px solid #facc15;
            background: #451a03;
        }
        .selected-for-breeding {
            /* é€‰ä¸­æ—¶çš„ç‰¹æ®Šæ ·å¼ */
            background-color: #1e3a8a !important; /* Blue 900 */
            border: 2px solid #60a5fa; /* Blue 400 */
        }

        /* æ–°å¢ï¼šç”¨äºå±…ä¸­é¢æ¿çš„æ ·å¼ */
        .centered-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50; /* ç¡®ä¿åœ¨é®ç½©å±‚ä¹‹ä¸Š */
        }

        /* æ–°å¢ï¼šé®ç½©å±‚æ ·å¼ */
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40; /* åœ¨é¢æ¿ä¹‹ä¸‹ */
        }

        /* é’ˆå¯¹ç§»åŠ¨ç«¯ä¼˜åŒ–å¸ƒå±€ */
        @media (max-width: 767px) {
            .control-panel-group {
                flex-direction: column;
                gap: 10px;
            }
            .action-button {
                padding: 10px 20px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- æ–°å¢ï¼šæ¨¡æ€æ¡†é®ç½©å±‚ -->
    <div id="modal-overlay" class="hidden"></div>

    <!-- 3D æ¸²æŸ“å°†åœ¨æ­¤å¤„æ˜¾ç¤º -->
    <div id="container"></div>

    <!-- æ¸¸æˆ UI ç•Œé¢ -->
    <div class="game-ui p-4 flex flex-col justify-between items-start">

    <!-- æ¸¸æˆ UI ç•Œé¢ -->
    <div class="game-ui p-4 flex flex-col justify-between items-start">
        
        <!-- å·¦ä¾§é¢æ¿ç»„ -->
        <div class="flex flex-col space-y-4 w-full md:w-72">
            <!-- èµ„æº/çŠ¶æ€é¢æ¿ (å·¦ä¸Šè§’) -->
            <div id="stats-panel" class="control-panel p-4 rounded-lg text-white">
                <h2 class="text-xl font-bold mb-3 text-green-400 border-b border-gray-700 pb-2">æ –æ¯åœ°çŠ¶æ€</h2>
                <div id="stat-food" class="text-sm mb-1">ğŸ é£Ÿç‰©: <span class="font-mono text-yellow-300">0</span></div>
                <div id="stat-gold" class="text-sm mb-1">ğŸ’° é‡‘å¸: <span class="font-mono text-amber-400">0</span></div>
                <div id="stat-wood" class="text-sm mb-1">ğŸªµ æœ¨æ: <span class="font-mono text-orange-400">0</span></div>
                <div id="stat-stone" class="text-sm mb-1">ğŸª¨ çŸ³æ: <span class="font-mono text-slate-400">0</span></div>
                <div id="stat-gems" class="text-sm mb-1">ğŸ’ å®çŸ³: <span class="font-mono text-pink-400">0</span></div>
                <div id="stat-exp-grass" class="text-sm mb-1">ğŸŒ¿ ç»éªŒè‰: <span class="font-mono text-green-400">0</span></div>
                <div id="stat-moon-flower" class="text-sm mb-1">ğŸŒ™ æœˆå…‰èŠ±: <span class="font-mono text-purple-400">0</span></div>
                <div id="stat-mutation-crystal" class="text-sm mb-1">ğŸ’  å˜å¼‚æ™¶ä½“: <span class="font-mono text-cyan-400">0</span></div>
                <div id="stat-void-essence" class="text-sm mb-2">ğŸŒŒ è™šç©ºç²¾å: <span class="font-mono text-indigo-400">0</span></div>
                <div id="stat-den-level" class="text-sm mb-2">ğŸ  ç¹æ®–çªç­‰çº§: <span class="font-mono text-green-300">1</span></div>
                <div id="stat-animal-count" class="text-sm">ğŸ¾ åŠ¨ç‰©æ•°é‡: <span class="font-mono text-indigo-300">0 / 5</span></div>
                <div id="stat-buildings" class="text-sm mt-3 border-t border-gray-700 pt-3">
                    ğŸšœ å†œåœº: <span id="farm-count" class="font-mono text-green-300">0</span> | â›ï¸ çŸ¿: <span id="mine-count" class="font-mono text-pink-300">0</span>
                </div>
                <div id="status-message" class="text-xs mt-3 h-4 text-gray-400"></div>
            </div>

            <!-- ç‹¬ç«‹çš„åŠ¨ç‰©è¯¦æƒ…é¢æ¿ (æ–°å¢) -->
            <div id="animal-standalone-details-panel" class="control-panel p-4 rounded-lg text-white hidden w-full md:w-96" style="position: absolute; z-index: 100;">
                 <h3 class="text-xl font-bold mb-3 text-fuchsia-400 border-b border-gray-700 pb-2 flex justify-between items-center">
                    <span>åŠ¨ç‰©è¯¦æƒ…</span>
                    <button id="btn-close-standalone-details" class="text-sm font-normal text-gray-400 hover:text-white">å…³é—­</button>
                </h3>
                <div id="animal-standalone-detail-content">
                    <h4 class="text-lg font-bold text-fuchsia-400 flex justify-between items-center">
                        <span id="standalone-animal-detail-name">åŠ¨ç‰©åç§°</span>
                        <div class="flex items-center space-x-2">
                            <span id="standalone-animal-detail-gender" class="text-sm font-normal px-2 py-1 rounded"></span>
                            <span id="standalone-animal-detail-level" class="text-sm font-normal bg-purple-600 px-2 py-1 rounded">Lv. 1</span>
                        </div>
                    </h4>

                    <!-- ç»éªŒè¿›åº¦æ¡ -->
                    <div class="my-2">
                        <div class="flex justify-between text-xs text-gray-400 mb-1">
                            <span>ç»éªŒ</span>
                            <span id="standalone-animal-detail-exp-text">0 / 100</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="standalone-animal-detail-exp-bar" class="bg-yellow-400 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- å±æ€§/èƒ½åŠ› åˆ‡æ¢æ ‡ç­¾ (æ­¤å¤„ç®€åŒ–ï¼Œç›´æ¥å±•ç¤ºæ ¸å¿ƒå±æ€§) -->
                     <div id="standalone-panel-attributes" class="text-sm space-y-1 mt-3 border-t border-gray-700 pt-3">
                        <p>â¤ï¸ ä½“åŠ›: <span id="standalone-animal-detail-stamina" class="font-mono text-green-300"></span></p>
                        <p>âœ¨ æ½œåŠ›: <span id="standalone-animal-detail-potential" class="font-mono"></span></p>
                        <p>ğŸŒ€ ç³»åˆ«: <span id="standalone-animal-detail-element" class="font-mono text-cyan-300"></span></p>
                        <!-- ç§»é™¤å‘è‚²é˜¶æ®µæ˜¾ç¤ºï¼Œç®€åŒ–å¸ƒå±€ -->
                        <!-- <p>ğŸŒ± å‘è‚²: <span id="standalone-animal-detail-development" class="font-mono text-yellow-300"></span></p> -->
                    </div>

                    <!-- èƒ½åŠ›é¢æ¿ -->
                    <div id="standalone-panel-abilities" class="text-sm space-y-2 mt-3 border-t border-gray-700 pt-3">
                        <p class="font-semibold text-indigo-300">èƒ½åŠ›</p>
                        <p class="ml-2 text-xs">âš”ï¸ æ”»å‡»: <span id="standalone-ability-combat-atk" class="font-mono text-red-400"></span></p>
                        <p class="ml-2 text-xs">ğŸ›¡ï¸ é˜²å¾¡: <span id="standalone-ability-combat-def" class="font-mono text-blue-400"></span></p>
                        <p class="ml-2 text-xs">âš¡ æ•æ·: <span id="standalone-ability-combat-agi" class="font-mono text-yellow-400"></span></p>
                        <p class="font-semibold text-indigo-300 mt-2">æˆ˜æ–—æŠ€èƒ½</p>
                        <div id="standalone-combat-skills" class="grid grid-cols-4 gap-1 mt-1">
                            <!-- æŠ€èƒ½æ§½ä½ç”± JS ç”Ÿæˆï¼ˆ4ä¸ªæ§½ä½ï¼‰ -->
                        </div>
                    </div>

                    <div class="mt-4 border-t border-gray-700 pt-3">
                        <button id="standalone-btn-feed-animal" class="action-button w-full mb-2 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg">å–‚å…»</button>
                        <button id="standalone-btn-place-animal" class="action-button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">æ”¾ç½®åˆ°æ –æ¯åœ°</button>
                        <button id="standalone-btn-recall-animal" class="action-button w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">ä»æ –æ¯åœ°å¬å›</button>
                        <button id="standalone-btn-challenge" class="action-button w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden">
                            âš”ï¸ æŒ‘æˆ˜
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å»ºç­‘è¯¦æƒ…é¢æ¿ (ç§»è‡³æ­¤å¤„å¹¶å±…ä¸­) -->
        <div id="building-details-panel" class="control-panel centered-panel p-6 rounded-xl text-white hidden w-full max-w-lg">
            <!-- 1. Header -->
            <div class="flex justify-between items-center mb-5 pb-4 border-b-2 border-gray-700">
                <div class="flex items-center space-x-4">
                    <div class="bg-gray-800 p-3 rounded-lg">
                        <span id="detail-icon" class="text-5xl"></span>
                    </div>
                    <div>
                        <h3 id="detail-name" class="text-2xl font-bold text-yellow-300">å»ºç­‘åç§°</h3>
                        <p id="detail-level" class="text-lg font-semibold text-cyan-400">Lv. 1</p>
                    </div>
                </div>
                <button id="btn-close-details" class="text-4xl text-gray-500 hover:text-white transition-colors leading-none">&times;</button>
            </div>

            <!-- 2. Production Output -->
            <div class="bg-gradient-to-br from-gray-800/80 to-gray-900/80 p-4 rounded-xl mb-4 border border-gray-700">
                <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider flex items-center">
                    <span class="mr-2">ğŸ“Š</span> å½“å‰æ•ˆæœ
                </h4>
                <p id="detail-current-effect" class="text-lg font-mono text-green-300 leading-relaxed"></p>
            </div>

            <!-- 3. Worker Slot -->
            <div id="worker-slot" class="bg-gradient-to-br from-gray-800/80 to-gray-900/80 p-4 rounded-xl mb-4 border border-gray-700">
                <h4 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider flex items-center">
                    <span class="mr-2">ğŸ‘·</span> å·¥ä½œåŠ¨ç‰©
                </h4>
                <div id="worker-info" class="hidden flex items-center justify-between">
                    <!-- å·¥ä½œåŠ¨ç‰©ä¿¡æ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div id="assign-worker-section">
                    <p id="no-worker-text" class="text-sm text-gray-500 mb-2">æš‚æ— åŠ¨ç‰©å·¥ä½œ</p>
                    <button id="btn-assign-worker" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-all duration-200 shadow-lg hover:shadow-cyan-500/50">
                        â• æ´¾é£åŠ¨ç‰©
                    </button>
                </div>
            </div>

            <!-- 4. Upgrade Section -->
            <div id="detail-next-upgrade" class="bg-gradient-to-br from-indigo-900/30 to-purple-900/30 p-4 rounded-xl border border-indigo-700/50 mb-4">
                <h4 class="text-xs font-bold text-indigo-300 mb-3 uppercase tracking-wider flex items-center">
                    <span class="mr-2">â¬†ï¸</span> å‡çº§é¢„è§ˆ
                </h4>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">ä¸‹ä¸€çº§:</span>
                        <span id="next-level" class="font-bold text-lg text-green-400">Lv. 2</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">æ•ˆæœ:</span>
                        <span id="detail-next-effect" class="font-mono text-sm text-green-300"></span>
                    </div>
                    <div id="upgrade-cost-display" class="mt-3 pt-3 border-t border-indigo-700/50">
                        <!-- å‡çº§æˆæœ¬å°†ç”±JSæ³¨å…¥ -->
                    </div>
                </div>
            </div>

            <!-- 5. æ“ä½œæŒ‰é’® -->
            <button id="btn-upgrade-building" class="action-button w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-indigo-500/50 transition-all duration-200">
                <!-- å‡çº§æ–‡å­—å’Œè´¹ç”¨å°†ç”±JSæ³¨å…¥ -->
            </button>
            
            <!-- 6. å·¥åŠåˆæˆæŒ‰é’® (ä»…å·¥åŠæ˜¾ç¤º) -->
            <button id="btn-craft-potion" class="action-button w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-3 shadow-lg hover:shadow-cyan-500/50 transition-all duration-200 hidden">
                ğŸ§ª åˆæˆè¯æ°´
            </button>

        </div>

        <!-- æ–°å¢ï¼šå·¥äººé€‰æ‹©é¢æ¿ -->
        <div id="worker-selection-panel" class="control-panel centered-panel p-5 rounded-lg text-white hidden w-full md:w-[450px]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-cyan-300">é€‰æ‹©å·¥ä½œåŠ¨ç‰©</h3>
                <button id="btn-close-worker-selection" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="worker-selection-list" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- å¯ç”¨åŠ¨ç‰©å°†åœ¨æ­¤å¤„åˆ—å‡º -->
            </div>
        </div>



        <!-- åŠ¨ç‰©æˆ˜æ–—é¢æ¿ (ç§»è‡³æ­¤å¤„å¹¶å±…ä¸­) -->
        <div id="battle-setup-panel" class="control-panel centered-panel p-4 rounded-lg text-white hidden w-full md:w-[450px]">
            <h3 class="text-xl font-bold mb-3 text-red-500 border-b border-gray-700 pb-2 flex justify-center items-center">
                <span>æˆ˜æ–—å‡†å¤‡</span>
            </h3>
            <div class="flex space-x-4 mb-4">
                <!-- å·¦åˆ—: æˆ‘æ–¹é˜Ÿä¼é€‰æ‹© -->
                <div class="w-1/2">
                    <p class="text-sm font-semibold text-gray-400 mb-2">é€‰æ‹©ä½ çš„å‹‡å£« (1åª)</p>
                    <div id="battle-team-selection-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- æˆ‘æ–¹åŠ¨ç‰©åˆ—è¡¨å°†åœ¨æ­¤å¤„æ³¨å…¥ -->
                    </div>
                </div>
                <!-- å³åˆ—: å¯¹æ‰‹ä¿¡æ¯ -->
                <div class="w-1/2">
                    <p class="text-sm font-semibold text-gray-400 mb-2">æŒ‘æˆ˜å¯¹æ‰‹</p>
                    <div id="battle-opponent-info" class="p-2 rounded-lg bg-gray-900 flex items-center justify-between">
                        <!-- å¯¹æ‰‹ä¿¡æ¯å°†åœ¨æ­¤æ³¨å…¥ -->
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex space-x-2 mt-4">
                <button id="btn-execute-battle" class="action-button flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-center text-sm" disabled>å‘èµ·æŒ‘æˆ˜</button>
                <button id="btn-close-battle-setup-panel" class="action-button flex-1 clear-button hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-center text-sm">å–æ¶ˆ</button>
            </div>
        </div>

        <!-- æ–°å¢ï¼šæ–‡ç‰©é¦†é¢æ¿ -->
        <div id="museum-panel" class="control-panel centered-panel p-6 rounded-xl text-white hidden w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-amber-400">ğŸ›ï¸ æ–‡ç‰©é¦†</h3>
                <button id="btn-close-museum" class="text-3xl text-gray-500 hover:text-white">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Left: Exhibition Slots -->
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-gray-300 mb-2">å±•å… (å®¹é‡: <span id="museum-capacity">0/4</span>)</h4>
                    <div id="museum-slots" class="grid grid-cols-2 gap-3">
                        <!-- Slots generated by JS -->
                    </div>
                </div>
                <!-- Right: Inventory -->
                <div class="w-full md:w-64 border-t md:border-t-0 md:border-l border-gray-700 pt-4 md:pt-0 md:pl-6">
                    <h4 class="text-lg font-bold text-gray-300 mb-2">æœªå±•ç¤ºæ–‡ç‰©</h4>
                    <div id="museum-inventory" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Inventory items -->
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šé“å…·å•†åº—é¢æ¿ -->
        <div id="shop-panel" class="control-panel centered-panel p-6 rounded-xl text-white hidden w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">ğŸ›’ é“å…·å•†åº—</h3>
                <div class="flex items-center gap-4">
                    <div class="text-sm">ğŸ’° é‡‘å¸: <span id="shop-gold-display" class="font-mono text-amber-400">0</span></div>
                    <button id="btn-close-shop" class="text-3xl text-gray-500 hover:text-white">&times;</button>
                </div>
            </div>
            <div id="shop-items-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- å•†å“åˆ—è¡¨ç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ–°å¢ï¼šèƒŒåŒ…é¢æ¿ -->
        <div id="inventory-panel" class="control-panel centered-panel p-6 rounded-xl text-white hidden w-full max-w-6xl max-h-[90vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-400">ğŸ’ æˆ‘çš„èƒŒåŒ…</h3>
                <button id="btn-close-inventory" class="text-3xl text-gray-500 hover:text-white">&times;</button>
            </div>
            
            <div class="flex gap-4 h-[calc(90vh-100px)]">
                <!-- å·¦ä¾§ï¼šå‡ºæˆ˜é˜Ÿä¼ - å æ®å…¨éƒ¨å·¦ä¾§é«˜åº¦ -->
                <div class="w-2/5 p-4 bg-gradient-to-br from-purple-900/30 to-indigo-900/30 rounded-xl border border-purple-500/50 overflow-y-auto">
                    <h4 class="text-lg font-bold text-purple-300 mb-4 flex items-center sticky top-0 bg-purple-900/30 pb-2">
                        <span class="mr-2">âš”ï¸</span>å‡ºæˆ˜é˜Ÿä¼ (6ä¸ªæ§½ä½)
                    </h4>
                    <div id="battle-team-slots" class="space-y-2">
                        <!-- å‡ºæˆ˜æ§½ä½ç”± JS ç”Ÿæˆ -->
                    </div>
                </div>
                    
                <!-- å³ä¾§ï¼šåŠ¨ç‰©è¯¦æƒ… -->
                <div class="w-3/5 p-4 bg-gradient-to-br from-gray-800/50 to-gray-900/50 rounded-xl border border-gray-600/50 overflow-y-auto">
                    <div id="inventory-animal-detail" class="hidden">
                        <h4 class="text-lg font-bold text-purple-300 mb-4 flex items-center">
                            <span class="mr-2">ğŸ“‹</span>åŠ¨ç‰©è¯¦æƒ…
                        </h4>
                        
                        <!-- åŠ¨ç‰©ä¿¡æ¯ -->
                        <div class="mb-4 pb-4 border-b border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <div id="inv-detail-avatar" class="w-16 h-16 rounded-full border-2" style="background-color: #60a5fa;"></div>
                                    <div>
                                        <h5 id="inv-detail-name" class="text-lg font-bold text-white">åŠ¨ç‰©åç§°</h5>
                                        <div class="flex items-center space-x-2 text-sm mt-1">
                                            <span id="inv-detail-level" class="bg-purple-600 px-2 py-0.5 rounded">Lv. 1</span>
                                            <span id="inv-detail-gender" class="px-2 py-0.5 rounded"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ç³»åˆ«ã€ç¨€æœ‰åº¦ã€å˜å¼‚ -->
                            <div class="flex items-center gap-2 flex-wrap mb-2">
                                <span class="bg-cyan-900/50 text-cyan-300 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1">
                                    <span>ğŸŒ€</span>
                                    <span id="inv-detail-element">æ°´</span>
                                </span>
                                <span id="inv-detail-rarity" class="px-3 py-1 rounded-full text-sm font-bold hidden">
                                    <!-- ç¨€æœ‰åº¦æ ‡ç­¾ -->
                                </span>
                                <span id="inv-detail-mutation" class="px-3 py-1 rounded-full text-sm font-bold hidden">
                                    <!-- å˜å¼‚æ ‡ç­¾ -->
                                </span>
                            </div>
                        </div>
                        
                        <!-- ç»éªŒæ¡ -->
                        <div class="mb-4">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>ç»éªŒå€¼</span>
                                <span id="inv-detail-exp-text">0 / 100</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div id="inv-detail-exp-bar" class="bg-yellow-400 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- å±æ€§ -->
                        <div class="grid grid-cols-2 gap-3 mb-4 text-sm">
                            <div class="bg-gray-900/50 p-3 rounded">
                                <span class="text-gray-400">âš¡ ä½“åŠ›</span>
                                <div id="inv-detail-stamina" class="text-green-400 font-mono text-lg mt-1">0/0</div>
                            </div>
                            <div class="bg-gray-900/50 p-3 rounded">
                                <span class="text-gray-400">âœ¨ æ½œåŠ›</span>
                                <div id="inv-detail-potential" class="font-bold text-lg mt-1">å¹³åº¸</div>
                            </div>
                        </div>
                        
                        <!-- æˆ˜æ–—å±æ€§ -->
                        <div class="grid grid-cols-3 gap-3 mb-4 text-sm">
                            <div class="bg-gray-900/50 p-3 rounded text-center">
                                <span class="text-gray-400 text-xs">âš”ï¸ æ”»å‡»</span>
                                <div id="inv-detail-attack" class="text-red-400 font-mono text-xl mt-1">0</div>
                            </div>
                            <div class="bg-gray-900/50 p-3 rounded text-center">
                                <span class="text-gray-400 text-xs">ğŸ›¡ï¸ é˜²å¾¡</span>
                                <div id="inv-detail-defense" class="text-blue-400 font-mono text-xl mt-1">0</div>
                            </div>
                            <div class="bg-gray-900/50 p-3 rounded text-center">
                                <span class="text-gray-400 text-xs">ğŸ’¨ æ•æ·</span>
                                <div id="inv-detail-agility" class="text-yellow-400 font-mono text-xl mt-1">0</div>
                            </div>
                        </div>
                        
                        <!-- æˆ˜æ–—æŠ€èƒ½ -->
                        <div class="mb-4 pb-4 border-b border-gray-700">
                            <h5 class="text-sm font-bold text-indigo-300 mb-2">âš”ï¸ æˆ˜æ–—æŠ€èƒ½</h5>
                            <div id="inv-detail-combat-skills" class="grid grid-cols-4 gap-2">
                                <!-- æŠ€èƒ½æ§½ä½ç”± JS ç”Ÿæˆï¼ˆ4ä¸ªæ§½ä½ï¼‰ -->
                            </div>
                        </div>
                        
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="space-y-2">
                            <button id="inv-detail-btn-set-first" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                                â­ è®¾ç½®ä¸ºé¦–å‘
                            </button>
                            <button id="inv-detail-btn-feed" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                                ğŸ å–‚å…»å‡çº§ (æ¶ˆè€— 10 é£Ÿç‰©)
                            </button>
                            <button id="inv-detail-btn-remove" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                âŒ ä»é˜Ÿä¼ç§»é™¤
                            </button>
                        </div>
                    </div>
                    
                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div id="inventory-detail-empty" class="flex flex-col items-center justify-center h-full text-gray-500">
                        <div class="text-6xl mb-4">ğŸ‘ˆ</div>
                        <p class="text-lg">ç‚¹å‡»å·¦ä¾§åŠ¨ç‰©æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šå‡ºæˆ˜é˜Ÿä¼é€‰æ‹©é¢æ¿ -->
        <div id="team-selector-panel" class="control-panel centered-panel p-5 rounded-lg text-white hidden w-full md:w-[500px] z-[60]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-300">é€‰æ‹©å‡ºæˆ˜åŠ¨ç‰©</h3>
                <button id="btn-close-team-selector" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="mb-3 text-sm text-gray-400">
                <span>å½“å‰æ§½ä½ï¼š</span>
                <span id="current-slot-info" class="text-yellow-400 font-bold">-</span>
            </div>
            <div id="team-animal-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                <!-- å¯é€‰åŠ¨ç‰©åˆ—è¡¨ -->
            </div>
        </div>

        <!-- æ–°å¢ï¼šé“å…·ç›®æ ‡é€‰æ‹©é¢æ¿ -->
        <div id="item-target-selector" class="control-panel centered-panel p-5 rounded-lg text-white hidden w-full md:w-[400px] z-[60]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">é€‰æ‹©ä½¿ç”¨å¯¹è±¡</h3>
                <button id="btn-close-target-selector" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <p class="text-sm text-gray-400 mb-2" id="target-selector-prompt">è¯·é€‰æ‹©ä¸€åªåŠ¨ç‰©ï¼š</p>
            <div id="target-animal-list" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
                <!-- åŠ¨ç‰©åˆ—è¡¨ -->
            </div>
        </div>

        <!-- æ–°å¢ï¼šæ‹å–è¡Œç«ä»·é¢æ¿ -->
        <div id="auction-bid-panel" class="control-panel centered-panel p-6 rounded-xl text-white hidden w-full max-w-md z-[60]">
            <div class="flex justify-between items-center mb-4">
                <h3 id="bid-panel-title" class="text-2xl font-bold text-yellow-400">ç«æ‹ç‰©å“</h3>
                <button id="btn-close-bid-panel" class="text-3xl text-gray-500 hover:text-white">&times;</button>
            </div>
            <div class="space-y-3">
                <div class="text-center text-6xl" id="bid-panel-icon">â“</div>
                <div class="flex justify-between">
                    <span class="text-gray-400">å½“å‰æœ€é«˜å‡ºä»·:</span>
                    <span id="bid-panel-current-bid" class="font-mono text-green-400">ğŸ’° 0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">æœ€é«˜å‡ºä»·è€…:</span>
                    <span id="bid-panel-highest-bidder" class="font-mono text-cyan-400">æ— </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">å‰©ä½™æ—¶é—´:</span>
                    <span id="bid-panel-time-left" class="font-mono text-red-400">00:00:00</span>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <label for="bid-input" class="block text-sm font-medium text-gray-300 mb-1">ä½ çš„å‡ºä»· (å¿…é¡»æ›´é«˜):</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="bid-input" class="bg-gray-900 text-white w-full rounded-md border-gray-600 focus:ring-purple-500 focus:border-purple-500" placeholder="è¾“å…¥é‡‘é¢">
                        <button id="btn-place-bid" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">å‡ºä»·</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ä½ çš„é‡‘å¸: <span id="bid-panel-player-gold"></span></p>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ï¼šäº¤æ˜“æ‰€é¢æ¿ -->
        <div id="exchange-panel" class="control-panel centered-panel p-6 rounded-xl text-white hidden w-full max-w-4xl h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-green-400">ğŸ”„ äº¤æ˜“æ‰€</h3>
                <div class="flex items-center gap-4">
                    <div class="text-sm">ğŸ’° é‡‘å¸: <span id="exchange-gold-display" class="font-mono text-amber-400">0</span></div>
                    <button id="btn-close-exchange" class="text-3xl text-gray-500 hover:text-white">&times;</button>
                </div>
            </div>
            <div class="flex flex-col h-full">
                <div class="flex border-b border-gray-600 mb-4">
                    <button data-tab="sell" class="exchange-tab-button flex-1 text-sm py-2 text-center text-white border-b-2 border-green-500">å‡ºå”®åŠ¨ç‰©</button>
                    <button data-tab="buy" class="exchange-tab-button flex-1 text-sm py-2 text-center text-gray-400 border-b-2 border-transparent">è´­ä¹°åŠ¨ç‰©</button>
                    <button data-tab="auction" class="exchange-tab-button flex-1 text-sm py-2 text-center text-gray-400 border-b-2 border-transparent">æ‹å–è¡Œ</button>
                </div>
                <div id="exchange-content" class="flex-1 overflow-y-auto custom-scrollbar pr-2">
                    <!-- Tab content will be rendered here -->
                </div>
            </div>
        </div>


        <!-- æ–°å¢ï¼šæŠ€èƒ½é€‰æ‹©é¢æ¿ -->
        <div id="skill-selector-panel" class="control-panel centered-panel p-5 rounded-xl text-white hidden w-full md:w-[600px]" style="z-index: 100;">
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-purple-500/50">
                <h3 class="text-xl font-bold text-purple-300">é€‰æ‹©æˆ˜æ–—æŠ€èƒ½</h3>
                <button id="btn-close-skill-selector" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="mb-3 text-sm text-gray-400">
                <span>å½“å‰æ§½ä½ï¼š</span>
                <span id="current-skill-slot-info" class="text-yellow-400 font-bold">-</span>
            </div>
            <div id="available-skills-list" class="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto custom-scrollbar">
                <!-- å¯ç”¨æŠ€èƒ½åˆ—è¡¨ -->
            </div>
        </div>

        <!-- å»ºç­‘èœå•å®¹å™¨ (å³ä¸Šè§’) -->
        <div id="build-menus-container" class="absolute top-4 right-4 flex flex-col space-y-2">
            <!-- ä¸»å»ºç­‘èœå• -->
            <div id="build-main-menu" class="control-panel hidden w-full md:w-72 p-4 rounded-lg text-white">
                <h3 class="text-lg font-bold mb-3 text-yellow-400 border-b border-gray-700 pb-2">é€‰æ‹©å»ºç­‘ç±»å‹</h3>
                <button data-category="landmarks" class="category-button bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg w-full mb-2">ğŸ›ï¸ åœ°æ ‡</button>
                <button data-category="exchange" class="category-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg w-full mb-2">ğŸ”„ äº¤æ˜“æ‰€</button>
                <button data-category="shrines" class="category-button bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-2 px-4 rounded-lg w-full mb-2">â›©ï¸ åŠ¨ç‰©ç¥ç¤¾</button>
                <button data-category="materials" class="category-button bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg w-full">ğŸ—ï¸ åŸºç¡€å»ºç­‘</button>
                <button data-category="advanced" class="category-button bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-lg w-full mt-2">âœ¨ è¿›é˜¶å»ºç­‘</button>
            </div>
            <!-- äº¤æ˜“æ‰€å­èœå• -->
            <div id="build-exchange-menu" class="control-panel hidden w-full md:w-72 p-4 rounded-lg text-white">
                <h3 class="text-lg font-bold mb-3 text-yellow-400 border-b border-gray-700 pb-2 flex justify-between items-center">
                    <span>äº¤æ˜“æ‰€</span>
                    <button class="back-to-main-build-menu text-xs text-gray-400 hover:text-white">è¿”å›</button>
                </h3>
                <div data-building="Exchange" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ”„</span>
                            <p class="font-bold text-green-300">äº¤æ˜“æ‰€</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">500 ğŸ’°</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">è¿›è¡ŒåŠ¨ç‰©çš„ä¹°å–å’Œæ‹å–</p>
                </div>
            </div>
            <!-- åœ°æ ‡å»ºç­‘å­èœå• -->
            <div id="build-landmarks-menu" class="control-panel hidden w-full md:w-72 p-4 rounded-lg text-white">
                <h3 class="text-lg font-bold mb-3 text-yellow-400 border-b border-gray-700 pb-2 flex justify-between items-center">
                    <span>åœ°æ ‡å»ºç­‘</span>
                    <button class="back-to-main-build-menu text-xs text-gray-400 hover:text-white">è¿”å›</button>
                </h3>
                <div data-building="Museum" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ›ï¸</span>
                            <p class="font-bold text-amber-200">æ–‡ç‰©é¦†</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">200 ğŸª¨</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">å±•ç¤ºæŒ–æ˜å‡ºçš„ç¨€æœ‰æ–‡ç‰©</p>
                </div>
            </div>
            <!-- åŸºç¡€å»ºç­‘å­èœå• -->
            <div id="build-material-menu" class="control-panel hidden w-full md:w-72 p-4 rounded-lg text-white">
                <h3 class="text-lg font-bold mb-3 text-yellow-400 border-b border-gray-700 pb-2 flex justify-between items-center">
                    <span>åŸºç¡€å»ºç­‘</span>
                    <button class="back-to-main-build-menu text-xs text-gray-400 hover:text-white">è¿”å›</button>
                </h3>
                <div data-building="Farm" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸšœ</span>
                            <p class="font-bold text-orange-400">å†œåœº</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">50 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +5 é£Ÿç‰© / 5ç§’</p>
                </div>
                <div data-building="Mint" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">â›ï¸</span>
                            <p class="font-bold text-amber-400">é‡‘çŸ¿</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">100 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +1 é‡‘å¸ / åˆ†é’Ÿ</p>
                </div>
                <div data-building="LumberMill" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸªµ</span>
                            <p class="font-bold text-orange-400">ä¼æœ¨åœº</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">75 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +2 æœ¨æ / åˆ†é’Ÿ</p>
                </div>
                <div data-building="Quarry" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸª¨</span>
                            <p class="font-bold text-slate-400">é‡‡çŸ³åœº</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">75 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +2 çŸ³æ / åˆ†é’Ÿ</p>
                </div>
                <div data-building="HerbGarden" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸŒ¿</span>
                            <p class="font-bold text-green-400">è‰è¯å›­</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">100 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +2 ç»éªŒè‰ / åˆ†é’Ÿ</p>
                </div>
                <div data-building="MoonGarden" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸŒ™</span>
                            <p class="font-bold text-purple-400">æœˆå…‰èŠ±å›­</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">100 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +2 æœˆå…‰èŠ± / åˆ†é’Ÿ</p>
                </div>
                <div data-building="CrystalCave" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ’ </span>
                            <p class="font-bold text-cyan-400">æ™¶ä½“æ´ç©´</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">150 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +1 å˜å¼‚æ™¶ä½“ / åˆ†é’Ÿ</p>
                </div>
                <div data-building="VoidRift" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸŒŒ</span>
                            <p class="font-bold text-indigo-400">è™šç©ºè£‚éš™</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">150 ğŸ</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +1 è™šç©ºç²¾å / åˆ†é’Ÿ</p>
                </div>
            </div>
            <!-- è¿›é˜¶å»ºç­‘å­èœå• -->
            <div id="build-advanced-menu" class="control-panel hidden w-full md:w-72 p-4 rounded-lg text-white">
                <h3 class="text-lg font-bold mb-3 text-yellow-400 border-b border-gray-700 pb-2 flex justify-between items-center">
                    <span>è¿›é˜¶å»ºç­‘</span>
                    <button class="back-to-main-build-menu text-xs text-gray-400 hover:text-white">è¿”å›</button>
                </h3>
                <div data-building="GemMine" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ’</span>
                            <p class="font-bold text-pink-400">å®çŸ³çŸ¿</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">500ğŸ’° 100ğŸªµ 100ğŸª¨</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">äº§å‡º: +1 å®çŸ³/åˆ†é’Ÿ (éœ€å·¥äºº)</p>
                </div>
                <div data-building="TrainingGround" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">âš”ï¸</span>
                            <p class="font-bold text-red-400">è®­ç»ƒåœº</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">600ğŸ’° 150ğŸªµ 150ğŸª¨</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">ä¸ºå·¥ä½œåŠ¨ç‰©æä¾›ç»éªŒ</p>
                </div>
                <div data-building="SanctuaryShrine" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ›ï¸</span>
                            <p class="font-bold text-amber-400">åœ£åŸŸç¥æ®¿</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">1000ğŸ’° 200ğŸªµ 200ğŸª¨</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">æå‡å…¨å±€ä½“åŠ›æ¢å¤é€Ÿåº¦</p>
                </div>
                <div data-building="PotionWorkshop" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ§ª</span>
                            <p class="font-bold text-cyan-400">ç»éªŒè¯æ°´å·¥åŠ</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">800ğŸ’° 150ğŸªµ 150ğŸª¨</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">åˆæˆç»éªŒè¯æ°´ (éœ€ææ–™)</p>
                </div>
                <div data-building="MutationLab" class="build-button bg-gray-800 hover:bg-gray-700 p-3 rounded-lg w-full mb-2 cursor-pointer transition-colors">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">ğŸ§¬</span>
                            <p class="font-bold text-purple-400">å˜å¼‚å®éªŒå®¤</p>
                        </div>
                        <p class="text-sm font-mono text-yellow-300">1000ğŸ’° 200ğŸªµ 200ğŸª¨</p>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-10">åˆæˆå˜å¼‚è¡€æ¸… (éœ€ææ–™)</p>
                </div>
            </div>
        </div>


        <!-- æ“ä½œé¢æ¿ (å±…ä¸­åº•éƒ¨) -->
        <div class="flex-grow flex justify-center items-end w-full pb-4">
            <div class="control-panel p-4 rounded-lg flex space-x-2 md:space-x-4 control-panel-group">
                <!-- 1. åŸºç¡€åŸºå»º: å‡çº§ç¹æ®–çª -->
                <button id="btn-upgrade-den" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ¡ å‡çº§ç¹æ®–çª<br><span class="text-xs"> (è´¹ç”¨: 50 é£Ÿç‰©)</span>
                </button>

                <!-- 2. åŠ¨ç‰©ç³»ç»Ÿ: æŸ¥çœ‹åŠ¨ç‰©åå†Œ -->
                <button id="btn-open-animal-roster" class="action-button bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ¾ åŠ¨ç‰©ç³»ç»Ÿ<br><span class="text-xs"> (ç¹æ®–/åå†Œ)</span>
                </button>
                
                <!-- 2.2 åŠ¨ç‰©å›¾é‰´ (æ–°å¢) -->
                <button id="btn-open-encyclopedia" class="action-button bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ“– åŠ¨ç‰©å›¾é‰´<br><span class="text-xs"> (æ”¶é›†è¿›åº¦)</span>
                </button>

                <!-- 2.5 æ¢ç´¢ç³»ç»Ÿ -->
                <button id="btn-open-exploration" class="action-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ—ºï¸ æ¢ç´¢ç³»ç»Ÿ<br><span class="text-xs"> (ä»»åŠ¡/è¿œå¾)</span>
                </button>

                <!-- 2.6 æŒ–çŸ¿ç³»ç»Ÿ -->
                <button id="btn-open-mining" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    â›ï¸ åœ°ä¸‹æŒ–æ˜<br><span class="text-xs"> (æŒ–çŸ¿/æ®ç‚¹)</span>
                </button>

                <!-- 2.7 ä¸–ç•Œåœ°å›¾ -->
                <button id="btn-open-world-map" class="action-button bg-red-800 hover:bg-red-900 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸŒ ä¸–ç•Œåœ°å›¾<br><span class="text-xs"> (åŒºåŸŸæ¢ç´¢)</span>
                </button>
                
                <!-- 2.7 é“å…·å•†åº— -->
                <button id="btn-open-shop" class="action-button bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ›’ é“å…·å•†åº—<br><span class="text-xs"> (è´­ä¹°è¡¥ç»™)</span>
                </button>
                
                <!-- 2.8 èƒŒåŒ… -->
                <button id="btn-open-inventory" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ’ æˆ‘çš„èƒŒåŒ…<br><span class="text-xs"> (æŸ¥çœ‹/ä½¿ç”¨)</span>
                </button>

                <!-- 3. åŸºå»ºç³»ç»Ÿ: æ”¾ç½®å»ºç­‘ -->
                <button id="btn-open-build" class="action-button bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-3 px-4 rounded-lg text-center">
                    ğŸ”¨ æ”¾ç½®å»ºç­‘
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- å…¨å±€å˜é‡å’Œé…ç½® ---
        let scene, camera, renderer;
        let worldGroup; // ç”¨äºåŒ…è£¹æ‰€æœ‰ 3D å¯¹è±¡ï¼Œå®ç°åœºæ™¯ç»Ÿä¸€æ—‹è½¬
        let habitatMesh; // æ –æ¯åœ°æ¨¡å‹ (ç”¨äºå°„çº¿æŠ•å°„)
        let denMesh; // ç¹æ®–çªæ¨¡å‹
        let collectiblesGroup; // æ–°å¢ï¼šç”¨äºå­˜æ”¾æ‰€æœ‰å¯æ”¶é›†ç‰©å“çš„ç»„
        let foodTimer; // é£Ÿç‰©äº§å‡ºå®šæ—¶å™¨
        let gemTimer; // å®çŸ³äº§å‡ºå®šæ—¶å™¨
        let animalGroup; // åŠ¨ç‰©ç¾¤ç»„
        let raycaster; // å°„çº¿æŠ•å°„å™¨
        let pointer; // é¼ æ ‡/è§¦æ‘¸ä½ç½®
        let previewMesh; // å»ºç­‘é¢„è§ˆæ¨¡å‹
        let selectedBuilding = null; // å½“å‰é€‰ä¸­çš„å»ºç­‘å¯¹è±¡
        let cameraMovement = { forward: false, backward: false, left: false, right: false }; // æ–°å¢ï¼šç›¸æœºç§»åŠ¨çŠ¶æ€
        const GRID_SIZE = 30;
        const GRID_DIVISIONS = 30;

        // åŠ¨ç‰©é…ç½®
        const ANIMAL_TRAITS = ['å¼ºå£®', 'æ•æ·', 'æ…µæ‡’', 'å¥½å¥‡', 'ç¨€æœ‰', 'å˜å¼‚'];
        const ANIMAL_NAMES = ['Ami', 'Bao', 'Cai', 'Duo', 'Fei', 'Gui', 'Hao', 'Jing', 'Kai', 'Ling'];
        const GENDERS = ['é›„', 'é›Œ'];
        const ANIMAL_ELEMENTS = ['æ°´', 'ç«', 'è‰', 'ç”µ', 'åœŸ', 'é£'];
        const POTENTIAL_LEVELS = ['å¹³åº¸', 'è¶…å¸¸', 'ç’€ç’¨'];
        const DEVELOPMENT_STAGES = ['å¹¼å¹´æœŸ', 'æˆé•¿æœŸ', 'æˆç†ŸæœŸ'];
        const STAMINA_CONSUMPTION_PER_HOUR = 10; // æ¯å°æ—¶ä½“åŠ›æ¶ˆè€—

        // ç­‰çº§å’Œæˆé•¿é…ç½®
        const LEVEL_CONFIG = {
            baseExperience: 100, // 1çº§å‡2çº§æ‰€éœ€ç»éªŒ
            experienceMultiplier: 1.5, // æ¯çº§æ‰€éœ€ç»éªŒå€æ•°
            feedAmount: 20, // æ¯æ¬¡å–‚å…»å¢åŠ 20ç»éªŒ
            potentialMultipliers: {
                'å¹³åº¸': { stamina: 1.0, mobility: 1.0, combat: 1.0 },
                'è¶…å¸¸': { stamina: 1.2, mobility: 1.2, combat: 1.3 },
                'ç’€ç’¨': { stamina: 1.5, mobility: 1.4, combat: 1.8 },
            },
            baseGrowth: { // æ¯çº§åŸºç¡€æˆé•¿å€¼
                stamina: 10, mobility: 2, attack: 3, defense: 2, agility: 2, favorability: 5,
            }
        };

        // æ–‡ç‰©é…ç½®
        const ARTIFACT_TYPES = [
            { name: 'å¤ä»£é™¶ç‰‡', rarity: 'æ™®é€š', icon: 'ğŸº' },
            { name: 'ä¸‰å¶è™«åŒ–çŸ³', rarity: 'æ™®é€š', icon: 'ğŸš' },
            { name: 'ç”Ÿé”ˆçš„é“œå¸', rarity: 'æ™®é€š', icon: 'ğŸª™' },
            { name: 'ç¥­ç¥€é¢å…·', rarity: 'ç¨€æœ‰', icon: 'ğŸ‘º' },
            { name: 'å‘å…‰çš„æ™¶ä½“', rarity: 'ç¨€æœ‰', icon: 'ğŸ”®' },
            { name: 'é»„é‡‘æƒæ–', rarity: 'å²è¯—', icon: 'ğŸ‘‘' },
            { name: 'å¤–æ˜Ÿé—ç‰©', rarity: 'ä¼ è¯´', icon: 'ğŸ‘½' }
        ];

        // å•†åº—ç‰©å“é…ç½®
        const SHOP_ITEMS = {
            'exp_potion_s': { name: 'å°ç»éªŒè¯æ°´', icon: 'ğŸ§ª', desc: 'å¢åŠ 50ç‚¹ç»éªŒ', price: 100 },
            'exp_potion_l': { name: 'å¤§ç»éªŒè¯æ°´', icon: 'âš—ï¸', desc: 'å¢åŠ 200ç‚¹ç»éªŒ', price: 350 },
            'stamina_potion': { name: 'ä½“åŠ›è¯å‰‚', icon: 'âš¡', desc: 'æ¢å¤50ç‚¹ä½“åŠ›', price: 50 },
            'mutation_serum': { name: 'å˜å¼‚è¡€æ¸…', icon: 'ğŸ’‰', desc: 'è¯±å‘åŸºå› çªå˜', price: 500 }
        };

        // é“å…·ä½¿ç”¨é…ç½® (ä¸ animal_management.html ä¿æŒä¸€è‡´)
        const ITEMS = {
            'exp_potion_s': { name: 'å°ç»éªŒè¯æ°´', icon: 'ğŸ§ª', type: 'exp', value: 50, desc: 'å¢åŠ 50ç‚¹ç»éªŒ' },
            'exp_potion_l': { name: 'å¤§ç»éªŒè¯æ°´', icon: 'âš—ï¸', type: 'exp', value: 200, desc: 'å¢åŠ 200ç‚¹ç»éªŒ' },
            'stamina_potion': { name: 'ä½“åŠ›è¯å‰‚', icon: 'âš¡', type: 'stamina', value: 50, desc: 'æ¢å¤50ç‚¹ä½“åŠ›' },
            'mutation_serum': { name: 'å˜å¼‚è¡€æ¸…', icon: 'ğŸ’‰', type: 'material', desc: 'è¯±å‘åŠ¨ç‰©åŸºå› çªå˜çš„å…³é”®é“å…·' }
        };


        // æˆ˜æ–—æŠ€èƒ½é…ç½®ï¼ˆç©ºå¯¹è±¡ï¼Œæ‰€æœ‰æŠ€èƒ½ä» SKILL_POOL è·å–ï¼‰
        const COMBAT_SKILLS = {};

        // å»ºç­‘é…ç½®
        const BUILDINGS = {
            Farm: {
                cost: 50,
                color: 0xffa500, // æ©™è‰²
                name_cn: 'å†œåœº',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, foodPerTick: 5, scale: 1.0, shape: new THREE.BoxGeometry(0.8, 0.8, 0.8) },
                    2: { cost: 100, foodPerTick: 10, scale: 1.3, shape: new THREE.BoxGeometry(0.8, 1.2, 0.8) },
                    3: { cost: 250, foodPerTick: 25, scale: 1.7, shape: new THREE.BoxGeometry(0.8, 1.6, 0.8) }
                },
            },
            Mint: {
                cost: 100,
                color: 0xFFD700, // é‡‘è‰²
                name_cn: 'é‡‘çŸ¿',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, goldPerMin: 1, scale: 1.0, shape: new THREE.CylinderGeometry(0.5, 0.5, 1, 16) },
                    2: { cost: 200, goldPerMin: 2, scale: 1.3, shape: new THREE.CylinderGeometry(0.5, 0.5, 1.4, 16) },
                    3: { cost: 500, goldPerMin: 4, scale: 1.7, shape: new THREE.CylinderGeometry(0.5, 0.5, 1.8, 16) }
                },
            },
            LumberMill: {
                cost: 75,
                color: 0x8B4513, // éè¤è‰²
                name_cn: 'ä¼æœ¨åœº',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, woodPerMin: 2, scale: 1.0, shape: new THREE.BoxGeometry(1, 1, 1.5) },
                    2: { cost: 150, woodPerMin: 5, scale: 1.3, shape: new THREE.BoxGeometry(1, 1.2, 1.5) },
                    3: { cost: 300, woodPerMin: 10, scale: 1.7, shape: new THREE.BoxGeometry(1, 1.4, 1.5) }
                },
            },
            Quarry: {
                cost: 75,
                color: 0x708090, // çŸ³æ¿ç°
                name_cn: 'é‡‡çŸ³åœº',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, stonePerMin: 2, scale: 1.0, shape: new THREE.DodecahedronGeometry(0.7) },
                    2: { cost: 150, stonePerMin: 5, scale: 1.3, shape: new THREE.DodecahedronGeometry(0.9) },
                    3: { cost: 300, stonePerMin: 10, scale: 1.7, shape: new THREE.DodecahedronGeometry(1.1) }
                },
            },
            HerbGarden: {
                cost: 100,
                color: 0x22c55e, // ç»¿è‰²
                name_cn: 'è‰è¯å›­',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, expGrassPerMin: 2, scale: 1.0, shape: new THREE.CylinderGeometry(0.6, 0.6, 0.8, 8) },
                    2: { cost: 150, expGrassPerMin: 5, scale: 1.3, shape: new THREE.CylinderGeometry(0.7, 0.7, 1.0, 8) },
                    3: { cost: 300, expGrassPerMin: 10, scale: 1.7, shape: new THREE.CylinderGeometry(0.8, 0.8, 1.2, 8) }
                }
            },
            MoonGarden: {
                cost: 100,
                color: 0xa855f7, // ç´«è‰²
                name_cn: 'æœˆå…‰èŠ±å›­',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, moonFlowerPerMin: 2, scale: 1.0, shape: new THREE.TorusGeometry(0.5, 0.2, 8, 12) },
                    2: { cost: 150, moonFlowerPerMin: 5, scale: 1.3, shape: new THREE.TorusGeometry(0.6, 0.25, 8, 12) },
                    3: { cost: 300, moonFlowerPerMin: 10, scale: 1.7, shape: new THREE.TorusGeometry(0.7, 0.3, 8, 12) }
                }
            },
            CrystalCave: {
                cost: 150,
                color: 0x06b6d4, // é’è‰²
                name_cn: 'æ™¶ä½“æ´ç©´',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, mutationCrystalPerMin: 1, scale: 1.0, shape: new THREE.OctahedronGeometry(0.6) },
                    2: { cost: 200, mutationCrystalPerMin: 2, scale: 1.3, shape: new THREE.OctahedronGeometry(0.8) },
                    3: { cost: 400, mutationCrystalPerMin: 4, scale: 1.7, shape: new THREE.OctahedronGeometry(1.0) }
                }
            },
            VoidRift: {
                cost: 150,
                color: 0x4c1d95, // æ·±ç´«è‰²
                name_cn: 'è™šç©ºè£‚éš™',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, voidEssencePerMin: 1, scale: 1.0, shape: new THREE.TorusKnotGeometry(0.4, 0.15, 32, 8) },
                    2: { cost: 200, voidEssencePerMin: 2, scale: 1.3, shape: new THREE.TorusKnotGeometry(0.5, 0.2, 32, 8) },
                    3: { cost: 400, voidEssencePerMin: 4, scale: 1.7, shape: new THREE.TorusKnotGeometry(0.6, 0.25, 32, 8) }
                }
            },
            Museum: {
                cost: 200, // Stone
                color: 0x9333ea, // Purple
                name_cn: 'æ–‡ç‰©é¦†',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, slots: 2, scale: 1.0, shape: new THREE.BoxGeometry(1.2, 0.8, 1.2) },
                    2: { cost: 300, slots: 4, scale: 1.2, shape: new THREE.BoxGeometry(1.4, 1.0, 1.4) },
                    3: { cost: 600, slots: 6, scale: 1.4, shape: new THREE.BoxGeometry(1.6, 1.2, 1.6) }
                }
            }
            ,
            Exchange: {
                cost: 500, // Gold
                color: 0x10b981, // Emerald
                name_cn: 'äº¤æ˜“æ‰€',
                maxLevel: 1,
                levels: {
                    1: { cost: 0, scale: 1.0, shape: new THREE.OctahedronGeometry(1) },
                }
            },
            GemMine: {
                costGold: 500,
                costWood: 100,
                costStone: 100,
                color: 0xe879f9, // Fuchsia
                name_cn: 'å®çŸ³çŸ¿',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, gemsPerMin: 1, scale: 1.0, shape: new THREE.OctahedronGeometry(0.8), requiresWorker: true },
                    2: { costFood: 200, costWood: 50, costStone: 50, upgradeTime: 120, gemsPerMin: 2, scale: 1.3, shape: new THREE.OctahedronGeometry(1.0), requiresWorker: true },
                    3: { costFood: 500, costWood: 100, costStone: 100, upgradeTime: 300, gemsPerMin: 3, scale: 1.6, shape: new THREE.OctahedronGeometry(1.2), requiresWorker: true }
                }
            },
            TrainingGround: {
                costGold: 600,
                costWood: 150,
                costStone: 150,
                color: 0xef4444, // Red
                name_cn: 'è®­ç»ƒåœº',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, expPerMin: 10, scale: 1.0, shape: new THREE.ConeGeometry(0.8, 1.5, 6), requiresWorker: true },
                    2: { costFood: 300, costWood: 80, costStone: 80, upgradeTime: 180, expPerMin: 25, scale: 1.2, shape: new THREE.ConeGeometry(1.0, 1.8, 6), requiresWorker: true },
                    3: { costFood: 800, costWood: 150, costStone: 150, upgradeTime: 360, expPerMin: 50, scale: 1.4, shape: new THREE.ConeGeometry(1.2, 2.1, 6), requiresWorker: true }
                }
            },
            SanctuaryShrine: {
                costGold: 1000,
                costWood: 200,
                costStone: 200,
                color: 0xfbbf24, // Amber
                name_cn: 'åœ£åŸŸç¥æ®¿',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, staminaRegenBonus: 2, scale: 1.0, shape: new THREE.TorusKnotGeometry(0.5, 0.2, 64, 8) },
                    2: { costFood: 500, costWood: 100, costStone: 100, upgradeTime: 240, staminaRegenBonus: 5, scale: 1.2, shape: new THREE.TorusKnotGeometry(0.6, 0.25, 64, 8) },
                    3: { costFood: 1000, costWood: 200, costStone: 200, upgradeTime: 480, staminaRegenBonus: 10, scale: 1.4, shape: new THREE.TorusKnotGeometry(0.7, 0.3, 64, 8) }
                }
            },
            PotionWorkshop: {
                costGold: 800,
                costWood: 150,
                costStone: 150,
                color: 0x06b6d4, // Cyan
                name_cn: 'ç»éªŒè¯æ°´å·¥åŠ',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, craftTime: 120, expGrassRequired: 3, moonFlowerRequired: 2, potionType: 'exp_potion_s', scale: 1.0, shape: new THREE.BoxGeometry(1.2, 1.0, 1.2) },
                    2: { costFood: 400, costWood: 100, costStone: 100, upgradeTime: 200, craftTime: 90, expGrassRequired: 5, moonFlowerRequired: 3, potionType: 'exp_potion_l', scale: 1.2, shape: new THREE.BoxGeometry(1.4, 1.2, 1.4) },
                    3: { costFood: 1000, costWood: 200, costStone: 200, upgradeTime: 400, craftTime: 60, expGrassRequired: 8, moonFlowerRequired: 5, potionType: 'exp_potion_l', scale: 1.4, shape: new THREE.BoxGeometry(1.6, 1.4, 1.6) }
                }
            },
            MutationLab: {
                costGold: 1000,
                costWood: 200,
                costStone: 200,
                color: 0x9333ea, // Purple
                name_cn: 'å˜å¼‚å®éªŒå®¤',
                maxLevel: 3,
                levels: {
                    1: { cost: 0, craftTime: 180, mutationCrystalRequired: 3, voidEssenceRequired: 2, potionType: 'mutation_serum', scale: 1.0, shape: new THREE.IcosahedronGeometry(0.8) },
                    2: { costFood: 600, costWood: 150, costStone: 150, upgradeTime: 300, craftTime: 120, mutationCrystalRequired: 5, voidEssenceRequired: 3, potionType: 'mutation_serum', scale: 1.2, shape: new THREE.IcosahedronGeometry(1.0) },
                    3: { costFood: 1500, costWood: 300, costStone: 300, upgradeTime: 600, craftTime: 90, mutationCrystalRequired: 8, voidEssenceRequired: 5, potionType: 'mutation_serum', scale: 1.4, shape: new THREE.IcosahedronGeometry(1.2) }
                }
            }
        };

        // æ¸¸æˆçŠ¶æ€
        const gameState = {
            food: 200000,
            gold: 10000,
            wood: 20000,
            stone: 20000,
            gems: 0,
            expGrass: 0, // æ–°å¢ï¼šç»éªŒè‰
            moonFlower: 0, // æ–°å¢ï¼šæœˆå…‰èŠ±
            mutationCrystal: 0, // æ–°å¢ï¼šå˜å¼‚æ™¶ä½“
            voidEssence: 0, // æ–°å¢ï¼šè™šç©ºç²¾å
            breedingDenLevel: 1,
            foodPerTick: 5,
            animalCount: 0,
            maxAnimals: 5,
            animals: [], // å­˜å‚¨åŠ¨ç‰©æ•°æ®å¯¹è±¡ {id, name, color, mesh, ...}
            buildings: [], // å­˜å‚¨å·²æ”¾ç½®çš„å»ºç­‘
            isDragging: false,
            isBuildingMode: false,
            buildingToPlace: null, 
            previousMouseX: 0,
            lastStockRefreshDate: null, // æ–°å¢ï¼šå•†åº—åˆ·æ–°æ—¥æœŸ
            auctions: { // æ–°å¢ï¼šæ‹å–è¡ŒçŠ¶æ€
                items: [],
                lastUpdate: null
            },
            exchangeStock: [], // æ–°å¢ï¼šäº¤æ˜“æ‰€åº“å­˜
            collectibles: [], // æ–°å¢ï¼šå­˜å‚¨å¯æ”¶é›†çš„èµ„æºå¯¹è±¡
            animalToPlace: null, 
            assigningWorkerForBuilding: null, // æ–°å¢ï¼šè®°å½•æ­£åœ¨ä¸ºå“ªä¸ªå»ºç­‘åˆ†é…å·¥äºº
            upgradingBuildings: {}, // æ–°å¢ï¼šæ­£åœ¨å‡çº§çš„å»ºç­‘ {buildingId: {endTime, nextLevel}}
            wildAnimals: [], // æ–°å¢ï¼šé‡ç”ŸåŠ¨ç‰©
            activeExplorations: [], // æ–°å¢ï¼šæ´»è·ƒçš„æ¢ç´¢ä»»åŠ¡
            artifacts: [], // æ–°å¢ï¼šæ‹¥æœ‰çš„æ–‡ç‰©
            inventory: {}, // æ–°å¢ï¼šèƒŒåŒ…
            battleTeam: [null, null, null, null, null, null], // æ–°å¢ï¼šå‡ºæˆ˜é˜Ÿä¼ï¼ˆ6ä¸ªæ§½ä½ï¼‰
            firstTeamMember: null, // æ–°å¢ï¼šé¦–å‘åŠ¨ç‰©ID
            unlockedEncyclopedia: {}, // æ–°å¢ï¼šå·²è§£é”çš„å›¾é‰´ï¼ˆå¯¹è±¡æ ¼å¼ï¼šanimalId -> è§£é”ä¿¡æ¯ï¼‰
            mining: { // æ–°å¢ï¼šæŒ–çŸ¿çŠ¶æ€
                unlockedCheckpoints: [0],
                currentRun: {
                    isActive: false,
                    team: [],
                    currentDepth: 0,
                    lastTick: 0
                }
            }
        };

        // UI å…ƒç´ å¼•ç”¨
        const ui = {
            food: document.querySelector('#stat-food span'),
            gold: document.querySelector('#stat-gold span'),
            wood: document.querySelector('#stat-wood span'),
            stone: document.querySelector('#stat-stone span'),
            gems: document.querySelector('#stat-gems span'),
            expGrass: document.querySelector('#stat-exp-grass span'),
            moonFlower: document.querySelector('#stat-moon-flower span'),
            mutationCrystal: document.querySelector('#stat-mutation-crystal span'),
            voidEssence: document.querySelector('#stat-void-essence span'),
            denLevel: document.querySelector('#stat-den-level span'),
            animalCount: document.querySelector('#stat-animal-count span'),
            farmCount: document.getElementById('farm-count'),
            mineCount: document.getElementById('mine-count'),
            statusMessage: document.getElementById('status-message'),
            btnUpgradeDen: document.getElementById('btn-upgrade-den'),
            btnOpenBuild: document.getElementById('btn-open-build'),
            buildMainMenu: document.getElementById('build-main-menu'),
            buildMaterialMenu: document.getElementById('build-material-menu'),
            buildExchangeMenu: document.getElementById('build-exchange-menu'),
            buildLandmarksMenu: document.getElementById('build-landmarks-menu'),
            buildAdvancedMenu: document.getElementById('build-advanced-menu'),
            buildButtons: document.querySelectorAll('.build-button'),
            container: document.getElementById('container'),
            
            // å»ºç­‘è¯¦æƒ… UI å…ƒç´ 
            detailPanel: document.getElementById('building-details-panel'),
            detailName: document.getElementById('detail-name'),
            detailIcon: document.getElementById('detail-icon'), // æ–°å¢
            detailLevel: document.getElementById('detail-level'),
            detailCurrentEffect: document.getElementById('detail-current-effect'),
            detailNextUpgrade: document.getElementById('detail-next-upgrade'),
            detailNextEffect: document.getElementById('detail-next-effect'),
            nextLevel: document.getElementById('next-level'),
            btnUpgradeBuilding: document.getElementById('btn-upgrade-building'),
            btnCraftPotion: document.getElementById('btn-craft-potion'),
            upgradeCostDisplay: document.getElementById('upgrade-cost-display'),
            btnCloseDetails: document.getElementById('btn-close-details'),
            workerSlot: document.getElementById('worker-slot'),
            workerInfo: document.getElementById('worker-info'),
            assignWorkerSection: document.getElementById('assign-worker-section'),
            noWorkerText: document.getElementById('no-worker-text'),
            btnAssignWorker: document.getElementById('btn-assign-worker'),
            // æ–°å¢ï¼šå·¥äººé€‰æ‹©é¢æ¿UI
            workerSelectionPanel: document.getElementById('worker-selection-panel'),
            workerSelectionList: document.getElementById('worker-selection-list'),
            btnCloseWorkerSelection: document.getElementById('btn-close-worker-selection'),

            // åŠ¨ç‰©ç³»ç»Ÿ UI å…ƒç´ 
            btnOpenAnimalSystem: document.getElementById('btn-open-animal-roster'),
            btnOpenEncyclopedia: document.getElementById('btn-open-encyclopedia'), // æ–°å¢
            btnOpenExploration: document.getElementById('btn-open-exploration'),
            btnOpenMining: document.getElementById('btn-open-mining'),
            btnOpenWorldMap: document.getElementById('btn-open-world-map'),
            btnOpenShop: document.getElementById('btn-open-shop'),
            btnOpenInventory: document.getElementById('btn-open-inventory'), // æ–°å¢
            btnPlaceAnimal: document.getElementById('btn-place-animal'),
            btnRecallAnimal: document.getElementById('btn-recall-animal'),

            // æ–°å¢ï¼šç‹¬ç«‹åŠ¨ç‰©è¯¦æƒ…é¢æ¿UI
            standaloneDetailPanel: document.getElementById('animal-standalone-details-panel'),
            btnCloseStandaloneDetails: document.getElementById('btn-close-standalone-details'),
            standaloneDetailName: document.getElementById('standalone-animal-detail-name'),
            standaloneDetailLevel: document.getElementById('standalone-animal-detail-level'),
            standaloneDetailGender: document.getElementById('standalone-animal-detail-gender'),
            standaloneDetailExpText: document.getElementById('standalone-animal-detail-exp-text'),
            standaloneDetailExpBar: document.getElementById('standalone-animal-detail-exp-bar'),
            standaloneDetailStamina: document.getElementById('standalone-animal-detail-stamina'),
            standaloneDetailFavorability: document.getElementById('standalone-animal-detail-favorability'),
            standaloneDetailPotential: document.getElementById('standalone-animal-detail-potential'),
            standaloneDetailElement: document.getElementById('standalone-animal-detail-element'),
            standaloneDetailDevelopment: document.getElementById('standalone-animal-detail-development'),
            standaloneAbilityCombatAtk: document.getElementById('standalone-ability-combat-atk'),
            standaloneAbilityCombatDef: document.getElementById('standalone-ability-combat-def'),
            standaloneAbilityCombatAgi: document.getElementById('standalone-ability-combat-agi'),
            standaloneCombatSkills: document.getElementById('standalone-combat-skills'), // æ–°å¢
            standaloneBtnFeed: document.getElementById('standalone-btn-feed-animal'),
            standaloneBtnPlace: document.getElementById('standalone-btn-place-animal'),
            standaloneBtnRecall: document.getElementById('standalone-btn-recall-animal'),
            standaloneBtnChallenge: document.getElementById('standalone-btn-challenge'),

            // æ–°å¢ï¼šæˆ˜æ–—é¢æ¿UI
            modalOverlay: document.getElementById('modal-overlay'), // æ–°å¢ï¼šé®ç½©å±‚
            battleSetupPanel: document.getElementById('battle-setup-panel'),
            btnCloseBattleSetupPanel: document.getElementById('btn-close-battle-setup-panel'),
            battleOpponentInfo: document.getElementById('battle-opponent-info'),
            battleTeamSelectionList: document.getElementById('battle-team-selection-list'),
            btnExecuteBattle: document.getElementById('btn-execute-battle'),

            // æ–°å¢ï¼šæ–‡ç‰©é¦† UI
            museumPanel: document.getElementById('museum-panel'),
            btnCloseMuseum: document.getElementById('btn-close-museum'),
            museumSlots: document.getElementById('museum-slots'),
            museumInventory: document.getElementById('museum-inventory'),
            museumCapacity: document.getElementById('museum-capacity'),

            // æ–°å¢ï¼šå•†åº— UI
            shopPanel: document.getElementById('shop-panel'),
            btnCloseShop: document.getElementById('btn-close-shop'),
            shopItemsContainer: document.getElementById('shop-items-container'),
            shopGoldDisplay: document.getElementById('shop-gold-display'),

            // æ–°å¢ï¼šäº¤æ˜“æ‰€ UI
            exchangePanel: document.getElementById('exchange-panel'),
            btnCloseExchange: document.getElementById('btn-close-exchange'),
            exchangeContent: document.getElementById('exchange-content'),
            exchangeGoldDisplay: document.getElementById('exchange-gold-display'),

            // æ–°å¢ï¼šæ‹å–è¡Œç«ä»· UI
            auctionBidPanel: document.getElementById('auction-bid-panel'),
            btnCloseBidPanel: document.getElementById('btn-close-bid-panel'),
            bidPanelTitle: document.getElementById('bid-panel-title'),
            bidPanelIcon: document.getElementById('bid-panel-icon'),
            bidPanelCurrentBid: document.getElementById('bid-panel-current-bid'),
            bidPanelHighestBidder: document.getElementById('bid-panel-highest-bidder'),
            bidPanelTimeLeft: document.getElementById('bid-panel-time-left'),
            // æ–°å¢ï¼šèƒŒåŒ… UI
            inventoryPanel: document.getElementById('inventory-panel'),
            btnCloseInventory: document.getElementById('btn-close-inventory'),
            inventoryItemsContainer: document.getElementById('inventory-items-container'),
            inventoryEmptyMsg: document.getElementById('inventory-empty-msg'),
            itemTargetSelector: document.getElementById('item-target-selector'),
            btnCloseTargetSelector: document.getElementById('btn-close-target-selector'),
            targetAnimalList: document.getElementById('target-animal-list'),
            
            // æ–°å¢ï¼šå‡ºæˆ˜é˜Ÿä¼UI
            teamSelectorPanel: document.getElementById('team-selector-panel'),
            btnCloseTeamSelector: document.getElementById('btn-close-team-selector'),
            teamAnimalList: document.getElementById('team-animal-list'),
            currentSlotInfo: document.getElementById('current-slot-info'),
            battleTeamSlots: document.getElementById('battle-team-slots'),
            
            // æ–°å¢ï¼šèƒŒåŒ…å†…åŠ¨ç‰©è¯¦æƒ…UI
            inventoryAnimalDetail: document.getElementById('inventory-animal-detail'),
            inventoryDetailEmpty: document.getElementById('inventory-detail-empty'),
            invDetailAvatar: document.getElementById('inv-detail-avatar'),
            invDetailName: document.getElementById('inv-detail-name'),
            invDetailLevel: document.getElementById('inv-detail-level'),
            invDetailGender: document.getElementById('inv-detail-gender'),
            invDetailExpText: document.getElementById('inv-detail-exp-text'),
            invDetailExpBar: document.getElementById('inv-detail-exp-bar'),
            invDetailStamina: document.getElementById('inv-detail-stamina'),
            invDetailPotential: document.getElementById('inv-detail-potential'),
            invDetailElement: document.getElementById('inv-detail-element'),
            invDetailAttack: document.getElementById('inv-detail-attack'),
            invDetailDefense: document.getElementById('inv-detail-defense'),
            invDetailAgility: document.getElementById('inv-detail-agility'),
            invDetailBtnFeed: document.getElementById('inv-detail-btn-feed'),
            invDetailBtnRemove: document.getElementById('inv-detail-btn-remove'),
            invDetailBtnSetFirst: document.getElementById('inv-detail-btn-set-first'),
            invDetailCombatSkills: document.getElementById('inv-detail-combat-skills'),
            
            // æŠ€èƒ½é€‰æ‹©é¢æ¿
            skillSelectorPanel: document.getElementById('skill-selector-panel'),
            btnCloseSkillSelector: document.getElementById('btn-close-skill-selector'),
            availableSkillsList: document.getElementById('available-skills-list'),
            currentSkillSlotInfo: document.getElementById('current-skill-slot-info'),
        };


        // --- Three.js åˆå§‹åŒ–å’Œäº‹ä»¶å¤„ç† (ä¸ä¹‹å‰ç‰ˆæœ¬ä¸€è‡´) ---

        function initThreeJS() {
            const width = window.innerWidth;
            const height = window.innerHeight;

            // åœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a1120); 

            // æ‘„åƒæœº
            camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
            camera.position.set(0, 15, 25); 
            camera.lookAt(0, 0, 0);

            // æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            ui.container.appendChild(renderer.domElement);

            // äº¤äº’å·¥å…·
            raycaster = new THREE.Raycaster();
            pointer = new THREE.Vector2();

            // å…‰æº
            const ambientLight = new THREE.AmbientLight(0xcccccc, 1.5); 
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 3);
            directionalLight.position.set(5, 20, 10);
            directionalLight.target.position.set(0, 0, 0);
            scene.add(directionalLight);
            scene.add(directionalLight.target);

            // ä¸–ç•Œç¾¤ç»„ï¼Œæ‰€æœ‰å¯æ—‹è½¬å¯¹è±¡éƒ½æ”¾å…¥å…¶ä¸­
            worldGroup = new THREE.Group();
            scene.add(worldGroup);

            // 1. åˆ›å»ºæ –æ¯åœ°æ¨¡å‹ (ç½‘æ ¼å¹³é¢)
            const habitatGeometry = new THREE.PlaneGeometry(GRID_SIZE, GRID_SIZE);
            const habitatMaterial = new THREE.MeshLambertMaterial({
                color: 0x22c55e, 
                side: THREE.DoubleSide
            });
            habitatMesh = new THREE.Mesh(habitatGeometry, habitatMaterial);
            habitatMesh.rotation.x = -Math.PI / 2; // æ—‹è½¬ä¸ºæ°´å¹³é¢
            habitatMesh.position.y = 0;
            habitatMesh.userData.isHabitat = true;
            worldGroup.add(habitatMesh);

            const gridHelper = new THREE.GridHelper(GRID_SIZE, GRID_DIVISIONS, 0x444444, 0x888888); // Keep grid helper
            gridHelper.position.y = 0.01; // Slightly above the plane to prevent z-fighting
            worldGroup.add(gridHelper);
            
            // 2. åˆ›å»ºç¹æ®–çª (ç«‹æ–¹ä½“)
            const denGeometry = new THREE.BoxGeometry(2, 2, 2);
            const denMaterial = new THREE.MeshPhongMaterial({
                color: 0xef4444, 
                emissive: 0x992d2d,
                shininess: 50
            });
            denMesh = new THREE.Mesh(denGeometry, denMaterial);
            denMesh.position.set(0, 1.0, 0); // ç¹æ®–çªä»åœ¨ä¸­å¿ƒ
            denMesh.userData.isCoreBuilding = true;
            worldGroup.add(denMesh);

            // 3. åŠ¨ç‰©ç¾¤ç»„
            animalGroup = new THREE.Group();
            worldGroup.add(animalGroup);

            // 4. å¯æ”¶é›†ç‰©å“ç»„
            collectiblesGroup = new THREE.Group();
            worldGroup.add(collectiblesGroup);


            // äº‹ä»¶ç›‘å¬å™¨
            window.addEventListener('resize', onWindowResize, false);
            ui.container.addEventListener('mousedown', onPointerDown, false);
            ui.container.addEventListener('mousemove', onPointerMove, false);
            ui.container.addEventListener('mouseup', onPointerUp, false);
            ui.container.addEventListener('touchstart', onPointerDown, false);
            ui.container.addEventListener('touchmove', onPointerMove, false);
            ui.container.addEventListener('touchend', onPointerUp, false);
            // æ–°å¢ï¼šé”®ç›˜äº‹ä»¶ç›‘å¬
            window.addEventListener('keydown', onKeyDown, false);
            window.addEventListener('keyup', onKeyUp, false);
            
            ui.btnCloseDetails.addEventListener('click', closeBuildingDetails, false);
            ui.btnUpgradeBuilding.addEventListener('click', () => upgradeBuilding(selectedBuilding), false);
            ui.btnCraftPotion.addEventListener('click', () => craftPotion(selectedBuilding), false);
            ui.btnCloseWorkerSelection.addEventListener('click', closeWorkerSelection, false);
            ui.btnAssignWorker.addEventListener('click', openWorkerSelection, false);

            // åŠ¨ç‰©ç³»ç»Ÿäº‹ä»¶ç›‘å¬å™¨
            ui.btnOpenAnimalSystem.addEventListener('click', openAnimalManagementPage, false);
            ui.btnOpenEncyclopedia.addEventListener('click', openEncyclopediaPage, false); // ä¿®æ”¹ï¼šè·³è½¬åˆ°å›¾é‰´é¡µé¢
            ui.btnOpenExploration.addEventListener('click', openExplorationPage, false);
            ui.btnOpenMining.addEventListener('click', openMiningPage, false);
            ui.btnOpenWorldMap.addEventListener('click', openWorldMapPage, false);
            ui.btnOpenShop.addEventListener('click', openShopPanel, false);
            ui.btnOpenInventory.addEventListener('click', openInventoryPanel, false); // æ–°å¢

            ui.btnCloseStandaloneDetails.addEventListener('click', closeStandaloneAnimalDetails, false);
            ui.btnCloseBattleSetupPanel.addEventListener('click', closeBattleSetupPanel, false);
            ui.btnExecuteBattle.addEventListener('click', startCombat, false);
            ui.btnCloseMuseum.addEventListener('click', closeMuseumPanel, false);
            ui.btnCloseExchange.addEventListener('click', closeExchangePanel, false);
            ui.btnCloseBidPanel.addEventListener('click', closeAuctionBidPanel, false);
            document.getElementById('btn-place-bid').addEventListener('click', placeBid, false);

            // ä¿®å¤ï¼šé‡æ–°ç»‘å®šå»ºç­‘é€‰æ‹©æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            ui.btnCloseInventory.addEventListener('click', closeInventoryPanel, false);
            ui.btnCloseTargetSelector.addEventListener('click', closeTargetSelector, false);
            if (ui.btnCloseTeamSelector) {
                ui.btnCloseTeamSelector.addEventListener('click', closeTeamSelector, false);
            }
            if (ui.btnCloseSkillSelector) {
                ui.btnCloseSkillSelector.addEventListener('click', closeSkillSelector, false);
            }
            ui.btnCloseShop.addEventListener('click', closeShopPanel, false);
            ui.buildButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const buildingType = event.currentTarget.dataset.building;
                    enterBuildMode(buildingType);
                });
            });

            // å¯åŠ¨åŠ¨ç”»å¾ªç¯
            animate();
        }

        // çª—å£å°ºå¯¸å˜åŒ–å¤„ç†
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * å…³é—­æ‰€æœ‰éæ ¸å¿ƒ UI é¢æ¿ï¼ˆå»ºç­‘è¯¦æƒ…ã€åŠ¨ç‰©è¯¦æƒ…ã€åŠ¨ç‰©åå†Œï¼‰ã€‚
         */
        function closeAllDetailPanels() {
            closeBuildingDetails();
            closeStandaloneAnimalDetails();
            closeWorkerSelection();
            closeBattleSetupPanel();
            closeMuseumPanel();
            closeShopPanel();
            closeExchangePanel();
            closeAuctionBidPanel();
            closeInventoryPanel();
            closeTargetSelector();
            if (typeof closeTeamSelector === 'function') closeTeamSelector();
            if (typeof closeSkillSelector === 'function') closeSkillSelector();
        }

        // æ–°å¢ï¼šé”®ç›˜æŒ‰ä¸‹äº‹ä»¶å¤„ç†
        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW':
                    cameraMovement.forward = true;
                    break;
                case 'KeyA':
                    cameraMovement.left = true;
                    break;
                case 'KeyS':
                    cameraMovement.backward = true;
                    break;
                case 'KeyD':
                    cameraMovement.right = true;
                    break;
            }
        }

        // æ–°å¢ï¼šé”®ç›˜æ¾å¼€äº‹ä»¶å¤„ç†
        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': cameraMovement.forward = false; break;
                case 'KeyA': cameraMovement.left = false; break;
                case 'KeyS': cameraMovement.backward = false; break;
                case 'KeyD': cameraMovement.right = false; break;
            }
        }


        // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶å¤„ç† (ç”¨äºæ—‹è½¬è§†è§’æˆ–æ”¾ç½®å»ºç­‘/ç‚¹å‡»ç‰©ä½“)
        function onPointerDown(event) {
            event.preventDefault();
            
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);
            
            // è®¡ç®—æŒ‡é’ˆä½ç½®
            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = - ((clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(pointer, camera);
            
            // æ”¶é›†æ‰€æœ‰å¯äº¤äº’çš„ mesh
            // åˆå¹¶ç©å®¶åŠ¨ç‰©å’Œé‡ç”ŸåŠ¨ç‰©çš„ mesh
            const animalMeshes = [...gameState.animals.map(a => a.mesh), ...gameState.wildAnimals.map(a => a.mesh)];
            const interactableMeshes = [habitatMesh, denMesh, ...gameState.buildings.map(b => b.mesh), ...animalMeshes, ...gameState.collectibles.map(c => c.mesh)];

            const intersects = raycaster.intersectObjects(interactableMeshes);
            
            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                
                // --- ç‚¹å‡»åŠ¨ç‰©æ¨¡å‹é€»è¾‘ ---
                if (clickedObject.userData.collectibleId) {
                    collectResource(clickedObject.userData.collectibleId);
                    exitBuildMode();
                    return;
                }


                if (clickedObject.userData.animalId) {
                    // åœ¨ç©å®¶åŠ¨ç‰©å’Œé‡ç”ŸåŠ¨ç‰©ä¸­åŒæ—¶æŸ¥æ‰¾
                    const foundAnimal = gameState.animals.find(a => a.id === clickedObject.userData.animalId) || 
                                        gameState.wildAnimals.find(a => a.id === clickedObject.userData.animalId);
                    if (foundAnimal) {
                        // openAnimalCultivationPanel(foundAnimal.id); // æ‰“å¼€é¢æ¿å¹¶ç›´æ¥æ˜¾ç¤ºè¯¥åŠ¨ç‰©è¯¦æƒ…
                        openStandaloneAnimalDetails(foundAnimal.id);
                        exitBuildMode(); 
                        return; 
                    }
                }

                // --- å»ºç­‘é€‰æ‹©é€»è¾‘ ---
                if (clickedObject.userData.buildingId) {
                    const foundBuilding = gameState.buildings.find(b => b.id === clickedObject.userData.buildingId);
                    if (foundBuilding) {
                        // å¦‚æœæ˜¯æ–‡ç‰©é¦†ï¼Œæ‰“å¼€æ–‡ç‰©é¢æ¿
                        if (foundBuilding.type === 'Museum') {
                            openMuseumPanel(foundBuilding);
                            exitBuildMode();
                            return;
                        }
                        if (foundBuilding.type === 'Exchange') {
                            openExchangePanel();
                            exitBuildMode();
                            return;
                        }
                        showBuildingDetails(foundBuilding);
                        exitBuildMode(); // å¦‚æœç‚¹å‡»äº†å»ºç­‘ï¼Œé€€å‡ºå»ºé€ æ¨¡å¼
                        return; // é˜»æ­¢æ‹–åŠ¨æ“ä½œ
                    }
                }
                
                // --- å»ºç­‘æ”¾ç½®é€»è¾‘ ---
                if (gameState.isBuildingMode && gameState.buildingToPlace && clickedObject.userData.isHabitat) {
                    // ç¡®ä¿å»ºç­‘ä½äºåˆæ³•çš„æ”¾ç½®åŒºåŸŸ
                    const intersectionPoint = intersects[0].point;
                    const snappedPoint = snapToGrid(intersectionPoint);
                    if (isValidPlacement(snappedPoint)) {
                        placeBuilding(snappedPoint);
                    } else {
                        showStatus(`âŒ æ”¾ç½®å¤±è´¥: ç¦»å…¶ä»–å»ºç­‘æˆ–ç¹æ®–çªå¤ªè¿‘äº†!`, 3000);
                    }
                    return; 
                }

                // --- åŠ¨ç‰©æ”¾ç½®é€»è¾‘ ---
                if (gameState.animalToPlace && clickedObject.userData.isHabitat) {
                    const intersectionPoint = intersects[0].point;
                    const snappedPoint = snapToGrid(intersectionPoint);
                    placeAnimal(snappedPoint);
                    return;
                }

                // å¦‚æœç‚¹å‡»äº†å¯äº¤äº’å¯¹è±¡ä½†æ²¡æœ‰è§¦å‘ä»»ä½•ç‰¹å®šæ“ä½œï¼Œä¹Ÿé˜»æ­¢åç»­çš„æ‹–åŠ¨
                // å¹¶å…è®¸é¢æ¿ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œç›´åˆ°ç‚¹å‡»ç©ºç™½åŒºåŸŸ
                return;
            }

            // --- å¦‚æœæ²¡æœ‰ç‚¹å‡»åˆ°ä»»ä½•å¯äº¤äº’å¯¹è±¡ ---
            // å…³é”®ä¿®å¤ï¼šä»…å½“ç‚¹å‡»äº‹ä»¶çš„ç›®æ ‡æ˜¯æ¸²æŸ“å™¨ç”»å¸ƒæœ¬èº«ï¼ˆå³åœºæ™¯èƒŒæ™¯ï¼‰æ—¶æ‰å…³é—­é¢æ¿
            if (event.target === renderer.domElement) {
                // å…³é—­æ‰€æœ‰æ‰“å¼€çš„è¯¦æƒ…é¢æ¿
                closeAllDetailPanels();
            }

            // å¦‚æœæ²¡æœ‰ç‚¹å‡»åˆ°å»ºç­‘/åŠ¨ç‰©æˆ–å¤„äºå»ºé€ æ¨¡å¼ï¼Œåˆ™å¯ç”¨æ‹–åŠ¨
            gameState.isDragging = true;
            gameState.previousMouseX = clientX;
        }

        function onPointerMove(event) {
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);

            // 1. å»ºç­‘é¢„è§ˆç§»åŠ¨
            if (gameState.isBuildingMode && previewMesh) {
                const rect = renderer.domElement.getBoundingClientRect();
                pointer.x = ((clientX - rect.left) / rect.width) * 2 - 1;
                pointer.y = - ((clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(pointer, camera);
                const intersects = raycaster.intersectObjects([habitatMesh]);
                
                if (intersects.length > 0) {
                    const intersectionPoint = intersects[0].point;
                    const snappedPoint = snapToGrid(intersectionPoint);
                    
                    if (isValidPlacement(snappedPoint)) {
                         previewMesh.material.color.setHex(0x00ff00); // ç»¿è‰²ï¼šå¯æ”¾ç½®
                    } else {
                         previewMesh.material.color.setHex(0xff0000); // çº¢è‰²ï¼šä¸å¯æ”¾ç½®
                    }
                    previewMesh.position.copy(snappedPoint);
                    previewMesh.position.y += previewMesh.userData.height / 2;
                }
            }

            // åŠ¨ç‰©æ”¾ç½®é¢„è§ˆ
            if (gameState.animalToPlace && previewMesh) {
                const rect = renderer.domElement.getBoundingClientRect();
                pointer.x = ((clientX - rect.left) / rect.width) * 2 - 1;
                pointer.y = - ((clientY - rect.top) / rect.height) * 2 + 1;
                
                raycaster.setFromCamera(pointer, camera);
                const intersects = raycaster.intersectObjects([habitatMesh]);

                if (intersects.length > 0) {
                    const intersectionPoint = intersects[0].point;
                    const snappedPoint = snapToGrid(intersectionPoint);
                    previewMesh.position.copy(snappedPoint);
                    previewMesh.position.y += previewMesh.userData.height / 2; // ä¿æŒåœ¨åœ°é¢ä¸Š
                }
            }

            // 2. åœºæ™¯æ‹–åŠ¨
            if (gameState.isDragging && !gameState.isBuildingMode) {
                const deltaX = clientX - gameState.previousMouseX;
                // æ—‹è½¬æ•´ä¸ªä¸–ç•Œç¾¤ç»„
                worldGroup.rotation.y += deltaX * 0.005;
                gameState.previousMouseX = clientX;
            }
        }

        function onPointerUp() {
            gameState.isDragging = false;
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);

            // æ›´æ–°ç›¸æœºä½ç½®
            const moveSpeed = 0.2;
            const cameraDirection = new THREE.Vector3();
            camera.getWorldDirection(cameraDirection);
            cameraDirection.y = 0; // ä¿æŒåœ¨æ°´å¹³é¢ç§»åŠ¨
            cameraDirection.normalize();

            const rightDirection = new THREE.Vector3();
            rightDirection.crossVectors(camera.up, cameraDirection).normalize();

            if (cameraMovement.forward) {
                camera.position.addScaledVector(cameraDirection, moveSpeed);
            }
            if (cameraMovement.backward) {
                camera.position.addScaledVector(cameraDirection, -moveSpeed);
            }
            if (cameraMovement.left) {
                camera.position.addScaledVector(rightDirection, moveSpeed);
            }
            if (cameraMovement.right) {
                camera.position.addScaledVector(rightDirection, -moveSpeed);
            }

            // åŠ¨ç‰©å’Œç¹æ®–çªè½»å¾®æ‘‡æ‘† (å¢åŠ ç›†æ ½æ´»åŠ›)
            const time = Date.now() * 0.0005;
            denMesh.rotation.y += 0.005;
            gameState.animals.forEach(animalData => {
                // åªè®©æœªæ”¾ç½®ï¼ˆåœ¨â€œå®¶â€é‡Œï¼‰çš„åŠ¨ç‰©æ‘‡æ‘†
                if (!animalData.isPlaced) {
                    const animal = animalData.mesh;
                    animal.position.y = 1 + Math.sin(time * 5 + animalData.id.charCodeAt(0)) * 0.1;
                    animal.rotation.y += 0.01;
                }
            });

            // å¯æ”¶é›†ç‰©å“çš„åŠ¨ç”»
            gameState.collectibles.forEach(collectible => {
                const collectibleMesh = collectible.mesh;
                collectibleMesh.rotation.y += 0.02;
                collectibleMesh.position.y = collectible.baseY + Math.sin(time * 3 + collectible.id.charCodeAt(0)) * 0.2;
            });


            renderer.render(scene, camera);
        }

        // --- æ¸¸æˆé€»è¾‘å’Œå¾ªç¯ ---

        // æ›´æ–° UI
        function updateUI() {
            ui.food.textContent = Math.floor(gameState.food).toLocaleString();
            ui.gold.textContent = gameState.gold;
            ui.wood.textContent = gameState.wood;
            ui.stone.textContent = gameState.stone;
            ui.gems.textContent = gameState.gems;
            ui.expGrass.textContent = gameState.expGrass;
            ui.moonFlower.textContent = gameState.moonFlower;
            ui.mutationCrystal.textContent = gameState.mutationCrystal;
            ui.voidEssence.textContent = gameState.voidEssence;
            ui.denLevel.textContent = gameState.breedingDenLevel;
            ui.animalCount.textContent = `${gameState.animalCount} / ${gameState.maxAnimals}`;
            
            // æ›´æ–°å»ºç­‘è®¡æ•°
            const farmCount = gameState.buildings.filter(b => b.type === 'Farm').length;
            const mineCount = gameState.buildings.filter(b => b.type === 'GemMine').length;
            ui.farmCount.textContent = farmCount;
            ui.mineCount.textContent = mineCount;

            // æ›´æ–°å‡çº§æŒ‰é’®çš„è´¹ç”¨æç¤º
            const upgradeCost = gameState.breedingDenLevel * 50;
            ui.btnUpgradeDen.querySelector('span').textContent = ` (è´¹ç”¨: ${upgradeCost} é£Ÿç‰©)`;
        }

        // æ˜¾ç¤ºä¸´æ—¶çŠ¶æ€æ¶ˆæ¯
        function showStatus(message, duration = 2500) {
            ui.statusMessage.textContent = message;
            setTimeout(() => {
                ui.statusMessage.textContent = '';
            }, duration);
        }

        // åˆå§‹åŒ–èµ„æºå¾ªç¯å®šæ—¶å™¨
        function startResourceLoops() {
            // é£Ÿç‰©äº§å‡º (æ¯ 5 ç§’)
            foodTimer = setInterval(() => {
                // å†œåœºäº§å‡º
                gameState.buildings.filter(b => b.type === 'Farm').forEach(farm => {
                    const amount = BUILDINGS.Farm.levels[farm.level].foodPerTick;
                    spawnCollectible(farm, 'food', amount);
                    processProduction(farm, 'food', amount);
                });
                // ç©ºä¸­èŠ±å›­äº§å‡º (æ¯ 10 ç§’äº§å‡ºä¸€æ¬¡ï¼Œè¿™é‡Œåœ¨5ç§’å¾ªç¯é‡Œåšä¸ªåˆ¤æ–­ï¼Œæˆ–è€…ç®€å•ç‚¹æ¯æ¬¡éƒ½äº§å‡º)
                gameState.buildings.filter(b => b.type === 'SkyGarden').forEach(garden => {
                    const amount = BUILDINGS.SkyGarden.levels[garden.level].foodPerTick;
                    spawnCollectible(garden, 'food', amount); // äº§å‡ºå¤§é‡é£Ÿç‰©
                    processProduction(garden, 'food', amount);
                });
            }, 5000); 

            // å…¶ä»–èµ„æºäº§å‡º (æ¯ 60 ç§’)
            gemTimer = setInterval(() => {
                gameState.buildings.forEach(b => {
                    if (b.type === 'Mint') {
                        const amount = BUILDINGS.Mint.levels[b.level].goldPerMin;
                        spawnCollectible(b, 'gold', amount);
                        processProduction(b, 'gold', amount);
                    }
                    if (b.type === 'LumberMill') {
                        const amount = BUILDINGS.LumberMill.levels[b.level].woodPerMin;
                        spawnCollectible(b, 'wood', amount);
                        processProduction(b, 'wood', amount);
                    }
                    if (b.type === 'Quarry') {
                        const amount = BUILDINGS.Quarry.levels[b.level].stonePerMin;
                        spawnCollectible(b, 'stone', amount);
                        processProduction(b, 'stone', amount);
                    }
                    if (b.type === 'HerbGarden') {
                        const amount = BUILDINGS.HerbGarden.levels[b.level].expGrassPerMin;
                        spawnCollectible(b, 'expGrass', amount);
                        processProduction(b, 'expGrass', amount);
                    }
                    if (b.type === 'MoonGarden') {
                        const amount = BUILDINGS.MoonGarden.levels[b.level].moonFlowerPerMin;
                        spawnCollectible(b, 'moonFlower', amount);
                        processProduction(b, 'moonFlower', amount);
                    }
                    if (b.type === 'CrystalCave') {
                        const amount = BUILDINGS.CrystalCave.levels[b.level].mutationCrystalPerMin;
                        spawnCollectible(b, 'mutationCrystal', amount);
                        processProduction(b, 'mutationCrystal', amount);
                    }
                    if (b.type === 'VoidRift') {
                        const amount = BUILDINGS.VoidRift.levels[b.level].voidEssencePerMin;
                        spawnCollectible(b, 'voidEssence', amount);
                        processProduction(b, 'voidEssence', amount);
                    }
                    if (b.type === 'GemMine') {
                        // å®çŸ³çŸ¿éœ€è¦å·¥äººæ‰èƒ½äº§å‡º
                        if (b.workerId) {
                            const amount = BUILDINGS.GemMine.levels[b.level].gemsPerMin;
                            spawnCollectible(b, 'gems', amount);
                            processProduction(b, 'gems', amount);
                        }
                    }
                    if (b.type === 'TrainingGround') {
                        // è®­ç»ƒåœºä¸ºå·¥ä½œçš„åŠ¨ç‰©æä¾›ç»éªŒ
                        if (b.workerId) {
                            const worker = gameState.animals.find(a => a.id === b.workerId);
                            if (worker) {
                                const expAmount = BUILDINGS.TrainingGround.levels[b.level].expPerMin;
                                worker.experience += expAmount;
                                // æ£€æŸ¥å‡çº§
                                while (worker.experience >= worker.experienceToNextLevel) {
                                    worker.experience -= worker.experienceToNextLevel;
                                    worker.level++;
                                    worker.experienceToNextLevel = Math.floor(LEVEL_CONFIG.baseExperience * Math.pow(LEVEL_CONFIG.experienceMultiplier, worker.level - 1));
                                    // æå‡å±æ€§
                                    const multiplier = LEVEL_CONFIG.potentialMultipliers[worker.potential];
                                    worker.abilities.combat.attack += Math.floor(LEVEL_CONFIG.baseGrowth.attack * multiplier.combat);
                                    worker.abilities.combat.defense += Math.floor(LEVEL_CONFIG.baseGrowth.defense * multiplier.combat);
                                    worker.abilities.combat.agility += Math.floor(LEVEL_CONFIG.baseGrowth.agility * multiplier.combat);
                                    worker.maxStamina += Math.floor(LEVEL_CONFIG.baseGrowth.stamina * multiplier.stamina);
                                    showStatus(`â¬†ï¸ ${worker.name} åœ¨è®­ç»ƒåœºå‡çº§è‡³ Lv.${worker.level}ï¼`, 3000);
                                }
                            }
                        }
                    }
                });
            }, 60000);
        }

        // å¤„ç†ç”Ÿäº§é€»è¾‘ï¼ˆåŒ…å«æŠ€èƒ½åŠ æˆï¼‰
        function processProduction(building, resourceType, baseAmount) {
            let finalAmount = baseAmount;
            let isHighQuality = false;
            let extraAmount = 0;

            const worker = building.workerId ? gameState.animals.find(a => a.id === building.workerId) : null;
            
            if (worker) {
                // ç§»é™¤æ‰€æœ‰å·¥ä½œæŠ€èƒ½åŠ æˆé€»è¾‘ï¼Œå›å½’åŸºç¡€äº§å‡º
                // ä»…ä¿ç•™å¥½æ„Ÿåº¦å¾®é‡åŠ æˆ (å¯é€‰)
                if (worker.favorability > 50) {
                    finalAmount *= 1.05; // å¥½æ„Ÿåº¦>50ï¼Œäº§é‡+5%
                }
            }

            // é«˜å“è´¨ = åŒå€äº§é‡
            if (isHighQuality) finalAmount *= 2;

            spawnCollectible(building, resourceType, Math.floor(finalAmount + extraAmount));
        }

        // æ–°å¢ï¼šç”Ÿæˆå¯æ”¶é›†çš„èµ„æºå¯¹è±¡
        function spawnCollectible(building, resourceType, amount) {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒç±»å‹çš„å¯æ”¶é›†ç‰©åœ¨è¯¥å»ºç­‘ä¸Š
            const existingCollectible = gameState.collectibles.find(c => c.buildingId === building.id && c.type === resourceType);

            if (existingCollectible) {
                // å¦‚æœæœ‰ï¼Œåªå¢åŠ æ•°é‡ï¼ˆæ•°æ®å±‚é¢ç´¯åŠ ï¼‰
                existingCollectible.amount += amount;
                
                // ç»™ä¸€ä¸ªè½»å¾®çš„è§†è§‰åé¦ˆï¼Œä½†ä¸æ”¹å˜å®é™…å¤§å°
                const mesh = existingCollectible.mesh;
                const originalY = mesh.position.y;
                mesh.position.y = originalY + 0.2;
                setTimeout(() => {
                    mesh.position.y = originalY;
                }, 150);
                return; // å®Œæˆæ“ä½œï¼Œä¸å†åˆ›å»ºæ–°æ¨¡å‹
            }

            const collectibleId = crypto.randomUUID();
            
            const resourceConfig = {
                food:  { geometry: new THREE.SphereGeometry(0.3, 8, 8),   color: 0xff4444 }, // è‹¹æœ
                gold:  { geometry: new THREE.CylinderGeometry(0.2, 0.2, 0.1, 12), color: 0xffd700 }, // é‡‘å¸
                wood:  { geometry: new THREE.BoxGeometry(0.2, 0.2, 0.6),  color: 0x8B4513 }, // æœ¨æ
                stone: { geometry: new THREE.DodecahedronGeometry(0.3),   color: 0x808080 }, // çŸ³æ
                gems:  { geometry: new THREE.OctahedronGeometry(0.25),    color: 0xff69b4 }, // å®çŸ³ (ç²‰è‰²)
                expGrass: { geometry: new THREE.ConeGeometry(0.2, 0.4, 6), color: 0x22c55e }, // ç»éªŒè‰ (ç»¿è‰²)
                moonFlower: { geometry: new THREE.TorusGeometry(0.2, 0.08, 8, 6), color: 0xa855f7 }, // æœˆå…‰èŠ± (ç´«è‰²)
                mutationCrystal: { geometry: new THREE.OctahedronGeometry(0.25), color: 0x06b6d4 }, // å˜å¼‚æ™¶ä½“ (é’è‰²)
                voidEssence: { geometry: new THREE.IcosahedronGeometry(0.2), color: 0x4c1d95 }, // è™šç©ºç²¾å (æ·±ç´«)
            };

            const config = resourceConfig[resourceType];
            if (!config) {
                console.warn(`æœªçŸ¥çš„èµ„æºç±»å‹: ${resourceType}`);
                return;
            }

            const material = new THREE.MeshStandardMaterial({ color: config.color, metalness: 0.3, roughness: 0.6 });
            const mesh = new THREE.Mesh(config.geometry, material);

            // è®¡ç®—åŸºç¡€é«˜åº¦
            const buildingHeight = building.mesh.geometry.parameters.height || (building.mesh.geometry.parameters.radius * 2) || 1;
            const baseY = building.mesh.position.y + buildingHeight / 2 + 0.5;

            mesh.position.set(building.mesh.position.x, baseY, building.mesh.position.z);
            mesh.userData.collectibleId = collectibleId;

            const collectible = {
                id: collectibleId,
                type: resourceType,
                amount: amount,
                buildingId: building.id,
                mesh: mesh,
                baseY: baseY,
            };

            gameState.collectibles.push(collectible);
            collectiblesGroup.add(mesh);
        }

        // æ–°å¢ï¼šæ”¶é›†èµ„æº
        function collectResource(collectibleId) {
            const index = gameState.collectibles.findIndex(c => c.id === collectibleId);
            if (index === -1) return;

            const collectible = gameState.collectibles[index];

            // å¢åŠ èµ„æº
            gameState[collectible.type] += collectible.amount;

            // æ˜¾ç¤ºæ”¶é›†åé¦ˆ
            const iconMap = {
                food: 'ğŸ',
                gold: 'ğŸ’°',
                wood: 'ğŸªµ',
                stone: 'ğŸª¨',
                gems: 'ğŸ’',
                expGrass: 'ğŸŒ¿',
                moonFlower: 'ğŸŒ™',
                mutationCrystal: 'ğŸ’ ',
                voidEssence: 'ğŸŒŒ'
            };
            const icon = iconMap[collectible.type] || 'ğŸ“¦';
            showStatus(`${icon} +${collectible.amount}`, 1500);
            updateUI();

            // ä»åœºæ™¯å’Œæ•°æ®ä¸­ç§»é™¤
            collectiblesGroup.remove(collectible.mesh);
            collectible.mesh.geometry.dispose();
            collectible.mesh.material.dispose();
            gameState.collectibles.splice(index, 1);
        }

        // æ–°å¢ï¼šæ¸¸æˆçŠ¶æ€æ›´æ–°å¾ªç¯ (æ¯ç§’)
        function startGameStateUpdateLoop() {
            setInterval(() => {
                const now = Date.now();
                
                // æ£€æŸ¥å»ºç­‘å‡çº§å®Œæˆ
                Object.keys(gameState.upgradingBuildings).forEach(buildingId => {
                    const upgradeInfo = gameState.upgradingBuildings[buildingId];
                    if (now >= upgradeInfo.endTime) {
                        const building = gameState.buildings.find(b => b.id === buildingId);
                        if (building) {
                            completeUpgrade(building, upgradeInfo.nextLevel, upgradeInfo.config);
                            delete gameState.upgradingBuildings[buildingId];
                        }
                    }
                });
                
                // å¦‚æœå»ºç­‘è¯¦æƒ…é¢æ¿å¼€ç€ä¸”è¯¥å»ºç­‘æ­£åœ¨å‡çº§ï¼Œæ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
                if (selectedBuilding && gameState.upgradingBuildings[selectedBuilding.id]) {
                    const upgradeInfo = gameState.upgradingBuildings[selectedBuilding.id];
                    const timeLeft = Math.max(0, upgradeInfo.endTime - now);
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    ui.btnUpgradeBuilding.innerHTML = `â³ å‡çº§ä¸­... (${minutes}:${seconds.toString().padStart(2, '0')})`;
                }
                
                // è®¡ç®—å…¨å±€ä½“åŠ›æ¢å¤åŠ æˆ
                let globalStaminaBonus = 0;
                gameState.buildings.forEach(b => {
                    if (b.type === 'SanctuaryShrine') {
                        globalStaminaBonus += BUILDINGS.SanctuaryShrine.levels[b.level].staminaRegenBonus;
                    }
                });

                const baseStaminaRecoveryRate = 5 / 3600; // æ¯å°æ—¶æ¢å¤5ç‚¹
                const staminaRecoveryRate = baseStaminaRecoveryRate + (globalStaminaBonus / 3600); // åŠ ä¸Šç¥æ®¿åŠ æˆ
                const staminaConsumptionRate = STAMINA_CONSUMPTION_PER_HOUR / 3600; // æ¯å°æ—¶æ¶ˆè€—10ç‚¹

                gameState.animals.forEach(animal => {
                    if (animal.workingBuildingId) {
                        let consumptionMultiplier = 1.0;

                        // æ¶ˆè€—ä½“åŠ›
                        const finalConsumption = Math.max(0, staminaConsumptionRate * consumptionMultiplier);
                        animal.stamina = Math.floor(Math.max(0, (animal.stamina || 0) - finalConsumption));
                        
                        if (animal.stamina <= 0) {
                            const building = gameState.buildings.find(b => b.id === animal.workingBuildingId);
                            if (building) {
                                showStatus(`ğŸ˜´ ${animal.name} å› ä½“åŠ›è€—å°½åœæ­¢äº†å·¥ä½œã€‚`, 3000);
                                removeWorker(building);
                            }
                        }
                    } else if (!animal.isInjured) {
                        // æ¢å¤ä½“åŠ›ï¼ˆåŒ…å«ç¥æ®¿åŠ æˆï¼‰
                        animal.stamina = Math.floor(Math.min(animal.maxStamina || 70, (animal.stamina || 0) + staminaRecoveryRate));
                    }
                });
            }, 1000);
        }

        // æ–°å¢ï¼šæŒ–çŸ¿åå°é€»è¾‘
        setInterval(() => {
            if (gameState.mining && gameState.mining.currentRun.isActive) {
                const run = gameState.mining.currentRun;
                const now = Date.now();
                // æ¯ 3 ç§’æŒ–ä¸€å±‚
                if (now - run.lastTick >= 3000) {
                    run.lastTick = now;
                    
                    // æ¶ˆè€—ä½“åŠ›
                    let staminaDepleted = false;
                    run.team.forEach(id => {
                        const animal = gameState.animals.find(a => a.id === id);
                        if (animal) {
                            animal.stamina -= 1; // æ¯å±‚æ¶ˆè€—1ä½“åŠ›
                            if (animal.stamina <= 0) staminaDepleted = true;
                        }
                    });

                    if (staminaDepleted) {
                        run.isActive = false;
                        // å›é€€åˆ°æœ€è¿‘çš„æ®ç‚¹
                        const checkpoints = [0, 25, 50, 75, 100];
                        const lastCheckpoint = checkpoints.reverse().find(cp => cp <= run.currentDepth) || 0;
                        run.currentDepth = lastCheckpoint;
                        showStatus("âš ï¸ æŒ–çŸ¿é˜Ÿä¼ä½“åŠ›è€—å°½ï¼Œå·²æ’¤å›æ®ç‚¹ã€‚", 4000);
                    } else {
                        run.currentDepth++;
                        // ç®€å•çš„åå°èµ„æºè·å–
                        gameState.stone += 1;
                        if (Math.random() < 0.1) gameState.gold += 1;
                        
                        // åå°æŒ–æ˜æ–‡ç‰©æ¦‚ç‡ (è¾ƒä½)
                        if (Math.random() < 0.02) {
                            const rarityRoll = Math.random();
                            let artifactType = ARTIFACT_TYPES[0];
                            if (rarityRoll < 0.05) artifactType = ARTIFACT_TYPES[5]; // Epic
                            else if (rarityRoll < 0.2) artifactType = ARTIFACT_TYPES[3]; // Rare
                            
                            addArtifact(artifactType);
                        }
                    }
                }
            }
        }, 1000);

        // æ–°å¢ï¼šå°†åæ ‡å¸é™„åˆ°ç½‘æ ¼
        function snapToGrid(point) {
            const cellSize = GRID_SIZE / GRID_DIVISIONS;
            const snappedX = Math.round(point.x / cellSize) * cellSize;
            const snappedZ = Math.round(point.z / cellSize) * cellSize;
            return new THREE.Vector3(snappedX, 0, snappedZ);
        }

        // æ–°å¢ï¼šæ£€æŸ¥æ”¾ç½®ä½ç½®æ˜¯å¦æœ‰æ•ˆ
        function isValidPlacement(point) {
            // æ£€æŸ¥æ˜¯å¦ä¸ç¹æ®–çªé‡å  (ä¸­å¿ƒç‚¹)
            if (point.x === 0 && point.z === 0) return false;

            // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–å·²æ”¾ç½®å»ºç­‘é‡å 
            const isOverlapping = gameState.buildings.some(b => {
                // å…¼å®¹æ™®é€šå¯¹è±¡å’Œ Vector3 å¯¹è±¡
                const bPos = b.position;
                return Math.abs(bPos.x - point.x) < 0.01 &&
                       Math.abs(bPos.z - point.z) < 0.01;
            });
            if (isOverlapping) return false;

            return true;
        }

        // åˆ›å»ºæ–°çš„åŠ¨ç‰©æ¨¡å‹ (æ›´æ–°ä¸ºå­˜å‚¨æ•°æ®å¯¹è±¡)
        function createNewAnimal(color = 0xffffff, type = 'sphere', isWild = false) {
            const animalId = crypto.randomUUID();
            const size = 0.8;
            let geometry;
            
            if (type === 'cube') { 
                 geometry = new THREE.BoxGeometry(size * 1.5, size * 1.5, size * 1.5);
                 showStatus("ğŸ§¬ æ­å–œï¼èåˆäº§ç”Ÿäº†ç‹¬ç‰¹çš„å˜å¼‚åŠ¨ç‰©ï¼", 4000);
            } else if (type === 'torus') { // æ˜ç¡®æŒ‡å®šç¯å½¢
                 geometry = new THREE.TorusGeometry(size * 0.8, size * 0.4, 8, 32); 
                 showStatus("âœ¨ å“‡ï¼ä¸€åªç¨€æœ‰çš„ç¯å½¢åŠ¨ç‰©å‡ºç°äº†ï¼", 4000);
            } else { 
                 geometry = new THREE.SphereGeometry(size, 16, 16);
            }

            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 150
            });
            const mesh = new THREE.Mesh(geometry, material); 

            // åˆå§‹ä½ç½®ï¼ˆç”¨äºå¬å›ï¼‰
            const angle = Math.random() * Math.PI * 2;
            const radius = 5 + Math.random() * 7;
            const initialPosition = new THREE.Vector3(Math.cos(angle) * radius, 1, Math.sin(angle) * radius);
            mesh.position.copy(initialPosition);
            // åˆå§‹æ—¶ï¼Œå®¶å…»åŠ¨ç‰©ä¸å¯è§ï¼Œç­‰å¾…è¢«â€œæ”¾ç½®â€ï¼›é‡ç”ŸåŠ¨ç‰©ç›´æ¥å¯è§
            mesh.visible = isWild;
            
            // ç»‘å®š ID å’Œæ•°æ®åˆ° Mesh
            mesh.userData.animalId = animalId; 

            // åˆ›å»ºåŠ¨ç‰©æ•°æ®å¯¹è±¡
            const nameIndex = Math.floor(Math.random() * ANIMAL_NAMES.length);
            const animalData = {
                id: animalId,
                type: type, // 'sphere', 'cube', 'torus'
                name: `${ANIMAL_NAMES[nameIndex]}${gameState.animals.length + 1}`,
                originalName: `${ANIMAL_NAMES[nameIndex]}${gameState.animals.length + 1}`, // æ–°å¢ï¼šç”¨äºé‡å‘½å
                color: color,
                mesh: mesh,
                isWild: isWild, // æ–°å¢ï¼šæ˜¯å¦ä¸ºé‡ç”Ÿ
                isPlaced: isWild, // é‡ç”ŸåŠ¨ç‰©é»˜è®¤å·²æ”¾ç½®
                initialPosition: initialPosition, // æ–°å¢ï¼šç”¨äºå¬å›çš„åˆå§‹ä½ç½®

                // å±æ€§æ¨¡å—
                level: 1,
                gender: GENDERS[Math.floor(Math.random() * GENDERS.length)],
                experience: 0,
                experienceToNextLevel: LEVEL_CONFIG.baseExperience,
                stamina: 50 + Math.floor(Math.random() * 20),
                maxStamina: 50 + Math.floor(Math.random() * 20), // æ–°å¢ï¼šæœ€å¤§ä½“åŠ›
                potential: isWild ? POTENTIAL_LEVELS[0] : assignPotential(), // é‡ç”ŸåŠ¨ç‰©æ½œåŠ›ä¸ºå¹³åº¸
                favorability: 0,
                element: ANIMAL_ELEMENTS[Math.floor(Math.random() * ANIMAL_ELEMENTS.length)],
                developmentStage: 'å¹¼å¹´æœŸ',

                // èƒ½åŠ›æ¨¡å— (ç§»é™¤ infrastructure å’Œ exploration)
                abilities: {
                    combat: {
                        attack: 10 + Math.floor(Math.random() * 5),
                        defense: 5 + Math.floor(Math.random() * 5),
                        agility: 8 + Math.floor(Math.random() * 5),
                    }
                },
                isInjured: false, // æ–°å¢ï¼šæ˜¯å¦å—ä¼¤
                injuryTimer: 0,   // æ–°å¢ï¼šå—ä¼¤æ¢å¤è®¡æ—¶å™¨
                combatSkills: [null, null, null, null], // æ–°å¢ï¼š4ä¸ªæˆ˜æ–—æŠ€èƒ½æ§½ä½
            };
            animalData.workingBuildingId = null; // æ–°å¢ï¼šå·¥ä½œå»ºç­‘ID

            if (isWild) {
                gameState.wildAnimals.push(animalData);
            } else {
                gameState.animals.push(animalData); // å­˜å‚¨æ•°æ®å¯¹è±¡
                gameState.animalCount = gameState.animals.length;
            }

            animalGroup.add(mesh);
            updateUI();
            
            // åªå¯¹éé‡ç”ŸåŠ¨ç‰©æ£€æŸ¥å›¾é‰´ï¼ˆé‡ç”ŸåŠ¨ç‰©åœ¨æ•è·åæ‰è§£é”ï¼Œä¸”éœ€è¦animalIdï¼‰
            if (!isWild && animalData.animalId) {
                checkEncyclopediaUnlock(animalData);
            }
            
            return animalData;
        }
        
        // æ ¹æ®æ¦‚ç‡åˆ†é…æ½œåŠ›
        function assignPotential() {
            const rand = Math.random();
            if (rand < 0.05) { // 5% ç’€ç’¨
                return POTENTIAL_LEVELS[2];
            } else if (rand < 0.30) { // 25% è¶…å¸¸
                return POTENTIAL_LEVELS[1];
            }
            return POTENTIAL_LEVELS[0]; // 70% å¹³åº¸
        }


        // è¿›å…¥å»ºé€ æ¨¡å¼ (ç•¥)
        function enterBuildMode(buildingType) {
            closeAllDetailPanels();
            if (previewMesh) worldGroup.remove(previewMesh);
            
            gameState.buildingToPlace = buildingType;
            gameState.isBuildingMode = true;
            // ç¡®ä¿æ­£ç¡®çš„å­èœå•æ˜¯å¯è§çš„
            showBuildSubMenu('materials');
            ui.btnOpenBuild.classList.add('build-mode-active');
            
            const config = BUILDINGS[buildingType];
            if (!config) {
                showStatus(`âŒ æœªçŸ¥çš„å»ºç­‘ç±»å‹: ${buildingType}`, 3000);
                exitBuildMode();
                return;
            }
            
            const geometry = config.levels[1].shape;

            const previewMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ff00,
                transparent: true,
                opacity: 0.5,
                wireframe: true
            });
            previewMesh = new THREE.Mesh(geometry, previewMaterial);
            
            // ä¿®å¤ï¼šæ­£ç¡®è®¡ç®—é¢„è§ˆé«˜åº¦
            if (geometry.parameters.height) {
                previewMesh.userData.height = geometry.parameters.height;
            } else if (geometry.parameters.radius) {
                previewMesh.userData.height = geometry.parameters.radius * 2;
            } else if (geometry.parameters.radiusTop) {
                previewMesh.userData.height = geometry.parameters.radiusTop * 2;
            } else {
                previewMesh.userData.height = 1;
            }
            
            worldGroup.add(previewMesh);
            
            showStatus(`ğŸ”¨ å·²é€‰æ‹© ${config.name_cn}ã€‚ç‚¹å‡»æ –æ¯åœ°æ”¾ç½®ï¼`, 3000);
        }

        // é€€å‡ºå»ºé€ æ¨¡å¼ (ç•¥)
        function exitBuildMode() {
            gameState.isBuildingMode = false;
            gameState.buildingToPlace = null;
            gameState.animalToPlace = null; // åŒæ—¶æ¸…é™¤åŠ¨ç‰©æ”¾ç½®çŠ¶æ€
            ui.buildMainMenu.classList.add('hidden');
            ui.buildMaterialMenu.classList.add('hidden');
            ui.btnOpenBuild.classList.remove('build-mode-active');
            if (previewMesh) {
                worldGroup.remove(previewMesh);
                previewMesh = null;
            }
            // showStatus(``); // Avoid clearing status messages too aggressively
        }

        // æ”¾ç½®å»ºç­‘ (ç•¥)
        function placeBuilding(point) {
            const type = gameState.buildingToPlace;
            const config = BUILDINGS[type];

            // æ£€æŸ¥å»ºé€ æˆæœ¬
            if (config.costGold !== undefined) {
                // è¿›é˜¶å»ºç­‘ï¼šéœ€è¦é‡‘å¸+æœ¨æ+çŸ³æ
                if (gameState.gold < config.costGold) {
                    showStatus(`âŒ é‡‘å¸ä¸è¶³! éœ€è¦ ${config.costGold} é‡‘å¸ã€‚`, 3000);
                    return;
                }
                if (gameState.wood < config.costWood) {
                    showStatus(`âŒ æœ¨æä¸è¶³! éœ€è¦ ${config.costWood} æœ¨æã€‚`, 3000);
                    return;
                }
                if (gameState.stone < config.costStone) {
                    showStatus(`âŒ çŸ³æä¸è¶³! éœ€è¦ ${config.costStone} çŸ³æã€‚`, 3000);
                    return;
                }
                
                gameState.gold -= config.costGold;
                gameState.wood -= config.costWood;
                gameState.stone -= config.costStone;
            } else {
                // åŸºç¡€å»ºç­‘ï¼šå•ä¸€èµ„æº
                let costResource = 'food';
                let costAmount = config.cost;

                if (type === 'Museum') costResource = 'stone';
                if (type === 'Exchange') costResource = 'gold';

                const currentRes = gameState[costResource];

                if (currentRes < costAmount) {
                    const resourceName = costResource === 'food' ? 'é£Ÿç‰©' : (costResource === 'stone' ? 'çŸ³æ' : 'é‡‘å¸');
                    showStatus(`âŒ æ”¾ç½®å¤±è´¥: åˆå§‹å»ºé€ éœ€è¦ ${costAmount} ${resourceName}ã€‚`, 3000);
                    return;
                }
                
                gameState[costResource] -= costAmount;
            }
            
            const level1Config = config.levels[1];
            const buildingMaterial = new THREE.MeshPhongMaterial({
                color: config.color,
                shininess: 100
            });
            const mesh = new THREE.Mesh(level1Config.shape, buildingMaterial);
            
            mesh.position.copy(point);
            const initialHeight = level1Config.shape.parameters.height || (level1Config.shape.parameters.radiusTop || level1Config.shape.parameters.radius) * 2;
            mesh.position.y = initialHeight / 2;

            worldGroup.add(mesh);
            const building = {
                type: type,
                mesh: mesh,
                position: point.clone(),
                level: 1, 
                id: crypto.randomUUID(),
                workerId: null, // æ–°å¢ï¼šå·¥ä½œåŠ¨ç‰©çš„ID
                placedArtifacts: [], // æ–°å¢ï¼šæ”¾ç½®çš„æ–‡ç‰©
            };
            mesh.userData.buildingId = building.id; 
            
            gameState.buildings.push(building);

            showStatus(`âœ… æˆåŠŸæ”¾ç½® ${config.name_cn}!`, 3000);
            exitBuildMode();
            updateUI();
        }
        

        // æ˜¾ç¤ºå»ºç­‘è¯¦æƒ…é¢æ¿ (ç•¥)
        function showBuildingDetails(building) {
            closeAllDetailPanels();
            
            selectedBuilding = building;
            const config = BUILDINGS[building.type];
            const currentLevel = building.level;
            const nextLevel = currentLevel + 1;
            
            // å¡«å……å½“å‰ä¿¡æ¯
            ui.detailName.textContent = config.name_cn;
            ui.detailLevel.textContent = `Lv. ${currentLevel}`;
            let currentEffect = '';
            let bonusEffect = ''; // æ–°å¢ï¼šåŠ æˆæ•ˆæœ
            const worker = building.workerId ? gameState.animals.find(a => a.id === building.workerId) : null;

            if (building.type === 'Farm') {
                currentEffect = `+${config.levels[currentLevel].foodPerTick} é£Ÿç‰©/5s`;
                if (worker && worker.abilities && worker.abilities.infrastructure && worker.abilities.infrastructure.specialized === 'è€•ç§ä¸“ç²¾') {
                    bonusEffect = ` (+${Math.round(config.levels[currentLevel].foodPerTick * 0.2)} ä¸“ç²¾)`;
                }
            } else if (building.type === 'Mint') {
                currentEffect = `+${config.levels[currentLevel].goldPerMin} é‡‘å¸/min`;
            } else if (building.type === 'LumberMill') {
                currentEffect = `+${config.levels[currentLevel].woodPerMin} æœ¨æ/min`;
            } else if (building.type === 'Quarry') {
                currentEffect = `+${config.levels[currentLevel].stonePerMin} çŸ³æ/min`;
            } else if (building.type === 'Museum') {
                currentEffect = `å±•ç¤ºå®¹é‡: ${config.levels[currentLevel].slots} ä¸ª`;
            } else if (building.type === 'Exchange') {
                currentEffect = `åŠ¨ç‰©äº¤æ˜“ä¸­å¿ƒ`;
            } else if (building.type === 'GemMine') {
                currentEffect = `+${config.levels[currentLevel].gemsPerMin} å®çŸ³/min`;
                if (!worker) bonusEffect = ' <span class="text-red-400 text-xs">(éœ€è¦å·¥äºº)</span>';
            } else if (building.type === 'HerbGarden') {
                currentEffect = `+${config.levels[currentLevel].expGrassPerMin} ç»éªŒè‰/min`;
            } else if (building.type === 'MoonGarden') {
                currentEffect = `+${config.levels[currentLevel].moonFlowerPerMin} æœˆå…‰èŠ±/min`;
            } else if (building.type === 'PotionWorkshop') {
                const levelConfig = config.levels[currentLevel];
                currentEffect = `åˆæˆ${ITEMS[levelConfig.potionType].name} (${levelConfig.expGrassRequired}ğŸŒ¿ + ${levelConfig.moonFlowerRequired}ğŸŒ™)`;
            } else if (building.type === 'CrystalCave') {
                currentEffect = `+${config.levels[currentLevel].mutationCrystalPerMin} å˜å¼‚æ™¶ä½“/min`;
            } else if (building.type === 'VoidRift') {
                currentEffect = `+${config.levels[currentLevel].voidEssencePerMin} è™šç©ºç²¾å/min`;
            } else if (building.type === 'MutationLab') {
                const levelConfig = config.levels[currentLevel];
                currentEffect = `åˆæˆ${ITEMS[levelConfig.potionType].name} (${levelConfig.mutationCrystalRequired}ğŸ’  + ${levelConfig.voidEssenceRequired}ğŸŒŒ)`;
            }

            const iconMap = {
                'Farm': 'ğŸšœ',
                'Mint': 'ğŸ’°',
                'LumberMill': 'ğŸªµ',
                'Quarry': 'ğŸª¨',
                'Museum': 'ğŸ›ï¸',
                'Exchange': 'ğŸ”„',
                'GemMine': 'ğŸ’',
                'TrainingGround': 'âš”ï¸',
                'SanctuaryShrine': 'ğŸ›ï¸',
                'HerbGarden': 'ğŸŒ¿',
                'MoonGarden': 'ğŸŒ™',
                'PotionWorkshop': 'ğŸ§ª',
                'CrystalCave': 'ğŸ’ ',
                'VoidRift': 'ğŸŒŒ',
                'MutationLab': 'ğŸ§¬'
            };
            ui.detailIcon.textContent = iconMap[building.type] || 'ğŸ—ï¸';

            ui.detailCurrentEffect.innerHTML = `${currentEffect} <span class="text-sm text-yellow-400">${bonusEffect}</span>`;

            // å¡«å……ä¸‹ä¸€çº§ä¿¡æ¯
            if (currentLevel < config.maxLevel) {
                const nextConfig = config.levels[nextLevel];
                ui.nextLevel.textContent = `Lv. ${nextLevel}`;
                ui.detailNextUpgrade.style.visibility = 'visible';
                // document.getElementById('upgrade-arrow').style.visibility = 'visible';
                ui.btnUpgradeBuilding.style.display = 'block';

                let nextEffect = '';
                if (building.type === 'Farm') {
                    nextEffect = `+${nextConfig.foodPerTick} é£Ÿç‰©/5s`;
                } else if (building.type === 'Mint') {
                    nextEffect = `+${nextConfig.goldPerMin} é‡‘å¸/min`;
                } else if (building.type === 'LumberMill') {
                    nextEffect = `+${nextConfig.woodPerMin} æœ¨æ/min`;
                } else if (building.type === 'Quarry') {
                    nextEffect = `+${nextConfig.stonePerMin} çŸ³æ/min`;
                } else if (building.type === 'Museum') {
                    nextEffect = `å±•ç¤ºå®¹é‡: ${nextConfig.slots} ä¸ª`;
                } else if (building.type === 'GemMine') {
                    nextEffect = `+${nextConfig.gemsPerMin} å®çŸ³/min`;
                } else if (building.type === 'HerbGarden') {
                    nextEffect = `+${nextConfig.expGrassPerMin} ç»éªŒè‰/min`;
                } else if (building.type === 'MoonGarden') {
                    nextEffect = `+${nextConfig.moonFlowerPerMin} æœˆå…‰èŠ±/min`;
                } else if (building.type === 'PotionWorkshop') {
                    nextEffect = `åˆæˆ${ITEMS[nextConfig.potionType].name} (${nextConfig.expGrassRequired}ğŸŒ¿ + ${nextConfig.moonFlowerRequired}ğŸŒ™)`;
                } else if (building.type === 'CrystalCave') {
                    nextEffect = `+${nextConfig.mutationCrystalPerMin} å˜å¼‚æ™¶ä½“/min`;
                } else if (building.type === 'VoidRift') {
                    nextEffect = `+${nextConfig.voidEssencePerMin} è™šç©ºç²¾å/min`;
                } else if (building.type === 'MutationLab') {
                    nextEffect = `åˆæˆ${ITEMS[nextConfig.potionType].name} (${nextConfig.mutationCrystalRequired}ğŸ’  + ${nextConfig.voidEssenceRequired}ğŸŒŒ)`;
                } else if (building.type === 'Exchange') {
                    nextEffect = 'æ— å‡çº§';
                }
                ui.detailNextEffect.textContent = nextEffect;
                
                // æ˜¾ç¤ºå‡çº§æˆæœ¬è¯¦æƒ…
                if (nextConfig.costFood !== undefined) {
                    // è¿›é˜¶å»ºç­‘ï¼šå¤šèµ„æºéœ€æ±‚
                    const foodEnough = gameState.food >= nextConfig.costFood;
                    const woodEnough = gameState.wood >= nextConfig.costWood;
                    const stoneEnough = gameState.stone >= nextConfig.costStone;
                    
                    ui.upgradeCostDisplay.innerHTML = `
                        <div class="text-xs text-gray-400 mb-2">å‡çº§éœ€è¦:</div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-gray-900/50 p-2 rounded ${foodEnough ? 'border border-green-500' : 'border border-red-500'}">
                                <div class="text-lg">ğŸ</div>
                                <div class="text-xs ${foodEnough ? 'text-green-400' : 'text-red-400'}">${nextConfig.costFood}</div>
                            </div>
                            <div class="bg-gray-900/50 p-2 rounded ${woodEnough ? 'border border-green-500' : 'border border-red-500'}">
                                <div class="text-lg">ğŸªµ</div>
                                <div class="text-xs ${woodEnough ? 'text-green-400' : 'text-red-400'}">${nextConfig.costWood}</div>
                            </div>
                            <div class="bg-gray-900/50 p-2 rounded ${stoneEnough ? 'border border-green-500' : 'border border-red-500'}">
                                <div class="text-lg">ğŸª¨</div>
                                <div class="text-xs ${stoneEnough ? 'text-green-400' : 'text-red-400'}">${nextConfig.costStone}</div>
                            </div>
                        </div>
                        ${nextConfig.upgradeTime ? `<div class="text-xs text-amber-400 mt-2 text-center">â±ï¸ å‡çº§æ—¶é—´: ${Math.floor(nextConfig.upgradeTime / 60)} åˆ†é’Ÿ</div>` : ''}
                    `;
                } else {
                    // åŸºç¡€å»ºç­‘ï¼šå•èµ„æºéœ€æ±‚
                    const foodEnough = gameState.food >= nextConfig.cost;
                    ui.upgradeCostDisplay.innerHTML = `
                        <div class="text-xs text-gray-400 mb-2">å‡çº§éœ€è¦:</div>
                        <div class="bg-gray-900/50 p-3 rounded ${foodEnough ? 'border border-green-500' : 'border border-red-500'} text-center">
                            <span class="text-2xl">ğŸ</span>
                            <span class="text-lg font-bold ml-2 ${foodEnough ? 'text-green-400' : 'text-red-400'}">${nextConfig.cost}</span>
                        </div>
                    `;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨å‡çº§
                if (gameState.upgradingBuildings[building.id]) {
                    const upgradeInfo = gameState.upgradingBuildings[building.id];
                    const timeLeft = Math.max(0, upgradeInfo.endTime - Date.now());
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    ui.btnUpgradeBuilding.disabled = true;
                    ui.btnUpgradeBuilding.innerHTML = `â³ å‡çº§ä¸­... (${minutes}:${seconds.toString().padStart(2, '0')})`;
                } else {
                    // æ£€æŸ¥èµ„æºéœ€æ±‚
                    let canUpgrade = true;
                    
                    if (nextConfig.costFood !== undefined) {
                        canUpgrade = gameState.food >= nextConfig.costFood &&
                                    gameState.wood >= nextConfig.costWood &&
                                    gameState.stone >= nextConfig.costStone;
                    } else {
                        canUpgrade = gameState.food >= nextConfig.cost;
                    }
                    
                    ui.btnUpgradeBuilding.disabled = !canUpgrade;
                    if (!canUpgrade) {
                        ui.btnUpgradeBuilding.innerHTML = `âŒ èµ„æºä¸è¶³`;
                    } else {
                        ui.btnUpgradeBuilding.innerHTML = `ğŸš€ å¼€å§‹å‡çº§`;
                    }
                }

            } else {
                // è¾¾åˆ°æœ€é«˜ç­‰çº§
                ui.detailNextUpgrade.style.visibility = 'hidden';
                // document.getElementById('upgrade-arrow').style.visibility = 'hidden';
                ui.btnUpgradeBuilding.style.display = 'block';
                ui.btnUpgradeBuilding.disabled = true;
                ui.btnUpgradeBuilding.innerHTML = 'âœ¨ å·²è¾¾åˆ°æœ€é«˜ç­‰çº§';
            }

            // æ˜¾ç¤º/éšè—åˆæˆæŒ‰é’®
            if (building.type === 'PotionWorkshop') {
                ui.btnCraftPotion.classList.remove('hidden');
                const levelConfig = BUILDINGS.PotionWorkshop.levels[building.level];
                const canCraft = gameState.expGrass >= levelConfig.expGrassRequired &&
                                gameState.moonFlower >= levelConfig.moonFlowerRequired;
                ui.btnCraftPotion.disabled = !canCraft;
                if (canCraft) {
                    ui.btnCraftPotion.textContent = `ğŸ§ª åˆæˆ ${ITEMS[levelConfig.potionType].name} (${levelConfig.expGrassRequired}ğŸŒ¿ + ${levelConfig.moonFlowerRequired}ğŸŒ™)`;
                } else {
                    ui.btnCraftPotion.textContent = `âŒ ææ–™ä¸è¶³ (éœ€è¦ ${levelConfig.expGrassRequired}ğŸŒ¿ + ${levelConfig.moonFlowerRequired}ğŸŒ™)`;
                }
            } else if (building.type === 'MutationLab') {
                ui.btnCraftPotion.classList.remove('hidden');
                const levelConfig = BUILDINGS.MutationLab.levels[building.level];
                const canCraft = gameState.mutationCrystal >= levelConfig.mutationCrystalRequired &&
                                gameState.voidEssence >= levelConfig.voidEssenceRequired;
                ui.btnCraftPotion.disabled = !canCraft;
                if (canCraft) {
                    ui.btnCraftPotion.textContent = `ğŸ§¬ åˆæˆ ${ITEMS[levelConfig.potionType].name} (${levelConfig.mutationCrystalRequired}ğŸ’  + ${levelConfig.voidEssenceRequired}ğŸŒŒ)`;
                } else {
                    ui.btnCraftPotion.textContent = `âŒ ææ–™ä¸è¶³ (éœ€è¦ ${levelConfig.mutationCrystalRequired}ğŸ’  + ${levelConfig.voidEssenceRequired}ğŸŒŒ)`;
                }
            } else {
                ui.btnCraftPotion.classList.add('hidden');
            }

            // æ›´æ–°å·¥äººUI
            updateWorkerUI(building);

            ui.modalOverlay.classList.remove('hidden');
            ui.detailPanel.classList.remove('hidden');
        }

        // æ–°å¢ï¼šæ‰“å¼€å·¥äººé€‰æ‹©ç•Œé¢ï¼ˆå¤ç”¨åŠ¨ç‰©åå†Œï¼‰
        function openWorkerSelection() {
            if (!selectedBuilding) return;
            // è®°å½•æˆ‘ä»¬æ­£åœ¨ä¸ºå“ªä¸ªå»ºç­‘åˆ†é…å·¥äºº
            gameState.assigningWorkerForBuilding = selectedBuilding.id;

            // æ¸²æŸ“å¯ç”¨çš„åŠ¨ç‰©åˆ—è¡¨
            const listElement = ui.workerSelectionList;
            listElement.innerHTML = '';
            // å¯ç”¨æ¡ä»¶ï¼šæœªæ”¾ç½®ã€æœªåœ¨å…¶ä»–å»ºç­‘å·¥ä½œã€æœªå—ä¼¤
            const availableAnimals = gameState.animals.filter(a => !a.isPlaced && !a.workingBuildingId && !a.isInjured && !a.exploringMissionId && !gameState.mining.currentRun.team.includes(a.id));

            if (availableAnimals.length === 0) {
                listElement.innerHTML = '<p class="text-sm text-gray-500 p-4 text-center">æ²¡æœ‰å¯ç”¨çš„åŠ¨ç‰©ã€‚<br>è¯·å…ˆä»æ –æ¯åœ°å¬å›æˆ–ç¡®ä¿åŠ¨ç‰©å¥åº·ã€‚</p>';
            } else {
                availableAnimals.forEach(animal => {
                    const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                    const listItem = document.createElement('div');
                    listItem.className = 'roster-item flex items-center justify-between p-2 rounded-md hover:bg-gray-700 cursor-pointer transition-colors duration-150 text-sm';
                    listItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div style="background-color: ${colorHex};" class="w-4 h-4 rounded-full border border-gray-400"></div>
                            <span class="font-medium text-indigo-300">${animal.name}</span>
                        </div>
                        <span class="text-sm text-yellow-400">Lv. ${animal.level}</span>`;
                    listItem.addEventListener('click', () => assignWorker(animal.id));
                    listElement.appendChild(listItem);
                });
            }

            // æ˜¾ç¤ºé€‰æ‹©é¢æ¿
            ui.modalOverlay.classList.remove('hidden');
            ui.workerSelectionPanel.classList.remove('hidden');
        }

        function closeWorkerSelection() {
            gameState.assigningWorkerForBuilding = null;
            ui.workerSelectionPanel.classList.add('hidden');
            // å¦‚æœæ²¡æœ‰å…¶ä»–é¢æ¿æ‰“å¼€ï¼Œéšè—é®ç½©å±‚
            if (ui.detailPanel.classList.contains('hidden') && ui.battleSetupPanel.classList.contains('hidden')) {
                ui.modalOverlay.classList.add('hidden');
            }
        }

        // æ–°å¢ï¼šåˆ†é…å·¥äººé€»è¾‘
        function assignWorker(animalId) {
            const buildingId = gameState.assigningWorkerForBuilding;
            if (!buildingId) return;

            const building = gameState.buildings.find(b => b.id === buildingId);
            const animal = gameState.animals.find(a => a.id === animalId);

            if (!building || !animal) return;

            // åˆ†é…å·¥äºº
            building.workerId = animal.id;
            animal.workingBuildingId = building.id;
            animal.workStartTime = Date.now(); // è®°å½•å¼€å§‹å·¥ä½œæ—¶é—´

            showStatus(`âœ… ${animal.name} å·²å¼€å§‹åœ¨ ${BUILDINGS[building.type].name_cn} å·¥ä½œã€‚`, 3000);

            // å…³é—­é€‰æ‹©é¢æ¿å¹¶åˆ·æ–°å»ºç­‘è¯¦æƒ…
            closeWorkerSelection();
            showBuildingDetails(building);
        }

        // å…³é—­å»ºç­‘è¯¦æƒ…é¢æ¿ (ç•¥)
        function closeBuildingDetails() {
            selectedBuilding = null;
            ui.detailPanel.classList.add('hidden');
            closeWorkerSelection(); // ç¡®ä¿å…³é—­æ—¶æ¸…é™¤åˆ†é…çŠ¶æ€
        }

        // å‡çº§å»ºç­‘é€»è¾‘ (ç•¥)
        function upgradeBuilding(building) {
            if (!building) return;
            const config = BUILDINGS[building.type];
            const nextLevel = building.level + 1;
            const nextConfig = config.levels[nextLevel];

            if (building.level >= config.maxLevel) {
                showStatus(`âŒ ${config.name_cn} å·²è¾¾æœ€é«˜ç­‰çº§ Lv.${config.maxLevel}`, 3000);
                return;
            }

            // æ£€æŸ¥èµ„æºéœ€æ±‚
            if (nextConfig.costFood !== undefined) {
                // è¿›é˜¶å»ºç­‘ï¼šéœ€è¦å¤šç§èµ„æº
                if (gameState.food < nextConfig.costFood) {
                    showStatus(`âŒ é£Ÿç‰©ä¸è¶³! éœ€è¦ ${nextConfig.costFood} é£Ÿç‰©ã€‚`, 3000);
                    return;
                }
                if (gameState.wood < nextConfig.costWood) {
                    showStatus(`âŒ æœ¨æä¸è¶³! éœ€è¦ ${nextConfig.costWood} æœ¨æã€‚`, 3000);
                    return;
                }
                if (gameState.stone < nextConfig.costStone) {
                    showStatus(`âŒ çŸ³æä¸è¶³! éœ€è¦ ${nextConfig.costStone} çŸ³æã€‚`, 3000);
                    return;
                }

                // æ¶ˆè€—èµ„æº
                gameState.food -= nextConfig.costFood;
                gameState.wood -= nextConfig.costWood;
                gameState.stone -= nextConfig.costStone;

                // å¦‚æœæœ‰å‡çº§æ—¶é—´ï¼Œå¯åŠ¨å‡çº§è®¡æ—¶
                if (nextConfig.upgradeTime) {
                    const upgradeEndTime = Date.now() + nextConfig.upgradeTime * 1000;
                    gameState.upgradingBuildings[building.id] = {
                        endTime: upgradeEndTime,
                        nextLevel: nextLevel,
                        config: nextConfig
                    };
                    
                    const minutes = Math.floor(nextConfig.upgradeTime / 60);
                    showStatus(`ğŸ”¨ ${config.name_cn} å¼€å§‹å‡çº§ï¼Œé¢„è®¡ ${minutes} åˆ†é’Ÿåå®Œæˆï¼`, 4000);
                    showBuildingDetails(building); // åˆ·æ–°æ˜¾ç¤ºå‡çº§çŠ¶æ€
                    updateUI();
                    return;
                }
            } else {
                // åŸºç¡€å»ºç­‘ï¼šåªéœ€è¦é£Ÿç‰©
                if (gameState.food < nextConfig.cost) {
                    showStatus(`âŒ é£Ÿç‰©ä¸è¶³! å‡çº§éœ€è¦ ${nextConfig.cost} é£Ÿç‰©ã€‚`, 3000);
                    return;
                }
                gameState.food -= nextConfig.cost;
            }

            // ç«‹å³å‡çº§ï¼ˆåŸºç¡€å»ºç­‘æˆ–æ— å‡çº§æ—¶é—´çš„å»ºç­‘ï¼‰
            completeUpgrade(building, nextLevel, nextConfig);
        }

        // æ–°å¢ï¼šå®Œæˆå»ºç­‘å‡çº§
        function completeUpgrade(building, nextLevel, nextConfig) {
            building.level = nextLevel;

            const mesh = building.mesh;
            
            mesh.geometry.dispose();
            mesh.geometry = nextConfig.shape;
            
            const newHeight = nextConfig.shape.parameters.height || (nextConfig.shape.parameters.radiusTop || nextConfig.shape.parameters.radius) * 2;
            mesh.position.y = newHeight / 2;
            
            mesh.material.emissive.setHex(0x333333);
            setTimeout(() => mesh.material.emissive.setHex(0x000000), 500);

            const config = BUILDINGS[building.type];
            showStatus(`â¬†ï¸ ${config.name_cn} å‡çº§è‡³ Lv.${nextLevel}! æ•ˆæœæå‡!`, 4000);
            
            // å¦‚æœè¯¦æƒ…é¢æ¿å¼€ç€ï¼Œåˆ·æ–°å®ƒ
            if (selectedBuilding && selectedBuilding.id === building.id) {
                showBuildingDetails(building);
            }
            updateUI();
        }

        // æ–°å¢ï¼šåˆæˆè¯æ°´
        function craftPotion(building) {
            if (!building) return;
            
            const levelConfig = BUILDINGS[building.type].levels[building.level];
            const potionType = levelConfig.potionType;
            
            if (building.type === 'PotionWorkshop') {
                const expGrassRequired = levelConfig.expGrassRequired;
                const moonFlowerRequired = levelConfig.moonFlowerRequired;
                
                if (gameState.expGrass < expGrassRequired || gameState.moonFlower < moonFlowerRequired) {
                    showStatus(`âŒ ææ–™ä¸è¶³ï¼éœ€è¦ ${expGrassRequired}ğŸŒ¿ ç»éªŒè‰ å’Œ ${moonFlowerRequired}ğŸŒ™ æœˆå…‰èŠ±`, 3000);
                    return;
                }
                
                // æ¶ˆè€—ææ–™
                gameState.expGrass -= expGrassRequired;
                gameState.moonFlower -= moonFlowerRequired;
                
            } else if (building.type === 'MutationLab') {
                const mutationCrystalRequired = levelConfig.mutationCrystalRequired;
                const voidEssenceRequired = levelConfig.voidEssenceRequired;
                
                if (gameState.mutationCrystal < mutationCrystalRequired || gameState.voidEssence < voidEssenceRequired) {
                    showStatus(`âŒ ææ–™ä¸è¶³ï¼éœ€è¦ ${mutationCrystalRequired}ğŸ’  å˜å¼‚æ™¶ä½“ å’Œ ${voidEssenceRequired}ğŸŒŒ è™šç©ºç²¾å`, 3000);
                    return;
                }
                
                // æ¶ˆè€—ææ–™
                gameState.mutationCrystal -= mutationCrystalRequired;
                gameState.voidEssence -= voidEssenceRequired;
            } else {
                return;
            }
            
            // æ·»åŠ åˆ°èƒŒåŒ…
            if (!gameState.inventory) gameState.inventory = {};
            gameState.inventory[potionType] = (gameState.inventory[potionType] || 0) + 1;
            
            showStatus(`âœ… æˆåŠŸåˆæˆ ${ITEMS[potionType].name}ï¼å·²æ”¾å…¥èƒŒåŒ…ã€‚`, 3000);
            updateUI();
            showBuildingDetails(building); // åˆ·æ–°é¢æ¿
        }

        // æ–°å¢ï¼šæ›´æ–°å»ºç­‘è¯¦æƒ…ä¸­çš„å·¥äººUI
        function updateWorkerUI(building) {
            const worker = building.workerId ? gameState.animals.find(a => a.id === building.workerId) : null;
            if (worker) {
                ui.workerInfo.innerHTML = `
                    <div class="w-full">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-cyan-300">${worker.name} (Lv.${worker.level})</span>
                            <button id="btn-remove-worker" class="text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">å¸ä»»</button>
                        </div>
                    </div>
                `;
                ui.workerInfo.classList.remove('hidden');
                ui.assignWorkerSection.classList.add('hidden');

                document.getElementById('btn-remove-worker').onclick = () => removeWorker(building);
            } else {
                ui.workerInfo.classList.add('hidden');
                ui.assignWorkerSection.classList.remove('hidden');
            }
        }

        // æ–°å¢ï¼šä»å»ºç­‘ä¸­ç§»é™¤å·¥äºº
        function removeWorker(building) {
            if (!building || !building.workerId) return;
            const worker = gameState.animals.find(a => a.id === building.workerId);
            if (worker) {
                worker.workingBuildingId = null;
                worker.workStartTime = null;
            }
            building.workerId = null;
            showStatus(`åŠ¨ç‰©å·²åœæ­¢å·¥ä½œã€‚`, 2000);
            
            // åˆ·æ–°UI
            showBuildingDetails(building);
            // å¦‚æœåŠ¨ç‰©è¯¦æƒ…é¡µå¼€ç€ï¼Œä¹Ÿåˆ·æ–°å®ƒ
            if (!ui.standaloneDetailPanel.classList.contains('hidden') && worker) {
                openStandaloneAnimalDetails(worker.id);
            }
        }
        // --- æ–°å¢ï¼šç‹¬ç«‹åŠ¨ç‰©è¯¦æƒ…é¢æ¿é€»è¾‘ ---

        // æ‰“å¼€ç‹¬ç«‹åŠ¨ç‰©è¯¦æƒ…é¢æ¿
        function openStandaloneAnimalDetails(animalId) {
            closeAllDetailPanels();
            exitBuildMode();

            const animal = gameState.animals.find(a => a.id === animalId) || 
                         gameState.wildAnimals.find(a => a.id === animalId);
            if (!animal) return;

            // æ£€æŸ¥å·¥ä½œçŠ¶æ€
            let workingInfo = '';
            if (animal.workingBuildingId) {
                const building = gameState.buildings.find(b => b.id === animal.workingBuildingId);
                workingInfo = ` (åœ¨ ${BUILDINGS[building.type].name_cn} å·¥ä½œ)`;
            } else if (animal.exploringMissionId) {
                workingInfo = ` (æ­£åœ¨æ¢ç´¢)`;
            } else if (gameState.mining.currentRun.team.includes(animal.id)) {
                workingInfo = ` (æ­£åœ¨æŒ–çŸ¿)`;
            }

            // å¡«å……æ•°æ®
            ui.standaloneDetailName.textContent = animal.name;
            ui.standaloneDetailLevel.textContent = `Lv. ${animal.level}`;
            ui.standaloneDetailGender.textContent = animal.gender;
            if (animal.gender === 'é›„') {
                ui.standaloneDetailGender.className = 'text-sm font-normal px-2 py-1 rounded bg-blue-500';
            } else {
                ui.standaloneDetailGender.className = 'text-sm font-normal px-2 py-1 rounded bg-pink-500';
            }

            const expPercent = (animal.experience / animal.experienceToNextLevel) * 100;
            ui.standaloneDetailExpText.textContent = `${Math.floor(animal.experience)} / ${animal.experienceToNextLevel}`;
            ui.standaloneDetailExpBar.style.width = `${expPercent}%`;

            ui.standaloneDetailStamina.textContent = `${Math.floor(animal.stamina)} / ${animal.maxStamina}`;
            ui.standaloneDetailPotential.textContent = animal.potential;
            ui.standaloneDetailElement.textContent = animal.element;

            ui.standaloneAbilityCombatAtk.textContent = animal.abilities.combat.attack;
            ui.standaloneAbilityCombatDef.textContent = animal.abilities.combat.defense;
            ui.standaloneAbilityCombatAgi.textContent = animal.abilities.combat.agility;

            // æŒ‰é’®çŠ¶æ€
            const isWild = animal.isWild;
            const isMining = gameState.mining.currentRun.team.includes(animal.id);
            ui.standaloneBtnFeed.style.display = (isWild || animal.workingBuildingId || animal.exploringMissionId || isMining) ? 'none' : 'block';
            ui.standaloneBtnPlace.style.display = (isWild || animal.isPlaced || animal.workingBuildingId || animal.exploringMissionId || isMining) ? 'none' : 'block';
            ui.standaloneBtnRecall.style.display = (isWild || !animal.isPlaced || animal.workingBuildingId || animal.exploringMissionId || isMining) ? 'none' : 'block';
            ui.standaloneBtnChallenge.style.display = isWild ? 'block' : 'none';

            if (!isWild) {
                const feedCost = animal.level * 10;
                const canFeed = gameState.food >= feedCost;
                ui.standaloneBtnFeed.disabled = !canFeed;
                ui.standaloneBtnFeed.textContent = canFeed ? `å–‚å…» (${feedCost} é£Ÿç‰©)` : `é£Ÿç‰©ä¸è¶³ (${feedCost})`;
            }

            // æ¸²æŸ“æˆ˜æ–—æŠ€èƒ½æ§½ä½
            ui.standaloneCombatSkills.innerHTML = '';
            const skills = animal.combatSkills || [null, null, null, null];
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            
            skills.forEach(skillId => {
                const slot = document.createElement('div');
                slot.className = 'h-12 w-12 bg-gray-800 border border-gray-600 rounded flex flex-col items-center justify-center text-xs cursor-pointer hover:bg-gray-700 transition-colors relative group';
                
                const skill = skillId ? skillPool.find(s => s.key === skillId) : null;
                
                if (skill) {
                    slot.innerHTML = `
                        <div class="text-lg">${skill.icon}</div>
                        <div class="absolute bottom-full mb-2 hidden group-hover:block w-32 bg-black text-white text-xs rounded p-2 z-10 text-center shadow-lg">
                            <div class="font-bold">${skill.name}</div>
                            <div class="text-gray-300 mt-1">${skill.description || skill.desc || ''}</div>
                        </div>
                    `;
                } else {
                    slot.textContent = '+';
                    slot.title = 'ç©ºæŠ€èƒ½æ§½';
                }
                ui.standaloneCombatSkills.appendChild(slot);
            });

            // ç»‘å®šäº‹ä»¶
            ui.standaloneBtnFeed.onclick = () => { /* å–‚å…»é€»è¾‘å·²ç§»å‡º */ };
            ui.standaloneBtnPlace.onclick = () => enterAnimalPlacementMode(animal.id);
            ui.standaloneBtnRecall.onclick = () => { recallAnimal(animal.id); openStandaloneAnimalDetails(animal.id); };
            ui.standaloneBtnChallenge.onclick = () => openBattleSetupPanel(animal.id);

            // æ˜¾ç¤ºé¢æ¿
            ui.standaloneDetailPanel.classList.remove('hidden');
        }
        
        // æ–°å¢ï¼šå°†è¯¦æƒ…é¢æ¿å®šä½åˆ°åŠ¨ç‰©æ—è¾¹
        function positionDetailPanelNearAnimal(animal) {
            if (!animal || !animal.mesh) return;
            
            const panel = ui.standaloneDetailPanel;
            const mesh = animal.mesh;
            
            // è·å–åŠ¨ç‰©åœ¨å±å¹•ä¸Šçš„2Dä½ç½®
            const vector = new THREE.Vector3();
            mesh.getWorldPosition(vector);
            vector.project(camera);
            
            // è½¬æ¢ä¸ºå±å¹•åæ ‡
            const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
            const y = (vector.y * -0.5 + 0.5) * window.innerHeight;
            
            // é¢æ¿å°ºå¯¸ï¼ˆä¼°ç®—ï¼‰
            const panelWidth = 384; // w-96 = 24rem = 384px
            const panelHeight = 500; // ä¼°ç®—é«˜åº¦
            
            // è®¡ç®—æœ€ä½³ä½ç½®ï¼ˆä¼˜å…ˆæ˜¾ç¤ºåœ¨å³ä¾§ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿåˆ™æ˜¾ç¤ºåœ¨å·¦ä¾§ï¼‰
            let left = x + 50; // é»˜è®¤åœ¨åŠ¨ç‰©å³ä¾§50px
            let top = y - panelHeight / 2; // å‚ç›´å±…ä¸­å¯¹é½
            
            // è¾¹ç•Œæ£€æŸ¥ - å³ä¾§
            if (left + panelWidth > window.innerWidth - 20) {
                left = x - panelWidth - 50; // æ˜¾ç¤ºåœ¨å·¦ä¾§
            }
            
            // è¾¹ç•Œæ£€æŸ¥ - å·¦ä¾§
            if (left < 20) {
                left = 20;
            }
            
            // è¾¹ç•Œæ£€æŸ¥ - é¡¶éƒ¨
            if (top < 20) {
                top = 20;
            }
            
            // è¾¹ç•Œæ£€æŸ¥ - åº•éƒ¨
            if (top + panelHeight > window.innerHeight - 20) {
                top = window.innerHeight - panelHeight - 20;
            }
            
            // åº”ç”¨ä½ç½®
            panel.style.left = `${left}px`;
            panel.style.top = `${top}px`;
            panel.style.transform = 'none'; // ç§»é™¤å±…ä¸­å˜æ¢
        }

        // å…³é—­ç‹¬ç«‹åŠ¨ç‰©è¯¦æƒ…é¢æ¿
        function closeStandaloneAnimalDetails() {
            ui.standaloneDetailPanel.classList.add('hidden');
        }

        // --- æ–°å¢ï¼šæˆ˜æ–—ç³»ç»Ÿé€»è¾‘ ---

        function openBattleSetupPanel(wildAnimalId) {
            closeAllDetailPanels();
            const opponent = gameState.wildAnimals.find(a => a.id === wildAnimalId);
            if (!opponent) return;

            // æ£€æŸ¥æ˜¯å¦æœ‰é¦–å‘åŠ¨ç‰©
            if (gameState.firstTeamMember) {
                const firstAnimal = gameState.animals.find(a => a.id === gameState.firstTeamMember);
                // éªŒè¯é¦–å‘åŠ¨ç‰©å¯ç”¨ï¼ˆæœªæ”¾ç½®ã€æœªå—ä¼¤ã€åœ¨å‡ºæˆ˜é˜Ÿä¼ä¸­ï¼‰
                if (firstAnimal && !firstAnimal.isPlaced && !firstAnimal.isInjured && gameState.battleTeam.includes(firstAnimal.id)) {
                    // ç›´æ¥ä½¿ç”¨é¦–å‘åŠ¨ç‰©è¿›å…¥æˆ˜æ–—
                    gameState.battle = {
                        opponent: opponent,
                        playerAnimal: firstAnimal,
                    };
                    startCombat();
                    return;
                }
            }

            // æ²¡æœ‰é¦–å‘æˆ–é¦–å‘ä¸å¯ç”¨ï¼Œæ˜¾ç¤ºé€‰æ‹©é¢æ¿
            gameState.battle = {
                opponent: opponent,
                playerAnimal: null,
            };

            // æ¸²æŸ“å¯¹æ‰‹ä¿¡æ¯
            const colorHex = '#' + opponent.color.toString(16).padStart(6, '0');
            ui.battleOpponentInfo.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div style="background-color: ${colorHex};" class="w-5 h-5 rounded-full border-2 border-red-400"></div>
                    <span class="font-bold text-red-400">${opponent.name}</span>
                </div>
                <span class="text-sm font-mono text-yellow-400">Lv. ${opponent.level}</span>
            `;

            // æ¸²æŸ“ç©å®¶å¯é€‰æ‹©çš„åŠ¨ç‰©åˆ—è¡¨
            renderBattleSelectionList();

            ui.btnExecuteBattle.disabled = true;

            ui.modalOverlay.classList.remove('hidden'); // æ˜¾ç¤ºé®ç½©å±‚
            ui.battleSetupPanel.classList.remove('hidden');
        }

        function closeBattleSetupPanel() {
            ui.battleSetupPanel.classList.add('hidden');
            ui.modalOverlay.classList.add('hidden'); // éšè—é®ç½©å±‚
            gameState.battle = null;
        }

        function renderBattleSelectionList() {
            const listElement = ui.battleTeamSelectionList;
            listElement.innerHTML = '';
            const availableAnimals = gameState.animals.filter(a => !a.isPlaced && !a.isInjured);

            if (availableAnimals.length === 0) {
                listElement.innerHTML = '<p class="text-sm text-gray-500 p-2">æ²¡æœ‰æœªæ”¾ç½®ä¸”å¥åº·çš„åŠ¨ç‰©å¯å‡ºæˆ˜ã€‚</p>';
                return;
            }

            availableAnimals.forEach(animal => {
                const isSelected = gameState.battle && gameState.battle.playerAnimal && gameState.battle.playerAnimal.id === animal.id;
                let listItemClass = 'roster-item flex items-center justify-between p-2 rounded-md hover:bg-gray-700 cursor-pointer transition-colors duration-150 text-sm';
                if (isSelected) {
                    listItemClass += ' selected-for-breeding';
                }
                const listItem = document.createElement('div');
                listItem.className = listItemClass;
                listItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div style="background-color: #${animal.color.toString(16).padStart(6, '0')};" class="w-4 h-4 rounded-full border border-gray-400"></div>
                        <span class="font-medium text-indigo-300">${animal.name}</span>
                    </div>
                    <span class="text-sm text-yellow-400">Lv. ${animal.level}</span>`;
                listItem.addEventListener('click', () => selectAnimalForCombat(animal.id));
                listElement.appendChild(listItem);
            });
        }

        function selectAnimalForCombat(animalId) {
            if (!gameState.battle) return;
            const animal = gameState.animals.find(a => a.id === animalId);
            gameState.battle.playerAnimal = animal;
            ui.btnExecuteBattle.disabled = false;
            renderBattleSelectionList(); // é‡æ–°æ¸²æŸ“ä»¥é«˜äº®æ˜¾ç¤º
        }

        function startCombat() {
            if (!gameState.battle) return;
            const { opponent, playerAnimal } = gameState.battle;
            if (!opponent || !playerAnimal) return;
    
            // åˆ›å»ºå¯åºåˆ—åŒ–çš„åŠ¨ç‰©å¯¹è±¡å‰¯æœ¬ï¼Œç§»é™¤æ— æ³•JSONåŒ–çš„ 'mesh' å±æ€§
            const getSerializableAnimal = (animal) => {
                const serializableAnimal = { ...animal };
                delete serializableAnimal.mesh;
                // å¦‚æœ initialPosition æ˜¯ THREE.Vector3 å¯¹è±¡ï¼Œä¹Ÿéœ€è¦è½¬æ¢
                if (serializableAnimal.initialPosition && typeof serializableAnimal.initialPosition.toArray === 'function') {
                    serializableAnimal.initialPosition = serializableAnimal.initialPosition.toArray();
                }
                return serializableAnimal;
            };
    
            // å°†æˆ˜æ–—ä¿¡æ¯å­˜å‚¨åˆ° localStorage
            localStorage.setItem('battleOpponent', JSON.stringify(getSerializableAnimal(opponent)));
            localStorage.setItem('battlePlayerAnimal', JSON.stringify(getSerializableAnimal(playerAnimal)));
    
            // è·³è½¬åˆ°æˆ˜æ–—åœºæ™¯
            window.location.href = 'battle.html';
        }

        // --- æ–°å¢ï¼šå•†åº—ç³»ç»Ÿé€»è¾‘ ---

        function openShopPanel() {
            closeAllDetailPanels();
            ui.shopGoldDisplay.textContent = gameState.gold;
            ui.shopItemsContainer.innerHTML = '';

            for (const [key, item] of Object.entries(SHOP_ITEMS)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-gray-800 p-4 rounded-lg flex flex-col items-center text-center border border-gray-700 hover:border-pink-500 transition-colors';
                
                // æ£€æŸ¥èƒŒåŒ…æ•°é‡
                const count = (gameState.inventory && gameState.inventory[key]) || 0;

                itemDiv.innerHTML = `
                    <div class="text-4xl mb-2">${item.icon}</div>
                    <h4 class="font-bold text-lg text-white">${item.name}</h4>
                    <p class="text-xs text-gray-400 mb-2 h-8">${item.desc}</p>
                    <div class="text-sm text-gray-300 mb-3">æ‹¥æœ‰: <span class="text-green-400 font-mono">${count}</span></div>
                    <button class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded flex justify-center items-center gap-2" onclick="buyItem('${key}')">
                        <span>ğŸ’° ${item.price}</span>
                        <span>è´­ä¹°</span>
                    </button>
                `;
                ui.shopItemsContainer.appendChild(itemDiv);
            }

            ui.modalOverlay.classList.remove('hidden');
            ui.shopPanel.classList.remove('hidden');
        }

        function closeShopPanel() {
            ui.shopPanel.classList.add('hidden');
            ui.modalOverlay.classList.add('hidden');
        }

        window.buyItem = function(itemKey) {
            const item = SHOP_ITEMS[itemKey];
            if (!item) return;

            if (gameState.gold < item.price) {
                showStatus('âŒ é‡‘å¸ä¸è¶³ï¼', 2000);
                return;
            }

            gameState.gold -= item.price;
            if (!gameState.inventory) gameState.inventory = {};
            gameState.inventory[itemKey] = (gameState.inventory[itemKey] || 0) + 1;

            showStatus(`âœ… è´­ä¹°æˆåŠŸ: ${item.name}`, 2000);
            updateUI();
            openShopPanel(); // åˆ·æ–°ç•Œé¢æ˜¾ç¤ºä½™é¢å’Œæ•°é‡
        };

        // --- èƒŒåŒ…ç³»ç»Ÿé€»è¾‘å·²ç§»è‡³ inventory_system.js ---

        // èƒŒåŒ…ç³»ç»Ÿæ‰€æœ‰å‡½æ•°å·²ç§»è‡³ inventory_system.js

        // å·²ç§»é™¤ renderInventoryItems() å‡½æ•°ï¼Œå› ä¸ºé“å…·ä»“åº“å·²ä»èƒŒåŒ…é¢æ¿ä¸­ç§»é™¤
        // é“å…·å¯ä»¥é€šè¿‡å•†åº—é¢æ¿è´­ä¹°å’Œä½¿ç”¨

        let currentItemToUse = null;

        function initiateUseItem(itemId) {
            currentItemToUse = itemId;
            // æ‰“å¼€åŠ¨ç‰©é€‰æ‹©å™¨
            ui.targetAnimalList.innerHTML = '';
            
            // åˆ—å‡ºæ‰€æœ‰åŠ¨ç‰©
            const allAnimals = [...gameState.animals]; // ä»…é™å®¶å…»åŠ¨ç‰©ï¼Œé‡ç”ŸåŠ¨ç‰©é€šå¸¸ä¸èƒ½å–‚è¯
            
            if (allAnimals.length === 0) {
                showStatus('âŒ æ²¡æœ‰å¯ä½¿ç”¨çš„åŠ¨ç‰©å¯¹è±¡ã€‚', 2000);
                return;
            }

            allAnimals.forEach(animal => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-700 rounded cursor-pointer hover:bg-gray-600';
                const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div style="background-color: ${colorHex};" class="w-6 h-6 rounded-full border border-gray-400"></div>
                        <div>
                            <div class="font-bold text-sm">${animal.name}</div>
                            <div class="text-xs text-gray-400">Lv.${animal.level} | âš¡${Math.floor(animal.stamina)}/${animal.maxStamina}</div>
                        </div>
                    </div>
                    <button class="text-xs bg-blue-600 px-2 py-1 rounded text-white">ä½¿ç”¨</button>
                `;
                div.onclick = () => confirmUseItem(animal.id);
                ui.targetAnimalList.appendChild(div);
            });

            ui.itemTargetSelector.classList.remove('hidden');
        }

        function closeTargetSelector() {
            ui.itemTargetSelector.classList.add('hidden');
            currentItemToUse = null;
        }

        function confirmUseItem(animalId) {
            const animal = gameState.animals.find(a => a.id === animalId);
            const item = ITEMS[currentItemToUse];
            
            if (animal && item && gameState.inventory[currentItemToUse] > 0) {
                if (item.type === 'exp') {
                    animal.experience += item.value;
                    showStatus(`ğŸ§ª ${animal.name} è·å¾—äº† ${item.value} ç»éªŒ!`, 2000);
                } else if (item.type === 'stamina') {
                    animal.stamina = Math.floor(Math.min(animal.maxStamina, animal.stamina + item.value));
                    showStatus(`âš¡ ${animal.name} æ¢å¤äº† ${item.value} ä½“åŠ›!`, 2000);
                }
                gameState.inventory[currentItemToUse]--;
                closeTargetSelector();
                renderInventoryItems(); // åˆ·æ–°èƒŒåŒ…
            }
        }

        // --- æ–°å¢ï¼šæ–‡ç‰©ç³»ç»Ÿé€»è¾‘ ---

        function addArtifact(type) {
            const artifact = {
                id: crypto.randomUUID(),
                name: type.name,
                rarity: type.rarity,
                icon: type.icon,
                foundDate: Date.now()
            };
            gameState.artifacts.push(artifact);
            showStatus(`ğŸº å‘ç°äº†æ–‡ç‰©: ${artifact.name} (${artifact.rarity})!`, 4000);
        }

        function openMuseumPanel(building) {
            closeAllDetailPanels();
            selectedBuilding = building;
            
            const config = BUILDINGS['Museum'].levels[building.level];
            const capacity = config.slots;
            building.placedArtifacts = building.placedArtifacts || [];

            ui.museumCapacity.textContent = `${building.placedArtifacts.length}/${capacity}`;
            
            // æ¸²æŸ“å±•ä½
            ui.museumSlots.innerHTML = '';
            for (let i = 0; i < capacity; i++) {
                const artifactId = building.placedArtifacts[i];
                const artifact = artifactId ? gameState.artifacts.find(a => a.id === artifactId) : null;
                
                const slot = document.createElement('div');
                slot.className = `h-24 border-2 border-dashed rounded-lg flex flex-col items-center justify-center ${artifact ? 'border-amber-500 bg-amber-900/30' : 'border-gray-600 bg-gray-800/50'}`;
                
                if (artifact) {
                    slot.innerHTML = `
                        <span class="text-3xl mb-1">${artifact.icon}</span>
                        <span class="text-xs font-bold text-amber-200">${artifact.name}</span>
                        <button class="mt-1 text-xs text-red-400 hover:text-red-300" onclick="removeArtifactFromMuseum('${artifact.id}')">å–å›</button>
                    `;
                } else {
                    slot.innerHTML = `<span class="text-gray-500 text-xs">ç©ºå±•ä½</span>`;
                }
                ui.museumSlots.appendChild(slot);
            }

            // æ¸²æŸ“ä»“åº“
            ui.museumInventory.innerHTML = '';
            // ç­›é€‰å‡ºæœªæ”¾ç½®çš„æ–‡ç‰©
            const placedIds = gameState.buildings.flatMap(b => b.placedArtifacts || []);
            const availableArtifacts = gameState.artifacts.filter(a => !placedIds.includes(a.id));

            if (availableArtifacts.length === 0) {
                ui.museumInventory.innerHTML = '<p class="text-gray-500 text-sm text-center">æ²¡æœ‰å¯å±•ç¤ºçš„æ–‡ç‰©</p>';
            } else {
                availableArtifacts.forEach(a => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-2 bg-gray-700 rounded hover:bg-gray-600 cursor-pointer';
                    item.innerHTML = `<span>${a.icon} ${a.name}</span> <span class="text-xs text-gray-400">${a.rarity}</span>`;
                    item.onclick = () => placeArtifactInMuseum(a.id);
                    ui.museumInventory.appendChild(item);
                });
            }

            ui.modalOverlay.classList.remove('hidden');
            ui.museumPanel.classList.remove('hidden');
        }

        window.placeArtifactInMuseum = function(artifactId) {
            if (!selectedBuilding || selectedBuilding.type !== 'Museum') return;
            const config = BUILDINGS['Museum'].levels[selectedBuilding.level];
            if (selectedBuilding.placedArtifacts.length >= config.slots) return showStatus('âŒ å±•å…å·²æ»¡ï¼Œè¯·å‡çº§æ–‡ç‰©é¦†', 2000);
            selectedBuilding.placedArtifacts.push(artifactId);
            openMuseumPanel(selectedBuilding); // åˆ·æ–°
        };

        window.removeArtifactFromMuseum = function(artifactId) {
            if (!selectedBuilding) return;
            selectedBuilding.placedArtifacts = selectedBuilding.placedArtifacts.filter(id => id !== artifactId);
            openMuseumPanel(selectedBuilding); // åˆ·æ–°
        };

        function closeMuseumPanel() {
            ui.museumPanel.classList.add('hidden');
            ui.modalOverlay.classList.add('hidden');
            selectedBuilding = null;
        }

        // --- æ–°å¢ï¼šäº¤æ˜“æ‰€ç³»ç»Ÿé€»è¾‘ ---

        function openExchangePanel() {
            closeAllDetailPanels();
            ui.exchangeGoldDisplay.textContent = gameState.gold;
            
            // æ–°å¢ï¼šå¦‚æœæ‹å–è¡Œæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç”Ÿæˆ
            if (!gameState.auctions || !gameState.auctions.items || gameState.auctions.items.length === 0) {
                generateAuctionItems();
            }
            
            // é»˜è®¤æ‰“å¼€å‡ºå”®æ ‡ç­¾
            renderExchangeTab('sell');

            // ç»‘å®šæ ‡ç­¾é¡µç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.exchange-tab-button').forEach(btn => {
                btn.onclick = () => renderExchangeTab(btn.dataset.tab);
            });

            ui.modalOverlay.classList.remove('hidden');
            ui.exchangePanel.classList.remove('hidden');
        }

        function closeExchangePanel() {
            ui.exchangePanel.classList.add('hidden');
            ui.modalOverlay.classList.add('hidden');
        }

        function renderExchangeTab(tabName) {
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.exchange-tab-button').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('text-white', 'border-green-500');
                    btn.classList.remove('text-gray-400', 'border-transparent');
                } else {
                    btn.classList.remove('text-white', 'border-green-500');
                    btn.classList.add('text-gray-400', 'border-transparent');
                }
            });

            const content = ui.exchangeContent;
            content.innerHTML = '';

            if (tabName === 'sell') {
                const sellableAnimals = gameState.animals.filter(a => !a.isPlaced && !a.workingBuildingId && !a.exploringMissionId && !gameState.mining.currentRun.team.includes(a.id));
                if (sellableAnimals.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-500 py-8">æ²¡æœ‰å¯å‡ºå”®çš„åŠ¨ç‰© (å¿…é¡»æ˜¯ç©ºé—²çŠ¶æ€)ã€‚</p>';
                    return;
                }
                sellableAnimals.forEach(animal => {
                    const value = calculateAnimalValue(animal);
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 p-3 rounded-lg flex items-center justify-between';
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div style="background-color: #${animal.color.toString(16).padStart(6, '0')};" class="w-8 h-8 rounded-full border border-gray-400"></div>
                            <div>
                                <div class="font-bold text-indigo-300">${animal.name} <span class="text-xs text-yellow-400">Lv.${animal.level}</span></div>
                                <div class="text-xs text-gray-400">${animal.potential} | ${animal.element}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-400">ğŸ’° ${value}</div>
                            <button class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded mt-1" onclick="sellAnimal('${animal.id}')">å‡ºå”®</button>
                        </div>
                    `;
                    content.appendChild(div);
                });
            } else if (tabName === 'buy') {
                const today = new Date().toDateString();
                if (gameState.lastStockRefreshDate !== today || !gameState.exchangeStock) {
                    generateExchangeStock();
                }

                // æ–°å¢ï¼šåˆ·æ–°æŒ‰é’®åŒºåŸŸ
                const refreshDiv = document.createElement('div');
                refreshDiv.className = 'flex justify-between items-center mb-4 pb-2 border-b border-gray-700';
                refreshDiv.innerHTML = `
                    <span class="text-sm text-gray-400">æ¯æ—¥éšæœºåˆ·æ–°</span>
                    <button onclick="refreshExchangeStock()" class="text-xs bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded flex items-center gap-2 transition-colors">
                        <span>ğŸ”„ ç«‹å³åˆ·æ–°</span>
                        <span class="font-mono text-pink-200 bg-black/20 px-1 rounded">ğŸ’ 5</span>
                    </button>
                `;
                content.appendChild(refreshDiv);

                if (!gameState.exchangeStock || gameState.exchangeStock.length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.className = 'text-center text-gray-500 py-8';
                    emptyMsg.textContent = 'ä»Šæ—¥å•†åº—å·²å”®ç½„ï¼Œæ˜æ—¥å†æ¥ï¼';
                    content.appendChild(emptyMsg);
                    return;
                }

                gameState.exchangeStock.forEach(animal => {
                    const value = calculateAnimalValue(animal);
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 p-3 rounded-lg flex items-center justify-between';
                    const canAfford = gameState.gold >= value;
                    const hasCapacity = gameState.animalCount < gameState.maxAnimals;
                    const canBuy = canAfford && hasCapacity;

                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div style="background-color: #${animal.color.toString(16).padStart(6, '0')};" class="w-8 h-8 rounded-full border border-gray-400"></div>
                            <div>
                                <div class="font-bold text-indigo-300">${animal.name} <span class="text-xs text-yellow-400">Lv.${animal.level}</span></div>
                                <div class="text-xs text-gray-400">${animal.potential} | ${animal.element}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-green-400">ğŸ’° ${value}</div>
                            <button 
                                class="text-xs ${canBuy ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 cursor-not-allowed'} text-white px-3 py-1 rounded mt-1" 
                                ${canBuy ? `onclick="buyAnimalFromExchange('${animal.id}')"` : 'disabled'}
                            >
                                ${hasCapacity ? (canAfford ? 'è´­ä¹°' : 'é‡‘å¸ä¸è¶³') : 'å®¹é‡å·²æ»¡'}
                            </button>
                        </div>
                    `;
                    content.appendChild(div);
                });

            } else if (tabName === 'auction') {
                if (!gameState.auctions || gameState.auctions.items.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-500 py-8">å½“å‰æ²¡æœ‰æ‹å–å“ã€‚</p>';
                    return;
                }

                gameState.auctions.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-800 p-3 rounded-lg flex items-center justify-between mb-2 cursor-pointer hover:bg-gray-700';
                    div.onclick = () => openAuctionBidPanel(item.id);

                    const timeLeft = Math.max(0, item.endTime - Date.now());
                    const formattedTime = new Date(timeLeft).toISOString().substr(11, 8);

                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-yellow-400">${item.icon} ${item.name}</div>
                            <div class="text-xs text-gray-400">æœ€é«˜å‡ºä»·è€…: <span class="text-cyan-300">${item.highestBidder}</span></div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-green-400">ğŸ’° ${item.currentBid}</div>
                            <div class="text-xs text-red-300">â³ ${formattedTime}</div>
                        </div>
                    `;
                    content.appendChild(div);
                });
            }
        }

        function calculateAnimalValue(animal) {
            let value = 0;
            // ç­‰çº§
            value += animal.level * 50;
            // æ½œåŠ›
            const potentialMultipliers = { 'å¹³åº¸': 1, 'è¶…å¸¸': 1.5, 'ç’€ç’¨': 2.5 };
            value *= potentialMultipliers[animal.potential] || 1;
            // æˆ˜æ–—å±æ€§
            value += (animal.abilities.combat.attack + animal.abilities.combat.defense + animal.abilities.combat.agility) * 2;
            // ä½“åŠ›
            value += animal.maxStamina;
            // æŠ€èƒ½
            if (animal.skills && animal.skills.normal) value += 200;
            if (animal.skills && animal.skills.specialized) value += 1000;
            // å¤–è§‚
            if (animal.appearance) {
                if (animal.appearance.scale && animal.appearance.scale > 1) value += (animal.appearance.scale - 1) * 100;
                if (animal.appearance.effect) value += 500;
            }
            return Math.floor(value);
        }

        window.sellAnimal = function(animalId) {
            const animalIndex = gameState.animals.findIndex(a => a.id === animalId);
            if (animalIndex === -1) return;

            const animal = gameState.animals[animalIndex];
            const value = calculateAnimalValue(animal);

            if (!confirm(`ç¡®å®šè¦ä»¥ ğŸ’°${value} çš„ä»·æ ¼å‡ºå”® ${animal.name} å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
                return;
            }

            // å¢åŠ é‡‘å¸
            gameState.gold += value;
            // ç§»é™¤åŠ¨ç‰©
            gameState.animals.splice(animalIndex, 1);
            gameState.animalCount--;
            // ä»åœºæ™¯ä¸­ç§»é™¤æ¨¡å‹
            animalGroup.remove(animal.mesh);

            showStatus(`âœ… æˆåŠŸå‡ºå”® ${animal.name}ï¼Œè·å¾— ${value} é‡‘å¸ï¼`, 3000);
            updateUI();
            openExchangePanel(); // åˆ·æ–°äº¤æ˜“æ‰€
        };

        // --- å›¾é‰´ç³»ç»Ÿé€»è¾‘ ---

        // å›¾é‰´è§£é”æ£€æŸ¥ - åŸºäºç‰©ç§IDã€ç¨€æœ‰åº¦å’Œå˜å¼‚
        function checkEncyclopediaUnlock(animal) {
            if (!animal || !animal.animalId) return;
            
            // åˆå§‹åŒ–å›¾é‰´æ•°æ®ç»“æ„ï¼ˆå¯¹è±¡æ ¼å¼ï¼‰
            if (!gameState.unlockedEncyclopedia) {
                gameState.unlockedEncyclopedia = {};
            }
            
            const animalId = animal.animalId;
            const mutationKey = getMutationKey(animal);
            const entryKey = mutationKey ? `${animalId}_${mutationKey}` : animalId;
            
            if (!gameState.unlockedEncyclopedia[entryKey]) {
                gameState.unlockedEncyclopedia[entryKey] = {
                    animalId: animalId,
                    mutationKey: mutationKey,
                    unlockedAt: Date.now(),
                    templateKey: animal.templateKey,
                    rarity: animal.rarity || 'common',
                    mutations: {
                        tier1: animal.mutations?.tier1 || null,
                        tier2: animal.mutations?.tier2 || null
                    }
                };
                
                // è·å–åŠ¨ç‰©åç§°
                const animalPool = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
                const template = animalPool.find(t => t.key === animal.templateKey);
                const speciesName = template ? template.name : animal.name;
                const mutationName = mutationKey ? ` - ${mutationKey}` : '';
                
                showStatus(`ğŸ“– æ–°å›¾é‰´è§£é”: ${speciesName}${mutationName}!`, 3000);
            }
        }
        
        // è·å–å˜å¼‚é”®ï¼ˆç”¨äºåŒºåˆ†ä¸åŒå˜å¼‚ç‰ˆæœ¬ï¼‰
        function getMutationKey(animal) {
            if (!animal.mutations) return null;
            const parts = [];
            if (animal.mutations.tier1) parts.push(animal.mutations.tier1);
            if (animal.mutations.tier2) parts.push(animal.mutations.tier2);
            return parts.length > 0 ? parts.join('+') : null;
        }

        // è·³è½¬åˆ°å›¾é‰´é¡µé¢
        function openEncyclopediaPage() {
            // ç§»é™¤æ— æ³•åºåˆ—åŒ–çš„ 'mesh' å’Œå¤§å‹çš„ 'avatarData' å±æ€§
            const serializableGameState = JSON.parse(JSON.stringify(gameState, (key, value) => {
                if (key === 'mesh' || key === 'avatarData') return undefined;
                return value;
            }));
            localStorage.setItem('gameState', JSON.stringify(serializableGameState));
            window.location.href = 'encyclopedia.html';
        }

        function generateRandomAnimalData() {
            const animalId = crypto.randomUUID();
            const nameIndex = Math.floor(Math.random() * ANIMAL_NAMES.length);
            const type = ['sphere', 'cube', 'torus'][Math.floor(Math.random() * 3)];
            const color = Math.floor(Math.random() * 0xffffff);

            return {
                id: animalId,
                type: type,
                name: `${ANIMAL_NAMES[nameIndex]}`,
                originalName: `${ANIMAL_NAMES[nameIndex]}`,
                color: color,
                isWild: false, isPlaced: false,
                level: Math.floor(Math.random() * 10) + 1,
                gender: GENDERS[Math.floor(Math.random() * GENDERS.length)],
                experience: 0,
                experienceToNextLevel: LEVEL_CONFIG.baseExperience,
                stamina: 50 + Math.floor(Math.random() * 20),
                maxStamina: 70 + Math.floor(Math.random() * 30),
                potential: assignPotential(),
                favorability: 0,
                element: ANIMAL_ELEMENTS[Math.floor(Math.random() * ANIMAL_ELEMENTS.length)],
                developmentStage: 'å¹¼å¹´æœŸ',
                abilities: { combat: { attack: 10 + Math.floor(Math.random() * 15), defense: 5 + Math.floor(Math.random() * 10), agility: 8 + Math.floor(Math.random() * 12) } },
                combatSkills: [null, null, null, null],
            };
        }

        function generateExchangeStock() {
            const stock = [];
            const numToGenerate = 3 + Math.floor(Math.random() * 3); // 3-5åª
            for (let i = 0; i < numToGenerate; i++) {
                stock.push(generateRandomAnimalData());
            }
            gameState.exchangeStock = stock;
            gameState.lastStockRefreshDate = new Date().toDateString();
        }

        // æ–°å¢ï¼šåˆ·æ–°äº¤æ˜“æ‰€åº“å­˜
        window.refreshExchangeStock = function() {
            const cost = 5;
            if (gameState.gems < cost) {
                showStatus(`âŒ å®çŸ³ä¸è¶³ï¼éœ€è¦ ${cost} å®çŸ³ã€‚`, 2000);
                return;
            }
            
            if (!confirm(`ç¡®å®šæ¶ˆè€— ${cost} å®çŸ³åˆ·æ–°äº¤æ˜“æ‰€åº“å­˜å—ï¼Ÿ`)) return;

            gameState.gems -= cost;
            generateExchangeStock();
            showStatus(`âœ… äº¤æ˜“æ‰€åº“å­˜å·²åˆ·æ–°ï¼`, 2000);
            updateUI();
            renderExchangeTab('buy');
        };

        window.buyAnimalFromExchange = function(animalId) {
            const animalIndex = gameState.exchangeStock.findIndex(a => a.id === animalId);
            if (animalIndex === -1) return;
            const animalData = gameState.exchangeStock[animalIndex];
            const price = calculateAnimalValue(animalData);

            if (gameState.animalCount >= gameState.maxAnimals) return showStatus(`âŒ åŠ¨ç‰©å®¹é‡å·²æ»¡ï¼`, 3000);
            if (gameState.gold < price) return showStatus(`âŒ é‡‘å¸ä¸è¶³ï¼éœ€è¦ ${price} é‡‘å¸ã€‚`, 3000);

            gameState.gold -= price;
            gameState.exchangeStock.splice(animalIndex, 1);

            const newMesh = createAnimalMesh(animalData);
            animalData.mesh = newMesh;
            animalData.initialPosition = new THREE.Vector3(0, 1, 0);
            animalGroup.add(newMesh);
            gameState.animals.push(animalData);
            gameState.animalCount++;

            showStatus(`âœ… æˆåŠŸè´­ä¹° ${animalData.name}ï¼`, 3000);
            updateUI();
            renderExchangeTab('buy');
        };

        // --- æ‹å–è¡Œé€»è¾‘ ---
        let currentAuctionItemId = null;

        function generateAuctionItems() {
            gameState.auctions = { items: [], lastUpdate: Date.now() };
            const itemsToGenerate = [
                { id: 'egg_1', name: 'ç¥ç§˜çš„è›‹', icon: 'ğŸ¥š', startBid: 1000, duration: 3600 * 1000 * 2 }, // 2 hours
                { id: 'artifact_1', name: 'è¿œå¤çŸ³æ¿', icon: 'ğŸ“œ', startBid: 500, duration: 3600 * 1000 * 1 }, // 1 hour
                { id: 'legend_animal', name: 'é»„é‡‘å…½ (ä¼ è¯´)', icon: 'ğŸ¦', startBid: 50000, duration: 3600 * 1000 * 12 } // 12 hours
            ];

            itemsToGenerate.forEach(itemData => {
                gameState.auctions.items.push({
                    ...itemData,
                    currentBid: itemData.startBid,
                    highestBidder: 'ç³»ç»Ÿ',
                    playerBid: 0, // The amount the player has bid
                    endTime: Date.now() + itemData.duration
                });
            });
        }

        function openAuctionBidPanel(itemId) {
            const item = gameState.auctions.items.find(i => i.id === itemId);
            if (!item) return;

            currentAuctionItemId = itemId;

            ui.bidPanelTitle.textContent = `ç«æ‹: ${item.name}`;
            ui.bidPanelIcon.textContent = item.icon;
            ui.bidPanelCurrentBid.textContent = `ğŸ’° ${item.currentBid}`;
            ui.bidPanelHighestBidder.textContent = item.highestBidder;
            document.getElementById('bid-input').value = item.currentBid + Math.floor(item.currentBid * 0.1); // Suggest a 10% higher bid
            document.getElementById('bid-panel-player-gold').textContent = `ğŸ’° ${gameState.gold}`;

            ui.modalOverlay.classList.remove('hidden');
            ui.auctionBidPanel.classList.remove('hidden');
        }

        function closeAuctionBidPanel() {
            ui.auctionBidPanel.classList.add('hidden');
            // Only hide overlay if no other panels are open
            if (ui.exchangePanel.classList.contains('hidden')) {
                ui.modalOverlay.classList.add('hidden');
            }
            currentAuctionItemId = null;
        }

        function placeBid() {
            if (!currentAuctionItemId) return;
            const item = gameState.auctions.items.find(i => i.id === currentAuctionItemId);
            if (!item) return;

            const bidInput = document.getElementById('bid-input');
            const bidAmount = parseInt(bidInput.value, 10);

            if (isNaN(bidAmount) || bidAmount <= item.currentBid) {
                showStatus('âŒ å‡ºä»·å¿…é¡»é«˜äºå½“å‰æœ€é«˜ä»·ï¼', 2000);
                return;
            }

            // å¦‚æœç©å®¶ä¹‹å‰æœ‰å‡ºä»·ï¼Œå…ˆé€€è¿˜
            if (item.playerBid > 0) {
                gameState.gold += item.playerBid;
            }

            if (gameState.gold < bidAmount) {
                showStatus('âŒ é‡‘å¸ä¸è¶³ï¼', 2000);
                // æŠŠåˆšæ‰é€€è¿˜çš„é’±åŠ å›å»
                if (item.playerBid > 0) gameState.gold -= item.playerBid;
                return;
            }

            // æ‰£é™¤æ–°å‡ºä»·
            gameState.gold -= bidAmount;
            item.currentBid = bidAmount;
            item.playerBid = bidAmount;
            item.highestBidder = 'ç©å®¶';

            showStatus(`âœ… å‡ºä»·æˆåŠŸï¼å½“å‰æœ€é«˜ä»·: ${bidAmount}`, 2500);
            updateUI();
            renderExchangeTab('auction');
            closeAuctionBidPanel();
        }

        function startAuctionUpdateLoop() {
            setInterval(() => {
                if (!gameState.auctions || !gameState.auctions.items) return;

                const now = Date.now();
                let needsRender = false;

                // æ£€æŸ¥ç»“æŸçš„æ‹å–
                const endedAuctions = gameState.auctions.items.filter(item => now >= item.endTime);
                if (endedAuctions.length > 0) {
                    needsRender = true;
                    endedAuctions.forEach(item => {
                        if (item.highestBidder === 'ç©å®¶') {
                            showStatus(`ğŸ‰ æ­å–œï¼ä½ èµ¢å¾—äº† ${item.name} çš„æ‹å–ï¼`, 5000);
                            if (item.id.includes('egg')) {
                                const newAnimal = createNewAnimal(0xffd700, 'sphere');
                                newAnimal.name = "ç¥ç§˜è›‹å­µåŒ–çš„å®å®";
                                newAnimal.potential = 'è¶…å¸¸';
                                showStatus(`ğŸ¥š ä½ çš„ç¥ç§˜è›‹å­µåŒ–äº†ï¼`, 4000);
                            }
                        } else {
                            showStatus(`å¾ˆé—æ†¾ï¼Œä½ åœ¨ ${item.name} çš„æ‹å–ä¸­è¢«å‡»è´¥äº†ã€‚`, 5000);
                            if (item.playerBid > 0) {
                                gameState.gold += item.playerBid;
                                showStatus(`ğŸ’° é€€å›äº†ä½ çš„å‡ºä»· ${item.playerBid} é‡‘å¸ã€‚`, 3000);
                            }
                        }
                    });
                    gameState.auctions.items = gameState.auctions.items.filter(item => now < item.endTime);
                }

                // Only re-render the auction tab if it's currently visible and active
                // to update countdown timers without forcing a tab switch.
                if (!ui.exchangePanel.classList.contains('hidden')) {
                    const auctionTabButton = document.querySelector('.exchange-tab-button[data-tab="auction"]');
                    if (auctionTabButton && auctionTabButton.classList.contains('border-green-500')) {
                        renderExchangeTab('auction');
                    }
                }
            }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // æ•è·é‡ç”ŸåŠ¨ç‰©
        function captureWildAnimal(wildAnimalId) {
            const wildAnimalIndex = gameState.wildAnimals.findIndex(a => a.id === wildAnimalId);
            if (wildAnimalIndex === -1) return;

            const capturedAnimal = gameState.wildAnimals.splice(wildAnimalIndex, 1)[0];
            capturedAnimal.isWild = false;
            capturedAnimal.name = `æ•è·çš„ ${capturedAnimal.originalName}`;
            
            // å°†å…¶æ·»åŠ åˆ°ç©å®¶åŠ¨ç‰©åˆ—è¡¨
            gameState.animals.push(capturedAnimal);
            gameState.animalCount++;
            // æ£€æŸ¥å›¾é‰´ï¼ˆä»…å½“æœ‰animalIdæ—¶ï¼‰
            if (capturedAnimal.animalId) {
                checkEncyclopediaUnlock(capturedAnimal);
            }
            updateUI();
            renderAnimalList(); // åˆ·æ–°å…»æˆåˆ—è¡¨
        }

        // --- æ–°çš„é¡µé¢è·³è½¬å’Œæ•°æ®å¤„ç†é€»è¾‘ ---

        function openAnimalManagementPage() {
            // ç§»é™¤æ— æ³•åºåˆ—åŒ–çš„ 'mesh' å’Œå¤§å‹çš„ 'avatarData' å±æ€§
            const serializableGameState = JSON.parse(JSON.stringify(gameState, (key, value) => {
                if (key === 'mesh' || key === 'avatarData') return undefined;
                return value;
            }));

            localStorage.setItem('gameState', JSON.stringify(serializableGameState));
            window.location.href = 'animal_management.html';
        }

        function openExplorationPage() {
             // ç§»é™¤æ— æ³•åºåˆ—åŒ–çš„ 'mesh' å’Œå¤§å‹çš„ 'avatarData' å±æ€§
            const serializableGameState = JSON.parse(JSON.stringify(gameState, (key, value) => {
                if (key === 'mesh' || key === 'avatarData') return undefined;
                return value;
            }));
            localStorage.setItem('gameState', JSON.stringify(serializableGameState));
            window.location.href = 'exploration.html';
        }

        function openMiningPage() {
             // ç§»é™¤æ— æ³•åºåˆ—åŒ–çš„ 'mesh' å’Œå¤§å‹çš„ 'avatarData' å±æ€§
            const serializableGameState = JSON.parse(JSON.stringify(gameState, (key, value) => {
                if (key === 'mesh' || key === 'avatarData') return undefined;
                return value;
            }));
            localStorage.setItem('gameState', JSON.stringify(serializableGameState));
            window.location.href = 'mining.html';
        }

        function openWorldMapPage() {
            // ç§»é™¤æ— æ³•åºåˆ—åŒ–çš„ 'mesh' å’Œå¤§å‹çš„ 'avatarData' å±æ€§
            const serializableGameState = JSON.parse(JSON.stringify(gameState, (key, value) => {
                if (key === 'mesh' || key === 'avatarData') return undefined;
                return value;
            }));
            localStorage.setItem('gameState', JSON.stringify(serializableGameState));
            window.location.href = 'world_map.html';
        }

        function loadGameStateFromStorage() {
            const storedStateJSON = localStorage.getItem('gameState');
            if (storedStateJSON) {
                const storedState = JSON.parse(storedStateJSON);
                
                // åˆå¹¶çŠ¶æ€ï¼Œè€Œä¸æ˜¯å®Œå…¨è¦†ç›–ï¼Œä»¥ä¿ç•™ mesh ç­‰è¿è¡Œæ—¶å¯¹è±¡
                gameState.food = storedState.food;
                gameState.gold = storedState.gold;
                gameState.wood = storedState.wood;
                gameState.stone = storedState.stone;
                gameState.gems = storedState.gems || 0;
                gameState.expGrass = storedState.expGrass || 0;
                gameState.moonFlower = storedState.moonFlower || 0;
                gameState.mutationCrystal = storedState.mutationCrystal || 0;
                gameState.voidEssence = storedState.voidEssence || 0;
                gameState.upgradingBuildings = storedState.upgradingBuildings || {};
                gameState.breedingDenLevel = storedState.breedingDenLevel;
                gameState.maxAnimals = storedState.maxAnimals;
                gameState.assigningWorkerForBuilding = storedState.assigningWorkerForBuilding; // æ¢å¤åˆ†é…å·¥äººçš„çŠ¶æ€
                gameState.animalCount = storedState.animals.length;
                gameState.activeExplorations = storedState.activeExplorations || [];
                gameState.mining = storedState.mining || { unlockedCheckpoints: [0], currentRun: { isActive: false, team: [], currentDepth: 0, lastTick: 0 } };
                gameState.artifacts = storedState.artifacts || [];
                gameState.inventory = storedState.inventory || {};
                gameState.battleTeam = storedState.battleTeam || [null, null, null, null, null, null];
                gameState.auctions = storedState.auctions || { items: [], lastUpdate: null };
                gameState.lastStockRefreshDate = storedState.lastStockRefreshDate || null;
                gameState.exchangeStock = storedState.exchangeStock || [];
                gameState.unlockedEncyclopedia = storedState.unlockedEncyclopedia || {};

                // åˆ›å»ºä¸€ä¸ªæ—§åŠ¨ç‰©meshçš„æ˜ å°„ï¼Œä»¥ä¾¿æ¢å¤ä½ç½®
                const oldMeshes = new Map();
                gameState.animals.forEach(animal => {
                    if (animal.mesh) {
                        oldMeshes.set(animal.id, {
                            position: animal.mesh.position.clone(),
                            visible: animal.mesh.visible
                        });
                        // ä»åœºæ™¯ä¸­ç§»é™¤æ—§æ¨¡å‹
                        animalGroup.remove(animal.mesh);
                    }
                });


                // 2. æ ¹æ®å­˜å‚¨çš„æ•°æ®é‡å»ºåŠ¨ç‰©åˆ—è¡¨å’Œæ¨¡å‹
                gameState.animals = storedState.animals.map(animalData => {
                    // **å…³é”®ä¿®å¤**ï¼šç¡®ä¿ä»å­˜å‚¨åŠ è½½çš„ä½“åŠ›æ˜¯æ•´æ•°
                    animalData.stamina = Math.floor(animalData.stamina || 0);
                    
                    // **æ–°å¢ä¿®å¤**ï¼šä»æ¨¡æ¿æ¢å¤å¤´åƒæ•°æ®ï¼ˆå¦‚æœæœ‰templateKeyä¸”æ— avatarDataï¼‰
                    if (animalData.templateKey && !animalData.avatarData) {
                        const animalPool = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
                        const template = animalPool.find(t => t.key === animalData.templateKey);
                        if (template && template.avatarData) {
                            animalData.avatarData = template.avatarData;
                        }
                    }

                    const newMesh = createAnimalMesh(animalData);
                    // æ¢å¤æ—§æ¨¡å‹çš„ä½ç½®å’Œå¯è§æ€§
                    const oldMeshData = oldMeshes.get(animalData.id);
                    if (oldMeshData) {
                        newMesh.position.copy(oldMeshData.position);
                        newMesh.visible = oldMeshData.visible;
                    }

                    animalData.mesh = newMesh;
                    animalGroup.add(newMesh);
                    // åŠ è½½æ—¶è¿½æº¯è§£é”å›¾é‰´ï¼ˆä»…å½“æœ‰animalIdæ—¶ï¼‰
                    if (animalData.animalId) {
                        checkEncyclopediaUnlock(animalData);
                    }
                    return animalData;
                });

                // 3. é‡å»ºå»ºç­‘ï¼ˆä¸ºäº†åŒæ­¥ workerIdï¼‰
                gameState.buildings.forEach(b => worldGroup.remove(b.mesh)); // ç§»é™¤æ—§æ¨¡å‹
                gameState.buildings = storedState.buildings.map(buildingData => {
                    const config = BUILDINGS[buildingData.type];
                    const levelConfig = config.levels[buildingData.level];
                    const material = new THREE.MeshPhongMaterial({ color: config.color, shininess: 100 });
                    const mesh = new THREE.Mesh(levelConfig.shape, material);
                    mesh.position.set(buildingData.position.x, buildingData.position.y, buildingData.position.z);
                    mesh.userData.buildingId = buildingData.id;
                    worldGroup.add(mesh);
                    buildingData.mesh = mesh;
                    return buildingData;
                });

                // æ¸…ç†å­˜å‚¨ï¼Œé¿å…ä¸‹æ¬¡åˆ·æ–°æ—¶é‡å¤åŠ è½½
                // localStorage.removeItem('gameState');
                showStatus("å·²ä»ç®¡ç†ä¸­å¿ƒåŒæ­¥æœ€æ–°æ•°æ®ã€‚", 2000);

                // å¦‚æœæ˜¯ä»åˆ†é…å·¥äººæµç¨‹è¿”å›ï¼Œåˆ™é‡æ–°æ‰“å¼€å»ºç­‘è¯¦æƒ…
                if (gameState.assigningWorkerForBuilding) {
                    const building = gameState.buildings.find(b => b.id === gameState.assigningWorkerForBuilding);
                    if (building) showBuildingDetails(building);
                }

                // ä¿®æ­£ï¼šå¦‚æœåŠ è½½çš„å­˜æ¡£é£Ÿç‰©ä¸º0ä¸”æ²¡æœ‰å»ºç­‘ï¼Œåˆ™é‡ç½®ä¸ºåˆå§‹å€¼
                if (gameState.food === 0 && gameState.buildings.length === 0) {
                    gameState.food = 2000;
                }

                // æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ä»ç®¡ç†ä¸­å¿ƒå‘èµ·çš„æ”¾ç½®è¯·æ±‚
                const animalToPlaceId = localStorage.getItem('animalToPlaceId');
                if (animalToPlaceId) {
                    enterAnimalPlacementMode(animalToPlaceId);
                    localStorage.removeItem('animalToPlaceId'); // æ¸…ç†æ ‡è®°
                }
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šä»…åˆ›å»ºåŠ¨ç‰©çš„ 3D æ¨¡å‹
        function createAnimalMesh(animalData) {
            const size = 0.8;
            let geometry;
            if (animalData.type === 'cube') {
                geometry = new THREE.BoxGeometry(size * 1.5, size * 1.5, size * 1.5);
            } else if (animalData.type === 'torus') {
                geometry = new THREE.TorusGeometry(size * 0.8, size * 0.4, 8, 32);
            } else {
                geometry = new THREE.SphereGeometry(size, 16, 16);
            }
            const material = new THREE.MeshPhongMaterial({ color: animalData.color, shininess: 150 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.userData.animalId = animalData.id;
            mesh.visible = animalData.isPlaced;
            // æ¢å¤ä½ç½®çš„é€»è¾‘ç§»åˆ° loadGameStateFromStorage ä¸­
            // è¿™é‡Œåªè®¾ç½®é»˜è®¤ä½ç½®
            if (!animalData.isPlaced) {
                 mesh.position.copy(animalData.initialPosition || new THREE.Vector3(0,1,0));
            }

            // --- åº”ç”¨å¤–è§‚å˜å¼‚ ---
            if (animalData.appearance) {
                // 1. ç¼©æ”¾
                if (animalData.appearance.scale) {
                    mesh.scale.multiplyScalar(animalData.appearance.scale);
                }
                // 2. ç‰¹æ•ˆ
                if (animalData.appearance.effect === 'transparent') {
                    material.transparent = true;
                    material.opacity = 0.6;
                } else if (animalData.appearance.effect === 'glow') {
                    material.emissive = new THREE.Color(animalData.color);
                    material.emissiveIntensity = 0.5;
                }
            }

            return mesh;
        }

        // è¿›å…¥åŠ¨ç‰©æ”¾ç½®æ¨¡å¼
        function enterAnimalPlacementMode(animalId) {
            const animal = gameState.animals.find(a => a.id === animalId);
            if (!animal || animal.isPlaced) return;

            if (animal.exploringMissionId || gameState.mining.currentRun.team.includes(animal.id)) {
                showStatus(`âŒ ${animal.name} æ­£åœ¨æ¢ç´¢ä¸­ï¼Œæ— æ³•æ”¾ç½®ã€‚`, 3000);
                return;
            }

            exitBuildMode(); // ç¡®ä¿é€€å‡ºå…¶ä»–æ¨¡å¼
            gameState.animalToPlace = animalId;

            // åˆ›å»ºé¢„è§ˆæ¨¡å‹
            if (previewMesh) worldGroup.remove(previewMesh);
            const geometry = animal.mesh.geometry.clone();
            const previewMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ff00, transparent: true, opacity: 0.6, wireframe: true
            });
            previewMesh = new THREE.Mesh(geometry, previewMaterial);
            previewMesh.userData.height = geometry.parameters.radius ? geometry.parameters.radius * 2 : geometry.parameters.height;
            worldGroup.add(previewMesh);

            showStatus(`è¯·åœ¨æ –æ¯åœ°ä¸Šç‚¹å‡»ä»¥æ”¾ç½® ${animal.name}ã€‚`, 3000);
            closeAnimalCultivationPanel(); // æ”¾ç½®æ—¶å…³é—­é¢æ¿
            closeStandaloneAnimalDetails(); // æ”¾ç½®æ—¶å…³é—­é¢æ¿
        }

        // æ”¾ç½®åŠ¨ç‰©åˆ°æŒ‡å®šä½ç½®
        function placeAnimal(point) {
            const animal = gameState.animals.find(a => a.id === gameState.animalToPlace);
            if (!animal) return;

            animal.isPlaced = true;
            animal.mesh.position.copy(point);
            const height = animal.mesh.geometry.parameters.radius || animal.mesh.geometry.parameters.height / 2;
            animal.mesh.position.y = height;
            animal.mesh.visible = true;

            showStatus(`âœ… ${animal.name} å·²æ”¾ç½®!`, 2000);

            // å¦‚æœæˆ˜æ–—å‡†å¤‡é¢æ¿æ˜¯æ‰“å¼€çš„ï¼Œåˆ·æ–°å¯é€‰åˆ—è¡¨
            if (!ui.battleSetupPanel.classList.contains('hidden')) {
                renderBattleSelectionList();
            }
            // åˆ·æ–°å…»æˆé¢æ¿åˆ—è¡¨
            if (!ui.animalCultivationPanel.classList.contains('hidden')) {
                renderAnimalList();
            }
            // (æ­¤å¤„çš„UIåˆ·æ–°é€»è¾‘å·²é€šè¿‡å…¶ä»–æ–¹å¼å¤„ç†æˆ–ä¸å†éœ€è¦)
            exitBuildMode(); // é€€å‡ºæ”¾ç½®æ¨¡å¼
        }

        // å¬å›åŠ¨ç‰© (ä¿ç•™åœ¨ä¸»åœºæ™¯)
        function recallAnimal(animalId) {
            const animal = gameState.animals.find(a => a.id === animalId);
            if (!animal || !animal.isPlaced) return;
            animal.isPlaced = false;
            animal.mesh.visible = false;
            showStatus(`â†©ï¸ ${animal.name} å·²è¢«å¬å›ã€‚`, 2000);
            openStandaloneAnimalDetails(animalId); // åˆ·æ–°è¯¦æƒ…é¢æ¿
        }

        // --- UI äº‹ä»¶ç›‘å¬å™¨ ---

        // 1. åŸºå»ºå¾ªç¯: å‡çº§ç¹æ®–çª
        ui.btnUpgradeDen.addEventListener('click', () => {
            closeAllDetailPanels(); 
            if (gameState.isBuildingMode) exitBuildMode();
            const cost = gameState.breedingDenLevel * 50;
            if (gameState.food >= cost) {
                gameState.food -= cost;
                gameState.breedingDenLevel += 1;
                gameState.foodPerTick += 5; 
                gameState.maxAnimals += 5; 
                
                // 3D æ¨¡å‹å˜åŒ–ï¼šç¹æ®–çªå°ºå¯¸å¢å¤§
                denMesh.scale.set(1 + gameState.breedingDenLevel * 0.1, 1 + gameState.breedingDenLevel * 0.1, 1 + gameState.breedingDenLevel * 0.1);
                denMesh.material.color.setHex(0xef4444 + gameState.breedingDenLevel * 0x0500);

                showStatus(`ğŸ¡ ç¹æ®–çªå‡çº§æˆåŠŸ! å®¹é‡: ${gameState.maxAnimals}`, 3000);
            } else {
                showStatus(`âŒ é£Ÿç‰©ä¸è¶³! å‡çº§éœ€è¦ ${cost} é£Ÿç‰©ã€‚`, 3000);
            }
            updateUI();
        });


        // 4. åŸºå»ºç³»ç»Ÿ: æ‰“å¼€å»ºç­‘èœå•
        ui.btnOpenBuild.addEventListener('click', () => {
            closeAllDetailPanels(); // å…³é—­æ‰€æœ‰é¢æ¿
            const isMainMenuHidden = ui.buildMainMenu.classList.contains('hidden');

            // éšè—æ‰€æœ‰å»ºç­‘èœå•ä»¥é‡ç½®çŠ¶æ€
            ui.buildMainMenu.classList.add('hidden');
            ui.buildMaterialMenu.classList.add('hidden');

            if (isMainMenuHidden) {
                ui.buildMainMenu.classList.remove('hidden');
                showStatus("ğŸ”¨ è¯·é€‰æ‹©å»ºç­‘ç±»å‹ã€‚", 3000);
            }
            
            ui.btnOpenBuild.classList.toggle('build-mode-active');
        });

        // å»ºç­‘åˆ†ç±»èœå•çš„ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.category-button').forEach(button => {
            button.addEventListener('click', (event) => {
                const category = event.currentTarget.dataset.category;
                showBuildSubMenu(category);
            });
        });

        // å­èœå•è¿”å›ä¸»èœå•çš„ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.back-to-main-build-menu').forEach(button => {
            button.addEventListener('click', () => {
                ui.buildMaterialMenu.classList.add('hidden');
                ui.buildLandmarksMenu.classList.add('hidden');
                ui.buildExchangeMenu.classList.add('hidden');
                ui.buildAdvancedMenu.classList.add('hidden');
                ui.buildMainMenu.classList.remove('hidden');
            });
        });



        // æ¯ç§’æ£€æŸ¥å—ä¼¤åŠ¨ç‰©çš„æ¢å¤æƒ…å†µ
        setInterval(() => {
            gameState.animals.forEach(animal => {
                if (animal.isInjured && animal.injuryTimer > 0) {
                    animal.injuryTimer--;
                    if (animal.injuryTimer <= 0) {
                        animal.isInjured = false;
                        showStatus(`â¤ï¸ ${animal.name} å·²ç»ä»ä¼¤ç—…ä¸­æ¢å¤ï¼`, 3000);
                    }
                }
            });
        }, 1000);
        
        // --- æ–°å¢ï¼šå¤„ç†ä»æˆ˜æ–—è¿”å›æ—¶æ•è·çš„åŠ¨ç‰© ---
        function processCapturedAnimal() {
            const capturedAnimalDataJSON = localStorage.getItem('capturedAnimal');
            if (!capturedAnimalDataJSON) {
                return; // æ²¡æœ‰æ•è·çš„åŠ¨ç‰©
            }

            const capturedAnimalData = JSON.parse(capturedAnimalDataJSON);

            // æ£€æŸ¥åŠ¨ç‰©å®¹é‡
            if (gameState.animalCount >= gameState.maxAnimals) {
                showStatus(`âŒ åŠ¨ç‰©å®¹é‡å·²æ»¡ï¼æ— æ³•å®‰ç½®æ–°æ•è·çš„ ${capturedAnimalData.name}ã€‚`, 5000);
                // æš‚æ—¶ä¸ç§»é™¤ localStorageï¼Œä»¥ä¾¿ç©å®¶å‡çº§ç¹æ®–çªåè¿˜æœ‰æœºä¼šæ¥æ”¶
                return;
            }

            // --- æ ¸å¿ƒä¿®å¤ï¼šä»é‡ç”ŸåŠ¨ç‰©åˆ—è¡¨ä¸­ç§»é™¤è¢«æ•è·çš„åŠ¨ç‰© ---
            const wildAnimalIndex = gameState.wildAnimals.findIndex(a => a.id === capturedAnimalData.id);
            if (wildAnimalIndex > -1) {
                const originalWildAnimal = gameState.wildAnimals[wildAnimalIndex];
                // 1. ä» 3D åœºæ™¯ä¸­ç§»é™¤æ¨¡å‹
                animalGroup.remove(originalWildAnimal.mesh);
                // 2. ä»æ•°æ®æ•°ç»„ä¸­ç§»é™¤
                gameState.wildAnimals.splice(wildAnimalIndex, 1);
            }
            
            // å¦‚æœæœ‰æ¨¡æ¿keyï¼Œä»æ¨¡æ¿æ¢å¤å¤´åƒæ•°æ®
            if (capturedAnimalData.templateKey && !capturedAnimalData.avatarData) {
                const animalPool = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
                const template = animalPool.find(t => t.key === capturedAnimalData.templateKey);
                if (template && template.avatarData) {
                    capturedAnimalData.avatarData = template.avatarData;
                }
            }

            // ä¿®å¤ï¼šè½¬æ¢ combatSkills æ•°æ®ç»“æ„ä»¥åŒ¹é… animal_management.html çš„æœŸæœ›æ ¼å¼
            // å°†ç®€å•æ•°ç»„æ ¼å¼è½¬æ¢ä¸ºå¯¹è±¡æ ¼å¼
            if (Array.isArray(capturedAnimalData.combatSkills)) {
                const skillsArray = capturedAnimalData.combatSkills;
                capturedAnimalData.combatSkills = {
                    equipped: skillsArray.slice(0, 4), // æœ€å¤š4ä¸ªè£…å¤‡æ§½
                    available: skillsArray // æ‰€æœ‰æŠ€èƒ½éƒ½å¯ç”¨
                };
            }
            
            // ç¡®ä¿æœ‰å®Œæ•´çš„æ•°æ®ç»“æ„
            if (!capturedAnimalData.combatSkills) {
                capturedAnimalData.combatSkills = { equipped: [], available: [] };
            }
            
            // åˆå§‹åŒ–å˜å¼‚ç³»ç»Ÿï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!capturedAnimalData.mutations) {
                capturedAnimalData.mutations = { tier1: null, tier2: null, skills: [], history: [] };
            }
            
            // ç¨€æœ‰åŒ–åŠ¨ç‰©ï¼ˆé—ªå…‰ã€å¹»å½©ã€æ˜ŸèŠ’ï¼‰ä¸æ˜ å°„åˆ°å˜å¼‚ç³»ç»Ÿ
            // å®ƒä»¬çš„ç¨€æœ‰åº¦ä½œä¸ºç‹¬ç«‹å±æ€§ä¿ç•™åœ¨ rarity å­—æ®µä¸­
            // å˜å¼‚ç³»ç»Ÿä¿æŒç‹¬ç«‹ï¼Œå¯ä»¥åœ¨åç»­é€šè¿‡å˜å¼‚å®éªŒå®¤è¿›è¡Œå˜å¼‚
            
            // åˆå§‹åŒ–å˜å¼‚æ¬¡æ•°ï¼ˆå¦‚æœè¿˜æœªè®¾ç½®ï¼‰
            if (typeof capturedAnimalData.mutationCount === 'undefined') {
                capturedAnimalData.mutationCount = 0;
            }
            
            // åˆå§‹åŒ–å¥½æ„Ÿåº¦
            if (typeof capturedAnimalData.favorability === 'undefined') {
                capturedAnimalData.favorability = 0;
            }
            
            // åˆå§‹åŒ–å‘è‚²é˜¶æ®µ
            if (!capturedAnimalData.developmentStage) {
                capturedAnimalData.developmentStage = 'å¹¼å¹´æœŸ';
            }

            // 1. é‡å»º 3D æ¨¡å‹
            const size = 0.8;
            let geometry;
            if (capturedAnimalData.type === 'cube') {
                geometry = new THREE.BoxGeometry(size * 1.5, size * 1.5, size * 1.5);
            } else if (capturedAnimalData.type === 'torus') {
                geometry = new THREE.TorusGeometry(size * 0.8, size * 0.4, 8, 32);
            } else {
                geometry = new THREE.SphereGeometry(size, 16, 16);
            }
            const material = new THREE.MeshPhongMaterial({ color: capturedAnimalData.color, shininess: 150 });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.userData.animalId = capturedAnimalData.id;

            // 2. æ›´æ–°åŠ¨ç‰©æ•°æ®
            capturedAnimalData.isWild = false; // ä¸å†æ˜¯é‡ç”Ÿ
            capturedAnimalData.isPlaced = false; // é»˜è®¤åœ¨"å®¶ä¸­"ï¼Œç­‰å¾…ç©å®¶æ”¾ç½®
            capturedAnimalData.mesh = mesh; // å…³è”æ–°çš„ 3D æ¨¡å‹
            capturedAnimalData.initialPosition = new THREE.Vector3(0, 1, 0); // è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„å®¶ä½ç½®
            mesh.visible = false; // åœ¨å®¶ä¸­æ—¶ä¸å¯è§

            // 3. æ·»åŠ åˆ°æ¸¸æˆçŠ¶æ€
            gameState.animals.push(capturedAnimalData);
            gameState.animalCount++;
            animalGroup.add(mesh);
            // æ£€æŸ¥å›¾é‰´ï¼ˆå¿…é¡»åœ¨æ·»åŠ åˆ°æ•°ç»„åï¼Œä¸”ä»…å½“æœ‰animalIdæ—¶ï¼‰
            if (capturedAnimalData.animalId) {
                checkEncyclopediaUnlock(capturedAnimalData);
            }

            // 4. æ¸…ç†å¹¶é€šçŸ¥
            localStorage.removeItem('capturedAnimal');
            showStatus(`ğŸ‰ æ¬¢è¿æ–°ä¼™ä¼´ï¼æ•è·çš„ ${capturedAnimalData.name} å·²è¢«é€è‡³ä½ çš„æ –æ¯åœ°ï¼`, 5000);
            updateUI();
        }

        // --- æ–°å¢ï¼šå»ºç­‘èœå•åˆ‡æ¢é€»è¾‘ ---
        function showBuildSubMenu(category) {
            ui.buildMainMenu.classList.add('hidden');
            switch (category) {
                case 'materials':
                    ui.buildMaterialMenu.classList.remove('hidden');
                    showStatus("è¯·é€‰æ‹©è¦æ”¾ç½®çš„åŸºç¡€å»ºç­‘ã€‚");
                    break;
                case 'landmarks':
                    ui.buildLandmarksMenu.classList.remove('hidden');
                    showStatus("è¯·é€‰æ‹©è¦æ”¾ç½®çš„åœ°æ ‡å»ºç­‘ã€‚");
                    break;
                case 'exchange':
                    ui.buildExchangeMenu.classList.remove('hidden');
                    showStatus("è¯·é€‰æ‹©è¦æ”¾ç½®çš„äº¤æ˜“æ‰€ã€‚");
                    break;
                case 'advanced':
                    ui.buildAdvancedMenu.classList.remove('hidden');
                    showStatus("è¯·é€‰æ‹©è¦æ”¾ç½®çš„è¿›é˜¶å»ºç­‘ã€‚");
                    break;
                case 'shrines':
                    showStatus(`æ­¤å»ºç­‘ç±»å‹ "${category}" æš‚æœªå¼€æ”¾ã€‚`, 2000);
                    ui.buildMainMenu.classList.remove('hidden'); // è¿”å›ä¸»èœå•
                    break;
            }
        }

        // --- åº”ç”¨å¯åŠ¨ ---
        window.onload = function() {
            initThreeJS();
            loadGameStateFromStorage();
            processCapturedAnimal();
            
            // å¦‚æœæ˜¯é¦–æ¬¡æ¸¸æˆï¼Œä»åŠ¨ç‰©æ± åˆ›å»ºä¸€åªåˆå§‹åŠ¨ç‰©
            if (gameState.animals.length === 0) {
                const animalPool = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
                if (animalPool.length > 0) {
                    const template = animalPool[Math.floor(Math.random() * animalPool.length)];
                    createAnimalFromTemplate(template);
                    showStatus(`ğŸ‰ ä½ è·å¾—äº†ä¸€åª ${template.name}ï¼`, 4000);
                }
            }
            
            startAuctionUpdateLoop();
            startResourceLoops();
            startGameStateUpdateLoop();
            updateUI();
            showStatus("æ¬¢è¿æ¥åˆ°ç”µå­ç›†æ ½ï¼æ‹–åŠ¨å¯æ—‹è½¬è§†è§’ï¼Œç‚¹å‡»ğŸ¾åŠ¨ç‰©ç³»ç»Ÿè¿›è¡Œç¹æ®–å’ŒæŸ¥çœ‹åå†Œã€‚", 5000);
        };
        
        // ä»æ¨¡æ¿åˆ›å»ºåŠ¨ç‰©
        function createAnimalFromTemplate(template) {
            const animalId = crypto.randomUUID();
            
            // åˆ›å»º3Dæ¨¡å‹
            const size = 0.8;
            const geometry = new THREE.SphereGeometry(size, 16, 16);
            const color = parseInt(template.color.replace('#', ''), 16);
            const material = new THREE.MeshPhongMaterial({ color: color, shininess: 150 });
            const mesh = new THREE.Mesh(geometry, material);
            
            // åˆå§‹ä½ç½®
            const angle = Math.random() * Math.PI * 2;
            const radius = 5 + Math.random() * 7;
            const initialPosition = new THREE.Vector3(Math.cos(angle) * radius, 1, Math.sin(angle) * radius);
            mesh.position.copy(initialPosition);
            mesh.visible = false;
            mesh.userData.animalId = animalId;
            
            // åˆ›å»ºåŠ¨ç‰©æ•°æ®
            const animalData = {
                id: animalId,
                animalId: template.animalId,
                templateKey: template.key,
                type: 'sphere',
                name: template.name,
                originalName: template.name,
                color: color,
                avatarData: template.avatarData || null,
                mesh: mesh,
                isWild: false,
                isPlaced: false,
                initialPosition: initialPosition,
                level: template.level || 1,
                gender: Math.random() > 0.5 ? 'é›„' : 'é›Œ',
                experience: 0,
                experienceToNextLevel: template.baseExp || 100,
                stamina: template.stamina || 100,
                maxStamina: template.stamina || 100,
                potential: 'å¹³åº¸',
                favorability: template.favorability || 50,
                element: template.element || 'æ°´',
                developmentStage: 'å¹¼å¹´æœŸ',
                rarity: template.rarity || 'common',
                abilities: {
                    combat: {
                        attack: template.attack || 10,
                        defense: template.defense || 5,
                        agility: template.agility || 8
                    }
                },
                combatSkills: {
                    equipped: [],
                    available: []
                },
                mutations: {
                    tier1: null,
                    tier2: null,
                    skills: [],
                    history: []
                },
                mutationCount: 0,
                isInjured: false,
                injuryTimer: 0,
                workingBuildingId: null
            };
            
            // å¤„ç†æŠ€èƒ½
            if (template.skillPoolKey) {
                const skillPools = JSON.parse(localStorage.getItem('SKILL_POOLS') || '[]');
                const skillPool = skillPools.find(p => p.key === template.skillPoolKey);
                if (skillPool && skillPool.skills) {
                    const availableSkills = skillPool.skills.map(s => s.skillKey);
                    animalData.combatSkills.available = availableSkills;
                    // éšæœºè£…å¤‡2ä¸ªæŠ€èƒ½
                    const equipped = [];
                    for (let i = 0; i < Math.min(2, availableSkills.length); i++) {
                        const randomIndex = Math.floor(Math.random() * availableSkills.length);
                        const skill = availableSkills[randomIndex];
                        if (!equipped.includes(skill)) {
                            equipped.push(skill);
                        }
                    }
                    animalData.combatSkills.equipped = equipped;
                }
            }
            
            gameState.animals.push(animalData);
            gameState.animalCount = gameState.animals.length;
            animalGroup.add(mesh);
            
            // æ£€æŸ¥å›¾é‰´è§£é”
            if (animalData.animalId) {
                checkEncyclopediaUnlock(animalData);
            }
        }

    </script>
</body>
</html>