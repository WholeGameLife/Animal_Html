<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€èƒ½æ± é…ç½®å™¨ - ç”µå­ç›†æ ½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* ç³»åˆ«é¢œè‰² */
        .element-normal { background: linear-gradient(135deg, #9ca3af, #6b7280); color: white; }
        .element-water { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .element-fire { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .element-grass { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .element-wind { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
        .element-metal { background: linear-gradient(135deg, #d4af37, #b8860b); color: white; }
        .element-earth { background: linear-gradient(135deg, #a16207, #854d0e); color: white; }
        
        /* å˜å¼‚é¢œè‰² */
        .mutation-dark { background: linear-gradient(135deg, #1f2937, #111827); color: white; }
        .mutation-light { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); color: #111827; }
        .mutation-crystal { background: linear-gradient(135deg, #a78bfa, #8b5cf6); color: white; }
        .mutation-shadow { background: linear-gradient(135deg, #4b5563, #374151); color: white; }
        .mutation-thunder { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; }
        .mutation-holy { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
        .mutation-psychic { background: linear-gradient(135deg, #ec4899, #db2777); color: white; }
        .mutation-chaos { background: linear-gradient(135deg, #581c87, #6b21a8); color: white; }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        body {
            background: linear-gradient(135deg, #581c87 0%, #7c2d12 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .pool-card {
            transition: all 0.3s ease;
        }
        
        .pool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ² æŠ€èƒ½æ± é…ç½®å™¨ ğŸ²</h1>
            <p class="text-purple-200 mb-3">é¢„è®¾æŠ€èƒ½æ± æ¨¡æ¿ï¼ŒåŠ¨ç‰©é€‰æ‹©æŠ€èƒ½æ± å³å¯è·å¾—éšæœºæŠ€èƒ½</p>
            <div class="flex justify-center gap-3">
                <button onclick="window.history.back()"
                        class="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    <span>â†</span>
                    <span>è¿”å›</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- å·¦ä¾§ï¼šæŠ€èƒ½æ± è®¾è®¡è¡¨å• -->
            <div class="lg:col-span-3 bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ¨ åˆ›å»ºæŠ€èƒ½æ± </h2>
                
                <form id="pool-form" class="space-y-4">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½æ± åç§° *</label>
                            <input type="text" id="pool-name" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500"
                                placeholder="ä¾‹: ç«ç³»åŸºç¡€æŠ€èƒ½æ± ">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½æ± å›¾æ ‡ *</label>
                            <input type="text" id="pool-icon" required maxlength="2" value="ğŸ²"
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-2xl focus:outline-none focus:border-purple-500">
                        </div>
                    </div>

                    <!-- æè¿° -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">æŠ€èƒ½æ± æè¿°</label>
                        <textarea id="pool-description" rows="2" placeholder="æè¿°è¿™ä¸ªæŠ€èƒ½æ± çš„ç”¨é€”å’Œç‰¹ç‚¹..."
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-purple-500 resize-none"></textarea>
                    </div>

                    <!-- æŠ€èƒ½æ± é…ç½® - å››ä¸ªç¨€æœ‰åº¦åˆ— -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ¯ æŠ€èƒ½æ± é…ç½®ï¼ˆæŒ‰ç¨€æœ‰åº¦åˆ†ç±»ï¼‰</label>
                        <p class="text-xs text-gray-400 mb-3">ğŸ’¡ è®¾ç½®å„ç¨€æœ‰åº¦ç”Ÿæˆæƒé‡ï¼Œæ± å†…æŠ€èƒ½æŒ‰è¯¥æƒé‡å¹³åˆ†</p>
                        <div class="grid grid-cols-4 gap-3">
                            <!-- æ™®é€šç¨€æœ‰åº¦ -->
                            <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-600">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-gray-300">âšª æ™®é€š</h4>
                                    <button type="button" onclick="addSkillToRarity('common')"
                                        class="text-gray-400 hover:text-white text-lg">+</button>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs text-gray-400">ç”Ÿæˆæƒé‡</label>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="rarity-weight-common" min="0" max="100" step="0.1" value="70"
                                            onchange="updateRarityWeight()"
                                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs text-center focus:outline-none">
                                        <span class="text-xs text-gray-400">%</span>
                                    </div>
                                </div>
                                <div id="skills-common" class="space-y-2 min-h-[200px] max-h-96 overflow-y-auto">
                                    <div class="text-center text-gray-500 text-xs py-4">ç‚¹å‡»+æ·»åŠ </div>
                                </div>
                            </div>

                            <!-- ç¨€æœ‰ç¨€æœ‰åº¦ -->
                            <div class="bg-yellow-900/30 rounded-lg p-3 border border-yellow-600">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-yellow-300">âœ¨ ç¨€æœ‰</h4>
                                    <button type="button" onclick="addSkillToRarity('rare')"
                                        class="text-yellow-400 hover:text-yellow-300 text-lg">+</button>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs text-gray-400">ç”Ÿæˆæƒé‡</label>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="rarity-weight-rare" min="0" max="100" step="0.1" value="20"
                                            onchange="updateRarityWeight()"
                                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs text-center focus:outline-none">
                                        <span class="text-xs text-gray-400">%</span>
                                    </div>
                                </div>
                                <div id="skills-rare" class="space-y-2 min-h-[200px] max-h-96 overflow-y-auto">
                                    <div class="text-center text-gray-500 text-xs py-4">ç‚¹å‡»+æ·»åŠ </div>
                                </div>
                            </div>

                            <!-- å²è¯—ç¨€æœ‰åº¦ -->
                            <div class="bg-pink-900/30 rounded-lg p-3 border border-pink-600">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-pink-300">ğŸŒˆ å²è¯—</h4>
                                    <button type="button" onclick="addSkillToRarity('epic')"
                                        class="text-pink-400 hover:text-pink-300 text-lg">+</button>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs text-gray-400">ç”Ÿæˆæƒé‡</label>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="rarity-weight-epic" min="0" max="100" step="0.1" value="8"
                                            onchange="updateRarityWeight()"
                                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs text-center focus:outline-none">
                                        <span class="text-xs text-gray-400">%</span>
                                    </div>
                                </div>
                                <div id="skills-epic" class="space-y-2 min-h-[200px] max-h-96 overflow-y-auto">
                                    <div class="text-center text-gray-500 text-xs py-4">ç‚¹å‡»+æ·»åŠ </div>
                                </div>
                            </div>

                            <!-- ä¼ è¯´ç¨€æœ‰åº¦ -->
                            <div class="bg-orange-900/30 rounded-lg p-3 border border-orange-600">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="text-sm font-bold text-orange-300">â­ ä¼ è¯´</h4>
                                    <button type="button" onclick="addSkillToRarity('legendary')"
                                        class="text-orange-400 hover:text-orange-300 text-lg">+</button>
                                </div>
                                <div class="mb-2">
                                    <label class="text-xs text-gray-400">ç”Ÿæˆæƒé‡</label>
                                    <div class="flex items-center gap-1">
                                        <input type="number" id="rarity-weight-legendary" min="0" max="100" step="0.1" value="2"
                                            onchange="updateRarityWeight()"
                                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs text-center focus:outline-none">
                                        <span class="text-xs text-gray-400">%</span>
                                    </div>
                                </div>
                                <div id="skills-legendary" class="space-y-2 min-h-[200px] max-h-96 overflow-y-auto">
                                    <div class="text-center text-gray-500 text-xs py-4">ç‚¹å‡»+æ·»åŠ </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æŒ‰é’® -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="submit-btn"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            <span id="submit-text">âœ¨ åˆ›å»ºæŠ€èƒ½æ± </span>
                        </button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            âŒ å–æ¶ˆç¼–è¾‘
                        </button>
                        <button type="button" id="clear-btn"
                            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            ğŸ”„ æ¸…ç©º
                        </button>
                    </div>
                </form>
            </div>

            <!-- å³ä¾§ï¼šé¢„è§ˆå’Œåˆ—è¡¨ -->
            <div class="space-y-6">
                <!-- æŠ€èƒ½æ± é¢„è§ˆ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ‘ï¸ æŠ€èƒ½æ± é¢„è§ˆ</h3>
                    <div id="pool-preview" class="pool-card bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">â“</div>
                            <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                        </div>
                    </div>
                </div>

                <!-- æŠ€èƒ½æ± åˆ—è¡¨ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">ğŸ“‹ æŠ€èƒ½æ± åˆ—è¡¨ (<span id="pool-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <label for="import-file"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer">
                                ğŸ“¤ å¯¼å…¥
                            </label>
                            <input type="file" id="import-file" accept=".json" class="hidden">
                            <button id="export-btn"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ“¥ å¯¼å‡ºJSON
                            </button>
                            <button id="export-csv-btn"
                                class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ“Š å¯¼å‡ºCSV
                            </button>
                        </div>
                    </div>
                    <div id="pools-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 text-sm py-8">
                            æš‚æ— æŠ€èƒ½æ± 
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æŠ€èƒ½é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="skill-select-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-xl p-6 max-w-4xl w-full mx-4 border border-gray-700 max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">ä»æŠ€èƒ½åº“é€‰æ‹©æŠ€èƒ½</h3>
                <button id="close-skill-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>
            
            <!-- ç­›é€‰å’Œæœç´¢ -->
            <div class="mb-4 flex gap-3">
                <input type="text" id="skill-search" placeholder="ğŸ” æœç´¢æŠ€èƒ½åç§°..."
                    class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                <select id="skill-type-filter"
                    class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    <option value="">å…¨éƒ¨ç±»å‹</option>
                    <option value="attack">âš”ï¸ æ”»å‡»å‹</option>
                    <option value="defense">ğŸ›¡ï¸ é˜²å¾¡å‹</option>
                    <option value="agility">âš¡ æ•æ·å‹</option>
                    <option value="buff">ğŸ’ª å¢ç›Šå‹</option>
                    <option value="debuff">ğŸ”» å‡ç›Šå‹</option>
                    <option value="heal">ğŸ’š æ²»ç–—å‹</option>
                </select>
                <select id="skill-category-filter"
                    class="bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    <option value="">å…¨éƒ¨ç³»åˆ«</option>
                    <option value="element-normal">â­• æ™®é€š</option>
                    <option value="element-water">ğŸ’§ æ°´ç³»</option>
                    <option value="element-fire">ğŸ”¥ ç«ç³»</option>
                    <option value="element-grass">ğŸŒ¿ è‰ç³»</option>
                    <option value="element-wind">ğŸ’¨ é£ç³»</option>
                    <option value="element-metal">ğŸª™ é‡‘ç³»</option>
                    <option value="element-earth">ğŸª¨ åœŸç³»</option>
                    <option value="mutation">âœ¨ å˜å¼‚ç³»</option>
                </select>
            </div>
            
            <div id="skill-pool-list" class="space-y-2 overflow-y-auto flex-1">
                <!-- æŠ€èƒ½åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <script>
        // æŠ€èƒ½æ± å­˜å‚¨
        let skillPools = JSON.parse(localStorage.getItem('SKILL_POOLS') || '[]');
        // æŠ€èƒ½åº“
        let skillLibrary = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
        // å½“å‰é…ç½®çš„æŠ€èƒ½ï¼ˆæŒ‰ç¨€æœ‰åº¦åˆ†ç±»ï¼‰
        let configuredSkills = {
            common: [],    // æ™®é€š
            rare: [],      // ç¨€æœ‰
            epic: [],      // å²è¯—
            legendary: []  // ä¼ è¯´
        };
        // ç¨€æœ‰åº¦ç”Ÿæˆæƒé‡
        let rarityWeights = {
            common: 70,
            rare: 20,
            epic: 8,
            legendary: 2
        };
        // å½“å‰æ­£åœ¨ä¸ºå“ªä¸ªç¨€æœ‰åº¦æ·»åŠ æŠ€èƒ½
        let currentRarity = 'common';
        // å½“å‰ç¼–è¾‘çš„ç´¢å¼•
        let editingIndex = -1;

        // DOMå…ƒç´ 
        const form = document.getElementById('pool-form');
        const preview = document.getElementById('pool-preview');
        const poolsList = document.getElementById('pools-list');
        const poolCount = document.getElementById('pool-count');

        // åˆå§‹åŒ–
        function init() {
            renderPoolsList();
            setupFormListeners();
            updatePoolCount();
            setupSkillModal();
            renderConfiguredSkills(); // åˆå§‹åŒ–å››åˆ—æ˜¾ç¤º
        }

        // æ›´æ–°æŠ€èƒ½æ± æ•°é‡
        function updatePoolCount() {
            poolCount.textContent = skillPools.length;
        }

        // æ›´æ–°ç¨€æœ‰åº¦æƒé‡å¹¶é‡æ–°è®¡ç®—æŠ€èƒ½æƒé‡
        window.updateRarityWeight = function() {
            rarityWeights.common = parseFloat(document.getElementById('rarity-weight-common').value) || 0;
            rarityWeights.rare = parseFloat(document.getElementById('rarity-weight-rare').value) || 0;
            rarityWeights.epic = parseFloat(document.getElementById('rarity-weight-epic').value) || 0;
            rarityWeights.legendary = parseFloat(document.getElementById('rarity-weight-legendary').value) || 0;
            
            // é‡æ–°è®¡ç®—æ¯ä¸ªæŠ€èƒ½çš„æƒé‡
            recalculateSkillWeights();
            renderConfiguredSkills();
        }

        // é‡æ–°è®¡ç®—æ‰€æœ‰æŠ€èƒ½çš„æƒé‡ï¼ˆåŸºäºç¨€æœ‰åº¦æƒé‡å¹³åˆ†ï¼‰
        function recalculateSkillWeights() {
            Object.keys(configuredSkills).forEach(rarity => {
                const skills = configuredSkills[rarity];
                const rarityWeight = rarityWeights[rarity] || 0;
                const skillCount = skills.length;
                
                if (skillCount > 0) {
                    const weightPerSkill = rarityWeight / skillCount;
                    skills.forEach(skill => {
                        skill.weight = parseFloat(weightPerSkill.toFixed(2));
                    });
                }
            });
        }

        // è®¾ç½®è¡¨å•ç›‘å¬å™¨
        function setupFormListeners() {
            form.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            form.onsubmit = (e) => {
                e.preventDefault();
                if (editingIndex >= 0) {
                    updateSkillPool();
                } else {
                    createSkillPool();
                }
            };

            document.getElementById('clear-btn').onclick = () => {
                form.reset();
                configuredSkills = { common: [], rare: [], epic: [], legendary: [] };
                cancelEdit();
                renderConfiguredSkills();
                updatePreview();
            };

            document.getElementById('cancel-edit-btn').onclick = () => {
                form.reset();
                configuredSkills = { common: [], rare: [], epic: [], legendary: [] };
                cancelEdit();
                renderConfiguredSkills();
                updatePreview();
            };

            document.getElementById('export-btn').onclick = exportSkillPools;
            document.getElementById('export-csv-btn').onclick = exportSkillPoolsToCSV;
            document.getElementById('import-file').onchange = importSkillPools;
        }

        // ä¸ºæŒ‡å®šç¨€æœ‰åº¦æ·»åŠ æŠ€èƒ½
        window.addSkillToRarity = function(rarity) {
            currentRarity = rarity;
            renderSkillLibrary();
            document.getElementById('skill-select-modal').classList.remove('hidden');
        }

        // è®¾ç½®æŠ€èƒ½é€‰æ‹©æ¨¡æ€æ¡†
        function setupSkillModal() {
            const modal = document.getElementById('skill-select-modal');
            const closeBtn = document.getElementById('close-skill-modal');

            closeBtn.onclick = () => modal.classList.add('hidden');
            modal.onclick = (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            };
            
            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('skill-search').addEventListener('input', renderSkillLibrary);
            document.getElementById('skill-type-filter').addEventListener('change', renderSkillLibrary);
            document.getElementById('skill-category-filter').addEventListener('change', renderSkillLibrary);
        }

        // æ¸²æŸ“æŠ€èƒ½åº“åˆ—è¡¨
        function renderSkillLibrary() {
            const skillPoolList = document.getElementById('skill-pool-list');
            
            if (skillLibrary.length === 0) {
                skillPoolList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p class="mb-2">æŠ€èƒ½åº“ä¸ºç©º</p>
                        <p class="text-sm">è¯·å…ˆåœ¨æŠ€èƒ½è®¾è®¡å™¨ä¸­åˆ›å»ºæŠ€èƒ½</p>
                    </div>
                `;
                return;
            }

            // è·å–ç­›é€‰æ¡ä»¶
            const searchText = document.getElementById('skill-search').value.toLowerCase();
            const typeFilter = document.getElementById('skill-type-filter').value;
            const categoryFilter = document.getElementById('skill-category-filter').value;

            // è¿‡æ»¤å·²é…ç½®åˆ°ä»»ä½•ç¨€æœ‰åº¦åˆ—çš„æŠ€èƒ½ï¼ˆåŒä¸€æŠ€èƒ½ä¸èƒ½é‡å¤æ·»åŠ ï¼‰
            const configuredKeys = new Set();
            Object.values(configuredSkills).forEach(skills => {
                skills.forEach(s => configuredKeys.add(s.skillKey));
            });
            
            let availableSkills = skillLibrary.filter(s => !configuredKeys.has(s.key));

            // åº”ç”¨æœç´¢è¿‡æ»¤
            if (searchText) {
                availableSkills = availableSkills.filter(s =>
                    s.name.toLowerCase().includes(searchText)
                );
            }

            // åº”ç”¨ç±»å‹è¿‡æ»¤
            if (typeFilter) {
                availableSkills = availableSkills.filter(s => s.type === typeFilter);
            }

            // åº”ç”¨ç³»åˆ«è¿‡æ»¤
            if (categoryFilter) {
                if (categoryFilter === 'mutation') {
                    availableSkills = availableSkills.filter(s =>
                        s.category && s.category.includes('mutation')
                    );
                } else {
                    availableSkills = availableSkills.filter(s => s.category === categoryFilter);
                }
            }

            if (availableSkills.length === 0) {
                skillPoolList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        ${configuredKeys.size > 0 ? 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æŠ€èƒ½æˆ–æ‰€æœ‰æŠ€èƒ½éƒ½å·²æ·»åŠ ' : 'æ‰€æœ‰æŠ€èƒ½éƒ½å·²æ·»åŠ åˆ°æ± ä¸­'}
                    </div>
                `;
                return;
            }

            // æŒ‰ç±»å‹åˆ†ç»„
            const groupedSkills = {
                'attack': [],
                'defense': [],
                'agility': [],
                'buff': [],
                'debuff': [],
                'heal': []
            };

            availableSkills.forEach(skill => {
                const type = skill.type || 'attack';
                if (groupedSkills[type]) {
                    groupedSkills[type].push(skill);
                }
            });

            const typeIcons = {
                'attack': 'âš”ï¸',
                'defense': 'ğŸ›¡ï¸',
                'agility': 'âš¡',
                'buff': 'ğŸ’ª',
                'debuff': 'ğŸ”»',
                'heal': 'ğŸ’š'
            };

            const typeNames = {
                'attack': 'æ”»å‡»å‹',
                'defense': 'é˜²å¾¡å‹',
                'agility': 'æ•æ·å‹',
                'buff': 'å¢ç›Šå‹',
                'debuff': 'å‡ç›Šå‹',
                'heal': 'æ²»ç–—å‹'
            };

            // æŒ‰åˆ†ç»„æ¸²æŸ“
            let html = '';
            Object.entries(groupedSkills).forEach(([type, skills]) => {
                if (skills.length === 0) return;

                const typeIcon = typeIcons[type] || '';
                const typeName = typeNames[type] || type;

                html += `
                    <div class="mb-4">
                        <div class="text-sm font-bold text-blue-300 mb-2 px-2">${typeIcon} ${typeName} (${skills.length})</div>
                        <div class="space-y-2">
                            ${skills.map(skill => {
                                const categoryBadge = skill.category ?
                                    `<span class="category-badge ${skill.category} text-xs">${getCategoryName(skill.category)}</span>` : '';
                                
                                return `
                                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-600 hover:border-blue-500 cursor-pointer transition-colors"
                                         onclick="selectSkill('${skill.key}')">
                                        <div class="flex items-start gap-3">
                                            <div class="text-2xl">${skill.icon}</div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                    <h5 class="text-sm font-bold text-white">${skill.name}</h5>
                                                    ${categoryBadge}
                                                </div>
                                                ${skill.description ? `<p class="text-xs text-gray-400 line-clamp-2">${skill.description}</p>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            skillPoolList.innerHTML = html || '<div class="text-center text-gray-500 py-8">æ²¡æœ‰å¯ç”¨çš„æŠ€èƒ½</div>';
        }

        // é€‰æ‹©æŠ€èƒ½ï¼ˆæ·»åŠ åˆ°å½“å‰ç¨€æœ‰åº¦åˆ—ï¼‰
        function selectSkill(skillKey) {
            const skill = skillLibrary.find(s => s.key === skillKey);
            if (!skill) return;

            // è®¡ç®—è¯¥ç¨€æœ‰åº¦çš„å¹³å‡æƒé‡
            const rarityWeight = rarityWeights[currentRarity] || 0;
            const currentSkillCount = configuredSkills[currentRarity].length;
            const newSkillCount = currentSkillCount + 1;
            const weightPerSkill = rarityWeight / newSkillCount;

            // æ·»åŠ æ–°æŠ€èƒ½
            configuredSkills[currentRarity].push({
                skillKey: skill.key,
                weight: parseFloat(weightPerSkill.toFixed(2)),
                unlockLevel: 1
            });

            // é‡æ–°åˆ†é…è¯¥ç¨€æœ‰åº¦æ‰€æœ‰æŠ€èƒ½çš„æƒé‡ï¼ˆå¹³å‡åˆ†é…ï¼‰
            configuredSkills[currentRarity].forEach(s => {
                s.weight = parseFloat(weightPerSkill.toFixed(2));
            });

            renderConfiguredSkills();
            document.getElementById('skill-select-modal').classList.add('hidden');
        }

        // æ¸²æŸ“å·²é…ç½®çš„æŠ€èƒ½ï¼ˆæŒ‰å››ä¸ªç¨€æœ‰åº¦åˆ—æ˜¾ç¤ºï¼‰
        function renderConfiguredSkills() {
            const rarities = ['common', 'rare', 'epic', 'legendary'];
            
            rarities.forEach(rarity => {
                const list = document.getElementById(`skills-${rarity}`);
                const skills = configuredSkills[rarity] || [];

                if (skills.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-500 text-xs py-4">ç‚¹å‡»+æ·»åŠ </div>';
                    return;
                }

                list.innerHTML = skills.map((config, index) => {
                    const skill = skillLibrary.find(s => s.key === config.skillKey);
                    if (!skill) return '';

                    const typeIcons = {
                        'attack': 'âš”ï¸',
                        'defense': 'ğŸ›¡ï¸',
                        'agility': 'âš¡',
                        'buff': 'ğŸ’ª',
                        'debuff': 'ğŸ”»',
                        'heal': 'ğŸ’š'
                    };
                    const typeIcon = typeIcons[skill.type] || '';

                    return `
                        <div class="bg-gray-700/70 rounded-lg p-2 border border-gray-600 hover:border-gray-500 transition-colors">
                            <div class="flex items-start gap-1">
                                <div class="text-lg flex-shrink-0">${skill.icon}</div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-1 mb-1">
                                        <span class="text-xs font-bold text-white truncate" title="${skill.name}">${skill.name}</span>
                                        <span class="text-xs">${typeIcon}</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-1">
                                            <span class="text-xs text-gray-400 whitespace-nowrap">è·å¾—</span>
                                            <input type="number" min="0" max="100" step="0.01" value="${config.weight || 0}"
                                                onchange="updateSkillWeight('${rarity}', ${index}, this.value)"
                                                class="w-14 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-white text-xs text-center focus:outline-none"
                                                readonly
                                                title="è‡ªåŠ¨è®¡ç®—ï¼šç¨€æœ‰åº¦æƒé‡ Ã· æŠ€èƒ½æ•°">
                                            <span class="text-xs text-gray-400">%</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-xs text-gray-400 whitespace-nowrap">ç­‰çº§</span>
                                            <input type="number" min="1" max="100" value="${config.unlockLevel || 1}"
                                                onchange="updateSkillLevel('${rarity}', ${index}, this.value)"
                                                class="w-12 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-white text-xs text-center focus:outline-none">
                                        </div>
                                    </div>
                                </div>
                                <button onclick="removeSkill('${rarity}', ${index})"
                                    class="text-red-400 hover:text-red-300 text-lg flex-shrink-0">
                                    Ã—
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            });

            updatePreview();
        }

        // æ›´æ–°æŠ€èƒ½æƒé‡ï¼ˆä¸å†æ‰‹åŠ¨ä¿®æ”¹ï¼Œç”±ç¨€æœ‰åº¦æƒé‡è‡ªåŠ¨è®¡ç®—ï¼‰
        window.updateSkillWeight = function(rarity, index, weight) {
            // æŠ€èƒ½æƒé‡ç°åœ¨æ˜¯åªè¯»çš„ï¼Œç”±ç¨€æœ‰åº¦æƒé‡è‡ªåŠ¨åˆ†é…
            // è¿™ä¸ªå‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹ï¼Œä½†ä¸åšä»»ä½•æ“ä½œ
        }

        // æ›´æ–°æŠ€èƒ½è§£é”ç­‰çº§
        window.updateSkillLevel = function(rarity, index, level) {
            if (configuredSkills[rarity] && configuredSkills[rarity][index]) {
                configuredSkills[rarity][index].unlockLevel = parseInt(level) || 1;
            }
        }

        // ç§»é™¤æŠ€èƒ½ï¼ˆç§»é™¤åé‡æ–°è®¡ç®—æƒé‡ï¼‰
        window.removeSkill = function(rarity, index) {
            if (configuredSkills[rarity]) {
                configuredSkills[rarity].splice(index, 1);
                
                // é‡æ–°è®¡ç®—è¯¥ç¨€æœ‰åº¦çš„æŠ€èƒ½æƒé‡
                const rarityWeight = rarityWeights[rarity] || 0;
                const skillCount = configuredSkills[rarity].length;
                if (skillCount > 0) {
                    const weightPerSkill = rarityWeight / skillCount;
                    configuredSkills[rarity].forEach(s => {
                        s.weight = parseFloat(weightPerSkill.toFixed(2));
                    });
                }
                
                renderConfiguredSkills();
            }
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const name = document.getElementById('pool-name').value;
            const icon = document.getElementById('pool-icon').value;
            const description = document.getElementById('pool-description').value;

            if (!name) {
                preview.innerHTML = `
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-2">â“</div>
                        <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                    </div>`;
                return;
            }

            // è®¡ç®—æ¯ä¸ªç¨€æœ‰åº¦çš„ç»Ÿè®¡ä¿¡æ¯
            const rarityStats = {
                common: { count: configuredSkills.common.length, weight: rarityWeights.common },
                rare: { count: configuredSkills.rare.length, weight: rarityWeights.rare },
                epic: { count: configuredSkills.epic.length, weight: rarityWeights.epic },
                legendary: { count: configuredSkills.legendary.length, weight: rarityWeights.legendary }
            };

            const totalSkills = rarityStats.common.count + rarityStats.rare.count + rarityStats.epic.count + rarityStats.legendary.count;
            const totalRarityWeight = rarityWeights.common + rarityWeights.rare + rarityWeights.epic + rarityWeights.legendary;

            const rarityLabels = {
                'common': 'âšªæ™®é€š',
                'rare': 'âœ¨ç¨€æœ‰',
                'epic': 'ğŸŒˆå²è¯—',
                'legendary': 'â­ä¼ è¯´'
            };

            preview.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="text-4xl">${icon || 'ğŸ²'}</div>
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-white mb-1">${name}</h4>
                            ${description ? `<p class="text-xs text-gray-400 italic">${description}</p>` : ''}
                        </div>
                    </div>
                    <div class="border-t border-gray-600 pt-2">
                        <div class="text-xs text-gray-400 mb-1">
                            æŠ€èƒ½æ€»æ•°: <span class="text-white">${totalSkills}</span>
                            <span class="ml-2">ç¨€æœ‰åº¦æƒé‡æ€»å’Œ: <span class="${totalRarityWeight === 100 ? 'text-green-400' : 'text-yellow-400'}">${totalRarityWeight.toFixed(1)}%</span></span>
                        </div>
                        ${totalSkills > 0 ? `
                            <div class="grid grid-cols-2 gap-1 text-xs mt-2">
                                ${Object.entries(rarityStats).map(([r, stat]) =>
                                    stat.count > 0 ? `
                                        <div class="bg-gray-800/50 rounded px-2 py-1">
                                            <span class="text-gray-400">${rarityLabels[r]}:</span>
                                            <span class="text-white">${stat.count}ä¸ª</span>
                                            <span class="text-purple-300">${stat.weight.toFixed(1)}%</span>
                                            ${stat.count > 0 ? `<span class="text-gray-500">(${(stat.weight / stat.count).toFixed(1)}%/ä¸ª)</span>` : ''}
                                        </div>
                                    ` : ''
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            // å°†å››åˆ—æŠ€èƒ½åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯ä¸ªæŠ€èƒ½ä¿ç•™ç¨€æœ‰åº¦ä¿¡æ¯
            const allSkills = [];
            Object.entries(configuredSkills).forEach(([rarity, skills]) => {
                skills.forEach(skill => {
                    allSkills.push({
                        ...skill,
                        rarity: rarity
                    });
                });
            });

            return {
                name: document.getElementById('pool-name').value,
                icon: document.getElementById('pool-icon').value,
                description: document.getElementById('pool-description').value,
                skills: allSkills,
                // ä¿å­˜ç¨€æœ‰åº¦æƒé‡
                rarityWeights: {...rarityWeights},
                // åŒæ—¶ä¿å­˜åˆ†ç±»ç»“æ„ï¼ˆä¾¿äºç¼–è¾‘ï¼‰
                skillsByRarity: {
                    common: configuredSkills.common.map(s => ({...s})),
                    rare: configuredSkills.rare.map(s => ({...s})),
                    epic: configuredSkills.epic.map(s => ({...s})),
                    legendary: configuredSkills.legendary.map(s => ({...s}))
                }
            };
        }

        // åˆ›å»ºæŠ€èƒ½æ± 
        function createSkillPool() {
            const data = getFormData();
            
            const totalSkills = configuredSkills.common.length + configuredSkills.rare.length +
                               configuredSkills.epic.length + configuredSkills.legendary.length;
            
            if (totalSkills === 0) {
                alert('âŒ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæŠ€èƒ½åˆ°æŠ€èƒ½æ± ï¼');
                return;
            }

            const poolKey = `SKILLPOOL_${Date.now()}`;
            const pool = {
                key: poolKey,
                ...data,
                createdAt: new Date().toISOString()
            };

            skillPools.push(pool);
            saveSkillPools();
            
            renderPoolsList();
            updatePoolCount();
            form.reset();
            configuredSkills = { common: [], rare: [], epic: [], legendary: [] };
            renderConfiguredSkills();
            updatePreview();
            
            const stats = `âšª${configuredSkills.common.length} âœ¨${configuredSkills.rare.length} ğŸŒˆ${configuredSkills.epic.length} â­${configuredSkills.legendary.length}`;
            alert(`âœ… æŠ€èƒ½æ±  "${data.name}" å·²åˆ›å»ºï¼\nåŒ…å« ${totalSkills} ä¸ªæŠ€èƒ½\n${stats}`);
        }

        // æ›´æ–°æŠ€èƒ½æ± 
        function updateSkillPool() {
            const data = getFormData();
            
            const totalSkills = configuredSkills.common.length + configuredSkills.rare.length +
                               configuredSkills.epic.length + configuredSkills.legendary.length;
            
            if (totalSkills === 0) {
                alert('âŒ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæŠ€èƒ½åˆ°æŠ€èƒ½æ± ï¼');
                return;
            }

            const pool = {
                key: skillPools[editingIndex].key,
                ...data,
                createdAt: skillPools[editingIndex].createdAt,
                updatedAt: new Date().toISOString()
            };

            skillPools[editingIndex] = pool;
            saveSkillPools();
            
            renderPoolsList();
            form.reset();
            configuredSkills = { common: [], rare: [], epic: [], legendary: [] };
            cancelEdit();
            renderConfiguredSkills();
            updatePreview();
            
            alert(`âœ… æŠ€èƒ½æ±  "${data.name}" å·²æ›´æ–°ï¼`);
        }

        // ç¼–è¾‘æŠ€èƒ½æ± 
        function editSkillPool(index) {
            editingIndex = index;
            const pool = skillPools[index];
            
            document.getElementById('pool-name').value = pool.name;
            document.getElementById('pool-icon').value = pool.icon;
            document.getElementById('pool-description').value = pool.description || '';
            
            // æ¢å¤ç¨€æœ‰åº¦æƒé‡
            if (pool.rarityWeights) {
                rarityWeights = {...pool.rarityWeights};
                document.getElementById('rarity-weight-common').value = rarityWeights.common;
                document.getElementById('rarity-weight-rare').value = rarityWeights.rare;
                document.getElementById('rarity-weight-epic').value = rarityWeights.epic;
                document.getElementById('rarity-weight-legendary').value = rarityWeights.legendary;
            }
            
            // æ¢å¤æŠ€èƒ½é…ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨åˆ†ç±»ç»“æ„ï¼‰
            if (pool.skillsByRarity) {
                configuredSkills = {
                    common: pool.skillsByRarity.common.map(s => ({...s})),
                    rare: pool.skillsByRarity.rare.map(s => ({...s})),
                    epic: pool.skillsByRarity.epic.map(s => ({...s})),
                    legendary: pool.skillsByRarity.legendary.map(s => ({...s}))
                };
            } else if (pool.skills) {
                // å…¼å®¹æ—§æ ¼å¼ï¼šæŒ‰ç¨€æœ‰åº¦åˆ†ç±»
                configuredSkills = { common: [], rare: [], epic: [], legendary: [] };
                pool.skills.forEach(skill => {
                    const rarity = skill.rarity || 'common';
                    if (configuredSkills[rarity]) {
                        configuredSkills[rarity].push({...skill});
                    }
                });
            }
            renderConfiguredSkills();
            
            document.getElementById('submit-text').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            document.getElementById('submit-btn').classList.remove('bg-purple-600', 'hover:bg-purple-700');
            document.getElementById('submit-btn').classList.add('bg-green-600', 'hover:bg-green-700');
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            updatePreview();
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingIndex = -1;
            document.getElementById('submit-text').textContent = 'âœ¨ åˆ›å»ºæŠ€èƒ½æ± ';
            document.getElementById('submit-btn').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('submit-btn').classList.add('bg-purple-600', 'hover:bg-purple-700');
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        // åˆ é™¤æŠ€èƒ½æ± 
        function deleteSkillPool(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ€èƒ½æ± å—ï¼Ÿ')) {
                skillPools.splice(index, 1);
                saveSkillPools();
                renderPoolsList();
                updatePoolCount();
            }
        }

        // ä¿å­˜æŠ€èƒ½æ± 
        function saveSkillPools() {
            localStorage.setItem('SKILL_POOLS', JSON.stringify(skillPools));
        }

        // æ¸²æŸ“æŠ€èƒ½æ± åˆ—è¡¨
        function renderPoolsList() {
            if (skillPools.length === 0) {
                poolsList.innerHTML = '<div class="text-center text-gray-500 text-sm py-8">æš‚æ— æŠ€èƒ½æ± </div>';
                return;
            }

            poolsList.innerHTML = skillPools.map((pool, index) => {
                const skills = pool.skills || [];
                
                // æŒ‰ç¨€æœ‰åº¦ç»Ÿè®¡
                const rarityStats = {
                    common: skills.filter(s => s.rarity === 'common').length,
                    rare: skills.filter(s => s.rarity === 'rare').length,
                    epic: skills.filter(s => s.rarity === 'epic').length,
                    legendary: skills.filter(s => s.rarity === 'legendary').length
                };

                const rarityLabels = {
                    'common': 'âšª',
                    'rare': 'âœ¨',
                    'epic': 'ğŸŒˆ',
                    'legendary': 'â­'
                };

                return `
                    <div class="pool-card bg-gray-800 rounded-lg p-3 border border-gray-600">
                        <div class="flex items-start gap-2">
                            <div class="text-2xl">${pool.icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <h5 class="text-sm font-bold text-white">${pool.name}</h5>
                                    <span class="bg-purple-600/30 text-purple-300 px-2 py-0.5 rounded text-xs">${skills.length}ä¸ªæŠ€èƒ½</span>
                                </div>
                                ${pool.description ? `<p class="text-xs text-gray-500 italic mb-1 line-clamp-1">${pool.description}</p>` : ''}
                                <div class="flex gap-1 text-xs">
                                    ${Object.entries(rarityStats).filter(([r, c]) => c > 0).map(([r, c]) =>
                                        `<span class="text-gray-400">${rarityLabels[r]}${c}</span>`
                                    ).join(' ')}
                                </div>
                            </div>
                            <div class="flex gap-1 flex-shrink-0">
                                <button onclick="editSkillPool(${index})"
                                    class="text-blue-400 hover:text-blue-300 text-lg px-2" title="ç¼–è¾‘">âœï¸</button>
                                <button onclick="deleteSkillPool(${index})"
                                    class="text-red-400 hover:text-red-300 text-xl" title="åˆ é™¤">Ã—</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // å¯¼å‡ºæŠ€èƒ½æ± ï¼ˆJSONï¼‰
        function exportSkillPools() {
            if (skillPools.length === 0) {
                alert('æŠ€èƒ½æ± ä¸ºç©ºï¼');
                return;
            }

            const dataStr = JSON.stringify(skillPools, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `skill_pools_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å‡ºæŠ€èƒ½æ± ï¼ˆCSVï¼‰
        function exportSkillPoolsToCSV() {
            if (skillPools.length === 0) {
                alert('æŠ€èƒ½æ± ä¸ºç©ºï¼');
                return;
            }

            const escapeCSV = (value) => {
                if (value === null || value === undefined) return '';
                const str = String(value);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            };

            // åŸºç¡€è¡¨å¤´
            const baseHeaders = [
                'æŠ€èƒ½æ± ID', 'æŠ€èƒ½æ± åç§°', 'å›¾æ ‡', 'æè¿°', 'æŠ€èƒ½æ•°é‡'
            ];

            // æŠ€èƒ½é…ç½®è¡¨å¤´ï¼ˆæœ€å¤š20ä¸ªæŠ€èƒ½ï¼‰
            const skillHeaders = [];
            for (let i = 1; i <= 20; i++) {
                skillHeaders.push(
                    `æŠ€èƒ½${i}_åç§°`,
                    `æŠ€èƒ½${i}_ç¨€æœ‰åº¦`,
                    `æŠ€èƒ½${i}_æƒé‡%`,
                    `æŠ€èƒ½${i}_è§£é”ç­‰çº§`
                );
            }

            const headers = [...baseHeaders, ...skillHeaders, 'åˆ›å»ºæ—¶é—´', 'æ›´æ–°æ—¶é—´', 'å¤‡æ³¨'];

            let csvContent = headers.join(',') + '\n';

            skillPools.forEach(pool => {
                const baseRow = [
                    escapeCSV(pool.key),
                    escapeCSV(pool.name),
                    escapeCSV(pool.icon),
                    escapeCSV(pool.description || ''),
                    escapeCSV(pool.skills.length)
                ];

                const skillRow = [];
                const skills = pool.skills || [];
                for (let i = 0; i < 20; i++) {
                    if (i < skills.length) {
                        const skillConfig = skills[i];
                        const skill = skillLibrary.find(s => s.key === skillConfig.skillKey);
                        skillRow.push(
                            escapeCSV(skill ? skill.name : skillConfig.skillKey),
                            escapeCSV(getRarityName(skillConfig.rarity)),
                            escapeCSV(skillConfig.weight || 0),
                            escapeCSV(skillConfig.unlockLevel || 1)
                        );
                    } else {
                        skillRow.push('', '', '', '');
                    }
                }

                const row = [...baseRow, ...skillRow,
                    escapeCSV(pool.createdAt ? new Date(pool.createdAt).toLocaleString('zh-CN') : ''),
                    escapeCSV(pool.updatedAt ? new Date(pool.updatedAt).toLocaleString('zh-CN') : ''),
                    ''
                ];

                csvContent += row.join(',') + '\n';
            });

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æŠ€èƒ½æ± é…ç½®è¡¨_${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`âœ… å·²å¯¼å‡º ${skillPools.length} ä¸ªæŠ€èƒ½æ± åˆ°ç­–åˆ’é…ç½®è¡¨ï¼ˆCSVæ ¼å¼ï¼‰ï¼\n\nè¡¨æ ¼ç‰¹ç‚¹ï¼š\nâ€¢ åŒ…å«æŠ€èƒ½ç¨€æœ‰åº¦å’Œæƒé‡é…ç½®\nâ€¢ æœ€å¤šæ”¯æŒ20ä¸ªæŠ€èƒ½\nâ€¢ ä¾¿äºExcelæ‰¹é‡ç¼–è¾‘`);
        }

        // å¯¼å…¥æŠ€èƒ½æ± 
        function importSkillPools(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedPools = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedPools)) {
                        alert('âŒ æ— æ•ˆçš„JSONæ ¼å¼ï¼');
                        return;
                    }

                    const existingKeys = new Set(skillPools.map(p => p.key));
                    const newPools = importedPools.filter(p => !existingKeys.has(p.key));
                    
                    skillPools = [...skillPools, ...newPools];
                    saveSkillPools();
                    
                    renderPoolsList();
                    updatePoolCount();
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${newPools.length} ä¸ªæ–°æŠ€èƒ½æ± ï¼`);
                } catch (error) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        }

        // è¾…åŠ©å‡½æ•°
        function getTypeName(type) {
            const names = {
                'attack': 'æ”»å‡»',
                'defense': 'é˜²å¾¡',
                'agility': 'æ•æ·',
                'buff': 'å¢ç›Š',
                'debuff': 'å‡ç›Š',
                'heal': 'æ²»ç–—'
            };
            return names[type] || type;
        }

        function getCategoryName(category) {
            if (!category) return '';
            const names = {
                'element-normal': 'æ™®é€š', 'element-water': 'æ°´ç³»', 'element-fire': 'ç«ç³»',
                'element-grass': 'è‰ç³»', 'element-wind': 'é£ç³»', 'element-metal': 'é‡‘ç³»',
                'element-earth': 'åœŸç³»', 'mutation-dark': 'é»‘åŒ–', 'mutation-light': 'ç™½åŒ–',
                'mutation-crystal': 'æ™¶åŒ–', 'mutation-shadow': 'å½±åŒ–', 'mutation-chaos': 'æš—èš€',
                'mutation-holy': 'åœ£è¾‰', 'mutation-psychic': 'å¼‚èƒ½', 'mutation-thunder': 'æç”µ',
                'mutation-eternal-dark': 'æ°¸å¤œ', 'mutation-eternal-light': 'æ°¸è€€',
                'mutation-source-crystal': 'æºæ™¶', 'mutation-thunder-lord': 'é›·ç…Œ'
            };
            return names[category] || 'æœªçŸ¥';
        }

        function getRarityName(rarity) {
            const names = {
                'common': 'æ™®é€š',
                'rare': 'ç¨€æœ‰',
                'epic': 'å²è¯—',
                'legendary': 'ä¼ è¯´'
            };
            return names[rarity] || 'æœªçŸ¥';
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>