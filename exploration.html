<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­ç›†æ ½ - æ¢ç´¢ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .control-panel {
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid #374151;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        .action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px #047857;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #047857;
        }
        .action-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #065f46;
        }
        .action-button:disabled {
            background-color: #374151;
            box-shadow: none;
            cursor: not-allowed;
            transform: none;
            color: #9ca3af;
        }
        .mission-card {
            transition: all 0.2s;
            border: 1px solid #374151;
        }
        .mission-card:hover {
            border-color: #60a5fa;
            background-color: rgba(31, 41, 55, 0.8);
        }
        .selected-animal {
            background-color: #1e3a8a !important;
            border: 2px solid #60a5fa;
        }
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- æ ‡é¢˜å’Œè¿”å› -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-purple-400">æ¢ç´¢ä¸­å¿ƒ</h1>
            <button id="btn-return" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                è¿”å›æ –æ¯åœ°
            </button>
        </div>

        <div class="flex flex-col md:flex-row gap-6 h-[calc(100vh-120px)]">
            <!-- å·¦ä¾§ï¼šæ¢ç´¢ä»»åŠ¡åˆ—è¡¨ -->
            <div class="flex-1 control-panel p-4 rounded-lg overflow-hidden flex flex-col">
                <div class="flex border-b border-gray-700 mb-4">
                    <button data-tab="missions" class="tab-button flex-1 text-sm py-2 text-center text-white border-b-2 border-cyan-500">å¸¸è§„æ¢ç´¢</button>
                    <button data-tab="bounties" class="tab-button flex-1 text-sm py-2 text-center text-gray-400 border-b-2 border-transparent">æ‚¬èµé€šç¼‰</button>
                </div>
                <div id="tab-content-missions" class="tab-content flex-1 overflow-hidden flex flex-col">
                    <h3 class="text-lg font-bold mb-2 text-cyan-400 flex justify-between">
                        <span>å¯é€‰ä»»åŠ¡</span>
                        <span class="text-sm font-normal text-gray-400 self-end" id="active-count">è¿›è¡Œä¸­: 0/3</span>
                    </h3>
                    <div id="mission-list" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
                </div>
                <div id="tab-content-bounties" class="tab-content hidden flex-1 overflow-y-auto space-y-3 pr-2">
                    <!-- é€šç¼‰ä»¤å°†é€šè¿‡ JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¯¦æƒ…ä¸é˜Ÿä¼é€‰æ‹© -->
            <div class="w-full md:w-96 control-panel p-4 rounded-lg flex flex-col">
                <div id="mission-detail-panel" class="hidden flex flex-col h-full">
                    <h3 id="detail-title" class="text-xl font-bold text-yellow-400 mb-2">ä»»åŠ¡è¯¦æƒ…</h3>
                    <p id="detail-desc" class="text-sm text-gray-400 mb-4 h-10">é€‰æ‹©ä¸€ä¸ªä»»åŠ¡ä»¥æŸ¥çœ‹è¯¦æƒ…ã€‚</p>
                    
                    <div class="bg-gray-800 p-3 rounded-lg mb-4 space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">â±ï¸ æ—¶é•¿:</span>
                            <span id="detail-duration" class="text-white font-mono"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">âš ï¸ è¦æ±‚:</span>
                            <span id="detail-req" class="text-red-300"></span>
                        </div>
                        <div>
                            <span class="text-gray-400 block mb-1">ğŸ é¢„è®¡å¥–åŠ±:</span>
                            <div id="detail-rewards" class="flex gap-2 flex-wrap"></div>
                        </div>
                    </div>

                    <h4 class="font-bold text-indigo-300 mb-2 flex justify-between">
                        <span>æ¢ç´¢é˜Ÿä¼</span>
                        <span id="team-power-display" class="text-sm font-normal text-gray-400"></span>
                    </h4>
                    <div id="team-slots" class="grid grid-cols-3 gap-2 mb-4">
                        <!-- é˜Ÿä¼æ§½ä½ -->
                    </div>

                    <div class="mt-auto">
                        <button id="btn-action-mission" class="action-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                            å¼€å§‹æ¢ç´¢
                        </button>
                        <p id="action-message" class="text-xs text-center mt-2 text-red-400 h-4"></p>
                    </div>
                </div>
                
                <div id="empty-detail-state" class="h-full flex items-center justify-center text-gray-500">
                    <p>ğŸ‘ˆ è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä»»åŠ¡</p>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ¨ç‰©é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="animal-selector-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-50 flex items-center justify-center">
        <div class="control-panel w-full max-w-md p-6 rounded-xl m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">é€‰æ‹©é˜Ÿå‘˜</h3>
                <button id="btn-close-selector" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="selector-list" class="max-h-96 overflow-y-auto space-y-2 pr-2">
                <!-- åŠ¨ç‰©åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <script>
        // --- é…ç½®æ•°æ® ---
        const MISSIONS = [
            { 
                id: 'forest_gathering', 
                name: 'è¿·é›¾æ£®æ—é‡‡é›†', 
                desc: 'åœ¨æ£®æ—è¾¹ç¼˜æ”¶é›†åŸºç¡€èµ„æºï¼Œé£é™©è¾ƒä½ã€‚',
                duration: 60, // ç§’
                rewards: { food: [30, 50], wood: [10, 20] },
                req: { minLevel: 1 },
                slots: 1
            },
            { 
                id: 'cave_mining', 
                name: 'æ·±é‚ƒçŸ¿æ´æŒ–æ˜', 
                desc: 'æ·±å…¥åœ°ä¸‹å¯»æ‰¾çŸ¿çŸ³ï¼Œéœ€è¦ä¸€å®šçš„ä½“åŠ›ã€‚',
                duration: 300, 
                rewards: { stone: [20, 40], gold: [5, 15] },
                req: { minStamina: 30 },
                slots: 2
            },
            { 
                id: 'ruins_adventure', 
                name: 'å¤ä»£é—è¿¹æ¢é™©', 
                desc: 'æ¢ç´¢å±é™©çš„å¤ä»£é—è¿¹ï¼Œå¯èƒ½å‘ç°çè´µå®è—ã€‚',
                duration: 600, 
                rewards: { gold: [50, 100], gems: [1, 3] },
                req: { minLevel: 5, minCombat: 20 },
                slots: 3
            },
            { 
                id: 'elemental_rift', 
                name: 'å…ƒç´ è£‚éš™', 
                desc: 'ä¸ç¨³å®šçš„å…ƒç´ ä½é¢ï¼Œåªæœ‰ç‰¹å®šå±æ€§çš„åŠ¨ç‰©èƒ½ç”Ÿå­˜ã€‚',
                duration: 1800, 
                rewards: { gems: [5, 10], food: [200, 300] },
                req: { element: 'ç«', minLevel: 10 },
                slots: 2
            }
        ];

        const BOUNTY_TEMPLATES = [
            {
                templateId: 'bounty_boar',
                name: 'æš´èºçš„é‡çŒªç‹',
                difficulty: 'ç®€å•',
                baseRewards: { gold: 200, food: 100 },
                reqCombat: 50,
                opponent: { name: 'æš´èºçš„é‡çŒªç‹', level: 8, element: 'åœŸ', stamina: 120, color: 0x8B4513, abilities: { combat: { attack: 25, defense: 15, agility: 10 } } }
            },
            {
                templateId: 'bounty_wolf',
                name: 'æš—å¤œå¹½ç‹¼',
                difficulty: 'æ™®é€š',
                baseRewards: { gold: 500, food: 200 },
                reqCombat: 100,
                opponent: { name: 'æš—å¤œå¹½ç‹¼', level: 15, element: 'æš—', stamina: 200, color: 0x4B0082, abilities: { combat: { attack: 40, defense: 20, agility: 30 } } }
            },
            {
                templateId: 'bounty_griffin',
                name: 'é£æš´ç‹®é¹«',
                difficulty: 'å›°éš¾',
                baseRewards: { gold: 1000, gems: 5 },
                reqCombat: 150,
                opponent: { name: 'é£æš´ç‹®é¹«', level: 25, element: 'é£', stamina: 300, color: 0x87CEEB, abilities: { combat: { attack: 60, defense: 30, agility: 50 } } }
            },
            {
                templateId: 'bounty_dragon',
                name: 'ç†”å²©å¹¼é¾™',
                difficulty: 'æéš¾',
                baseRewards: { gold: 2000, gems: 10 },
                reqCombat: 300,
                opponent: { name: 'ç†”å²©å¹¼é¾™', level: 40, element: 'ç«', stamina: 500, color: 0xFF4500, abilities: { combat: { attack: 100, defense: 60, agility: 40 } } }
            }
        ];

        const ELEMENT_ICONS = { 'æ°´': 'ğŸ’§', 'ç«': 'ğŸ”¥', 'åœŸ': 'ğŸŒ', 'é£': 'ğŸ’¨', 'é›·': 'âš¡ï¸', 'æœ¨': 'ğŸŒ³', 'å…‰': 'â˜€ï¸', 'æš—': 'ğŸŒ™' };

        // --- å…¨å±€çŠ¶æ€ ---
        let gameState = {};
        let selectedMissionId = null;
        let currentTeam = []; // å½“å‰é€‰ä¸­ä»»åŠ¡çš„ä¸´æ—¶é˜Ÿä¼ [animalId, null, ...]
        let activeTimerInterval = null;

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadGameState();
            processBountyReturn();
            switchTab('missions'); // é»˜è®¤æ˜¾ç¤ºå¸¸è§„ä»»åŠ¡
            setupEventListeners();
            startGlobalTimer();
        };

        function loadGameState() {
            const stateJSON = localStorage.getItem('gameState');
            if (stateJSON) {
                gameState = JSON.parse(stateJSON);
                gameState.activeExplorations = gameState.activeExplorations || [];
                gameState.completedBounties = gameState.completedBounties || [];
                // ç¡®ä¿ gems å­˜åœ¨
                if (typeof gameState.gems === 'undefined') gameState.gems = 0;

                // --- æ¯æ—¥é€šç¼‰åˆ·æ–°é€»è¾‘ ---
                const today = new Date().toDateString();
                if (gameState.lastBountyRefreshDate !== today) {
                    refreshDailyBounties(today);
                }
                // ç¡®ä¿ dailyBounties å­˜åœ¨
                if (!gameState.dailyBounties || gameState.dailyBounties.length === 0) {
                    refreshDailyBounties(today);
                }
            } else {
                alert("æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¿”å›ä¸»é¡µã€‚");
                window.location.href = 'game3d.html';
            }
        }

        function saveGameState() {
            localStorage.setItem('gameState', JSON.stringify(gameState));
        }

        function refreshDailyBounties(dateString) {
            gameState.dailyBounties = generateDailyBounties();
            gameState.lastBountyRefreshDate = dateString;
            gameState.completedBounties = []; // é‡ç½®å®ŒæˆçŠ¶æ€
            saveGameState();
        }

        function generateDailyBounties() {
            // éšæœºé€‰å– 2 ä¸ªä¸åŒçš„é€šç¼‰ç›®æ ‡
            const shuffled = [...BOUNTY_TEMPLATES].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 2).map(t => ({
                id: t.templateId,
                name: t.name,
                difficulty: t.difficulty,
                duration: 0,
                rewards: t.baseRewards,
                req: { minCombatPower: t.reqCombat },
                slots: 1,
                opponent: t.opponent
            }));
        }

        function setupEventListeners() {
            document.getElementById('btn-return').addEventListener('click', () => {
                saveGameState();
                window.location.href = 'game3d.html';
            });
            document.getElementById('btn-close-selector').addEventListener('click', () => {
                document.getElementById('animal-selector-modal').classList.add('hidden');
            });
            document.getElementById('btn-action-mission').addEventListener('click', handleMissionAction);
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('text-white', 'border-cyan-500');
                el.classList.add('text-gray-400', 'border-transparent');
            });

            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            const button = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
            button.classList.add('text-white', 'border-cyan-500');
            button.classList.remove('text-gray-400', 'border-transparent');

            if (tabName === 'missions') {
                renderMissionList();
            } else if (tabName === 'bounties') {
                renderBountyList();
            }
            // æ¸…ç©ºè¯¦æƒ…é¡µ
            selectedMissionId = null;
            document.getElementById('empty-detail-state').classList.remove('hidden');
            document.getElementById('mission-detail-panel').classList.add('hidden');
        }

        function processBountyReturn() {
            const result = localStorage.getItem('bountyBattleResult');
            const bountyId = localStorage.getItem('activeBountyId');

            if (result === 'won' && bountyId) {
                const bounty = gameState.dailyBounties.find(b => b.id === bountyId);
                if (bounty && !gameState.completedBounties.includes(bountyId)) {
                    gameState.completedBounties.push(bountyId);
                    // å‘æ”¾å¥–åŠ±
                    Object.keys(bounty.rewards).forEach(key => {
                        gameState[key] = (gameState[key] || 0) + bounty.rewards[key];
                    });
                    alert(`æ‚¬èµå®Œæˆï¼ä½ å‡»è´¥äº† ${bounty.name}ï¼Œè·å¾—äº†å¥–åŠ±ï¼`);
                    saveGameState();
                }
            }
            localStorage.removeItem('bountyBattleResult');
            localStorage.removeItem('activeBountyId');
        }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function renderMissionList() {
            const listEl = document.getElementById('mission-list');
            listEl.innerHTML = '';
            
            const activeCount = gameState.activeExplorations.filter(e => !e.completed).length;
            document.getElementById('active-count').textContent = `è¿›è¡Œä¸­: ${activeCount}/3`;

            MISSIONS.forEach(mission => {
                const activeMission = gameState.activeExplorations.find(e => e.missionId === mission.id);
                const isSelected = selectedMissionId === mission.id;
                
                const card = document.createElement('div');
                card.className = `mission-card p-3 rounded-lg cursor-pointer ${isSelected ? 'border-blue-500 bg-gray-800' : 'bg-gray-900 border-gray-700'}`;
                
                let statusHtml = '';
                if (activeMission) {
                    if (Date.now() >= activeMission.endTime) {
                        statusHtml = '<span class="text-green-400 font-bold text-sm">âœ… å¯é¢†å–</span>';
                    } else {
                        const timeLeft = Math.max(0, Math.ceil((activeMission.endTime - Date.now()) / 1000));
                        statusHtml = `<span class="text-yellow-400 font-mono text-sm">â³ ${formatTime(timeLeft)}</span>`;
                    }
                } else {
                    statusHtml = `<span class="text-gray-500 text-sm">${formatTime(mission.duration)}</span>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold ${isSelected ? 'text-white' : 'text-gray-300'}">${mission.name}</h4>
                        ${statusHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-1 truncate">${mission.desc}</div>
                `;
                
                card.addEventListener('click', () => selectMission(mission.id));
                listEl.appendChild(card);
            });
        }

        function renderBountyList() {
            const listEl = document.getElementById('tab-content-bounties');
            listEl.innerHTML = '';

            gameState.dailyBounties.forEach(bounty => {
                const isCompleted = gameState.completedBounties.includes(bounty.id);
                const isSelected = selectedMissionId === bounty.id;

                const card = document.createElement('div');
                card.className = `mission-card p-3 rounded-lg cursor-pointer ${isSelected ? 'border-blue-500 bg-gray-800' : 'bg-gray-900 border-gray-700'}`;

                let statusHtml = '';
                if (isCompleted) {
                    statusHtml = '<span class="text-green-400 font-bold text-sm">âœ… å·²å®Œæˆ</span>';
                } else {
                    statusHtml = `<span class="text-yellow-400 text-sm">${bounty.difficulty}</span>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="font-bold ${isSelected ? 'text-white' : 'text-gray-300'}">${bounty.name}</h4>
                        ${statusHtml}
                    </div>
                    <div class="text-xs text-gray-500 mt-1 truncate">è¦æ±‚æˆ˜æ–—åŠ›: ${bounty.req.minCombatPower}</div>
                `;
                card.addEventListener('click', () => selectBounty(bounty.id));
                listEl.appendChild(card);
            });
        }

        function selectMission(missionId) {
            selectedMissionId = missionId;
            const mission = MISSIONS.find(m => m.id === missionId);

            // UI åˆ‡æ¢
            document.getElementById('empty-detail-state').classList.add('hidden');
            document.getElementById('mission-detail-panel').classList.remove('hidden');
            renderMissionList(); // æ›´æ–°é€‰ä¸­é«˜äº®

            // å¡«å……è¯¦æƒ…
            document.getElementById('detail-title').textContent = mission.name;
            document.getElementById('detail-desc').textContent = mission.desc;
            document.getElementById('team-power-display').textContent = ''; // å¸¸è§„ä»»åŠ¡ä¸æ˜¾ç¤ºæˆ˜åŠ›
            document.getElementById('detail-duration').textContent = formatTime(mission.duration);
            
            // æ¸²æŸ“è¦æ±‚
            let reqText = [];
            if (mission.req.minLevel) reqText.push(`ç­‰çº§ â‰¥ ${mission.req.minLevel}`);
            if (mission.req.minStamina) reqText.push(`ä½“åŠ› â‰¥ ${mission.req.minStamina}`);
            if (mission.req.minCombat) reqText.push(`æ”»å‡» â‰¥ ${mission.req.minCombat}`);
            if (mission.req.element) reqText.push(`å±æ€§: ${mission.req.element}`);
            document.getElementById('detail-req').textContent = reqText.join(', ') || 'æ— ç‰¹æ®Šè¦æ±‚';

            // æ¸²æŸ“å¥–åŠ±é¢„è§ˆ
            const rewardsContainer = document.getElementById('detail-rewards');
            rewardsContainer.innerHTML = '';
            for (const [key, val] of Object.entries(mission.rewards)) {
                const badge = document.createElement('span');
                badge.className = 'px-2 py-1 bg-gray-700 rounded text-xs text-gray-300';
                const iconMap = { food: 'ğŸ', wood: 'ğŸªµ', stone: 'ğŸª¨', gold: 'ğŸ’°', gems: 'ğŸ’' };
                badge.textContent = `${iconMap[key] || key} ${val[0]}-${val[1]}`;
                rewardsContainer.appendChild(badge);
            }

            // æ¸²æŸ“é˜Ÿä¼æ§½ä½
            const slotsContainer = document.getElementById('team-slots');
            slotsContainer.innerHTML = '';
            const activeMission = gameState.activeExplorations.find(e => e.missionId === missionId);
            
            // å¦‚æœä»»åŠ¡æ­£åœ¨è¿›è¡Œæˆ–å·²å®Œæˆï¼Œæ˜¾ç¤ºå®é™…é˜Ÿä¼
            if (activeMission) {
                currentTeam = activeMission.animalIds;
            } else if (currentTeam.length !== mission.slots) {
                // é‡ç½®é€‰æ‹©
                currentTeam = new Array(mission.slots).fill(null);
            }

            for (let i = 0; i < mission.slots; i++) {
                const slot = document.createElement('div');
                const animalId = currentTeam[i];
                const animal = animalId ? gameState.animals.find(a => a.id === animalId) : null;

                slot.className = `h-20 border-2 border-dashed rounded-lg flex flex-col items-center justify-center cursor-pointer transition-colors ${animal ? 'border-indigo-500 bg-indigo-900/30' : 'border-gray-600 hover:border-gray-400 hover:bg-gray-800'}`;
                
                if (animal) {
                    const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                    slot.innerHTML = `
                        <div style="background-color: ${colorHex};" class="w-6 h-6 rounded-full border border-gray-300 mb-1"></div>
                        <span class="text-xs font-bold text-white truncate w-full text-center px-1">${animal.name}</span>
                        <span class="text-[10px] text-yellow-300">Lv.${animal.level}</span>
                    `;
                    // å¦‚æœä»»åŠ¡æœªå¼€å§‹ï¼Œç‚¹å‡»å¯ç§»é™¤
                    if (!activeMission) {
                        slot.onclick = () => { currentTeam[i] = null; selectMission(missionId); };
                    }
                } else {
                    slot.innerHTML = `<span class="text-2xl text-gray-500">+</span><span class="text-xs text-gray-500">é€‰æ‹©é˜Ÿå‘˜</span>`;
                    if (!activeMission) {
                        slot.onclick = () => openAnimalSelector(i, mission);
                    }
                }
                slotsContainer.appendChild(slot);
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('btn-action-mission');
            const msg = document.getElementById('action-message');
            msg.textContent = '';

            if (activeMission) {
                if (Date.now() >= activeMission.endTime) {
                    btn.textContent = 'é¢†å–å¥–åŠ±';
                    btn.className = 'action-button w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg';
                    btn.disabled = false;
                } else {
                    btn.textContent = 'æ¢ç´¢è¿›è¡Œä¸­...';
                    btn.className = 'action-button w-full bg-gray-600 text-gray-300 font-bold py-3 px-4 rounded-lg cursor-not-allowed';
                    btn.disabled = true;
                }
            } else {
                btn.textContent = 'å¼€å§‹æ¢ç´¢';
                btn.className = 'action-button w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg';
                btn.disabled = false;
            }
        }

        function selectBounty(bountyId) {
            selectedMissionId = bountyId;
            const bounty = gameState.dailyBounties.find(b => b.id === bountyId);

            // UI åˆ‡æ¢
            document.getElementById('empty-detail-state').classList.add('hidden');
            document.getElementById('mission-detail-panel').classList.remove('hidden');
            renderBountyList(); // æ›´æ–°é€‰ä¸­é«˜äº®

            // å¡«å……è¯¦æƒ…
            document.getElementById('detail-title').textContent = bounty.name;
            document.getElementById('detail-desc').textContent = `å‡»è´¥ ${bounty.name} ä»¥è·å¾—æ‚¬èµå¥–åŠ±ã€‚`;
            document.getElementById('team-power-display').textContent = `æ¨èæˆ˜åŠ›: ${bounty.req.minCombatPower}`;
            document.getElementById('detail-duration').textContent = "å³æ—¶æˆ˜æ–—";
            document.getElementById('detail-req').textContent = `æˆ˜åŠ› â‰¥ ${bounty.req.minCombatPower}`;

            // æ¸²æŸ“å¥–åŠ±é¢„è§ˆ
            const rewardsContainer = document.getElementById('detail-rewards');
            rewardsContainer.innerHTML = '';
            for (const [key, val] of Object.entries(bounty.rewards)) {
                const badge = document.createElement('span');
                badge.className = 'px-2 py-1 bg-gray-700 rounded text-xs text-gray-300';
                const iconMap = { food: 'ğŸ', wood: 'ğŸªµ', stone: 'ğŸª¨', gold: 'ğŸ’°', gems: 'ğŸ’' };
                badge.textContent = `${iconMap[key] || key} ${val}`;
                rewardsContainer.appendChild(badge);
            }

            // æ¸²æŸ“é˜Ÿä¼æ§½ä½ (é€šç¼‰ä»»åŠ¡é€šå¸¸åªæœ‰1ä¸ªæ§½ä½)
            const slotsContainer = document.getElementById('team-slots');
            slotsContainer.innerHTML = '';
            
            if (currentTeam.length !== bounty.slots) {
                currentTeam = new Array(bounty.slots).fill(null);
            }

            for (let i = 0; i < bounty.slots; i++) {
                const slot = document.createElement('div');
                const animalId = currentTeam[i];
                const animal = animalId ? gameState.animals.find(a => a.id === animalId) : null;

                slot.className = `h-20 border-2 border-dashed rounded-lg flex flex-col items-center justify-center cursor-pointer transition-colors ${animal ? 'border-indigo-500 bg-indigo-900/30' : 'border-gray-600 hover:border-gray-400 hover:bg-gray-800'}`;
                
                if (animal) {
                    const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                    slot.innerHTML = `
                        <div style="background-color: ${colorHex};" class="w-6 h-6 rounded-full border border-gray-300 mb-1"></div>
                        <span class="text-xs font-bold text-white truncate w-full text-center px-1">${animal.name}</span>
                        <span class="text-[10px] text-yellow-300">Lv.${animal.level}</span>
                    `;
                    slot.onclick = () => { currentTeam[i] = null; selectBounty(bountyId); };
                } else {
                    slot.innerHTML = `<span class="text-2xl text-gray-500">+</span><span class="text-xs text-gray-500">é€‰æ‹©é˜Ÿå‘˜</span>`;
                    slot.onclick = () => openAnimalSelector(i, bounty);
                }
                slotsContainer.appendChild(slot);
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('btn-action-mission');
            const isCompleted = gameState.completedBounties.includes(bounty.id);
            const msg = document.getElementById('action-message');
            msg.textContent = '';

            if (isCompleted) {
                btn.textContent = 'å·²å®Œæˆ';
                btn.className = 'action-button w-full bg-gray-600 text-gray-300 font-bold py-3 px-4 rounded-lg cursor-not-allowed';
                btn.disabled = true;
            } else {
                btn.textContent = 'å¼€å§‹è®¨ä¼';
                btn.className = 'action-button w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg';
                btn.disabled = false;
            }
        }

        function openAnimalSelector(slotIndex, mission) {
            const modal = document.getElementById('animal-selector-modal');
            const list = document.getElementById('selector-list');
            list.innerHTML = '';
            modal.classList.remove('hidden');

            // ç­›é€‰å¯ç”¨åŠ¨ç‰©ï¼šæœªå¿™ç¢Œã€æœªå—ä¼¤ã€æœªåœ¨å½“å‰é˜Ÿä¼ä¸­
            const isBounty = gameState.dailyBounties.some(b => b.id === mission.id);
            const availableAnimals = gameState.animals.filter(a => {
                const isBusy = a.workingBuildingId || a.exploringMissionId || a.isPlaced; // For both, animal must be idle and at home
                const isInjured = a.isInjured;
                const isInTeam = currentTeam.includes(a.id);
                return !isBusy && !isInjured && !isInTeam;
            });


            if (availableAnimals.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç©ºé—²åŠ¨ç‰©ã€‚<br>è¯·æ£€æŸ¥åŠ¨ç‰©æ˜¯å¦åœ¨å·¥ä½œã€å—ä¼¤æˆ–å·²æ”¾ç½®ã€‚</p>';
                return;
            }

            availableAnimals.forEach(animal => {
                // æ£€æŸ¥æ˜¯å¦æ»¡è¶³ä»»åŠ¡ç¡¬æ€§è¦æ±‚
                let meetsReq = true;
                let failReason = '';
                if (!isBounty) { // Individual requirements only for regular missions
                    if (mission.req.minLevel && animal.level < mission.req.minLevel) { meetsReq = false; failReason = `ç­‰çº§<${mission.req.minLevel}`; }
                    if (mission.req.minStamina && animal.stamina < mission.req.minStamina) { meetsReq = false; failReason = `ä½“åŠ›<${mission.req.minStamina}`; }
                    if (mission.req.element && animal.element !== mission.req.element) { meetsReq = false; failReason = `é${mission.req.element}ç³»`; }
                    if (mission.req.minCombat && animal.abilities.combat.attack < mission.req.minCombat) { meetsReq = false; failReason = `æ”»å‡»ä¸è¶³`; }
                }

                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded border ${meetsReq ? 'border-gray-600 hover:bg-gray-700 cursor-pointer' : 'border-red-900 bg-red-900/20 opacity-60'}`;
                
                const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div style="background-color: ${colorHex};" class="w-8 h-8 rounded-full border border-gray-400"></div>
                        <div>
                            <div class="font-bold text-sm text-indigo-200">${animal.name} <span class="text-yellow-500 text-xs">Lv.${animal.level}</span></div>
                            <div class="text-xs text-gray-400">ä½“åŠ›: ${Math.floor(animal.stamina)} | æˆ˜åŠ›: ${animal.abilities.combat.attack} | ${ELEMENT_ICONS[animal.element] || animal.element}</div>
                        </div>
                    </div>
                    <div class="text-xs text-right">
                        ${meetsReq ? '<span class="text-green-400">å¯é€‰</span>' : `<span class="text-red-400">${failReason}</span>`}
                    </div>
                `;

                if (meetsReq) {
                    item.onclick = () => {
                        currentTeam[slotIndex] = animal.id;
                        modal.classList.add('hidden');
                        if (isBounty) {
                            selectBounty(mission.id);
                        } else {
                            selectMission(mission.id);
                        }
                    };
                }
                list.appendChild(item);
            });
        }

        function handleMissionAction() {
            const activeMission = gameState.activeExplorations.find(e => e.missionId === selectedMissionId);

            if (activeMission) {
                const mission = MISSIONS.find(m => m.id === selectedMissionId);
                if (Date.now() >= activeMission.endTime) {
                    claimRewards(activeMission, mission);
                }
                return;
            }

            // If not an active mission, it's either a new regular mission or a bounty
            const bounty = gameState.dailyBounties.find(b => b.id === selectedMissionId);
            if (bounty) {
                startBountyHunt(bounty);
                return;
            }

            const mission = MISSIONS.find(m => m.id === selectedMissionId);
            if (mission) {
                startMission(mission);
                return;
            }
        }

        function startMission(mission) {
            // éªŒè¯é˜Ÿä¼
            if (currentTeam.some(id => id === null)) {
                document.getElementById('action-message').textContent = 'âŒ é˜Ÿä¼äººæ•°ä¸è¶³';
                return;
            }
            
            // æ‰£é™¤ä½“åŠ›å¹¶æ ‡è®°çŠ¶æ€
            const animals = currentTeam.map(id => gameState.animals.find(a => a.id === id));
            const staminaCost = mission.req.minStamina || 10; // é»˜è®¤æ¶ˆè€—10ä½“åŠ›

            // å†æ¬¡æ£€æŸ¥ä½“åŠ›ï¼ˆé˜²æ­¢è¾¹ç•Œæƒ…å†µï¼‰
            for (let animal of animals) {
                if (animal.stamina < staminaCost) {
                    document.getElementById('action-message').textContent = `âŒ ${animal.name} ä½“åŠ›ä¸è¶³`;
                    return;
                }
            }

            // æ‰§è¡Œå¼€å§‹
            animals.forEach(animal => {
                animal.stamina -= staminaCost;
                animal.exploringMissionId = mission.id;
            });

            const newExploration = {
                missionId: mission.id,
                startTime: Date.now(),
                endTime: Date.now() + mission.duration * 1000,
                animalIds: [...currentTeam],
                completed: false
            };

            gameState.activeExplorations.push(newExploration);
            saveGameState();
            selectMission(mission.id); // åˆ·æ–°
        }

        function startBountyHunt(bounty) {
            const animalId = currentTeam[0];
            if (!animalId) {
                document.getElementById('action-message').textContent = 'âŒ è¯·é€‰æ‹©å‡ºæˆ˜åŠ¨ç‰©';
                return;
            }
            const animal = gameState.animals.find(a => a.id === animalId);
            
            // æ£€æŸ¥æˆ˜åŠ›
            if (animal.abilities.combat.attack < bounty.req.minCombatPower) {
                 if (!confirm(`âš ï¸ è­¦å‘Šï¼š${animal.name} çš„æ”»å‡»åŠ›ä½äºæ¨èå€¼ (${bounty.req.minCombatPower})ï¼Œå¯èƒ½ä¼šå¤±è´¥ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
                     return;
                 }
            }

            // å‡†å¤‡æˆ˜æ–—æ•°æ® (ç§»é™¤ mesh)
            const serializableAnimal = { ...animal };
            delete serializableAnimal.mesh;
            
            localStorage.setItem('battlePlayerAnimal', JSON.stringify(serializableAnimal));
            localStorage.setItem('battleOpponent', JSON.stringify(bounty.opponent));
            localStorage.setItem('activeBountyId', bounty.id);
            localStorage.setItem('battleReturnUrl', 'exploration.html');
            
            saveGameState();
            window.location.href = 'battle.html';
        }

        function claimRewards(activeMission, mission) {
            // è®¡ç®—å¥–åŠ±
            let rewardMsg = [];
            for (const [key, range] of Object.entries(mission.rewards)) {
                const amount = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
                gameState[key] = (gameState[key] || 0) + amount;
                const iconMap = { food: 'ğŸ', wood: 'ğŸªµ', stone: 'ğŸª¨', gold: 'ğŸ’°', gems: 'ğŸ’' };
                rewardMsg.push(`${iconMap[key] || key} +${amount}`);
            }

            // å¢åŠ åŠ¨ç‰©ç»éªŒ
            const expGain = mission.duration * 0.5; // ç»éªŒå…¬å¼
            activeMission.animalIds.forEach(id => {
                const animal = gameState.animals.find(a => a.id === id);
                if (animal) {
                    animal.experience += expGain;
                    animal.exploringMissionId = null; // è§£é™¤çŠ¶æ€
                    // ç®€å•çš„å‡çº§æ£€æŸ¥ (å®Œæ•´é€»è¾‘åœ¨ game3d ä¸­ï¼Œè¿™é‡Œåšç®€åŒ–å¤„ç†æˆ–ä»…åŠ ç»éªŒ)
                    if (animal.experience >= animal.experienceToNextLevel) {
                        // ç•™ç»™ game3d å¤„ç†å‡çº§ï¼Œæˆ–è€…ç®€å•å¤„ç†
                        animal.level++;
                        animal.experience -= animal.experienceToNextLevel;
                        animal.experienceToNextLevel = Math.floor(animal.experienceToNextLevel * 1.5);
                    }
                }
            });

            // ç§»é™¤ä»»åŠ¡
            gameState.activeExplorations = gameState.activeExplorations.filter(e => e !== activeMission);
            saveGameState();
            
            alert(`æ¢ç´¢å®Œæˆï¼è·å¾—: ${rewardMsg.join(', ')}`);
            currentTeam = new Array(mission.slots).fill(null); // é‡ç½®é˜Ÿä¼é€‰æ‹©
            selectMission(mission.id); // åˆ·æ–°
        }

        function formatTime(seconds) {
            if (seconds < 60) return `${seconds}ç§’`;
            const mins = Math.floor(seconds / 60);
            if (mins < 60) return `${mins}åˆ†é’Ÿ`;
            const hours = Math.floor(mins / 60);
            return `${hours}å°æ—¶${mins % 60}åˆ†`;
        }

        function startGlobalTimer() {
            if (activeTimerInterval) clearInterval(activeTimerInterval);
            activeTimerInterval = setInterval(() => {
                renderMissionList(); // æ›´æ–°åˆ—è¡¨å€’è®¡æ—¶
                if (selectedMissionId) {
                    // å¦‚æœå½“å‰é€‰ä¸­çš„ä»»åŠ¡æ­£åœ¨è¿›è¡Œï¼Œåˆ·æ–°æŒ‰é’®çŠ¶æ€
                    const active = gameState.activeExplorations.find(e => e.missionId === selectedMissionId);
                    if (active && Date.now() >= active.endTime) {
                        selectMission(selectedMissionId); // è§¦å‘åˆ·æ–°ä»¥æ˜¾ç¤ºâ€œé¢†å–â€
                    }
                }
            }, 1000);
        }

    </script>
</body>
</html>
