<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­ç›†æ ½ - åŠ¨ç‰©ç®¡ç†ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #111827;
            color: #f3f4f6;
            font-family: 'Inter', sans-serif;
        }
        .control-panel {
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(5px);
            border: 1px solid #374151;
            /* Needed for progress bar positioning */
            position: relative;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
        }
        
        /* ç¡®ä¿å³ä¾§è¯¦æƒ…é¢æ¿ä¸è£å‰ªæ‚¬æµ®æç¤º */
        #animal-details {
            overflow: visible !important;
        }
        
        /* æŠ€èƒ½æ‚¬æµ®æç¤ºæ¡†æ ·å¼ */
        .skill-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: rgba(17, 24, 39, 1);
            border: 2px solid rgba(139, 92, 246, 0.8);
            border-radius: 8px;
            padding: 12px;
            min-width: 280px;
            max-width: 350px;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            white-space: normal;
        }
        
        .skill-slot-wrapper {
            position: relative;
        }
        
        .skill-slot-wrapper:hover .skill-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
            pointer-events: auto;
        }
        
        .skill-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(139, 92, 246, 0.6);
        }
        
        .skill-item-wrapper {
            position: relative;
            overflow: visible;
        }
        
        /* å¯ç”¨æŠ€èƒ½åˆ—è¡¨çš„æ‚¬æµ®æç¤ºæ˜¾ç¤ºåœ¨å³ä¾§ */
        .skill-item-wrapper .skill-tooltip {
            bottom: auto;
            top: 0;
            left: calc(100% + 8px);
            right: auto;
            transform: none;
            min-width: 300px;
            max-width: 350px;
            z-index: 10000;
            background: rgba(17, 24, 39, 1);
        }
        
        .skill-item-wrapper:hover .skill-tooltip {
            opacity: 1 !important;
            transform: none;
            pointer-events: auto;
            display: block !important;
        }
        
        .skill-item-wrapper .skill-tooltip::after {
            content: '';
            position: absolute;
            top: 24px;
            left: -12px;
            transform: none;
            border: 6px solid transparent;
            border-right-color: rgba(139, 92, 246, 0.8);
        }
        
        /* ç¡®ä¿æ‰€æœ‰ç›¸å…³å®¹å™¨ä¸è£å‰ªæç¤ºæ¡† */
        #available-skills-list {
            overflow-y: auto !important;
            overflow-x: visible !important;
            position: relative !important;
        }
        
        #mutation-skills-in-abilities {
            overflow: visible !important;
            position: relative !important;
        }
        
        #panel-abilities {
            overflow: visible !important;
        }
        
        #animal-detail-content {
            overflow: visible !important;
        }
        
        .bg-gray-800.rounded-lg.p-3.space-y-3 {
            overflow: visible !important;
        }
        
        /* å¼ºåˆ¶æ˜¾ç¤ºæŠ€èƒ½é¡¹åŒ…è£…å™¨ */
        .skill-item-wrapper {
            position: relative !important;
            overflow: visible !important;
        }
        
        .tooltip-header {
            text-align: center;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
            padding-bottom: 8px;
            margin-bottom: 8px;
        }
        
        .tooltip-param {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.75rem;
        }
        
        .tooltip-param-label {
            color: #9ca3af;
        }
        
        .tooltip-param-value {
            color: #a78bfa;
            font-weight: 600;
        }
        .action-button {
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px #047857;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #047857;
        }
        .action-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #065f46;
        }
        .clear-button {
             box-shadow: 0 4px #475569;
             background-color: #4b5563;
        }
        .clear-button:hover {
            box-shadow: 0 6px #475569;
             background-color: #6b7280;
        }
        .clear-button:active {
            box-shadow: 0 2px #374151;
             background-color: #374151;
        }
        .selected-for-breeding {
            background-color: #1e3a8a !important;
            border: 2px solid #60a5fa;
        }
        .roster-item.selected-detail {
            background-color: #4338ca !important; /* Indigo 700 */
            border: 2px solid #818cf8; /* Indigo 400 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- é¡µé¢æ ‡é¢˜å’Œè¿”å›æŒ‰é’® -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-cyan-400">åŠ¨ç‰©ç®¡ç†ä¸­å¿ƒ</h1>
            <button id="btn-save-and-return" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">
                ä¿å­˜å¹¶è¿”å›æ –æ¯åœ°
            </button>
        </div>

        <!-- ä¸»å®¹å™¨ -->
        <div id="main-container" class="flex flex-col md:flex-row gap-6" style="overflow: visible;">
            <!-- å·¦ä¾§ä¸»èœå• -->
            <div id="animal-system-main-menu" class="control-panel p-4 rounded-lg text-white w-full md:w-72">
                <h3 class="text-xl font-bold mb-4 text-cyan-400 border-b border-gray-700 pb-2">
                    åŠŸèƒ½èœå•
                </h3>
                <div class="flex flex-col space-y-3">
                    <button id="btn-open-cultivation-from-menu" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                        ğŸ“– åŠ¨ç‰©å…»æˆ
                    </button>
                    <button id="btn-open-breeding-panel" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                        ğŸ¥š åŠ¨ç‰©ç¹æ®–
                    </button>
                    <button id="btn-open-fusion-panel" class="action-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                        ğŸ§¬ åŠ¨ç‰©èåˆ
                    </button>
                    <button id="btn-open-mutation-panel" class="action-button bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-4 rounded-lg text-center">
                        â˜£ï¸ åŠ¨ç‰©å˜å¼‚
                    </button>
                </div>
                <!-- æ–°å¢ï¼šèµ„æºæ˜¾ç¤ºé¢æ¿ -->
                <div id="resource-panel" class="mt-6 pt-4 border-t border-gray-700">
                     <h3 class="text-lg font-bold mb-3 text-green-400">
                        å…»æˆèµ„æº
                    </h3>
                    <div id="stat-food" class="text-sm mb-2">ğŸ é£Ÿç‰©: <span class="font-mono text-yellow-300">0</span></div>
                    <div id="stat-gems" class="text-sm mb-2">ğŸ’ å®çŸ³: <span class="font-mono text-pink-400">0</span></div>
                    <div id="stat-animal-count" class="text-sm mb-2">ğŸ¾ åŠ¨ç‰©æ•°é‡: <span class="font-mono text-indigo-300">0 / 0</span></div>
                </div>
                 <div id="status-message" class="text-xs mt-4 h-8 text-gray-400 text-center"></div>
                 <!-- æ–°å¢ï¼šé‡ç½®æ¸¸æˆæŒ‰é’® -->
                 <div class="mt-6 pt-4 border-t border-gray-700">
                     <button id="btn-reset-game" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg text-center text-sm transition-colors">
                        âš ï¸ å¼ºåˆ¶é‡ç½®æ¸¸æˆ
                    </button>
                </div>
            </div>

            <!-- å³ä¾§å†…å®¹é¢æ¿ -->
            <div id="content-panels" class="flex-1">
                <!-- åŠ¨ç‰©å…»æˆé¢æ¿ -->
                <div id="animal-cultivation-panel" class="control-panel p-4 rounded-lg text-white hidden h-full">
                    <h3 class="text-xl font-bold mb-3 text-cyan-400 border-b border-gray-700 pb-2">åŠ¨ç‰©å…»æˆ</h3>
                    <div id="animal-list" class="w-full space-y-2 max-h-[calc(100vh-200px)] overflow-y-auto pr-2"></div>
                </div>

                <!-- åŠ¨ç‰©ç¹æ®–é¢æ¿ -->
                <div id="animal-breeding-panel" class="control-panel p-4 rounded-lg text-white hidden h-full">
                    <h3 class="text-xl font-bold mb-3 text-green-400 border-b border-gray-700 pb-2">åŠ¨ç‰©ç¹æ®–</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div id="parent-display-1" class="h-24 flex items-center justify-center text-center text-gray-500 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-800 hover:border-gray-500">
                            ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©çˆ¶ä»£ 1
                        </div>
                        <div id="parent-display-2" class="h-24 flex items-center justify-center text-center text-gray-500 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-800 hover:border-gray-500">
                            ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©çˆ¶ä»£ 2
                        </div>
                    </div>
                    <div class="flex space-x-2 mb-3">
                        <button id="btn-execute-breed" class="action-button flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-center text-sm" disabled>é€‰æ‹©çˆ¶æ¯</button>
                        <button id="btn-clear-breed-selection" class="action-button flex-1 clear-button hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-center text-sm">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                    <div>
                        <h4 class="text-md font-semibold mb-2 text-cyan-300">å¯é€‰åŠ¨ç‰©åˆ—è¡¨</h4>
                        <div id="breeding-animal-list" class="space-y-2 max-h-[calc(100vh-400px)] overflow-y-auto"></div>
                    </div>
                    <!-- Breeding Progress Overlay -->
                    <div id="breeding-progress-container" class="hidden absolute inset-0 bg-gray-900 bg-opacity-80 flex flex-col items-center justify-center rounded-lg">
                        <p id="breeding-progress-text" class="text-lg text-white mb-2">æ­£åœ¨ç¹æ®–...</p>
                        <div class="w-3/4 bg-gray-600 rounded-full h-4">
                            <div id="breeding-progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500 ease-linear" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- åŠ¨ç‰©èåˆé¢æ¿ -->
                <div id="animal-fusion-panel" class="control-panel p-4 rounded-lg text-white hidden h-full">
                    <h3 class="text-xl font-bold mb-3 text-purple-400 border-b border-gray-700 pb-2">åŠ¨ç‰©èåˆ (æ¶ˆè€—çˆ¶æ¯)</h3>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div id="fusion-material-display-1" class="h-24 flex items-center justify-center text-center text-gray-500 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-800 hover:border-gray-500">
                            ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©ææ–™ 1
                        </div>
                        <div id="fusion-material-display-2" class="h-24 flex items-center justify-center text-center text-gray-500 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:bg-gray-800 hover:border-gray-500">
                            ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©ææ–™ 2
                        </div>
                    </div>
                    <div class="flex space-x-2 mb-3">
                        <button id="btn-execute-fusion" class="action-button flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-center text-sm" disabled>é€‰æ‹©ææ–™</button>
                        <button id="btn-clear-fusion-selection" class="action-button flex-1 clear-button hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-center text-sm">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                    <div>
                        <h4 class="text-md font-semibold mb-2 text-cyan-300">å¯é€‰ææ–™åˆ—è¡¨</h4>
                        <div id="fusion-animal-list" class="space-y-2 max-h-[calc(100vh-400px)] overflow-y-auto"></div>
                    </div>
                    <!-- Fusion Progress Overlay -->
                    <div id="fusion-progress-container" class="hidden absolute inset-0 bg-gray-900 bg-opacity-80 flex flex-col items-center justify-center rounded-lg">
                        <p id="fusion-progress-text" class="text-lg text-white mb-2">æ­£åœ¨èåˆ...</p>
                        <div class="w-3/4 bg-gray-600 rounded-full h-4">
                            <div id="fusion-progress-bar" class="bg-purple-500 h-4 rounded-full transition-all duration-500 ease-linear" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- åŠ¨ç‰©å˜å¼‚é¢æ¿ - ä¼˜åŒ–ç‰ˆ -->
                <div id="animal-mutation-panel" class="control-panel p-6 rounded-lg text-white hidden h-full">
                    <!-- æ ‡é¢˜æ  -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">
                                ğŸ§¬ åŠ¨ç‰©å˜å¼‚å®éªŒå®¤
                            </h3>
                            <div class="flex gap-2">
                                <button id="btn-mutation-tier1" class="px-4 py-2 rounded-lg font-semibold transition-all bg-gradient-to-r from-pink-600 to-pink-500 text-white shadow-lg hover:shadow-pink-500/50">
                                    ä¸€çº§å˜å¼‚
                                </button>
                                <button id="btn-mutation-tier2" class="px-4 py-2 rounded-lg font-semibold transition-all bg-gray-700 text-gray-300 hover:bg-gray-600">
                                    äºŒçº§å˜å¼‚
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-400">âš ï¸ éœ€è¦ç­‰çº§ > 10 çš„åŠ¨ç‰©æ‰èƒ½è¿›è¡Œå˜å¼‚</p>
                    </div>
                    
                    <!-- ä¸€çº§å˜å¼‚å†…å®¹ -->
                    <div id="mutation-tier1-content" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- å·¦ä¾§ï¼šåŠ¨ç‰©åˆ—è¡¨ -->
                        <div class="lg:col-span-1 bg-gray-800/50 rounded-lg p-4">
                            <h4 class="text-sm font-bold mb-3 text-pink-400 flex items-center gap-2">
                                <span>ğŸ¾</span>
                                <span>å¯å˜å¼‚åŠ¨ç‰©</span>
                            </h4>
                            <div id="mutation-animal-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šå˜å¼‚æ“ä½œåŒº -->
                        <div class="lg:col-span-2 flex flex-col gap-4">
                            <!-- é€‰ä¸­çš„åŠ¨ç‰©æ˜¾ç¤º -->
                            <div class="bg-gradient-to-br from-pink-900/30 to-purple-900/30 border-2 border-pink-500/30 rounded-xl p-6" style="min-height: 160px;">
                                <div id="mutation-target-display" class="flex items-center justify-center" style="min-height: 112px;">
                                    <p class="text-gray-400 text-center">
                                        <span class="text-4xl block mb-2">ğŸ§¬</span>
                                        è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€åªåŠ¨ç‰©
                                    </p>
                                </div>
                            </div>
                            
                            <!-- å˜å¼‚ä¿¡æ¯å’ŒæŒ‰é’® -->
                            <div id="mutation-stats" class="hidden bg-gray-800/80 rounded-lg p-4 border border-gray-700" style="min-height: 180px;">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gray-900/50 rounded-lg p-3 text-center">
                                        <p class="text-xs text-gray-400 mb-1">æ¶ˆè€—ææ–™</p>
                                        <p id="mut-cost" class="font-mono text-sm"></p>
                                    </div>
                                    <div class="bg-gray-900/50 rounded-lg p-3 text-center">
                                        <p class="text-xs text-gray-400 mb-1">å˜å¼‚æ¦‚ç‡</p>
                                        <p class="font-mono text-xs">
                                            <span class="text-gray-400">åŸºç¡€ 80%</span> |
                                            <span class="text-purple-400">ç²¾è‹± 18%</span> |
                                            <span class="text-pink-400">ä¼ è¯´ 2%</span>
                                        </p>
                                    </div>
                                </div>
                                <button id="btn-execute-mutation" class="action-button w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-pink-500/50 transition-all" disabled>
                                    ğŸ§¬ å¼€å§‹ä¸€çº§å˜å¼‚
                                </button>
                            </div>
                            
                            <!-- å˜å¼‚æ—¥å¿— -->
                            <div class="bg-black/40 rounded-lg p-4 border border-gray-700" style="min-height: 200px;">
                                <h5 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-2">
                                    <span>ğŸ“‹</span>
                                    <span>å˜å¼‚æ—¥å¿—</span>
                                </h5>
                                <div id="mutation-result-log" class="text-xs font-mono text-gray-300 whitespace-pre-wrap overflow-y-auto" style="height: 150px;">
                                    ç­‰å¾…å¼€å§‹å˜å¼‚...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- äºŒçº§å˜å¼‚å†…å®¹ -->
                    <div id="mutation-tier2-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- å·¦ä¾§ï¼šåŠ¨ç‰©åˆ—è¡¨ -->
                        <div class="lg:col-span-1 bg-gray-800/50 rounded-lg p-4">
                            <h4 class="text-sm font-bold mb-3 text-yellow-400 flex items-center gap-2">
                                <span>âš¡</span>
                                <span>å¯äºŒçº§å˜å¼‚åŠ¨ç‰©</span>
                            </h4>
                            <div id="mutation-tier2-animal-list" class="space-y-2 max-h-[500px] overflow-y-auto pr-2"></div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šå˜å¼‚æ“ä½œåŒº -->
                        <div class="lg:col-span-2 flex flex-col gap-4">
                            <!-- é€‰ä¸­çš„åŠ¨ç‰©æ˜¾ç¤º -->
                            <div class="bg-gradient-to-br from-yellow-900/30 to-orange-900/30 border-2 border-yellow-500/30 rounded-xl p-6" style="min-height: 160px;">
                                <div id="mutation-tier2-target-display" class="flex items-center justify-center" style="min-height: 112px;">
                                    <p class="text-gray-400 text-center">
                                        <span class="text-4xl block mb-2">âš¡</span>
                                        è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€åªåŠ¨ç‰©
                                    </p>
                                </div>
                            </div>
                            
                            <!-- å˜å¼‚ä¿¡æ¯å’ŒæŒ‰é’® -->
                            <div id="mutation-tier2-stats" class="hidden bg-gray-800/80 rounded-lg p-4 border border-gray-700" style="min-height: 180px;">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gray-900/50 rounded-lg p-3 text-center">
                                        <p class="text-xs text-gray-400 mb-1">æ¶ˆè€—ææ–™</p>
                                        <p id="mut-tier2-cost" class="font-mono text-sm"></p>
                                    </div>
                                    <div class="bg-gray-900/50 rounded-lg p-3 text-center">
                                        <p class="text-xs text-gray-400 mb-1">æˆåŠŸç‡</p>
                                        <p class="font-mono text-lg text-green-400">60%</p>
                                    </div>
                                </div>
                                <button id="btn-execute-tier2-mutation" class="action-button w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-4 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-yellow-500/50 transition-all" disabled>
                                    âš¡ å¼€å§‹äºŒçº§å˜å¼‚
                                </button>
                            </div>
                            
                            <!-- å˜å¼‚æ—¥å¿— -->
                            <div class="bg-black/40 rounded-lg p-4 border border-gray-700" style="min-height: 200px;">
                                <h5 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-2">
                                    <span>ğŸ“‹</span>
                                    <span>å˜å¼‚æ—¥å¿—</span>
                                </h5>
                                <div id="mutation-tier2-result-log" class="text-xs font-mono text-gray-300 whitespace-pre-wrap overflow-y-auto" style="height: 150px;">
                                    ç­‰å¾…å¼€å§‹å˜å¼‚...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å˜å¼‚ç»“æœæ¨¡æ€æ¡† (æ–°å¢) -->
            <div id="mutation-result-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center">
                <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full border border-pink-500 shadow-2xl transform transition-all scale-100 relative">
                    <div id="mutation-result-header" class="text-center mb-6">
                        <div id="mutation-result-icon" class="text-6xl mb-2">ğŸ§¬</div>
                        <h3 id="mutation-result-title" class="text-2xl font-bold text-white">å˜å¼‚ç»“æœ</h3>
                    </div>
                    
                    <div id="mutation-result-content" class="space-y-4 text-sm text-gray-300">
                        <!-- åŠ¨æ€å†…å®¹ -->
                    </div>

                    <div class="mt-8 text-center">
                        <button id="btn-close-mutation-result" class="px-8 py-3 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white rounded-lg font-bold shadow-lg transform transition hover:scale-105">
                            ç¡®å®š
                        </button>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§è¯¦æƒ…é¢æ¿ (ç‹¬ç«‹å‡ºæ¥) -->
            <div id="animal-details" class="control-panel p-4 rounded-lg text-white w-full md:w-96" style="overflow: visible;">
                            <div id="animal-detail-content" class="hidden" style="overflow: visible;">
                                <h4 class="text-lg font-bold text-fuchsia-400 flex justify-between items-center">
                                    <span class="flex items-center">
                                        <span id="animal-detail-name"></span>
                                        <button id="btn-rename-animal" class="text-sm ml-2 p-1 rounded hover:bg-gray-600" title="é‡å‘½å">âœï¸</button>
                                    </span>
                                    <div class="flex items-center space-x-2">
                                        <span id="animal-detail-element-tag" class="text-sm font-normal bg-cyan-600 px-2 py-1 rounded"></span>
                                        <span id="animal-detail-gender" class="text-sm font-normal px-2 py-1 rounded"></span>
                                        <span id="animal-detail-level" class="text-sm font-normal bg-purple-600 px-2 py-1 rounded"></span>
                                    </div>
                                </h4>
                                <div class="my-2">
                                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                                        <span>ç»éªŒ</span>
                                        <span id="animal-detail-exp-text"></span>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-2">
                                        <div id="animal-detail-exp-bar" class="bg-yellow-400 h-2 rounded-full"></div>
                                    </div>
                                </div>
                                <div class="flex border-b border-gray-600 mb-2">
                                    <button id="btn-tab-attributes" class="flex-1 text-sm py-1 text-center">å±æ€§</button>
                                    <button id="btn-tab-abilities" class="flex-1 text-sm py-1 text-center">èƒ½åŠ›</button>
                                    <button id="btn-tab-items" class="flex-1 text-sm py-1 text-center text-gray-400">é“å…·</button>
                                </div>
                                <div id="panel-attributes" class="text-sm space-y-1">
                                    <p class="cursor-help" title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†åŠ æˆ">â¤ï¸ ä½“åŠ›: <span id="animal-detail-stamina" class="font-mono text-green-300"></span></p>
                                    <div id="stamina-breakdown" class="hidden text-xs text-gray-400 ml-6 mb-2 bg-gray-800/50 p-2 rounded"></div>
                                    
                                    <p>ğŸ˜Š å¥½æ„Ÿåº¦: <span id="animal-detail-favorability" class="font-mono text-pink-300"></span></p>
                                    <p>âœ¨ æ½œåŠ›: <span id="animal-detail-potential" class="font-mono"></span></p>
                                    <p>ğŸŒ± å‘è‚²: <span id="animal-detail-development" class="font-mono text-yellow-300"></span></p>
                                    
                                    <!-- ç¨€æœ‰åº¦æ˜¾ç¤º -->
                                    <div id="rarity-display" class="mt-3 pt-3 border-t border-gray-700">
                                        <p class="text-xs text-gray-400 mb-2">â­ ç¨€æœ‰åº¦</p>
                                        <div id="rarity-info" class="space-y-1">
                                            <p id="rarity-text" class="text-sm font-bold">æ™®é€š</p>
                                        </div>
                                    </div>
                                    
                                    <!-- å˜å¼‚ç±»å‹æ˜¾ç¤º -->
                                    <div id="mutation-types-display" class="mt-3 pt-3 border-t border-gray-700">
                                        <p class="text-xs text-gray-400 mb-2">ğŸ§¬ å˜å¼‚çŠ¶æ€</p>
                                        <div id="mutation-types-list" class="space-y-1">
                                            <p class="text-xs text-gray-500">æœªè¿›è¡Œå˜å¼‚</p>
                                        </div>
                                    </div>
                                    
                                    <!-- ä¼ è¯´çº§æœºåˆ¶æ˜¾ç¤º -->
                                    <div id="legendary-mechanism-display" class="mt-3 pt-3 border-t border-gray-700 hidden">
                                        <p class="text-xs text-gray-400 mb-2">âš™ï¸ ç‰¹æ®Šæœºåˆ¶</p>
                                        <div id="legendary-mechanism-content" class="space-y-1">
                                        </div>
                                    </div>
                                    
                                    <!-- å–‚å…»æ“ä½œåŒºåŸŸ -->
                                    <div class="mt-4 pt-3 border-t border-gray-700 space-y-2">
                                        <button id="btn-feed-animal" class="action-button w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg">å–‚å…»</button>
                                        <button id="btn-feed-animal-10" class="action-button w-full bg-orange-800 hover:bg-orange-900 text-white font-bold py-2 px-4 rounded-lg">è¿å‡10çº§</button>
                                    </div>
                                </div>
                                <div id="panel-abilities" class="text-sm space-y-2 hidden" style="overflow: visible;">
                                    <!-- æˆ˜æ–—èƒ½åŠ›æ  -->
                                    <div class="bg-gray-800 rounded-lg p-3 space-y-3" style="overflow: visible;">
                                        <p class="font-semibold text-red-400 text-center border-b border-gray-700 pb-2">âš”ï¸ æˆ˜æ–—èƒ½åŠ›</p>
                                        
                                        <!-- ä¸‰ä¸ªå±æ€§å€¼ -->
                                        <div class="grid grid-cols-3 gap-2 text-center">
                                            <div class="bg-gray-700 rounded p-2 cursor-help" title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†åŠ æˆ">
                                                <div class="text-xs text-gray-400">æ”»å‡»</div>
                                                <div id="ability-combat-atk" class="font-mono text-red-400 font-bold text-lg"></div>
                                            </div>
                                            <div class="bg-gray-700 rounded p-2 cursor-help" title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†åŠ æˆ">
                                                <div class="text-xs text-gray-400">é˜²å¾¡</div>
                                                <div id="ability-combat-def" class="font-mono text-blue-400 font-bold text-lg"></div>
                                            </div>
                                            <div class="bg-gray-700 rounded p-2 cursor-help" title="ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†åŠ æˆ">
                                                <div class="text-xs text-gray-400">æ•æ·</div>
                                                <div id="ability-combat-agi" class="font-mono text-yellow-400 font-bold text-lg"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- æˆ˜æ–—èƒ½åŠ›è¯¦ç»†åŠ æˆ -->
                                        <div id="combat-breakdown" class="hidden text-xs text-gray-400 bg-gray-900/50 p-3 rounded space-y-1">
                                            <div id="attack-breakdown"></div>
                                            <div id="defense-breakdown"></div>
                                            <div id="agility-breakdown"></div>
                                        </div>

                                        <!-- å››ä¸ªæŠ€èƒ½æ§½ -->
                                        <div class="border-t border-gray-700 pt-2">
                                            <p class="text-xs text-gray-400 mb-2">æˆ˜æ–—æŠ€èƒ½æ§½</p>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div id="skill-slot-1" class="bg-gray-700 rounded p-2 text-center cursor-pointer hover:bg-gray-600 transition-colors min-h-[60px] flex flex-col items-center justify-center">
                                                    <span class="text-gray-500 text-xs">ç©ºæ§½ä½</span>
                                                </div>
                                                <div id="skill-slot-2" class="bg-gray-700 rounded p-2 text-center cursor-pointer hover:bg-gray-600 transition-colors min-h-[60px] flex flex-col items-center justify-center">
                                                    <span class="text-gray-500 text-xs">ç©ºæ§½ä½</span>
                                                </div>
                                                <div id="skill-slot-3" class="bg-gray-700 rounded p-2 text-center cursor-pointer hover:bg-gray-600 transition-colors min-h-[60px] flex flex-col items-center justify-center">
                                                    <span class="text-gray-500 text-xs">ç©ºæ§½ä½</span>
                                                </div>
                                                <div id="skill-slot-4" class="bg-gray-700 rounded p-2 text-center cursor-pointer hover:bg-gray-600 transition-colors min-h-[60px] flex flex-col items-center justify-center">
                                                    <span class="text-gray-500 text-xs">ç©ºæ§½ä½</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- æŠ€èƒ½é€‰æ‹©åˆ—è¡¨ï¼ˆåŒ…å«å˜å¼‚æŠ€èƒ½å’Œæˆ˜æ–—æŠ€èƒ½ï¼‰ -->
                                        <div class="border-t border-gray-700 pt-2">
                                            <div class="flex justify-between items-center mb-2">
                                                <p class="text-xs text-gray-400">å¯ç”¨æŠ€èƒ½</p>
                                                <button id="btn-manage-skills" class="text-xs bg-purple-600 hover:bg-purple-700 px-2 py-1 rounded">ç®¡ç†æŠ€èƒ½</button>
                                            </div>
                                            
                                            <!-- å˜å¼‚æŠ€èƒ½åŒºåŸŸ -->
                                            <div id="mutation-skills-in-abilities" class="mb-2">
                                                <!-- ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                                            </div>
                                            
                                            <!-- æˆ˜æ–—æŠ€èƒ½åŒºåŸŸ -->
                                            <div id="available-skills-list" class="space-y-1 max-h-[150px]" style="overflow-y: auto; overflow-x: visible; position: relative;">
                                                <p class="text-xs text-gray-500 text-center py-2">æš‚æ— å¯ç”¨æŠ€èƒ½</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="panel-items" class="text-sm space-y-2 hidden">
                                    <p id="items-empty-msg" class="text-gray-400 text-center py-4">æš‚æ— å¯ç”¨é“å…·</p>
                                    <!-- é“å…·æ å ä½ç¬¦ -->
                                    <div id="item-grid" class="grid grid-cols-4 gap-2 min-h-[50px]"></div>
                                </div>
                            </div>
                        </div>
                        <div id="animal-detail-placeholder" class="text-center text-gray-500 pt-10">
                            <p>ç‚¹å‡»å·¦ä¾§åˆ—è¡¨ä¸­çš„åŠ¨ç‰©<br>ä»¥æŸ¥çœ‹è¯¦æƒ…</p>
                        </div>
            </div>
        </div>
    </div>

    <script>
        // è°ƒè¯•å¯¹è±¡å°†ç”± debug.js æä¾›

        // --- å…¨å±€å˜é‡å’Œé…ç½® ---
        let gameState = {};
        let selectedAnimalId = null;
        let lastSelectedAnimalIdInCultivation = null; // æ–°å¢ï¼šè®°å½•å…»æˆé¢æ¿çš„æœ€åé€‰æ‹©
        let currentActivePanel = 'cultivation'; // è¿½è¸ªå½“å‰æ¿€æ´»çš„é¢æ¿
        let isActionInProgress = false; // é˜²æ­¢åœ¨ç¹æ®–/èåˆæœŸé—´è¿›è¡Œå…¶ä»–æ“ä½œ

        // ç­‰çº§å’Œæˆé•¿é…ç½® (ä¸ game3d.html ä¿æŒä¸€è‡´)
        const LEVEL_CONFIG = {
            baseExperience: 100,
            experienceMultiplier: 1.5,
            feedAmount: 20,
            potentialMultipliers: { 'å¹³åº¸': { stamina: 1.0, combat: 1.0 }, 'è¶…å¸¸': { stamina: 1.2, combat: 1.3 }, 'ç’€ç’¨': { stamina: 1.5, combat: 1.8 } },
            baseGrowth: { stamina: 10, attack: 3, defense: 2, agility: 2, favorability: 5 }
        };
        const ACTION_DURATION = 15000; // 15 seconds for breeding/fusion

        const ELEMENT_ICONS = {
            'æ°´': 'ğŸ’§',
            'ç«': 'ğŸ”¥',
            'åœŸ': 'ğŸŒ',
            'é£': 'ğŸ’¨',
            'é›·': 'âš¡ï¸',
            'æœ¨': 'ğŸŒ³',
            'å…‰': 'â˜€ï¸',
            'æš—': 'ğŸŒ™',
            'é»˜è®¤': 'â”'
        };
        const ELEMENT_COLORS = {
            'æ°´': 'bg-blue-500',
            'ç«': 'bg-red-600',
            'åœŸ': 'bg-amber-700',
            'é£': 'bg-teal-400 text-black',
            'é›·': 'bg-yellow-400 text-black',
            'æœ¨': 'bg-green-600',
            'å…‰': 'bg-yellow-200 text-black',
            'æš—': 'bg-indigo-800',
            'é»˜è®¤': 'bg-gray-500'
        };
        const ANIMAL_NAMES = ['Ami', 'Bao', 'Cai', 'Duo', 'Fei', 'Gui', 'Hao', 'Jing', 'Kai', 'Ling'];
        // æ–°å¢ï¼šé“å…·é…ç½®
        const ITEMS = {
            'exp_potion_s': { name: 'å°ç»éªŒè¯æ°´', icon: 'ğŸ§ª', type: 'exp', value: 50, desc: 'å¢åŠ 50ç‚¹ç»éªŒ' },
            'exp_potion_l': { name: 'å¤§ç»éªŒè¯æ°´', icon: 'âš—ï¸', type: 'exp', value: 200, desc: 'å¢åŠ 200ç‚¹ç»éªŒ' },
            'stamina_potion': { name: 'ä½“åŠ›è¯å‰‚', icon: 'âš¡', type: 'stamina', value: 50, desc: 'æ¢å¤50ç‚¹ä½“åŠ›' },
            'mutation_serum': { name: 'å˜å¼‚è¡€æ¸…', icon: 'ğŸ’‰', type: 'material', desc: 'è¯±å‘åŠ¨ç‰©åŸºå› çªå˜çš„å…³é”®é“å…·' }
        };

        // æˆ˜æ–—æŠ€èƒ½é…ç½®
        const COMBAT_SKILLS = {
            'POWER_STRIKE': { name: 'åŠ›é‡æ‰“å‡»', icon: 'ğŸ’¥', type: 'attack', desc: 'é€ æˆ150%æ”»å‡»åŠ›çš„ä¼¤å®³', cooldown: 3 },
            'SHIELD_BASH': { name: 'ç›¾å‡»', icon: 'ğŸ›¡ï¸', type: 'defense', desc: 'æå‡50%é˜²å¾¡å¹¶åå‡»', cooldown: 4 },
            'QUICK_SLASH': { name: 'ç–¾é£æ–©', icon: 'âš¡', type: 'agility', desc: 'è¿ç»­æ”»å‡»2æ¬¡ï¼Œæ¯æ¬¡70%ä¼¤å®³', cooldown: 2 },
            'BERSERKER': { name: 'ç‹‚æš´', icon: 'ğŸ˜¡', type: 'buff', desc: 'æ”»å‡»åŠ›æå‡30%ï¼ŒæŒç»­3å›åˆ', cooldown: 5 },
            'IRON_WALL': { name: 'é“å£', icon: 'ğŸ°', type: 'defense', desc: 'é˜²å¾¡åŠ›æå‡50%ï¼ŒæŒç»­2å›åˆ', cooldown: 4 },
            'DODGE': { name: 'é—ªé¿', icon: 'ğŸ’¨', type: 'agility', desc: 'ä¸‹æ¬¡æ”»å‡»å¿…å®šé—ªé¿', cooldown: 3 },
            'CRITICAL_HIT': { name: 'è‡´å‘½ä¸€å‡»', icon: 'ğŸ¯', type: 'attack', desc: 'é€ æˆ200%æš´å‡»ä¼¤å®³', cooldown: 5 },
            'LIFE_STEAL': { name: 'ç”Ÿå‘½æ±²å–', icon: 'ğŸ©¸', type: 'attack', desc: 'æ”»å‡»å›å¤50%ä¼¤å®³çš„ç”Ÿå‘½', cooldown: 4 },
            'COUNTER': { name: 'åå‡»', icon: 'â†©ï¸', type: 'defense', desc: 'å—åˆ°æ”»å‡»æ—¶åå‡»100%ä¼¤å®³', cooldown: 3 },
            'SPEED_BOOST': { name: 'åŠ é€Ÿ', icon: 'ğŸš€', type: 'agility', desc: 'æ•æ·æå‡40%ï¼ŒæŒç»­2å›åˆ', cooldown: 3 }
        };

        // å˜å¼‚ç³»ç»Ÿé…ç½®
        const MUTATION_CONFIG = {
            tier1: {
                basic: {
                    'é»‘åŒ–': { icon: 'ğŸ–¤', rarity: 'basic', chain: 'dark', skills: ['MUT_DARK_POWER'], stats: { attack: 5 } },
                    'ç™½åŒ–': { icon: 'ğŸ¤', rarity: 'basic', chain: 'light', skills: ['MUT_LIGHT_HEAL'], stats: { stamina: 10 } },
                    'æ™¶åŒ–': { icon: 'ğŸ’', rarity: 'basic', chain: 'crystal', skills: ['MUT_CRYSTAL_SHIELD'], stats: { defense: 5 } },
                    'å½±åŒ–': { icon: 'ğŸ‘¤', rarity: 'basic', chain: 'thunder', skills: ['MUT_SHADOW_SPEED'], stats: { agility: 5 } }
                },
                elite: {
                    'æš—èš€': { icon: 'ğŸŒ‘', rarity: 'elite', chain: 'dark', skills: ['MUT_PERCENT_DAMAGE', 'MUT_LIFE_DRAIN'], stats: { attack: 10 } },
                    'åœ£è¾‰': { icon: 'âœ¨', rarity: 'elite', chain: 'light', skills: ['MUT_HOLY_HEAL', 'MUT_HEAL_REDUCE'], stats: { stamina: 15, defense: 5 } },
                    'å¼‚èƒ½': { icon: 'ğŸ”®', rarity: 'elite', chain: 'crystal', skills: ['MUT_DAMAGE_AMP', 'MUT_DEFENSE_AMP'], stats: { attack: 6, defense: 6 } },
                    'æç”µ': { icon: 'âš¡', rarity: 'elite', chain: 'thunder', skills: ['MUT_THUNDER_STRIKE', 'MUT_LIGHTNING_SPEED'], stats: { attack: 8, agility: 8 } }
                },
                legendary: {
                    'æ°¸å¤œ': { icon: 'ğŸŒ™', rarity: 'legendary', chain: 'dark', skills: ['MUT_ETERNAL_DARK', 'MUT_DARK_AURA'], stats: { attack: 15, defense: 10 }, mechanism: 'enemy_debuff' },
                    'æ°¸è€€': { icon: 'â˜€ï¸', rarity: 'legendary', chain: 'light', skills: ['MUT_ETERNAL_LIGHT', 'MUT_REGEN_AURA'], stats: { stamina: 20, defense: 10 }, mechanism: 'team_buff' },
                    'æºæ™¶': { icon: 'ğŸ’ ', rarity: 'legendary', chain: 'crystal', skills: ['MUT_CRYSTAL_POWER', 'MUT_SHIELD_AURA'], stats: { defense: 15, stamina: 15 }, mechanism: 'production' },
                    'é›·ç…Œ': { icon: 'âš¡', rarity: 'legendary', chain: 'thunder', skills: ['MUT_LIGHTNING_LORD', 'MUT_SPEED_AURA'], stats: { attack: 15, agility: 15 }, mechanism: 'speed_buff' }
                }
            },
            tier2: {
                'é˜´': { icon: 'â˜¯ï¸', stats: { agility: 10, stamina: 15 } },
                'é˜³': { icon: 'â˜€ï¸', stats: { attack: 10, defense: 10 } },
                'ç„': { icon: 'ğŸ”¯', stats: { attack: 5, defense: 5, agility: 5, stamina: 10 } }
            }
        };
        
        // äº²å’Œå…³ç³»é“¾å®šä¹‰
        const AFFINITY_CHAINS = {
            dark: { basic: 'é»‘åŒ–', elite: 'æš—èš€', legendary: 'æ°¸å¤œ', opposite: 'light' },
            light: { basic: 'ç™½åŒ–', elite: 'åœ£è¾‰', legendary: 'æ°¸è€€', opposite: 'dark' },
            crystal: { basic: 'æ™¶åŒ–', elite: 'å¼‚èƒ½', legendary: 'æºæ™¶', opposite: 'thunder' },
            thunder: { basic: 'å½±åŒ–', elite: 'æç”µ', legendary: 'é›·ç…Œ', opposite: 'crystal' }
        };

        // å˜å¼‚æŠ€èƒ½é…ç½®
        const MUTATION_SKILLS = {
            'MUT_DARK_POWER': { name: 'æš—é»‘ä¹‹åŠ›', icon: 'ğŸ–¤', desc: 'æ”»å‡»åŠ›+15%' },
            'MUT_LIGHT_HEAL': { name: 'å…‰æ˜æ²»æ„ˆ', icon: 'ğŸ¤', desc: 'æ¯å›åˆæ¢å¤5%ç”Ÿå‘½' },
            'MUT_CRYSTAL_SHIELD': { name: 'æ™¶ä½“æŠ¤ç›¾', icon: 'ğŸ’', desc: 'é˜²å¾¡åŠ›+20%' },
            'MUT_SHADOW_SPEED': { name: 'å½±ä¹‹ç–¾è¡Œ', icon: 'ğŸ‘¤', desc: 'æ•æ·+25%' },
            'MUT_THUNDER_STRIKE': { name: 'é›·éœ†ä¸€å‡»', icon: 'âš¡', desc: 'æ”»å‡»é™„åŠ 30%é›·ç”µä¼¤å®³' },
            'MUT_LIGHTNING_SPEED': { name: 'é—ªç”µç–¾é©°', icon: 'âš¡', desc: 'æ•æ·+30%' },
            'MUT_HOLY_HEAL': { name: 'åœ£å…‰æ²»ç–—', icon: 'âœ¨', desc: 'æ¯å›åˆæ¢å¤8%ç”Ÿå‘½' },
            'MUT_HEAL_REDUCE': { name: 'æ²»ç–—å‰Šå¼±', icon: 'âœ¨', desc: 'æ•Œæ–¹æ²»ç–—æ•ˆæœ-50%' },
            'MUT_DAMAGE_AMP': { name: 'ä¼¤å®³å¢å¹…', icon: 'ğŸ”®', desc: 'é€ æˆä¼¤å®³+25%' },
            'MUT_DEFENSE_AMP': { name: 'é˜²å¾¡å¢å¹…', icon: 'ğŸ”®', desc: 'å—åˆ°ä¼¤å®³-20%' },
            'MUT_PERCENT_DAMAGE': { name: 'ç™¾åˆ†æ¯”ä¼¤å®³', icon: 'ğŸŒ‘', desc: 'æ”»å‡»é€ æˆæ•Œæ–¹5%æœ€å¤§ç”Ÿå‘½ä¼¤å®³' },
            'MUT_LIFE_DRAIN': { name: 'ç”Ÿå‘½æ±²å–', icon: 'ğŸŒ‘', desc: 'æ”»å‡»å›å¤50%ä¼¤å®³ç”Ÿå‘½' },
            'MUT_ETERNAL_DARK': { name: 'æ°¸æ’æš—å¤œ', icon: 'ğŸŒ™', desc: 'é™ä½æ•Œæ–¹å…¨ä½“10%æ”»å‡»/å‘½ä¸­' },
            'MUT_DARK_AURA': { name: 'æš—å½±å…‰ç¯', icon: 'ğŸŒ™', desc: 'å·±æ–¹æš—ç³»ä¼¤å®³+30%' },
            'MUT_ETERNAL_LIGHT': { name: 'æ°¸æ’å…‰è¾‰', icon: 'â˜€ï¸', desc: 'å‡ºæˆ˜èƒŒåŒ…å…¨ä½“ç”Ÿå‘½+15%' },
            'MUT_REGEN_AURA': { name: 'å†ç”Ÿå…‰ç¯', icon: 'â˜€ï¸', desc: 'é˜Ÿä¼å…¨ä½“æ¯å›åˆæ¢å¤3%ç”Ÿå‘½' },
            'MUT_CRYSTAL_POWER': { name: 'æºæ™¶ä¹‹åŠ›', icon: 'ğŸ’ ', desc: 'é˜²å¾¡åŠ›+40%' },
            'MUT_SHIELD_AURA': { name: 'æŠ¤ç›¾å…‰ç¯', icon: 'ğŸ’ ', desc: 'é˜Ÿä¼å…¨ä½“å—åˆ°ä¼¤å®³-15%' },
            'MUT_LIGHTNING_LORD': { name: 'é›·éœ†ä¹‹ä¸»', icon: 'âš¡', desc: 'æ”»å‡»é€Ÿåº¦+50%ï¼Œæ¦‚ç‡è§¦å‘è¿é”é—ªç”µ' },
            'MUT_SPEED_AURA': { name: 'ç–¾é€Ÿå…‰ç¯', icon: 'âš¡', desc: 'é˜Ÿä¼å…¨ä½“æ”»å‡»é€Ÿåº¦/ç§»åŠ¨é€Ÿåº¦+25%' }
        };

        // UI å…ƒç´ å¼•ç”¨
        const ui = {
            statusMessage: document.getElementById('status-message'),
            btnSaveAndReturn: document.getElementById('btn-save-and-return'),
            mainMenu: document.getElementById('animal-system-main-menu'),
            cultivationPanel: document.getElementById('animal-cultivation-panel'),
            breedingPanel: document.getElementById('animal-breeding-panel'),
            fusionPanel: document.getElementById('animal-fusion-panel'),
            mutationPanel: document.getElementById('animal-mutation-panel'), // æ–°å¢
            btnOpenCultivation: document.getElementById('btn-open-cultivation-from-menu'),
            btnOpenBreeding: document.getElementById('btn-open-breeding-panel'),
            btnOpenFusion: document.getElementById('btn-open-fusion-panel'),
            btnOpenMutation: document.getElementById('btn-open-mutation-panel'), // æ–°å¢
            animalList: document.getElementById('animal-list'),
            animalDetailContent: document.getElementById('animal-detail-content'),
            animalDetailPlaceholder: document.getElementById('animal-detail-placeholder'),
            animalDetailName: document.getElementById('animal-detail-name'),
            animalDetailLevel: document.getElementById('animal-detail-level'),
            btnRenameAnimal: document.getElementById('btn-rename-animal'), // æ–°å¢
            animalDetailElementTag: document.getElementById('animal-detail-element-tag'), // æ–°å¢
            animalDetailGender: document.getElementById('animal-detail-gender'),
            animalDetailExpText: document.getElementById('animal-detail-exp-text'),
            animalDetailExpBar: document.getElementById('animal-detail-exp-bar'),
            animalDetailStamina: document.getElementById('animal-detail-stamina'),
            animalDetailFavorability: document.getElementById('animal-detail-favorability'),
            animalDetailPotential: document.getElementById('animal-detail-potential'),
            animalDetailDevelopment: document.getElementById('animal-detail-development'),
            btnTabAttributes: document.getElementById('btn-tab-attributes'),
            btnTabAbilities: document.getElementById('btn-tab-abilities'),
            btnTabItems: document.getElementById('btn-tab-items'), // æ–°å¢
            panelAttributes: document.getElementById('panel-attributes'),
            panelAbilities: document.getElementById('panel-abilities'),
            panelItems: document.getElementById('panel-items'), // æ–°å¢
            abilityCombatAtk: document.getElementById('ability-combat-atk'),
            abilityCombatDef: document.getElementById('ability-combat-def'),
            abilityCombatAgi: document.getElementById('ability-combat-agi'),
            btnFeedAnimal: document.getElementById('btn-feed-animal'),
            // æˆ˜æ–—æŠ€èƒ½ç›¸å…³UI
            skillSlot1: document.getElementById('skill-slot-1'),
            skillSlot2: document.getElementById('skill-slot-2'),
            skillSlot3: document.getElementById('skill-slot-3'),
            skillSlot4: document.getElementById('skill-slot-4'),
            availableSkillsList: document.getElementById('available-skills-list'),
            btnManageSkills: document.getElementById('btn-manage-skills'),
            btnFeedAnimal10: document.getElementById('btn-feed-animal-10'), // æ–°å¢
            breedingAnimalList: document.getElementById('breeding-animal-list'),
            parentDisplay1: document.getElementById('parent-display-1'),
            parentDisplay2: document.getElementById('parent-display-2'),
            btnExecuteBreed: document.getElementById('btn-execute-breed'),
            btnClearBreedSelection: document.getElementById('btn-clear-breed-selection'),
            fusionAnimalList: document.getElementById('fusion-animal-list'),
            fusionMaterialDisplay1: document.getElementById('fusion-material-display-1'),
            fusionMaterialDisplay2: document.getElementById('fusion-material-display-2'),
            btnExecuteFusion: document.getElementById('btn-execute-fusion'),
            btnClearFusionSelection: document.getElementById('btn-clear-fusion-selection'),
            breedingProgressContainer: document.getElementById('breeding-progress-container'),
            breedingProgressBar: document.getElementById('breeding-progress-bar'),
            fusionProgressContainer: document.getElementById('fusion-progress-container'),
            fusionProgressBar: document.getElementById('fusion-progress-bar'),
            // æ–°å¢ï¼šèµ„æºUIå…ƒç´ 
            food: document.querySelector('#stat-food span'),
            gems: document.querySelector('#stat-gems span'),
            animalCount: document.querySelector('#stat-animal-count span'),
            // æ–°å¢ï¼šå˜å¼‚UIå…ƒç´ 
            mutationAnimalList: document.getElementById('mutation-animal-list'),
            mutationTargetDisplay: document.getElementById('mutation-target-display'),
            mutationStats: document.getElementById('mutation-stats'),
            mutRate: document.getElementById('mut-rate'),
            mutCooldown: document.getElementById('mut-cooldown'),
            mutReq: document.getElementById('mut-req'),
            mutCost: document.getElementById('mut-cost'),
            btnExecuteMutation: document.getElementById('btn-execute-mutation'),
            mutationResultLog: document.getElementById('mutation-result-log'),
            // æ–°å¢ï¼šå˜å¼‚ç»“æœæ¨¡æ€æ¡†UI
            mutationResultModal: document.getElementById('mutation-result-modal'),
            mutationResultTitle: document.getElementById('mutation-result-title'),
            mutationResultContent: document.getElementById('mutation-result-content'),
            mutationResultIcon: document.getElementById('mutation-result-icon'),
            btnCloseMutationResult: document.getElementById('btn-close-mutation-result'),
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        window.onload = function() {
            loadGameState();
            setupEventListeners();
            updateResourceUI();
            // é»˜è®¤æ‰“å¼€å…»æˆé¢æ¿å¹¶é€‰æ‹©ç¬¬ä¸€åªåŠ¨ç‰©
            switchPanel('cultivation');
            // å¦‚æœæœ‰åŠ¨ç‰©ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€åª
            if (gameState.animals && gameState.animals.length > 0) {
                showAnimalDetails(gameState.animals[0].id);
            }
        };

        function loadGameState() {
            const stateJSON = localStorage.getItem('gameState');
            if (stateJSON) {
                gameState = JSON.parse(stateJSON);
                // ç¡®ä¿åµŒå¥—å¯¹è±¡å­˜åœ¨
                gameState.selectedAnimalsForBreeding = gameState.selectedAnimalsForBreeding || [];
                gameState.selectedAnimalsForFusion = gameState.selectedAnimalsForFusion || [];
                // æ–°å¢ï¼šåˆå§‹åŒ–èƒŒåŒ…
                if (!gameState.inventory || Object.keys(gameState.inventory).length === 0) {
                    gameState.inventory = {
                        'exp_potion_s': 5,
                        'exp_potion_l': 2,
                        'stamina_potion': 5,
                        'mutation_serum': 2
                    };
                }
                if (gameState.inventory && typeof gameState.inventory['mutation_serum'] === 'undefined') {
                    gameState.inventory['mutation_serum'] = 1; // ä¸ºæ—§å­˜æ¡£è¡¥å……é“å…·
                }
            } else {
                alert("æ¸¸æˆçŠ¶æ€åŠ è½½å¤±è´¥ï¼å°†è¿”å›ä¸»åœºæ™¯ã€‚");
                window.location.href = 'game3d.html';
            }
        }

        function saveGameState() {
            // æ¸…ç†æ‰ä¸´æ—¶çš„é€‰æ‹©çŠ¶æ€å†ä¿å­˜
            const stateToSave = { ...gameState };
            delete stateToSave.selectedAnimalsForBreeding;
            delete stateToSave.selectedAnimalsForFusion;

            localStorage.setItem('gameState', JSON.stringify(stateToSave));
        }

        function saveAndReturn() {
            saveGameState();
            window.location.href = 'game3d.html';
        }

        function setupEventListeners() {
            if (isActionInProgress) {
                showStatus("æ­£åœ¨è¿›è¡Œæ“ä½œï¼Œè¯·ç¨å€™...", 3000);
                return;
            }

            ui.btnSaveAndReturn.addEventListener('click', saveAndReturn);
            ui.btnOpenCultivation.addEventListener('click', () => switchPanel('cultivation'));
            ui.btnOpenBreeding.addEventListener('click', () => switchPanel('breeding'));
            ui.btnOpenFusion.addEventListener('click', () => switchPanel('fusion'));
            ui.btnOpenMutation.addEventListener('click', () => switchPanel('mutation')); // æ–°å¢

            ui.btnExecuteBreed.addEventListener('click', breedAnimal);
            ui.btnClearBreedSelection.addEventListener('click', clearBreedingSelection);
            ui.btnExecuteFusion.addEventListener('click', fuseAnimals);
            ui.btnClearFusionSelection.addEventListener('click', clearFusionSelection);

            ui.parentDisplay1.addEventListener('click', () => clearParentSelection(0));
            ui.parentDisplay2.addEventListener('click', () => clearParentSelection(1));

            ui.fusionMaterialDisplay1.addEventListener('click', () => clearFusionMaterialSelection(0));
            ui.fusionMaterialDisplay2.addEventListener('click', () => clearFusionMaterialSelection(1));

            ui.btnExecuteMutation.addEventListener('click', executeMutation);
            document.getElementById('btn-execute-tier2-mutation').addEventListener('click', executeTier2Mutation);
            ui.btnCloseMutationResult.addEventListener('click', () => ui.mutationResultModal.classList.add('hidden'));
            document.getElementById('btn-mutation-tier1').addEventListener('click', () => switchMutationTab('tier1'));
            document.getElementById('btn-mutation-tier2').addEventListener('click', () => switchMutationTab('tier2'));

            ui.btnTabAttributes.addEventListener('click', () => switchDetailTab('attributes'));
            ui.btnTabAbilities.addEventListener('click', () => switchDetailTab('abilities'));
            ui.btnTabItems.addEventListener('click', () => switchDetailTab('items')); // æ–°å¢

            ui.btnRenameAnimal.addEventListener('click', renameAnimal);
            document.getElementById('btn-reset-game').addEventListener('click', resetGameData);
            ui.btnManageSkills.addEventListener('click', openSkillManagementModal);
        }

        // æ¸²æŸ“æˆ˜æ–—æŠ€èƒ½æ§½å’Œå¯ç”¨æŠ€èƒ½åˆ—è¡¨ï¼ˆæ”¯æŒå˜å¼‚æŠ€èƒ½ï¼‰
        function renderCombatSkills(animal) {
            if (!animal) return;
            
            // åˆå§‹åŒ–æŠ€èƒ½ç³»ç»Ÿ
            animal.combatSkills = animal.combatSkills || { equipped: [], available: [] };
            
            // è¯»å–æŠ€èƒ½æ± ä»¥è·å–è‡ªå®šä¹‰æŠ€èƒ½ä¿¡æ¯
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            
            // æ¸²æŸ“å·²è£…å¤‡çš„æŠ€èƒ½æ§½ï¼ˆæ”¯æŒæˆ˜æ–—æŠ€èƒ½å’Œå˜å¼‚æŠ€èƒ½ï¼‰
            const slots = [ui.skillSlot1, ui.skillSlot2, ui.skillSlot3, ui.skillSlot4];
            slots.forEach((slot, index) => {
                const skillKey = animal.combatSkills.equipped[index];
                
                // æ£€æŸ¥æ˜¯æˆ˜æ–—æŠ€èƒ½ã€å˜å¼‚æŠ€èƒ½è¿˜æ˜¯è‡ªå®šä¹‰æŠ€èƒ½
                let skill = COMBAT_SKILLS[skillKey] || MUTATION_SKILLS[skillKey];
                let customSkill = null;
                
                // å¦‚æœä¸æ˜¯é¢„å®šä¹‰æŠ€èƒ½ï¼Œä»æŠ€èƒ½æ± ä¸­æŸ¥æ‰¾
                if (!skill && skillKey) {
                    customSkill = skillPool.find(s => s.key === skillKey);
                    if (customSkill) {
                        skill = {
                            name: customSkill.name,
                            icon: customSkill.icon,
                            desc: customSkill.description || customSkill.desc || 'æ— æè¿°',
                            cooldown: customSkill.params?.cooldown || 0
                        };
                    }
                }
                
                if (skillKey && skill) {
                    const isMutationSkill = !!MUTATION_SKILLS[skillKey];
                    const tooltipHtml = generateSkillTooltip(skill, customSkill);
                    
                    slot.innerHTML = `
                        ${tooltipHtml}
                        <div class="text-2xl mb-1">${skill.icon}</div>
                        <div class="text-xs font-bold text-white">${skill.name}</div>
                        ${skill.cooldown ? `<div class="text-xs text-gray-400">CD: ${skill.cooldown}</div>` : ''}
                    `;
                    // å˜å¼‚æŠ€èƒ½ä½¿ç”¨ç²‰è‰²è¾¹æ¡†ï¼Œæ™®é€šæŠ€èƒ½ä½¿ç”¨ç´«è‰²è¾¹æ¡†
                    const borderColor = isMutationSkill ? 'border-pink-400' : 'border-purple-400';
                    const bgColor = isMutationSkill ? 'bg-pink-700 hover:bg-pink-600' : 'bg-purple-700 hover:bg-purple-600';
                    slot.className = `skill-slot-wrapper ${bgColor} rounded p-2 text-center cursor-pointer transition-colors min-h-[60px] flex flex-col items-center justify-center border-2 ${borderColor}`;
                    slot.onclick = () => unequipSkill(animal, index);
                } else {
                    slot.innerHTML = '<span class="text-gray-500 text-xs">ç©ºæ§½ä½</span>';
                    slot.className = 'bg-gray-700 rounded p-2 text-center cursor-pointer hover:bg-gray-600 transition-colors min-h-[60px] flex flex-col items-center justify-center';
                    slot.onclick = null;
                }
            });

            // æ¸²æŸ“å¯ç”¨æŠ€èƒ½åˆ—è¡¨
            ui.availableSkillsList.innerHTML = '';
            const availableSkills = animal.combatSkills.available || [];
            
            if (availableSkills.length === 0) {
                ui.availableSkillsList.innerHTML = '<p class="text-xs text-gray-500 text-center py-2">æš‚æ— å¯ç”¨æŠ€èƒ½<br>æ¯5çº§è§£é”æ–°æŠ€èƒ½</p>';
            } else {
                // è¯»å–æŠ€èƒ½æ± ä»¥è·å–è‡ªå®šä¹‰æŠ€èƒ½ä¿¡æ¯
                const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
                
                availableSkills.forEach(skillKey => {
                    // è·³è¿‡æ‰€æœ‰å·²çŸ¥çš„å˜å¼‚æŠ€èƒ½ï¼Œå› ä¸ºå®ƒä»¬åœ¨ä¸“å±åŒºåŸŸæ¸²æŸ“
                    if (MUTATION_SKILLS[skillKey]) return;

                    // å…ˆä»é¢„å®šä¹‰æŠ€èƒ½ä¸­æŸ¥æ‰¾
                    // æ£€æŸ¥æ˜¯æˆ˜æ–—æŠ€èƒ½ã€å˜å¼‚æŠ€èƒ½è¿˜æ˜¯è‡ªå®šä¹‰æŠ€èƒ½
                    let skill = COMBAT_SKILLS[skillKey] || MUTATION_SKILLS[skillKey];
                    let customSkill = null;
                    
                    // å¦‚æœä¸æ˜¯é¢„å®šä¹‰æŠ€èƒ½ï¼Œä»æŠ€èƒ½æ± ä¸­æŸ¥æ‰¾
                    if (!skill && skillKey) {
                        customSkill = skillPool.find(s => s.key === skillKey);
                        if (customSkill) {
                            skill = {
                                name: customSkill.name,
                                icon: customSkill.icon,
                                desc: customSkill.description || customSkill.desc || 'æ— æè¿°',
                                type: customSkill.type,
                                cooldown: customSkill.params?.cooldown || 0
                            };
                        }
                    }
                    
                    if (!skill) {
                        console.warn('æŠ€èƒ½æœªæ‰¾åˆ°:', skillKey);
                        return;
                    }
                    
                    const isEquipped = animal.combatSkills.equipped.includes(skillKey);
                    const div = document.createElement('div');
                    div.className = `skill-item-wrapper p-2 rounded cursor-pointer transition-colors ${
                        isEquipped ? 'bg-purple-800 opacity-50' : 'bg-gray-700 hover:bg-gray-600'
                    }`;
                    
                    const tooltipHtml = generateSkillTooltip(skill, customSkill);
                    
                    div.innerHTML = `
                        ${tooltipHtml}
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-lg flex-shrink-0">${skill.icon}</span>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-bold">${skill.name}</div>
                                <div class="text-xs text-gray-400 line-clamp-2">${skill.desc}</div>
                            </div>
                            <span class="text-xs text-gray-400 flex-shrink-0 ml-2">CD:${skill.cooldown || 0}</span>
                        </div>
                    `;
                    
                    if (!isEquipped) {
                        div.onclick = () => equipSkill(animal, skillKey);
                    }
                    
                    ui.availableSkillsList.appendChild(div);
                });
            }
        }
        
        // ç”ŸæˆæŠ€èƒ½æ‚¬æµ®æç¤ºæ¡†
        function generateSkillTooltip(skill, customSkill) {
            let tooltipHtml = `
                <div class="skill-tooltip">
                    <div class="tooltip-header">
                        <div class="text-3xl mb-1">${skill.icon}</div>
                        <div class="text-sm font-bold text-purple-300">${skill.name}</div>
                        ${skill.type ? `<div class="text-xs text-gray-400 mt-1">${getTypeDisplayName(skill.type)}</div>` : ''}
                    </div>
                    
                    <div class="text-xs text-gray-300 mb-2">${skill.desc}</div>
            `;
            
            // å¦‚æœæ˜¯è‡ªå®šä¹‰æŠ€èƒ½ï¼Œæ˜¾ç¤ºè¯¦ç»†å‚æ•°
            if (customSkill && customSkill.params) {
                const params = customSkill.params;
                tooltipHtml += `<div class="border-t border-gray-600 pt-2 mt-2">`;
                tooltipHtml += `<div class="text-xs font-bold text-purple-400 mb-1">ğŸ“Š æŠ€èƒ½å‚æ•°</div>`;
                
                if (params.cooldown !== undefined && params.cooldown > 0) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">å†·å´å›åˆ</span><span class="tooltip-param-value">${params.cooldown}</span></div>`;
                }
                if (params.duration !== undefined && params.duration > 0) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">æŒç»­å›åˆ</span><span class="tooltip-param-value">${params.duration}</span></div>`;
                }
                if (params.count !== undefined && params.count > 1) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">æ¬¡æ•°</span><span class="tooltip-param-value">${params.count}</span></div>`;
                }
                if (params.attackBonus !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">æ”»å‡»åŠ æˆ</span><span class="tooltip-param-value">Ã—${params.attackBonus}</span></div>`;
                }
                if (params.defenseBonus !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">é˜²å¾¡åŠ æˆ</span><span class="tooltip-param-value">Ã—${params.defenseBonus}</span></div>`;
                }
                if (params.speedBonus !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">é€Ÿåº¦åŠ æˆ</span><span class="tooltip-param-value">${(params.speedBonus * 100).toFixed(0)}%</span></div>`;
                }
                if (params.buffBonus !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">BuffåŠ æˆ</span><span class="tooltip-param-value">${(params.buffBonus * 100).toFixed(0)}%</span></div>`;
                }
                if (params.healBonus !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">æ²»ç–—åŠ æˆ</span><span class="tooltip-param-value">${(params.healBonus * 100).toFixed(0)}%</span></div>`;
                }
                if (params.damagePercent !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">ä¼¤å®³ç™¾åˆ†æ¯”</span><span class="tooltip-param-value">${(params.damagePercent * 100).toFixed(0)}%</span></div>`;
                }
                if (params.healPercent !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">æ¢å¤ç™¾åˆ†æ¯”</span><span class="tooltip-param-value">${(params.healPercent * 100).toFixed(0)}%</span></div>`;
                }
                if (params.multiBonus && params.multiBonus.length > 0) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">å¤šæ®µå€ç‡</span><span class="tooltip-param-value">[${params.multiBonus.join(', ')}]</span></div>`;
                }
                if (params.target) {
                    const targetMap = {
                        'self': 'è‡ªèº«', 'ally-single': 'æˆ‘æ–¹å•ä½“', 'ally-all': 'æˆ‘æ–¹å…¨ä½“',
                        'enemy-single': 'æ•Œæ–¹å•ä½“', 'enemy-all': 'æ•Œæ–¹å…¨ä½“'
                    };
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">ç›®æ ‡</span><span class="tooltip-param-value">${targetMap[params.target] || params.target}</span></div>`;
                }
                if (params.statusType) {
                    const statusMap = {
                        'stun': 'çœ©æ™•', 'poison': 'ä¸­æ¯’', 'bleed': 'æµè¡€',
                        'frostbite': 'å†»ä¼¤', 'burn': 'çƒ§ä¼¤', 'paralyze': 'éº»ç—¹'
                    };
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">å¼‚å¸¸çŠ¶æ€</span><span class="tooltip-param-value">${statusMap[params.statusType] || params.statusType}</span></div>`;
                }
                if (params.statusChance !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">æ–½åŠ æ¦‚ç‡</span><span class="tooltip-param-value">${params.statusChance}%</span></div>`;
                }
                if (params.elementType) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">é’ˆå¯¹å±æ€§</span><span class="tooltip-param-value">${params.elementType}</span></div>`;
                }
                if (params.elementBonus !== undefined) {
                    tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">å±æ€§åŠ æˆ</span><span class="tooltip-param-value">${(params.elementBonus * 100).toFixed(0)}%</span></div>`;
                }
                
                tooltipHtml += `</div>`;
            } else if (skill.cooldown) {
                // é¢„å®šä¹‰æŠ€èƒ½åªæ˜¾ç¤ºå†·å´æ—¶é—´
                tooltipHtml += `<div class="border-t border-gray-600 pt-2 mt-2">`;
                tooltipHtml += `<div class="tooltip-param"><span class="tooltip-param-label">å†·å´å›åˆ</span><span class="tooltip-param-value">${skill.cooldown}</span></div>`;
                tooltipHtml += `</div>`;
            }
            
            tooltipHtml += `</div>`;
            return tooltipHtml;
        }
        
        // è·å–ç±»å‹æ˜¾ç¤ºåç§°
        function getTypeDisplayName(type) {
            const typeMap = {
                'attack': 'âš”ï¸ æ”»å‡»å‹',
                'defense': 'ğŸ›¡ï¸ é˜²å¾¡å‹',
                'agility': 'âš¡ æ•æ·å‹',
                'buff': 'ğŸ’ª å¢ç›Šå‹',
                'debuff': 'ğŸ”» å‡ç›Šå‹',
                'heal': 'ğŸ’š æ²»ç–—å‹'
            };
            return typeMap[type] || type;
        }

        // æ–°å¢ï¼šè®¡ç®—ä½“åŠ›è¯¦ç»†åŠ æˆ
        function calculateStaminaBreakdown(animal) {
            const baseStamina = 70; // åˆå§‹ä½“åŠ›
            const rarityMultiplier = getRarityMultiplier(animal.rarity);
            const potentialMultiplier = LEVEL_CONFIG.potentialMultipliers[animal.potential]?.stamina || 1.0;
            const levelGrowth = (animal.level - 1) * LEVEL_CONFIG.baseGrowth.stamina;
            
            let breakdown = `<div class="font-semibold text-green-300 mb-2">ä½“åŠ›åŠ æˆè¯¦æƒ…ï¼š</div>`;
            breakdown += `<div>â€¢ åŸºç¡€ä½“åŠ›: ${baseStamina}</div>`;
            
            if (rarityMultiplier > 1.0) {
                const rarityBonus = Math.floor(baseStamina * (rarityMultiplier - 1.0));
                breakdown += `<div>â€¢ ç¨€æœ‰åº¦åŠ æˆ (${animal.rarity || 'æ™®é€š'}): +${rarityBonus} (Ã—${rarityMultiplier})</div>`;
            }
            
            if (potentialMultiplier > 1.0) {
                const potentialBonus = Math.floor(levelGrowth * (potentialMultiplier - 1.0));
                breakdown += `<div>â€¢ æ½œåŠ›åŠ æˆ (${animal.potential}): +${potentialBonus} (Ã—${potentialMultiplier})</div>`;
            }
            
            if (levelGrowth > 0) {
                breakdown += `<div>â€¢ ç­‰çº§æˆé•¿ (Lv.${animal.level}): +${Math.floor(levelGrowth * potentialMultiplier)}</div>`;
            }
            
            // å˜å¼‚åŠ æˆ
            if (animal.mutations?.tier1) {
                const mutConfig = getMutationConfig(animal.mutations.tier1);
                if (mutConfig?.stats?.stamina) {
                    breakdown += `<div>â€¢ ä¸€çº§å˜å¼‚ (${animal.mutations.tier1}): +${mutConfig.stats.stamina}</div>`;
                }
            }
            
            if (animal.mutations?.tier2) {
                const tier2Config = MUTATION_CONFIG.tier2[animal.mutations.tier2];
                if (tier2Config?.stats?.stamina) {
                    breakdown += `<div>â€¢ äºŒçº§å˜å¼‚ (${animal.mutations.tier2}): +${tier2Config.stats.stamina}</div>`;
                }
            }
            
            breakdown += `<div class="mt-2 pt-2 border-t border-gray-700 font-bold text-green-400">æ€»è®¡: ${animal.maxStamina}</div>`;
            return breakdown;
        }
        
        // æ–°å¢ï¼šè®¡ç®—æˆ˜æ–—èƒ½åŠ›è¯¦ç»†åŠ æˆ
        function calculateCombatBreakdown(animal) {
            const baseStats = { attack: 10, defense: 5, agility: 8 };
            const rarityMultiplier = getRarityMultiplier(animal.rarity);
            const potentialMultiplier = LEVEL_CONFIG.potentialMultipliers[animal.potential]?.combat || 1.0;
            const levelGrowth = (animal.level - 1);
            
            const breakdown = {
                attack: [],
                defense: [],
                agility: []
            };
            
            // æ”»å‡»åŠ›
            breakdown.attack.push(`åŸºç¡€: ${baseStats.attack}`);
            if (rarityMultiplier > 1.0) {
                const bonus = Math.floor(baseStats.attack * (rarityMultiplier - 1.0));
                breakdown.attack.push(`ç¨€æœ‰åº¦ (${animal.rarity}): +${bonus}`);
            }
            if (levelGrowth > 0) {
                const growth = Math.ceil(levelGrowth * LEVEL_CONFIG.baseGrowth.attack * potentialMultiplier);
                breakdown.attack.push(`ç­‰çº§æˆé•¿: +${growth}`);
            }
            if (animal.mutations?.tier1) {
                const mutConfig = getMutationConfig(animal.mutations.tier1);
                if (mutConfig?.stats?.attack) {
                    breakdown.attack.push(`ä¸€çº§å˜å¼‚: +${mutConfig.stats.attack}`);
                }
            }
            if (animal.mutations?.tier2) {
                const tier2Config = MUTATION_CONFIG.tier2[animal.mutations.tier2];
                if (tier2Config?.stats?.attack) {
                    breakdown.attack.push(`äºŒçº§å˜å¼‚: +${tier2Config.stats.attack}`);
                }
            }
            
            // é˜²å¾¡åŠ›
            breakdown.defense.push(`åŸºç¡€: ${baseStats.defense}`);
            if (rarityMultiplier > 1.0) {
                const bonus = Math.floor(baseStats.defense * (rarityMultiplier - 1.0));
                breakdown.defense.push(`ç¨€æœ‰åº¦ (${animal.rarity}): +${bonus}`);
            }
            if (levelGrowth > 0) {
                const growth = Math.ceil(levelGrowth * LEVEL_CONFIG.baseGrowth.defense * potentialMultiplier);
                breakdown.defense.push(`ç­‰çº§æˆé•¿: +${growth}`);
            }
            if (animal.mutations?.tier1) {
                const mutConfig = getMutationConfig(animal.mutations.tier1);
                if (mutConfig?.stats?.defense) {
                    breakdown.defense.push(`ä¸€çº§å˜å¼‚: +${mutConfig.stats.defense}`);
                }
            }
            if (animal.mutations?.tier2) {
                const tier2Config = MUTATION_CONFIG.tier2[animal.mutations.tier2];
                if (tier2Config?.stats?.defense) {
                    breakdown.defense.push(`äºŒçº§å˜å¼‚: +${tier2Config.stats.defense}`);
                }
            }
            
            // æ•æ·
            breakdown.agility.push(`åŸºç¡€: ${baseStats.agility}`);
            if (rarityMultiplier > 1.0) {
                const bonus = Math.floor(baseStats.agility * (rarityMultiplier - 1.0));
                breakdown.agility.push(`ç¨€æœ‰åº¦ (${animal.rarity}): +${bonus}`);
            }
            if (levelGrowth > 0) {
                const growth = Math.ceil(levelGrowth * LEVEL_CONFIG.baseGrowth.agility * potentialMultiplier);
                breakdown.agility.push(`ç­‰çº§æˆé•¿: +${growth}`);
            }
            if (animal.mutations?.tier1) {
                const mutConfig = getMutationConfig(animal.mutations.tier1);
                if (mutConfig?.stats?.agility) {
                    breakdown.agility.push(`ä¸€çº§å˜å¼‚: +${mutConfig.stats.agility}`);
                }
            }
            if (animal.mutations?.tier2) {
                const tier2Config = MUTATION_CONFIG.tier2[animal.mutations.tier2];
                if (tier2Config?.stats?.agility) {
                    breakdown.agility.push(`äºŒçº§å˜å¼‚: +${tier2Config.stats.agility}`);
                }
            }
            
            return breakdown;
        }
        
        // æ–°å¢ï¼šè·å–ç¨€æœ‰åº¦å€ç‡
        function getRarityMultiplier(rarity) {
            const multipliers = {
                'æ™®é€š': 1.0,
                'é—ªå…‰': 1.25,
                'å¹»å½©': 1.5,
                'æ˜ŸèŠ’': 2.0
            };
            return multipliers[rarity] || 1.0;
        }
        
        // æ–°å¢ï¼šåˆ‡æ¢æˆ˜æ–—èƒ½åŠ›è¯¦ç»†ä¿¡æ¯æ˜¾ç¤º
        function toggleCombatBreakdown(breakdown) {
            const breakdownDiv = document.getElementById('combat-breakdown');
            if (breakdownDiv.classList.contains('hidden')) {
                let html = '<div class="font-semibold text-red-300 mb-2">æˆ˜æ–—èƒ½åŠ›åŠ æˆè¯¦æƒ…ï¼š</div>';
                html += `<div class="mb-2"><span class="text-red-400">âš”ï¸ æ”»å‡»:</span> ${breakdown.attack.join(' | ')}</div>`;
                html += `<div class="mb-2"><span class="text-blue-400">ğŸ›¡ï¸ é˜²å¾¡:</span> ${breakdown.defense.join(' | ')}</div>`;
                html += `<div><span class="text-yellow-400">âš¡ æ•æ·:</span> ${breakdown.agility.join(' | ')}</div>`;
                breakdownDiv.innerHTML = html;
                breakdownDiv.classList.remove('hidden');
            } else {
                breakdownDiv.classList.add('hidden');
            }
        }

        // æ–°å¢ï¼šæ¸²æŸ“ç¨€æœ‰åº¦ä¿¡æ¯
        function renderRarityInfo(animal) {
            const rarityText = document.getElementById('rarity-text');
            if (!rarityText) return;
            
            const rarity = animal.rarity || 'æ™®é€š';
            const rarityColors = {
                'æ™®é€š': 'text-gray-400',
                'é—ªå…‰': 'text-yellow-400',
                'å¹»å½©': 'text-pink-400',
                'æ˜ŸèŠ’': 'text-purple-500'
            };
            
            const rarityIcons = {
                'æ™®é€š': '',
                'é—ªå…‰': 'âœ¨',
                'å¹»å½©': 'ğŸŒˆ',
                'æ˜ŸèŠ’': 'â­'
            };
            
            rarityText.textContent = `${rarityIcons[rarity] || ''} ${rarity}`;
            rarityText.className = `text-sm font-bold ${rarityColors[rarity] || 'text-gray-400'}`;
        }

        // æ¸²æŸ“å˜å¼‚ç±»å‹ï¼ˆåœ¨å±æ€§æ ‡ç­¾é¡µï¼‰
        function renderMutationTypes(animal) {
            const typesList = document.getElementById('mutation-types-list');
            if (!typesList) return;
            
            typesList.innerHTML = '';
            
            if (!animal.mutations || (!animal.mutations.tier1 && !animal.mutations.tier2 && (!animal.mutations.history || animal.mutations.history.length === 0))) {
                typesList.innerHTML = '<p class="text-xs text-gray-500">æœªè¿›è¡Œå˜å¼‚</p>';
                return;
            }
            
            // æ˜¾ç¤ºäºŒçº§å˜å¼‚
            if (animal.mutations.tier2) {
                const tier2Config = MUTATION_CONFIG.tier2[animal.mutations.tier2];
                const div = document.createElement('div');
                div.className = 'bg-yellow-900/20 border border-yellow-500/40 rounded px-2 py-1 flex items-center gap-2';
                div.innerHTML = `
                    <span class="text-lg">${tier2Config.icon}</span>
                    <span class="text-xs font-bold text-yellow-300">${animal.mutations.tier2}çº§å˜å¼‚</span>
                `;
                typesList.appendChild(div);
            }
            
            // æ˜¾ç¤ºå½“å‰ä¸€çº§å˜å¼‚
            if (animal.mutations.tier1) {
                const tier1Config = getMutationConfig(animal.mutations.tier1);
                if (tier1Config) {
                    const rarityColors = {
                        basic: 'bg-gray-700/40 border-gray-500/40 text-gray-300',
                        elite: 'bg-purple-900/20 border-purple-500/40 text-purple-300',
                        legendary: 'bg-pink-900/20 border-pink-500/40 text-pink-300'
                    };
                    const colorClass = rarityColors[tier1Config.rarity] || rarityColors.basic;
                    
                    const div = document.createElement('div');
                    div.className = `${colorClass} border rounded px-2 py-1 flex items-center gap-2`;
                    div.innerHTML = `
                        <span class="text-lg">${tier1Config.icon}</span>
                        <span class="text-xs font-bold">${animal.mutations.tier1}</span>
                        <span class="text-xs text-gray-400">(å½“å‰)</span>
                    `;
                    typesList.appendChild(div);
                }
            }
            
            // æ˜¾ç¤ºå†å²å˜å¼‚è®°å½•
            if (animal.mutations.history && animal.mutations.history.length > 0) {
                const historyHeader = document.createElement('div');
                historyHeader.className = 'text-xs text-gray-500 mt-2 mb-1';
                historyHeader.textContent = 'ğŸ“œ å˜å¼‚å†å²';
                typesList.appendChild(historyHeader);
                
                animal.mutations.history.forEach(historyItem => {
                    const rarityColors = {
                        basic: 'bg-gray-800/40 border-gray-600/40 text-gray-400',
                        elite: 'bg-purple-900/10 border-purple-600/40 text-purple-400',
                        legendary: 'bg-pink-900/10 border-pink-600/40 text-pink-400'
                    };
                    const colorClass = rarityColors[historyItem.rarity] || rarityColors.basic;
                    
                    const div = document.createElement('div');
                    div.className = `${colorClass} border rounded px-2 py-1 flex items-center gap-2 opacity-70`;
                    div.innerHTML = `
                        <span class="text-sm">${historyItem.icon}</span>
                        <span class="text-xs">${historyItem.name}</span>
                    `;
                    typesList.appendChild(div);
                });
            }
            
            // æ¸²æŸ“ä¼ è¯´çº§æœºåˆ¶
            renderLegendaryMechanism(animal);
        }
        
        // æ¸²æŸ“ä¼ è¯´çº§æœºåˆ¶ï¼ˆåœ¨å±æ€§æ ‡ç­¾é¡µï¼‰
        function renderLegendaryMechanism(animal) {
            const mechanismDisplay = document.getElementById('legendary-mechanism-display');
            const mechanismContent = document.getElementById('legendary-mechanism-content');
            
            if (!mechanismDisplay || !mechanismContent) return;
            
            mechanismContent.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¼ è¯´çº§å˜å¼‚
            if (!animal.mutations || !animal.mutations.tier1) {
                mechanismDisplay.classList.add('hidden');
                return;
            }
            
            const tier1Config = getMutationConfig(animal.mutations.tier1);
            if (!tier1Config || tier1Config.rarity !== 'legendary' || !tier1Config.mechanism) {
                mechanismDisplay.classList.add('hidden');
                return;
            }
            
            // æ˜¾ç¤ºæœºåˆ¶
            mechanismDisplay.classList.remove('hidden');
            
            const mechanismDescriptions = {
                'production': 'ğŸ“¦ ç”Ÿäº§åŠ é€Ÿï¼šåŸºå»ºç”Ÿäº§é€Ÿåº¦+50%',
                'team_buff': 'ğŸ’« å›¢é˜Ÿå¢ç›Šï¼šå‡ºæˆ˜èƒŒåŒ…å…¨ä½“ç”Ÿå‘½+15%',
                'enemy_debuff': 'ğŸŒ‘ æ•Œæ–¹å‰Šå¼±ï¼šé™ä½æ•Œæ–¹å…¨ä½“10%æ”»å‡»/å‘½ä¸­',
                'speed_buff': 'âš¡ ç–¾é€Ÿå¢ç›Šï¼šé˜Ÿä¼å…¨ä½“æ”»å‡»é€Ÿåº¦/ç§»åŠ¨é€Ÿåº¦+25%'
            };
            
            const mechanismDesc = mechanismDescriptions[tier1Config.mechanism] || tier1Config.mechanism;
            
            const div = document.createElement('div');
            div.className = 'bg-gradient-to-r from-pink-900/30 to-purple-900/30 border-2 border-pink-500/50 rounded px-3 py-2';
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-lg">${tier1Config.icon}</span>
                    <div class="flex-1">
                        <div class="text-xs font-bold text-pink-300">${animal.mutations.tier1} - ç‰¹æ®Šæœºåˆ¶</div>
                        <div class="text-xs text-gray-300 mt-1">${mechanismDesc}</div>
                    </div>
                </div>
            `;
            mechanismContent.appendChild(div);
        }

        // æ¸²æŸ“å˜å¼‚æŠ€èƒ½ï¼ˆåœ¨èƒ½åŠ›æ ‡ç­¾é¡µï¼Œä¸æˆ˜æ–—æŠ€èƒ½åˆå¹¶ï¼‰
        function renderMutationSkills(animal) {
            const mutationSkillsContainer = document.getElementById('mutation-skills-in-abilities');
            if (!mutationSkillsContainer) return;
            
            mutationSkillsContainer.innerHTML = '';
            
            if (!animal.mutations || !animal.mutations.skills || animal.mutations.skills.length === 0) {
                return; // æ²¡æœ‰å˜å¼‚æŠ€èƒ½å°±ä¸æ˜¾ç¤º
            }
            
            // åˆ›å»ºå˜å¼‚æŠ€èƒ½æ ‡é¢˜
            const header = document.createElement('div');
            header.className = 'text-xs text-pink-400 font-semibold mb-1 flex items-center gap-1';
            header.innerHTML = 'ğŸ§¬ å˜å¼‚æˆ˜æ–—æŠ€èƒ½';
            mutationSkillsContainer.appendChild(header);
            
            // è¯»å–æŠ€èƒ½æ± ä»¥è·å–è‡ªå®šä¹‰æŠ€èƒ½ä¿¡æ¯
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            
            // æ˜¾ç¤ºæ‰€æœ‰å˜å¼‚æŠ€èƒ½ï¼ˆå¯è£…å¤‡ï¼‰
            animal.mutations.skills.forEach(skillKey => {
                // å…ˆä»é¢„å®šä¹‰å˜å¼‚æŠ€èƒ½ä¸­æŸ¥æ‰¾
                let skill = MUTATION_SKILLS[skillKey];
                let customSkill = null;
                
                // å¦‚æœä¸æ˜¯é¢„å®šä¹‰æŠ€èƒ½ï¼Œä»æŠ€èƒ½æ± ä¸­æŸ¥æ‰¾
                if (!skill) {
                    customSkill = skillPool.find(s => s.key === skillKey);
                    if (customSkill) {
                        skill = {
                            name: customSkill.name,
                            icon: customSkill.icon,
                            desc: customSkill.description || customSkill.desc || 'æ— æè¿°'
                        };
                    }
                }
                
                if (!skill) {
                    console.warn('å˜å¼‚æŠ€èƒ½æœªæ‰¾åˆ°:', skillKey);
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²è£…å¤‡
                const isEquipped = animal.combatSkills.equipped.includes(skillKey);
                
                const skillDiv = document.createElement('div');
                skillDiv.className = `skill-item-wrapper p-2 rounded cursor-pointer transition-colors border-2 border-pink-500/50 mb-1 flex items-center justify-between ${
                    isEquipped ? 'bg-purple-800 opacity-50' : 'bg-gradient-to-r from-pink-900/40 to-purple-900/40 hover:from-pink-800/50 hover:to-purple-800/50'
                }`;
                
                const tooltipHtml = generateSkillTooltip(skill, customSkill);
                
                skillDiv.innerHTML = `
                    ${tooltipHtml}
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">${skill.icon}</span>
                        <div class="flex-1">
                            <div class="text-xs font-bold text-pink-200">${skill.name}</div>
                            <div class="text-xs text-gray-400">${skill.desc}</div>
                        </div>
                    </div>
                    ${isEquipped ? '<span class="text-xs text-purple-300">å·²è£…å¤‡</span>' : '<span class="text-xs text-gray-500">ç‚¹å‡»è£…å¤‡</span>'}
                `;
                
                // å¦‚æœæœªè£…å¤‡ï¼Œå…è®¸ç‚¹å‡»è£…å¤‡
                if (!isEquipped) {
                    skillDiv.onclick = () => equipSkill(animal, skillKey);
                }
                
                mutationSkillsContainer.appendChild(skillDiv);
            });
            
            // æ·»åŠ åˆ†éš”çº¿
            const divider = document.createElement('div');
            divider.className = 'border-t border-gray-600 my-2';
            mutationSkillsContainer.appendChild(divider);
            
            // æ·»åŠ æˆ˜æ–—æŠ€èƒ½æ ‡é¢˜
            const combatHeader = document.createElement('div');
            combatHeader.className = 'text-xs text-gray-400 font-semibold mb-1';
            combatHeader.innerHTML = 'âš”ï¸ æˆ˜æ–—æŠ€èƒ½';
            mutationSkillsContainer.appendChild(combatHeader);
        }

        // è£…å¤‡æŠ€èƒ½ï¼ˆæ”¯æŒæˆ˜æ–—æŠ€èƒ½å’Œå˜å¼‚æŠ€èƒ½ï¼‰
        function equipSkill(animal, skillKey) {
            if (!animal || !skillKey) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²è£…å¤‡
            if (animal.combatSkills.equipped.includes(skillKey)) {
                showStatus('è¯¥æŠ€èƒ½å·²è£…å¤‡', 1500);
                return;
            }
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºæ§½ä½
            const emptySlotIndex = animal.combatSkills.equipped.findIndex((s, i) => !s || s === null);
            
            // è·å–æŠ€èƒ½åç§°ï¼ˆå¯èƒ½æ˜¯æˆ˜æ–—æŠ€èƒ½æˆ–å˜å¼‚æŠ€èƒ½ï¼‰
            const skillInfo = COMBAT_SKILLS[skillKey] || MUTATION_SKILLS[skillKey];
            const skillName = skillInfo ? skillInfo.name : 'æœªçŸ¥æŠ€èƒ½';
            
            if (emptySlotIndex !== -1) {
                animal.combatSkills.equipped[emptySlotIndex] = skillKey;
                showStatus(`âœ… å·²è£…å¤‡æŠ€èƒ½ï¼š${skillName}`, 2000);
            } else if (animal.combatSkills.equipped.length < 4) {
                animal.combatSkills.equipped.push(skillKey);
                showStatus(`âœ… å·²è£…å¤‡æŠ€èƒ½ï¼š${skillName}`, 2000);
            } else {
                showStatus('âŒ æŠ€èƒ½æ§½å·²æ»¡ï¼Œè¯·å…ˆå¸ä¸‹ä¸€ä¸ªæŠ€èƒ½', 2000);
                return;
            }
            
            saveGameState(); // ä¿å­˜çŠ¶æ€
            renderCombatSkills(animal);
            renderMutationSkills(animal); // åˆ·æ–°å˜å¼‚æŠ€èƒ½æ˜¾ç¤ºçŠ¶æ€
        }

        // å¸ä¸‹æŠ€èƒ½ï¼ˆæ”¯æŒæˆ˜æ–—æŠ€èƒ½å’Œå˜å¼‚æŠ€èƒ½ï¼‰
        function unequipSkill(animal, slotIndex) {
            if (!animal || slotIndex < 0 || slotIndex >= 4) return;
            
            const skillKey = animal.combatSkills.equipped[slotIndex];
            if (skillKey) {
                const skillInfo = COMBAT_SKILLS[skillKey] || MUTATION_SKILLS[skillKey];
                const skillName = skillInfo ? skillInfo.name : 'æœªçŸ¥æŠ€èƒ½';
                
                animal.combatSkills.equipped[slotIndex] = null;
                showStatus(`ğŸ”“ å·²å¸ä¸‹æŠ€èƒ½ï¼š${skillName}`, 2000);
                saveGameState(); // ä¿å­˜çŠ¶æ€
                renderCombatSkills(animal);
                renderMutationSkills(animal); // åˆ·æ–°å˜å¼‚æŠ€èƒ½æ˜¾ç¤ºçŠ¶æ€
            }
        }

        // æ‰“å¼€æŠ€èƒ½ç®¡ç†æ¨¡æ€æ¡†ï¼ˆé¢„ç•™åŠŸèƒ½ï¼‰
        function openSkillManagementModal() {
            if (!selectedAnimalId) {
                showStatus('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€åªåŠ¨ç‰©', 2000);
                return;
            }
            showStatus('ğŸ’¡ ç‚¹å‡»æŠ€èƒ½æ§½å¯å¸ä¸‹æŠ€èƒ½ï¼Œç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨å¯è£…å¤‡æŠ€èƒ½', 3000);
        }

        function switchPanel(panelName) {
            if (isActionInProgress) {
                showStatus("æ­£åœ¨è¿›è¡Œæ“ä½œï¼Œæ— æ³•åˆ‡æ¢é¢æ¿ã€‚", 2000);
                return;
            }

            ui.breedingPanel.classList.add('hidden');
            ui.fusionPanel.classList.add('hidden');
            ui.cultivationPanel.classList.add('hidden');
            ui.mutationPanel.classList.add('hidden'); // æ–°å¢

            // å¦‚æœæˆ‘ä»¬æ­£åœ¨ä»ç¹æ®–é¢æ¿åˆ‡æ¢èµ°ï¼Œæ¸…ç©ºç¹æ®–é€‰æ‹©
            if (currentActivePanel === 'breeding' && panelName !== 'breeding') {
                gameState.selectedAnimalsForBreeding = [];
            }
            // å¦‚æœæˆ‘ä»¬æ­£åœ¨ä»èåˆé¢æ¿åˆ‡æ¢èµ°ï¼Œæ¸…ç©ºèåˆé€‰æ‹©
            if (currentActivePanel === 'fusion' && panelName !== 'fusion') {
                gameState.selectedAnimalsForFusion = [];
            }

            // å¦‚æœæˆ‘ä»¬æ­£åœ¨ä»å…»æˆé¢æ¿åˆ‡æ¢èµ°ï¼Œè®°å½•å½“å‰é€‰ä¸­çš„åŠ¨ç‰©
            if (currentActivePanel === 'cultivation' && panelName !== 'cultivation') {
                lastSelectedAnimalIdInCultivation = selectedAnimalId;
            }

            // éšè—æ‰€æœ‰é¢æ¿
            ui.breedingPanel.classList.add('hidden');
            ui.fusionPanel.classList.add('hidden');
            ui.cultivationPanel.classList.add('hidden');

            // æ˜¾ç¤ºç›®æ ‡é¢æ¿å¹¶æ›´æ–°å…¶å†…å®¹
            if (panelName === 'cultivation') {
                ui.cultivationPanel.classList.remove('hidden');
                renderAnimalList();
                // æ¢å¤å…»æˆé¢æ¿çš„é€‰æ‹©
                showAnimalDetails(lastSelectedAnimalIdInCultivation);
            } else if (panelName === 'breeding') {
                ui.breedingPanel.classList.remove('hidden');
                renderBreedingPanel();
                showAnimalDetails(null); // æ¸…ç©ºè¯¦æƒ…é¢æ¿ï¼Œç­‰å¾…åœ¨ç¹æ®–åˆ—è¡¨ä¸­é€‰æ‹©
            } else if (panelName === 'fusion') {
                showAnimalDetails(null); // æ¸…ç©ºè¯¦æƒ…é¢æ¿
                ui.fusionPanel.classList.remove('hidden');
                renderFusionPanel();
            } else if (panelName === 'mutation') { // æ–°å¢
                showAnimalDetails(null);
                ui.mutationPanel.classList.remove('hidden');
                renderMutationPanel();
            }

            // æ›´æ–°å½“å‰æ¿€æ´»çš„é¢æ¿
            currentActivePanel = panelName;
        }

        function switchDetailTab(tabName) {
            const activeClass = 'text-white border-b-2 border-cyan-400';
            const inactiveClass = 'text-gray-400';

            ui.panelAttributes.classList.add('hidden');
            ui.panelAbilities.classList.add('hidden');
            ui.panelItems.classList.add('hidden'); // æ–°å¢
            ui.btnTabAttributes.className = `flex-1 text-sm py-1 text-center ${inactiveClass}`;
            ui.btnTabAbilities.className = `flex-1 text-sm py-1 text-center ${inactiveClass}`;
            ui.btnTabItems.className = `flex-1 text-sm py-1 text-center ${inactiveClass}`; // æ–°å¢

            let tabButton = ui.btnTabAttributes;
            let panel = ui.panelAttributes;
            if (tabName === 'abilities') { 
                tabButton = ui.btnTabAbilities; 
                panel = ui.panelAbilities; 
            } else if (tabName === 'items') { 
                tabButton = ui.btnTabItems; 
                panel = ui.panelItems; 
                renderItemPanel(); // æ–°å¢ï¼šæ¸²æŸ“é“å…·é¢æ¿
            } 

            tabButton.className = `flex-1 text-sm py-1 text-center ${activeClass}`;
            panel.classList.remove('hidden');
        }

        function showStatus(message, duration = 2500) {
            ui.statusMessage.textContent = message;
            setTimeout(() => {
                ui.statusMessage.textContent = '';
            }, duration);
        }

        // æ–°å¢ï¼šæ›´æ–°èµ„æºUIçš„å‡½æ•°
        function updateResourceUI() {
            ui.food.textContent = Math.floor(gameState.food).toLocaleString();
            ui.gems.textContent = gameState.gems;
            ui.animalCount.textContent = `${gameState.animalCount} / ${gameState.maxAnimals}`;
        }
        // --- æ¸²æŸ“å‡½æ•° ---

        function renderAnimalList() {
            ui.animalList.innerHTML = '';
            if (gameState.animals.length === 0) {
                ui.animalList.innerHTML = '<p class="text-sm text-gray-500 p-2">æ –æ¯åœ°ä¸­è¿˜æ²¡æœ‰åŠ¨ç‰©ã€‚</p>';
                return;
            }
            gameState.animals.forEach(animal => {
                const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                const listItem = document.createElement('div');
                let itemClass = 'roster-item flex items-center justify-between p-2 rounded-md hover:bg-gray-700 cursor-pointer transition-colors duration-150';
                if (animal.id === selectedAnimalId) {
                    itemClass += ' selected-detail';
                }
                listItem.className = itemClass;
                listItem.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div style="background-color: ${colorHex};" class="w-4 h-4 rounded-full border border-gray-400"></div>
                        <span class="font-medium text-indigo-300">${animal.name}</span>
                        <span title="${animal.element}" class="w-5 text-center">${ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤']}</span>
                        <span class="text-xs text-gray-400">${animal.isPlaced ? ' (å·²æ”¾ç½®)' : ''}</span>
                    </div>
                    <span class="text-sm text-yellow-400">Lv. ${animal.level}</span>`;
                listItem.addEventListener('click', () => {
                    selectedAnimalId = animal.id;
                    showAnimalDetails(animal.id);
                    renderAnimalList(); // é‡ç»˜åˆ—è¡¨ä»¥æ›´æ–°é«˜äº®
                });
                ui.animalList.appendChild(listItem);
            });
        }

        function showAnimalDetails(animalId) {
            selectedAnimalId = animalId; // ç»Ÿä¸€æ›´æ–° selectedAnimalId
            const animal = gameState.animals.find(a => a.id === animalId);
            if (!animal) {
                ui.animalDetailContent.classList.add('hidden');
                ui.animalDetailPlaceholder.classList.remove('hidden');
                selectedAnimalId = null; // å¦‚æœæ‰¾ä¸åˆ°åŠ¨ç‰©ï¼Œæ¸…ç©ºé€‰æ‹©
                return;
            }

            ui.animalDetailName.textContent = animal.name;
            ui.animalDetailLevel.textContent = `Lv. ${animal.level}`;
            ui.animalDetailElementTag.innerHTML = ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤'];
            ui.animalDetailElementTag.title = animal.element;
            ui.animalDetailGender.textContent = animal.gender;
            ui.animalDetailElementTag.className = `text-sm font-normal px-2 py-1 rounded ${ELEMENT_COLORS[animal.element] || ELEMENT_COLORS['é»˜è®¤']}`;
            ui.animalDetailGender.className = `text-sm font-normal px-2 py-1 rounded ${animal.gender === 'é›„' ? 'bg-blue-500' : 'bg-pink-500'}`;

            const expPercent = Math.min(100, (animal.experience / animal.experienceToNextLevel) * 100);
            ui.animalDetailExpText.textContent = `${Math.floor(animal.experience)} / ${animal.experienceToNextLevel}`;
            ui.animalDetailExpBar.style.width = `${expPercent}%`;

            // è®¡ç®—å¹¶æ˜¾ç¤ºè¯¦ç»†çš„å±æ€§åŠ æˆ
            const staminaBreakdown = calculateStaminaBreakdown(animal);
            ui.animalDetailStamina.textContent = `${animal.stamina} / ${animal.maxStamina}`;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤º/éšè—è¯¦ç»†ä¿¡æ¯
            ui.animalDetailStamina.parentElement.onclick = () => {
                const breakdownDiv = document.getElementById('stamina-breakdown');
                if (breakdownDiv.classList.contains('hidden')) {
                    breakdownDiv.innerHTML = staminaBreakdown;
                    breakdownDiv.classList.remove('hidden');
                } else {
                    breakdownDiv.classList.add('hidden');
                }
            };
            
            ui.animalDetailFavorability.textContent = animal.favorability;
            ui.animalDetailPotential.textContent = animal.potential;
            ui.animalDetailDevelopment.textContent = animal.developmentStage;

            // å¡«å……æˆ˜æ–—èƒ½åŠ›æ•°æ®
            const combatBreakdown = calculateCombatBreakdown(animal);
            ui.abilityCombatAtk.textContent = animal.abilities.combat.attack;
            ui.abilityCombatDef.textContent = animal.abilities.combat.defense;
            ui.abilityCombatAgi.textContent = animal.abilities.combat.agility;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ˜¾ç¤º/éšè—æˆ˜æ–—èƒ½åŠ›è¯¦ç»†ä¿¡æ¯
            ui.abilityCombatAtk.parentElement.onclick = () => toggleCombatBreakdown(combatBreakdown);
            ui.abilityCombatDef.parentElement.onclick = () => toggleCombatBreakdown(combatBreakdown);
            ui.abilityCombatAgi.parentElement.onclick = () => toggleCombatBreakdown(combatBreakdown);

            // æ¸²æŸ“ç¨€æœ‰åº¦ä¿¡æ¯
            renderRarityInfo(animal);

            // æ¸²æŸ“æˆ˜æ–—æŠ€èƒ½æ§½ã€å˜å¼‚æŠ€èƒ½å’Œå˜å¼‚ç±»å‹
            renderCombatSkills(animal);
            renderMutationSkills(animal);
            renderMutationTypes(animal);

            // å–‚å…»æŒ‰é’®é€»è¾‘
            const feedCost = animal.level * 10;
            const canFeed = gameState.food >= feedCost;
            ui.btnFeedAnimal.disabled = !canFeed;
            ui.btnFeedAnimal.textContent = canFeed ? `å–‚å…» (${feedCost} é£Ÿç‰©)` : `é£Ÿç‰©ä¸è¶³ (${feedCost})`;
            ui.btnFeedAnimal.onclick = () => feedAnimal(animal.id);

            // è¿å‡10çº§æŒ‰é’®é€»è¾‘
            const cost10 = calculateLevelUpCost(animal, 10);
            const canFeed10 = gameState.food >= cost10;
            ui.btnFeedAnimal10.disabled = !canFeed10;
            ui.btnFeedAnimal10.textContent = canFeed10 ? `è¿å‡10çº§ (${cost10})` : `é£Ÿç‰©ä¸è¶³ (${cost10})`;
            ui.btnFeedAnimal10.onclick = () => feedAnimalPlus10(animal.id);

            ui.btnRenameAnimal.style.display = 'inline-block'; // ç¡®ä¿æŒ‰é’®å¯è§

            ui.animalDetailContent.classList.remove('hidden');
            ui.animalDetailPlaceholder.classList.add('hidden');

            // å¦‚æœå½“å‰åœ¨é“å…·é¡µç­¾ï¼Œåˆ·æ–°é“å…·åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
            if (!ui.panelItems.classList.contains('hidden')) {
                renderItemPanel();
            }
        }

        function renderSelectionList(listElement, selectionArray, onSelectCallback) {
            listElement.innerHTML = '';
            if (gameState.animals.length === 0) {
                listElement.innerHTML = '<p class="text-sm text-gray-500 p-2">æ²¡æœ‰å¯ç”¨çš„åŠ¨ç‰©ã€‚</p>';
                return;
            }
            gameState.animals.forEach(animal => {
                const isSelected = selectionArray.includes(animal.id);
                const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
                let listItemClass = 'roster-item flex items-center justify-between p-2 rounded-md hover:bg-gray-700 cursor-pointer transition-colors duration-150';
                if (isSelected) {
                    listItemClass += ' selected-for-breeding';
                }
                const listItem = document.createElement('div');
                listItem.className = listItemClass;
                listItem.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <div style="background-color: ${colorHex};" class="w-4 h-4 rounded-full border border-gray-400"></div>
                                <span class="font-medium text-indigo-300">${animal.name}</span>
                                <span title="${animal.element}" class="w-5 text-center">${ELEMENT_ICONS[animal.element] || ELEMENT_ICONS['é»˜è®¤']}</span>
                                <span class="text-xs ${animal.gender === 'é›„' ? 'text-blue-400' : 'text-pink-400'}">${animal.gender === 'é›„' ? 'â™‚' : 'â™€'}</span>
                            </div>
                            <span class="text-sm text-yellow-400">Lv. ${animal.level}</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1 pl-6">
                            <span>${animal.developmentStage}</span> | <span>æ½œåŠ›: ${animal.potential}</span>
                        </div>
                    </div>
                    `;
                listItem.addEventListener('click', () => onSelectCallback(animal));
                listElement.appendChild(listItem);
            });
        }

        function renderBreedingPanel() {
            // æ¸²æŸ“ä¸¤ä¸ªçˆ¶æ¡†
            const parentSlots = [ui.parentDisplay1, ui.parentDisplay2];
            const placeholderTexts = ['ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©çˆ¶ä»£ 1', 'ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©çˆ¶ä»£ 2'];

            for (let i = 0; i < 2; i++) {
                const parentId = gameState.selectedAnimalsForBreeding[i];
                const parentAnimal = parentId ? gameState.animals.find(a => a.id === parentId) : null;
                const slot = parentSlots[i];

                if (parentAnimal) {
                    const colorHex = '#' + parentAnimal.color.toString(16).padStart(6, '0');
                    slot.innerHTML = `
                        <div class="p-2 text-left w-full">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div style="background-color: ${colorHex};" class="w-5 h-5 rounded-full border border-gray-400"></div>
                                    <span class="font-bold text-indigo-300">${parentAnimal.name}</span>
                                    <span class="text-sm ${parentAnimal.gender === 'é›„' ? 'text-blue-400' : 'text-pink-400'}">${parentAnimal.gender === 'é›„' ? 'â™‚' : 'â™€'}</span>
                                </div>
                                <span class="text-md text-yellow-400">Lv. ${parentAnimal.level}</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-2 pl-7">
                                <span>${parentAnimal.developmentStage}</span> | <span>æ½œåŠ›: ${parentAnimal.potential}</span>
                            </div>
                        </div>`;
                    slot.classList.remove('border-dashed', 'items-center', 'justify-center');
                } else {
                    slot.innerHTML = placeholderTexts[i];
                    slot.classList.add('border-dashed', 'items-center', 'justify-center');
                }
            }

            // æ¸²æŸ“ä¸‹æ–¹å¯é€‰åˆ—è¡¨
            renderSelectionList(ui.breedingAnimalList, gameState.selectedAnimalsForBreeding, toggleBreedingSelection);
            updateBreedingButton(); // ç»Ÿä¸€æ›´æ–°æŒ‰é’®çŠ¶æ€
        }

        function clearParentSelection(index) {
            if (gameState.selectedAnimalsForBreeding[index]) {
                gameState.selectedAnimalsForBreeding.splice(index, 1);
                showStatus('å·²æ¸…ç©ºä¸€ä¸ªçˆ¶ä»£é€‰æ‹©ã€‚', 1500);
                renderBreedingPanel();
            }
        }

        function renderFusionPanel() {
            // æ¸²æŸ“ä¸¤ä¸ªææ–™æ¡†
            const materialSlots = [ui.fusionMaterialDisplay1, ui.fusionMaterialDisplay2];
            const placeholderTexts = ['ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©ææ–™ 1', 'ç‚¹å‡»ä¸‹æ–¹åˆ—è¡¨<br>é€‰æ‹©ææ–™ 2'];

            for (let i = 0; i < 2; i++) {
                const materialId = gameState.selectedAnimalsForFusion[i];
                const materialAnimal = materialId ? gameState.animals.find(a => a.id === materialId) : null;
                const slot = materialSlots[i];

                if (materialAnimal) {
                    const colorHex = '#' + materialAnimal.color.toString(16).padStart(6, '0');
                    slot.innerHTML = `
                        <div class="p-2 text-left w-full">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <div style="background-color: ${colorHex};" class="w-5 h-5 rounded-full border border-gray-400"></div>
                                    <span class="font-bold text-indigo-300">${materialAnimal.name}</span>
                                    <span class="text-sm ${materialAnimal.gender === 'é›„' ? 'text-blue-400' : 'text-pink-400'}">${materialAnimal.gender === 'é›„' ? 'â™‚' : 'â™€'}</span>
                                </div>
                                <span class="text-md text-yellow-400">Lv. ${materialAnimal.level}</span>
                            </div>
                            <div class="text-xs text-gray-400 mt-2 pl-7">
                                <span>${materialAnimal.developmentStage}</span> | <span>æ½œåŠ›: ${materialAnimal.potential}</span>
                            </div>
                        </div>`;
                    slot.classList.remove('border-dashed', 'items-center', 'justify-center');
                } else {
                    slot.innerHTML = placeholderTexts[i];
                    slot.classList.add('border-dashed', 'items-center', 'justify-center');
                }
            }

            // æ¸²æŸ“ä¸‹æ–¹å¯é€‰åˆ—è¡¨
            renderSelectionList(ui.fusionAnimalList, gameState.selectedAnimalsForFusion, toggleFusionSelection);
            updateFusionButton();
        }

        function clearFusionMaterialSelection(index) {
            if (gameState.selectedAnimalsForFusion[index]) {
                gameState.selectedAnimalsForFusion.splice(index, 1);
                showStatus('å·²æ¸…ç©ºä¸€ä¸ªææ–™é€‰æ‹©ã€‚', 1500);
                renderFusionPanel();
            }
        }

        // --- å˜å¼‚ç³»ç»Ÿé€»è¾‘ ---

        function renderMutationPanel() {
            ui.mutationAnimalList.innerHTML = '';
            ui.mutationResultLog.textContent = '';
            
            const eligibleAnimals = gameState.animals.filter(a => a.level > 10);

            if (eligibleAnimals.length === 0) {
                ui.mutationAnimalList.innerHTML = '<p class="text-gray-500 text-center p-4">æ²¡æœ‰ç­‰çº§ > 10 çš„åŠ¨ç‰©ã€‚</p>';
                return;
            }

            eligibleAnimals.forEach(animal => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-700 rounded cursor-pointer hover:bg-gray-600 flex justify-between items-center';
                if (selectedAnimalId === animal.id) div.classList.add('border', 'border-pink-500');
                
                // æ˜¾ç¤ºå½“å‰å˜å¼‚çŠ¶æ€
                const mutationDisplay = getMutationDisplay(animal);
                
                div.innerHTML = `
                    <div>
                        <div>${animal.name} ${mutationDisplay}</div>
                        <div class="text-xs text-gray-400">å˜å¼‚: ${animal.mutationCount || 0}æ¬¡</div>
                    </div>
                    <span class="text-xs text-yellow-400">Lv.${animal.level}</span>
                `;
                div.onclick = () => selectMutationTarget(animal);
                ui.mutationAnimalList.appendChild(div);
            });
        }

        function getMutationDisplay(animal) {
            if (!animal.mutations) return '';
            let display = '';
            if (animal.mutations.tier2) {
                display += MUTATION_CONFIG.tier2[animal.mutations.tier2].icon;
            }
            if (animal.mutations.tier1) {
                const config = getMutationConfig(animal.mutations.tier1);
                if (config) display += config.icon;
            }
            return display;
        }

        function getMutationConfig(mutationName) {
            for (const tier of Object.values(MUTATION_CONFIG.tier1)) {
                if (tier[mutationName]) return tier[mutationName];
            }
            return null;
        }

        function selectMutationTarget(animal) {
            selectedAnimalId = animal.id;
            showAnimalDetails(animal.id);
            renderMutationPanel();

            const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
            const mutationDisplay = getMutationDisplay(animal);
            
            ui.mutationTargetDisplay.innerHTML = `
                <div class="flex flex-col items-center">
                    <div style="background-color: ${colorHex};" class="w-12 h-12 rounded-full border-2 border-pink-400 mb-2"></div>
                    <div class="font-bold text-lg">${animal.name} ${mutationDisplay}</div>
                    <div class="text-xs text-gray-400">å˜å¼‚æ¬¡æ•°: ${animal.mutationCount || 0}</div>
                </div>
            `;
            ui.mutationTargetDisplay.classList.remove('border-dashed');

            ui.mutationStats.classList.remove('hidden');
            
            const serumCount = (gameState.inventory && gameState.inventory['mutation_serum']) || 0;
            ui.mutCost.innerHTML = `ğŸ’‰ å˜å¼‚è¡€æ¸… x1 <span class="text-xs text-gray-400">(æ‹¥æœ‰: ${serumCount})</span>`;
            const hasSerum = serumCount >= 1;
            ui.mutCost.className = hasSerum ? 'font-mono text-green-400' : 'font-mono text-red-400';
            
            // ç§»é™¤å˜å¼‚å†·å´æ£€æŸ¥
            const canMutate = hasSerum && !isActionInProgress;
            
            ui.btnExecuteMutation.disabled = !canMutate;
            
            if (!hasSerum) {
                ui.btnExecuteMutation.textContent = "ç¼ºå°‘å˜å¼‚è¡€æ¸…";
            } else {
                ui.btnExecuteMutation.textContent = "ğŸ§¬ å¼€å§‹ä¸€çº§å˜å¼‚";
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥å˜å¼‚å†·å´æœŸï¼ˆå·²æš‚æ—¶ç¦ç”¨ï¼‰
        function checkMutationCooldown(animal) {
            return 0; // æš‚æ—¶ç§»é™¤å†·å´é™åˆ¶
        }

        function executeMutation() {
            if (!selectedAnimalId || isActionInProgress) return;
            const animal = gameState.animals.find(a => a.id === selectedAnimalId);
            if (!animal) return;
            if ((gameState.inventory['mutation_serum'] || 0) < 1) return showStatus("âŒ ç¼ºå°‘å˜å¼‚è¡€æ¸…ï¼", 2000);

            // åˆå§‹åŒ–å˜å¼‚å¯¹è±¡
            if (!animal.mutations) {
                animal.mutations = { tier1: null, tier2: null, skills: [], currentSkills: [] };
            }

            isActionInProgress = true;
            ui.btnExecuteMutation.disabled = true;
            ui.btnExecuteMutation.textContent = "å˜å¼‚ä¸­...";
            ui.mutationResultLog.textContent = "æ­£åœ¨æ³¨å…¥å˜å¼‚å› å­...\n";

            gameState.inventory['mutation_serum']--;
            updateResourceUI();

            setTimeout(() => {
                const result = performTier1Mutation(animal, animal.mutations?.tier1, animal.mutations?.tier1 ? getMutationConfig(animal.mutations.tier1)?.rarity : null);
                
                ui.mutationResultLog.textContent += result.log;
                ui.mutationResultIcon.textContent = result.success ? "ğŸ§¬" : "ğŸ’¥";
                ui.mutationResultTitle.textContent = "ä¸€çº§å˜å¼‚" + (result.success ? "æˆåŠŸï¼" : "å¤±è´¥");
                ui.mutationResultTitle.className = result.success ? "text-2xl font-bold text-green-400" : "text-2xl font-bold text-red-500";
                ui.mutationResultContent.innerHTML = result.changeDesc;

                // é‡ç½®çŠ¶æ€å¹¶åˆ·æ–°UIï¼ˆå¿…é¡»åœ¨setTimeoutå†…éƒ¨ï¼‰
                isActionInProgress = false;
                saveGameState(); // ä¿å­˜çŠ¶æ€
                
                // åˆ·æ–°å˜å¼‚ç›®æ ‡æ˜¾ç¤º
                selectMutationTarget(animal);
                
                // å¼ºåˆ¶åˆ‡æ¢åˆ°èƒ½åŠ›æ ‡ç­¾é¡µå¹¶åˆ·æ–°è¯¦æƒ…ä»¥æ˜¾ç¤ºæ–°è·å¾—çš„å˜å¼‚æŠ€èƒ½
                if (result.success) {
                    showAnimalDetails(animal.id);
                    switchDetailTab('abilities');
                    // ç¡®ä¿å˜å¼‚æŠ€èƒ½åŒºåŸŸè¢«æ¸²æŸ“
                    renderMutationSkills(animal);
                }
                
                updateResourceUI();
                
                ui.mutationResultModal.classList.remove('hidden');
            }, 2000);
        }
        
        function executeTier2Mutation() {
            if (!selectedAnimalId || isActionInProgress) return;
            const animal = gameState.animals.find(a => a.id === selectedAnimalId);
            if (!animal) return;
            if ((gameState.inventory['mutation_serum'] || 0) < 1) return showStatus("âŒ ç¼ºå°‘å˜å¼‚è¡€æ¸…ï¼", 2000);
            
            isActionInProgress = true;
            const btn = document.getElementById('btn-execute-tier2-mutation');
            const log = document.getElementById('mutation-tier2-result-log');
            btn.disabled = true;
            btn.textContent = "å˜å¼‚ä¸­...";
            log.textContent = "æ­£åœ¨æ³¨å…¥äºŒçº§å˜å¼‚å› å­...\n";
            
            gameState.inventory['mutation_serum']--;
            
            setTimeout(() => {
                const result = performTier2Mutation(animal);
                
                log.textContent += result.log;
                ui.mutationResultIcon.textContent = result.success ? "ğŸ§¬" : "ğŸ’¥";
                ui.mutationResultTitle.textContent = "äºŒçº§å˜å¼‚" + (result.success ? "æˆåŠŸï¼" : "å¤±è´¥");
                ui.mutationResultTitle.className = result.success ? "text-2xl font-bold text-green-400" : "text-2xl font-bold text-red-500";
                ui.mutationResultContent.innerHTML = result.changeDesc;
                
                isActionInProgress = false;
                saveGameState(); // ä¿å­˜çŠ¶æ€
                
                // åˆ·æ–°å˜å¼‚ç›®æ ‡æ˜¾ç¤º
                selectTier2MutationTarget(animal);
                
                // å¼ºåˆ¶åˆ‡æ¢åˆ°èƒ½åŠ›æ ‡ç­¾é¡µå¹¶åˆ·æ–°è¯¦æƒ…
                if (result.success) {
                    showAnimalDetails(animal.id);
                    switchDetailTab('abilities');
                    renderMutationSkills(animal);
                }
                
                updateResourceUI();
                ui.mutationResultModal.classList.remove('hidden');
            }, 2000);
        }
                

        function switchMutationTab(tab) {
            const tier1Content = document.getElementById('mutation-tier1-content');
            const tier2Content = document.getElementById('mutation-tier2-content');
            const btn1 = document.getElementById('btn-mutation-tier1');
            const btn2 = document.getElementById('btn-mutation-tier2');
            
            if (tab === 'tier1') {
                tier1Content.classList.remove('hidden');
                tier2Content.classList.add('hidden');
                btn1.className = 'px-4 py-2 rounded-lg font-semibold transition-all bg-gradient-to-r from-pink-600 to-pink-500 text-white shadow-lg hover:shadow-pink-500/50';
                btn2.className = 'px-4 py-2 rounded-lg font-semibold transition-all bg-gray-700 text-gray-300 hover:bg-gray-600';
                renderMutationPanel();
            } else {
                tier1Content.classList.add('hidden');
                tier2Content.classList.remove('hidden');
                btn1.className = 'px-4 py-2 rounded-lg font-semibold transition-all bg-gray-700 text-gray-300 hover:bg-gray-600';
                btn2.className = 'px-4 py-2 rounded-lg font-semibold transition-all bg-gradient-to-r from-yellow-600 to-orange-600 text-white shadow-lg hover:shadow-yellow-500/50';
                renderTier2MutationPanel();
            }
        }

        function renderTier2MutationPanel() {
            const list = document.getElementById('mutation-tier2-animal-list');
            const log = document.getElementById('mutation-tier2-result-log');
            list.innerHTML = '';
            log.textContent = '';
            
            const eligibleAnimals = gameState.animals.filter(a => a.level > 10 && a.mutations && a.mutations.tier1);
            
            if (eligibleAnimals.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center p-4">æ²¡æœ‰å·²è¿›è¡Œä¸€çº§å˜å¼‚çš„åŠ¨ç‰©ã€‚</p>';
                return;
            }
            
            eligibleAnimals.forEach(animal => {
                const div = document.createElement('div');
                div.className = 'p-2 bg-gray-700 rounded cursor-pointer hover:bg-gray-600 flex justify-between items-center';
                if (selectedAnimalId === animal.id) div.classList.add('border', 'border-yellow-500');
                
                const mutationDisplay = getMutationDisplay(animal);
                div.innerHTML = `
                    <div>
                        <div>${animal.name} ${mutationDisplay}</div>
                        <div class="text-xs text-gray-400">äºŒçº§: ${animal.mutations.tier2 || 'æœªå˜å¼‚'}</div>
                    </div>
                    <span class="text-xs text-yellow-400">Lv.${animal.level}</span>
                `;
                div.onclick = () => selectTier2MutationTarget(animal);
                list.appendChild(div);
            });
        }

        function selectTier2MutationTarget(animal) {
            selectedAnimalId = animal.id;
            showAnimalDetails(animal.id);
            renderTier2MutationPanel();
            
            const colorHex = '#' + animal.color.toString(16).padStart(6, '0');
            const mutationDisplay = getMutationDisplay(animal);
            const targetDisplay = document.getElementById('mutation-tier2-target-display');
            
            targetDisplay.innerHTML = `
                <div class="flex flex-col items-center">
                    <div style="background-color: ${colorHex};" class="w-12 h-12 rounded-full border-2 border-yellow-400 mb-2"></div>
                    <div class="font-bold text-lg">${animal.name} ${mutationDisplay}</div>
                    <div class="text-xs text-gray-400">å½“å‰äºŒçº§: ${animal.mutations.tier2 || 'æ— '}</div>
                </div>
            `;
            targetDisplay.classList.remove('border-dashed');
            
            const stats = document.getElementById('mutation-tier2-stats');
            stats.classList.remove('hidden');
            
            const serumCount = (gameState.inventory && gameState.inventory['mutation_serum']) || 0;
            document.getElementById('mut-tier2-cost').innerHTML = `ğŸ’‰ å˜å¼‚è¡€æ¸… x1 <span class="text-xs text-gray-400">(æ‹¥æœ‰: ${serumCount})</span>`;
            
            // ç§»é™¤äºŒçº§å˜å¼‚å†·å´æ£€æŸ¥
            const hasSerum = serumCount >= 1;
            const canMutate = hasSerum && !isActionInProgress;
            
            const btn = document.getElementById('btn-execute-tier2-mutation');
            btn.disabled = !canMutate;
            
            if (!hasSerum) {
                btn.textContent = "ç¼ºå°‘å˜å¼‚è¡€æ¸…";
            } else {
                btn.textContent = "âš¡ å¼€å§‹äºŒçº§å˜å¼‚";
            }
        }
        
        // æ–°å¢ï¼šæ£€æŸ¥äºŒçº§å˜å¼‚å†·å´æœŸï¼ˆå·²æš‚æ—¶ç¦ç”¨ï¼‰
        function checkTier2MutationCooldown(animal) {
            return 0; // æš‚æ—¶ç§»é™¤å†·å´é™åˆ¶
        }

        function executeTier2Mutation() {
            if (!selectedAnimalId || isActionInProgress) return;
            const animal = gameState.animals.find(a => a.id === selectedAnimalId);
            if (!animal) return;
            if ((gameState.inventory['mutation_serum'] || 0) < 1) return showStatus("âŒ ç¼ºå°‘å˜å¼‚è¡€æ¸…ï¼", 2000);
            
            isActionInProgress = true;
            const btn = document.getElementById('btn-execute-tier2-mutation');
            const log = document.getElementById('mutation-tier2-result-log');
            btn.disabled = true;
            btn.textContent = "å˜å¼‚ä¸­...";
            log.textContent = "æ­£åœ¨æ³¨å…¥äºŒçº§å˜å¼‚å› å­...\n";
            
            gameState.inventory['mutation_serum']--;
            
            setTimeout(() => {
                const result = performTier2Mutation(animal);
                
                log.textContent += result.log;
                ui.mutationResultIcon.textContent = result.success ? "âš¡" : "ğŸ’¥";
                ui.mutationResultTitle.textContent = result.success ? "äºŒçº§å˜å¼‚æˆåŠŸï¼" : "äºŒçº§å˜å¼‚å¤±è´¥";
                ui.mutationResultTitle.className = result.success ? "text-2xl font-bold text-green-400" : "text-2xl font-bold text-red-500";
                ui.mutationResultContent.innerHTML = result.changeDesc;
                
                isActionInProgress = false;
                saveGameState(); // ä¿å­˜çŠ¶æ€
                
                // åˆ·æ–°å˜å¼‚ç›®æ ‡æ˜¾ç¤º
                selectTier2MutationTarget(animal);
                
                // å¼ºåˆ¶åˆ‡æ¢åˆ°èƒ½åŠ›æ ‡ç­¾é¡µå¹¶åˆ·æ–°è¯¦æƒ…
                if (result.success) {
                    showAnimalDetails(animal.id);
                    switchDetailTab('abilities');
                    renderMutationSkills(animal);
                }
                
                updateResourceUI();
                ui.mutationResultModal.classList.remove('hidden');
            }, 2000);
        }

        function performTier1Mutation(animal, currentMutation, currentRarity) {
            let targetRarity, mutationName, config;
            
            if (!currentMutation) {
                // é¦–æ¬¡å˜å¼‚ - ä½¿ç”¨æ ‡å‡†æ¦‚ç‡
                const roll = Math.random() * 100;
                if (roll < 80) {
                    targetRarity = 'basic';
                    const options = Object.keys(MUTATION_CONFIG.tier1.basic);
                    mutationName = options[Math.floor(Math.random() * options.length)];
                } else if (roll < 98) {
                    targetRarity = 'elite';
                    const options = Object.keys(MUTATION_CONFIG.tier1.elite);
                    mutationName = options[Math.floor(Math.random() * options.length)];
                } else {
                    targetRarity = 'legendary';
                    const options = Object.keys(MUTATION_CONFIG.tier1.legendary);
                    mutationName = options[Math.floor(Math.random() * options.length)];
                }
            } else {
                // å·²æœ‰å˜å¼‚ - ä½¿ç”¨äº²å’Œé“¾è§„åˆ™
                const result = calculateAffinityMutation(currentMutation, currentRarity);
                targetRarity = result.rarity;
                mutationName = result.mutation;
            }

            // ä¿®æ­£ï¼šç¡®ä¿ config è¢«æ­£ç¡®èµ‹å€¼
            config = MUTATION_CONFIG.tier1[targetRarity]?.[mutationName];
            
            // å¦‚æœ config æœªå®šä¹‰ï¼Œè¯´æ˜å‡ºç°é”™è¯¯ï¼Œæå‰é€€å‡º
            if (!config) {
                console.error("Mutation failed: Could not find config for", targetRarity, mutationName);
                return { success: false, log: "å˜å¼‚å¤±è´¥ï¼šæœªæ‰¾åˆ°é…ç½®ã€‚", changeDesc: "<p>å˜å¼‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>" };
            }
            
            // åˆå§‹åŒ–å˜å¼‚å†å²æ•°ç»„
            if (!animal.mutations.history) {
                animal.mutations.history = [];
            }
            
            // åº”ç”¨å˜å¼‚
            const oldMutation = animal.mutations.tier1;
            const oldRarity = currentRarity;
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºç¨€æœ‰åº¦æå‡
            const isRarityUpgrade = oldMutation && getRarityLevel(targetRarity) > getRarityLevel(oldRarity);
            
            // ç®¡ç†æŠ€èƒ½ï¼šæ ¹æ®æŠ€èƒ½æ•°é‡é™åˆ¶å¤„ç†
            const skillLimits = { basic: 2, elite: 2, legendary: 2 };
            
            // å¦‚æœæ˜¯è¿›é˜¶ï¼ˆç¨€æœ‰åº¦æå‡ï¼‰ï¼Œä¿ç•™æ—§å˜å¼‚åˆ°å†å²
            if (isRarityUpgrade) {
                const oldConfig = getMutationConfig(oldMutation);
                if (oldConfig && !animal.mutations.history.some(h => h.name === oldMutation)) {
                    animal.mutations.history.push({
                        name: oldMutation,
                        rarity: oldRarity,
                        icon: oldConfig.icon
                    });
                }
                // ç¨€æœ‰åº¦æå‡æ—¶ï¼Œä¿ç•™æ‰€æœ‰æ—§æŠ€èƒ½ï¼ˆä¸ç§»é™¤ï¼‰
            } else if (oldMutation) {
                // åŒçº§è½¬æ¢ï¼šå¼ºåˆ¶æ›¿æ¢æŠ€èƒ½
                const skillsToRemove = animal.mutations.currentSkills || (getMutationConfig(oldMutation)?.skills || []);
                
                if (skillsToRemove && skillsToRemove.length > 0) {
                    // ä»å˜å¼‚æŠ€èƒ½åˆ—è¡¨ä¸­ç§»é™¤æ—§å˜å¼‚çš„æŠ€èƒ½
                    animal.mutations.skills = animal.mutations.skills.filter(s => !skillsToRemove.includes(s));
                    
                    // ä»è£…å¤‡æ§½ä¸­ç§»é™¤æ—§çš„å˜å¼‚æŠ€èƒ½
                    if (animal.combatSkills && animal.combatSkills.equipped) {
                        animal.combatSkills.equipped = animal.combatSkills.equipped.map(skillKey => {
                            if (skillKey && skillsToRemove.includes(skillKey)) {
                                return null;
                            }
                            return skillKey;
                        });
                    }
                }
            }
            
            // æ›´æ–°å½“å‰å˜å¼‚
            animal.mutations.tier1 = mutationName;
            
            // ä»æŠ€èƒ½æ± ä¸­è·å–å¯¹åº”å˜å¼‚ç±»å‹çš„æŠ€èƒ½
            let mutationSkills = getSkillsFromPool(mutationName);
            
            // å¦‚æœæŠ€èƒ½æ± ä¸ºç©ºï¼Œä½¿ç”¨é¢„å®šä¹‰æŠ€èƒ½
            if (mutationSkills.length === 0) {
                mutationSkills = config.skills || [];
            }
            
            // è®¡ç®—åº”è·å¾—çš„æŠ€èƒ½æ•°é‡ï¼ˆè€ƒè™‘è·¨çº§å¥–åŠ±ï¼‰
            let skillCount = mutationSkills.length;
            if (isRarityUpgrade) {
                const rarityDiff = getRarityLevel(targetRarity) - getRarityLevel(oldRarity);
                if (rarityDiff === 1) {
                    // æ™®é€š->ç²¾è‹± æˆ– ç²¾è‹±->ä¼ è¯´ï¼š+1æŠ€èƒ½
                    skillCount = Math.min(skillCount + 1, skillLimits[targetRarity]);
                } else if (rarityDiff === 2) {
                    // æ™®é€š->ä¼ è¯´ï¼š+2æŠ€èƒ½
                    skillCount = Math.min(skillCount + 2, skillLimits[targetRarity]);
                }
            }
            
            // ä»æŠ€èƒ½æ± ä¸­éšæœºé€‰æ‹©æŠ€èƒ½
            const selectedSkills = mutationSkills.slice(0, skillCount);

            // è®°å½•å½“å‰å˜å¼‚å¸¦æ¥çš„æŠ€èƒ½ï¼Œä¾›ä¸‹æ¬¡å˜å¼‚æ—¶ç§»é™¤
            animal.mutations.currentSkills = [...selectedSkills];

            // æ·»åŠ æ–°æŠ€èƒ½åˆ°æ‹¥æœ‰çš„æŠ€èƒ½åˆ—è¡¨
            // ç¡®ä¿å³ä½¿ selectedSkills ä¸ºç©ºï¼Œä¹Ÿä» config.skills æ·»åŠ 
            const skillsToAdd = selectedSkills.length > 0 ? selectedSkills : (config.skills || []);

            skillsToAdd.forEach(skillKey => {
                if (!animal.mutations.skills.includes(skillKey)) {
                    animal.mutations.skills.push(skillKey);
                }
            });
            
            // æ£€æŸ¥å¹¶é™åˆ¶æŠ€èƒ½æ•°é‡
            limitMutationSkills(animal, skillLimits);
            
            // åº”ç”¨å±æ€§åŠ æˆ
            applyMutationStats(animal, config.stats);
            
            // å¢åŠ å˜å¼‚æ¬¡æ•°
            animal.mutationCount = (animal.mutationCount || 0) + 1;
            
            // æš‚æ—¶ç§»é™¤24å°æ—¶å†·å´æœŸ
            // animal.mutationCooldownUntil = Date.now() + (24 * 60 * 60 * 1000);
            
            const rarityText = { basic: 'åŸºç¡€', elite: 'ç²¾è‹±', legendary: 'ä¼ è¯´' }[targetRarity];
            const isUpgrade = oldMutation && getRarityLevel(targetRarity) > getRarityLevel(oldRarity);
            let log = `âœ… ä¸€çº§å˜å¼‚æˆåŠŸï¼\n[${rarityText}çº§] ${oldMutation || 'æ— '} â†’ ${mutationName}\n`;
            if (isUpgrade) {
                log += `ğŸ‰ ç¨€æœ‰åº¦æå‡ï¼æ—§å˜å¼‚å·²ä¿ç•™åˆ°å†å²è®°å½•\n`;
            }
            
            // è·å–æŠ€èƒ½åç§°ï¼ˆä»æŠ€èƒ½æ± æˆ–é¢„å®šä¹‰ï¼‰
            const skillNames = getSkillNames(mutationSkills.length > 0 ? mutationSkills : config.skills);
            log += `è·å¾—æŠ€èƒ½: ${skillNames.join(', ')}`;
            
            const changeDesc = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded">
                        <span class="text-gray-400">å˜å¼‚ç±»å‹</span>
                        <span class="text-yellow-400 font-bold">${config.icon} ${mutationName}</span>
                    </div>
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded">
                        <span class="text-gray-400">ç¨€æœ‰åº¦</span>
                        <span class="text-purple-400 font-bold">${rarityText}çº§</span>
                    </div>
                    ${isUpgrade ? `
                    <div class="bg-green-900/20 border border-green-500/40 p-3 rounded">
                        <div class="text-green-400 mb-1">ğŸ‰ ç¨€æœ‰åº¦æå‡ï¼</div>
                        <div class="text-xs text-gray-400">æ—§å˜å¼‚ "${oldMutation}" å·²ä¿ç•™åˆ°å†å²è®°å½•</div>
                    </div>
                    ` : ''}
                    <div class="bg-gray-700 p-3 rounded">
                        <div class="text-gray-400 mb-2">æ–°å¢æŠ€èƒ½:</div>
                        ${getSkillDisplayHtml(mutationSkills.length > 0 ? mutationSkills : config.skills)}
                    </div>
                </div>
            `;
            
            return { success: true, log, changeDesc };
        }

        function performTier2Mutation(animal) {
            const roll = Math.random() * 100;
            
            // æš‚æ—¶ç§»é™¤äºŒçº§å˜å¼‚å†·å´æœŸ
            // animal.tier2MutationCooldownUntil = Date.now() + (24 * 60 * 60 * 1000);
            
            if (roll > 60) {
                return {
                    success: false,
                    log: 'âŒ äºŒçº§å˜å¼‚å¤±è´¥ï¼åŸºå› åºåˆ—ä¸ç¨³å®šã€‚\nè¿›å…¥24å°æ—¶å†·å´ä¿®å…»æœŸã€‚',
                    changeDesc: '<p class="text-center text-gray-400">äºŒçº§å˜å¼‚å¤±è´¥ï¼ŒåŠ¨ç‰©éœ€è¦ä¼‘æ¯ã€‚</p>'
                };
            }
            
            let mutationName;
            const tierRoll = Math.random() * 100;
            if (tierRoll < 40) {
                mutationName = 'é˜´';
            } else if (tierRoll < 80) {
                mutationName = 'é˜³';
            } else {
                mutationName = 'ç„';
            }
            
            const config = MUTATION_CONFIG.tier2[mutationName];
            const oldTier2 = animal.mutations.tier2;
            
            // å¦‚æœå·²æœ‰äºŒçº§å˜å¼‚ï¼Œç§»é™¤æ—§çš„å±æ€§åŠ æˆï¼ˆé€šè¿‡åå‘åº”ç”¨ï¼‰
            if (oldTier2 && MUTATION_CONFIG.tier2[oldTier2]) {
                const oldConfig = MUTATION_CONFIG.tier2[oldTier2];
                const reverseStats = {};
                for (const [key, value] of Object.entries(oldConfig.stats)) {
                    reverseStats[key] = -value;
                }
                applyMutationStats(animal, reverseStats);
            }
            
            animal.mutations.tier2 = mutationName;
            
            applyMutationStats(animal, config.stats);
            
            let log = `âœ… äºŒçº§å˜å¼‚æˆåŠŸï¼\n${oldTier2 || 'æ— '} â†’ ${mutationName}\n`;
            log += `å±æ€§æå‡: ${Object.entries(config.stats).map(([k, v]) => `${k}+${v}`).join(', ')}`;
            
            const changeDesc = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center bg-gray-700 p-3 rounded">
                        <span class="text-gray-400">äºŒçº§å˜å¼‚</span>
                        <span class="text-yellow-400 font-bold">${config.icon} ${mutationName}</span>
                    </div>
                    <div class="bg-gray-700 p-3 rounded">
                        <div class="text-gray-400 mb-2">å±æ€§åŠ æˆ:</div>
                        ${Object.entries(config.stats).map(([k, v]) => `<div class="text-sm">${k}: +${v}</div>`).join('')}
                    </div>
                </div>
            `;
            
            return { success: true, log, changeDesc };
        }

        function applyMutationStats(animal, stats) {
            if (stats.attack) animal.abilities.combat.attack += stats.attack;
            if (stats.defense) animal.abilities.combat.defense += stats.defense;
            if (stats.agility) animal.abilities.combat.agility += stats.agility;
            if (stats.stamina) {
                animal.stamina += stats.stamina;
                animal.maxStamina += stats.stamina;
            }
        }

        function getRarityLevel(rarity) {
            const levels = { basic: 1, elite: 2, legendary: 3 };
            return levels[rarity] || 0;
        }
        
        // æ–°å¢ï¼šåŸºäºäº²å’Œé“¾è®¡ç®—å˜å¼‚ç»“æœ
        function calculateAffinityMutation(currentMutation, currentRarity) {
            const currentConfig = getMutationConfig(currentMutation);
            const currentChain = currentConfig?.chain;
            
            if (!currentChain) {
                // å¦‚æœæ²¡æœ‰é“¾ä¿¡æ¯ï¼Œå›é€€åˆ°éšæœº
                return { rarity: currentRarity, mutation: currentMutation };
            }
            
            const chainInfo = AFFINITY_CHAINS[currentChain];
            const oppositeChain = chainInfo.opposite;
            
            if (currentRarity === 'basic') {
                // ä»åŸºç¡€çº§å˜å¼‚
                const roll = Math.random() * 100;
                
                if (roll < 70) {
                    // åŒçº§è½¬æ¢ (70%)
                    return selectSameTierMutation('basic', currentMutation, currentChain, oppositeChain);
                } else if (roll < 98) {
                    // å‘ä¸Šè¿›é˜¶ (28%)
                    return selectUpgradeMutation('elite', currentChain, oppositeChain);
                } else {
                    // è·¨çº§çªå˜ (2%)
                    return selectUpgradeMutation('legendary', currentChain, oppositeChain);
                }
            } else if (currentRarity === 'elite') {
                // ä»ç²¾è‹±çº§å˜å¼‚
                const roll = Math.random() * 100;
                
                if (roll < 75) {
                    // åŒçº§è½¬æ¢ (75%)
                    return selectSameTierMutation('elite', currentMutation, currentChain, oppositeChain);
                } else {
                    // å‘ä¸Šè¿›é˜¶ (25%)
                    return selectUpgradeMutation('legendary', currentChain, oppositeChain);
                }
            } else {
                // ä¼ è¯´çº§åªèƒ½åŒçº§è½¬æ¢
                return selectSameTierMutation('legendary', currentMutation, currentChain, oppositeChain);
            }
        }
        
        // æ–°å¢ï¼šé€‰æ‹©åŒçº§å˜å¼‚
        function selectSameTierMutation(rarity, currentMutation, currentChain, oppositeChain) {
            const tier = MUTATION_CONFIG.tier1[rarity];
            const candidates = Object.keys(tier).filter(m => m !== currentMutation);
            
            // æŒ‰äº²å’Œåº¦åˆ†ç±»
            const opposite = candidates.filter(m => tier[m].chain === oppositeChain);
            const neutral = candidates.filter(m => tier[m].chain !== currentChain && tier[m].chain !== oppositeChain);
            
            // è®¡ç®—æ¦‚ç‡
            const roll = Math.random() * 100;
            let selected;
            
            if (rarity === 'legendary') {
                // ä¼ è¯´çº§ï¼šå¯¹ç«‹15%ï¼Œä¸­ç«‹å„42.5%
                if (roll < 15 && opposite.length > 0) {
                    selected = opposite[Math.floor(Math.random() * opposite.length)];
                } else if (neutral.length > 0) {
                    selected = neutral[Math.floor(Math.random() * neutral.length)];
                } else {
                    selected = candidates[Math.floor(Math.random() * candidates.length)];
                }
            } else {
                // åŸºç¡€çº§/ç²¾è‹±çº§ï¼šå¯¹ç«‹è¾ƒä½æ¦‚ç‡ï¼Œä¸­ç«‹å‡åˆ†
                const oppositeChance = rarity === 'basic' ? 15 : 10;
                if (roll < oppositeChance && opposite.length > 0) {
                    selected = opposite[Math.floor(Math.random() * opposite.length)];
                } else if (neutral.length > 0) {
                    selected = neutral[Math.floor(Math.random() * neutral.length)];
                } else {
                    selected = candidates[Math.floor(Math.random() * candidates.length)];
                }
            }
            
            return { rarity, mutation: selected };
        }
        
        // æ–°å¢ï¼šé€‰æ‹©å‡çº§å˜å¼‚
        function selectUpgradeMutation(targetRarity, currentChain, oppositeChain) {
            const tier = MUTATION_CONFIG.tier1[targetRarity];
            const candidates = Object.keys(tier);
            
            // æŒ‰äº²å’Œåº¦åˆ†ç±»
            const affinity = candidates.filter(m => tier[m].chain === currentChain);
            const opposite = candidates.filter(m => tier[m].chain === oppositeChain);
            const neutral = candidates.filter(m => tier[m].chain !== currentChain && tier[m].chain !== oppositeChain);
            
            // è®¡ç®—æ¦‚ç‡
            const roll = Math.random() * 100;
            let selected;
            
            if (targetRarity === 'elite') {
                // å‡çº§åˆ°ç²¾è‹±ï¼šäº²å’Œ20%ï¼Œå¯¹ç«‹1%ï¼Œä¸­ç«‹å„3.5%
                if (roll < 71.4 && affinity.length > 0) { // 20/28 * 100
                    selected = affinity[Math.floor(Math.random() * affinity.length)];
                } else if (roll < 75 && opposite.length > 0) { // 1/28 * 100
                    selected = opposite[Math.floor(Math.random() * opposite.length)];
                } else if (neutral.length > 0) {
                    selected = neutral[Math.floor(Math.random() * neutral.length)];
                } else {
                    selected = candidates[Math.floor(Math.random() * candidates.length)];
                }
            } else {
                // å‡çº§åˆ°ä¼ è¯´ï¼šäº²å’Œ1.6%(åŸºç¡€)æˆ–20%(ç²¾è‹±)ï¼Œå¯¹ç«‹0.1%æˆ–1%ï¼Œä¸­ç«‹å‡åˆ†
                const affinityChance = currentChain ? 80 : 1.6; // å‡è®¾ä»ç²¾è‹±å‡çº§
                const oppositeChance = currentChain ? 4 : 0.1;
                
                if (roll < affinityChance && affinity.length > 0) {
                    selected = affinity[Math.floor(Math.random() * affinity.length)];
                } else if (roll < affinityChance + oppositeChance && opposite.length > 0) {
                    selected = opposite[Math.floor(Math.random() * opposite.length)];
                } else if (neutral.length > 0) {
                    selected = neutral[Math.floor(Math.random() * neutral.length)];
                } else {
                    selected = candidates[Math.floor(Math.random() * candidates.length)];
                }
            }
            
            return { rarity: targetRarity, mutation: selected };
        }
        
        // æ–°å¢ï¼šé™åˆ¶å˜å¼‚æŠ€èƒ½æ•°é‡
        function limitMutationSkills(animal, skillLimits) {
            if (!animal.mutations || !animal.mutations.skills) return;
            
            // è¯»å–æŠ€èƒ½æ± ä»¥æ”¯æŒè‡ªå®šä¹‰æŠ€èƒ½
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            
            // æŒ‰ç¨€æœ‰åº¦åˆ†ç±»æŠ€èƒ½
            const skillsByRarity = { basic: [], elite: [], legendary: [] };
            
            animal.mutations.skills.forEach(skillKey => {
                let found = false;
                
                // é¦–å…ˆåœ¨é¢„å®šä¹‰é…ç½®ä¸­æŸ¥æ‰¾
                for (const [rarity, mutations] of Object.entries(MUTATION_CONFIG.tier1)) {
                    for (const mutConfig of Object.values(mutations)) {
                        if (mutConfig.skills && mutConfig.skills.includes(skillKey)) {
                            skillsByRarity[rarity].push(skillKey);
                            found = true;
                            return;
                        }
                    }
                }
                
                // å¦‚æœæ˜¯è‡ªå®šä¹‰æŠ€èƒ½ï¼Œä»æŠ€èƒ½æ± ä¸­æ¨æ–­ç¨€æœ‰åº¦
                if (!found) {
                    const customSkill = skillPool.find(s => s.key === skillKey);
                    if (customSkill && customSkill.category) {
                        // æ ¹æ®categoryæ¨æ–­ç¨€æœ‰åº¦
                        // mutation-dark, mutation-light, mutation-crystal, mutation-shadow -> basic
                        // mutation-chaos, mutation-holy, mutation-psychic, mutation-thunder -> elite
                        // mutation-eternal-*, mutation-source-*, mutation-thunder-lord -> legendary
                        let rarity = 'basic'; // é»˜è®¤ä¸ºbasic
                        if (customSkill.category.includes('chaos') ||
                            customSkill.category.includes('holy') ||
                            customSkill.category.includes('psychic') ||
                            (customSkill.category.includes('thunder') && !customSkill.category.includes('lord'))) {
                            rarity = 'elite';
                        } else if (customSkill.category.includes('eternal') ||
                                   customSkill.category.includes('source') ||
                                   customSkill.category.includes('lord')) {
                            rarity = 'legendary';
                        }
                        skillsByRarity[rarity].push(skillKey);
                    } else {
                        // å¦‚æœå®Œå…¨æ‰¾ä¸åˆ°ï¼Œä¿ç•™è¯¥æŠ€èƒ½ï¼ˆå½’ç±»åˆ°basicï¼‰
                        skillsByRarity.basic.push(skillKey);
                    }
                }
            });
            
            // é™åˆ¶æ¯ä¸ªç¨€æœ‰åº¦çš„æŠ€èƒ½æ•°é‡
            let limitedSkills = [];
            for (const [rarity, skills] of Object.entries(skillsByRarity)) {
                const limit = skillLimits[rarity];
                limitedSkills = limitedSkills.concat(skills.slice(0, limit));
            }
            
            // æ›´æ–°æŠ€èƒ½åˆ—è¡¨
            animal.mutations.skills = limitedSkills;
            
            // ä»è£…å¤‡æ§½ä¸­ç§»é™¤è¶…å‡ºé™åˆ¶çš„æŠ€èƒ½
            if (animal.combatSkills && animal.combatSkills.equipped) {
                animal.combatSkills.equipped = animal.combatSkills.equipped.map(skillKey => {
                    if (skillKey && !limitedSkills.includes(skillKey)) {
                        return null;
                    }
                    return skillKey;
                });
            }
        }
        
        // æ–°å¢ï¼šä»æŠ€èƒ½æ± ä¸­è·å–å¯¹åº”å˜å¼‚ç±»å‹çš„æŠ€èƒ½
        function getSkillsFromPool(mutationType) {
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            
            // å˜å¼‚ç±»å‹åˆ°categoryçš„æ˜ å°„
            const mutationToCategoryMap = {
                'é»‘åŒ–': 'mutation-dark',
                'ç™½åŒ–': 'mutation-light',
                'æ™¶åŒ–': 'mutation-crystal',
                'å½±åŒ–': 'mutation-shadow',
                'æç”µ': 'mutation-thunder',
                'åœ£è¾‰': 'mutation-holy',
                'å¼‚èƒ½': 'mutation-psychic',
                'æš—èš€': 'mutation-chaos',
                'æ¹®ç­': 'mutation-annihilate',
                'è™šæ— ': 'mutation-void',
                'è½®å›': 'mutation-rebirth'
            };
            
            const category = mutationToCategoryMap[mutationType];
            if (!category) return [];
            
            // ç­›é€‰å‡ºå¯¹åº”ç±»åˆ«çš„æŠ€èƒ½
            const matchingSkills = skillPool.filter(skill => skill.category === category);
            
            // éšæœºé€‰æ‹©æŠ€èƒ½ï¼ˆåŸºç¡€çº§1ä¸ªï¼Œç²¾è‹±çº§2ä¸ªï¼Œä¼ è¯´çº§2ä¸ªï¼‰
            const config = getMutationConfig(mutationType);
            const maxSkills = config?.rarity === 'basic' ? 1 : 2;
            
            // æ‰“ä¹±å¹¶é€‰æ‹©
            const shuffled = matchingSkills.sort(() => Math.random() - 0.5);
            return shuffled.slice(0, maxSkills).map(s => s.key);
        }
        
        // æ–°å¢ï¼šè·å–æŠ€èƒ½åç§°åˆ—è¡¨
        function getSkillNames(skillKeys) {
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            return skillKeys.map(skillKey => {
                const skill = MUTATION_SKILLS[skillKey];
                if (skill) return skill.name;
                
                const customSkill = skillPool.find(s => s.key === skillKey);
                return customSkill ? customSkill.name : 'æœªçŸ¥æŠ€èƒ½';
            });
        }
        
        // æ–°å¢ï¼šè·å–æŠ€èƒ½æ˜¾ç¤ºHTML
        function getSkillDisplayHtml(skillKeys) {
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            return skillKeys.map(skillKey => {
                const skill = MUTATION_SKILLS[skillKey];
                if (skill) {
                    return `<div class="text-sm">${skill.icon} ${skill.name}</div>`;
                }
                
                const customSkill = skillPool.find(s => s.key === skillKey);
                if (customSkill) {
                    return `<div class="text-sm">${customSkill.icon} ${customSkill.name}</div>`;
                }
                
                return `<div class="text-sm">â“ æœªçŸ¥æŠ€èƒ½</div>`;
            }).join('');
        }

        // --- é€»è¾‘å¤„ç†å‡½æ•° ---

        function feedAnimal(animalId) {
            const animal = gameState.animals.find(a => a.id === animalId);
            if (!animal) return;
            const cost = animal.level * 10;
            if (gameState.food < cost) {
                showStatus('âŒ é£Ÿç‰©ä¸è¶³ï¼Œæ— æ³•å–‚å…»ã€‚', 2000);
                return;
            }
            gameState.food -= cost;
            animal.experience += LEVEL_CONFIG.feedAmount;
            showStatus(`ğŸ– å–‚å…»äº† ${animal.name}ï¼Œç»éªŒ +${LEVEL_CONFIG.feedAmount}!`, 1500);
            
            // å¤„ç†å¯èƒ½çš„è¿ç»­å‡çº§
            while (animal.experience >= animal.experienceToNextLevel) {
                levelUpAnimal(animal);
            }
            
            saveGameState(); // ä¿å­˜çŠ¶æ€
            updateResourceUI();
            showAnimalDetails(animal.id);
        }

        // æ–°å¢ï¼šè®¡ç®—å‡çº§æˆæœ¬
        function calculateLevelUpCost(animal, levels) {
            let totalCost = 0;
            let tempLevel = animal.level;
            let tempExp = animal.experience;
            let tempExpToNext = animal.experienceToNextLevel;

            for (let i = 0; i < levels; i++) {
                const expNeeded = Math.max(0, tempExpToNext - tempExp);
                const feedsNeeded = Math.ceil(expNeeded / LEVEL_CONFIG.feedAmount);
                // æ¯æ¬¡å–‚å…»æˆæœ¬ = å½“å‰ç­‰çº§ * 10
                totalCost += feedsNeeded * (tempLevel * 10);

                // æ¨¡æ‹Ÿå‡çº§
                tempLevel++;
                // æº¢å‡ºçš„ç»éªŒ
                tempExp = (feedsNeeded * LEVEL_CONFIG.feedAmount) - expNeeded;
                tempExpToNext = Math.floor(tempExpToNext * LEVEL_CONFIG.experienceMultiplier);
            }
            return totalCost;
        }

        // æ–°å¢ï¼šè¿å‡10çº§
        function feedAnimalPlus10(animalId) {
            const animal = gameState.animals.find(a => a.id === animalId);
            if (!animal) return;

            const totalCost = calculateLevelUpCost(animal, 10);
            if (gameState.food < totalCost) {
                showStatus(`âŒ é£Ÿç‰©ä¸è¶³ï¼Œéœ€è¦ ${totalCost} é£Ÿç‰©ã€‚`, 2000);
                return;
            }

            gameState.food -= totalCost;
            for (let i = 0; i < 10; i++) {
                levelUpAnimal(animal);
            }
            
            showStatus(`ğŸš€ ${animal.name} è¿å‡10çº§ï¼æ¶ˆè€—äº† ${totalCost} é£Ÿç‰©ã€‚`, 3000);
            saveGameState(); // ä¿å­˜çŠ¶æ€
            updateResourceUI();
            showAnimalDetails(animal.id);
        }

        // æ–°å¢ï¼šæ¸²æŸ“é“å…·é¢æ¿
        function renderItemPanel() {
            const grid = document.getElementById('item-grid');
            const emptyMsg = document.getElementById('items-empty-msg');
            grid.innerHTML = '';
            if (!gameState.inventory) gameState.inventory = {}; // ç¡®ä¿ inventory å­˜åœ¨
            
            const inventory = gameState.inventory || {};
            let hasItems = false;

            for (const [itemId, count] of Object.entries(inventory)) {
                if (count > 0 && ITEMS[itemId]) {
                    hasItems = true;
                    const item = ITEMS[itemId];
                    const el = document.createElement('div');
                    el.className = 'bg-gray-700 p-2 rounded flex flex-col items-center cursor-pointer hover:bg-gray-600 transition-colors relative group';
                    el.innerHTML = `
                        <div class="text-2xl mb-1">${item.icon}</div>
                        <div class="text-xs text-center font-bold">${item.name}</div>
                        <div class="text-xs text-gray-400">x${count}</div>
                        <div class="absolute bottom-full mb-2 hidden group-hover:block w-32 bg-black text-white text-xs rounded p-1 z-10 text-center shadow-lg">
                            ${item.desc}
                        </div>
                    `;
                    el.onclick = () => useItem(itemId);
                    grid.appendChild(el);
                }
            }

            if (emptyMsg) emptyMsg.style.display = hasItems ? 'none' : 'block';
        }

        // æ–°å¢ï¼šä½¿ç”¨é“å…·
        function useItem(itemId) {
            if (!selectedAnimalId) return showStatus('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€åªåŠ¨ç‰©', 2000);
            const animal = gameState.animals.find(a => a.id === selectedAnimalId);
            if (!animal) return;

            const item = ITEMS[itemId];
            if (!item || !gameState.inventory[itemId] || gameState.inventory[itemId] <= 0) return;

            if (item.type === 'exp') {
                animal.experience += item.value;
                showStatus(`ğŸ§ª ä½¿ç”¨äº†${item.name}ï¼Œç»éªŒ +${item.value}`, 2000);
                
                // å¤„ç†å¯èƒ½çš„è¿ç»­å‡çº§
                while (animal.experience >= animal.experienceToNextLevel) {
                    levelUpAnimal(animal);
                }
            } else if (item.type === 'stamina') {
                if (animal.stamina >= animal.maxStamina) return showStatus('âš ï¸ ä½“åŠ›å·²æ»¡ï¼Œæ— éœ€ä½¿ç”¨ã€‚', 2000);
                animal.stamina = Math.min(animal.maxStamina, animal.stamina + item.value);
                showStatus(`âš¡ ä½¿ç”¨äº†${item.name}ï¼Œä½“åŠ›æ¢å¤ +${item.value}`, 2000);
            }

            gameState.inventory[itemId]--;
            saveGameState(); // ä¿å­˜çŠ¶æ€
            renderItemPanel();
            showAnimalDetails(animal.id); // åˆ·æ–°ç•Œé¢
        }

        function levelUpAnimal(animal) {
            // ç¡®ä¿ç»éªŒå€¼ä¸ä¼šå˜æˆè´Ÿæ•°
            const currentExp = animal.experience;
            const expNeeded = animal.experienceToNextLevel;
            
            // å‡å»å‡çº§æ‰€éœ€ç»éªŒï¼Œä¿ç•™æº¢å‡ºéƒ¨åˆ†
            animal.experience = Math.max(0, currentExp - expNeeded);
            animal.level++;
            animal.experienceToNextLevel = Math.floor(expNeeded * LEVEL_CONFIG.experienceMultiplier);
            
            const potential = animal.potential;
            const multipliers = LEVEL_CONFIG.potentialMultipliers[potential] || { stamina: 1.0, combat: 1.0 };
            const growth = LEVEL_CONFIG.baseGrowth;
            const staminaGrowth = Math.ceil(growth.stamina * (multipliers.stamina || 1.0));
            animal.stamina += staminaGrowth;
            animal.maxStamina += staminaGrowth;
            animal.abilities.combat.attack += Math.ceil(growth.attack * (multipliers.combat || 1.0));
            animal.abilities.combat.defense += Math.ceil(growth.defense * (multipliers.combat || 1.0));
            animal.abilities.combat.agility += Math.ceil(growth.agility * (multipliers.combat || 1.0));
            
            showStatus(`ğŸ‰ æ­å–œï¼${animal.name} å‡çº§åˆ°äº† Lv.${animal.level}ï¼`, 4000);
            
            // æˆ˜æ–—æŠ€èƒ½è§£é”é€»è¾‘
            animal.combatSkills = animal.combatSkills || { equipped: [], available: [] };
            
            // æ£€æŸ¥æ¨¡æ¿æŠ€èƒ½è§£é”ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            if (animal.templateKey) {
                console.log(`[å‡çº§] ${animal.name} å‡åˆ° Lv.${animal.level}ï¼ŒtemplateKey:`, animal.templateKey);
                checkTemplateSkillUnlock(animal);
                console.log('[å‡çº§] è§£é”åå¯ç”¨æŠ€èƒ½:', animal.combatSkills.available);
            } else {
                console.log(`[å‡çº§] ${animal.name} æ²¡æœ‰ templateKey`);
            }
            
            // ç§»é™¤éšæœºæŠ€èƒ½è§£é”æœºåˆ¶
            // åŠ¨ç‰©åªèƒ½é€šè¿‡æ¨¡æ¿æŠ€èƒ½ç»„è§£é”æŠ€èƒ½
            
            // æ£€æŸ¥ç»§æ‰¿æŠ€èƒ½è§£é”
            if (animal.mutations?.inheritedSkills) {
                animal.mutations.inheritedSkills.forEach(inheritedSkill => {
                    if (animal.level === inheritedSkill.unlockLevel && !animal.mutations.skills.includes(inheritedSkill.skillKey)) {
                        // è§£é”ç»§æ‰¿çš„æŠ€èƒ½
                        animal.mutations.skills.push(inheritedSkill.skillKey);
                        const skillInfo = MUTATION_SKILLS[inheritedSkill.skillKey];
                        showStatus(`ğŸ§¬ ç»§æ‰¿æŠ€èƒ½è§£é”ï¼${animal.name} å­¦ä¼šäº† ${skillInfo.icon} ${skillInfo.name}ï¼`, 5000);
                    }
                });
            }

            renderAnimalList(); // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºç­‰çº§
        }

        // æ–°å¢ï¼šæ£€æŸ¥æ¨¡æ¿æŠ€èƒ½è§£é”
        function checkTemplateSkillUnlock(animal) {
            // è¯»å–åŠ¨ç‰©æ¨¡æ¿æ± å’ŒæŠ€èƒ½æ± 
            const animalPool = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
            const skillPool = JSON.parse(localStorage.getItem('SKILL_POOL') || '[]');
            
            console.log('[æŠ€èƒ½è§£é”] æ¨¡æ¿æ± :', animalPool.length, 'æŠ€èƒ½æ± :', skillPool.length);
            
            // æŸ¥æ‰¾åŠ¨ç‰©çš„æ¨¡æ¿
            const template = animalPool.find(t => t.key === animal.templateKey);
            if (!template) {
                console.warn('[æŠ€èƒ½è§£é”] æœªæ‰¾åˆ°æ¨¡æ¿:', animal.templateKey);
                return;
            }
            
            console.log('[æŠ€èƒ½è§£é”] æ‰¾åˆ°æ¨¡æ¿:', template.name, 'é…ç½®æŠ€èƒ½æ•°:', template.skills?.length || 0);
            
            if (!template.skills || template.skills.length === 0) {
                console.log('[æŠ€èƒ½è§£é”] æ¨¡æ¿æ²¡æœ‰é…ç½®æŠ€èƒ½');
                return; // æ²¡æœ‰æ¨¡æ¿æˆ–æ¨¡æ¿æ²¡æœ‰é…ç½®æŠ€èƒ½
            }
            
            // åˆå§‹åŒ–æ¨¡æ¿æŠ€èƒ½è§£é”è®°å½•
            if (!animal.templateSkillsUnlocked) {
                animal.templateSkillsUnlocked = [];
            }
            
            console.log('[æŠ€èƒ½è§£é”] å½“å‰ç­‰çº§:', animal.level, 'å·²è§£é”:', animal.templateSkillsUnlocked);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æŠ€èƒ½åœ¨å½“å‰ç­‰çº§è§£é”
            template.skills.forEach(skillConfig => {
                console.log('[æŠ€èƒ½è§£é”] æ£€æŸ¥æŠ€èƒ½:', skillConfig.skillKey, 'è§£é”ç­‰çº§:', skillConfig.unlockLevel);
                
                if (skillConfig.unlockLevel === animal.level) {
                    console.log('[æŠ€èƒ½è§£é”] ç­‰çº§åŒ¹é…ï¼');
                    
                    // æ£€æŸ¥æ˜¯å¦å·²ç»è§£é”è¿‡
                    if (animal.templateSkillsUnlocked.includes(skillConfig.skillKey)) {
                        console.log('[æŠ€èƒ½è§£é”] å·²è§£é”ï¼Œè·³è¿‡');
                        return; // å·²è§£é”ï¼Œè·³è¿‡
                    }
                    
                    // æŸ¥æ‰¾æŠ€èƒ½ä¿¡æ¯
                    const skill = skillPool.find(s => s.key === skillConfig.skillKey);
                    if (!skill) {
                        console.warn('[æŠ€èƒ½è§£é”] æŠ€èƒ½ä¸å­˜åœ¨:', skillConfig.skillKey);
                        return;
                    }
                    
                    console.log('[æŠ€èƒ½è§£é”] æ‰¾åˆ°æŠ€èƒ½:', skill.name, 'ç±»åˆ«:', skill.category);
                    
                    // è§£é”æŠ€èƒ½
                    animal.templateSkillsUnlocked.push(skillConfig.skillKey);
                    
                    // æ ¹æ®æŠ€èƒ½ç±»åˆ«æ·»åŠ åˆ°å¯¹åº”çš„æŠ€èƒ½åˆ—è¡¨
                    if (skill.category && skill.category.startsWith('mutation-')) {
                        // å˜å¼‚æŠ€èƒ½
                        if (!animal.mutations) {
                            animal.mutations = { tier1: null, tier2: null, skills: [], inheritedSkills: [], currentSkills: [] };
                        }
                        if (!animal.mutations.skills.includes(skillConfig.skillKey)) {
                            animal.mutations.skills.push(skillConfig.skillKey);
                        }
                        
                        // å°†è‡ªå®šä¹‰æŠ€èƒ½æ·»åŠ åˆ° MUTATION_SKILLS ä»¥ä¾¿æ¸²æŸ“
                        if (!MUTATION_SKILLS[skillConfig.skillKey]) {
                            MUTATION_SKILLS[skillConfig.skillKey] = {
                                name: skill.name,
                                icon: skill.icon,
                                desc: skill.description || skill.desc || 'æ— æè¿°'
                            };
                        }
                        
                        console.log('[æŠ€èƒ½è§£é”] è§£é”å˜å¼‚æŠ€èƒ½:', skill.name);
                        showStatus(`ğŸ§¬ æ¨¡æ¿æŠ€èƒ½è§£é”ï¼${animal.name} å­¦ä¼šäº† ${skill.icon} ${skill.name}ï¼`, 5000);
                    } else {
                        // æˆ˜æ–—æŠ€èƒ½
                        if (!animal.combatSkills.available.includes(skillConfig.skillKey)) {
                            animal.combatSkills.available.push(skillConfig.skillKey);
                        }
                        
                        // å°†è‡ªå®šä¹‰æŠ€èƒ½æ·»åŠ åˆ° COMBAT_SKILLS ä»¥ä¾¿æ¸²æŸ“
                        if (!COMBAT_SKILLS[skillConfig.skillKey]) {
                            COMBAT_SKILLS[skillConfig.skillKey] = {
                                name: skill.name,
                                icon: skill.icon,
                                desc: skill.description || skill.desc || 'æ— æè¿°',
                                type: skill.type,
                                cooldown: skill.params?.cooldown || 0
                            };
                        }
                        
                        console.log('[æŠ€èƒ½è§£é”] è§£é”æˆ˜æ–—æŠ€èƒ½:', skill.name);
                        showStatus(`ğŸ”“ æ¨¡æ¿æŠ€èƒ½è§£é”ï¼${animal.name} å­¦ä¼šäº† ${skill.icon} ${skill.name}ï¼`, 5000);
                    }
                }
            });
            
            console.log('[æŠ€èƒ½è§£é”] è§£é”å®Œæˆï¼Œå½“å‰å¯ç”¨æŠ€èƒ½:', animal.combatSkills.available);
            saveGameState(); // ä¿å­˜çŠ¶æ€
        }

        function renameAnimal() {
            if (!selectedAnimalId) return;
            const animal = gameState.animals.find(a => a.id === selectedAnimalId);
            if (!animal) return;

            const newName = prompt(`ä¸º "${animal.name}" è¾“å…¥æ–°åå­—:`, animal.name);

            if (newName && newName.trim() !== '') {
                animal.name = newName.trim();
                saveGameState(); // ä¿å­˜çŠ¶æ€
                showStatus(`åå­—å·²æ›´æ–°ä¸º "${animal.name}"`, 2000);
                // åˆ·æ–°UI
                showAnimalDetails(selectedAnimalId);
                renderAnimalList();
            } else if (newName !== null) { // ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®šä½†è¾“å…¥ä¸ºç©º
                showStatus('âŒ åå­—ä¸èƒ½ä¸ºç©ºã€‚', 2000);
            }
        }

        function toggleBreedingSelection(animal) {
            if (isActionInProgress) {
                showStatus("æ­£åœ¨ç¹æ®–ä¸­ï¼Œæ— æ³•æ›´æ”¹é€‰æ‹©ã€‚", 2000);
                return;
            }

            const id = animal.id;
            const index = gameState.selectedAnimalsForBreeding.indexOf(id);

            if (index > -1) {
                // å¦‚æœåŠ¨ç‰©å·²è¢«é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                gameState.selectedAnimalsForBreeding.splice(index, 1);
                // å¦‚æœå–æ¶ˆçš„æ˜¯å½“å‰æ­£åœ¨æŸ¥çœ‹è¯¦æƒ…çš„åŠ¨ç‰©ï¼Œåˆ™å°è¯•æ˜¾ç¤ºå¦ä¸€ä¸ªçˆ¶ä»£ï¼Œå¦åˆ™æ¸…ç©º
                if (selectedAnimalId === id) {
                    const otherParentId = gameState.selectedAnimalsForBreeding[0] || null;
                    showAnimalDetails(otherParentId);
                }
            } else {
                if (gameState.selectedAnimalsForBreeding.length >= 2) {
                    showStatus(`âŒ çˆ¶æ¯æ å·²æ»¡ï¼Œè¯·å…ˆæ¸…ç©ºä¸€ä¸ªä½ç½®ã€‚`, 2000);
                    return;
                }

                // æ£€æŸ¥æ€§åˆ«å†²çª
                if (gameState.selectedAnimalsForBreeding.length === 1) {
                    const existingParent = gameState.animals.find(a => a.id === gameState.selectedAnimalsForBreeding[0]);
                    if (animal.gender === existingParent.gender) {
                        showStatus(`âŒ å¿…é¡»é€‰æ‹©ä¸€åªé›„æ€§å’Œä¸€åªé›Œæ€§è¿›è¡Œç¹æ®–ã€‚`, 2000);
                        return;
                    }
                }

                // æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªç©ºä½
                gameState.selectedAnimalsForBreeding.push(id);
            }

            // æ— è®ºé€‰æ‹©è¿˜æ˜¯å–æ¶ˆï¼Œéƒ½æ˜¾ç¤ºå½“å‰ç‚¹å‡»çš„åŠ¨ç‰©è¯¦æƒ…
            showAnimalDetails(animal.id);
            renderBreedingPanel();
        }

        function toggleFusionSelection(animal) {
            if (isActionInProgress) {
                showStatus("æ­£åœ¨èåˆä¸­ï¼Œæ— æ³•æ›´æ”¹é€‰æ‹©ã€‚", 2000);
                return;
            }

            const id = animal.id;
            const index = gameState.selectedAnimalsForFusion.indexOf(id);

            if (index > -1) {
                // å¦‚æœåŠ¨ç‰©å·²è¢«é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                gameState.selectedAnimalsForFusion.splice(index, 1);
                // å¦‚æœå–æ¶ˆçš„æ˜¯å½“å‰æ­£åœ¨æŸ¥çœ‹è¯¦æƒ…çš„åŠ¨ç‰©ï¼Œåˆ™å°è¯•æ˜¾ç¤ºå¦ä¸€ä¸ªææ–™ï¼Œå¦åˆ™æ¸…ç©º
                if (selectedAnimalId === id) {
                    const otherMaterialId = gameState.selectedAnimalsForFusion[0] || null;
                    showAnimalDetails(otherMaterialId);
                }
            } else {
                if (gameState.selectedAnimalsForFusion.length >= 2) {
                    showStatus(`âŒ ææ–™æ å·²æ»¡ï¼Œè¯·å…ˆæ¸…ç©ºä¸€ä¸ªä½ç½®ã€‚`, 2000);
                    return;
                }
                // æ·»åŠ åˆ°ç©ºä½
                gameState.selectedAnimalsForFusion.push(id);
            }
            showAnimalDetails(animal.id); // æ˜¾ç¤ºå½“å‰ç‚¹å‡»çš„åŠ¨ç‰©è¯¦æƒ…
            renderFusionPanel();
        }

        function clearBreedingSelection() {
            if (isActionInProgress) return;
            gameState.selectedAnimalsForBreeding = [];
            renderBreedingPanel();
        }

        function clearFusionSelection() {
            if (isActionInProgress) return;
            gameState.selectedAnimalsForFusion = [];
            renderFusionPanel();
        }

        function updateBreedingButton() {
            const cost = 100;
            const parents = gameState.selectedAnimalsForBreeding.map(id => gameState.animals.find(a => a.id === id));
            const hasTwoParents = parents.length === 2;
            const isMaleFemalePair = hasTwoParents && parents[0].gender !== parents[1].gender;

            const canBreed = !isActionInProgress && hasTwoParents && isMaleFemalePair && gameState.food >= cost && gameState.animalCount < gameState.maxAnimals;
            ui.btnExecuteBreed.disabled = !canBreed;

            if (gameState.animalCount >= gameState.maxAnimals) {
                ui.btnExecuteBreed.textContent = 'âŒ å®¹é‡å·²æ»¡';
            } else if (hasTwoParents && !isMaleFemalePair) {
                ui.btnExecuteBreed.textContent = 'âŒ éœ€ä¸€é›„ä¸€é›Œ';
            } else if (gameState.selectedAnimalsForBreeding.length < 2) {
                ui.btnExecuteBreed.textContent = `é€‰æ‹©çˆ¶æ¯ (${gameState.selectedAnimalsForBreeding.length}/2)`;
            } else if (gameState.food < cost) {
                ui.btnExecuteBreed.textContent = `é£Ÿç‰©ä¸è¶³ (${cost})`;
            } else if (isActionInProgress) {
                ui.btnExecuteBreed.textContent = 'æ“ä½œè¿›è¡Œä¸­...';
            } else {
                ui.btnExecuteBreed.textContent = `ç¹æ®–! (${cost} é£Ÿç‰©)`;
            }
            updateResourceUI(); // æ¯æ¬¡é€‰æ‹©éƒ½å¯èƒ½å½±å“æŒ‰é’®çŠ¶æ€ï¼Œé¡ºä¾¿åˆ·æ–°èµ„æº
        }

        function updateFusionButton() {
            const cost = 50;
            const canFuse = !isActionInProgress && gameState.selectedAnimalsForFusion.length === 2 && gameState.food >= cost;
            ui.btnExecuteFusion.disabled = !canFuse;
            if (gameState.selectedAnimalsForFusion.length < 2) {
                ui.btnExecuteFusion.textContent = `é€‰æ‹©ææ–™ (${gameState.selectedAnimalsForFusion.length}/2)`;
            } else if (gameState.food < cost) {
                ui.btnExecuteFusion.textContent = `é£Ÿç‰©ä¸è¶³ (${cost})`;
            } else if (isActionInProgress) {
                ui.btnExecuteFusion.textContent = 'æ“ä½œè¿›è¡Œä¸­...';
            } else {
                ui.btnExecuteFusion.textContent = `èåˆ! (${cost} é£Ÿç‰©)`;
            }
            updateResourceUI(); // æ¯æ¬¡é€‰æ‹©éƒ½å¯èƒ½å½±å“æŒ‰é’®çŠ¶æ€ï¼Œé¡ºä¾¿åˆ·æ–°èµ„æº
        }

        function createNewAnimal(color = 0xffffff, type = 'sphere') {
            const animalId = crypto.randomUUID();
            const nameIndex = Math.floor(Math.random() * ANIMAL_NAMES.length);
            const animalData = {
                id: animalId,
                type: type,
                name: `${ANIMAL_NAMES[nameIndex]}${gameState.animals.length + 1}`,
                originalName: `${ANIMAL_NAMES[nameIndex]}${gameState.animals.length + 1}`,
                color: color,
                isWild: false,
                isPlaced: false,
                level: 1,
                gender: Math.random() > 0.5 ? 'é›„' : 'é›Œ',
                experience: 0,
                experienceToNextLevel: LEVEL_CONFIG.baseExperience,
                stamina: 70,
                maxStamina: 70,
                potential: 'å¹³åº¸',
                favorability: 0,
                element: 'æ°´',
                developmentStage: 'å¹¼å¹´æœŸ',
                abilities: {
                    combat: { attack: 10, defense: 5, agility: 8 }
                },
                isInjured: false,
                injuryTimer: 0,
                combatSkills: { equipped: [], available: [] },
                mutations: { tier1: null, tier2: null, skills: [], currentSkills: [] }, // åˆå§‹åŒ–å˜å¼‚ç³»ç»Ÿ
                mutationCount: 0 // å˜å¼‚æ¬¡æ•°
            };
            gameState.animals.push(animalData);
            gameState.animalCount++;
        }

        function breedAnimal() {
            if (isActionInProgress) return;

            const cost = 100;
            const parents = gameState.selectedAnimalsForBreeding.map(id => gameState.animals.find(a => a.id === id)).filter(Boolean);
            if (parents.length !== 2 || gameState.food < cost || gameState.animalCount >= gameState.maxAnimals) {
                showStatus('âŒ ä¸æ»¡è¶³ç¹æ®–æ¡ä»¶ã€‚', 2000);
                return;
            }

            isActionInProgress = true;
            gameState.food -= cost;
            updateResourceUI();
            updateBreedingButton();

            // æ˜¾ç¤ºè¿›åº¦æ¡
            ui.breedingProgressContainer.classList.remove('hidden');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 100 / (ACTION_DURATION / 100);
                ui.breedingProgressBar.style.width = `${Math.min(progress, 100)}%`;
            }, 100);

            setTimeout(() => {
                clearInterval(interval);
                const [p1, p2] = parents;
                const newColor = (p1.color & 0xfefefe) / 2 + (p2.color & 0xfefefe) / 2;
                
                // åˆ›å»ºå­ä»£
                const offspring = createOffspringWithInheritance(p1, p2, newColor);
                
                showStatus(`ğŸ¥š ç¹æ®–æˆåŠŸï¼è¯ç”Ÿäº†æ–°çš„å°åŠ¨ç‰©ï¼`, 3000);

                // é‡ç½®çŠ¶æ€
                isActionInProgress = false;
                gameState.selectedAnimalsForBreeding = [];
                ui.breedingProgressContainer.classList.add('hidden');
                ui.breedingProgressBar.style.width = '0%';
                saveGameState(); // ä¿å­˜çŠ¶æ€
                updateResourceUI(); // æ›´æ–°é£Ÿç‰©å’ŒåŠ¨ç‰©æ•°é‡
                renderBreedingPanel();
            }, ACTION_DURATION);
        }
        
        // æ–°å¢ï¼šåˆ›å»ºå¸¦æŠ€èƒ½ç»§æ‰¿å’Œæ–°ç¨€æœ‰åº¦è§„åˆ™çš„å­ä»£
        function createOffspringWithInheritance(parent1, parent2, color) {
            const animalId = crypto.randomUUID();
            const nameIndex = Math.floor(Math.random() * ANIMAL_NAMES.length);
            
            // 1. è®¡ç®—å­ä»£ç¨€æœ‰åº¦
            const offspringRarity = calculateOffspringRarity(parent1.rarity || 'æ™®é€š', parent2.rarity || 'æ™®é€š');
            
            // åŸºç¡€å±æ€§
            const offspring = {
                id: animalId,
                type: 'sphere',
                name: `${ANIMAL_NAMES[nameIndex]}${gameState.animals.length + 1}`,
                originalName: `${ANIMAL_NAMES[nameIndex]}${gameState.animals.length + 1}`,
                color: color,
                isWild: false,
                isPlaced: false,
                level: 1,
                gender: Math.random() > 0.5 ? 'é›„' : 'é›Œ',
                experience: 0,
                experienceToNextLevel: LEVEL_CONFIG.baseExperience,
                stamina: 70,
                maxStamina: 70,
                potential: 'å¹³åº¸', // å¯ä»¥ä¹‹åå†åŠ å…¥æ½œåŠ›ç»§æ‰¿
                favorability: 0,
                element: Math.random() > 0.5 ? parent1.element : parent2.element,
                developmentStage: 'å¹¼å¹´æœŸ',
                rarity: offspringRarity, // åº”ç”¨æ–°çš„ç¨€æœ‰åº¦
                abilities: {
                    combat: { attack: 10, defense: 5, agility: 8 }
                },
                isInjured: false,
                injuryTimer: 0,
                combatSkills: { equipped: [], available: [] },
                mutations: { tier1: null, tier2: null, skills: [], inheritedSkills: [], currentSkills: [] },
                mutationCount: 0
            };
            
            // 2. æŠ€èƒ½ç»§æ‰¿é€»è¾‘
            const inheritedSkills = calculateSkillInheritance(parent1, parent2, offspring);
            if (inheritedSkills.length > 0) {
                offspring.mutations.inheritedSkills = inheritedSkills;
                showStatus(`âœ¨ å­ä»£ç»§æ‰¿äº† ${inheritedSkills.length} ä¸ªæŠ€èƒ½ï¼å°†åœ¨ç‰¹å®šç­‰çº§è§£é”ã€‚`, 4000);
            }
            
            gameState.animals.push(offspring);
            gameState.animalCount++;
            
            // æ›´æ–°æ–°åŠ¨ç‰©çš„å±æ€§
            updateAnimalStats(offspring);
            
            return offspring;
        }

        // æ–°å¢ï¼šæ ¹æ®çˆ¶æ¯ç¨€æœ‰åº¦è®¡ç®—å­ä»£ç¨€æœ‰åº¦
        function calculateOffspringRarity(rarity1, rarity2) {
            const RARITY_LEVELS = ['æ™®é€š', 'é—ªå…‰', 'å¹»å½©', 'æ˜ŸèŠ’'];
            const key = [rarity1, rarity2].sort((a, b) => RARITY_LEVELS.indexOf(a) - RARITY_LEVELS.indexOf(b)).join(' Ã— ');

            const PROBABILITY_TABLE = {
                'æ™®é€š Ã— æ™®é€š': { 'æ™®é€š': 95.0, 'é—ªå…‰': 4.5, 'å¹»å½©': 0.5, 'æ˜ŸèŠ’': 0 },
                'æ™®é€š Ã— é—ªå…‰': { 'æ™®é€š': 70.0, 'é—ªå…‰': 25.0, 'å¹»å½©': 4.5, 'æ˜ŸèŠ’': 0.5 },
                'æ™®é€š Ã— å¹»å½©': { 'æ™®é€š': 60.0, 'é—ªå…‰': 25.0, 'å¹»å½©': 13.0, 'æ˜ŸèŠ’': 2.0 },
                'æ™®é€š Ã— æ˜ŸèŠ’': { 'æ™®é€š': 40.0, 'é—ªå…‰': 30.0, 'å¹»å½©': 20.0, 'æ˜ŸèŠ’': 10.0 },
                'é—ªå…‰ Ã— é—ªå…‰': { 'æ™®é€š': 50.0, 'é—ªå…‰': 40.0, 'å¹»å½©': 9.0, 'æ˜ŸèŠ’': 1.0 },
                'é—ªå…‰ Ã— å¹»å½©': { 'æ™®é€š': 35.0, 'é—ªå…‰': 40.0, 'å¹»å½©': 20.0, 'æ˜ŸèŠ’': 5.0 },
                'é—ªå…‰ Ã— æ˜ŸèŠ’': { 'æ™®é€š': 25.0, 'é—ªå…‰': 35.0, 'å¹»å½©': 25.0, 'æ˜ŸèŠ’': 15.0 },
                'å¹»å½© Ã— å¹»å½©': { 'æ™®é€š': 20.0, 'é—ªå…‰': 30.0, 'å¹»å½©': 40.0, 'æ˜ŸèŠ’': 10.0 },
                'å¹»å½© Ã— æ˜ŸèŠ’': { 'æ™®é€š': 10.0, 'é—ªå…‰': 25.0, 'å¹»å½©': 35.0, 'æ˜ŸèŠ’': 30.0 },
                'æ˜ŸèŠ’ Ã— æ˜ŸèŠ’': { 'æ™®é€š': 5.0, 'é—ªå…‰': 15.0, 'å¹»å½©': 30.0, 'æ˜ŸèŠ’': 50.0 }
            };

            const probabilities = PROBABILITY_TABLE[key];
            if (!probabilities) return 'æ™®é€š';

            const roll = Math.random() * 100;
            let cumulative = 0;
            for (const rarity of RARITY_LEVELS) {
                cumulative += probabilities[rarity];
                if (roll < cumulative) {
                    return rarity;
                }
            }
            return 'æ™®é€š'; // Fallback
        }
        
        // æ–°å¢ï¼šè®¡ç®—æŠ€èƒ½ç»§æ‰¿
        function calculateSkillInheritance(parent1, parent2, offspring) {
            const inheritedSkills = [];
            const p1Mutation = parent1.mutations?.tier1;
            const p2Mutation = parent2.mutations?.tier1;
            const p1Config = p1Mutation ? getMutationConfig(p1Mutation) : null;
            const p2Config = p2Mutation ? getMutationConfig(p2Mutation) : null;
            const p1Rarity = p1Config?.rarity; // e.g., 'elite'
            const p2Rarity = p2Config?.rarity; // e.g., 'legendary'

            // å­ä»£çš„ç¨€æœ‰åº¦ï¼Œä¾‹å¦‚ 'å¹»å½©'
            const offspringAnimalRarity = offspring.rarity;
            // å­ä»£ç¨€æœ‰åº¦å¯¹åº”çš„å˜å¼‚ç¨€æœ‰åº¦ï¼Œä¾‹å¦‚ 'elite'
            const offspringMutationRarity = getMutationRarityFromAnimalRarity(offspringAnimalRarity);

            if (!offspringMutationRarity) {
                return []; // å­ä»£ä¸æ˜¯é«˜ç¨€æœ‰åº¦å˜å¼‚ï¼Œæ— æ³•ç»§æ‰¿
            }

            // è§„åˆ™ 1: å•ä¸€é«˜ç¨€æœ‰åº¦çˆ¶ä»£
            if ((p1Rarity && !p2Rarity) || (!p1Rarity && p2Rarity)) {
                const highParentConfig = p1Rarity ? p1Config : p2Config;
                const highParentRarity = p1Rarity || p2Rarity;
                
                // å­ä»£ä¹Ÿæ˜¯åŒé«˜ç¨€æœ‰åº¦å˜å¼‚
                if (highParentRarity === offspringMutationRarity) {
                    const unlockLevel = getUnlockLevelByRarity(highParentRarity);
                    (highParentConfig.skills || []).forEach(skillKey => {
                        inheritedSkills.push({ skillKey, unlockLevel });
                    });
                }
            }
            // è§„åˆ™ 2: çˆ¶æ¯å‡ä¸ºç›¸åŒé«˜ç¨€æœ‰åº¦å˜å¼‚
            else if (p1Rarity && p1Rarity === p2Rarity) {
                // å­ä»£ä¹Ÿæ˜¯åŒé«˜ç¨€æœ‰åº¦
                if (p1Rarity === offspringMutationRarity) {
                    const unlockLevel = getUnlockLevelByRarity(p1Rarity);
                    const skillPool = [...new Set([...(p1Config.skills || []), ...(p2Config.skills || [])])];
                    let maxInherit = 0;
                    if (p1Rarity === 'basic') maxInherit = 1;
                    if (p1Rarity === 'elite') maxInherit = 2;
                    if (p1Rarity === 'legendary') maxInherit = 2;
                    
                    const skillsToInherit = skillPool.slice(0, maxInherit); // éšæœºé€‰æ‹©æŠ€èƒ½
                    skillsToInherit.forEach(skillKey => {
                        inheritedSkills.push({ skillKey, unlockLevel });
                    });
                }
            }
            // è§„åˆ™ 3: çˆ¶æ¯ä¸ºä¸åŒç¨€æœ‰åº¦å˜å¼‚
            else if (p1Rarity && p2Rarity && p1Rarity !== p2Rarity) {
                const p1MutationRarityLevel = getRarityLevel(p1Rarity);
                const p2MutationRarityLevel = getRarityLevel(p2Rarity);
                
                // ç¡®å®šå“ªä¸ªæ˜¯è¾ƒä½çš„ç¨€æœ‰åº¦
                const lowerMutationRarity = p1MutationRarityLevel < p2MutationRarityLevel ? p1Rarity : p2Rarity;
                
                // å¦‚æœå­ä»£é—ä¼ äº†è¾ƒä½çš„ç¨€æœ‰åº¦
                if (offspringMutationRarity === lowerMutationRarity) {
                    const unlockLevel = getUnlockLevelByRarity(lowerMutationRarity);
                    const skillPool = [];

                    // ä»çˆ¶æ¯åŒæ–¹æ”¶é›†æ‰€æœ‰ä¸å­ä»£ç¨€æœ‰åº¦åŒ¹é…æˆ–æ›´ä½çš„æŠ€èƒ½
                    if (p1Rarity === lowerMutationRarity) {
                        skillPool.push(...(p1Config.skills || []));
                    }
                    if (p2Rarity === lowerMutationRarity) {
                        skillPool.push(...(p2Config.skills || []));
                    }
                    
                    const uniqueSkills = [...new Set(skillPool)];
                    const skillsToInherit = uniqueSkills.slice(0, 2); // æœ€å¤šç»§æ‰¿2ä¸ª
                    skillsToInherit.forEach(skillKey => {
                        inheritedSkills.push({ skillKey, unlockLevel });
                    });
                }
            }

            return inheritedSkills;
        }

        // è¾…åŠ©å‡½æ•°
        function getRarityLevelByName(rarityName) {
            const levels = {'æ™®é€š': 0, 'é—ªå…‰': 1, 'å¹»å½©': 2, 'æ˜ŸèŠ’': 3};
            return levels[rarityName] ?? -1;
        }

        function getUnlockLevelByRarity(mutationRarity) {
            const levels = { 'basic': 5, 'elite': 10, 'legendary': 15 };
            return levels[mutationRarity] || 99;
        }
        
        function getMutationRarityFromAnimalRarity(animalRarity) {
            const mapping = { 'é—ªå…‰': 'basic', 'å¹»å½©': 'elite', 'æ˜ŸèŠ’': 'legendary' };
            return mapping[animalRarity];
        }

        function getAnimalRarityFromMutationRarity(mutationRarity) {
            const mapping = { 'basic': 'é—ªå…‰', 'elite': 'å¹»å½©', 'legendary': 'æ˜ŸèŠ’' };
            return mapping[mutationRarity];
        }

        function updateAnimalStats(animal) {
             // ç¡®ä¿æ‰€æœ‰å±æ€§éƒ½åŸºäºæœ€æ–°çš„ç¨€æœ‰åº¦å’Œå…¶ä»–çŠ¶æ€è¿›è¡Œè®¡ç®—
             // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¸€ä¸ªç»Ÿä¸€çš„å±æ€§æ›´æ–°å‡½æ•°ï¼Œå¦‚æœå­˜åœ¨çš„è¯
        }

        function fuseAnimals() {
            if (isActionInProgress) return;

            const cost = 50;
            const parents = gameState.selectedAnimalsForFusion.map(id => gameState.animals.find(a => a.id === id)).filter(Boolean);
            if (parents.length !== 2 || gameState.food < cost) {
                showStatus('âŒ ä¸æ»¡è¶³èåˆæ¡ä»¶ã€‚', 2000);
                return;
            }

            isActionInProgress = true;
            gameState.food -= cost;
            updateResourceUI();
            updateFusionButton();

            // æ˜¾ç¤ºè¿›åº¦æ¡
            ui.fusionProgressContainer.classList.remove('hidden');
            let progress = 0;
            const interval = setInterval(() => {
                progress += 100 / (ACTION_DURATION / 100);
                ui.fusionProgressBar.style.width = `${Math.min(progress, 100)}%`;
            }, 100);

            setTimeout(() => {
                clearInterval(interval);
                const [p1, p2] = parents;
                const r = ((p1.color >> 16) + (p2.color >> 16)) / 2;
                const g = (((p1.color >> 8) & 0xFF) + ((p2.color >> 8) & 0xFF)) / 2;
                const b = ((p1.color & 0xFF) + (p2.color & 0xFF)) / 2;
                const newColor = (Math.floor(r) << 16) | (Math.floor(g) << 8) | Math.floor(b);
                
                gameState.animals = gameState.animals.filter(a => a.id !== p1.id && a.id !== p2.id);
                gameState.animalCount = gameState.animals.length;
                createNewAnimal(newColor, 'cube');
                showStatus(`ğŸ§¬ èåˆæˆåŠŸ! ${p1.name} å’Œ ${p2.name} åˆ›é€ äº†æ–°çš„å˜å¼‚ç”Ÿå‘½!`, 4000);

                isActionInProgress = false;
                gameState.selectedAnimalsForFusion = [];
                ui.fusionProgressContainer.classList.add('hidden');
                ui.fusionProgressBar.style.width = '0%';
                saveGameState(); // ä¿å­˜çŠ¶æ€
                updateResourceUI();
                renderFusionPanel();
            }, ACTION_DURATION);
        }

        // æ–°å¢ï¼šå¼ºåˆ¶é‡ç½®æ¸¸æˆæ•°æ®ï¼ˆä»…é‡ç½®æ¸¸æˆå†…æ•°æ®ï¼Œä¿ç•™æŠ€èƒ½è®¾è®¡å™¨ç­‰æ¸¸æˆå¤–æ•°æ®ï¼‰
        function resetGameData() {
            const isConfirmed = confirm("è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æ¸¸æˆè¿›åº¦å’ŒåŠ¨ç‰©æ•°æ®ï¼Œä½†ä¼šä¿ç•™æŠ€èƒ½è®¾è®¡å™¨ç­‰æ¸¸æˆå¤–æ•°æ®ã€‚æ‚¨ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿ");
            if (isConfirmed) {
                showStatus("æ­£åœ¨æ¸…é™¤æ¸¸æˆæ•°æ®...", 2000);
                
                // ä¿å­˜æ¸¸æˆå¤–æ•°æ®
                const skillPool = localStorage.getItem('SKILL_POOL');
                const animalPool = localStorage.getItem('ANIMAL_POOL');
                
                // æ¸…é™¤æ‰€æœ‰æ•°æ®
                localStorage.clear();
                
                // æ¢å¤æ¸¸æˆå¤–æ•°æ®
                if (skillPool) {
                    localStorage.setItem('SKILL_POOL', skillPool);
                }
                if (animalPool) {
                    localStorage.setItem('ANIMAL_POOL', animalPool);
                }
                
                setTimeout(() => {
                    window.location.href = 'game3d.html';
                }, 1000);
            }
        }
    </script>
    
    <!-- å¼•å…¥è°ƒè¯•å·¥å…· -->
    <script src="debug.js"></script>
</body>
</html>
