<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å›¾é…ç½®å™¨ - ç”µå­ç›†æ ½</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #7c2d12 0%, #991b1b 100%);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        
        .map-card {
            transition: all 0.3s ease;
        }
        
        .map-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        /* ç³»åˆ«é¢œè‰² */
        .element-water { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .element-fire { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .element-grass { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .element-wind { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .element-electric { background: linear-gradient(135deg, #eab308, #ca8a04); }
        .element-earth { background: linear-gradient(135deg, #a16207, #854d0e); }
        
        /* ç¨€æœ‰åº¦é¢œè‰² */
        .rarity-common { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .rarity-shiny { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .rarity-prismatic { background: linear-gradient(135deg, #ec4899, #8b5cf6, #3b82f6); }
        .rarity-stellar { background: linear-gradient(135deg, #fef3c7, #fde68a, #fbbf24); color: #92400e; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">ğŸ—ºï¸ åœ°å›¾é…ç½®å™¨ ğŸ—ºï¸</h1>
            <p class="text-orange-200">é…ç½®æ¯ä¸ªåœ°å›¾çš„åŠ¨ç‰©ç”Ÿæˆè§„åˆ™</p>
            <div class="mt-4 bg-orange-900/50 border border-orange-700 rounded-lg p-4 max-w-3xl mx-auto text-left">
                <p class="text-sm text-orange-200 font-bold mb-2">ğŸ’¡ åœ°å›¾ç”Ÿæˆæœºåˆ¶ï¼š</p>
                <div class="text-xs text-orange-100">
                    <div class="mb-2">â€¢ æ¯ä¸ªåœ°å›¾å¯ä»¥é…ç½®ä¸“å±çš„åŠ¨ç‰©ç”Ÿæˆæ± </div>
                    <div class="mb-2">â€¢ ä»åŠ¨ç‰©æ¨¡æ¿æ± ä¸­é€‰æ‹©è¯¥åœ°å›¾å¯ä»¥ç”Ÿæˆçš„åŠ¨ç‰©</div>
                    <div>â€¢ å¯ä»¥ä¸ºæ¯ä¸ªåŠ¨ç‰©è®¾ç½®åœ¨è¯¥åœ°å›¾çš„ç”Ÿæˆæƒé‡</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šåœ°å›¾é…ç½®è¡¨å• -->
            <div class="lg:col-span-2 bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ¨ é…ç½®åœ°å›¾</h2>
                
                <form id="map-form" class="space-y-4">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">åœ°å›¾åç§°</label>
                            <input type="text" id="map-name" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">åœ°å›¾å›¾æ ‡</label>
                            <input type="text" id="map-icon" required maxlength="2" value="ğŸ—ºï¸"
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white text-center text-2xl focus:outline-none focus:border-orange-500">
                        </div>
                    </div>

                    <!-- åœ°å›¾å±æ€§ -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">åœ°å›¾ç­‰çº§</label>
                            <input type="number" id="map-level" min="1" max="100" value="1" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500">
                            <p class="text-xs text-gray-400 mt-1">æ¨èåŠ¨ç‰©ç­‰çº§</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ç”Ÿæˆé—´éš”(ç§’)</label>
                            <input type="number" id="map-spawn-interval" min="1" max="3600" value="60" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500">
                            <p class="text-xs text-gray-400 mt-1">åŠ¨ç‰©ç”Ÿæˆé—´éš”</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">æœ€å¤§æ•°é‡</label>
                            <input type="number" id="map-max-animals" min="1" max="50" value="10" required
                                class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500">
                            <p class="text-xs text-gray-400 mt-1">åœ°å›¾åŠ¨ç‰©ä¸Šé™</p>
                        </div>
                    </div>

                    <!-- åœ°å›¾æè¿° -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">åœ°å›¾æè¿°</label>
                        <textarea id="map-desc" rows="2"
                            class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-orange-500"
                            placeholder="æè¿°è¿™ä¸ªåœ°å›¾çš„ç‰¹ç‚¹..."></textarea>
                    </div>

                    <!-- å­åœ°å›¾é…ç½® -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ—ºï¸ å­åœ°å›¾é…ç½®</label>
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-300">å·²é…ç½®å­åœ°å›¾ (<span id="submap-count-display">0</span>)</span>
                                <button type="button" id="add-submap-btn"
                                    class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-1 px-3 rounded transition-colors">
                                    + æ·»åŠ å­åœ°å›¾
                                </button>
                            </div>
                            <div id="submaps-config-list" class="space-y-2 max-h-48 overflow-y-auto">
                                <div class="text-center text-gray-500 text-sm py-4">
                                    ç‚¹å‡»"æ·»åŠ å­åœ°å›¾"é€‰æ‹©å·²åˆ›å»ºçš„åœ°å›¾
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åŠ¨ç‰©ç”Ÿæˆé…ç½® -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ğŸ¦ åŠ¨ç‰©ç”Ÿæˆé…ç½®</label>
                        <div class="bg-gray-800/50 rounded-lg p-4 border border-gray-600">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm text-gray-300">å·²é…ç½®åŠ¨ç‰© (<span id="animal-count-display">0</span>)</span>
                                <button type="button" id="add-animal-btn"
                                    class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-1 px-3 rounded transition-colors">
                                    + æ·»åŠ åŠ¨ç‰©
                                </button>
                            </div>
                            <div id="animals-config-list" class="space-y-2 max-h-64 overflow-y-auto">
                                <div class="text-center text-gray-500 text-sm py-4">
                                    ç‚¹å‡»"æ·»åŠ åŠ¨ç‰©"ä»åŠ¨ç‰©æ¨¡æ¿æ± ä¸­é€‰æ‹©
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æŒ‰é’® -->
                    <div class="flex gap-4 pt-4">
                        <button type="submit" id="submit-btn"
                            class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            <span id="submit-text">âœ¨ ä¿å­˜åœ°å›¾é…ç½®</span>
                        </button>
                        <button type="button" id="cancel-edit-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            âŒ å–æ¶ˆç¼–è¾‘
                        </button>
                        <button type="button" id="clear-btn"
                            class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            ğŸ”„ æ¸…ç©º
                        </button>
                    </div>
                </form>
            </div>

            <!-- å³ä¾§ï¼šåœ°å›¾é¢„è§ˆå’Œåˆ—è¡¨ -->
            <div class="space-y-6">
                <!-- åœ°å›¾é¢„è§ˆ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ‘ï¸ åœ°å›¾é¢„è§ˆ</h3>
                    <div id="map-preview" class="map-card bg-gray-800 rounded-lg p-4 border-2 border-gray-600">
                        <div class="text-center text-gray-500">
                            <div class="text-4xl mb-2">â“</div>
                            <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                        </div>
                    </div>
                </div>

                <!-- åœ°å›¾é…ç½®åˆ—è¡¨ -->
                <div class="bg-gray-900/80 backdrop-blur-lg rounded-xl p-6 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">ğŸ—ºï¸ åœ°å›¾é…ç½® (<span id="map-count">0</span>)</h3>
                        <div class="flex gap-2">
                            <label for="import-file" 
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors cursor-pointer">
                                ğŸ“¤ å¯¼å…¥
                            </label>
                            <input type="file" id="import-file" accept=".json" class="hidden">
                            <button id="export-btn"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ“¥ å¯¼å‡º
                            </button>
                            <button id="apply-to-game-btn"
                                class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                                ğŸ® åº”ç”¨
                            </button>
                        </div>
                    </div>
                    <div id="maps-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 text-sm py-8">
                            æš‚æ— åœ°å›¾é…ç½®
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å­åœ°å›¾é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="submap-select-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-xl p-6 max-w-2xl w-full mx-4 border border-gray-700 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">é€‰æ‹©å­åœ°å›¾</h3>
                <button id="close-submap-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>
            <div id="submap-pool-list" class="space-y-2">
                <!-- å­åœ°å›¾åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <!-- åŠ¨ç‰©é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="animal-select-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-xl p-6 max-w-2xl w-full mx-4 border border-gray-700 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">ä»åŠ¨ç‰©æ¨¡æ¿æ± é€‰æ‹©</h3>
                <button id="close-animal-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>
            <div id="animal-pool-list" class="space-y-2">
                <!-- åŠ¨ç‰©åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <!-- å˜ä½“æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="variant-template-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-900 rounded-xl p-6 max-w-2xl w-full mx-4 border border-gray-700 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">ä¸º <span id="variant-rarity-label"></span> é€‰æ‹©æ¨¡æ¿</h3>
                <button id="close-variant-modal" class="text-gray-400 hover:text-white text-2xl">Ã—</button>
            </div>
            <div id="variant-template-list" class="space-y-2">
                <!-- æ¨¡æ¿åˆ—è¡¨ -->
            </div>
        </div>
    </div>

    <script>
        // åœ°å›¾é…ç½®å­˜å‚¨
        let maps = JSON.parse(localStorage.getItem('MAP_CONFIGS') || '[]');
        // åŠ¨ç‰©æ¨¡æ¿æ± 
        let animalPool = JSON.parse(localStorage.getItem('ANIMAL_POOL') || '[]');
        // å½“å‰é…ç½®çš„åŠ¨ç‰©
        let configuredAnimals = [];
        // å½“å‰é…ç½®çš„å­åœ°å›¾
        let configuredSubmaps = [];
        // å½“å‰æ­£åœ¨ç¼–è¾‘çš„åœ°å›¾keyï¼ˆç”¨äºé¿å…å¾ªç¯å¼•ç”¨ï¼‰
        let currentEditingMapKey = null;
        // å½“å‰ç¼–è¾‘çš„åœ°å›¾ç´¢å¼•
        let editingIndex = -1;

        // DOMå…ƒç´ 
        const form = document.getElementById('map-form');
        const preview = document.getElementById('map-preview');
        const mapsList = document.getElementById('maps-list');
        const clearBtn = document.getElementById('clear-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const submitBtn = document.getElementById('submit-btn');
        const submitText = document.getElementById('submit-text');
        const exportBtn = document.getElementById('export-btn');

        // åˆå§‹åŒ–
        function init() {
            renderMapsList();
            setupFormListeners();
            updateMapCount();
            setupAnimalModal();
            setupSubmapModal();
            setupVariantTemplateModal();
        }

        // è®¾ç½®å­åœ°å›¾é€‰æ‹©æ¨¡æ€æ¡†
        function setupSubmapModal() {
            const modal = document.getElementById('submap-select-modal');
            const addSubmapBtn = document.getElementById('add-submap-btn');
            const closeBtn = document.getElementById('close-submap-modal');

            addSubmapBtn.onclick = () => {
                renderSubmapPool();
                modal.classList.remove('hidden');
            };

            closeBtn.onclick = () => modal.classList.add('hidden');
            modal.onclick = (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            };
        }

        // è®¾ç½®åŠ¨ç‰©é€‰æ‹©æ¨¡æ€æ¡†
        function setupAnimalModal() {
            const modal = document.getElementById('animal-select-modal');
            const addAnimalBtn = document.getElementById('add-animal-btn');
            const closeBtn = document.getElementById('close-animal-modal');

            addAnimalBtn.onclick = () => {
                renderAnimalPool();
                modal.classList.remove('hidden');
            };

            closeBtn.onclick = () => modal.classList.add('hidden');
            modal.onclick = (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            };
        }

        // æ¸²æŸ“å­åœ°å›¾æ± åˆ—è¡¨
        function renderSubmapPool() {
            const submapPoolList = document.getElementById('submap-pool-list');
            
            if (maps.length === 0) {
                submapPoolList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p class="mb-2">æš‚æ— å¯ç”¨åœ°å›¾</p>
                        <p class="text-sm">è¯·å…ˆåˆ›å»ºå…¶ä»–åœ°å›¾</p>
                    </div>
                `;
                return;
            }

            // è¿‡æ»¤å·²é…ç½®çš„å­åœ°å›¾å’Œå½“å‰ç¼–è¾‘çš„åœ°å›¾ï¼ˆé¿å…å¾ªç¯å¼•ç”¨ï¼‰
            const configuredKeys = new Set(configuredSubmaps.map(s => s.mapKey));
            const availableMaps = maps.filter(m =>
                !configuredKeys.has(m.key) && m.key !== currentEditingMapKey
            );

            if (availableMaps.length === 0) {
                submapPoolList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        æ‰€æœ‰åœ°å›¾éƒ½å·²é…ç½®æˆ–ä¸å¯ç”¨
                    </div>
                `;
                return;
            }

            submapPoolList.innerHTML = availableMaps.map(map => `
                <div class="bg-gray-800 rounded-lg p-3 border border-gray-600 hover:border-purple-500 cursor-pointer transition-colors"
                     onclick="selectSubmap('${map.key}')">
                    <div class="flex items-start gap-3">
                        <div class="text-3xl">${map.icon}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h5 class="text-sm font-bold text-white">${map.name}</h5>
                                <span class="bg-orange-600/30 text-orange-300 px-2 py-0.5 rounded text-xs">Lv.${map.level}</span>
                            </div>
                            <div class="flex gap-2 text-xs">
                                <span class="text-blue-400">â±ï¸${map.spawnInterval}s</span>
                                <span class="text-green-400">ğŸ¦${map.maxAnimals}åª</span>
                                <span class="text-gray-400">ğŸ²${map.animals?.length || 0}ç§</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // é€‰æ‹©å­åœ°å›¾
        function selectSubmap(mapKey) {
            const map = maps.find(m => m.key === mapKey);
            if (!map) return;

            configuredSubmaps.push({
                mapKey: map.key
            });

            renderConfiguredSubmaps();
            document.getElementById('submap-select-modal').classList.add('hidden');
        }

        // æ¸²æŸ“å·²é…ç½®çš„å­åœ°å›¾
        function renderConfiguredSubmaps() {
            const list = document.getElementById('submaps-config-list');
            document.getElementById('submap-count-display').textContent = configuredSubmaps.length;

            if (configuredSubmaps.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-4">
                        ç‚¹å‡»"æ·»åŠ å­åœ°å›¾"é€‰æ‹©å·²åˆ›å»ºçš„åœ°å›¾
                    </div>
                `;
                return;
            }

            list.innerHTML = configuredSubmaps.map((config, index) => {
                const map = maps.find(m => m.key === config.mapKey);
                if (!map) return '';

                return `
                    <div class="bg-gray-700/50 rounded-lg p-2 border border-gray-600">
                        <div class="flex items-center gap-2">
                            <div class="text-2xl flex-shrink-0">${map.icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold text-white truncate">${map.name}</div>
                                <div class="flex gap-2 text-xs">
                                    <span class="text-orange-400">Lv.${map.level}</span>
                                    <span class="text-gray-400">ğŸ²${map.animals?.length || 0}ç§åŠ¨ç‰©</span>
                                </div>
                            </div>
                            <button onclick="removeSubmap(${index})"
                                class="text-red-400 hover:text-red-300 text-xl flex-shrink-0">
                                Ã—
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç§»é™¤å­åœ°å›¾
        function removeSubmap(index) {
            configuredSubmaps.splice(index, 1);
            renderConfiguredSubmaps();
            updatePreview();
        }

        // æ¸²æŸ“åŠ¨ç‰©æ¨¡æ¿æ± åˆ—è¡¨
        function renderAnimalPool() {
            const animalPoolList = document.getElementById('animal-pool-list');
            
            if (animalPool.length === 0) {
                animalPoolList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p class="mb-2">åŠ¨ç‰©æ¨¡æ¿æ± ä¸ºç©º</p>
                        <p class="text-sm">è¯·å…ˆåœ¨åŠ¨ç‰©è®¾è®¡å™¨ä¸­åˆ›å»ºåŠ¨ç‰©æ¨¡æ¿</p>
                    </div>
                `;
                return;
            }

            // è¿‡æ»¤å·²é…ç½®çš„åŠ¨ç‰©
            // å¯¹äºæ™®é€šåŠ¨ç‰©ï¼Œå¦‚æœå·²ç»æœ‰ç»„å­˜åœ¨åˆ™ä¸æ˜¾ç¤º
            // å¯¹äºå…¶ä»–ç¨€æœ‰åº¦ï¼Œå¦‚æœå·²ç»å•ç‹¬æ·»åŠ åˆ™ä¸æ˜¾ç¤º
            const configuredKeys = new Set();
            configuredAnimals.forEach(config => {
                const animal = animalPool.find(a => a.key === config.animalKey);
                if (animal) {
                    if (config.groupId) {
                        // å¦‚æœæ˜¯ç»„çš„ä¸€éƒ¨åˆ†ï¼Œæ ‡è®°æ•´ä¸ªåŠ¨ç‰©key
                        configuredKeys.add(config.animalKey);
                    } else {
                        // å¦‚æœæ˜¯ç‹¬ç«‹é…ç½®ï¼Œæ ‡è®° key+ç¨€æœ‰åº¦
                        configuredKeys.add(`${config.animalKey}_${config.rarityType}`);
                    }
                }
            });
            
            const availableAnimals = animalPool.filter(animal => {
                // å¦‚æœåŠ¨ç‰©å·²ç»ä½œä¸ºç»„å­˜åœ¨ï¼Œä¸æ˜¾ç¤º
                if (configuredKeys.has(animal.key)) {
                    return false;
                }
                // å¦‚æœæ˜¯éæ™®é€šç¨€æœ‰åº¦ä¸”å·²å•ç‹¬æ·»åŠ ï¼Œä¸æ˜¾ç¤º
                if (animal.rarity !== 'common' && configuredKeys.has(`${animal.key}_${animal.rarity}`)) {
                    return false;
                }
                return true;
            });

            if (availableAnimals.length === 0) {
                animalPoolList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        æ‰€æœ‰åŠ¨ç‰©éƒ½å·²é…ç½®
                    </div>
                `;
                return;
            }

            animalPoolList.innerHTML = availableAnimals.map(animal => {
                const elementClass = `element-${animal.element}`;
                const rarityClass = `rarity-${animal.rarity}`;
                
                return `
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-600 hover:border-green-500 cursor-pointer transition-colors"
                         onclick="selectAnimal('${animal.key}')">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 rounded-full border-2 border-white flex-shrink-0" style="background-color: ${animal.color}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <h5 class="text-sm font-bold text-white">${animal.name}</h5>
                                    <span class="badge ${elementClass} text-xs">${getElementName(animal.element)}</span>
                                    <span class="badge ${rarityClass} text-xs">${getRarityName(animal.rarity)}</span>
                                </div>
                                <div class="flex gap-2 text-xs">
                                    <span class="text-orange-400">ğŸ“ŠLv.${animal.level}</span>
                                    <span class="text-pink-400">ğŸ’—${animal.health}</span>
                                    <span class="text-red-400">âš”ï¸${animal.attack}</span>
                                    <span class="text-blue-400">ğŸ›¡ï¸${animal.defense}</span>
                                    <span class="text-yellow-400">âš¡${animal.agility}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // é€‰æ‹©åŠ¨ç‰©
        function selectAnimal(animalKey) {
            const animal = animalPool.find(a => a.key === animalKey);
            if (!animal) return;

            // é»˜è®¤æ½œåŠ›æ¯”ä¾‹æ ¹æ®ç¨€æœ‰åº¦è®¾ç½®
            const defaultGrowthByRarity = {
                'common': { mediocre: 60, extraordinary: 35, brilliant: 5 },
                'shiny': { mediocre: 30, extraordinary: 50, brilliant: 20 },
                'prismatic': { mediocre: 10, extraordinary: 40, brilliant: 50 },
                'stellar': { mediocre: 0, extraordinary: 20, brilliant: 80 }
            };
            
            const defaultWeightByRarity = {
                'common': 85,
                'shiny': 12,
                'prismatic': 2.5,
                'stellar': 0.5
            };
            
            // å¦‚æœæ˜¯æ™®é€šåŠ¨ç‰©ï¼Œè‡ªåŠ¨åˆ›å»ºå››ä¸ªç¨€æœ‰åº¦æ ä½ï¼ˆæ™®é€šã€é—ªå…‰ã€å¹»å½©ã€æ˜ŸèŠ’ï¼‰
            if (animal.rarity === 'common') {
                const rarityTypes = ['common', 'shiny', 'prismatic', 'stellar'];
                const groupId = `GROUP_${Date.now()}`;
                
                rarityTypes.forEach(rarityType => {
                    configuredAnimals.push({
                        animalKey: animal.key,
                        rarityType: rarityType,
                        weight: defaultWeightByRarity[rarityType] || 10,
                        growthRatios: defaultGrowthByRarity[rarityType] || { mediocre: 20, extraordinary: 50, brilliant: 30 },
                        groupId: groupId // æ ‡è®°ä¸ºåŒä¸€ç»„
                    });
                });
            } else {
                // éæ™®é€šåŠ¨ç‰©ï¼Œåªæ·»åŠ å•ä¸ªé…ç½®
                configuredAnimals.push({
                    animalKey: animal.key,
                    rarityType: animal.rarity,
                    weight: defaultWeightByRarity[animal.rarity] || 10,
                    growthRatios: defaultGrowthByRarity[animal.rarity] || { mediocre: 20, extraordinary: 50, brilliant: 30 }
                });
            }

            renderConfiguredAnimals();
            document.getElementById('animal-select-modal').classList.add('hidden');
        }

        // æ¸²æŸ“å·²é…ç½®çš„åŠ¨ç‰©
        function renderConfiguredAnimals() {
            const list = document.getElementById('animals-config-list');
            
            // ç»Ÿè®¡ç‹¬ç«‹åŠ¨ç‰©å’Œç»„çš„æ•°é‡
            const groups = new Set(configuredAnimals.filter(a => a.groupId).map(a => a.groupId));
            const independentAnimals = configuredAnimals.filter(a => !a.groupId).length;
            const totalCount = groups.size + independentAnimals;
            
            document.getElementById('animal-count-display').textContent = totalCount;

            if (configuredAnimals.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-4">
                        ç‚¹å‡»"æ·»åŠ åŠ¨ç‰©"ä»åŠ¨ç‰©æ¨¡æ¿æ± ä¸­é€‰æ‹©
                    </div>
                `;
                return;
            }

            // æŒ‰ç»„åˆ†ç±»åŠ¨ç‰©
            const groupedAnimals = {};
            const independentAnimalsList = [];
            
            configuredAnimals.forEach((config, index) => {
                if (config.groupId) {
                    if (!groupedAnimals[config.groupId]) {
                        groupedAnimals[config.groupId] = [];
                    }
                    groupedAnimals[config.groupId].push({ config, index });
                } else {
                    independentAnimalsList.push({ config, index });
                }
            });

            let html = '';

            // æ¸²æŸ“åˆ†ç»„çš„åŠ¨ç‰©ï¼ˆå››ä¸ªç¨€æœ‰åº¦ä¸€ç»„ï¼‰
            Object.entries(groupedAnimals).forEach(([groupId, items]) => {
                const firstAnimal = animalPool.find(a => a.key === items[0].config.animalKey);
                if (!firstAnimal) return;

                const elementClass = `element-${firstAnimal.element}`;
                
                // è®¡ç®—ç»„çš„æƒé‡æ€»å’Œ
                const groupWeightSum = items.reduce((sum, item) => sum + (item.config.weight || 0), 0);
                const isWeightValid = Math.abs(groupWeightSum - 100) < 0.01;
                
                html += `
                    <div class="bg-gray-800/70 rounded-lg p-3 border-2 border-blue-600/50 mb-3">
                        <div class="flex items-center gap-2 mb-3 cursor-pointer hover:bg-gray-700/30 rounded p-2 -m-2" onclick="toggleVariantGroup('${groupId}')">
                            <span id="toggle-icon-${groupId}" class="text-blue-400 text-lg flex-shrink-0">â–¼</span>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <span class="text-base font-bold text-white">${firstAnimal.name}</span>
                                    <span class="badge ${elementClass} text-xs">${getElementName(firstAnimal.element)}</span>
                                    <span class="bg-blue-600/30 text-blue-300 px-2 py-0.5 rounded text-xs">ğŸ² ç¨€æœ‰åº¦ç»„ (${items.length}ä¸ªå˜ä½“)</span>
                                    <span class="text-xs px-2 py-0.5 rounded ${isWeightValid ? 'bg-green-600/30 text-green-300' : 'bg-red-600/30 text-red-300'}">
                                        âš–ï¸ ${groupWeightSum.toFixed(1)}% ${isWeightValid ? 'âœ“' : 'âœ—'}
                                    </span>
                                </div>
                            </div>
                            <button type="button" onclick="event.stopPropagation(); removeAnimalGroup('${groupId}')"
                                class="text-red-400 hover:text-red-300 text-xl flex-shrink-0"
                                title="åˆ é™¤æ•´ç»„">
                                Ã—
                            </button>
                        </div>
                        
                        <!-- ç¨€æœ‰åº¦å˜ä½“åˆ—è¡¨ -->
                        <div id="variant-list-${groupId}" class="space-y-2">
                            ${items.map(({ config, index }) => {
                                const rarityType = config.rarityType || 'common';
                                const rarityClass = `rarity-${rarityType}`;
                                
                                const growthRatios = config.growthRatios || { mediocre: 20, extraordinary: 50, brilliant: 30 };
                                const growthTotal = growthRatios.mediocre + growthRatios.extraordinary + growthRatios.brilliant;
                                const isValid = Math.abs(growthTotal - 100) < 0.01;
                                
                                const rarityLabels = {
                                    'common': 'âšª æ™®é€š',
                                    'shiny': 'âœ¨ é—ªå…‰',
                                    'prismatic': 'ğŸŒˆ å¹»å½©',
                                    'stellar': 'â­ æ˜ŸèŠ’'
                                };
                                const rarityLabel = rarityLabels[rarityType] || 'âšª æ™®é€š';
                                
                                const colorThemes = {
                                    'common': 'gray',
                                    'shiny': 'yellow',
                                    'prismatic': 'pink',
                                    'stellar': 'orange'
                                };
                                const colorTheme = colorThemes[rarityType] || 'gray';
                                
                                // è·å–å½“å‰é€‰æ‹©çš„æ¨¡æ¿ï¼ˆæ™®é€šæ ä½ä½¿ç”¨åŸå§‹animalKeyï¼Œå…¶ä»–ä½¿ç”¨selectedAnimalKeyï¼‰
                                const selectedAnimal = rarityType === 'common' ?
                                    animalPool.find(a => a.key === config.animalKey) :
                                    (config.selectedAnimalKey ? animalPool.find(a => a.key === config.selectedAnimalKey) : null);

                                return `
                                    <div class="bg-gray-700/50 rounded-lg p-2 border border-${colorTheme}-600/50">
                                        <div class="flex items-start gap-2">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                                    <span class="badge ${rarityClass} text-xs">${rarityLabel}</span>
                                                    ${rarityType !== 'common' ? `
                                                        <button type="button" onclick="selectTemplateForVariant('${config.groupId}', '${rarityType}')"
                                                            class="bg-${colorTheme}-600/30 hover:bg-${colorTheme}-600/50 text-${colorTheme}-300 text-xs px-2 py-1 rounded transition-colors">
                                                            ${selectedAnimal ? 'âœï¸ æ›´æ¢æ¨¡æ¿' : 'â• é€‰æ‹©æ¨¡æ¿'}
                                                        </button>
                                                        ${selectedAnimal ? `
                                                            <button type="button" onclick="clearTemplateForVariant('${config.groupId}', '${rarityType}')"
                                                                class="text-red-400 hover:text-red-300 text-xs"
                                                                title="æ¸…é™¤æ¨¡æ¿">
                                                                Ã—
                                                            </button>
                                                        ` : ''}
                                                    ` : `
                                                        <span class="text-xs text-gray-400">ï¼ˆåŸºç¡€æ¨¡æ¿ï¼‰</span>
                                                    `}
                                                    <div class="flex items-center gap-1">
                                                        <label class="text-xs text-gray-500">æƒé‡</label>
                                                        <input type="number" min="0" max="100" step="0.1" value="${config.weight}"
                                                            onchange="updateAnimalWeight(${index}, this.value)"
                                                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-${colorTheme}-500">
                                                    </div>
                                                </div>
                                                
                                                ${selectedAnimal ? `
                                                    <div class="bg-gray-800/50 rounded p-2 mb-2 border border-${colorTheme}-600/30">
                                                        <div class="flex items-center gap-2">
                                                            <div class="w-8 h-8 rounded-full border border-white flex-shrink-0" style="background-color: ${selectedAnimal.color}"></div>
                                                            <div class="flex-1 min-w-0">
                                                                <div class="text-xs font-bold text-white truncate">${selectedAnimal.name}</div>
                                                                <div class="text-xs text-gray-400">
                                                                    âš”ï¸${selectedAnimal.attack} ğŸ›¡ï¸${selectedAnimal.defense} âš¡${selectedAnimal.agility}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                
                                                <div class="bg-gray-800/50 rounded p-2 border ${isValid ? 'border-gray-600' : 'border-red-500'}">
                                                    <div class="text-xs text-gray-400 mb-1">ğŸ“ˆ æ½œåŠ›æ¯”ä¾‹</div>
                                                    <div class="grid grid-cols-3 gap-1">
                                                        <div>
                                                            <label class="text-xs text-gray-500">â­</label>
                                                            <div class="flex items-center gap-1">
                                                                <input type="number" min="0" max="100" step="1" value="${growthRatios.mediocre}"
                                                                    onchange="updateGrowthRatio(${index}, 'mediocre', this.value)"
                                                                    class="w-full bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-white text-xs focus:outline-none">
                                                                <span class="text-xs text-gray-500">%</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="text-xs text-blue-400">â­â­</label>
                                                            <div class="flex items-center gap-1">
                                                                <input type="number" min="0" max="100" step="1" value="${growthRatios.extraordinary}"
                                                                    onchange="updateGrowthRatio(${index}, 'extraordinary', this.value)"
                                                                    class="w-full bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-white text-xs focus:outline-none">
                                                                <span class="text-xs text-gray-500">%</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="text-xs text-purple-400">â­â­â­</label>
                                                            <div class="flex items-center gap-1">
                                                                <input type="number" min="0" max="100" step="1" value="${growthRatios.brilliant}"
                                                                    onchange="updateGrowthRatio(${index}, 'brilliant', this.value)"
                                                                    class="w-full bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-white text-xs focus:outline-none">
                                                                <span class="text-xs text-gray-500">%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="text-xs mt-1 text-center ${isValid ? 'text-green-400' : 'text-red-400'}">
                                                        ${growthTotal.toFixed(1)}% ${isValid ? 'âœ“' : 'âœ—'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            // æ¸²æŸ“ç‹¬ç«‹çš„åŠ¨ç‰©ï¼ˆéæ™®é€šç¨€æœ‰åº¦æˆ–å•ç‹¬æ·»åŠ çš„ï¼‰
            independentAnimalsList.forEach(({ config, index }) => {
                const animal = animalPool.find(a => a.key === config.animalKey);
                if (!animal) return;

                const elementClass = `element-${animal.element}`;
                const rarityType = config.rarityType || 'common';
                const rarityClass = `rarity-${rarityType}`;
                
                const growthRatios = config.growthRatios || { mediocre: 20, extraordinary: 50, brilliant: 30 };
                const growthTotal = growthRatios.mediocre + growthRatios.extraordinary + growthRatios.brilliant;
                const isValid = Math.abs(growthTotal - 100) < 0.01;
                
                const rarityLabels = {
                    'common': 'âšª æ™®é€š',
                    'shiny': 'âœ¨ é—ªå…‰',
                    'prismatic': 'ğŸŒˆ å¹»å½©',
                    'stellar': 'â­ æ˜ŸèŠ’'
                };
                const rarityLabel = rarityLabels[rarityType] || 'âšª æ™®é€š';
                
                const colorThemes = {
                    'common': 'gray',
                    'shiny': 'yellow',
                    'prismatic': 'pink',
                    'stellar': 'orange'
                };
                const colorTheme = colorThemes[rarityType] || 'gray';

                html += `
                    <div class="bg-gray-700/50 rounded-lg p-3 border border-${colorTheme}-600/50 mb-2">
                        <div class="flex items-start gap-2">
                            <div class="w-10 h-10 rounded-full border-2 border-white flex-shrink-0" style="background-color: ${animal.color}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1 mb-2 flex-wrap">
                                    <span class="text-sm font-bold text-white truncate">${animal.name}</span>
                                    <span class="badge ${elementClass} text-xs">${getElementName(animal.element)}</span>
                                    <span class="badge ${rarityClass} text-xs">${rarityLabel}</span>
                                </div>
                                <div class="flex gap-2 text-xs mb-2">
                                    <span class="text-orange-400">ğŸ“ŠLv.${animal.level}</span>
                                    <span class="text-red-400">âš”ï¸${animal.attack}</span>
                                    <span class="text-blue-400">ğŸ›¡ï¸${animal.defense}</span>
                                    <div class="flex items-center gap-1">
                                        <label class="text-gray-500">æƒé‡</label>
                                        <input type="number" min="0" max="100" step="0.1" value="${config.weight}"
                                            onchange="updateAnimalWeight(${index}, this.value)"
                                            class="w-16 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-${colorTheme}-500">
                                    </div>
                                </div>
                                
                                <div class="bg-gray-800/50 rounded p-2 border ${isValid ? 'border-gray-600' : 'border-red-500'}">
                                    <div class="text-xs text-gray-400 mb-1">ğŸ“ˆ æ½œåŠ›æ¯”ä¾‹ (æ€»å’Œéœ€100%)</div>
                                    <div class="grid grid-cols-3 gap-1">
                                        <div>
                                            <label class="text-xs text-gray-500">â­</label>
                                            <div class="flex items-center gap-1">
                                                <input type="number" min="0" max="100" step="1" value="${growthRatios.mediocre}"
                                                    onchange="updateGrowthRatio(${index}, 'mediocre', this.value)"
                                                    class="w-full bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-white text-xs focus:outline-none">
                                                <span class="text-xs text-gray-500">%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-xs text-blue-400">â­â­</label>
                                            <div class="flex items-center gap-1">
                                                <input type="number" min="0" max="100" step="1" value="${growthRatios.extraordinary}"
                                                    onchange="updateGrowthRatio(${index}, 'extraordinary', this.value)"
                                                    class="w-full bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-white text-xs focus:outline-none">
                                                <span class="text-xs text-gray-500">%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-xs text-purple-400">â­â­â­</label>
                                            <div class="flex items-center gap-1">
                                                <input type="number" min="0" max="100" step="1" value="${growthRatios.brilliant}"
                                                    onchange="updateGrowthRatio(${index}, 'brilliant', this.value)"
                                                    class="w-full bg-gray-700 border border-gray-600 rounded px-1 py-0.5 text-white text-xs focus:outline-none">
                                                <span class="text-xs text-gray-500">%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-xs mt-1 text-center ${isValid ? 'text-green-400' : 'text-red-400'}">
                                        æ€»å’Œ: ${growthTotal.toFixed(1)}% ${isValid ? 'âœ“' : 'âœ—'}
                                    </div>
                                </div>
                            </div>
                            <button onclick="removeAnimal(${index})"
                                class="text-red-400 hover:text-red-300 text-xl flex-shrink-0">
                                Ã—
                            </button>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // æ›´æ–°åŠ¨ç‰©æƒé‡
        function updateAnimalWeight(index, weight) {
            const newWeight = parseFloat(weight) || 0;
            const config = configuredAnimals[index];
            
            // å¦‚æœæ˜¯ç»„çš„ä¸€éƒ¨åˆ†ï¼Œéœ€è¦è”åŠ¨è°ƒæ•´å…¶ä»–ç¨€æœ‰åº¦çš„æƒé‡ï¼Œä¿è¯æ€»å’Œä¸º100
            if (config.groupId) {
                // æ‰¾åˆ°åŒç»„çš„æ‰€æœ‰é…ç½®
                const groupConfigs = configuredAnimals
                    .map((c, i) => ({ config: c, index: i }))
                    .filter(item => item.config.groupId === config.groupId);
                
                if (groupConfigs.length > 1) {
                    // é™åˆ¶æ–°æƒé‡ä¸è¶…è¿‡100
                    const limitedWeight = Math.min(newWeight, 100);
                    
                    // è®¡ç®—å…¶ä»–é…ç½®çš„å½“å‰æƒé‡æ€»å’Œ
                    const otherConfigs = groupConfigs.filter(item => item.index !== index);
                    const otherWeightsSum = otherConfigs.reduce((sum, item) => sum + (item.config.weight || 0), 0);
                    
                    // è®¡ç®—å‰©ä½™æƒé‡
                    const remainingWeight = 100 - limitedWeight;
                    
                    if (remainingWeight >= 0) {
                        if (otherWeightsSum > 0) {
                            // æŒ‰æ¯”ä¾‹åˆ†é…å‰©ä½™æƒé‡ç»™å…¶ä»–é…ç½®
                            otherConfigs.forEach(item => {
                                const ratio = item.config.weight / otherWeightsSum;
                                configuredAnimals[item.index].weight = parseFloat((remainingWeight * ratio).toFixed(2));
                            });
                        } else {
                            // å¦‚æœå…¶ä»–æƒé‡éƒ½æ˜¯0ï¼Œå¹³å‡åˆ†é…
                            const avgWeight = parseFloat((remainingWeight / otherConfigs.length).toFixed(2));
                            otherConfigs.forEach(item => {
                                configuredAnimals[item.index].weight = avgWeight;
                            });
                        }
                    }
                    
                    // æ›´æ–°å½“å‰é…ç½®çš„æƒé‡
                    configuredAnimals[index].weight = limitedWeight;
                } else {
                    // åªæœ‰ä¸€ä¸ªé…ç½®ï¼Œç›´æ¥è®¾ç½®
                    configuredAnimals[index].weight = newWeight;
                }
            } else {
                // ä¸æ˜¯ç»„çš„ä¸€éƒ¨åˆ†ï¼Œç›´æ¥æ›´æ–°
                configuredAnimals[index].weight = newWeight;
            }
            
            renderConfiguredAnimals();
            updatePreview();
        }
        
        // æ›´æ–°æ½œåŠ›æ¯”ä¾‹
        function updateGrowthRatio(index, growthType, value) {
            if (!configuredAnimals[index].growthRatios) {
                configuredAnimals[index].growthRatios = {
                    mediocre: 0,
                    extraordinary: 0,
                    brilliant: 0
                };
            }
            configuredAnimals[index].growthRatios[growthType] = parseFloat(value) || 0;
            renderConfiguredAnimals();
            updatePreview();
        }

        // ç§»é™¤åŠ¨ç‰©
        function removeAnimal(index) {
            configuredAnimals.splice(index, 1);
            renderConfiguredAnimals();
            updatePreview();
        }
        
        // ç§»é™¤æ•´ç»„åŠ¨ç‰©
        function removeAnimalGroup(groupId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ¨ç‰©çš„æ‰€æœ‰ç¨€æœ‰åº¦å˜ä½“å—ï¼Ÿ')) {
                configuredAnimals = configuredAnimals.filter(a => a.groupId !== groupId);
                renderConfiguredAnimals();
                updatePreview();
            }
        }
        
        // åˆ‡æ¢å˜ä½“ç»„çš„å±•å¼€/æŠ˜å çŠ¶æ€
        function toggleVariantGroup(groupId) {
            const variantList = document.getElementById(`variant-list-${groupId}`);
            const toggleIcon = document.getElementById(`toggle-icon-${groupId}`);
            
            if (variantList && toggleIcon) {
                if (variantList.style.display === 'none') {
                    variantList.style.display = 'block';
                    toggleIcon.textContent = 'â–¼';
                } else {
                    variantList.style.display = 'none';
                    toggleIcon.textContent = 'â–¶';
                }
            }
        }
        
        // å½“å‰æ­£åœ¨é€‰æ‹©æ¨¡æ¿çš„å˜ä½“ä¿¡æ¯
        let selectingVariantGroupId = '';
        let selectingVariantRarity = '';
        
        // ä¸ºå˜ä½“é€‰æ‹©æ¨¡æ¿
        function selectTemplateForVariant(groupId, rarityType) {
            selectingVariantGroupId = groupId;
            selectingVariantRarity = rarityType;
            
            const rarityLabels = {
                'shiny': 'âœ¨ é—ªå…‰',
                'prismatic': 'ğŸŒˆ å¹»å½©',
                'stellar': 'â­ æ˜ŸèŠ’'
            };
            
            document.getElementById('variant-rarity-label').textContent = rarityLabels[rarityType] || rarityType;
            
            // æ¸²æŸ“å¯é€‰æ¨¡æ¿åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºå¯¹åº”ç¨€æœ‰åº¦çš„æ¨¡æ¿ï¼‰
            renderVariantTemplateList(rarityType);
            
            document.getElementById('variant-template-modal').classList.remove('hidden');
        }
        
        // æ¸²æŸ“å˜ä½“æ¨¡æ¿åˆ—è¡¨
        function renderVariantTemplateList(rarityType) {
            const list = document.getElementById('variant-template-list');
            
            // è¿‡æ»¤å‡ºå¯¹åº”ç¨€æœ‰åº¦çš„æ¨¡æ¿
            const availableTemplates = animalPool.filter(a => a.rarity === rarityType);
            
            if (availableTemplates.length === 0) {
                list.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p class="mb-2">æš‚æ— ${rarityType}ç¨€æœ‰åº¦çš„æ¨¡æ¿</p>
                        <p class="text-sm">è¯·å…ˆåœ¨åŠ¨ç‰©è®¾è®¡å™¨ä¸­åˆ›å»ºå¯¹åº”ç¨€æœ‰åº¦çš„æ¨¡æ¿</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = availableTemplates.map(animal => {
                const elementClass = `element-${animal.element}`;
                const rarityClass = `rarity-${animal.rarity}`;
                
                return `
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-600 hover:border-green-500 cursor-pointer transition-colors"
                         onclick="confirmVariantTemplate('${animal.key}')">
                        <div class="flex items-start gap-3">
                            <div class="w-12 h-12 rounded-full border-2 border-white flex-shrink-0" style="background-color: ${animal.color}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1 flex-wrap">
                                    <h5 class="text-sm font-bold text-white">${animal.name}</h5>
                                    <span class="badge ${elementClass} text-xs">${getElementName(animal.element)}</span>
                                    <span class="badge ${rarityClass} text-xs">${getRarityName(animal.rarity)}</span>
                                </div>
                                <div class="flex gap-2 text-xs">
                                    <span class="text-orange-400">ğŸ“ŠLv.${animal.level}</span>
                                    <span class="text-pink-400">ğŸ’—${animal.health}</span>
                                    <span class="text-red-400">âš”ï¸${animal.attack}</span>
                                    <span class="text-blue-400">ğŸ›¡ï¸${animal.defense}</span>
                                    <span class="text-yellow-400">âš¡${animal.agility}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ç¡®è®¤é€‰æ‹©å˜ä½“æ¨¡æ¿
        function confirmVariantTemplate(animalKey) {
            if (selectingVariantGroupId && selectingVariantRarity) {
                // æ‰¾åˆ°å¯¹åº”çš„å˜ä½“é…ç½®
                const variantIndex = configuredAnimals.findIndex(
                    a => a.groupId === selectingVariantGroupId && a.rarityType === selectingVariantRarity
                );
                
                if (variantIndex >= 0) {
                    configuredAnimals[variantIndex].selectedAnimalKey = animalKey;
                    renderConfiguredAnimals();
                    document.getElementById('variant-template-modal').classList.add('hidden');
                    selectingVariantGroupId = '';
                    selectingVariantRarity = '';
                }
            }
        }
        
        // æ¸…é™¤å˜ä½“æ¨¡æ¿
        function clearTemplateForVariant(groupId, rarityType) {
            if (confirm('ç¡®å®šè¦æ¸…é™¤è¿™ä¸ªå˜ä½“çš„æ¨¡æ¿å—ï¼Ÿ')) {
                const variantIndex = configuredAnimals.findIndex(
                    a => a.groupId === groupId && a.rarityType === rarityType
                );
                
                if (variantIndex >= 0) {
                    delete configuredAnimals[variantIndex].selectedAnimalKey;
                    renderConfiguredAnimals();
                }
            }
        }
        
        // è®¾ç½®å˜ä½“æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†
        function setupVariantTemplateModal() {
            const modal = document.getElementById('variant-template-modal');
            const closeBtn = document.getElementById('close-variant-modal');
            
            closeBtn.onclick = () => {
                modal.classList.add('hidden');
                selectingVariantIndex = -1;
                selectingVariantRarity = '';
            };
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    selectingVariantIndex = -1;
                    selectingVariantRarity = '';
                }
            };
        }

        // æ›´æ–°åœ°å›¾æ•°é‡æ˜¾ç¤º
        function updateMapCount() {
            document.getElementById('map-count').textContent = maps.length;
        }

        // è®¾ç½®è¡¨å•ç›‘å¬å™¨
        function setupFormListeners() {
            // å®æ—¶é¢„è§ˆ
            form.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updatePreview);
            });

            // æäº¤è¡¨å•
            form.onsubmit = (e) => {
                e.preventDefault();
                if (editingIndex >= 0) {
                    updateMap();
                } else {
                    createMap();
                }
            };

            // æ¸…ç©ºæŒ‰é’®
            clearBtn.onclick = () => {
                form.reset();
                configuredAnimals = [];
                configuredSubmaps = [];
                currentEditingMapKey = null;
                cancelEdit();
                renderConfiguredAnimals();
                renderConfiguredSubmaps();
                updatePreview();
            };

            // å–æ¶ˆç¼–è¾‘æŒ‰é’®
            cancelEditBtn.onclick = () => {
                form.reset();
                configuredAnimals = [];
                configuredSubmaps = [];
                currentEditingMapKey = null;
                cancelEdit();
                renderConfiguredAnimals();
                renderConfiguredSubmaps();
                updatePreview();
            };

            // å¯¼å‡ºæŒ‰é’®
            exportBtn.onclick = exportMaps;

            // å¯¼å…¥æŒ‰é’®
            document.getElementById('import-file').onchange = importMaps;

            // åº”ç”¨åˆ°æ¸¸æˆæŒ‰é’®
            document.getElementById('apply-to-game-btn').onclick = applyToGame;
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const data = getFormData();
            if (!data.name) {
                preview.innerHTML = `
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-2">â“</div>
                        <div class="text-sm">å¡«å†™è¡¨å•æŸ¥çœ‹é¢„è§ˆ</div>
                    </div>
                `;
                return;
            }

            const totalAnimals = configuredAnimals.length;

            preview.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <div class="text-4xl">${data.icon}</div>
                        <div class="flex-1">
                            <h4 class="text-lg font-bold text-white mb-1">${data.name}</h4>
                            <p class="text-xs text-gray-300">${data.desc || 'æš‚æ— æè¿°'}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        <div class="bg-orange-600/20 text-orange-300 px-2 py-1 rounded">ğŸ“Š Lv.${data.level}</div>
                        <div class="bg-blue-600/20 text-blue-300 px-2 py-1 rounded">â±ï¸ ${data.spawnInterval}s</div>
                        <div class="bg-green-600/20 text-green-300 px-2 py-1 rounded">ğŸ¦ ${data.maxAnimals}åª</div>
                    </div>
                    ${configuredSubmaps.length > 0 ? `
                        <div class="border-t border-gray-600 pt-2">
                            <div class="text-xs text-gray-400 mb-1">å­åœ°å›¾ (${configuredSubmaps.length}ä¸ª):</div>
                            <div class="text-xs text-purple-300">
                                ${configuredSubmaps.map(s => {
                                    const submap = maps.find(m => m.key === s.mapKey);
                                    return submap ? `${submap.icon} ${submap.name}` : '';
                                }).filter(s => s).join(' | ')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="border-t border-gray-600 pt-2">
                        <div class="text-xs text-gray-400 mb-1">åŠ¨ç‰©ç”Ÿæˆæ±  (${totalAnimals}ç§):</div>
                        <div class="text-xs text-gray-300">
                            ${totalAnimals > 0 ? 'å·²é…ç½®åŠ¨ç‰©åŠç¨€æœ‰åº¦æ§½ä½' : 'æœªé…ç½®åŠ¨ç‰©'}
                        </div>
                    </div>
                </div>
            `;
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            return {
                name: document.getElementById('map-name').value,
                icon: document.getElementById('map-icon').value,
                level: parseInt(document.getElementById('map-level').value) || 1,
                spawnInterval: parseInt(document.getElementById('map-spawn-interval').value) || 60,
                maxAnimals: parseInt(document.getElementById('map-max-animals').value) || 10,
                desc: document.getElementById('map-desc').value
            };
        }

        // åˆ›å»ºåœ°å›¾é…ç½®
        function createMap() {
            if (configuredAnimals.length === 0 && configuredSubmaps.length === 0) {
                alert('âŒ è¯·è‡³å°‘é…ç½®ä¸€ä¸ªåŠ¨ç‰©æˆ–å­åœ°å›¾ï¼');
                return;
            }

            const data = getFormData();
            const mapKey = `MAP_${Date.now()}`;
            
            const map = {
                key: mapKey,
                ...data,
                submaps: configuredSubmaps.map(s => ({...s})),
                animals: configuredAnimals.map(a => ({...a})),
                createdAt: new Date().toISOString()
            };

            maps.push(map);
            saveMapConfigs();
            
            console.log('åœ°å›¾å·²ä¿å­˜:', map);
            console.log('å½“å‰æ‰€æœ‰åœ°å›¾:', maps);
            console.log('localStorageä¸­çš„åœ°å›¾:', localStorage.getItem('MAP_CONFIGS'));
            
            renderMapsList();
            updateMapCount();
            form.reset();
            configuredAnimals = [];
            configuredSubmaps = [];
            currentEditingMapKey = null;
            renderConfiguredAnimals();
            renderConfiguredSubmaps();
            updatePreview();
            
            const summary = [];
            if (map.submaps.length > 0) summary.push(`${map.submaps.length} ä¸ªå­åœ°å›¾`);
            if (map.animals.length > 0) summary.push(`${map.animals.length} ç§åŠ¨ç‰©`);
            
            alert(`âœ… åœ°å›¾é…ç½® "${data.name}" å·²ä¿å­˜ï¼\né…ç½®äº† ${summary.join('ã€')}`);
        }

        // æ›´æ–°åœ°å›¾é…ç½®
        function updateMap() {
            if (configuredAnimals.length === 0 && configuredSubmaps.length === 0) {
                alert('âŒ è¯·è‡³å°‘é…ç½®ä¸€ä¸ªåŠ¨ç‰©æˆ–å­åœ°å›¾ï¼');
                return;
            }

            const data = getFormData();
            
            // ä¿ç•™åŸæœ‰çš„keyå’Œåˆ›å»ºæ—¶é—´
            const map = {
                key: maps[editingIndex].key,
                ...data,
                submaps: configuredSubmaps.map(s => ({...s})),
                animals: configuredAnimals.map(a => ({...a})),
                createdAt: maps[editingIndex].createdAt,
                updatedAt: new Date().toISOString()
            };

            maps[editingIndex] = map;
            saveMapConfigs();
            
            renderMapsList();
            form.reset();
            configuredAnimals = [];
            configuredSubmaps = [];
            currentEditingMapKey = null;
            cancelEdit();
            renderConfiguredAnimals();
            renderConfiguredSubmaps();
            updatePreview();
            
            alert(`âœ… åœ°å›¾é…ç½® "${data.name}" å·²æ›´æ–°ï¼`);
        }

        // ç¼–è¾‘åœ°å›¾é…ç½®
        function editMap(index) {
            editingIndex = index;
            const map = maps[index];
            currentEditingMapKey = map.key;
            
            // å¡«å……è¡¨å•
            document.getElementById('map-name').value = map.name;
            document.getElementById('map-icon').value = map.icon;
            document.getElementById('map-level').value = map.level;
            document.getElementById('map-spawn-interval').value = map.spawnInterval;
            document.getElementById('map-max-animals').value = map.maxAnimals;
            document.getElementById('map-desc').value = map.desc || '';
            
            // æ¢å¤å­åœ°å›¾é…ç½®
            configuredSubmaps = map.submaps ? map.submaps.map(s => ({...s})) : [];
            renderConfiguredSubmaps();
            
            // æ¢å¤åŠ¨ç‰©é…ç½®
            configuredAnimals = map.animals ? map.animals.map(a => ({...a})) : [];
            renderConfiguredAnimals();
            
            // æ›´æ–°UI
            submitText.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            submitBtn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            cancelEditBtn.classList.remove('hidden');
            
            updatePreview();
            
            // æ»šåŠ¨åˆ°è¡¨å•é¡¶éƒ¨
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            editingIndex = -1;
            currentEditingMapKey = null;
            submitText.textContent = 'âœ¨ ä¿å­˜åœ°å›¾é…ç½®';
            submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitBtn.classList.add('bg-orange-600', 'hover:bg-orange-700');
            cancelEditBtn.classList.add('hidden');
        }

        // ä¿å­˜åœ°å›¾é…ç½®
        function saveMapConfigs() {
            const jsonStr = JSON.stringify(maps);
            localStorage.setItem('MAP_CONFIGS', jsonStr);
            console.log('âœ… åœ°å›¾é…ç½®å·²ä¿å­˜åˆ° localStorage');
            console.log('ä¿å­˜çš„åœ°å›¾æ•°é‡:', maps.length);
            console.log('ä¿å­˜çš„æ•°æ®:', jsonStr.substring(0, 200) + '...');
            
            // éªŒè¯ä¿å­˜
            const saved = localStorage.getItem('MAP_CONFIGS');
            if (saved) {
                const parsed = JSON.parse(saved);
                console.log('âœ… éªŒè¯æˆåŠŸï¼ŒlocalStorageä¸­æœ‰', parsed.length, 'ä¸ªåœ°å›¾');
            } else {
                console.error('âŒ ä¿å­˜å¤±è´¥ï¼ŒlocalStorageä¸­æ²¡æœ‰æ•°æ®');
            }
        }

        // æ¸²æŸ“åœ°å›¾åˆ—è¡¨
        function renderMapsList() {
            if (maps.length === 0) {
                mapsList.innerHTML = `
                    <div class="text-center text-gray-500 text-sm py-8">
                        æš‚æ— åœ°å›¾é…ç½®
                    </div>
                `;
                return;
            }

            mapsList.innerHTML = maps.map((map, index) => {
                const submapCount = map.submaps?.length || 0;
                const animalCount = map.animals?.length || 0;
                
                return `
                    <div class="map-card bg-gray-800 rounded-lg p-3 border border-gray-600">
                        <div class="flex items-start gap-2">
                            <div class="text-3xl">${map.icon}</div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <h5 class="text-sm font-bold text-white">${map.name}</h5>
                                    <span class="bg-orange-600/30 text-orange-300 px-2 py-0.5 rounded text-xs">Lv.${map.level}</span>
                                </div>
                                <div class="flex gap-2 text-xs mb-1 flex-wrap">
                                    <span class="text-blue-400">â±ï¸${map.spawnInterval}s</span>
                                    <span class="text-green-400">ğŸ¦${map.maxAnimals}åª</span>
                                    ${submapCount > 0 ? `<span class="text-purple-400">ğŸ—ºï¸${submapCount}ä¸ªå­åœ°å›¾</span>` : ''}
                                    <span class="text-gray-400">ğŸ²${animalCount}ç§åŠ¨ç‰©</span>
                                </div>
                                <p class="text-xs text-gray-400">${map.desc || 'æš‚æ— æè¿°'}</p>
                            </div>
                            <div class="flex gap-1 flex-shrink-0">
                                <button onclick="editMap(${index})"
                                    class="text-blue-400 hover:text-blue-300 text-lg px-2"
                                    title="ç¼–è¾‘">
                                    âœï¸
                                </button>
                                <button onclick="deleteMap(${index})"
                                    class="text-red-400 hover:text-red-300 text-xl"
                                    title="åˆ é™¤">
                                    Ã—
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤åœ°å›¾é…ç½®
        function deleteMap(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåœ°å›¾é…ç½®å—ï¼Ÿ')) {
                maps.splice(index, 1);
                saveMapConfigs();
                renderMapsList();
                updateMapCount();
            }
        }

        // å¯¼å‡ºåœ°å›¾é…ç½®
        function exportMaps() {
            if (maps.length === 0) {
                alert('åœ°å›¾é…ç½®ä¸ºç©ºï¼');
                return;
            }

            const dataStr = JSON.stringify(maps, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `map_configs_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥åœ°å›¾é…ç½®
        function importMaps(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedMaps = JSON.parse(event.target.result);
                    
                    if (!Array.isArray(importedMaps)) {
                        alert('âŒ æ— æ•ˆçš„JSONæ ¼å¼ï¼');
                        return;
                    }

                    // åˆå¹¶åœ°å›¾ï¼ˆé¿å…é‡å¤ï¼‰
                    const existingKeys = new Set(maps.map(m => m.key));
                    const newMaps = importedMaps.filter(m => !existingKeys.has(m.key));
                    
                    maps = [...maps, ...newMaps];
                    saveMapConfigs();
                    
                    renderMapsList();
                    updateMapCount();
                    alert(`âœ… æˆåŠŸå¯¼å…¥ ${newMaps.length} ä¸ªåœ°å›¾é…ç½®ï¼`);
                } catch (error) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        }

        // åº”ç”¨åˆ°æ¸¸æˆ
        function applyToGame() {
            if (maps.length === 0) {
                alert('âŒ åœ°å›¾é…ç½®ä¸ºç©ºï¼');
                return;
            }

            // ç»Ÿè®¡ä¿¡æ¯
            const totalAnimals = maps.reduce((sum, m) => sum + m.animals.length, 0);
            const avgAnimalsPerMap = (totalAnimals / maps.length).toFixed(1);

            alert(`âœ… åœ°å›¾é…ç½®å·²å°±ç»ªï¼\n\n` +
                  `ğŸ“Š é…ç½®ç»Ÿè®¡ï¼š\n` +
                  `â€¢ åœ°å›¾æ•°é‡ï¼š${maps.length} ä¸ª\n` +
                  `â€¢ æ€»åŠ¨ç‰©ç§ç±»ï¼š${totalAnimals} ç§\n` +
                  `â€¢ å¹³å‡æ¯åœ°å›¾ï¼š${avgAnimalsPerMap} ç§\n\n` +
                  `ğŸ® æ¸¸æˆä¼šæ ¹æ®åœ°å›¾é…ç½®ç”Ÿæˆå¯¹åº”çš„é‡ç”ŸåŠ¨ç‰©ï¼`);
        }

        // è¾…åŠ©å‡½æ•°
        function getElementName(element) {
            const names = {
                'water': 'æ°´ç³»',
                'fire': 'ç«ç³»',
                'grass': 'è‰ç³»',
                'wind': 'é£ç³»',
                'electric': 'ç”µç³»',
                'earth': 'åœŸç³»'
            };
            return names[element] || 'æœªçŸ¥';
        }

        function getRarityName(rarity) {
            const names = {
                'common': 'æ™®é€š',
                'shiny': 'é—ªå…‰',
                'prismatic': 'å¹»å½©',
                'stellar': 'æ˜ŸèŠ’'
            };
            return names[rarity] || 'æœªçŸ¥';
        }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
</body>
</html>